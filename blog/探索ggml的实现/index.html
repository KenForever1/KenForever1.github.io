<!DOCTYPE html><html lang="zh" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="热爱编程和阅读，学无止境">
      
      
        <meta name="author" content="SteveForever">
      
      
        <link rel="canonical" href="https://github.com/KenForever1/blog/%E6%8E%A2%E7%B4%A2ggml%E7%9A%84%E5%AE%9E%E7%8E%B0/">
      
      
        <link rel="prev" href="../bitnet%E4%B8%ADint2%E5%92%8Cint8%E7%9A%84%E4%BD%BF%E7%94%A8/">
      
      
        <link rel="next" href="../%E5%A1%94%E7%8F%80tutter%E8%87%AA%E6%8C%87%E5%85%AC%E5%BC%8F%E6%98%AF%E4%BB%80%E4%B9%88/">
      
      
        
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/logo.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>探索ggml的实现 - KenForever1</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
    
    
   <meta name="baidu-site-verification" content="codeva-hJH2gPjZkn">

  <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#探索ggml的实现vscode调试环境的搭建" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="KenForever1" class="md-header__button md-logo" aria-label="KenForever1" data-md-component="logo">
      
  <img src="../../assets/octocat.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            KenForever1
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              探索ggml的实现
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="indigo" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.5 2c-1.79 1.15-3 3.18-3 5.5s1.21 4.35 3.03 5.5C4.46 13 2 10.54 2 7.5A5.5 5.5 0 0 1 7.5 2m11.57 1.5 1.43 1.43L4.93 20.5 3.5 19.07zm-6.18 2.43L11.41 5 9.97 6l.42-1.7L9 3.24l1.75-.12.58-1.65L12 3.1l1.73.03-1.35 1.13zm-3.3 3.61-1.16-.73-1.12.78.34-1.32-1.09-.83 1.36-.09.45-1.29.51 1.27 1.36.03-1.05.87zM19 13.5a5.5 5.5 0 0 1-5.5 5.5c-1.22 0-2.35-.4-3.26-1.07l7.69-7.69c.67.91 1.07 2.04 1.07 3.26m-4.4 6.58 2.77-1.15-.24 3.35zm4.33-2.7 1.15-2.77 2.2 2.54zm1.15-4.96-1.14-2.78 3.34.24zM9.63 18.93l2.77 1.15-2.53 2.19z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="grey" data-md-color-accent="indigo" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.5 2c-1.79 1.15-3 3.18-3 5.5s1.21 4.35 3.03 5.5C4.46 13 2 10.54 2 7.5A5.5 5.5 0 0 1 7.5 2m11.57 1.5 1.43 1.43L4.93 20.5 3.5 19.07zm-6.18 2.43L11.41 5 9.97 6l.42-1.7L9 3.24l1.75-.12.58-1.65L12 3.1l1.73.03-1.35 1.13zm-3.3 3.61-1.16-.73-1.12.78.34-1.32-1.09-.83 1.36-.09.45-1.29.51 1.27 1.36.03-1.05.87zM19 13.5a5.5 5.5 0 0 1-5.5 5.5c-1.22 0-2.35-.4-3.26-1.07l7.69-7.69c.67.91 1.07 2.04 1.07 3.26m-4.4 6.58 2.77-1.15-.24 3.35zm4.33-2.7 1.15-2.77 2.2 2.54zm1.15-4.96-1.14-2.78 3.34.24zM9.63 18.93l2.77 1.15-2.53 2.19z"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/KenForever1" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    KenForever1
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
    
  
  博客

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../weeks/%E8%A7%A3%E9%94%81%E9%AB%98%E6%95%88%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%EF%BC%9A%E5%BC%A0%E9%87%8F%E5%B9%B6%E8%A1%8C%28TP%29%E6%8A%80%E6%9C%AF/" class="md-tabs__link">
          
  
  
    
  
  杂谈杂记

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../notes/%23%E8%B0%83%E8%AF%95%E6%8A%80%E8%83%BD%E7%AF%87/%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7/" class="md-tabs__link">
          
  
  
    
  
  技术

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  关于我

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="KenForever1" class="md-nav__button md-logo" aria-label="KenForever1" data-md-component="logo">
      
  <img src="../../assets/octocat.png" alt="logo">

    </a>
    KenForever1
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/KenForever1" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    KenForever1
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    博客
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    博客
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2">
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    归档
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    归档
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2026/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2026
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2024
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3">
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    分类
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    分类
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/c/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C++
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/gnu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GNU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/llm%E6%8E%A8%E7%90%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM推理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/ai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ai
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/course/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    course
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/cpp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    cpp
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/ebpf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ebpf
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/git/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    git
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/http-proxy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    http proxy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/libcurl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    libcurl
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/linux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    linux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/llm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    llm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/llvm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    llvm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/netcap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    netcap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/openai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    openai
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/proxychains/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    proxychains
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    python
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/rust/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    rust
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/squid/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    squid
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/vim/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    vim
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    开发工具
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    开发技能
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/%E6%8A%80%E6%B3%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    技法
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/%E6%9D%82%E8%B0%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    杂谈
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    源码实现
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/%E7%AE%97%E6%B3%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    算法
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/%E7%BC%96%E7%A8%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    编程
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/%E9%98%9F%E5%88%97/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    队列
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/%E9%AB%98%E6%80%A7%E8%83%BD%E5%A4%9A%E7%BA%BF%E7%A8%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    高性能多线程
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    杂谈杂记
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    杂谈杂记
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/%E8%A7%A3%E9%94%81%E9%AB%98%E6%95%88%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%EF%BC%9A%E5%BC%A0%E9%87%8F%E5%B9%B6%E8%A1%8C%28TP%29%E6%8A%80%E6%9C%AF/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    解锁高效大规模模型训练：张量并行(TP)技术
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/%E8%A7%A3%E5%86%B3linux%E4%B8%8D%E8%83%BD%E8%BE%93%E5%85%A5%E6%B1%89%E5%AD%97%E4%BB%A5%E5%8F%8A%E6%B1%89%E5%AD%97%E6%98%BE%E7%A4%BA%E4%B9%B1%E7%A0%81/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    解决linux不能输入汉字以及汉字显示乱码
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/%E7%BC%96%E8%AF%91Opencv%E5%92%8CFFmpeg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    编译Opencv和FFmpeg
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/%E5%9F%BA%E4%BA%8EDocusaurus%E6%90%AD%E5%BB%BAgithub_pages%E5%B1%95%E7%A4%BA%E9%A1%B9%E7%9B%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    基于Docusaurus搭建github pages展示项目
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/%E4%BB%8B%E7%BB%8D%E8%A1%A5%E7%A0%81%E7%9A%84%E4%B8%80%E7%AF%87%E5%BE%88%E5%A5%BD%E7%9A%84%E6%96%87%E7%AB%A0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    介绍补码的一篇很好的文章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/python%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90%E8%B0%83%E7%94%A8%E5%9B%BEcall_graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    python调用图
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/float%E8%BD%ACstring%E7%B2%BE%E5%BA%A6%E6%8D%9F%E5%A4%B1%E9%97%AE%E9%A2%98/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Float转string精度损失问题
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/docker%E6%8B%89%E9%95%9C%E5%83%8F%E5%A4%AA%E6%85%A2%E4%BA%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    docker镜像加速方法
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/c%2B%2B%E5%8D%95%E6%B5%8B%E8%A6%86%E7%9B%96%E7%8E%87%E8%BF%87%E4%BD%8E/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C++单测覆盖率过低
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/base64%E5%8E%9F%E7%90%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Base64原理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/babylon%E5%B7%B4%E6%AF%94%E4%BC%A6%E7%9A%84%E5%B7%A5%E7%A8%8B%E5%B8%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    c++开源库和文章分享
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/SRAM%E5%92%8CDRAM/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SRAM和DRAM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/C%2B%2B%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C++条件编译
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/C%2B%2B%E5%8D%95%E6%B5%8BMock%E6%96%B9%E5%BC%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C++单测Mock方式
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../weeks/20241117-llama-cpp%E6%8F%90%E7%82%B9PR/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    给llama-cpp提交一些PR
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3">
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    技术
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    技术
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1">
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    #调试技能篇
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    #调试技能篇
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E8%B0%83%E8%AF%95%E6%8A%80%E8%83%BD%E7%AF%87/%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    调试工具
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E8%B0%83%E8%AF%95%E6%8A%80%E8%83%BD%E7%AF%87/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    性能分析
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_3">
        
          
          <label class="md-nav__link" for="__nav_3_1_3" id="__nav_3_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Gdb
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gdb
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E8%B0%83%E8%AF%95%E6%8A%80%E8%83%BD%E7%AF%87/gdb/use%20gdb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Use gdb
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E8%B0%83%E8%AF%95%E6%8A%80%E8%83%BD%E7%AF%87/gdb/gdb%E8%B0%83%E8%AF%95core%E6%96%87%E4%BB%B6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gdb调试core文件
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E8%B0%83%E8%AF%95%E6%8A%80%E8%83%BD%E7%AF%87/gdb/gdb%E6%9B%B4%E5%A5%BD%E7%9A%84%E6%98%BE%E7%A4%BAc%2B%2B%20STL%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E5%80%BC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    gdb更好的显示c++ STL数据结构的值
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E8%B0%83%E8%AF%95%E6%8A%80%E8%83%BD%E7%AF%87/gcc%E7%89%88%E6%9C%AC%E4%BE%9D%E8%B5%96ELF%E4%BF%AE%E6%94%B9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux修改ELF解决glibc兼容性问题
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_5">
        
          
          <label class="md-nav__link" for="__nav_3_1_5" id="__nav_3_1_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Ebpf
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ebpf
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E8%B0%83%E8%AF%95%E6%8A%80%E8%83%BD%E7%AF%87/ebpf/ebpf%20udst%E5%88%9D%E6%8E%A2--libstapsdt%E7%9A%84%E4%BD%BF%E7%94%A8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ebpf udst初探  libstapsdt的使用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E8%B0%83%E8%AF%95%E6%8A%80%E8%83%BD%E7%AF%87/Python%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python调试工具
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2">
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    #编程语言篇
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    #编程语言篇
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_1">
        
          
          <label class="md-nav__link" for="__nav_3_2_1" id="__nav_3_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Rust
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Rust
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Rust/%E5%9C%A8Linux%E4%B8%8A%E7%BC%96%E8%AF%91Windows%E5%B9%B3%E5%8F%B0%E7%9A%84Rust%E7%A8%8B%E5%BA%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    在Linux上编译Windows平台的Rust程序
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Rust/rust%20corse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Rust corse
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Rust/Rust%E7%AF%87/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Rust篇
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Rust/Advent_of_code_2020--%E7%99%BB%E6%9C%BA%E5%BA%A7%E4%BD%8D%E9%97%AE%E9%A2%98/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Advent of code 2020 -- 登机座位问题
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_2">
        
          
          <label class="md-nav__link" for="__nav_3_2_2" id="__nav_3_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Python
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Python
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/Python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_2_2">
        
          
          <label class="md-nav__link" for="__nav_3_2_2_2" id="__nav_3_2_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    PyQt技法
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_2_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    PyQt技法
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/PyQt%E6%8A%80%E6%B3%95/tabWidget%20in%20pyqt5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    tabWidget in pyqt5
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/PyQt%E6%8A%80%E6%B3%95/qt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Qt
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/PyQt%E6%8A%80%E6%B3%95/qt5-code-snippet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Qt5 code snippet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/PyQt%E6%8A%80%E6%B3%95/pyqt%20qss%20problem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pyqt qss problem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/PyQt%E6%8A%80%E6%B3%95/pyqt5-tableWidget/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    pyqt5 tableWidget
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/PyQt%E6%8A%80%E6%B3%95/pyqt5-package-to-deb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pyqt5 package to deb
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/PyQt%E6%8A%80%E6%B3%95/pyqt5-eric6-pycharm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pyqt5 eric6 pycharm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/PyQt%E6%8A%80%E6%B3%95/pyqt5-add-resource-file/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pyqt5 add resource file
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/PyQt%E6%8A%80%E6%B3%95/pyQt%20style%20Pattern/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    pyQt style Pattern
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/PyQt%E6%8A%80%E6%B3%95/TreeView%20of%20PyQt5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TreeView of PyQt5
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/PyQt%E6%8A%80%E6%B3%95/QtDev/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    QtDev
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/PyQt%E6%8A%80%E6%B3%95/NetworkGraph%20add%20self%20loop%20edge%20of%20PyQt5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NetworkGraph add self loop edge of PyQt5
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Python/PyQt%E6%8A%80%E6%B3%95/Network%20Graph%20of%20PyQt5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Graph of PyQt5
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/Kotlin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kotlin
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_4">
        
          
          <label class="md-nav__link" for="__nav_3_2_4" id="__nav_3_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    FFI跨语言调用
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    FFI跨语言调用
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/FFI%E8%B7%A8%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8/python%E8%B0%83%E7%94%A8c%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    python调用c踩坑记录
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/FFI%E8%B7%A8%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8/ctypes%E5%9C%B0%E5%9D%80%E4%BC%A0%E9%80%92%E6%88%AA%E6%96%AD%E9%97%AE%E9%A2%98/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ctypes地址传递截断问题
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_5">
        
          
          <label class="md-nav__link" for="__nav_3_2_5" id="__nav_3_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    C++
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    C++
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/%E7%BC%96%E8%AF%91ABI%E9%97%AE%E9%A2%98/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    编译ABI问题
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/%E6%A8%A1%E6%9D%BF%E5%85%83%E7%BC%96%E7%A8%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    模板元编程
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/%E5%A4%9AGCC%E7%8E%AF%E5%A2%83%E4%B8%8B%E8%AE%BE%E7%BD%AE%E7%BC%96%E8%AF%91%E5%99%A8%E7%89%88%E6%9C%AC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    多GCC环境下设置编译器版本
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/std%20sort%E5%B4%A9%E6%BA%83%E8%AE%B0%E5%BD%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Std sort崩溃记录
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/c%2B%2B%E7%BC%96%E8%AF%91%E4%B8%AD%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E7%9A%84%E5%BC%95%E5%85%A5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C++编译中第三方库的引入
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/c%2B%2B%E6%98%93%E9%94%99%E4%BB%A3%E7%A0%81%E6%9D%82%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C++易错代码杂记
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/c%2B%2B%20macro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C++ macro
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/Vector%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E7%A4%BA%E4%BE%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vector与常用数据类型转换示例
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/RapidJSON/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RapidJSON
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/Handle%20abort%20signal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Handle abort signal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/FileIO%E7%A4%BA%E4%BE%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FileIO示例
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/C%2B%2B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C++
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/C%2B%2B%2020%20corutine%20generator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C++ 20 corutine generator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/C%2B%2B20%E4%B8%ADbarrier%E5%92%8Clatch%E6%9C%89%E4%BD%95%E4%B8%8D%E5%90%8C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C++20中barrier和latch有何不同
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_5_15">
        
          
          <label class="md-nav__link" for="__nav_3_2_5_15" id="__nav_3_2_5_15_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Abseil
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_2_5_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_5_15">
            <span class="md-nav__icon md-icon"></span>
            
  
    Abseil
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/Abseil/Status%E5%AE%9E%E7%8E%B0%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Status实现源码阅读
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/Abseil/FTADLE%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FTADLE设计模式
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E7%AF%87/C%2B%2B/Abseil/C%2B%2B%20Tips/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C++ Tips
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3">
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    #开发技能篇
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    #开发技能篇
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_1">
        
          
          <label class="md-nav__link" for="__nav_3_3_1" id="__nav_3_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    工程实践
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    工程实践
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/Opencv%E6%8A%80%E5%B7%A7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Opencv技巧
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/FFmpeg%E6%8A%80%E5%B7%A7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FFmpeg技巧
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/Docker%E6%8A%80%E5%B7%A7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Docker技巧
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%99%A8%E7%9A%84%E5%89%8D%E8%BF%9B-%E5%9B%9E%E9%80%80%E6%8C%89%E9%92%AE%E9%80%BB%E8%BE%91/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    如何实现文件管理器的前进/回退按钮逻辑
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/%E5%8F%8C%E6%8B%BC%E4%BD%A0%E7%94%A8%E8%BF%87%E5%90%97/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    双拼你用过吗
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_4">
        
          
          <label class="md-nav__link" for="__nav_3_3_4" id="__nav_3_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    博客搭建记录
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    博客搭建记录
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E8%AE%B0%E5%BD%95/how%20to%20deploy%20a%20mkdocks%20blog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How to deploy a mkdocks blog
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E8%AE%B0%E5%BD%95/hexo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E8%AE%B0%E5%BD%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    hexo博客搭建记录
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/%E4%BB%98%E8%B4%B9%E8%8E%B7%E5%8F%96%E5%AF%86%E7%A0%81%E5%B9%B3%E5%8F%B0%E5%8E%9F%E7%90%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    付费获取密码平台原理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/windows%E4%B8%8B%E6%89%93%E5%8C%85exe%E6%96%87%E4%BB%B6%E6%8A%80%E6%B3%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Windows下打包exe文件技法
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/blogs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Blogs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/QGIS%20%E4%BD%BF%E7%94%A8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Convert pyQt UI to python
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_9">
        
          
          <label class="md-nav__link" for="__nav_3_3_9" id="__nav_3_3_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Algorithm
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Algorithm
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/Algorithm/%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    无锁队列实现
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/Algorithm/%E5%8D%95%E8%B0%83%E9%98%9F%E5%88%97/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    单调队列
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/Algorithm/%E5%89%8D%E7%BC%80%E6%A0%91/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    前缀树
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/Algorithm/LRU/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LRU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E6%8A%80%E8%83%BD%E7%AF%87/Algorithm/ExamRoom/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ExamRoom
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4">
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    #开发工具篇
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    #开发工具篇
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/%E9%AB%98%E6%95%88%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    高效使用工具
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_2">
        
          
          <label class="md-nav__link" for="__nav_3_4_2" id="__nav_3_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    编辑器之神
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    编辑器之神
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/%E7%BC%96%E8%BE%91%E5%99%A8%E4%B9%8B%E7%A5%9E/%E5%A6%82%E4%BD%95%E8%B0%83%E8%AF%95vimscript%E7%A8%8B%E5%BA%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    如何调试vimscript程序
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/%E7%BC%96%E8%BE%91%E5%99%A8%E4%B9%8B%E7%A5%9E/%E5%A6%82%E4%BD%95%E6%9B%B4%E6%96%B0neovim%E4%BB%A5%E5%8F%8A%E5%AE%89%E8%A3%85%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    如何更新neovim以及安装指定版本.md
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/%E7%BC%96%E8%BE%91%E5%99%A8%E4%B9%8B%E7%A5%9E/Vim%E5%A5%87%E6%B7%AB%E6%8A%80%E5%B7%A7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vim奇淫技巧
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/%E7%BC%96%E8%BE%91%E5%99%A8%E4%B9%8B%E7%A5%9E/AWK/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AWK
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_3">
        
          
          <label class="md-nav__link" for="__nav_3_4_3" id="__nav_3_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    编译大法
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    编译大法
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/%E7%BC%96%E8%AF%91%E5%A4%A7%E6%B3%95/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    交叉编译
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/%E7%94%BB%E5%9B%BE%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    画图工具
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/markdown/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Markdown
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_6">
        
          
          <label class="md-nav__link" for="__nav_3_4_6" id="__nav_3_4_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Linux提效
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Linux提效
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/linux%E6%8F%90%E6%95%88/%E8%87%AA%E5%AE%9A%E4%B9%89Linux%E5%8F%91%E8%A1%8C%E5%8C%85/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    自定义Linux发行包
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/linux%E6%8F%90%E6%95%88/%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8U%E7%9B%98%E5%88%B6%E4%BD%9C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    系统启动U盘制作
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/linux%E6%8F%90%E6%95%88/%E7%A3%81%E7%9B%98%E6%B8%85%E7%90%86%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    磁盘清理工具
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/linux%E6%8F%90%E6%95%88/%E5%86%85%E5%AD%98%E6%A3%80%E6%B5%8B%E5%8F%8A%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    内存检测及调试工具
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/linux%E6%8F%90%E6%95%88/%E4%BB%A5%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E6%96%B9%E5%BC%8F%E5%90%AF%E5%8A%A8%E7%A8%8B%E5%BA%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    以系统服务方式启动程序
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/linux%E6%8F%90%E6%95%88/systemd%20use%20service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Systemd use service
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/linux%E6%8F%90%E6%95%88/right%20Network%20way/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    right Network way
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/linux%E6%8F%90%E6%95%88/linux%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux零拷贝技术
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/linux%E6%8F%90%E6%95%88/dotfiles%20config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dotfiles config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/linux%E6%8F%90%E6%95%88/Utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/linux%E6%8F%90%E6%95%88/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux常用命令行工具
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/linux%E6%8F%90%E6%95%88/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux常用命令
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_7">
        
          
          <label class="md-nav__link" for="__nav_3_4_7" id="__nav_3_4_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Vscode
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Vscode
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/Vscode/Vscode%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vscode环境配置
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/Linux%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux开发环境配置
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/Git/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Git
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%AF%87/Bash/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bash
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5">
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    #AI篇
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    #AI篇
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_1">
        
          
          <label class="md-nav__link" for="__nav_3_5_1" id="__nav_3_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    mlir学习之旅
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    mlir学习之旅
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23AI%E7%AF%87/mlir/debug_toy_config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Debug toy config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23AI%E7%AF%87/mlir/learn_toy4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Learn toy4
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23AI%E7%AF%87/mlir/learn_toy3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MLIR 系列–Toy3 Rewrite Pass
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23AI%E7%AF%87/mlir/learn_toy2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MLIR初遇–Toy2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23AI%E7%AF%87/mlir/%E5%85%B3%E4%BA%8Emlir%E7%9A%84%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    关于mlir的学习资料
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_2">
        
          
          <label class="md-nav__link" for="__nav_3_5_2" id="__nav_3_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    llama多少也得会点
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    llama多少也得会点
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23AI%E7%AF%87/llama/gguf%E4%BD%BF%E7%94%A8mmap%E8%BF%9B%E8%A1%8C%E9%AB%98%E6%95%88%E8%AF%BB%E5%8F%96%E5%92%8C%E4%BF%9D%E5%AD%98/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gguf使用mmap进行高效读取和保存
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_3">
        
          
          <label class="md-nav__link" for="__nav_3_5_3" id="__nav_3_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    lmdepoly如何实现的？
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    lmdepoly如何实现的？
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23AI%E7%AF%87/lmdeploy/%E9%80%9A%E8%BF%87lmdepoly%E5%AD%A6%E4%B9%A0Python%E4%B8%AD%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%B3%A8%E5%86%8C%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    通过lmdepoly学习Python中如何实现注册模式
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23AI%E7%AF%87/lmdeploy/Intervl2-8B%E6%A8%A1%E5%9E%8B%E7%9A%84%E9%A2%84%E5%A4%84%E7%90%86preprocess%E6%9C%89%E4%BD%95%E4%B8%8D%E5%90%8C%3F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Intervl2 8B模型的预处理preprocess有何不同?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_4">
        
          
          <label class="md-nav__link" for="__nav_3_5_4" id="__nav_3_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    triton_server是个啥？
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    triton_server是个啥？
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23AI%E7%AF%87/triton_server/tritonServer%E4%B8%AD%E7%9A%84decouple%E6%A8%A1%E5%BC%8F%E6%98%AF%E4%BB%80%E4%B9%88%3F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Triton推理服务器中的解耦模式
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/%23AI%E7%AF%87/triton_server/TritonServer%E7%9A%84pythonbackend%E6%9D%82%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TritonServer的pythonbackend杂记
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    关于我
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#探索ggml的实现vscode调试环境的搭建" class="md-nav__link">
    <span class="md-ellipsis">
      
        探索ggml的实现–vscode调试环境的搭建
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="探索ggml的实现–vscode调试环境的搭建">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#配置调试目标" class="md-nav__link">
    <span class="md-ellipsis">
      
        配置调试目标
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vscode配置debug" class="md-nav__link">
    <span class="md-ellipsis">
      
        vscode配置debug
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#探索ggml的实现张量表示" class="md-nav__link">
    <span class="md-ellipsis">
      
        探索ggml的实现–张量表示
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="探索ggml的实现–张量表示">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ggml_tensor-数据结构" class="md-nav__link">
    <span class="md-ellipsis">
      
        ggml_tensor 数据结构
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#通过一个例子学习tensor" class="md-nav__link">
    <span class="md-ellipsis">
      
        通过一个例子学习tensor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tensor的内存布局" class="md-nav__link">
    <span class="md-ellipsis">
      
        tensor的内存布局
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tensor的内存布局">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#f32矩阵" class="md-nav__link">
    <span class="md-ellipsis">
      
        f32矩阵
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#量化矩阵" class="md-nav__link">
    <span class="md-ellipsis">
      
        量化矩阵
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#矩阵permute重排列" class="md-nav__link">
    <span class="md-ellipsis">
      
        矩阵permute重排列
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#张量视图" class="md-nav__link">
    <span class="md-ellipsis">
      
        张量视图
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#探索ggml的实现ggml的内存管理" class="md-nav__link">
    <span class="md-ellipsis">
      
        探索ggml的实现–GGML的内存管理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="探索ggml的实现–GGML的内存管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#认识ggml_context" class="md-nav__link">
    <span class="md-ellipsis">
      
        认识ggml_context
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="认识ggml_context">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#理解ggml_init" class="md-nav__link">
    <span class="md-ellipsis">
      
        理解ggml_init
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ggml的tensor表示" class="md-nav__link">
    <span class="md-ellipsis">
      
        GGML的tensor表示
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GGML的tensor表示">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#理解ggml_new_object" class="md-nav__link">
    <span class="md-ellipsis">
      
        理解ggml_new_object
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ggml_tensor如何定义" class="md-nav__link">
    <span class="md-ellipsis">
      
        ggml_tensor如何定义
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#要点" class="md-nav__link">
    <span class="md-ellipsis">
      
        要点
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#探索ggml的实现ggml计算图构建" class="md-nav__link">
    <span class="md-ellipsis">
      
        探索ggml的实现–GGML计算图构建
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="探索ggml的实现–GGML计算图构建">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#在ggml_context中创建计算图" class="md-nav__link">
    <span class="md-ellipsis">
      
        在ggml_context中创建计算图
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在ggml_context中创建计算图">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ggml_gral_nbytes计算细节" class="md-nav__link">
    <span class="md-ellipsis">
      
        ggml_gral_nbytes计算细节
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#构建矩阵乘计算图" class="md-nav__link">
    <span class="md-ellipsis">
      
        构建矩阵乘计算图
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="构建矩阵乘计算图">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ggml_build_forward_expand-函数细节探索" class="md-nav__link">
    <span class="md-ellipsis">
      
        ggml_build_forward_expand 函数细节探索
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#探索ggml的实现执行ggml计算图" class="md-nav__link">
    <span class="md-ellipsis">
      
        探索ggml的实现–执行GGML计算图
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="探索ggml的实现–执行GGML计算图">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#探索ggml_graph_plan细节" class="md-nav__link">
    <span class="md-ellipsis">
      
        探索ggml_graph_plan细节
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="探索ggml_graph_plan细节">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#如何确定线程数量" class="md-nav__link">
    <span class="md-ellipsis">
      
        如何确定线程数量
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#确定工作缓存区大小" class="md-nav__link">
    <span class="md-ellipsis">
      
        确定工作缓存区大小
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#计算图的执行计算" class="md-nav__link">
    <span class="md-ellipsis">
      
        计算图的执行计算
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="计算图的执行计算">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ggml线程池实现" class="md-nav__link">
    <span class="md-ellipsis">
      
        GGML线程池实现
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu亲和性设置" class="md-nav__link">
    <span class="md-ellipsis">
      
        cpu亲和性设置
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#计算图工作线程创建及调度" class="md-nav__link">
    <span class="md-ellipsis">
      
        计算图工作线程创建及调度
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#多线程如何执行矩阵乘张量计算" class="md-nav__link">
    <span class="md-ellipsis">
      
        多线程如何执行矩阵乘张量计算
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#获取计算结果" class="md-nav__link">
    <span class="md-ellipsis">
      
        获取计算结果
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
                  <span class="md-ellipsis">
                    回到主页
                  </span>
                </a>
              </div>
            </div>
            
              <div class="md-post__authors md-typeset">
                
                  <div class="md-profile md-post__profile">
                    <span class="md-author md-author--long">
                      <img src="https://raw.githubusercontent.com/KenForever1/CDN/main/logo.png" alt="KenForever1">
                    </span>
                    <span class="md-profile__description">
                      <strong>
                        
                          KenForever1
                        
                      </strong>
                      <br>
                      Creator
                    </span>
                  </div>
                
              </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    元数据
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"></path></svg>
                        <time datetime="2025-09-01 00:00:00+00:00" class="md-ellipsis">2025年9月1日</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"></path></svg>
                          <span class="md-ellipsis">
                            分类于
                            
                              <a href="../category/cpp/">cpp</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"></path></svg>
                          <span class="md-ellipsis">
                            
                              需要 15 分钟阅读时间
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  



  
    <a href="https://github.com/KenForever1/edit/main/docs/blog/posts/探索ggml的实现.md" title="编辑此页" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"></path></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/KenForever1/raw/main/docs/blog/posts/探索ggml的实现.md" title="查看本页的源代码" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"></path></svg>
    </a>
  


  <h1>探索ggml的实现</h1>

<!-- more --><p>本文主要介绍ggml的调试入门环境搭建、ggml的核心数据结构、内存管理与布局、计算图构建与执行、以及gguf文件格式构成，会分成多个小节介绍。</p>
<p>本文起源于作者ggml学习过程中了解的资料，包括<a href="https://xsxszab.github.io/posts/ggml-deep-dive-i/">xsxszab的ggml-deep-dive系列文章</a>、以及阅读源码，记录和分享自己的理解过程。（感谢xsxszab绘制的关于内存布局的图例，为ggml的理解更加浅显易懂。）</p>
<p>ggml是采用c/c++编写高度优化的tensor张量计算库，没有外部依赖。存在不同的backend实现，从mac的metal、x86的avx实现以及arm的neon指令实现、gpu的cuda、hip、opencl等实现。llama.cpp项目就是使用ggml进行模型加载、推理的。</p>
<h2 id="探索ggml的实现vscode调试环境的搭建">探索ggml的实现–vscode调试环境的搭建<a class="headerlink" href="#探索ggml的实现vscode调试环境的搭建" title="Permanent link">¶</a></h2>
<p>在阅读源码的时候，找一个最简单的example例子跑通，然后跟着源码进行调试，是很快理解原理的一种方法。 </p>
<p>在linux、或者mac下都方便编译。</p>
<p>编译依赖：</p>
<ul>
<li>gcc/g++或者 clang编译</li>
<li>cmake： 用于管理构建项目</li>
<li>ccache：可选项，加快编译速度用</li>
</ul>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/ggml-org/ggml.git
</code></pre></div></td></tr></tbody></table></div>
<p>上面的依赖安装很简单，以ubuntu为例：
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>apt<span class="w"> </span>update
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>gcc<span class="w"> </span>g++<span class="w"> </span>cmake<span class="w"> </span>ccache
</code></pre></div></td></tr></tbody></table></div><p></p>
<h3 id="配置调试目标">配置调试目标<a class="headerlink" href="#配置调试目标" title="Permanent link">¶</a></h3>
<p>ggml的example中包括了很多例子，先从简单的例子看起。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>examples/simple/simple-ctx.cpp
</code></pre></div></td></tr></tbody></table></div>
<p>修改项目的cmake配置，即添加-g方便debug调试。找到examples/simple/CMakeLists.txt配置文件，为simple-ctx这个可执行文件添加-g参数。
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span>
<span class="normal"><a href="#__codelineno-3-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>set<span class="o">(</span>TEST_TARGET<span class="w"> </span>simple-ctx<span class="o">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>add_executable<span class="o">(</span><span class="si">${</span><span class="nv">TEST_TARGET</span><span class="si">}</span><span class="w"> </span>simple-ctx.cpp<span class="o">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>target_compile_options<span class="o">(</span><span class="si">${</span><span class="nv">TEST_TARGET</span><span class="si">}</span><span class="w"> </span>PRIVATE<span class="w"> </span>-g<span class="o">)</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>target_link_libraries<span class="o">(</span><span class="si">${</span><span class="nv">TEST_TARGET</span><span class="si">}</span><span class="w"> </span>PRIVATE<span class="w"> </span>ggml<span class="o">)</span>
</code></pre></div></td></tr></tbody></table></div>
上面只是为可执行文件添加了-g调试信息，如果要调试ggml.so这个库，则需要编译ggml.so库时指定Debug类型。<p></p>
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a>cmake<span class="w"> </span>-B<span class="w"> </span>build<span class="w"> </span>-S<span class="w"> </span>.<span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>DEBUG
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>cmake<span class="w"> </span>--build<span class="w"> </span>build
</code></pre></div></td></tr></tbody></table></div>
查看编译输出，可以看到ggml.so库被编译成with debug_info。
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a>file<span class="w"> </span>build/src/libggml.so<span class="w"> </span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>build/src/libggml.so:<span class="w"> </span>ELF<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>LSB<span class="w"> </span>shared<span class="w"> </span>object,<span class="w"> </span>x86-64,<span class="w"> </span>version<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>SYSV<span class="o">)</span>,<span class="w"> </span>dynamically<span class="w"> </span>linked,<span class="w"> </span>BuildID<span class="o">[</span>sha1<span class="o">]=</span>db376e303daeef672c8002ed6cebed1da303a706,<span class="w"> </span>with<span class="w"> </span>debug_info,<span class="w"> </span>not<span class="w"> </span>stripped
</code></pre></div></td></tr></tbody></table></div><p></p>
<h3 id="vscode配置debug">vscode配置debug<a class="headerlink" href="#vscode配置debug" title="Permanent link">¶</a></h3>
<p>点击右边的Run and Debug按钮，create a launch.json file，创建一个配置文件，把下面的内容粘贴进去。</p>
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="p">{</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">    </span><span class="nt">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.2.0"</span><span class="p">,</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">    </span><span class="nt">"configurations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">            </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"debug simple-ctx"</span><span class="p">,</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lldb"</span><span class="p">,</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">            </span><span class="nt">"request"</span><span class="p">:</span><span class="w"> </span><span class="s2">"launch"</span><span class="p">,</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">            </span><span class="nt">"program"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}/build/bin/simple-ctx"</span><span class="p">,</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">            </span><span class="nt">"cwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}"</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="p">]</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div>
接下来就可以按照vscode的界面button调试了，如果要调试其它可执行程序，修改launch.json的program字段即可。<p></p>
<p>可以看到，通过上面的编译debug模式和添加-g参数，可以进入可执行程序和ggml.so库的源码进行调试了了。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-debug.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-debug.png"></a></p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-debug1.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-debug1.png"></a></p>
<h2 id="探索ggml的实现张量表示">探索ggml的实现–张量表示<a class="headerlink" href="#探索ggml的实现张量表示" title="Permanent link">¶</a></h2>
<h3 id="ggml_tensor-数据结构">ggml_tensor 数据结构<a class="headerlink" href="#ggml_tensor-数据结构" title="Permanent link">¶</a></h3>
<p>在GGML中通过ggml_tensor结构体表示张量，结构体定义如下：</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span>
<span class="normal"><a href="#__codelineno-7-39">39</a></span>
<span class="normal"><a href="#__codelineno-7-40">40</a></span>
<span class="normal"><a href="#__codelineno-7-41">41</a></span>
<span class="normal"><a href="#__codelineno-7-42">42</a></span>
<span class="normal"><a href="#__codelineno-7-43">43</a></span>
<span class="normal"><a href="#__codelineno-7-44">44</a></span>
<span class="normal"><a href="#__codelineno-7-45">45</a></span>
<span class="normal"><a href="#__codelineno-7-46">46</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1">// n-dimensional tensor</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="c1">// 张量的数据类型：例如GGML_TYPE_F32,GGML_TYPE_F16，GGML_TYPE_Q4_0</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="nc">ggml_type</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_backend_buffer</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="c1">// 最大维度为4，GGML_MAX_DIMS为4</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">    </span><span class="c1">// ne存储张量每个维度的元素个数</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">    </span><span class="c1">// nb存储张量每个维的元素大小</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">ne</span><span class="p">[</span><span class="n">GGML_MAX_DIMS</span><span class="p">];</span><span class="w"> </span><span class="c1">// number of elements</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">    </span><span class="kt">size_t</span><span class="w">  </span><span class="n">nb</span><span class="p">[</span><span class="n">GGML_MAX_DIMS</span><span class="p">];</span><span class="w"> </span><span class="c1">// stride in bytes:</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">                                </span><span class="c1">// nb[0] = ggml_type_size(type)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">                                </span><span class="c1">// nb[1] = nb[0]   * (ne[0] / ggml_blck_size(type)) + padding</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">                                </span><span class="c1">// nb[i] = nb[i-1] * ne[i-1]</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">    </span><span class="c1">// 张量op类型，在计算图中作为op node，后面会提到</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">    </span><span class="c1">// 例如矩阵乘类型，GGML_OP_MUL_MAT</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">    </span><span class="c1">// compute data</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="nc">ggml_op</span><span class="w"> </span><span class="n">op</span><span class="p">;</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">    </span><span class="c1">// op params - allocated as int32_t for alignment</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">op_params</span><span class="p">[</span><span class="n">GGML_MAX_OP_PARAMS</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">)];</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="w">    </span><span class="c1">// 指针指向此张量的src张量</span>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="w">    </span><span class="c1">// 例如矩阵乘op tensor的src张量是矩阵A tensor和矩阵B tensor</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">[</span><span class="n">GGML_MAX_SRC</span><span class="p">];</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="w">    </span><span class="c1">// 描述张量视图，如果此张量是另一个张量（base张量）的视图，则指向base张量</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="w">    </span><span class="c1">// source tensor and offset for views</span>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">view_src</span><span class="p">;</span>
<a id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="w">    </span><span class="c1">// 视图张量的偏移量</span>
<a id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="w">    </span><span class="kt">size_t</span><span class="w">               </span><span class="n">view_offs</span><span class="p">;</span>
<a id="__codelineno-7-36" name="__codelineno-7-36"></a>
<a id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="w">    </span><span class="c1">// 存储张量的数据</span>
<a id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<a id="__codelineno-7-39" name="__codelineno-7-39"></a>
<a id="__codelineno-7-40" name="__codelineno-7-40"></a><span class="w">    </span><span class="c1">// 张量的名称</span>
<a id="__codelineno-7-41" name="__codelineno-7-41"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">GGML_MAX_NAME</span><span class="p">];</span>
<a id="__codelineno-7-42" name="__codelineno-7-42"></a>
<a id="__codelineno-7-43" name="__codelineno-7-43"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">extra</span><span class="p">;</span><span class="w"> </span><span class="c1">// extra things e.g. for ggml-cuda.cu</span>
<a id="__codelineno-7-44" name="__codelineno-7-44"></a>
<a id="__codelineno-7-45" name="__codelineno-7-45"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">padding</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<a id="__codelineno-7-46" name="__codelineno-7-46"></a><span class="p">};</span>
</code></pre></div></td></tr></tbody></table></div>
<h3 id="通过一个例子学习tensor">通过一个例子学习tensor<a class="headerlink" href="#通过一个例子学习tensor" title="Permanent link">¶</a></h3>
<p>在examples文件夹中添加一个simple-add.cpp的文件，添加如下内容：
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span>
<span class="normal"><a href="#__codelineno-8-36">36</a></span>
<span class="normal"><a href="#__codelineno-8-37">37</a></span>
<span class="normal"><a href="#__codelineno-8-38">38</a></span>
<span class="normal"><a href="#__codelineno-8-39">39</a></span>
<span class="normal"><a href="#__codelineno-8-40">40</a></span>
<span class="normal"><a href="#__codelineno-8-41">41</a></span>
<span class="normal"><a href="#__codelineno-8-42">42</a></span>
<span class="normal"><a href="#__codelineno-8-43">43</a></span>
<span class="normal"><a href="#__codelineno-8-44">44</a></span>
<span class="normal"><a href="#__codelineno-8-45">45</a></span>
<span class="normal"><a href="#__codelineno-8-46">46</a></span>
<span class="normal"><a href="#__codelineno-8-47">47</a></span>
<span class="normal"><a href="#__codelineno-8-48">48</a></span>
<span class="normal"><a href="#__codelineno-8-49">49</a></span>
<span class="normal"><a href="#__codelineno-8-50">50</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">"ggml.h"</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">"ggml-cpu.h"</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstring&gt;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_init_params</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">        </span><span class="cm">/*.mem_size   =*/</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ggml_graph_overhead</span><span class="p">(),</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">        </span><span class="cm">/*.mem_buffer =*/</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">        </span><span class="cm">/*.no_alloc   =*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">    </span><span class="n">ggml_context</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_init</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">    </span><span class="c1">// --------------------</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">    </span><span class="c1">// Modify this section to test different tensor computations</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">a_data</span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">        </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="w">        </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="w">        </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">b_data</span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="w">        </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="w">        </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="w">        </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a><span class="w">    </span><span class="c1">// 因为ggml中tensor表示和pytorch相反，因此3行2列的矩阵，表示为[2, 3]</span>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a><span class="w">    </span><span class="n">ggml_tensor</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_new_tensor_2d</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_TYPE_F32</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a><span class="w">    </span><span class="n">ggml_tensor</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_new_tensor_2d</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_TYPE_F32</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">a_data</span><span class="p">,</span><span class="w"> </span><span class="n">ggml_nbytes</span><span class="p">(</span><span class="n">a</span><span class="p">));</span>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">b_data</span><span class="p">,</span><span class="w"> </span><span class="n">ggml_nbytes</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
<a id="__codelineno-8-36" name="__codelineno-8-36"></a>
<a id="__codelineno-8-37" name="__codelineno-8-37"></a><span class="w">    </span><span class="n">ggml_tensor</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
<a id="__codelineno-8-38" name="__codelineno-8-38"></a><span class="w">    </span><span class="c1">// --------------------</span>
<a id="__codelineno-8-39" name="__codelineno-8-39"></a>
<a id="__codelineno-8-40" name="__codelineno-8-40"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_cgraph</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">gf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_new_graph</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<a id="__codelineno-8-41" name="__codelineno-8-41"></a><span class="w">    </span><span class="n">ggml_build_forward_expand</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<a id="__codelineno-8-42" name="__codelineno-8-42"></a>
<a id="__codelineno-8-43" name="__codelineno-8-43"></a><span class="w">    </span><span class="n">ggml_graph_compute_with_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">gf</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-8-44" name="__codelineno-8-44"></a>
<a id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">out_data</span><span class="p">(</span><span class="n">ggml_nelements</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
<a id="__codelineno-8-46" name="__codelineno-8-46"></a><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">out_data</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">ggml_nbytes</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
<a id="__codelineno-8-47" name="__codelineno-8-47"></a>
<a id="__codelineno-8-48" name="__codelineno-8-48"></a><span class="w">    </span><span class="n">ggml_free</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<a id="__codelineno-8-49" name="__codelineno-8-49"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-8-50" name="__codelineno-8-50"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div>
完善cmake配置，在CMakeLists.txt中添加以下内容：
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">CMake</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span>
<span class="normal"><a href="#__codelineno-9-5">5</a></span>
<span class="normal"><a href="#__codelineno-9-6">6</a></span>
<span class="normal"><a href="#__codelineno-9-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c">#</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="c"># simple-add</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="nb">set</span><span class="p">(</span><span class="s">TEST_TARGET</span><span class="w"> </span><span class="s">simple-add</span><span class="p">)</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">TEST_TARGET</span><span class="o">}</span><span class="w"> </span><span class="s">simple-add.cpp</span><span class="p">)</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="nb">target_compile_options</span><span class="p">(</span><span class="o">${</span><span class="nv">TEST_TARGET</span><span class="o">}</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="s">-g</span><span class="p">)</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">TEST_TARGET</span><span class="o">}</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="s">ggml</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
根据第一节的内容，编译然后就可以用vscode debug调试了。当完成ggml_new_tensor_2d创建2维张量时，并且通过memcpy拷贝赋值后。我们通过gdb打印tensor的数据，就可以看到数据了。
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span>
<span class="normal"><a href="#__codelineno-10-35">35</a></span>
<span class="normal"><a href="#__codelineno-10-36">36</a></span>
<span class="normal"><a href="#__codelineno-10-37">37</a></span>
<span class="normal"><a href="#__codelineno-10-38">38</a></span>
<span class="normal"><a href="#__codelineno-10-39">39</a></span>
<span class="normal"><a href="#__codelineno-10-40">40</a></span>
<span class="normal"><a href="#__codelineno-10-41">41</a></span>
<span class="normal"><a href="#__codelineno-10-42">42</a></span>
<span class="normal"><a href="#__codelineno-10-43">43</a></span>
<span class="normal"><a href="#__codelineno-10-44">44</a></span>
<span class="normal"><a href="#__codelineno-10-45">45</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a>&gt;<span class="w"> </span>p<span class="w"> </span>*a
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="o">(</span>ggml_tensor<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">  </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>GGML_TYPE_F32
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">  </span><span class="nv">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">  </span><span class="nv">ne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">([</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>,<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>,<span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">)</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">  </span><span class="nv">nb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">([</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>,<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span>,<span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span>,<span class="w"> </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="o">)</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">  </span><span class="nv">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>GGML_OP_NONE
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">  </span><span class="nv">op_params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">    </span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">    </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">    </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">    </span><span class="o">[</span><span class="m">4</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">    </span><span class="o">[</span><span class="m">5</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="w">    </span><span class="o">[</span><span class="m">6</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="w">    </span><span class="o">[</span><span class="m">7</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="w">    </span><span class="o">[</span><span class="m">8</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="w">    </span><span class="o">[</span><span class="m">9</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="w">    </span><span class="o">[</span><span class="m">10</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="w">    </span><span class="o">[</span><span class="m">11</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="w">    </span><span class="o">[</span><span class="m">12</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="w">    </span><span class="o">[</span><span class="m">13</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="w">    </span><span class="o">[</span><span class="m">14</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="w">    </span><span class="o">[</span><span class="m">15</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="w">  </span><span class="o">}</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="w">  </span><span class="nv">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="w">  </span><span class="nv">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a><span class="w">    </span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-10-29" name="__codelineno-10-29"></a><span class="w">    </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-10-30" name="__codelineno-10-30"></a><span class="w">    </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-10-31" name="__codelineno-10-31"></a><span class="w">    </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-10-32" name="__codelineno-10-32"></a><span class="w">    </span><span class="o">[</span><span class="m">4</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-10-33" name="__codelineno-10-33"></a><span class="w">    </span><span class="o">[</span><span class="m">5</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-10-34" name="__codelineno-10-34"></a><span class="w">    </span><span class="o">[</span><span class="m">6</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-10-35" name="__codelineno-10-35"></a><span class="w">    </span><span class="o">[</span><span class="m">7</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-10-36" name="__codelineno-10-36"></a><span class="w">    </span><span class="o">[</span><span class="m">8</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-10-37" name="__codelineno-10-37"></a><span class="w">    </span><span class="o">[</span><span class="m">9</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-10-38" name="__codelineno-10-38"></a><span class="w">  </span><span class="o">}</span>
<a id="__codelineno-10-39" name="__codelineno-10-39"></a><span class="w">  </span><span class="nv">view_src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-10-40" name="__codelineno-10-40"></a><span class="w">  </span><span class="nv">view_offs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-10-41" name="__codelineno-10-41"></a><span class="w">  </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x00007fffb75eb1b0
<a id="__codelineno-10-42" name="__codelineno-10-42"></a><span class="w">  </span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span>
<a id="__codelineno-10-43" name="__codelineno-10-43"></a><span class="w">  </span><span class="nv">extra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x0000000000000000
<a id="__codelineno-10-44" name="__codelineno-10-44"></a><span class="w">  </span><span class="nv">padding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span>
<a id="__codelineno-10-45" name="__codelineno-10-45"></a><span class="o">}</span>
</code></pre></div></td></tr></tbody></table></div>
从上面的内容可以看到，ggml_tensor结构体的ne成员变量是一个数组，数组的元素个数是4，分别表示该张量的维度。例如，一个二维矩阵的ne成员变量为[2, 3, 1, 1]，表示该矩阵有3行2列，且行和列的索引从0开始。<p></p>
<h3 id="tensor的内存布局">tensor的内存布局<a class="headerlink" href="#tensor的内存布局" title="Permanent link">¶</a></h3>
<h4 id="f32矩阵">f32矩阵<a class="headerlink" href="#f32矩阵" title="Permanent link">¶</a></h4>
<p>对于ne的理解，比如一个RGB的图片，width为1920，height为1080， 用pytorch表示维度信息就是[1, 3, 1080, 1920],即[N, C, H, W]。而在GGML中，这个维度信息表示为：
[1920, 1080, 3, 1]。</p>
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span>
<span class="normal"><a href="#__codelineno-11-2">2</a></span>
<span class="normal"><a href="#__codelineno-11-3">3</a></span>
<span class="normal"><a href="#__codelineno-11-4">4</a></span>
<span class="normal"><a href="#__codelineno-11-5">5</a></span>
<span class="normal"><a href="#__codelineno-11-6">6</a></span>
<span class="normal"><a href="#__codelineno-11-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GGML_TYPE_F32</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="n">ne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="c1">// 4表示第一维每个元素所占字节数。8表示每行元素间隔8个字节，也就是间隔两个元素。</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="c1">// 也就是在内存存储的布局是row major连续存储的</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="n">nb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GGML_OP_NONE</span>
</code></pre></div></td></tr></tbody></table></div>
ne只表示了矩阵的维度，而nb表示了矩阵在内存中的存储布局，以及每行元素间隔。<p></p>
<h3 id="量化矩阵">量化矩阵<a class="headerlink" href="#量化矩阵" title="Permanent link">¶</a></h3>
<p>在上面的例子任意地方加一行表示一个量化矩阵。
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="n">ggml_tensor</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_new_tensor_2d</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_TYPE_Q4_0</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span>
</code></pre></div></td></tr></tbody></table></div><p></p>
<p>通过<code>p *c</code> 可以查看矩阵的详细信息。
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span>
<span class="normal"><a href="#__codelineno-13-2">2</a></span>
<span class="normal"><a href="#__codelineno-13-3">3</a></span>
<span class="normal"><a href="#__codelineno-13-4">4</a></span>
<span class="normal"><a href="#__codelineno-13-5">5</a></span>
<span class="normal"><a href="#__codelineno-13-6">6</a></span>
<span class="normal"><a href="#__codelineno-13-7">7</a></span>
<span class="normal"><a href="#__codelineno-13-8">8</a></span>
<span class="normal"><a href="#__codelineno-13-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a>&gt;<span class="w"> </span>p<span class="w"> </span>*c
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="o">(</span>ggml_tensor<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">  </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>GGML_TYPE_Q4_0
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">  </span><span class="nv">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">  </span><span class="nv">ne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">([</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">32</span>,<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>,<span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">)</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">  </span><span class="nv">nb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">([</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span>,<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span>,<span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">108</span>,<span class="w"> </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">108</span><span class="o">)</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">  </span><span class="nv">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>GGML_OP_NONE
<a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">  </span>......
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="o">}</span>
</code></pre></div></td></tr></tbody></table></div>
下面就分析认识一些Q4_0类型的矩阵表示有什么不同。
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span>
<span class="normal"><a href="#__codelineno-14-5">5</a></span>
<span class="normal"><a href="#__codelineno-14-6">6</a></span>
<span class="normal"><a href="#__codelineno-14-7">7</a></span>
<span class="normal"><a href="#__codelineno-14-8">8</a></span>
<span class="normal"><a href="#__codelineno-14-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">typedef</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">ggml_half</span><span class="p">;</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="cp">#define QK4_0 32</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">    </span><span class="c1">// 16bit存储delta信息, 2个字节</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">    </span><span class="n">ggml_half</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w">           </span><span class="c1">// delta</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="c1">// 8bit数组，数组长度为：16， 16个字节</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">qs</span><span class="p">[</span><span class="n">QK4_0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span><span class="w"> </span><span class="c1">// nibbles / quants</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="p">}</span><span class="w"> </span><span class="n">block_q4_0</span><span class="p">;</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="k">static_assert</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">block_q4_0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ggml_half</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">QK4_0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s">"wrong q4_0 block size/padding"</span><span class="p">);</span>
</code></pre></div></td></tr></tbody></table></div>
在GGML中，一个block_q4_0结构体，可以表示32个int4元素，再加上一个16bit的delta信息。<p></p>
<p>我们ne[0]和ne[1]分别为32, 16,表示了32行和16列的int4矩阵。而nb[0]为18，表示GGML的q4_0量化将32个int4元素组合在一起，再加上一个16位的差值，每组共18字节。</p>
<p>[32, 6, 1, 1]的Q4_0数组就可以看成[1,6,1,1]，因为32个元素为内存上的最小寻址单元。更高维度的情况下，nb[i] = nb[i-1] * ne[i]。</p>
<h3 id="矩阵permute重排列">矩阵permute重排列<a class="headerlink" href="#矩阵permute重排列" title="Permanent link">¶</a></h3>
<p>看一个pytorch例子，了解permute是什么？permute就是对数据的维度变化顺序
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span>
<span class="normal"><a href="#__codelineno-15-5">5</a></span>
<span class="normal"><a href="#__codelineno-15-6">6</a></span>
<span class="normal"><a href="#__codelineno-15-7">7</a></span>
<span class="normal"><a href="#__codelineno-15-8">8</a></span>
<span class="normal"><a href="#__codelineno-15-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="k">import</span><span class="w"> </span><span class="n">torch</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="k">import</span><span class="w"> </span><span class="n">numpy</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">np</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]]])</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="n">unpermuted</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="n">print</span><span class="p">(</span><span class="n">unpermuted</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w">              </span><span class="err">#</span><span class="w">  </span><span class="err">——</span><span class="o">&gt;</span><span class="w">  </span><span class="n">torch</span><span class="p">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="n">permuted</span><span class="o">=</span><span class="n">unpermuted</span><span class="p">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="n">print</span><span class="p">(</span><span class="n">permuted</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w">                </span><span class="err">#</span><span class="w">  </span><span class="err">——</span><span class="o">&gt;</span><span class="w">  </span><span class="n">torch</span><span class="p">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">])</span>
</code></pre></div></td></tr></tbody></table></div><p></p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="n">tensor</span><span class="p">([[[</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="mi">4</span><span class="p">]],</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">        </span><span class="p">[[</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">  </span><span class="mi">5</span><span class="p">]],</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">        </span><span class="p">[[</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">  </span><span class="mi">6</span><span class="p">]]])</span><span class="w">     </span><span class="err">#</span><span class="w"> </span><span class="n">print</span><span class="p">(</span><span class="n">permuted</span><span class="p">)</span><span class="w">    </span>
</code></pre></div></td></tr></tbody></table></div>
<p>再看ggml中的permute操作，添加如下例子:
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="n">ggml_tensor</span><span class="o">*</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="c1">// Same as PyTorch's permute()</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="n">ggml_tensor</span><span class="o">*</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_permute</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">before</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
</code></pre></div></td></tr></tbody></table></div>
观察before和after tensor信息，可以看到after的ne和nb中的0和1维度交换了，但是看data，其实数据内存存储本身是没有变化的。对于一个内存存储，要改变ne维度信息，只需要改变nb每个维度的间隔，也就是数据访问方式。<p></p>
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span>
<span class="normal"><a href="#__codelineno-18-18">18</a></span>
<span class="normal"><a href="#__codelineno-18-19">19</a></span>
<span class="normal"><a href="#__codelineno-18-20">20</a></span>
<span class="normal"><a href="#__codelineno-18-21">21</a></span>
<span class="normal"><a href="#__codelineno-18-22">22</a></span>
<span class="normal"><a href="#__codelineno-18-23">23</a></span>
<span class="normal"><a href="#__codelineno-18-24">24</a></span>
<span class="normal"><a href="#__codelineno-18-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a>&gt;<span class="w"> </span>p<span class="w"> </span>*before
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="o">(</span>ggml_tensor<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">  </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>GGML_TYPE_F32
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">  </span><span class="nv">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">  </span><span class="nv">ne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">([</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>,<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>,<span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">)</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">  </span><span class="nv">nb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">([</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>,<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span>,<span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span>,<span class="w"> </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="o">)</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">  </span><span class="nv">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>GGML_OP_NONE
<a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">  </span><span class="nv">view_src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">  </span><span class="nv">view_offs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">  </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x00007fffb77eb1b0
<a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="o">}</span>
<a id="__codelineno-18-12" name="__codelineno-18-12"></a>
<a id="__codelineno-18-13" name="__codelineno-18-13"></a>&gt;<span class="w"> </span>p<span class="w"> </span>*after
<a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="o">(</span>ggml_tensor<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-18-15" name="__codelineno-18-15"></a><span class="w">  </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>GGML_TYPE_F32
<a id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="w">  </span><span class="nv">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nullptr
<a id="__codelineno-18-17" name="__codelineno-18-17"></a><span class="w">  </span><span class="nv">ne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">([</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>,<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>,<span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">)</span>
<a id="__codelineno-18-18" name="__codelineno-18-18"></a><span class="w">  </span><span class="nv">nb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">([</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span>,<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>,<span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span>,<span class="w"> </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="o">)</span>
<a id="__codelineno-18-19" name="__codelineno-18-19"></a><span class="w">  </span><span class="nv">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>GGML_OP_PERMUTE
<a id="__codelineno-18-20" name="__codelineno-18-20"></a>
<a id="__codelineno-18-21" name="__codelineno-18-21"></a><span class="w">  </span><span class="nv">view_src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x00007fffb77eb060
<a id="__codelineno-18-22" name="__codelineno-18-22"></a><span class="w">  </span><span class="nv">view_offs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-18-23" name="__codelineno-18-23"></a><span class="w">  </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x00007fffb77eb1b0
<a id="__codelineno-18-24" name="__codelineno-18-24"></a><span class="w">  </span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">" (permuted)"</span>
<a id="__codelineno-18-25" name="__codelineno-18-25"></a><span class="o">}</span>
</code></pre></div></td></tr></tbody></table></div>
从view_src也可以看出after只是before的视图。<p></p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="c1">// Pseudo-code representation of tensor's memory layout</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="c1">// Accessing row 1 before permutation, nb[0] = 4</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="c1">// 1, 2,</span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="c1">// 3, 4,</span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="c1">// 5, 6</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="n">e0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="n">e1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="c1">// Accessing row 1 after permutation, nb[0] = 8</span>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="c1">// [[1,3,5],</span>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="c1">//  [2,4,6]]</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="n">e0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="n">e1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="n">e1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
</code></pre></div></td></tr></tbody></table></div>
<h3 id="张量视图">张量视图<a class="headerlink" href="#张量视图" title="Permanent link">¶</a></h3>
<p>视图可以对张量内存进行复用，避免拷贝、避免低效的为每个张量分配一个独特的内存块。</p>
<p>以ggml_cpy操作为例，拷贝的b tensor就是相对于a创建的一个视图。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span>
<span class="normal"><a href="#__codelineno-20-18">18</a></span>
<span class="normal"><a href="#__codelineno-20-19">19</a></span>
<span class="normal"><a href="#__codelineno-20-20">20</a></span>
<span class="normal"><a href="#__codelineno-20-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1">// ggml_cpy</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ggml_cpy_impl</span><span class="p">(</span>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_context</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="w">    </span><span class="n">GGML_ASSERT</span><span class="p">(</span><span class="n">ggml_nelements</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ggml_nelements</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="w">    </span><span class="c1">// make a view of the destination</span>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_view_tensor</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="w">        </span><span class="n">ggml_format_name</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="s">"%s (copy of %s)"</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<a id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-13" name="__codelineno-20-13"></a><span class="w">        </span><span class="n">ggml_format_name</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="s">"%s (copy)"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<a id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-20-15" name="__codelineno-20-15"></a>
<a id="__codelineno-20-16" name="__codelineno-20-16"></a><span class="w">    </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">op</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">GGML_OP_CPY</span><span class="p">;</span>
<a id="__codelineno-20-17" name="__codelineno-20-17"></a><span class="w">    </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<a id="__codelineno-20-18" name="__codelineno-20-18"></a><span class="w">    </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<a id="__codelineno-20-19" name="__codelineno-20-19"></a>
<a id="__codelineno-20-20" name="__codelineno-20-20"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<a id="__codelineno-20-21" name="__codelineno-20-21"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div>
<p>以LLM中Q、K、V tensor为例，下面的Qcur、Kcur、Vcur可以表示成创建的tensor_input的一部分。所以视图不用是base tensor的全部，可以只是一部分，通过offset可以设置相对base tensor的偏移量。
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="o">*</span><span class="w"> </span><span class="n">tensor_input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_new_tensor_2d</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_TYPE_32</span><span class="p">,</span><span class="w"> </span><span class="mi">768</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">);</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="c1">// Create a view tensor of shape (768, seq_len) with offset 0</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="c1">// The last parameter of ggml_view_2d specifies the view's offset (in bytes)</span>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="n">Qcur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_view_2d</span><span class="p">(</span><span class="n">ctx0</span><span class="p">,</span><span class="w"> </span><span class="n">tensor_input</span><span class="p">,</span><span class="w"> </span><span class="mi">768</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">768</span><span class="p">);</span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="c1">// Create a view tensor of shape (768, seq_len) with offset 768</span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="n">Kcur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_view_2d</span><span class="p">(</span><span class="n">ctx0</span><span class="p">,</span><span class="w"> </span><span class="n">tensor_input</span><span class="p">,</span><span class="w"> </span><span class="mi">768</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">768</span><span class="p">);</span>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a>
<a id="__codelineno-21-10" name="__codelineno-21-10"></a><span class="c1">// Create a view tensor of shape (768, seq_len) with offset 768 * 2</span>
<a id="__codelineno-21-11" name="__codelineno-21-11"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="n">Vcur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_view_2d</span><span class="p">(</span><span class="n">ctx0</span><span class="p">,</span><span class="w"> </span><span class="n">tensor_input</span><span class="p">,</span><span class="w"> </span><span class="mi">768</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">768</span><span class="p">);</span>
</code></pre></div></td></tr></tbody></table></div><p></p>
<h2 id="探索ggml的实现ggml的内存管理">探索ggml的实现–GGML的内存管理<a class="headerlink" href="#探索ggml的实现ggml的内存管理" title="Permanent link">¶</a></h2>
<p>本小节通过最简单的一个例子, ./examples/simple/simple-ctx.cpp，理解GGML实现两个矩阵执行矩阵乘法的核心工作流程。</p>
<p>这个例子具有以下特点，也因此作为我们理解的起点。</p>
<ul>
<li>
<p>在cpu上执行最简单的两个矩阵的乘法计算，与硬件显卡无关</p>
</li>
<li>
<p>所有的计算都在cpu上执行，所有的内存分配都在RAM中完成</p>
</li>
</ul>
<p>!!![warning]
    GGML采用c语言风格实现，所以在内存管理上，通过struct中的指针和偏移量来管理内存，我们需要跟踪指针值、计算偏移量，来理解它的内存布局。</p>
<h3 id="认识ggml_context">认识ggml_context<a class="headerlink" href="#认识ggml_context" title="Permanent link">¶</a></h3>
<p>跳过不重要的函数（比如： ggml_time_init），断点debug进入load_model函数。首先看到一个ctx_size的计算，通过ctx_size作为参数，调用了ggml_init函数, 初始化了struct ggml_context *。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx.png"></a></p>
<p>暂时先跳过复杂的ctx_size计算，重点关注这个GGML最重要的函数之一：ggml_init。</p>
<h4 id="理解ggml_init">理解ggml_init<a class="headerlink" href="#理解ggml_init" title="Permanent link">¶</a></h4>
<p>ggml_init函数接受一个参数ggml_init_params，这个参数中包含内存分配的参数。</p>
<ul>
<li>
<p>mem_size_: 内存池大小，也就是ctx_size（提前计算出来的）</p>
</li>
<li>
<p>mem_buffer_: 内存池，也就是ctx_buffer，这个内存池用于存储ggml_tensor结构体和数据。这里传递的NULL初始化，表示由内部分配</p>
</li>
<li>
<p>no_alloc_: 是否使用用户传递的内存池，如果为true，则使用用户传递的内存池。这个传递的false，表示由内部分配内存池。</p>
</li>
</ul>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_context</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ggml_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_init_params</span><span class="w"> </span><span class="n">params</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">    </span><span class="c1">// ......</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="p">}</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_init_params</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">    </span><span class="c1">// memory pool</span>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">mem_size</span><span class="p">;</span><span class="w">   </span><span class="c1">// bytes</span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mem_buffer</span><span class="p">;</span><span class="w"> </span><span class="c1">// if NULL, memory will be allocated internally</span>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="w">    </span><span class="kt">bool</span><span class="w">   </span><span class="n">no_alloc</span><span class="p">;</span><span class="w">   </span><span class="c1">// don't allocate memory for the tensor data</span>
<a id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="p">};</span>
</code></pre></div></td></tr></tbody></table></div>
<p>进入ggml_init函数，可以看到，首先在堆上分配了一个struct ggml_context *。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_init_func.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_init_func.png"></a></p>
<p>到这里，ggml_context内存布局如下图所示，我们接下来会一步一步了解内部的进一步分配。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph1.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph1.png"></a></p>
<h3 id="ggml的tensor表示">GGML的tensor表示<a class="headerlink" href="#ggml的tensor表示" title="Permanent link">¶</a></h3>
<p>在ggml_init函数执行完成后，紧接着就是对两个矩阵tensor的创建和内存赋值。包括了ggml_new_tensor_2d的调用，一直调用到真正的实现函数ggml_new_tensor_impl。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">1</a></span>
<span class="normal"><a href="#__codelineno-23-2">2</a></span>
<span class="normal"><a href="#__codelineno-23-3">3</a></span>
<span class="normal"><a href="#__codelineno-23-4">4</a></span>
<span class="normal"><a href="#__codelineno-23-5">5</a></span>
<span class="normal"><a href="#__codelineno-23-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="c1">// create tensors</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="n">model</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_new_tensor_2d</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_TYPE_F32</span><span class="p">,</span><span class="w"> </span><span class="n">cols_A</span><span class="p">,</span><span class="w"> </span><span class="n">rows_A</span><span class="p">);</span>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="n">model</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_new_tensor_2d</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_TYPE_F32</span><span class="p">,</span><span class="w"> </span><span class="n">cols_B</span><span class="p">,</span><span class="w"> </span><span class="n">rows_B</span><span class="p">);</span>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="n">memcpy</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">ggml_nbytes</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">a</span><span class="p">));</span>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="n">memcpy</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">ggml_nbytes</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">b</span><span class="p">));</span>
</code></pre></div></td></tr></tbody></table></div>
<p>关于view_src的内容可以跳过，主要用于处理张量视图，现在可以不用关心。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-new-tensor-impl.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-new-tensor-impl.png"></a></p>
<p>首先，一个问题就是：GGML的张量维度是如何表示的？</p>
<p>这里我们可以和pytorch的张量表示进行对比，因为你可以发现，它们的表示方式正好相反。</p>
<p>ggml采用一个四维数组表示shape信息。在pytorch中一个[batch, channels, height, width]的张量，ggml中表示为[width, height, channels, batch]。</p>
<p>pytorch从最外层到最内层的数据，是从左到右表示的。这里最内层，表示在内存存储上连续的维度。</p>
<p>比如row优先存储，一个3 * 4的矩阵（3行，4列），那最内层维度就是列，也就是4列。pytorch表示为[3, 4]，ggml表示为[4, 3]。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/row-colomn-matrix.png" data-desc-position="bottom"><img alt="picture from https://en.wikipedia.org/wiki/Row-_and_column-major_order" src="https://raw.githubusercontent.com/KenForever1/CDN/main/row-colomn-matrix.png"></a></p>
<p>上面计算出的data_size，先计算单行的size，然后乘以行数，得到矩阵的size。这里的type是float32类型，如果是量化类型，size就会不同，后面用到在讨论。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span>
<span class="normal"><a href="#__codelineno-24-2">2</a></span>
<span class="normal"><a href="#__codelineno-24-3">3</a></span>
<span class="normal"><a href="#__codelineno-24-4">4</a></span>
<span class="normal"><a href="#__codelineno-24-5">5</a></span>
<span class="normal"><a href="#__codelineno-24-6">6</a></span>
<span class="normal"><a href="#__codelineno-24-7">7</a></span>
<span class="normal"><a href="#__codelineno-24-8">8</a></span>
<span class="normal"><a href="#__codelineno-24-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kt">size_t</span><span class="w"> </span><span class="n">obj_alloc_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">view_src</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">no_alloc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">    </span><span class="c1">// allocate tensor data in the context's memory pool</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">    </span><span class="n">obj_alloc_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_size</span><span class="p">;</span>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="p">}</span>
<a id="__codelineno-24-7" name="__codelineno-24-7"></a>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_object</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">obj_new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_new_object</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_OBJECT_TYPE_TENSOR</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_TENSOR_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">obj_alloc_size</span><span class="p">);</span>
<a id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="n">GGML_ASSERT</span><span class="p">(</span><span class="n">obj_new</span><span class="p">);</span>
</code></pre></div></td></tr></tbody></table></div>
<p>如果view_src为空，且no_alloc为false，则调用ggml_new_object函数，分配一个struct ggml_object *，并初始化。分配的size就是tensor的size，这里就是data_size。</p>
<p>!!! [warning]
    view_src表示该obj是其它内存的视图，不需要分配内存，直接复用内存。</p>
<p>分配的ggml_object结构体有什么用呢？</p>
<h4 id="理解ggml_new_object">理解ggml_new_object<a class="headerlink" href="#理解ggml_new_object" title="Permanent link">¶</a></h4>
<p>直接看代码，可能有点困难，我们对关键点进行总结。</p>
<ul>
<li>
<p>在这个例子中，我们首先计算了context的size，据此分配了ggml_context。接下来的内存分配，包括obj的分配，都是在context的memory pool中完成。</p>
</li>
<li>
<p>ggml_object的定义可以看出，有一个next指针指向下一个ggml_object。因此它是通过链表来管理内存的，每个ggml_object对象都是一个链表节点。</p>
</li>
<li>
<p>初始状态下，ggml_object的objects_begin和objects_end都为NULL，表示这个链表为空。</p>
</li>
<li>
<p>ggml_object的用途是什么呢？ggml通过它来隐式的管理各种资源–包括tensor张量、计算图、work buffer等。链接具有O(n)的查找时间复杂度。</p>
</li>
</ul>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-new-obj.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-new-obj.png"></a></p>
<p>分配一个ggml_object对象，需要多大的内存呢？</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span>
<span class="normal"><a href="#__codelineno-25-2">2</a></span>
<span class="normal"><a href="#__codelineno-25-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_object</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">obj_new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_new_object</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_OBJECT_TYPE_TENSOR</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_TENSOR_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">obj_alloc_size</span><span class="p">);</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">GGML_TENSOR_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="p">);</span>
</code></pre></div></td></tr></tbody></table></div>
<p>以这里ggml_object分配的是tensor类型为例子：
包括了 struct ggml_object的size + struct ggml_tensor的size + obj_alloc_size（也就是tensor的data内存大小）。当然ggml_tensor struc的size和obj_alloc_size还需要进行内存对齐。</p>
<p>到此，我们的ggml_context内存布局（没有分配新的内存，所有的内存都是分配ctx时分配）如下图所示：</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph2.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph2.png"></a></p>
<h4 id="ggml_tensor如何定义">ggml_tensor如何定义<a class="headerlink" href="#ggml_tensor如何定义" title="Permanent link">¶</a></h4>
<p>上节，我们的第一个tensor，以及通过ggml_object进行了表示管理，并为其在ggml_context中分配了内存，那么ggml_tensor结构体的定义呢？</p>
<p>我们继续看ggml_new_tensor_impl函数中的下半部分内容。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span>
<span class="normal"><a href="#__codelineno-26-11">11</a></span>
<span class="normal"><a href="#__codelineno-26-12">12</a></span>
<span class="normal"><a href="#__codelineno-26-13">13</a></span>
<span class="normal"><a href="#__codelineno-26-14">14</a></span>
<span class="normal"><a href="#__codelineno-26-15">15</a></span>
<span class="normal"><a href="#__codelineno-26-16">16</a></span>
<span class="normal"><a href="#__codelineno-26-17">17</a></span>
<span class="normal"><a href="#__codelineno-26-18">18</a></span>
<span class="normal"><a href="#__codelineno-26-19">19</a></span>
<span class="normal"><a href="#__codelineno-26-20">20</a></span>
<span class="normal"><a href="#__codelineno-26-21">21</a></span>
<span class="normal"><a href="#__codelineno-26-22">22</a></span>
<span class="normal"><a href="#__codelineno-26-23">23</a></span>
<span class="normal"><a href="#__codelineno-26-24">24</a></span>
<span class="normal"><a href="#__codelineno-26-25">25</a></span>
<span class="normal"><a href="#__codelineno-26-26">26</a></span>
<span class="normal"><a href="#__codelineno-26-27">27</a></span>
<span class="normal"><a href="#__codelineno-26-28">28</a></span>
<span class="normal"><a href="#__codelineno-26-29">29</a></span>
<span class="normal"><a href="#__codelineno-26-30">30</a></span>
<span class="normal"><a href="#__codelineno-26-31">31</a></span>
<span class="normal"><a href="#__codelineno-26-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mem_buffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">obj_new</span><span class="o">-&gt;</span><span class="n">offs</span><span class="p">);</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="o">*</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="w">    </span><span class="cm">/*.type         =*/</span><span class="w"> </span><span class="n">type</span><span class="p">,</span>
<a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="w">    </span><span class="cm">/*.buffer       =*/</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="w">    </span><span class="cm">/*.ne           =*/</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="w">    </span><span class="cm">/*.nb           =*/</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="w">    </span><span class="cm">/*.op           =*/</span><span class="w"> </span><span class="n">GGML_OP_NONE</span><span class="p">,</span>
<a id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="w">    </span><span class="cm">/*.op_params    =*/</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="w">    </span><span class="cm">/*.flags        =*/</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="w">    </span><span class="cm">/*.src          =*/</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="w">    </span><span class="cm">/*.view_src     =*/</span><span class="w"> </span><span class="n">view_src</span><span class="p">,</span>
<a id="__codelineno-26-13" name="__codelineno-26-13"></a><span class="w">    </span><span class="cm">/*.view_offs    =*/</span><span class="w"> </span><span class="n">view_offs</span><span class="p">,</span>
<a id="__codelineno-26-14" name="__codelineno-26-14"></a><span class="w">    </span><span class="cm">/*.data         =*/</span><span class="w"> </span><span class="n">obj_alloc_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">result</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">data</span><span class="p">,</span>
<a id="__codelineno-26-15" name="__codelineno-26-15"></a><span class="w">    </span><span class="cm">/*.name         =*/</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-26-16" name="__codelineno-26-16"></a><span class="w">    </span><span class="cm">/*.extra        =*/</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<a id="__codelineno-26-17" name="__codelineno-26-17"></a><span class="w">    </span><span class="cm">/*.padding      =*/</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-26-18" name="__codelineno-26-18"></a><span class="p">};</span>
<a id="__codelineno-26-19" name="__codelineno-26-19"></a>
<a id="__codelineno-26-20" name="__codelineno-26-20"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_dims</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-21" name="__codelineno-26-21"></a><span class="w">    </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ne</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-26-22" name="__codelineno-26-22"></a><span class="p">}</span>
<a id="__codelineno-26-23" name="__codelineno-26-23"></a>
<a id="__codelineno-26-24" name="__codelineno-26-24"></a><span class="n">result</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_type_size</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
<a id="__codelineno-26-25" name="__codelineno-26-25"></a><span class="n">result</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">ggml_blck_size</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
<a id="__codelineno-26-26" name="__codelineno-26-26"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GGML_MAX_DIMS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-27" name="__codelineno-26-27"></a><span class="w">    </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-26-28" name="__codelineno-26-28"></a><span class="p">}</span>
<a id="__codelineno-26-29" name="__codelineno-26-29"></a>
<a id="__codelineno-26-30" name="__codelineno-26-30"></a><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">n_objects</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-26-31" name="__codelineno-26-31"></a>
<a id="__codelineno-26-32" name="__codelineno-26-32"></a><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</code></pre></div></td></tr></tbody></table></div>
<p>result指针指向了ctx-&gt;mem_buffer + obj_new-&gt;offs，也就是ggml_tensor结构体对象所分配的内存。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph3.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph3.png"></a></p>
<p>ggml_tensor结构体的关键字段如下：</p>
<ul>
<li>
<p>data：指向tensor张量数据存储起始地址，这里就是ggml_tensor结构体自身之后的第一个字节。</p>
</li>
<li>
<p>ne：一个大小为4的数组，表示每个维度的元素数量，这里是[2, 4, 1, 1]。</p>
</li>
<li>
<p>nb：一个大小为4的数组，表示每个维度的元素字节数，这里是[4, 8, 32, 32]。</p>
</li>
</ul>
<p>如果不考虑量化，计算方式如下:</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">1</a></span>
<span class="normal"><a href="#__codelineno-27-2">2</a></span>
<span class="normal"><a href="#__codelineno-27-3">3</a></span>
<span class="normal"><a href="#__codelineno-27-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="n">nb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="n">nb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="n">nb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="n">nb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ne</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</code></pre></div></td></tr></tbody></table></div>
<p>通过上面的内容我们以及了解了ggml_new_tensor_2d的工作原理。在simple-ctx例子中，会调用两次以分配两个tensor张量，一次为x，一次为y，分配后的内存布局如下图所示：</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph4.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph4.png"></a></p>
<p>然后通过memcpy将数据复制到ggml_tensor的data字段中。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph5.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph5.png"></a></p>
<p>这里的张量数据直接硬编码定义到了源代码中，因此不需要加载GGU文件，再更复杂的例子中会通过GGU文件加载数据。</p>
<h3 id="要点">要点<a class="headerlink" href="#要点" title="Permanent link">¶</a></h3>
<ul>
<li>
<p>ggml 通过ggml_context来处理内存分配</p>
</li>
<li>
<p>ggml_context中通过链表来管理内存，每个节点都是ggml_object结构体，隐式管理tensor张量、计算图、work buffer等资源。</p>
</li>
<li>
<p>ggml_tensor的维度表示和pytorch是相反的，这个需要注意。</p>
</li>
</ul>
<h2 id="探索ggml的实现ggml计算图构建">探索ggml的实现–GGML计算图构建<a class="headerlink" href="#探索ggml的实现ggml计算图构建" title="Permanent link">¶</a></h2>
<p>本小节介绍GGML如何构建和管理计算图相关的数据结构。</p>
<h3 id="在ggml_context中创建计算图">在ggml_context中创建计算图<a class="headerlink" href="#在ggml_context中创建计算图" title="Permanent link">¶</a></h3>
<p>上一节，完成了ggml_context的创建，并且完成了矩阵计算所需的ggml_tensor张量的创建。(load_model函数中实现的功能)</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span>
<span class="normal"><a href="#__codelineno-28-2">2</a></span>
<span class="normal"><a href="#__codelineno-28-3">3</a></span>
<span class="normal"><a href="#__codelineno-28-4">4</a></span>
<span class="normal"><a href="#__codelineno-28-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="n">simple_model</span><span class="w"> </span><span class="n">model</span><span class="p">;</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="n">load_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_A</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_B</span><span class="p">,</span><span class="w"> </span><span class="n">rows_A</span><span class="p">,</span><span class="w"> </span><span class="n">cols_A</span><span class="p">,</span><span class="w"> </span><span class="n">rows_B</span><span class="p">,</span><span class="w"> </span><span class="n">cols_B</span><span class="p">);</span>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a>
<a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="c1">// perform computation in cpu</span>
<a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute</span><span class="p">(</span><span class="n">model</span><span class="p">);</span>
</code></pre></div></td></tr></tbody></table></div>
<p>接下来重点研究的就是compute函数，分为构建计算图、执行图计算、获取结果（获取最后一个计算节点的输出结果）三个步骤。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="c1">// compute with backend</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">compute</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">simple_model</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_cgraph</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">build_graph</span><span class="p">(</span><span class="n">model</span><span class="p">);</span>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a>
<a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n_threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// number of threads to perform some operations with multi-threading</span>
<a id="__codelineno-29-6" name="__codelineno-29-6"></a>
<a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="w">    </span><span class="n">ggml_graph_compute_with_ctx</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">gf</span><span class="p">,</span><span class="w"> </span><span class="n">n_threads</span><span class="p">);</span>
<a id="__codelineno-29-8" name="__codelineno-29-8"></a>
<a id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="w">    </span><span class="c1">// in this case, the output tensor is the last one in the graph</span>
<a id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ggml_graph_node</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>
<a id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div>
<p>在build_graph函数中，首先会调用<strong>ggml_new_graph</strong>，这个函数可以和前一节中ggml_new_tensor函数一样的方式理解。它也是创建了ggml_object对象，但是不同的是，<strong>这个object管理的是计算图（ggml_cgraph结构体对象）</strong>，而不是tensor张量。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-new-graph-custom.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-new-graph-custom.png"></a></p>
<ul>
<li>
<p>通过ggml_graph_nbytes函数获取计算图需要占用的内存大小</p>
</li>
<li>
<p>ggml_new_object根据计算图大小在ggml_context内存区域中分配一块内存，创建ggml_object对象</p>
</li>
<li>
<p>通过offs偏移获取ggml_object中管理的ggml_cgraph结构体对象指针，完成计算图的构建</p>
</li>
</ul>
<p>现在我们再对细节进行展开介绍：</p>
<h4 id="ggml_gral_nbytes计算细节">ggml_gral_nbytes计算细节<a class="headerlink" href="#ggml_gral_nbytes计算细节" title="Permanent link">¶</a></h4>
<p>GGML_DEFAULT_GRAPH_SIZE是一个宏定义，默认值为2048。定义了单个ggml_cgraph中可分配的最大节点树和leaf（叶节点）张量数。然后使用ggml_hash_size函数计算hash表需要的内存大小，乘以2是需要管理nodes和leafs两种类型。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span>
<span class="normal"><a href="#__codelineno-30-14">14</a></span>
<span class="normal"><a href="#__codelineno-30-15">15</a></span>
<span class="normal"><a href="#__codelineno-30-16">16</a></span>
<span class="normal"><a href="#__codelineno-30-17">17</a></span>
<span class="normal"><a href="#__codelineno-30-18">18</a></span>
<span class="normal"><a href="#__codelineno-30-19">19</a></span>
<span class="normal"><a href="#__codelineno-30-20">20</a></span>
<span class="normal"><a href="#__codelineno-30-21">21</a></span>
<span class="normal"><a href="#__codelineno-30-22">22</a></span>
<span class="normal"><a href="#__codelineno-30-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="c1">// 调用ggml_new_graph_custom传递的参数</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="n">ggml_new_graph_custom</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_DEFAULT_GRAPH_SIZE</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-30-3" name="__codelineno-30-3"></a>
<a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="cp">#define GGML_DEFAULT_GRAPH_SIZE 2048</span>
<a id="__codelineno-30-5" name="__codelineno-30-5"></a>
<a id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="k">static</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">ggml_graph_nbytes</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">grads</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">hash_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_hash_size</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="w">    </span><span class="n">incr_ptr_aligned</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_cgraph</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="w">    </span><span class="n">incr_ptr_aligned</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="p">));</span><span class="w"> </span><span class="c1">// nodes</span>
<a id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="w">    </span><span class="n">incr_ptr_aligned</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="p">));</span><span class="w"> </span><span class="c1">// leafs</span>
<a id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="w">    </span><span class="n">incr_ptr_aligned</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">hash_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">));</span><span class="w"> </span><span class="c1">// use_counts</span>
<a id="__codelineno-30-13" name="__codelineno-30-13"></a><span class="w">    </span><span class="n">incr_ptr_aligned</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">hash_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="p">));</span><span class="w"> </span><span class="c1">// hash keys</span>
<a id="__codelineno-30-14" name="__codelineno-30-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">grads</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-15" name="__codelineno-30-15"></a><span class="w">        </span><span class="n">incr_ptr_aligned</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">hash_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="p">));</span><span class="w"> </span><span class="c1">// grads</span>
<a id="__codelineno-30-16" name="__codelineno-30-16"></a><span class="w">        </span><span class="n">incr_ptr_aligned</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">hash_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="p">));</span><span class="w"> </span><span class="c1">// grad_accs</span>
<a id="__codelineno-30-17" name="__codelineno-30-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-18" name="__codelineno-30-18"></a><span class="w">    </span><span class="c1">// 计算hash_size需要多少个ggml_bitset_t表示状态，这些多个ggml_bitset_t构成了bit位图</span>
<a id="__codelineno-30-19" name="__codelineno-30-19"></a><span class="w">    </span><span class="n">incr_ptr_aligned</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">ggml_bitset_size</span><span class="p">(</span><span class="n">hash_size</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ggml_bitset_t</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ggml_bitset_t</span><span class="p">));</span>
<a id="__codelineno-30-20" name="__codelineno-30-20"></a>
<a id="__codelineno-30-21" name="__codelineno-30-21"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">nbytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-30-22" name="__codelineno-30-22"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nbytes</span><span class="p">;</span>
<a id="__codelineno-30-23" name="__codelineno-30-23"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div>
<p>ggml_hash_size从其实现来看，通过二分查找找到大于或等于2 * GGML_DEFAULT_GRAPH_SIZE的最小质数，这个质数决定了计算图哈希表的大小。选择质数主要是出于性能考虑：GGML采用了一种简单的开放地址哈希函数，并使用线性探测法。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1">1</a></span>
<span class="normal"><a href="#__codelineno-31-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="c1">// the last 4 bits are always zero due to alignment</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="n">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ggml_tensor_pointer_value</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">table_size</span>
</code></pre></div></td></tr></tbody></table></div>
<blockquote>
<blockquote>
<blockquote>
<p>使用质数表大小有助于更均匀地分布键，减少聚集、提高查找效率。</p>
</blockquote>
</blockquote>
</blockquote>
<p>ggml_graph的内存布局：</p>
<ul>
<li>
<p>ggml_cgraph结构体对象占用空间：sizeof(struct ggml_cgraph)</p>
</li>
<li>
<p>2048个tensor张量指针，指向nodes</p>
</li>
<li>
<p>2048个tensor张量指针，指向leafs</p>
</li>
<li>
<p>hash_size个int32_t，用于记录张量的使用次数</p>
</li>
<li>
<p>hash_size个tensor张量指针，用于存储张量的哈希键</p>
</li>
<li>
<p>梯度相关，simple_ctx例子不涉及</p>
</li>
<li>
<p>哈希表bit位图，用于记录张量的使用情况</p>
</li>
</ul>
<p>关于bit位图，</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-32-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-32-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-32-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-32-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-32-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-32-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-32-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-32-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-32-10">10</a></span>
<span class="normal"><a href="#__codelineno-32-11">11</a></span>
<span class="normal"><a href="#__codelineno-32-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="k">typedef</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ggml_bitset_t</span><span class="p">;</span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a>
<a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="k">static_assert</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ggml_bitset_t</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s">"bitset_t constants must be updated"</span><span class="p">);</span>
<a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="cp">#define BITSET_SHR 5 </span><span class="c1">// log2(sizeof(ggml_bitset_t)*8)</span>
<a id="__codelineno-32-5" name="__codelineno-32-5"></a><span class="cp">#define BITSET_MASK (sizeof(ggml_bitset_t)*8 - 1)</span>
<a id="__codelineno-32-6" name="__codelineno-32-6"></a>
<a id="__codelineno-32-7" name="__codelineno-32-7"></a>
<a id="__codelineno-32-8" name="__codelineno-32-8"></a><span class="c1">// &gt;&gt; BITSET_SHR相当于除以32，表示数字n的bit记录位于第几个ggml_bitset_t中</span>
<a id="__codelineno-32-9" name="__codelineno-32-9"></a><span class="c1">// 一个ggml_bitset_t可以表示32个数的状态，在本文上下文中即表示一个hash位置</span>
<a id="__codelineno-32-10" name="__codelineno-32-10"></a><span class="k">static</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">ggml_bitset_size</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-11" name="__codelineno-32-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">BITSET_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">BITSET_SHR</span><span class="p">;</span>
<a id="__codelineno-32-12" name="__codelineno-32-12"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div>
<p>根据ggml_graph_nbytes函数计算出来的内存大小，在ctx中分配内存，分配后的内存布局如下：</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_graph_graph1.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_graph_graph1.png"></a></p>
<p>包括计算图对象、节点指针、叶子指针、使用次数、哈希键、梯度、哈希表bit位图。接下来的几行代码初始化指向已分配内存中不同区域的指针，并将它们存储在ggml_cgraph结构体中。最后，哈希表被重置，所有槽位都被标记为未占用。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_graph_graph2.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_graph_graph2.png"></a></p>
<h3 id="构建矩阵乘计算图">构建矩阵乘计算图<a class="headerlink" href="#构建矩阵乘计算图" title="Permanent link">¶</a></h3>
<p>前面的内容介绍了在ggml_context中分配一个计算图内存，并且初始化了相关成员默认值。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1">1</a></span>
<span class="normal"><a href="#__codelineno-33-2">2</a></span>
<span class="normal"><a href="#__codelineno-33-3">3</a></span>
<span class="normal"><a href="#__codelineno-33-4">4</a></span>
<span class="normal"><a href="#__codelineno-33-5">5</a></span>
<span class="normal"><a href="#__codelineno-33-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_cgraph</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">gf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_new_graph</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">ctx</span><span class="p">);</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="c1">// 用gf表示矩阵乘任务</span>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="c1">// result = a*b^T</span>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_mul_mat</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">b</span><span class="p">);</span>
<a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="n">ggml_build_forward_expand</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
</code></pre></div></td></tr></tbody></table></div>
<p>现在这个计算图gf支持添加2048个张量节点和叶节点，但是还没有将矩阵乘这个计算的节点加入计算图。接下来的内容就是介绍如何将矩阵乘任务信息用计算图进行表示。</p>
<p>在ggml_mul_mat函数中，首先检查输入张量的合法性，然后创建一个结果张量，并设置张量的运算类型为矩阵乘。
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span>
<span class="normal"><a href="#__codelineno-34-11">11</a></span>
<span class="normal"><a href="#__codelineno-34-12">12</a></span>
<span class="normal"><a href="#__codelineno-34-13">13</a></span>
<span class="normal"><a href="#__codelineno-34-14">14</a></span>
<span class="normal"><a href="#__codelineno-34-15">15</a></span>
<span class="normal"><a href="#__codelineno-34-16">16</a></span>
<span class="normal"><a href="#__codelineno-34-17">17</a></span>
<span class="normal"><a href="#__codelineno-34-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ggml_mul_mat</span><span class="p">(</span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_context</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span>
<a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="w">    </span><span class="n">GGML_ASSERT</span><span class="p">(</span><span class="n">ggml_can_mul_mat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">));</span>
<a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="w">    </span><span class="n">GGML_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">ggml_is_transposed</span><span class="p">(</span><span class="n">a</span><span class="p">));</span>
<a id="__codelineno-34-7" name="__codelineno-34-7"></a>
<a id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="w">    </span><span class="c1">// 计算结果的shape</span>
<a id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">ne</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_new_tensor</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_TYPE_F32</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">ne</span><span class="p">);</span>
<a id="__codelineno-34-11" name="__codelineno-34-11"></a>
<a id="__codelineno-34-12" name="__codelineno-34-12"></a><span class="w">    </span><span class="c1">// 将加入graph nodes中的一个node，类型位矩阵乘</span>
<a id="__codelineno-34-13" name="__codelineno-34-13"></a><span class="w">    </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">op</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">GGML_OP_MUL_MAT</span><span class="p">;</span>
<a id="__codelineno-34-14" name="__codelineno-34-14"></a><span class="w">    </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<a id="__codelineno-34-15" name="__codelineno-34-15"></a><span class="w">    </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<a id="__codelineno-34-16" name="__codelineno-34-16"></a>
<a id="__codelineno-34-17" name="__codelineno-34-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<a id="__codelineno-34-18" name="__codelineno-34-18"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div><p></p>
<p>现在，到了我们构建计算图的最后阶段了，秘密就藏在ggml_build_forward_expand函数中。</p>
<p>函数的输入参数是我们创建的“空图”和矩阵乘任务所返回的矩阵乘结果节点（在复杂的案例中，就是模型的输出节点或者LLM中的logits）。</p>
<h4 id="ggml_build_forward_expand-函数细节探索">ggml_build_forward_expand 函数细节探索<a class="headerlink" href="#ggml_build_forward_expand-函数细节探索" title="Permanent link">¶</a></h4>
<p>该函数调用到了ggml_build_forward_impl函数，核心实现在ggml_visit_parents中。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-35-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-35-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-35-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-35-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-35-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-35-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-35-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-35-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-35-10">10</a></span>
<span class="normal"><a href="#__codelineno-35-11">11</a></span>
<span class="normal"><a href="#__codelineno-35-12">12</a></span>
<span class="normal"><a href="#__codelineno-35-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ggml_build_forward_impl</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_cgraph</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cgraph</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tensor</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">expand</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cgraph</span><span class="o">-&gt;</span><span class="n">n_nodes</span><span class="p">;</span>
<a id="__codelineno-35-3" name="__codelineno-35-3"></a>
<a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="w">    </span><span class="n">ggml_visit_parents</span><span class="p">(</span><span class="n">cgraph</span><span class="p">,</span><span class="w"> </span><span class="n">tensor</span><span class="p">);</span>
<a id="__codelineno-35-5" name="__codelineno-35-5"></a>
<a id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cgraph</span><span class="o">-&gt;</span><span class="n">n_nodes</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n0</span><span class="p">;</span>
<a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="w">    </span><span class="n">GGML_PRINT_DEBUG</span><span class="p">(</span><span class="s">"%s: visited %d new nodes</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">n_new</span><span class="p">);</span>
<a id="__codelineno-35-8" name="__codelineno-35-8"></a>
<a id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n_new</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="w">        </span><span class="c1">// the last added node should always be starting point</span>
<a id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="w">        </span><span class="n">GGML_ASSERT</span><span class="p">(</span><span class="n">cgraph</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="n">cgraph</span><span class="o">-&gt;</span><span class="n">n_nodes</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tensor</span><span class="p">);</span>
<a id="__codelineno-35-12" name="__codelineno-35-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-35-13" name="__codelineno-35-13"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div>
<p>ggml_visit_parents函数通过递归的方式构建了计算图。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_visit_parents-1.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_visit_parents-1.png"></a></p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_visit_parents-2.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_visit_parents-2.png"></a></p>
<p>核心逻辑：</p>
<ul>
<li>
<p>检查当前张量是否已存在于哈希表中。如果存在，则停止执行并返回。</p>
</li>
<li>
<p>对所有src张量递归调用ggml_visit_parents函数。</p>
</li>
<li>
<p>如果它是一个叶节点（即常量张量或不由运算生成的输入张量），则将其存储在图的叶数组（leafs数组）中。</p>
</li>
<li>
<p>否则，将其存储在图的节点数组（nodes数组）中。</p>
</li>
</ul>
<p>所有递归调用返回后，最后一次检查会确保最后记录的节点是结果张量。因为使用了后序遍历，这意味着输入节点（张量）是最后插入的。</p>
<p>采用debug打印gf计算图信息，1个node节点就是mat mul op节点，两个leaf节点就是两个输入张量a、b矩阵。
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span>
<span class="normal"><a href="#__codelineno-36-15">15</a></span>
<span class="normal"><a href="#__codelineno-36-16">16</a></span>
<span class="normal"><a href="#__codelineno-36-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">*</span><span class="n">gf</span>
<a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="p">(</span><span class="n">ggml_cgraph</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="w">  </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2048</span>
<a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="w">  </span><span class="n">n_nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="w">  </span><span class="n">n_leafs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="w">  </span><span class="n">nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x000055555556ddd8</span>
<a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="w">  </span><span class="n">grads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span>
<a id="__codelineno-36-8" name="__codelineno-36-8"></a><span class="w">  </span><span class="n">grad_accs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span>
<a id="__codelineno-36-9" name="__codelineno-36-9"></a><span class="w">  </span><span class="n">leafs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0000555555571dd8</span>
<a id="__codelineno-36-10" name="__codelineno-36-10"></a><span class="w">  </span><span class="n">use_counts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0000555555575dd8</span>
<a id="__codelineno-36-11" name="__codelineno-36-11"></a><span class="w">  </span><span class="n">visited_hash_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-12" name="__codelineno-36-12"></a><span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4099</span>
<a id="__codelineno-36-13" name="__codelineno-36-13"></a><span class="w">    </span><span class="n">used</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0000555555581e00</span>
<a id="__codelineno-36-14" name="__codelineno-36-14"></a><span class="w">    </span><span class="n">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0000555555579de8</span>
<a id="__codelineno-36-15" name="__codelineno-36-15"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-36-16" name="__codelineno-36-16"></a><span class="w">  </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GGML_CGRAPH_EVAL_ORDER_LEFT_TO_RIGHT</span>
<a id="__codelineno-36-17" name="__codelineno-36-17"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div><p></p>
<p>到目前为止，我们已经构建好了a、b矩阵乘这个任务的计算图，接下来就是看GGML如何执行这个计算图并获取计算结果了。</p>
<h2 id="探索ggml的实现执行ggml计算图">探索ggml的实现–执行GGML计算图<a class="headerlink" href="#探索ggml的实现执行ggml计算图" title="Permanent link">¶</a></h2>
<p>这节主要介绍如何计算GGML计算图，实现的核心逻辑在ggml_graph_compute_with_ctx函数中。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1">1</a></span>
<span class="normal"><a href="#__codelineno-37-2">2</a></span>
<span class="normal"><a href="#__codelineno-37-3">3</a></span>
<span class="normal"><a href="#__codelineno-37-4">4</a></span>
<span class="normal"><a href="#__codelineno-37-5">5</a></span>
<span class="normal"><a href="#__codelineno-37-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">n_threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// number of threads to perform some operations with multi-threading</span>
<a id="__codelineno-37-2" name="__codelineno-37-2"></a>
<a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="n">ggml_graph_compute_with_ctx</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">gf</span><span class="p">,</span><span class="w"> </span><span class="n">n_threads</span><span class="p">);</span>
<a id="__codelineno-37-4" name="__codelineno-37-4"></a>
<a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="c1">// in this case, the output tensor is the last one in the graph</span>
<a id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="k">return</span><span class="w"> </span><span class="n">ggml_graph_node</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>
</code></pre></div></td></tr></tbody></table></div>
<p>在该函数中，首先创建了个一个计算计划，并且根据cplan的work_size分配了完成这个plan所需的buffer，然后调用ggml_graph_compute函数执行计算计划。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1">1</a></span>
<span class="normal"><a href="#__codelineno-38-2">2</a></span>
<span class="normal"><a href="#__codelineno-38-3">3</a></span>
<span class="normal"><a href="#__codelineno-38-4">4</a></span>
<span class="normal"><a href="#__codelineno-38-5">5</a></span>
<span class="normal"><a href="#__codelineno-38-6">6</a></span>
<span class="normal"><a href="#__codelineno-38-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="k">enum</span><span class="w"> </span><span class="nc">ggml_status</span><span class="w"> </span><span class="n">ggml_graph_compute_with_ctx</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_context</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_cgraph</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cgraph</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_threads</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_cplan</span><span class="w"> </span><span class="n">cplan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_graph_plan</span><span class="p">(</span><span class="n">cgraph</span><span class="p">,</span><span class="w"> </span><span class="n">n_threads</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-38-3" name="__codelineno-38-3"></a>
<a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="w">    </span><span class="n">cplan</span><span class="p">.</span><span class="n">work_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ggml_new_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">cplan</span><span class="p">.</span><span class="n">work_size</span><span class="p">);</span>
<a id="__codelineno-38-5" name="__codelineno-38-5"></a>
<a id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ggml_graph_compute</span><span class="p">(</span><span class="n">cgraph</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cplan</span><span class="p">);</span>
<a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div>
<p>ggml_cplan结构体的核心目的是：<strong>确定计算的关键执行参数</strong>。</p>
<ul>
<li>
<p>n_threads：用于图计算的线程数，这个设置为了1。</p>
</li>
<li>
<p>work_size：计算计划所需的临时内存大小（字节为单位）。在simple-ctx这个示例中，这个值被设置为0，不同的后端和op需要的work_size有不同。</p>
</li>
</ul>
<h3 id="探索ggml_graph_plan细节">探索ggml_graph_plan细节<a class="headerlink" href="#探索ggml_graph_plan细节" title="Permanent link">¶</a></h3>
<h4 id="如何确定线程数量">如何确定线程数量<a class="headerlink" href="#如何确定线程数量" title="Permanent link">¶</a></h4>
<p>ggml_graph_plan函数实现的主要功能就是确定计算计划所需的线程数和临时内存大小。</p>
<p>确定线程数的逻辑：</p>
<ul>
<li>
<p>首先，传递的参数n_threads决定了cplan的线程数上限。</p>
</li>
<li>
<p>通过迭代所有的op node，根据op类型的线程限制和n_threads参数，确max_threads。（通过op的swich case实现）</p>
</li>
<li>
<p>最终线程计算如下：</p>
</li>
</ul>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="n">final_n_threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MIN</span><span class="p">(</span><span class="n">n_threads</span><span class="p">,</span><span class="w"> </span><span class="n">MAX</span><span class="p">(</span><span class="n">each</span><span class="w"> </span><span class="n">node</span><span class="err">'</span><span class="n">s</span><span class="w"> </span><span class="n">maximum</span><span class="w"> </span><span class="n">multithreading</span><span class="w"> </span><span class="n">count</span><span class="p">))</span>
</code></pre></div></td></tr></tbody></table></div>
<h4 id="确定工作缓存区大小">确定工作缓存区大小<a class="headerlink" href="#确定工作缓存区大小" title="Permanent link">¶</a></h4>
<ul>
<li>
<p>遍历所有的op node，根据每个op type以及计算的数据类型（比如计算的矩阵乘两个参数数据类不同，需要额外的缓存区），确定需要的临时内存大小。</p>
</li>
<li>
<p>最终工作缓存区大小计算如下：
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="n">final_work_buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX</span><span class="p">(</span><span class="n">each</span><span class="w"> </span><span class="n">node</span><span class="err">'</span><span class="n">s</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div><p></p>
</li>
</ul>
<p>在simple-ctx这个例子中，threads_count = 1， work_buffer_size = 0。在接下来的函数ggml_new_buffer中，可以看到分配的work_buffer_size大小的缓存区，也是在context的内存buffer中分配的。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1">1</a></span>
<span class="normal"><a href="#__codelineno-41-2">2</a></span>
<span class="normal"><a href="#__codelineno-41-3">3</a></span>
<span class="normal"><a href="#__codelineno-41-4">4</a></span>
<span class="normal"><a href="#__codelineno-41-5">5</a></span>
<span class="normal"><a href="#__codelineno-41-6">6</a></span>
<span class="normal"><a href="#__codelineno-41-7">7</a></span>
<span class="normal"><a href="#__codelineno-41-8">8</a></span>
<span class="normal"><a href="#__codelineno-41-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">cplan</span>
<a id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="p">(</span><span class="n">ggml_cplan</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="w">  </span><span class="n">work_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-41-4" name="__codelineno-41-4"></a><span class="w">  </span><span class="n">work_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00005555555821d0</span><span class="w"> </span><span class="s">""</span>
<a id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="w">  </span><span class="n">n_threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-41-6" name="__codelineno-41-6"></a><span class="w">  </span><span class="n">threadpool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span>
<a id="__codelineno-41-7" name="__codelineno-41-7"></a><span class="w">  </span><span class="n">abort_callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0000000000000000</span>
<a id="__codelineno-41-8" name="__codelineno-41-8"></a><span class="w">  </span><span class="n">abort_callback_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0000000000000000</span>
<a id="__codelineno-41-9" name="__codelineno-41-9"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div>
<h3 id="计算图的执行计算">计算图的执行计算<a class="headerlink" href="#计算图的执行计算" title="Permanent link">¶</a></h3>
<p>到目前为止，为了执行计算图，已经准备好了张量数据、计算图、计算计划（plan），执行的关键逻辑来到了ggml_graph_compute函数，将计算图cgraph和cplan作为参数传入。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="n">ggml_graph_compute</span><span class="p">(</span><span class="n">cgraph</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cplan</span><span class="p">);</span>
</code></pre></div></td></tr></tbody></table></div>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-graph-compute.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-graph-compute.png"></a></p>
<p>在ggml_graph_compute函数中, 实现了如下核心功能：</p>
<ul>
<li>在ggml_cpu_init函数中，创建了一些快速计算的查找表。比如f32到f16的转换表、gelu计算的查找表。</li>
</ul>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1">1</a></span>
<span class="normal"><a href="#__codelineno-43-2">2</a></span>
<span class="normal"><a href="#__codelineno-43-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="n">ggml_table_f32_f16</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">;</span>
<a id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="n">ggml_table_gelu_f16</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GGML_CPU_FP32_TO_FP16</span><span class="p">(</span><span class="n">ggml_gelu_f32</span><span class="p">(</span><span class="n">f</span><span class="p">));</span>
<a id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="n">ggml_table_gelu_quick_f16</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GGML_CPU_FP32_TO_FP16</span><span class="p">(</span><span class="n">ggml_gelu_quick_f32</span><span class="p">(</span><span class="n">f</span><span class="p">));</span>
</code></pre></div></td></tr></tbody></table></div>
<ul>
<li>创建了线程池，将计算图和计算任务dispath给线程池执行。在linux下，ggml采用pthread实现线程相关操作。（关于GGML_USE_OPENMP的逻辑可以先跳过）</li>
</ul>
<h4 id="ggml线程池实现">GGML线程池实现<a class="headerlink" href="#ggml线程池实现" title="Permanent link">¶</a></h4>
<p>GGML 实现了一个线程池，该线程池经过优化，可高效运行计算图，并针对 NUMA 架构进行了优化。</p>
<p>ggml首先使用默认参数初始化一个ggml_thread_pool结构体，然后为每个工作线程分配一个状态结构体（ggml_compute_state），负责线程池中的每个线程的状态记录：
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-44-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-44-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-44-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-44-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-44-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-44-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-44-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-44-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-44-10">10</a></span>
<span class="normal"><a href="#__codelineno-44-11">11</a></span>
<span class="normal"><a href="#__codelineno-44-12">12</a></span>
<span class="normal"><a href="#__codelineno-44-13">13</a></span>
<span class="normal"><a href="#__codelineno-44-14">14</a></span>
<span class="normal"><a href="#__codelineno-44-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="c1">// Per-thread state</span>
<a id="__codelineno-44-2" name="__codelineno-44-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_compute_state</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="cp">#ifndef GGML_USE_OPENMP</span>
<a id="__codelineno-44-4" name="__codelineno-44-4"></a><span class="w">    </span><span class="c1">// linux下实际为pthread</span>
<a id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="w">    </span><span class="n">ggml_thread_t</span><span class="w"> </span><span class="n">thrd</span><span class="p">;</span>
<a id="__codelineno-44-6" name="__codelineno-44-6"></a><span class="w">    </span><span class="c1">// 用于设置cpu亲和性（NUMA相关优化）</span>
<a id="__codelineno-44-7" name="__codelineno-44-7"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">cpumask</span><span class="p">[</span><span class="n">GGML_MAX_N_THREADS</span><span class="p">];</span>
<a id="__codelineno-44-8" name="__codelineno-44-8"></a><span class="w">    </span><span class="kt">int</span><span class="w">  </span><span class="n">last_graph</span><span class="p">;</span>
<a id="__codelineno-44-9" name="__codelineno-44-9"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">pending</span><span class="p">;</span>
<a id="__codelineno-44-10" name="__codelineno-44-10"></a><span class="cp">#endif</span>
<a id="__codelineno-44-11" name="__codelineno-44-11"></a><span class="w">    </span><span class="c1">// 指向线程池的指针</span>
<a id="__codelineno-44-12" name="__codelineno-44-12"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_threadpool</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadpool</span><span class="p">;</span>
<a id="__codelineno-44-13" name="__codelineno-44-13"></a><span class="w">    </span><span class="c1">// 线程编号</span>
<a id="__codelineno-44-14" name="__codelineno-44-14"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ith</span><span class="p">;</span>
<a id="__codelineno-44-15" name="__codelineno-44-15"></a><span class="p">};</span>
</code></pre></div></td></tr></tbody></table></div><p></p>
<p>如果启用了 OpenMP，线程管理会自动处理；否则，GGML 会手动创建和管理 pthread，即手动设置cpu亲和性等操作。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_threadpool.png" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_threadpool.png"></a></p>
<h4 id="cpu亲和性设置">cpu亲和性设置<a class="headerlink" href="#cpu亲和性设置" title="Permanent link">¶</a></h4>
<p>由于在numa架构下，本地/远程内存访问速度差异大，通过NUMA感知调度（如线程绑定、内存分配优化）可提升性能‌。通过设置cpu亲和性，绑定线程到本地NUMA节点，减少远程访问‌。</p>
<p>在ggml的实现中，通过函数ggml_thread_cpumask_next()为每个worker线程分配cpu亲和性。</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-45-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-45-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-45-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-45-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-45-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-45-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-45-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-45-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-45-10">10</a></span>
<span class="normal"><a href="#__codelineno-45-11">11</a></span>
<span class="normal"><a href="#__codelineno-45-12">12</a></span>
<span class="normal"><a href="#__codelineno-45-13">13</a></span>
<span class="normal"><a href="#__codelineno-45-14">14</a></span>
<span class="normal"><a href="#__codelineno-45-15">15</a></span>
<span class="normal"><a href="#__codelineno-45-16">16</a></span>
<span class="normal"><a href="#__codelineno-45-17">17</a></span>
<span class="normal"><a href="#__codelineno-45-18">18</a></span>
<span class="normal"><a href="#__codelineno-45-19">19</a></span>
<span class="normal"><a href="#__codelineno-45-20">20</a></span>
<span class="normal"><a href="#__codelineno-45-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ggml_thread_cpumask_next</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">global_mask</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">local_mask</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">strict</span><span class="p">,</span><span class="w"> </span><span class="kt">int32_t</span><span class="o">*</span><span class="w"> </span><span class="n">iter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strict</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">local_mask</span><span class="p">,</span><span class="w"> </span><span class="n">global_mask</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_MAX_N_THREADS</span><span class="p">);</span>
<a id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-6" name="__codelineno-45-6"></a><span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">local_mask</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">GGML_MAX_N_THREADS</span><span class="p">);</span>
<a id="__codelineno-45-7" name="__codelineno-45-7"></a><span class="w">        </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">base_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">iter</span><span class="p">;</span>
<a id="__codelineno-45-8" name="__codelineno-45-8"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GGML_MAX_N_THREADS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-9" name="__codelineno-45-9"></a><span class="w">            </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-45-10" name="__codelineno-45-10"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">GGML_MAX_N_THREADS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-11" name="__codelineno-45-11"></a><span class="w">                </span><span class="c1">// Just a cheaper modulo</span>
<a id="__codelineno-45-12" name="__codelineno-45-12"></a><span class="w">                </span><span class="n">idx</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">GGML_MAX_N_THREADS</span><span class="p">;</span>
<a id="__codelineno-45-13" name="__codelineno-45-13"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-45-14" name="__codelineno-45-14"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">global_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-15" name="__codelineno-45-15"></a><span class="w">                </span><span class="n">local_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-45-16" name="__codelineno-45-16"></a><span class="w">                </span><span class="o">*</span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-45-17" name="__codelineno-45-17"></a><span class="w">                </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-45-18" name="__codelineno-45-18"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-45-19" name="__codelineno-45-19"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-45-20" name="__codelineno-45-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-45-21" name="__codelineno-45-21"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div>
<p>在该函数中通过strict参数控制线程的亲和性设置。</p>
<ul>
<li>
<p>如果strict为false，则将全局mask复制给线程的mask。在没有NUMA的架构中，这会导致所有线程都被允许在任何核心上运行。</p>
</li>
<li>
<p>如果strict为true，则通过循环遍历全局mask，找到第一个可用的CPU核心，并将其分配给线程。</p>
</li>
</ul>
<p>这种逻辑确保线程在可用的CPU核心之间均匀分布，从而减少竞争。</p>
<h4 id="计算图工作线程创建及调度">计算图工作线程创建及调度<a class="headerlink" href="#计算图工作线程创建及调度" title="Permanent link">¶</a></h4>
<p>上面的逻辑完成了线程池的创建、亲和性的设置，接下来就是创建具体的工作线程了，也就是线程跑起来要执行怎样的运算逻辑。</p>
<p>注意，这里创建工作线程是从thread 1开始的，因为thread 0的触发不在这里。
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1">1</a></span>
<span class="normal"><a href="#__codelineno-46-2">2</a></span>
<span class="normal"><a href="#__codelineno-46-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tpp</span><span class="o">-&gt;</span><span class="n">n_threads</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggml_thread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">workers</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">thrd</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">ggml_graph_compute_secondary_thread</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">workers</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
<a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div><p></p>
<p>接下来，请看ggml_graph_compute_secondary_thread函数。</p>
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-47-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-47-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-47-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-47-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-47-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-47-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-47-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-47-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-47-10">10</a></span>
<span class="normal"><a href="#__codelineno-47-11">11</a></span>
<span class="normal"><a href="#__codelineno-47-12">12</a></span>
<span class="normal"><a href="#__codelineno-47-13">13</a></span>
<span class="normal"><a href="#__codelineno-47-14">14</a></span>
<span class="normal"><a href="#__codelineno-47-15">15</a></span>
<span class="normal"><a href="#__codelineno-47-16">16</a></span>
<span class="normal"><a href="#__codelineno-47-17">17</a></span>
<span class="normal"><a href="#__codelineno-47-18">18</a></span>
<span class="normal"><a href="#__codelineno-47-19">19</a></span>
<span class="normal"><a href="#__codelineno-47-20">20</a></span>
<span class="normal"><a href="#__codelineno-47-21">21</a></span>
<span class="normal"><a href="#__codelineno-47-22">22</a></span>
<span class="normal"><a href="#__codelineno-47-23">23</a></span>
<span class="normal"><a href="#__codelineno-47-24">24</a></span>
<span class="normal"><a href="#__codelineno-47-25">25</a></span>
<span class="normal"><a href="#__codelineno-47-26">26</a></span>
<span class="normal"><a href="#__codelineno-47-27">27</a></span>
<span class="normal"><a href="#__codelineno-47-28">28</a></span>
<span class="normal"><a href="#__codelineno-47-29">29</a></span>
<span class="normal"><a href="#__codelineno-47-30">30</a></span>
<span class="normal"><a href="#__codelineno-47-31">31</a></span>
<span class="normal"><a href="#__codelineno-47-32">32</a></span>
<span class="normal"><a href="#__codelineno-47-33">33</a></span>
<span class="normal"><a href="#__codelineno-47-34">34</a></span>
<span class="normal"><a href="#__codelineno-47-35">35</a></span>
<span class="normal"><a href="#__codelineno-47-36">36</a></span>
<span class="normal"><a href="#__codelineno-47-37">37</a></span>
<span class="normal"><a href="#__codelineno-47-38">38</a></span>
<span class="normal"><a href="#__codelineno-47-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="k">static</span><span class="w"> </span><span class="n">thread_ret_t</span><span class="w"> </span><span class="nf">ggml_graph_compute_secondary_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_compute_state</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_compute_state</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_threadpool</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadpool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="o">-&gt;</span><span class="n">threadpool</span><span class="p">;</span>
<a id="__codelineno-47-4" name="__codelineno-47-4"></a>
<a id="__codelineno-47-5" name="__codelineno-47-5"></a><span class="w">    </span><span class="c1">// 设置线程优先级</span>
<a id="__codelineno-47-6" name="__codelineno-47-6"></a><span class="w">    </span><span class="n">ggml_thread_apply_priority</span><span class="p">(</span><span class="n">threadpool</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
<a id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ggml_thread_cpumask_is_valid</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cpumask</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-8" name="__codelineno-47-8"></a><span class="w">        </span><span class="c1">// 设置线程 affinity</span>
<a id="__codelineno-47-9" name="__codelineno-47-9"></a><span class="w">        </span><span class="n">ggml_thread_apply_affinity</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cpumask</span><span class="p">);</span>
<a id="__codelineno-47-10" name="__codelineno-47-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-47-11" name="__codelineno-47-11"></a>
<a id="__codelineno-47-12" name="__codelineno-47-12"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-13" name="__codelineno-47-13"></a><span class="w">        </span><span class="c1">// Check if we need to sleep</span>
<a id="__codelineno-47-14" name="__codelineno-47-14"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">threadpool</span><span class="o">-&gt;</span><span class="n">pause</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-15" name="__codelineno-47-15"></a><span class="w">            </span><span class="n">GGML_PRINT_DEBUG</span><span class="p">(</span><span class="s">"thread #%d inside pause loop</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ith</span><span class="p">);</span>
<a id="__codelineno-47-16" name="__codelineno-47-16"></a><span class="w">            </span><span class="n">ggml_mutex_lock_shared</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threadpool</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<a id="__codelineno-47-17" name="__codelineno-47-17"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadpool</span><span class="o">-&gt;</span><span class="n">pause</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-18" name="__codelineno-47-18"></a><span class="w">                </span><span class="n">ggml_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threadpool</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadpool</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<a id="__codelineno-47-19" name="__codelineno-47-19"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-47-20" name="__codelineno-47-20"></a><span class="w">            </span><span class="n">GGML_PRINT_DEBUG</span><span class="p">(</span><span class="s">"thread #%d resuming after wait</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ith</span><span class="p">);</span>
<a id="__codelineno-47-21" name="__codelineno-47-21"></a><span class="w">            </span><span class="n">ggml_mutex_unlock_shared</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threadpool</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<a id="__codelineno-47-22" name="__codelineno-47-22"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-47-23" name="__codelineno-47-23"></a>
<a id="__codelineno-47-24" name="__codelineno-47-24"></a><span class="w">        </span><span class="c1">// This needs to be checked for after the cond_wait</span>
<a id="__codelineno-47-25" name="__codelineno-47-25"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadpool</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-47-26" name="__codelineno-47-26"></a>
<a id="__codelineno-47-27" name="__codelineno-47-27"></a><span class="w">        </span><span class="c1">// Check if there is new work</span>
<a id="__codelineno-47-28" name="__codelineno-47-28"></a><span class="w">        </span><span class="c1">// The main thread is the only one that can dispatch new work</span>
<a id="__codelineno-47-29" name="__codelineno-47-29"></a>
<a id="__codelineno-47-30" name="__codelineno-47-30"></a><span class="w">        </span><span class="n">ggml_graph_compute_check_for_work</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<a id="__codelineno-47-31" name="__codelineno-47-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-32" name="__codelineno-47-32"></a><span class="w">            </span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-47-33" name="__codelineno-47-33"></a>
<a id="__codelineno-47-34" name="__codelineno-47-34"></a><span class="w">            </span><span class="n">ggml_graph_compute_thread</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<a id="__codelineno-47-35" name="__codelineno-47-35"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-47-36" name="__codelineno-47-36"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-47-37" name="__codelineno-47-37"></a>
<a id="__codelineno-47-38" name="__codelineno-47-38"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">thread_ret_t</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-47-39" name="__codelineno-47-39"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div>
可以看到工作线程不是上来就开始执行，而是通过threadpool-&gt;pause进行了暂停等待。<p></p>
<p>让我们回头看看主线程中的ggml_graph_compute逻辑，它首先创建线程池，也就是上面的部分。创建好从1开始的工作线程后，然后调用了ggml_graph_compute_kickoff，就是它把线程池的pause设置为false。</p>
<p>然后线程0在这个启动其它线程的线程开始执行ggml_graph_compute_thread计算任务。
</p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1">1</a></span>
<span class="normal"><a href="#__codelineno-48-2">2</a></span>
<span class="normal"><a href="#__codelineno-48-3">3</a></span>
<span class="normal"><a href="#__codelineno-48-4">4</a></span>
<span class="normal"><a href="#__codelineno-48-5">5</a></span>
<span class="normal"><a href="#__codelineno-48-6">6</a></span>
<span class="normal"><a href="#__codelineno-48-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="k">enum</span><span class="w"> </span><span class="nc">ggml_status</span><span class="w"> </span><span class="n">ggml_graph_compute</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_cgraph</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cgraph</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_cplan</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cplan</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="w">    </span><span class="c1">// Kick all threads to start the new graph</span>
<a id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="w">    </span><span class="n">ggml_graph_compute_kickoff</span><span class="p">(</span><span class="n">threadpool</span><span class="p">,</span><span class="w"> </span><span class="n">n_threads</span><span class="p">);</span>
<a id="__codelineno-48-4" name="__codelineno-48-4"></a>
<a id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="w">    </span><span class="c1">// This is a work thread too</span>
<a id="__codelineno-48-6" name="__codelineno-48-6"></a><span class="w">    </span><span class="n">ggml_graph_compute_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threadpool</span><span class="o">-&gt;</span><span class="n">workers</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div><p></p>
<h3 id="多线程如何执行矩阵乘张量计算">多线程如何执行矩阵乘张量计算<a class="headerlink" href="#多线程如何执行矩阵乘张量计算" title="Permanent link">¶</a></h3>
<p>GGML的所有线程每次只处理一个节点。让我们看看ggml_compute_forward，其中会根据节点的运算符类型选择实际的计算函数。这是通过一个庞大的switch-case语句块来处理的。</p>
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-49-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-49-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-49-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-49-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-49-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-49-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-49-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-49-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-49-10">10</a></span>
<span class="normal"><a href="#__codelineno-49-11">11</a></span>
<span class="normal"><a href="#__codelineno-49-12">12</a></span>
<span class="normal"><a href="#__codelineno-49-13">13</a></span>
<span class="normal"><a href="#__codelineno-49-14">14</a></span>
<span class="normal"><a href="#__codelineno-49-15">15</a></span>
<span class="normal"><a href="#__codelineno-49-16">16</a></span>
<span class="normal"><a href="#__codelineno-49-17">17</a></span>
<span class="normal"><a href="#__codelineno-49-18">18</a></span>
<span class="normal"><a href="#__codelineno-49-19">19</a></span>
<span class="normal"><a href="#__codelineno-49-20">20</a></span>
<span class="normal"><a href="#__codelineno-49-21">21</a></span>
<span class="normal"><a href="#__codelineno-49-22">22</a></span>
<span class="normal"><a href="#__codelineno-49-23">23</a></span>
<span class="normal"><a href="#__codelineno-49-24">24</a></span>
<span class="normal"><a href="#__codelineno-49-25">25</a></span>
<span class="normal"><a href="#__codelineno-49-26">26</a></span>
<span class="normal"><a href="#__codelineno-49-27">27</a></span>
<span class="normal"><a href="#__codelineno-49-28">28</a></span>
<span class="normal"><a href="#__codelineno-49-29">29</a></span>
<span class="normal"><a href="#__codelineno-49-30">30</a></span>
<span class="normal"><a href="#__codelineno-49-31">31</a></span>
<span class="normal"><a href="#__codelineno-49-32">32</a></span>
<span class="normal"><a href="#__codelineno-49-33">33</a></span>
<span class="normal"><a href="#__codelineno-49-34">34</a></span>
<span class="normal"><a href="#__codelineno-49-35">35</a></span>
<span class="normal"><a href="#__codelineno-49-36">36</a></span>
<span class="normal"><a href="#__codelineno-49-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="k">static</span><span class="w"> </span><span class="n">thread_ret_t</span><span class="w"> </span><span class="nf">ggml_graph_compute_thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_compute_state</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_compute_state</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<a id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_threadpool</span><span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">tp</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="o">-&gt;</span><span class="n">threadpool</span><span class="p">;</span>
<a id="__codelineno-49-4" name="__codelineno-49-4"></a>
<a id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_cgraph</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cgraph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cgraph</span><span class="p">;</span>
<a id="__codelineno-49-6" name="__codelineno-49-6"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_cplan</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">cplan</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cplan</span><span class="p">;</span>
<a id="__codelineno-49-7" name="__codelineno-49-7"></a>
<a id="__codelineno-49-8" name="__codelineno-49-8"></a><span class="w">    </span><span class="n">set_numa_thread_affinity</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ith</span><span class="p">);</span>
<a id="__codelineno-49-9" name="__codelineno-49-9"></a>
<a id="__codelineno-49-10" name="__codelineno-49-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_compute_params</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-11" name="__codelineno-49-11"></a><span class="w">        </span><span class="cm">/*.ith       =*/</span><span class="w"> </span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ith</span><span class="p">,</span>
<a id="__codelineno-49-12" name="__codelineno-49-12"></a><span class="w">        </span><span class="cm">/*.nth       =*/</span><span class="w"> </span><span class="n">atomic_load_explicit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">n_threads_cur</span><span class="p">,</span><span class="w"> </span><span class="n">memory_order_relaxed</span><span class="p">),</span>
<a id="__codelineno-49-13" name="__codelineno-49-13"></a><span class="w">        </span><span class="cm">/*.wsize     =*/</span><span class="w"> </span><span class="n">cplan</span><span class="o">-&gt;</span><span class="n">work_size</span><span class="p">,</span>
<a id="__codelineno-49-14" name="__codelineno-49-14"></a><span class="w">        </span><span class="cm">/*.wdata     =*/</span><span class="w"> </span><span class="n">cplan</span><span class="o">-&gt;</span><span class="n">work_data</span><span class="p">,</span>
<a id="__codelineno-49-15" name="__codelineno-49-15"></a><span class="w">        </span><span class="cm">/*.threadpool=*/</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span>
<a id="__codelineno-49-16" name="__codelineno-49-16"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-49-17" name="__codelineno-49-17"></a>
<a id="__codelineno-49-18" name="__codelineno-49-18"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">node_n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">node_n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cgraph</span><span class="o">-&gt;</span><span class="n">n_nodes</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">atomic_load_explicit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">abort</span><span class="p">,</span><span class="w"> </span><span class="n">memory_order_relaxed</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">node_n</span><span class="p">;</span><span class="w"> </span><span class="n">node_n</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-19" name="__codelineno-49-19"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cgraph</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_n</span><span class="p">];</span>
<a id="__codelineno-49-20" name="__codelineno-49-20"></a>
<a id="__codelineno-49-21" name="__codelineno-49-21"></a><span class="w">        </span><span class="n">ggml_compute_forward</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-49-22" name="__codelineno-49-22"></a>
<a id="__codelineno-49-23" name="__codelineno-49-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ith</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cplan</span><span class="o">-&gt;</span><span class="n">abort_callback</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="__codelineno-49-24" name="__codelineno-49-24"></a><span class="w">                </span><span class="n">cplan</span><span class="o">-&gt;</span><span class="n">abort_callback</span><span class="p">(</span><span class="n">cplan</span><span class="o">-&gt;</span><span class="n">abort_callback_data</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-25" name="__codelineno-49-25"></a><span class="w">            </span><span class="n">atomic_store_explicit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">abort</span><span class="p">,</span><span class="w"> </span><span class="n">node_n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">memory_order_relaxed</span><span class="p">);</span>
<a id="__codelineno-49-26" name="__codelineno-49-26"></a><span class="w">            </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">ec</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">GGML_STATUS_ABORTED</span><span class="p">;</span>
<a id="__codelineno-49-27" name="__codelineno-49-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-49-28" name="__codelineno-49-28"></a>
<a id="__codelineno-49-29" name="__codelineno-49-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node_n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cgraph</span><span class="o">-&gt;</span><span class="n">n_nodes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-30" name="__codelineno-49-30"></a><span class="w">            </span><span class="n">ggml_barrier</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">threadpool</span><span class="p">);</span>
<a id="__codelineno-49-31" name="__codelineno-49-31"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-49-32" name="__codelineno-49-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-49-33" name="__codelineno-49-33"></a>
<a id="__codelineno-49-34" name="__codelineno-49-34"></a><span class="w">    </span><span class="n">ggml_barrier</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">threadpool</span><span class="p">);</span>
<a id="__codelineno-49-35" name="__codelineno-49-35"></a>
<a id="__codelineno-49-36" name="__codelineno-49-36"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-49-37" name="__codelineno-49-37"></a><span class="p">}</span>
</code></pre></div></td></tr></tbody></table></div>
ggml_compute_forward调用的是ggml_compute_forward_mul_mat的实现，完成矩阵乘法。<p></p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1">1</a></span>
<span class="normal"><a href="#__codelineno-50-2">2</a></span>
<span class="normal"><a href="#__codelineno-50-3">3</a></span>
<span class="normal"><a href="#__codelineno-50-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="k">case</span><span class="w"> </span><span class="no">GGML_OP_MUL_MAT</span><span class="p">:</span>
<a id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-50-3" name="__codelineno-50-3"></a><span class="w">        </span><span class="n">ggml_compute_forward_mul_mat</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">tensor</span><span class="p">);</span>
<a id="__codelineno-50-4" name="__codelineno-50-4"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</code></pre></div></td></tr></tbody></table></div>
<p>查看ggml_compute_forward_mul_mat的实现可知，矩阵的计算不是一个线程完成整个矩阵的计算，而是传递了thread_id参数，根据thread_id来拆分矩阵块，分块计算。</p>
<p>这里也可以看到GGML的计算图执行调度和一般图计算的区别，一般场景的有向无环图，多个线程并行执行多个可以并行的node，这里GGML是一次只执行一个node，node中多个线程分块计算。然后进入下一个节点计算。</p>
<p>一旦一个节点node的计算完成，所有线程都会在屏障ggml_barrier处同步，确保它们在进入下一个节点之前完成当前节点的计算。这个过程会重复进行，直到图中的所有节点都被评估完毕。</p>
<p>上面更多的谈到的是不使用OpenMP，手动管理线程的凡是。如果启用OpenMP后，它会自动管理并行计算，无需手动创建和同步线程。我们无需自己处理线程池、条件变量和竞争条件，只需设置线程数量，让每个线程执行ggml_graph_compute_thread即可。</p>
<h3 id="获取计算结果">获取计算结果<a class="headerlink" href="#获取计算结果" title="Permanent link">¶</a></h3>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-51-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-51-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-51-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-51-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-51-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-51-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-51-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-51-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-51-10">10</a></span>
<span class="normal"><a href="#__codelineno-51-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="c1">// perform computation in cpu</span>
<a id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ggml_tensor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute</span><span class="p">(</span><span class="n">model</span><span class="p">);</span>
<a id="__codelineno-51-3" name="__codelineno-51-3"></a>
<a id="__codelineno-51-4" name="__codelineno-51-4"></a><span class="c1">// get the result data pointer as a float array to print</span>
<a id="__codelineno-51-5" name="__codelineno-51-5"></a><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">out_data</span><span class="p">(</span><span class="n">ggml_nelements</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
<a id="__codelineno-51-6" name="__codelineno-51-6"></a><span class="n">memcpy</span><span class="p">(</span><span class="n">out_data</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">ggml_nbytes</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
<a id="__codelineno-51-7" name="__codelineno-51-7"></a>
<a id="__codelineno-51-8" name="__codelineno-51-8"></a><span class="c1">// expected result:</span>
<a id="__codelineno-51-9" name="__codelineno-51-9"></a><span class="c1">// [ 60.00 55.00 50.00 110.00</span>
<a id="__codelineno-51-10" name="__codelineno-51-10"></a><span class="c1">//   90.00 54.00 54.00 126.00</span>
<a id="__codelineno-51-11" name="__codelineno-51-11"></a><span class="c1">//   42.00 29.00 28.00 64.00 ]</span>
</code></pre></div></td></tr></tbody></table></div>
<p>最后就是获取result node，然后将计算结果拷贝出来。到此，通过simple-ctx的例子，我们从源码理解了GGML如何实现在ggml_context中分配所有需要的内存，通过cpu backend的方式执行计算图。</p>
<style>
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme="slate"] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
</style>
<div class="related-posts">
<h3>📚 相关文章推荐</h3>
<ul>
<li><a href="https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/" target="_blank">300行实现一个BoundedSPSCQueue</a></li>
<li><a href="https://kenforever1.github.io/blog/c20如何实现一个基于属性测试的quickcheck-cpp库/" target="_blank">C++20如何实现一个基于属性测试的quickcheck-cpp库</a></li>
<li><a href="https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/" target="_blank">helix-gpt如何实现AI code以及如何调试?</a></li>
<li><a href="https://kenforever1.github.io/blog/c使用abseil-cpp遇到的小问题/" target="_blank">C++使用abseil-cpp遇到的小问题</a></li>
<li><a href="https://kenforever1.github.io/blog/mit-经典讲座how-to-speak---patrick-winston/" target="_blank">MIT 经典讲座：How to Speak - Patrick Winston</a></li>
</ul>
</div>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="2026年1月11日 21:45:14 CST">2026-01-11</span>
  </span>

    
    
    
    
  </aside>


  


  



  <link rel="stylesheet" type="text/css" href="../../stylesheets/auto-number-title.css">
  <h1 id="__comments">评论</h1>
  <!-- Insert generated snippet here -->
  <script src="https://giscus.app/client.js" data-repo="KenForever1/KenForever1.github.io" data-repo-id="R_kgDOGbt1Ww" data-category="Announcements" data-category-id="DIC_kwDOGbt1W84CahvG" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>
  </script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme) 
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="页脚">
        
          
          <a href="../bitnet%E4%B8%ADint2%E5%92%8Cint8%E7%9A%84%E4%BD%BF%E7%94%A8/" class="md-footer__link md-footer__link--prev" aria-label="上一页: bitnet中int2和int8的使用">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                bitnet中int2和int8的使用
              </div>
            </div>
          </a>
        
        
          
          <a href="../%E5%A1%94%E7%8F%80tutter%E8%87%AA%E6%8C%87%E5%85%AC%E5%BC%8F%E6%98%AF%E4%BB%80%E4%B9%88/" class="md-footer__link md-footer__link--next" aria-label="下一页: 塔珀（Tutter）自指公式是什么？">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                塔珀（Tutter）自指公式是什么？
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Copyright and theme information -->
<div class="md-copyright">
  
    <div class="md-copyright__highlight">
      版权所有 © 2025-2026
    </div>
  
  
    <script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/3JIbgFniDcGIaNP7/quote.js?theme=#FFFFFF,#808080,#808080,#B3B3B3,#FFFFFF,#1690FF,12&amp;f=12&amp;display=0,0,1,1,1,1,1,1"></script>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/KenForever1" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
    </a>
  
    
    
    
    
    <a href="https://www.zhihu.com/people/steveforever" target="_blank" rel="noopener" title="Mastodon" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M170.5 148.1v217.5h23.4l7.7 26.4 42-26.4h49.5V148.1H170.4zM268.3 342h-27.9l-27.9 17.5-5.1-17.5h-11.9V171.7h72.8zm-118.5-94.3H97.5c1.7-27.1 2.2-51.6 2.2-73.5h51.2s2-22.6-8.6-22.3H53.8c3.5-13.1 7.9-26.7 13.1-40.7 0 0-24.1 0-32.3 21.6-3.4 8.9-13.2 43.1-30.7 78.1 5.9-.6 25.4-1.2 36.8-22.2 2.1-5.9 2.5-6.7 5.1-14.5h28.9c0 10.5-1.2 66.9-1.7 73.4H20.7c-11.7 0-15.6 23.6-15.6 23.6h65.6c-4.4 49.9-28 91.9-70.8 125.1 20.5 5.9 40.9-.9 51-9.9 0 0 23-20.9 35.6-69.3l54 64.9s7.9-26.9-1.2-40c-7.6-8.9-28.1-33.1-36.8-41.8L87.9 312c4.4-14 7-27.6 7.9-40.7h61.6s-.1-23.6-7.6-23.6m412-1.6c20.8-25.6 45-58.6 45-58.6s-18.6-14.8-27.4-4.1c-6 8.2-36.8 48.2-36.8 48.2l19.2 14.4zm-150-59.1c-9-8.2-25.9 2.1-25.9 2.1s39.5 55 41.1 57.4l19.5-13.7s-25.7-37.6-34.7-45.9zM640 258.4c-19.8 0-130.9.9-131.1.9v-101q7.2 0 22.8-1.2c40.9-2.4 70.1-4 87.8-4.8 0 0 12.2-27.2-.6-33.4-3.1-1.2-23.2 4.6-23.2 4.6s-165.2 16.5-232.4 18c1.6 8.8 7.6 17.1 15.8 19.6 13.3 3.5 22.7 1.7 49.2.9 24.8-1.6 43.7-2.4 56.5-2.4v99.8H351.3s2.8 22.3 25.5 22.9h107.9v70.9c0 14-11.2 22-24.5 21.1-14.1.1-26.1-1.1-41.7-1.8 2 4 6.3 14.4 19.3 21.8 9.9 4.8 16.2 6.6 26 6.6 29.6 0 45.7-17.3 44.9-45.3v-73.3h122.4c9.7 0 8.7-23.8 8.7-23.8z"></path></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.indexes", "navigation.top", "navigation.sections", "navigation.path", "content.action.edit", "content.action.view", "content.code.copy", "navigation.footer"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../js/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.bootcss.com/mathjax/3.0.5/es5/tex-mml-chtml.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>