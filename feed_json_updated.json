{
    "version": "https://jsonfeed.org/version/1",
    "title": "KenForever1",
    "home_page_url": "https://github.com/KenForever1/",
    "feed_url": "https://github.com/KenForever1/feed_json_updated.json",
    "description": "\u70ed\u7231\u7f16\u7a0b\u548c\u9605\u8bfb\uff0c\u5b66\u65e0\u6b62\u5883",
    "icon": "https://upload.wikimedia.org/wikipedia/commons/thumb/4/43/Feed-icon.svg/128px-Feed-icon.svg.png",
    "authors": [
        {
            "name": "SteveForever"
        }
    ],
    "language": "zh",
    "items": [
        {
            "id": "https://github.com/KenForever1/blog/pyo3%E5%AE%9E%E7%8E%B0python%E5%92%8Crust%E8%B7%A8%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8/",
            "url": "https://github.com/KenForever1/blog/pyo3%E5%AE%9E%E7%8E%B0python%E5%92%8Crust%E8%B7%A8%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8/",
            "title": "pyo3\u5b9e\u73b0python\u548crust\u8de8\u8bed\u8a00\u8c03\u7528",
            "content_html": "<!-- more -->\n\n<h2 id=\"pyo3\u662f\u4ec0\u4e48\">pyo3\u662f\u4ec0\u4e48\uff1f<a class=\"headerlink\" href=\"#pyo3\u662f\u4ec0\u4e48\" title=\"Permanent link\">&para;</a></h2>\n<p>pyo3\u662f\u4e00\u4e2aRust\u5e93\uff0c\u53ef\u4ee5\u5b9e\u73b0python\u548crust\u4e4b\u95f4\u7684\u76f8\u4e92\u8c03\u7528\u3002\u53ef\u4ee5\u4f7f\u7528Rust\u4e3aPython\u7f16\u5199\u6269\u5c55\u3002\n\u6559\u7a0b\u53ef\u4ee5\u53c2\u8003<a href=\"https://pyo3.rs/main/getting-started.html\">pyo3 getting-started</a>\u3002</p>\n<p>\u5c31\u884c\uff0cpybind11\u4e00\u6837\uff0cpybind11\u662f\u4e00\u4e2ac++\u5e93\uff0c\u63d0\u4f9b\u4e86c++\u548cpython\u4e4b\u95f4\u7684\u76f8\u4e92\u8c03\u7528\u3002</p>\n<h2 id=\"ffi\u9700\u8981\u8003\u8651\u4ec0\u4e48\u95ee\u9898\">FFI\u9700\u8981\u8003\u8651\u4ec0\u4e48\u95ee\u9898\uff1f<a class=\"headerlink\" href=\"#ffi\u9700\u8981\u8003\u8651\u4ec0\u4e48\u95ee\u9898\" title=\"Permanent link\">&para;</a></h2>\n<p>python\u548crust\u4e4b\u95f4\u7684\u76f8\u4e92\u8c03\u7528\uff0c\u9700\u8981\u8003\u8651\u7684\u95ee\u9898\u6709\uff1a\n\u7ebf\u7a0b\u5b89\u5168\uff0c\u7ebf\u7a0b\u95f4\u7ade\u4e89\u3002pyo3\u9488\u5bf9\u4e0d\u540c\u7684python\u7248\u672c\u5b9e\u73b0\uff0c\u5b9e\u73b0\u4e86GIL\u548cno GIL\u3002\n\u6570\u636e\u7ed3\u6784\u7684\u751f\u547d\u5468\u671f\uff0cpyo3\u5c01\u88c5\u4e86\u667a\u80fd\u6307\u9488\uff0c\u901a\u8fc7\u8fc7\u7a0b\u5b8f\u751f\u6210\u51fd\u6570</p>\n<h2 id=\"python\u7684no-gil\">python\u7684no GIL<a class=\"headerlink\" href=\"#python\u7684no-gil\" title=\"Permanent link\">&para;</a></h2>\n<p>GIL\u5c31\u662fPython\u7684\u5168\u5c40\u89e3\u91ca\u5668\u9501\uff0c\u56e0\u6b64python\u7684\u591a\u7ebf\u7a0b\u5b9e\u9645\u662f\u4f2a\u591a\u7ebf\u7a0b\uff0c\u4e0d\u80fd\u50cfc++\u7b49\u5176\u5b83\u8bed\u8a00\u7684\u591a\u7ebf\u7a0b\u4e00\u6837\u771f\u6b63\u7684\u5b9e\u73b0\u5e76\u53d1\u3002</p>\n<p>python\u7684no GIL\u662fCPython 3.14\u63d0\u51fa\u7684\u4e0d\u518d\u4f9d\u8d56\u5168\u5c40\u89e3\u91ca\u5668\u9501\u7684\u591a\u7ebf\u7a0b\u5b9e\u73b0\uff0c\u63d0\u5347\u5e76\u53d1\u3002</p>\n<blockquote>\n<p>CPython 3.14 declared support for the &ldquo;free-threaded&rdquo; build of CPython that does not rely on the global interpreter lock (often referred to as the GIL) for thread safety. </p>\n</blockquote>\n<h2 id=\"\u5982\u4f55\u7f16\u8bd1\u4e00\u4e2a\u591a\u4e2a\u7248\u672c\u90fd\u53ef\u4ee5\u4f7f\u7528\u7684wheel\u5305\u4e0e\u4ec0\u4e48\u7279\u6027\u6709\u5173\">\u5982\u4f55\u7f16\u8bd1\u4e00\u4e2a\u591a\u4e2a\u7248\u672c\u90fd\u53ef\u4ee5\u4f7f\u7528\u7684wheel\u5305\uff1f\u4e0e\u4ec0\u4e48\u7279\u6027\u6709\u5173\uff1f<a class=\"headerlink\" href=\"#\u5982\u4f55\u7f16\u8bd1\u4e00\u4e2a\u591a\u4e2a\u7248\u672c\u90fd\u53ef\u4ee5\u4f7f\u7528\u7684wheel\u5305\u4e0e\u4ec0\u4e48\u7279\u6027\u6709\u5173\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6211\u4eec\u5e73\u65f6\u4f7f\u7528python\u4f9d\u8d56\u5b89\u88c5\u5305\u65f6\u53ef\u80fd\u4f1a\u6ce8\u610f\u5230\uff0c\u6709\u4e9bwheel\u6587\u4ef6\u547d\u540d\u4e0a\u662f\u6307\u660e\u4e86python\u7248\u672c\u8981\u6c42\u7684\uff0c\u6bd4\u5982python3.8\u7684wheel\u5305\u548cpython3.10\u7b49\u662f\u4e0d\u540c\u7684\u6587\u4ef6\u3002</p>\n<p>\u6807\u51c6Python ABI\u901a\u5e38\u8981\u6c42\u6a21\u5757\u9488\u5bf9\u7279\u5b9aPython\u7248\u672c\u7f16\u8bd1\uff0c\u800cABI3\u901a\u8fc7\u51bb\u7ed3\u5173\u952e\u4e8c\u8fdb\u5236\u63a5\u53e3\u5b9e\u73b0\u8de8\u7248\u672c\u517c\u5bb9\uff0c\u964d\u4f4e\u4e86\u7ef4\u62a4\u6210\u672c\u3002</p>\n<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cPython\u6269\u5c55\u6a21\u5757\u53ea\u80fd\u4e0e\u7f16\u8bd1\u5b83\u4eec\u65f6\u6240\u9488\u5bf9\u7684Python\u7248\u672c\u4e00\u8d77\u4f7f\u7528\u3002\u4f8b\u5982\uff0c\u4e3aPython 3.5\u6784\u5efa\u7684\u6269\u5c55\u6a21\u5757\u65e0\u6cd5\u5728Python 3.8\u4e2d\u5bfc\u5165\u3002<a href=\"https://www.python.org/dev/peps/pep-0384/\">PEP 384</a>\u5f15\u5165\u4e86\u6709\u9650Python API\u7684\u6982\u5ff5\uff0c\u8be5API\u5c06\u5177\u6709\u7a33\u5b9a\u7684ABI\uff0c\u4f7f\u4f7f\u7528\u5b83\u6784\u5efa\u7684\u6269\u5c55\u6a21\u5757\u80fd\u591f\u5728\u591a\u4e2aPython\u7248\u672c\u4e2d\u4f7f\u7528\u3002\u8fd9\u4e5f\u88ab\u79f0\u4e3aabi3\u3002</p>\n<p>\u5176\u7f3a\u70b9\u662f\uff0cPyO3\u65e0\u6cd5\u4f7f\u7528\u90a3\u4e9b\u4f9d\u8d56\u4e8e\u9488\u5bf9\u5df2\u77e5\u786e\u5207Python\u7248\u672c\u8fdb\u884c\u7f16\u8bd1\u7684\u4f18\u5316\u3002pyo3\u4ec5\u8c03\u7528\u5c5e\u4e8e\u7a33\u5b9aAPI\u7684Python C-API\u51fd\u6570\u3002</p>\n<p>\u7531\u4e8e\u5355\u4e2aabi3\u8f6e\u5305\u53ef\u7528\u4e8e\u591a\u4e2a\u4e0d\u540c\u7684Python\u7248\u672c\uff0cPyO3\u63d0\u4f9b\u4e86abi3-py37\u3001abi3-py38\u3001abi3-py39\u7b49\u529f\u80fd\u6807\u5fd7\uff0c\u7528\u4e8e\u4e3a\u60a8\u7684abi3\u8f6e\u5305\u8bbe\u7f6e\u6700\u4f4e\u6240\u9700\u7684Python\u7248\u672c\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u8bbe\u7f6e\u4e86abi3-py37\u529f\u80fd\uff0c\u60a8\u7684\u6269\u5c55\u8f6e\u5305\u53ef\u7528\u4e8e\u4ecePython 3.7\u53ca\u66f4\u9ad8\u7248\u672c\u7684\u6240\u6709Python 3\u7248\u672c\u3002maturin\u548csetuptools-rust\u4f1a\u7ed9\u8f6e\u5305\u547d\u540d\u4e3a\u7c7b\u4f3cmy-extension-1.0-cp37-abi3-manylinux2020_x86_64.whl\u7684\u540d\u79f0\u3002</p>\n<h2 id=\"\u4e00\u4e2apython\u5305\u5982\u4f55\u6d4b\u8bd5\u591a\u4e2a\u7248\u672c\">\u4e00\u4e2apython\u5305\uff0c\u5982\u4f55\u6d4b\u8bd5\u591a\u4e2a\u7248\u672c\uff1f<a class=\"headerlink\" href=\"#\u4e00\u4e2apython\u5305\u5982\u4f55\u6d4b\u8bd5\u591a\u4e2a\u7248\u672c\" title=\"Permanent link\">&para;</a></h2>\n<p><a href=\"https://nox.thea.codes/en/stable/index.html\">nox</a>\uff0c\u53ef\u4ee5\u81ea\u52a8\u5316\u7684\u5728\u591a\u4e2apython\u7248\u672c\u4e0b\u8fd0\u884c\u6d4b\u8bd5\u3002\u901a\u8fc7py\u811a\u672c\u914d\u7f6e\u3002</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/rust-facet\u5e93\u5982\u4f55\u5b9e\u73b0\u8fd0\u884c\u65f6\u53cd\u5c04/\" target=\"_blank\">rust-facet\u5e93\u5982\u4f55\u5b9e\u73b0\u8fd0\u884c\u65f6\u53cd\u5c04</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/\u4f7f\u7528aya\u548cc\u6df7\u5408\u7f16\u5199uprobe\u7a0b\u5e8f/\" target=\"_blank\">\u4f7f\u7528aya\u548cc\u6df7\u5408\u7f16\u5199uprobe\u7a0b\u5e8f</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u5f00\u53d1\u5e38\u89c1\u95ee\u9898\u4e4babi\u517c\u5bb9\u6027\u95ee\u9898/\" target=\"_blank\">C++\u5f00\u53d1\u5e38\u89c1\u95ee\u9898\u4e4bABI\u517c\u5bb9\u6027\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-09-20T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/%E6%8E%A2%E7%B4%A2ggml%E7%9A%84%E5%AE%9E%E7%8E%B0/",
            "url": "https://github.com/KenForever1/blog/%E6%8E%A2%E7%B4%A2ggml%E7%9A%84%E5%AE%9E%E7%8E%B0/",
            "title": "\u63a2\u7d22ggml\u7684\u5b9e\u73b0",
            "content_html": "<!-- more -->\n\n<p>\u672c\u6587\u4e3b\u8981\u4ecb\u7ecdggml\u7684\u8c03\u8bd5\u5165\u95e8\u73af\u5883\u642d\u5efa\u3001ggml\u7684\u6838\u5fc3\u6570\u636e\u7ed3\u6784\u3001\u5185\u5b58\u7ba1\u7406\u4e0e\u5e03\u5c40\u3001\u8ba1\u7b97\u56fe\u6784\u5efa\u4e0e\u6267\u884c\u3001\u4ee5\u53cagguf\u6587\u4ef6\u683c\u5f0f\u6784\u6210\uff0c\u4f1a\u5206\u6210\u591a\u4e2a\u5c0f\u8282\u4ecb\u7ecd\u3002</p>\n<p>\u672c\u6587\u8d77\u6e90\u4e8e\u4f5c\u8005ggml\u5b66\u4e60\u8fc7\u7a0b\u4e2d\u4e86\u89e3\u7684\u8d44\u6599\uff0c\u5305\u62ec<a href=\"https://xsxszab.github.io/posts/ggml-deep-dive-i/\">xsxszab\u7684ggml-deep-dive\u7cfb\u5217\u6587\u7ae0</a>\u3001\u4ee5\u53ca\u9605\u8bfb\u6e90\u7801\uff0c\u8bb0\u5f55\u548c\u5206\u4eab\u81ea\u5df1\u7684\u7406\u89e3\u8fc7\u7a0b\u3002\uff08\u611f\u8c22xsxszab\u7ed8\u5236\u7684\u5173\u4e8e\u5185\u5b58\u5e03\u5c40\u7684\u56fe\u4f8b\uff0c\u4e3aggml\u7684\u7406\u89e3\u66f4\u52a0\u6d45\u663e\u6613\u61c2\u3002\uff09</p>\n<p>ggml\u662f\u91c7\u7528c/c++\u7f16\u5199\u9ad8\u5ea6\u4f18\u5316\u7684tensor\u5f20\u91cf\u8ba1\u7b97\u5e93\uff0c\u6ca1\u6709\u5916\u90e8\u4f9d\u8d56\u3002\u5b58\u5728\u4e0d\u540c\u7684backend\u5b9e\u73b0\uff0c\u4ecemac\u7684metal\u3001x86\u7684avx\u5b9e\u73b0\u4ee5\u53caarm\u7684neon\u6307\u4ee4\u5b9e\u73b0\u3001gpu\u7684cuda\u3001hip\u3001opencl\u7b49\u5b9e\u73b0\u3002llama.cpp\u9879\u76ee\u5c31\u662f\u4f7f\u7528ggml\u8fdb\u884c\u6a21\u578b\u52a0\u8f7d\u3001\u63a8\u7406\u7684\u3002</p>\n<h2 id=\"\u63a2\u7d22ggml\u7684\u5b9e\u73b0vscode\u8c03\u8bd5\u73af\u5883\u7684\u642d\u5efa\">\u63a2\u7d22ggml\u7684\u5b9e\u73b0&ndash;vscode\u8c03\u8bd5\u73af\u5883\u7684\u642d\u5efa<a class=\"headerlink\" href=\"#\u63a2\u7d22ggml\u7684\u5b9e\u73b0vscode\u8c03\u8bd5\u73af\u5883\u7684\u642d\u5efa\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u9605\u8bfb\u6e90\u7801\u7684\u65f6\u5019\uff0c\u627e\u4e00\u4e2a\u6700\u7b80\u5355\u7684example\u4f8b\u5b50\u8dd1\u901a\uff0c\u7136\u540e\u8ddf\u7740\u6e90\u7801\u8fdb\u884c\u8c03\u8bd5\uff0c\u662f\u5f88\u5feb\u7406\u89e3\u539f\u7406\u7684\u4e00\u79cd\u65b9\u6cd5\u3002 </p>\n<p>\u5728linux\u3001\u6216\u8005mac\u4e0b\u90fd\u65b9\u4fbf\u7f16\u8bd1\u3002</p>\n<p>\u7f16\u8bd1\u4f9d\u8d56\uff1a</p>\n<ul>\n<li>gcc/g++\u6216\u8005 clang\u7f16\u8bd1</li>\n<li>cmake\uff1a \u7528\u4e8e\u7ba1\u7406\u6784\u5efa\u9879\u76ee</li>\n<li>ccache\uff1a\u53ef\u9009\u9879\uff0c\u52a0\u5feb\u7f16\u8bd1\u901f\u5ea6\u7528</li>\n</ul>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a>git<span class=\"w\"> </span>clone<span class=\"w\"> </span>https://github.com/ggml-org/ggml.git\n</code></pre></div></td></tr></table></div>\n<p>\u4e0a\u9762\u7684\u4f9d\u8d56\u5b89\u88c5\u5f88\u7b80\u5355\uff0c\u4ee5ubuntu\u4e3a\u4f8b\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a>apt<span class=\"w\"> </span>update\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a>apt<span class=\"w\"> </span>install<span class=\"w\"> </span>-y<span class=\"w\"> </span>gcc<span class=\"w\"> </span>g++<span class=\"w\"> </span>cmake<span class=\"w\"> </span>ccache\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"\u914d\u7f6e\u8c03\u8bd5\u76ee\u6807\">\u914d\u7f6e\u8c03\u8bd5\u76ee\u6807<a class=\"headerlink\" href=\"#\u914d\u7f6e\u8c03\u8bd5\u76ee\u6807\" title=\"Permanent link\">&para;</a></h3>\n<p>ggml\u7684example\u4e2d\u5305\u62ec\u4e86\u5f88\u591a\u4f8b\u5b50\uff0c\u5148\u4ece\u7b80\u5355\u7684\u4f8b\u5b50\u770b\u8d77\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a>examples/simple/simple-ctx.cpp\n</code></pre></div></td></tr></table></div>\n<p>\u4fee\u6539\u9879\u76ee\u7684cmake\u914d\u7f6e\uff0c\u5373\u6dfb\u52a0-g\u65b9\u4fbfdebug\u8c03\u8bd5\u3002\u627e\u5230examples/simple/CMakeLists.txt\u914d\u7f6e\u6587\u4ef6\uff0c\u4e3asimple-ctx\u8fd9\u4e2a\u53ef\u6267\u884c\u6587\u4ef6\u6dfb\u52a0-g\u53c2\u6570\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\">4</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a>set<span class=\"o\">(</span>TEST_TARGET<span class=\"w\"> </span>simple-ctx<span class=\"o\">)</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a>add_executable<span class=\"o\">(</span><span class=\"si\">${</span><span class=\"nv\">TEST_TARGET</span><span class=\"si\">}</span><span class=\"w\"> </span>simple-ctx.cpp<span class=\"o\">)</span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a>target_compile_options<span class=\"o\">(</span><span class=\"si\">${</span><span class=\"nv\">TEST_TARGET</span><span class=\"si\">}</span><span class=\"w\"> </span>PRIVATE<span class=\"w\"> </span>-g<span class=\"o\">)</span>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a>target_link_libraries<span class=\"o\">(</span><span class=\"si\">${</span><span class=\"nv\">TEST_TARGET</span><span class=\"si\">}</span><span class=\"w\"> </span>PRIVATE<span class=\"w\"> </span>ggml<span class=\"o\">)</span>\n</code></pre></div></td></tr></table></div>\n\u4e0a\u9762\u53ea\u662f\u4e3a\u53ef\u6267\u884c\u6587\u4ef6\u6dfb\u52a0\u4e86-g\u8c03\u8bd5\u4fe1\u606f\uff0c\u5982\u679c\u8981\u8c03\u8bd5ggml.so\u8fd9\u4e2a\u5e93\uff0c\u5219\u9700\u8981\u7f16\u8bd1ggml.so\u5e93\u65f6\u6307\u5b9aDebug\u7c7b\u578b\u3002</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a>cmake<span class=\"w\"> </span>-B<span class=\"w\"> </span>build<span class=\"w\"> </span>-S<span class=\"w\"> </span>.<span class=\"w\"> </span>-DCMAKE_BUILD_TYPE<span class=\"o\">=</span>DEBUG\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a>cmake<span class=\"w\"> </span>--build<span class=\"w\"> </span>build\n</code></pre></div></td></tr></table></div>\n\u67e5\u770b\u7f16\u8bd1\u8f93\u51fa\uff0c\u53ef\u4ee5\u770b\u5230ggml.so\u5e93\u88ab\u7f16\u8bd1\u6210with debug_info\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a>file<span class=\"w\"> </span>build/src/libggml.so<span class=\"w\"> </span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a>build/src/libggml.so:<span class=\"w\"> </span>ELF<span class=\"w\"> </span><span class=\"m\">64</span>-bit<span class=\"w\"> </span>LSB<span class=\"w\"> </span>shared<span class=\"w\"> </span>object,<span class=\"w\"> </span>x86-64,<span class=\"w\"> </span>version<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">(</span>SYSV<span class=\"o\">)</span>,<span class=\"w\"> </span>dynamically<span class=\"w\"> </span>linked,<span class=\"w\"> </span>BuildID<span class=\"o\">[</span>sha1<span class=\"o\">]=</span>db376e303daeef672c8002ed6cebed1da303a706,<span class=\"w\"> </span>with<span class=\"w\"> </span>debug_info,<span class=\"w\"> </span>not<span class=\"w\"> </span>stripped\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"vscode\u914d\u7f6edebug\">vscode\u914d\u7f6edebug<a class=\"headerlink\" href=\"#vscode\u914d\u7f6edebug\" title=\"Permanent link\">&para;</a></h3>\n<p>\u70b9\u51fb\u53f3\u8fb9\u7684Run and Debug\u6309\u94ae\uff0ccreate a launch.json file\uff0c\u521b\u5efa\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u628a\u4e0b\u9762\u7684\u5185\u5bb9\u7c98\u8d34\u8fdb\u53bb\u3002</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">JSON</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-12\">12</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a><span class=\"p\">{</span>\n<a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\"></a><span class=\"w\">    </span><span class=\"nt\">&quot;version&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;0.2.0&quot;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\"></a><span class=\"w\">    </span><span class=\"nt\">&quot;configurations&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span>\n<a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\"></a><span class=\"w\">        </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\"></a><span class=\"w\">            </span><span class=\"nt\">&quot;name&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;debug simple-ctx&quot;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\"></a><span class=\"w\">            </span><span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;lldb&quot;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\"></a><span class=\"w\">            </span><span class=\"nt\">&quot;request&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;launch&quot;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\"></a><span class=\"w\">            </span><span class=\"nt\">&quot;program&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;${workspaceFolder}/build/bin/simple-ctx&quot;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\"></a><span class=\"w\">            </span><span class=\"nt\">&quot;cwd&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;${workspaceFolder}&quot;</span>\n<a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-11\" name=\"__codelineno-6-11\"></a><span class=\"w\">    </span><span class=\"p\">]</span>\n<a id=\"__codelineno-6-12\" name=\"__codelineno-6-12\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u6309\u7167vscode\u7684\u754c\u9762button\u8c03\u8bd5\u4e86\uff0c\u5982\u679c\u8981\u8c03\u8bd5\u5176\u5b83\u53ef\u6267\u884c\u7a0b\u5e8f\uff0c\u4fee\u6539launch.json\u7684program\u5b57\u6bb5\u5373\u53ef\u3002</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u901a\u8fc7\u4e0a\u9762\u7684\u7f16\u8bd1debug\u6a21\u5f0f\u548c\u6dfb\u52a0-g\u53c2\u6570\uff0c\u53ef\u4ee5\u8fdb\u5165\u53ef\u6267\u884c\u7a0b\u5e8f\u548cggml.so\u5e93\u7684\u6e90\u7801\u8fdb\u884c\u8c03\u8bd5\u4e86\u4e86\u3002</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-debug.png\" /></p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-debug1.png\" /></p>\n<h2 id=\"\u63a2\u7d22ggml\u7684\u5b9e\u73b0\u5f20\u91cf\u8868\u793a\">\u63a2\u7d22ggml\u7684\u5b9e\u73b0&ndash;\u5f20\u91cf\u8868\u793a<a class=\"headerlink\" href=\"#\u63a2\u7d22ggml\u7684\u5b9e\u73b0\u5f20\u91cf\u8868\u793a\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"ggml_tensor-\u6570\u636e\u7ed3\u6784\">ggml_tensor \u6570\u636e\u7ed3\u6784<a class=\"headerlink\" href=\"#ggml_tensor-\u6570\u636e\u7ed3\u6784\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728GGML\u4e2d\u901a\u8fc7ggml_tensor\u7ed3\u6784\u4f53\u8868\u793a\u5f20\u91cf\uff0c\u7ed3\u6784\u4f53\u5b9a\u4e49\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-7-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-39\">39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-40\">40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-41\">41</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-42\">42</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-43\">43</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-44\">44</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-45\">45</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-46\">46</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\"></a><span class=\"c1\">// n-dimensional tensor</span>\n<a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\"></a><span class=\"w\">    </span><span class=\"c1\">// \u5f20\u91cf\u7684\u6570\u636e\u7c7b\u578b\uff1a\u4f8b\u5982GGML_TYPE_F32,GGML_TYPE_F16\uff0cGGML_TYPE_Q4_0</span>\n<a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\"></a><span class=\"w\">    </span><span class=\"k\">enum</span><span class=\"w\"> </span><span class=\"nc\">ggml_type</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\"></a>\n<a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_backend_buffer</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\"></a>\n<a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\"></a><span class=\"w\">    </span><span class=\"c1\">// \u6700\u5927\u7ef4\u5ea6\u4e3a4\uff0cGGML_MAX_DIMS\u4e3a4</span>\n<a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\"></a><span class=\"w\">    </span><span class=\"c1\">// ne\u5b58\u50a8\u5f20\u91cf\u6bcf\u4e2a\u7ef4\u5ea6\u7684\u5143\u7d20\u4e2a\u6570</span>\n<a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\"></a><span class=\"w\">    </span><span class=\"c1\">// nb\u5b58\u50a8\u5f20\u91cf\u6bcf\u4e2a\u7ef4\u7684\u5143\u7d20\u5927\u5c0f</span>\n<a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\"></a><span class=\"w\">    </span><span class=\"kt\">int64_t</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"p\">[</span><span class=\"n\">GGML_MAX_DIMS</span><span class=\"p\">];</span><span class=\"w\"> </span><span class=\"c1\">// number of elements</span>\n<a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\"></a><span class=\"w\">    </span><span class=\"kt\">size_t</span><span class=\"w\">  </span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"n\">GGML_MAX_DIMS</span><span class=\"p\">];</span><span class=\"w\"> </span><span class=\"c1\">// stride in bytes:</span>\n<a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\"></a><span class=\"w\">                                </span><span class=\"c1\">// nb[0] = ggml_type_size(type)</span>\n<a id=\"__codelineno-7-14\" name=\"__codelineno-7-14\"></a><span class=\"w\">                                </span><span class=\"c1\">// nb[1] = nb[0]   * (ne[0] / ggml_blck_size(type)) + padding</span>\n<a id=\"__codelineno-7-15\" name=\"__codelineno-7-15\"></a><span class=\"w\">                                </span><span class=\"c1\">// nb[i] = nb[i-1] * ne[i-1]</span>\n<a id=\"__codelineno-7-16\" name=\"__codelineno-7-16\"></a>\n<a id=\"__codelineno-7-17\" name=\"__codelineno-7-17\"></a><span class=\"w\">    </span><span class=\"c1\">// \u5f20\u91cfop\u7c7b\u578b\uff0c\u5728\u8ba1\u7b97\u56fe\u4e2d\u4f5c\u4e3aop node\uff0c\u540e\u9762\u4f1a\u63d0\u5230</span>\n<a id=\"__codelineno-7-18\" name=\"__codelineno-7-18\"></a><span class=\"w\">    </span><span class=\"c1\">// \u4f8b\u5982\u77e9\u9635\u4e58\u7c7b\u578b\uff0cGGML_OP_MUL_MAT</span>\n<a id=\"__codelineno-7-19\" name=\"__codelineno-7-19\"></a><span class=\"w\">    </span><span class=\"c1\">// compute data</span>\n<a id=\"__codelineno-7-20\" name=\"__codelineno-7-20\"></a><span class=\"w\">    </span><span class=\"k\">enum</span><span class=\"w\"> </span><span class=\"nc\">ggml_op</span><span class=\"w\"> </span><span class=\"n\">op</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-21\" name=\"__codelineno-7-21\"></a>\n<a id=\"__codelineno-7-22\" name=\"__codelineno-7-22\"></a><span class=\"w\">    </span><span class=\"c1\">// op params - allocated as int32_t for alignment</span>\n<a id=\"__codelineno-7-23\" name=\"__codelineno-7-23\"></a><span class=\"w\">    </span><span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">op_params</span><span class=\"p\">[</span><span class=\"n\">GGML_MAX_OP_PARAMS</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">int32_t</span><span class=\"p\">)];</span>\n<a id=\"__codelineno-7-24\" name=\"__codelineno-7-24\"></a>\n<a id=\"__codelineno-7-25\" name=\"__codelineno-7-25\"></a><span class=\"w\">    </span><span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-26\" name=\"__codelineno-7-26\"></a>\n<a id=\"__codelineno-7-27\" name=\"__codelineno-7-27\"></a><span class=\"w\">    </span><span class=\"c1\">// \u6307\u9488\u6307\u5411\u6b64\u5f20\u91cf\u7684src\u5f20\u91cf</span>\n<a id=\"__codelineno-7-28\" name=\"__codelineno-7-28\"></a><span class=\"w\">    </span><span class=\"c1\">// \u4f8b\u5982\u77e9\u9635\u4e58op tensor\u7684src\u5f20\u91cf\u662f\u77e9\u9635A tensor\u548c\u77e9\u9635B tensor</span>\n<a id=\"__codelineno-7-29\" name=\"__codelineno-7-29\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"p\">[</span><span class=\"n\">GGML_MAX_SRC</span><span class=\"p\">];</span>\n<a id=\"__codelineno-7-30\" name=\"__codelineno-7-30\"></a>\n<a id=\"__codelineno-7-31\" name=\"__codelineno-7-31\"></a><span class=\"w\">    </span><span class=\"c1\">// \u63cf\u8ff0\u5f20\u91cf\u89c6\u56fe\uff0c\u5982\u679c\u6b64\u5f20\u91cf\u662f\u53e6\u4e00\u4e2a\u5f20\u91cf\uff08base\u5f20\u91cf\uff09\u7684\u89c6\u56fe\uff0c\u5219\u6307\u5411base\u5f20\u91cf</span>\n<a id=\"__codelineno-7-32\" name=\"__codelineno-7-32\"></a><span class=\"w\">    </span><span class=\"c1\">// source tensor and offset for views</span>\n<a id=\"__codelineno-7-33\" name=\"__codelineno-7-33\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">view_src</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-34\" name=\"__codelineno-7-34\"></a><span class=\"w\">    </span><span class=\"c1\">// \u89c6\u56fe\u5f20\u91cf\u7684\u504f\u79fb\u91cf</span>\n<a id=\"__codelineno-7-35\" name=\"__codelineno-7-35\"></a><span class=\"w\">    </span><span class=\"kt\">size_t</span><span class=\"w\">               </span><span class=\"n\">view_offs</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-36\" name=\"__codelineno-7-36\"></a>\n<a id=\"__codelineno-7-37\" name=\"__codelineno-7-37\"></a><span class=\"w\">    </span><span class=\"c1\">// \u5b58\u50a8\u5f20\u91cf\u7684\u6570\u636e</span>\n<a id=\"__codelineno-7-38\" name=\"__codelineno-7-38\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-39\" name=\"__codelineno-7-39\"></a>\n<a id=\"__codelineno-7-40\" name=\"__codelineno-7-40\"></a><span class=\"w\">    </span><span class=\"c1\">// \u5f20\u91cf\u7684\u540d\u79f0</span>\n<a id=\"__codelineno-7-41\" name=\"__codelineno-7-41\"></a><span class=\"w\">    </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">[</span><span class=\"n\">GGML_MAX_NAME</span><span class=\"p\">];</span>\n<a id=\"__codelineno-7-42\" name=\"__codelineno-7-42\"></a>\n<a id=\"__codelineno-7-43\" name=\"__codelineno-7-43\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">extra</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// extra things e.g. for ggml-cuda.cu</span>\n<a id=\"__codelineno-7-44\" name=\"__codelineno-7-44\"></a>\n<a id=\"__codelineno-7-45\" name=\"__codelineno-7-45\"></a><span class=\"w\">    </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">padding</span><span class=\"p\">[</span><span class=\"mi\">8</span><span class=\"p\">];</span>\n<a id=\"__codelineno-7-46\" name=\"__codelineno-7-46\"></a><span class=\"p\">};</span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u5b66\u4e60tensor\">\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u5b66\u4e60tensor<a class=\"headerlink\" href=\"#\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u5b66\u4e60tensor\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728examples\u6587\u4ef6\u5939\u4e2d\u6dfb\u52a0\u4e00\u4e2asimple-add.cpp\u7684\u6587\u4ef6\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-8-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-39\">39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-40\">40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-41\">41</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-42\">42</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-43\">43</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-44\">44</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-45\">45</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-46\">46</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-47\">47</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-48\">48</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-49\">49</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-50\">50</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&quot;ggml.h&quot;</span>\n<a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&quot;ggml-cpu.h&quot;</span>\n<a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cstring&gt;</span>\n<a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;iostream&gt;</span>\n<a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;vector&gt;</span>\n<a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\"></a>\n<a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_init_params</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\"></a><span class=\"w\">        </span><span class=\"cm\">/*.mem_size   =*/</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">ggml_graph_overhead</span><span class=\"p\">(),</span>\n<a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\"></a><span class=\"w\">        </span><span class=\"cm\">/*.mem_buffer =*/</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">,</span>\n<a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\"></a><span class=\"w\">        </span><span class=\"cm\">/*.no_alloc   =*/</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">,</span>\n<a id=\"__codelineno-8-12\" name=\"__codelineno-8-12\"></a><span class=\"w\">    </span><span class=\"p\">};</span>\n<a id=\"__codelineno-8-13\" name=\"__codelineno-8-13\"></a>\n<a id=\"__codelineno-8-14\" name=\"__codelineno-8-14\"></a><span class=\"w\">    </span><span class=\"n\">ggml_context</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_init</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-15\" name=\"__codelineno-8-15\"></a>\n<a id=\"__codelineno-8-16\" name=\"__codelineno-8-16\"></a><span class=\"w\">    </span><span class=\"c1\">// --------------------</span>\n<a id=\"__codelineno-8-17\" name=\"__codelineno-8-17\"></a><span class=\"w\">    </span><span class=\"c1\">// Modify this section to test different tensor computations</span>\n<a id=\"__codelineno-8-18\" name=\"__codelineno-8-18\"></a><span class=\"w\">    </span><span class=\"kt\">float</span><span class=\"w\"> </span><span class=\"n\">a_data</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-19\" name=\"__codelineno-8-19\"></a><span class=\"w\">        </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span>\n<a id=\"__codelineno-8-20\" name=\"__codelineno-8-20\"></a><span class=\"w\">        </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span>\n<a id=\"__codelineno-8-21\" name=\"__codelineno-8-21\"></a><span class=\"w\">        </span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span>\n<a id=\"__codelineno-8-22\" name=\"__codelineno-8-22\"></a><span class=\"w\">    </span><span class=\"p\">};</span>\n<a id=\"__codelineno-8-23\" name=\"__codelineno-8-23\"></a>\n<a id=\"__codelineno-8-24\" name=\"__codelineno-8-24\"></a><span class=\"w\">    </span><span class=\"kt\">float</span><span class=\"w\"> </span><span class=\"n\">b_data</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-25\" name=\"__codelineno-8-25\"></a><span class=\"w\">        </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span>\n<a id=\"__codelineno-8-26\" name=\"__codelineno-8-26\"></a><span class=\"w\">        </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span>\n<a id=\"__codelineno-8-27\" name=\"__codelineno-8-27\"></a><span class=\"w\">        </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<a id=\"__codelineno-8-28\" name=\"__codelineno-8-28\"></a><span class=\"w\">    </span><span class=\"p\">};</span>\n<a id=\"__codelineno-8-29\" name=\"__codelineno-8-29\"></a>\n<a id=\"__codelineno-8-30\" name=\"__codelineno-8-30\"></a>\n<a id=\"__codelineno-8-31\" name=\"__codelineno-8-31\"></a><span class=\"w\">    </span><span class=\"c1\">// \u56e0\u4e3aggml\u4e2dtensor\u8868\u793a\u548cpytorch\u76f8\u53cd\uff0c\u56e0\u6b643\u884c2\u5217\u7684\u77e9\u9635\uff0c\u8868\u793a\u4e3a[2, 3]</span>\n<a id=\"__codelineno-8-32\" name=\"__codelineno-8-32\"></a><span class=\"w\">    </span><span class=\"n\">ggml_tensor</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_new_tensor_2d</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_TYPE_F32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-33\" name=\"__codelineno-8-33\"></a><span class=\"w\">    </span><span class=\"n\">ggml_tensor</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_new_tensor_2d</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_TYPE_F32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">);</span><span class=\"w\"> </span>\n<a id=\"__codelineno-8-34\" name=\"__codelineno-8-34\"></a><span class=\"w\">    </span><span class=\"n\">memcpy</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"o\">-&gt;</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a_data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ggml_nbytes</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">));</span>\n<a id=\"__codelineno-8-35\" name=\"__codelineno-8-35\"></a><span class=\"w\">    </span><span class=\"n\">memcpy</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"o\">-&gt;</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b_data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ggml_nbytes</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">));</span>\n<a id=\"__codelineno-8-36\" name=\"__codelineno-8-36\"></a>\n<a id=\"__codelineno-8-37\" name=\"__codelineno-8-37\"></a><span class=\"w\">    </span><span class=\"n\">ggml_tensor</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_add</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-38\" name=\"__codelineno-8-38\"></a><span class=\"w\">    </span><span class=\"c1\">// --------------------</span>\n<a id=\"__codelineno-8-39\" name=\"__codelineno-8-39\"></a>\n<a id=\"__codelineno-8-40\" name=\"__codelineno-8-40\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_cgraph</span><span class=\"w\">  </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">gf</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_new_graph</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-41\" name=\"__codelineno-8-41\"></a><span class=\"w\">    </span><span class=\"n\">ggml_build_forward_expand</span><span class=\"p\">(</span><span class=\"n\">gf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-42\" name=\"__codelineno-8-42\"></a>\n<a id=\"__codelineno-8-43\" name=\"__codelineno-8-43\"></a><span class=\"w\">    </span><span class=\"n\">ggml_graph_compute_with_ctx</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">gf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-44\" name=\"__codelineno-8-44\"></a>\n<a id=\"__codelineno-8-45\" name=\"__codelineno-8-45\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">vector</span><span class=\"o\">&lt;</span><span class=\"kt\">float</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">out_data</span><span class=\"p\">(</span><span class=\"n\">ggml_nelements</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">));</span>\n<a id=\"__codelineno-8-46\" name=\"__codelineno-8-46\"></a><span class=\"w\">    </span><span class=\"n\">memcpy</span><span class=\"p\">(</span><span class=\"n\">out_data</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ggml_nbytes</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">));</span>\n<a id=\"__codelineno-8-47\" name=\"__codelineno-8-47\"></a>\n<a id=\"__codelineno-8-48\" name=\"__codelineno-8-48\"></a><span class=\"w\">    </span><span class=\"n\">ggml_free</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-49\" name=\"__codelineno-8-49\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-8-50\" name=\"__codelineno-8-50\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n\u5b8c\u5584cmake\u914d\u7f6e\uff0c\u5728CMakeLists.txt\u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">CMake</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-9-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-7\">7</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\"></a><span class=\"c\">#</span>\n<a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\"></a><span class=\"c\"># simple-add</span>\n<a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\"></a>\n<a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\"></a><span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"s\">TEST_TARGET</span><span class=\"w\"> </span><span class=\"s\">simple-add</span><span class=\"p\">)</span>\n<a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\"></a><span class=\"nb\">add_executable</span><span class=\"p\">(</span><span class=\"o\">${</span><span class=\"nv\">TEST_TARGET</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"s\">simple-add.cpp</span><span class=\"p\">)</span>\n<a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\"></a><span class=\"nb\">target_compile_options</span><span class=\"p\">(</span><span class=\"o\">${</span><span class=\"nv\">TEST_TARGET</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"s\">PRIVATE</span><span class=\"w\"> </span><span class=\"s\">-g</span><span class=\"p\">)</span>\n<a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\"></a><span class=\"nb\">target_link_libraries</span><span class=\"p\">(</span><span class=\"o\">${</span><span class=\"nv\">TEST_TARGET</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"s\">PRIVATE</span><span class=\"w\"> </span><span class=\"s\">ggml</span><span class=\"p\">)</span>\n</code></pre></div></td></tr></table></div>\n\u6839\u636e\u7b2c\u4e00\u8282\u7684\u5185\u5bb9\uff0c\u7f16\u8bd1\u7136\u540e\u5c31\u53ef\u4ee5\u7528vscode debug\u8c03\u8bd5\u4e86\u3002\u5f53\u5b8c\u6210ggml_new_tensor_2d\u521b\u5efa2\u7ef4\u5f20\u91cf\u65f6\uff0c\u5e76\u4e14\u901a\u8fc7memcpy\u62f7\u8d1d\u8d4b\u503c\u540e\u3002\u6211\u4eec\u901a\u8fc7gdb\u6253\u5370tensor\u7684\u6570\u636e\uff0c\u5c31\u53ef\u4ee5\u770b\u5230\u6570\u636e\u4e86\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-10-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-39\">39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-40\">40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-41\">41</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-42\">42</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-43\">43</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-44\">44</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-45\">45</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\"></a>&gt;<span class=\"w\"> </span>p<span class=\"w\"> </span>*a\n<a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\"></a><span class=\"o\">(</span>ggml_tensor<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\"></a><span class=\"w\">  </span><span class=\"nb\">type</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>GGML_TYPE_F32\n<a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\"></a><span class=\"w\">  </span><span class=\"nv\">buffer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-10-5\" name=\"__codelineno-10-5\"></a><span class=\"w\">  </span><span class=\"nv\">ne</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">([</span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">3</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">)</span>\n<a id=\"__codelineno-10-6\" name=\"__codelineno-10-6\"></a><span class=\"w\">  </span><span class=\"nv\">nb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">([</span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">8</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">24</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">24</span><span class=\"o\">)</span>\n<a id=\"__codelineno-10-7\" name=\"__codelineno-10-7\"></a><span class=\"w\">  </span><span class=\"nv\">op</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>GGML_OP_NONE\n<a id=\"__codelineno-10-8\" name=\"__codelineno-10-8\"></a><span class=\"w\">  </span><span class=\"nv\">op_params</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<a id=\"__codelineno-10-9\" name=\"__codelineno-10-9\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-10\" name=\"__codelineno-10-10\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-11\" name=\"__codelineno-10-11\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-12\" name=\"__codelineno-10-12\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-13\" name=\"__codelineno-10-13\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">4</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-14\" name=\"__codelineno-10-14\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">5</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-15\" name=\"__codelineno-10-15\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">6</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-16\" name=\"__codelineno-10-16\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">7</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-17\" name=\"__codelineno-10-17\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">8</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-18\" name=\"__codelineno-10-18\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">9</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-19\" name=\"__codelineno-10-19\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">10</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-20\" name=\"__codelineno-10-20\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">11</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-21\" name=\"__codelineno-10-21\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">12</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-22\" name=\"__codelineno-10-22\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">13</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-23\" name=\"__codelineno-10-23\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">14</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-24\" name=\"__codelineno-10-24\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">15</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-25\" name=\"__codelineno-10-25\"></a><span class=\"w\">  </span><span class=\"o\">}</span>\n<a id=\"__codelineno-10-26\" name=\"__codelineno-10-26\"></a><span class=\"w\">  </span><span class=\"nv\">flags</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-27\" name=\"__codelineno-10-27\"></a><span class=\"w\">  </span><span class=\"nv\">src</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<a id=\"__codelineno-10-28\" name=\"__codelineno-10-28\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-10-29\" name=\"__codelineno-10-29\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-10-30\" name=\"__codelineno-10-30\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-10-31\" name=\"__codelineno-10-31\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-10-32\" name=\"__codelineno-10-32\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">4</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-10-33\" name=\"__codelineno-10-33\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">5</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-10-34\" name=\"__codelineno-10-34\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">6</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-10-35\" name=\"__codelineno-10-35\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">7</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-10-36\" name=\"__codelineno-10-36\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">8</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-10-37\" name=\"__codelineno-10-37\"></a><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"m\">9</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-10-38\" name=\"__codelineno-10-38\"></a><span class=\"w\">  </span><span class=\"o\">}</span>\n<a id=\"__codelineno-10-39\" name=\"__codelineno-10-39\"></a><span class=\"w\">  </span><span class=\"nv\">view_src</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-10-40\" name=\"__codelineno-10-40\"></a><span class=\"w\">  </span><span class=\"nv\">view_offs</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-10-41\" name=\"__codelineno-10-41\"></a><span class=\"w\">  </span><span class=\"nv\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>0x00007fffb75eb1b0\n<a id=\"__codelineno-10-42\" name=\"__codelineno-10-42\"></a><span class=\"w\">  </span><span class=\"nv\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;&quot;</span>\n<a id=\"__codelineno-10-43\" name=\"__codelineno-10-43\"></a><span class=\"w\">  </span><span class=\"nv\">extra</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>0x0000000000000000\n<a id=\"__codelineno-10-44\" name=\"__codelineno-10-44\"></a><span class=\"w\">  </span><span class=\"nv\">padding</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;&quot;</span>\n<a id=\"__codelineno-10-45\" name=\"__codelineno-10-45\"></a><span class=\"o\">}</span>\n</code></pre></div></td></tr></table></div>\n\u4ece\u4e0a\u9762\u7684\u5185\u5bb9\u53ef\u4ee5\u770b\u5230\uff0cggml_tensor\u7ed3\u6784\u4f53\u7684ne\u6210\u5458\u53d8\u91cf\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u6570\u7ec4\u7684\u5143\u7d20\u4e2a\u6570\u662f4\uff0c\u5206\u522b\u8868\u793a\u8be5\u5f20\u91cf\u7684\u7ef4\u5ea6\u3002\u4f8b\u5982\uff0c\u4e00\u4e2a\u4e8c\u7ef4\u77e9\u9635\u7684ne\u6210\u5458\u53d8\u91cf\u4e3a[2, 3, 1, 1]\uff0c\u8868\u793a\u8be5\u77e9\u9635\u67093\u884c2\u5217\uff0c\u4e14\u884c\u548c\u5217\u7684\u7d22\u5f15\u4ece0\u5f00\u59cb\u3002</p>\n<h3 id=\"tensor\u7684\u5185\u5b58\u5e03\u5c40\">tensor\u7684\u5185\u5b58\u5e03\u5c40<a class=\"headerlink\" href=\"#tensor\u7684\u5185\u5b58\u5e03\u5c40\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"f32\u77e9\u9635\">f32\u77e9\u9635<a class=\"headerlink\" href=\"#f32\u77e9\u9635\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5bf9\u4e8ene\u7684\u7406\u89e3\uff0c\u6bd4\u5982\u4e00\u4e2aRGB\u7684\u56fe\u7247\uff0cwidth\u4e3a1920\uff0cheight\u4e3a1080\uff0c \u7528pytorch\u8868\u793a\u7ef4\u5ea6\u4fe1\u606f\u5c31\u662f[1, 3, 1080, 1920],\u5373[N, C, H, W]\u3002\u800c\u5728GGML\u4e2d\uff0c\u8fd9\u4e2a\u7ef4\u5ea6\u4fe1\u606f\u8868\u793a\u4e3a\uff1a\n[1920, 1080, 3, 1]\u3002</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-11-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-7\">7</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\"></a><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">GGML_TYPE_F32</span>\n<a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\"></a><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">nullptr</span>\n<a id=\"__codelineno-11-3\" name=\"__codelineno-11-3\"></a><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">([</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<a id=\"__codelineno-11-4\" name=\"__codelineno-11-4\"></a><span class=\"c1\">// 4\u8868\u793a\u7b2c\u4e00\u7ef4\u6bcf\u4e2a\u5143\u7d20\u6240\u5360\u5b57\u8282\u6570\u30028\u8868\u793a\u6bcf\u884c\u5143\u7d20\u95f4\u96948\u4e2a\u5b57\u8282\uff0c\u4e5f\u5c31\u662f\u95f4\u9694\u4e24\u4e2a\u5143\u7d20\u3002</span>\n<a id=\"__codelineno-11-5\" name=\"__codelineno-11-5\"></a><span class=\"c1\">// \u4e5f\u5c31\u662f\u5728\u5185\u5b58\u5b58\u50a8\u7684\u5e03\u5c40\u662frow major\u8fde\u7eed\u5b58\u50a8\u7684</span>\n<a id=\"__codelineno-11-6\" name=\"__codelineno-11-6\"></a><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">([</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"p\">)</span>\n<a id=\"__codelineno-11-7\" name=\"__codelineno-11-7\"></a><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">GGML_OP_NONE</span>\n</code></pre></div></td></tr></table></div>\nne\u53ea\u8868\u793a\u4e86\u77e9\u9635\u7684\u7ef4\u5ea6\uff0c\u800cnb\u8868\u793a\u4e86\u77e9\u9635\u5728\u5185\u5b58\u4e2d\u7684\u5b58\u50a8\u5e03\u5c40\uff0c\u4ee5\u53ca\u6bcf\u884c\u5143\u7d20\u95f4\u9694\u3002</p>\n<h3 id=\"\u91cf\u5316\u77e9\u9635\">\u91cf\u5316\u77e9\u9635<a class=\"headerlink\" href=\"#\u91cf\u5316\u77e9\u9635\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4efb\u610f\u5730\u65b9\u52a0\u4e00\u884c\u8868\u793a\u4e00\u4e2a\u91cf\u5316\u77e9\u9635\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-12-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-12-1\" name=\"__codelineno-12-1\"></a><span class=\"n\">ggml_tensor</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_new_tensor_2d</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_TYPE_Q4_0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u901a\u8fc7<code>p *c</code> \u53ef\u4ee5\u67e5\u770b\u77e9\u9635\u7684\u8be6\u7ec6\u4fe1\u606f\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-13-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-8\">8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-9\">9</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-13-1\" name=\"__codelineno-13-1\"></a>&gt;<span class=\"w\"> </span>p<span class=\"w\"> </span>*c\n<a id=\"__codelineno-13-2\" name=\"__codelineno-13-2\"></a><span class=\"o\">(</span>ggml_tensor<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<a id=\"__codelineno-13-3\" name=\"__codelineno-13-3\"></a><span class=\"w\">  </span><span class=\"nb\">type</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>GGML_TYPE_Q4_0\n<a id=\"__codelineno-13-4\" name=\"__codelineno-13-4\"></a><span class=\"w\">  </span><span class=\"nv\">buffer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-13-5\" name=\"__codelineno-13-5\"></a><span class=\"w\">  </span><span class=\"nv\">ne</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">([</span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">32</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">6</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">)</span>\n<a id=\"__codelineno-13-6\" name=\"__codelineno-13-6\"></a><span class=\"w\">  </span><span class=\"nv\">nb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">([</span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">18</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">18</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">108</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">108</span><span class=\"o\">)</span>\n<a id=\"__codelineno-13-7\" name=\"__codelineno-13-7\"></a><span class=\"w\">  </span><span class=\"nv\">op</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>GGML_OP_NONE\n<a id=\"__codelineno-13-8\" name=\"__codelineno-13-8\"></a><span class=\"w\">  </span>......\n<a id=\"__codelineno-13-9\" name=\"__codelineno-13-9\"></a><span class=\"o\">}</span>\n</code></pre></div></td></tr></table></div>\n\u4e0b\u9762\u5c31\u5206\u6790\u8ba4\u8bc6\u4e00\u4e9bQ4_0\u7c7b\u578b\u7684\u77e9\u9635\u8868\u793a\u6709\u4ec0\u4e48\u4e0d\u540c\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-14-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-8\">8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-9\">9</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-14-1\" name=\"__codelineno-14-1\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">ggml_half</span><span class=\"p\">;</span>\n<a id=\"__codelineno-14-2\" name=\"__codelineno-14-2\"></a><span class=\"cp\">#define QK4_0 32</span>\n<a id=\"__codelineno-14-3\" name=\"__codelineno-14-3\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-14-4\" name=\"__codelineno-14-4\"></a><span class=\"w\">    </span><span class=\"c1\">// 16bit\u5b58\u50a8delta\u4fe1\u606f, 2\u4e2a\u5b57\u8282</span>\n<a id=\"__codelineno-14-5\" name=\"__codelineno-14-5\"></a><span class=\"w\">    </span><span class=\"n\">ggml_half</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">;</span><span class=\"w\">           </span><span class=\"c1\">// delta</span>\n<a id=\"__codelineno-14-6\" name=\"__codelineno-14-6\"></a><span class=\"w\">    </span><span class=\"c1\">// 8bit\u6570\u7ec4\uff0c\u6570\u7ec4\u957f\u5ea6\u4e3a\uff1a16\uff0c 16\u4e2a\u5b57\u8282</span>\n<a id=\"__codelineno-14-7\" name=\"__codelineno-14-7\"></a><span class=\"w\">    </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">qs</span><span class=\"p\">[</span><span class=\"n\">QK4_0</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">];</span><span class=\"w\"> </span><span class=\"c1\">// nibbles / quants</span>\n<a id=\"__codelineno-14-8\" name=\"__codelineno-14-8\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">block_q4_0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-14-9\" name=\"__codelineno-14-9\"></a><span class=\"k\">static_assert</span><span class=\"p\">(</span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">block_q4_0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">ggml_half</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">QK4_0</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;wrong q4_0 block size/padding&quot;</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div>\n\u5728GGML\u4e2d\uff0c\u4e00\u4e2ablock_q4_0\u7ed3\u6784\u4f53\uff0c\u53ef\u4ee5\u8868\u793a32\u4e2aint4\u5143\u7d20\uff0c\u518d\u52a0\u4e0a\u4e00\u4e2a16bit\u7684delta\u4fe1\u606f\u3002</p>\n<p>\u6211\u4eecne[0]\u548cne[1]\u5206\u522b\u4e3a32, 16,\u8868\u793a\u4e8632\u884c\u548c16\u5217\u7684int4\u77e9\u9635\u3002\u800cnb[0]\u4e3a18\uff0c\u8868\u793aGGML\u7684q4_0\u91cf\u5316\u5c0632\u4e2aint4\u5143\u7d20\u7ec4\u5408\u5728\u4e00\u8d77\uff0c\u518d\u52a0\u4e0a\u4e00\u4e2a16\u4f4d\u7684\u5dee\u503c\uff0c\u6bcf\u7ec4\u517118\u5b57\u8282\u3002</p>\n<p>[32, 6, 1, 1]\u7684Q4_0\u6570\u7ec4\u5c31\u53ef\u4ee5\u770b\u6210[1,6,1,1]\uff0c\u56e0\u4e3a32\u4e2a\u5143\u7d20\u4e3a\u5185\u5b58\u4e0a\u7684\u6700\u5c0f\u5bfb\u5740\u5355\u5143\u3002\u66f4\u9ad8\u7ef4\u5ea6\u7684\u60c5\u51b5\u4e0b\uff0cnb[i] = nb[i-1] * ne[i]\u3002</p>\n<h3 id=\"\u77e9\u9635permute\u91cd\u6392\u5217\">\u77e9\u9635permute\u91cd\u6392\u5217<a class=\"headerlink\" href=\"#\u77e9\u9635permute\u91cd\u6392\u5217\" title=\"Permanent link\">&para;</a></h3>\n<p>\u770b\u4e00\u4e2apytorch\u4f8b\u5b50\uff0c\u4e86\u89e3permute\u662f\u4ec0\u4e48\uff1fpermute\u5c31\u662f\u5bf9\u6570\u636e\u7684\u7ef4\u5ea6\u53d8\u5316\u987a\u5e8f\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-15-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-8\">8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-9\">9</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-15-1\" name=\"__codelineno-15-1\"></a><span class=\"k\">import</span><span class=\"w\"> </span><span class=\"n\">torch</span>\n<a id=\"__codelineno-15-2\" name=\"__codelineno-15-2\"></a><span class=\"k\">import</span><span class=\"w\"> </span><span class=\"n\">numpy</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"n\">np</span>\n<a id=\"__codelineno-15-3\" name=\"__codelineno-15-3\"></a>\n<a id=\"__codelineno-15-4\" name=\"__codelineno-15-4\"></a><span class=\"n\">a</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"p\">.</span><span class=\"n\">array</span><span class=\"p\">([[[</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"mi\">3</span><span class=\"p\">],[</span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">6</span><span class=\"p\">]]])</span>\n<a id=\"__codelineno-15-5\" name=\"__codelineno-15-5\"></a><span class=\"n\">unpermuted</span><span class=\"o\">=</span><span class=\"n\">torch</span><span class=\"p\">.</span><span class=\"n\">tensor</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">)</span>\n<a id=\"__codelineno-15-6\" name=\"__codelineno-15-6\"></a><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"n\">unpermuted</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">())</span><span class=\"w\">              </span><span class=\"err\">#</span><span class=\"w\">  </span><span class=\"err\">\u2014\u2014</span><span class=\"o\">&gt;</span><span class=\"w\">  </span><span class=\"n\">torch</span><span class=\"p\">.</span><span class=\"n\">Size</span><span class=\"p\">([</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">])</span>\n<a id=\"__codelineno-15-7\" name=\"__codelineno-15-7\"></a>\n<a id=\"__codelineno-15-8\" name=\"__codelineno-15-8\"></a><span class=\"n\">permuted</span><span class=\"o\">=</span><span class=\"n\">unpermuted</span><span class=\"p\">.</span><span class=\"n\">permute</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<a id=\"__codelineno-15-9\" name=\"__codelineno-15-9\"></a><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"n\">permuted</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">())</span><span class=\"w\">                </span><span class=\"err\">#</span><span class=\"w\">  </span><span class=\"err\">\u2014\u2014</span><span class=\"o\">&gt;</span><span class=\"w\">  </span><span class=\"n\">torch</span><span class=\"p\">.</span><span class=\"n\">Size</span><span class=\"p\">([</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">])</span>\n</code></pre></div></td></tr></table></div></p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-16-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-16-1\" name=\"__codelineno-16-1\"></a><span class=\"n\">tensor</span><span class=\"p\">([[[</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"p\">]],</span>\n<a id=\"__codelineno-16-2\" name=\"__codelineno-16-2\"></a><span class=\"w\">        </span><span class=\"p\">[[</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"p\">]],</span>\n<a id=\"__codelineno-16-3\" name=\"__codelineno-16-3\"></a><span class=\"w\">        </span><span class=\"p\">[[</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"p\">]]])</span><span class=\"w\">     </span><span class=\"err\">#</span><span class=\"w\"> </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"n\">permuted</span><span class=\"p\">)</span><span class=\"w\">    </span>\n</code></pre></div></td></tr></table></div>\n<p>\u518d\u770bggml\u4e2d\u7684permute\u64cd\u4f5c\uff0c\u6dfb\u52a0\u5982\u4e0b\u4f8b\u5b50:\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-17-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-4\">4</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-17-1\" name=\"__codelineno-17-1\"></a><span class=\"n\">ggml_tensor</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">before</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">;</span>\n<a id=\"__codelineno-17-2\" name=\"__codelineno-17-2\"></a>\n<a id=\"__codelineno-17-3\" name=\"__codelineno-17-3\"></a><span class=\"c1\">// Same as PyTorch&#39;s permute()</span>\n<a id=\"__codelineno-17-4\" name=\"__codelineno-17-4\"></a><span class=\"n\">ggml_tensor</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_permute</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">before</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div>\n\u89c2\u5bdfbefore\u548cafter tensor\u4fe1\u606f\uff0c\u53ef\u4ee5\u770b\u5230after\u7684ne\u548cnb\u4e2d\u76840\u548c1\u7ef4\u5ea6\u4ea4\u6362\u4e86\uff0c\u4f46\u662f\u770bdata\uff0c\u5176\u5b9e\u6570\u636e\u5185\u5b58\u5b58\u50a8\u672c\u8eab\u662f\u6ca1\u6709\u53d8\u5316\u7684\u3002\u5bf9\u4e8e\u4e00\u4e2a\u5185\u5b58\u5b58\u50a8\uff0c\u8981\u6539\u53d8ne\u7ef4\u5ea6\u4fe1\u606f\uff0c\u53ea\u9700\u8981\u6539\u53d8nb\u6bcf\u4e2a\u7ef4\u5ea6\u7684\u95f4\u9694\uff0c\u4e5f\u5c31\u662f\u6570\u636e\u8bbf\u95ee\u65b9\u5f0f\u3002</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-18-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-25\">25</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-18-1\" name=\"__codelineno-18-1\"></a>&gt;<span class=\"w\"> </span>p<span class=\"w\"> </span>*before\n<a id=\"__codelineno-18-2\" name=\"__codelineno-18-2\"></a><span class=\"o\">(</span>ggml_tensor<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<a id=\"__codelineno-18-3\" name=\"__codelineno-18-3\"></a><span class=\"w\">  </span><span class=\"nb\">type</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>GGML_TYPE_F32\n<a id=\"__codelineno-18-4\" name=\"__codelineno-18-4\"></a><span class=\"w\">  </span><span class=\"nv\">buffer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-18-5\" name=\"__codelineno-18-5\"></a><span class=\"w\">  </span><span class=\"nv\">ne</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">([</span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">3</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">)</span>\n<a id=\"__codelineno-18-6\" name=\"__codelineno-18-6\"></a><span class=\"w\">  </span><span class=\"nv\">nb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">([</span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">8</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">24</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">24</span><span class=\"o\">)</span>\n<a id=\"__codelineno-18-7\" name=\"__codelineno-18-7\"></a><span class=\"w\">  </span><span class=\"nv\">op</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>GGML_OP_NONE\n<a id=\"__codelineno-18-8\" name=\"__codelineno-18-8\"></a><span class=\"w\">  </span><span class=\"nv\">view_src</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-18-9\" name=\"__codelineno-18-9\"></a><span class=\"w\">  </span><span class=\"nv\">view_offs</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-18-10\" name=\"__codelineno-18-10\"></a><span class=\"w\">  </span><span class=\"nv\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>0x00007fffb77eb1b0\n<a id=\"__codelineno-18-11\" name=\"__codelineno-18-11\"></a><span class=\"o\">}</span>\n<a id=\"__codelineno-18-12\" name=\"__codelineno-18-12\"></a>\n<a id=\"__codelineno-18-13\" name=\"__codelineno-18-13\"></a>&gt;<span class=\"w\"> </span>p<span class=\"w\"> </span>*after\n<a id=\"__codelineno-18-14\" name=\"__codelineno-18-14\"></a><span class=\"o\">(</span>ggml_tensor<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<a id=\"__codelineno-18-15\" name=\"__codelineno-18-15\"></a><span class=\"w\">  </span><span class=\"nb\">type</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>GGML_TYPE_F32\n<a id=\"__codelineno-18-16\" name=\"__codelineno-18-16\"></a><span class=\"w\">  </span><span class=\"nv\">buffer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>nullptr\n<a id=\"__codelineno-18-17\" name=\"__codelineno-18-17\"></a><span class=\"w\">  </span><span class=\"nv\">ne</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">([</span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">3</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">)</span>\n<a id=\"__codelineno-18-18\" name=\"__codelineno-18-18\"></a><span class=\"w\">  </span><span class=\"nv\">nb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">([</span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">8</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">24</span>,<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">24</span><span class=\"o\">)</span>\n<a id=\"__codelineno-18-19\" name=\"__codelineno-18-19\"></a><span class=\"w\">  </span><span class=\"nv\">op</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>GGML_OP_PERMUTE\n<a id=\"__codelineno-18-20\" name=\"__codelineno-18-20\"></a>\n<a id=\"__codelineno-18-21\" name=\"__codelineno-18-21\"></a><span class=\"w\">  </span><span class=\"nv\">view_src</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>0x00007fffb77eb060\n<a id=\"__codelineno-18-22\" name=\"__codelineno-18-22\"></a><span class=\"w\">  </span><span class=\"nv\">view_offs</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<a id=\"__codelineno-18-23\" name=\"__codelineno-18-23\"></a><span class=\"w\">  </span><span class=\"nv\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>0x00007fffb77eb1b0\n<a id=\"__codelineno-18-24\" name=\"__codelineno-18-24\"></a><span class=\"w\">  </span><span class=\"nv\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot; (permuted)&quot;</span>\n<a id=\"__codelineno-18-25\" name=\"__codelineno-18-25\"></a><span class=\"o\">}</span>\n</code></pre></div></td></tr></table></div>\n\u4eceview_src\u4e5f\u53ef\u4ee5\u770b\u51faafter\u53ea\u662fbefore\u7684\u89c6\u56fe\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-19-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-16\">16</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-19-1\" name=\"__codelineno-19-1\"></a><span class=\"c1\">// Pseudo-code representation of tensor&#39;s memory layout</span>\n<a id=\"__codelineno-19-2\" name=\"__codelineno-19-2\"></a><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">6</span><span class=\"p\">]</span>\n<a id=\"__codelineno-19-3\" name=\"__codelineno-19-3\"></a>\n<a id=\"__codelineno-19-4\" name=\"__codelineno-19-4\"></a><span class=\"c1\">// Accessing row 1 before permutation, nb[0] = 4</span>\n<a id=\"__codelineno-19-5\" name=\"__codelineno-19-5\"></a><span class=\"c1\">// 1, 2,</span>\n<a id=\"__codelineno-19-6\" name=\"__codelineno-19-6\"></a><span class=\"c1\">// 3, 4,</span>\n<a id=\"__codelineno-19-7\" name=\"__codelineno-19-7\"></a><span class=\"c1\">// 5, 6</span>\n<a id=\"__codelineno-19-8\" name=\"__codelineno-19-8\"></a><span class=\"n\">e0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<a id=\"__codelineno-19-9\" name=\"__codelineno-19-9\"></a><span class=\"n\">e1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<a id=\"__codelineno-19-10\" name=\"__codelineno-19-10\"></a>\n<a id=\"__codelineno-19-11\" name=\"__codelineno-19-11\"></a><span class=\"c1\">// Accessing row 1 after permutation, nb[0] = 8</span>\n<a id=\"__codelineno-19-12\" name=\"__codelineno-19-12\"></a><span class=\"c1\">// [[1,3,5],</span>\n<a id=\"__codelineno-19-13\" name=\"__codelineno-19-13\"></a><span class=\"c1\">//  [2,4,6]]</span>\n<a id=\"__codelineno-19-14\" name=\"__codelineno-19-14\"></a><span class=\"n\">e0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<a id=\"__codelineno-19-15\" name=\"__codelineno-19-15\"></a><span class=\"n\">e1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<a id=\"__codelineno-19-16\" name=\"__codelineno-19-16\"></a><span class=\"n\">e1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"\u5f20\u91cf\u89c6\u56fe\">\u5f20\u91cf\u89c6\u56fe<a class=\"headerlink\" href=\"#\u5f20\u91cf\u89c6\u56fe\" title=\"Permanent link\">&para;</a></h3>\n<p>\u89c6\u56fe\u53ef\u4ee5\u5bf9\u5f20\u91cf\u5185\u5b58\u8fdb\u884c\u590d\u7528\uff0c\u907f\u514d\u62f7\u8d1d\u3001\u907f\u514d\u4f4e\u6548\u7684\u4e3a\u6bcf\u4e2a\u5f20\u91cf\u5206\u914d\u4e00\u4e2a\u72ec\u7279\u7684\u5185\u5b58\u5757\u3002</p>\n<p>\u4ee5ggml_cpy\u64cd\u4f5c\u4e3a\u4f8b\uff0c\u62f7\u8d1d\u7684b tensor\u5c31\u662f\u76f8\u5bf9\u4e8ea\u521b\u5efa\u7684\u4e00\u4e2a\u89c6\u56fe\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-20-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-20-21\">21</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-20-1\" name=\"__codelineno-20-1\"></a><span class=\"c1\">// ggml_cpy</span>\n<a id=\"__codelineno-20-2\" name=\"__codelineno-20-2\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ggml_cpy_impl</span><span class=\"p\">(</span>\n<a id=\"__codelineno-20-3\" name=\"__codelineno-20-3\"></a><span class=\"w\">        </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_context</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"p\">,</span>\n<a id=\"__codelineno-20-4\" name=\"__codelineno-20-4\"></a><span class=\"w\">        </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\">  </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">,</span>\n<a id=\"__codelineno-20-5\" name=\"__codelineno-20-5\"></a><span class=\"w\">        </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\">  </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-20-6\" name=\"__codelineno-20-6\"></a><span class=\"w\">    </span><span class=\"n\">GGML_ASSERT</span><span class=\"p\">(</span><span class=\"n\">ggml_nelements</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">ggml_nelements</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">));</span>\n<a id=\"__codelineno-20-7\" name=\"__codelineno-20-7\"></a>\n<a id=\"__codelineno-20-8\" name=\"__codelineno-20-8\"></a><span class=\"w\">    </span><span class=\"c1\">// make a view of the destination</span>\n<a id=\"__codelineno-20-9\" name=\"__codelineno-20-9\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_view_tensor</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">);</span>\n<a id=\"__codelineno-20-10\" name=\"__codelineno-20-10\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">strlen</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"o\">-&gt;</span><span class=\"n\">name</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-20-11\" name=\"__codelineno-20-11\"></a><span class=\"w\">        </span><span class=\"n\">ggml_format_name</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;%s (copy of %s)&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">-&gt;</span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">-&gt;</span><span class=\"n\">name</span><span class=\"p\">);</span>\n<a id=\"__codelineno-20-12\" name=\"__codelineno-20-12\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-20-13\" name=\"__codelineno-20-13\"></a><span class=\"w\">        </span><span class=\"n\">ggml_format_name</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;%s (copy)&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">-&gt;</span><span class=\"n\">name</span><span class=\"p\">);</span>\n<a id=\"__codelineno-20-14\" name=\"__codelineno-20-14\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-20-15\" name=\"__codelineno-20-15\"></a>\n<a id=\"__codelineno-20-16\" name=\"__codelineno-20-16\"></a><span class=\"w\">    </span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">op</span><span class=\"w\">     </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">GGML_OP_CPY</span><span class=\"p\">;</span>\n<a id=\"__codelineno-20-17\" name=\"__codelineno-20-17\"></a><span class=\"w\">    </span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">src</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">;</span>\n<a id=\"__codelineno-20-18\" name=\"__codelineno-20-18\"></a><span class=\"w\">    </span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">src</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">;</span>\n<a id=\"__codelineno-20-19\" name=\"__codelineno-20-19\"></a>\n<a id=\"__codelineno-20-20\" name=\"__codelineno-20-20\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">;</span>\n<a id=\"__codelineno-20-21\" name=\"__codelineno-20-21\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u4ee5LLM\u4e2dQ\u3001K\u3001V tensor\u4e3a\u4f8b\uff0c\u4e0b\u9762\u7684Qcur\u3001Kcur\u3001Vcur\u53ef\u4ee5\u8868\u793a\u6210\u521b\u5efa\u7684tensor_input\u7684\u4e00\u90e8\u5206\u3002\u6240\u4ee5\u89c6\u56fe\u4e0d\u7528\u662fbase tensor\u7684\u5168\u90e8\uff0c\u53ef\u4ee5\u53ea\u662f\u4e00\u90e8\u5206\uff0c\u901a\u8fc7offset\u53ef\u4ee5\u8bbe\u7f6e\u76f8\u5bf9base tensor\u7684\u504f\u79fb\u91cf\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-21-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-21-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-21-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-21-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-21-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-21-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-21-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-21-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-21-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-21-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-21-11\">11</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-21-1\" name=\"__codelineno-21-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">tensor_input</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_new_tensor_2d</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_TYPE_32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">768</span><span class=\"o\">*</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">seq_len</span><span class=\"p\">);</span>\n<a id=\"__codelineno-21-2\" name=\"__codelineno-21-2\"></a>\n<a id=\"__codelineno-21-3\" name=\"__codelineno-21-3\"></a><span class=\"c1\">// Create a view tensor of shape (768, seq_len) with offset 0</span>\n<a id=\"__codelineno-21-4\" name=\"__codelineno-21-4\"></a><span class=\"c1\">// The last parameter of ggml_view_2d specifies the view&#39;s offset (in bytes)</span>\n<a id=\"__codelineno-21-5\" name=\"__codelineno-21-5\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">Qcur</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_view_2d</span><span class=\"p\">(</span><span class=\"n\">ctx0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tensor_input</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">768</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">seq_len</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cur</span><span class=\"o\">-&gt;</span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">float</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">768</span><span class=\"p\">);</span>\n<a id=\"__codelineno-21-6\" name=\"__codelineno-21-6\"></a>\n<a id=\"__codelineno-21-7\" name=\"__codelineno-21-7\"></a><span class=\"c1\">// Create a view tensor of shape (768, seq_len) with offset 768</span>\n<a id=\"__codelineno-21-8\" name=\"__codelineno-21-8\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">Kcur</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_view_2d</span><span class=\"p\">(</span><span class=\"n\">ctx0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tensor_input</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">768</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">seq_len</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cur</span><span class=\"o\">-&gt;</span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">float</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">768</span><span class=\"p\">);</span>\n<a id=\"__codelineno-21-9\" name=\"__codelineno-21-9\"></a>\n<a id=\"__codelineno-21-10\" name=\"__codelineno-21-10\"></a><span class=\"c1\">// Create a view tensor of shape (768, seq_len) with offset 768 * 2</span>\n<a id=\"__codelineno-21-11\" name=\"__codelineno-21-11\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">Vcur</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_view_2d</span><span class=\"p\">(</span><span class=\"n\">ctx0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tensor_input</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">768</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">seq_len</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cur</span><span class=\"o\">-&gt;</span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">float</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">768</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div></p>\n<h2 id=\"\u63a2\u7d22ggml\u7684\u5b9e\u73b0ggml\u7684\u5185\u5b58\u7ba1\u7406\">\u63a2\u7d22ggml\u7684\u5b9e\u73b0&ndash;GGML\u7684\u5185\u5b58\u7ba1\u7406<a class=\"headerlink\" href=\"#\u63a2\u7d22ggml\u7684\u5b9e\u73b0ggml\u7684\u5185\u5b58\u7ba1\u7406\" title=\"Permanent link\">&para;</a></h2>\n<p>\u672c\u5c0f\u8282\u901a\u8fc7\u6700\u7b80\u5355\u7684\u4e00\u4e2a\u4f8b\u5b50, ./examples/simple/simple-ctx.cpp\uff0c\u7406\u89e3GGML\u5b9e\u73b0\u4e24\u4e2a\u77e9\u9635\u6267\u884c\u77e9\u9635\u4e58\u6cd5\u7684\u6838\u5fc3\u5de5\u4f5c\u6d41\u7a0b\u3002</p>\n<p>\u8fd9\u4e2a\u4f8b\u5b50\u5177\u6709\u4ee5\u4e0b\u7279\u70b9\uff0c\u4e5f\u56e0\u6b64\u4f5c\u4e3a\u6211\u4eec\u7406\u89e3\u7684\u8d77\u70b9\u3002</p>\n<ul>\n<li>\n<p>\u5728cpu\u4e0a\u6267\u884c\u6700\u7b80\u5355\u7684\u4e24\u4e2a\u77e9\u9635\u7684\u4e58\u6cd5\u8ba1\u7b97\uff0c\u4e0e\u786c\u4ef6\u663e\u5361\u65e0\u5173</p>\n</li>\n<li>\n<p>\u6240\u6709\u7684\u8ba1\u7b97\u90fd\u5728cpu\u4e0a\u6267\u884c\uff0c\u6240\u6709\u7684\u5185\u5b58\u5206\u914d\u90fd\u5728RAM\u4e2d\u5b8c\u6210</p>\n</li>\n</ul>\n<p>!!![warning]\n    GGML\u91c7\u7528c\u8bed\u8a00\u98ce\u683c\u5b9e\u73b0\uff0c\u6240\u4ee5\u5728\u5185\u5b58\u7ba1\u7406\u4e0a\uff0c\u901a\u8fc7struct\u4e2d\u7684\u6307\u9488\u548c\u504f\u79fb\u91cf\u6765\u7ba1\u7406\u5185\u5b58\uff0c\u6211\u4eec\u9700\u8981\u8ddf\u8e2a\u6307\u9488\u503c\u3001\u8ba1\u7b97\u504f\u79fb\u91cf\uff0c\u6765\u7406\u89e3\u5b83\u7684\u5185\u5b58\u5e03\u5c40\u3002</p>\n<h3 id=\"\u8ba4\u8bc6ggml_context\">\u8ba4\u8bc6ggml_context<a class=\"headerlink\" href=\"#\u8ba4\u8bc6ggml_context\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8df3\u8fc7\u4e0d\u91cd\u8981\u7684\u51fd\u6570\uff08\u6bd4\u5982\uff1a ggml_time_init\uff09\uff0c\u65ad\u70b9debug\u8fdb\u5165load_model\u51fd\u6570\u3002\u9996\u5148\u770b\u5230\u4e00\u4e2actx_size\u7684\u8ba1\u7b97\uff0c\u901a\u8fc7ctx_size\u4f5c\u4e3a\u53c2\u6570\uff0c\u8c03\u7528\u4e86ggml_init\u51fd\u6570, \u521d\u59cb\u5316\u4e86struct ggml_context *\u3002</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx.png\" /></p>\n<p>\u6682\u65f6\u5148\u8df3\u8fc7\u590d\u6742\u7684ctx_size\u8ba1\u7b97\uff0c\u91cd\u70b9\u5173\u6ce8\u8fd9\u4e2aGGML\u6700\u91cd\u8981\u7684\u51fd\u6570\u4e4b\u4e00\uff1aggml_init\u3002</p>\n<h4 id=\"\u7406\u89e3ggml_init\">\u7406\u89e3ggml_init<a class=\"headerlink\" href=\"#\u7406\u89e3ggml_init\" title=\"Permanent link\">&para;</a></h4>\n<p>ggml_init\u51fd\u6570\u63a5\u53d7\u4e00\u4e2a\u53c2\u6570ggml_init_params\uff0c\u8fd9\u4e2a\u53c2\u6570\u4e2d\u5305\u542b\u5185\u5b58\u5206\u914d\u7684\u53c2\u6570\u3002</p>\n<ul>\n<li>\n<p>mem_size_: \u5185\u5b58\u6c60\u5927\u5c0f\uff0c\u4e5f\u5c31\u662fctx_size\uff08\u63d0\u524d\u8ba1\u7b97\u51fa\u6765\u7684\uff09</p>\n</li>\n<li>\n<p>mem_buffer_: \u5185\u5b58\u6c60\uff0c\u4e5f\u5c31\u662fctx_buffer\uff0c\u8fd9\u4e2a\u5185\u5b58\u6c60\u7528\u4e8e\u5b58\u50a8ggml_tensor\u7ed3\u6784\u4f53\u548c\u6570\u636e\u3002\u8fd9\u91cc\u4f20\u9012\u7684NULL\u521d\u59cb\u5316\uff0c\u8868\u793a\u7531\u5185\u90e8\u5206\u914d</p>\n</li>\n<li>\n<p>no_alloc_: \u662f\u5426\u4f7f\u7528\u7528\u6237\u4f20\u9012\u7684\u5185\u5b58\u6c60\uff0c\u5982\u679c\u4e3atrue\uff0c\u5219\u4f7f\u7528\u7528\u6237\u4f20\u9012\u7684\u5185\u5b58\u6c60\u3002\u8fd9\u4e2a\u4f20\u9012\u7684false\uff0c\u8868\u793a\u7531\u5185\u90e8\u5206\u914d\u5185\u5b58\u6c60\u3002</p>\n</li>\n</ul>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-22-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-22-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-22-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-22-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-22-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-22-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-22-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-22-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-22-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-22-10\">10</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-22-1\" name=\"__codelineno-22-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_context</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ggml_init</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_init_params</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-22-2\" name=\"__codelineno-22-2\"></a><span class=\"w\">    </span><span class=\"c1\">// ......</span>\n<a id=\"__codelineno-22-3\" name=\"__codelineno-22-3\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-22-4\" name=\"__codelineno-22-4\"></a>\n<a id=\"__codelineno-22-5\" name=\"__codelineno-22-5\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_init_params</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-22-6\" name=\"__codelineno-22-6\"></a><span class=\"w\">    </span><span class=\"c1\">// memory pool</span>\n<a id=\"__codelineno-22-7\" name=\"__codelineno-22-7\"></a><span class=\"w\">    </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">mem_size</span><span class=\"p\">;</span><span class=\"w\">   </span><span class=\"c1\">// bytes</span>\n<a id=\"__codelineno-22-8\" name=\"__codelineno-22-8\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">mem_buffer</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// if NULL, memory will be allocated internally</span>\n<a id=\"__codelineno-22-9\" name=\"__codelineno-22-9\"></a><span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\">   </span><span class=\"n\">no_alloc</span><span class=\"p\">;</span><span class=\"w\">   </span><span class=\"c1\">// don&#39;t allocate memory for the tensor data</span>\n<a id=\"__codelineno-22-10\" name=\"__codelineno-22-10\"></a><span class=\"p\">};</span>\n</code></pre></div></td></tr></table></div>\n<p>\u8fdb\u5165ggml_init\u51fd\u6570\uff0c\u53ef\u4ee5\u770b\u5230\uff0c\u9996\u5148\u5728\u5806\u4e0a\u5206\u914d\u4e86\u4e00\u4e2astruct ggml_context *\u3002</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_init_func.png\" /></p>\n<p>\u5230\u8fd9\u91cc\uff0cggml_context\u5185\u5b58\u5e03\u5c40\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u4f1a\u4e00\u6b65\u4e00\u6b65\u4e86\u89e3\u5185\u90e8\u7684\u8fdb\u4e00\u6b65\u5206\u914d\u3002</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph1.png\" /></p>\n<h3 id=\"ggml\u7684tensor\u8868\u793a\">GGML\u7684tensor\u8868\u793a<a class=\"headerlink\" href=\"#ggml\u7684tensor\u8868\u793a\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728ggml_init\u51fd\u6570\u6267\u884c\u5b8c\u6210\u540e\uff0c\u7d27\u63a5\u7740\u5c31\u662f\u5bf9\u4e24\u4e2a\u77e9\u9635tensor\u7684\u521b\u5efa\u548c\u5185\u5b58\u8d4b\u503c\u3002\u5305\u62ec\u4e86ggml_new_tensor_2d\u7684\u8c03\u7528\uff0c\u4e00\u76f4\u8c03\u7528\u5230\u771f\u6b63\u7684\u5b9e\u73b0\u51fd\u6570ggml_new_tensor_impl\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-23-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-23-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-23-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-23-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-23-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-23-6\">6</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-23-1\" name=\"__codelineno-23-1\"></a><span class=\"c1\">// create tensors</span>\n<a id=\"__codelineno-23-2\" name=\"__codelineno-23-2\"></a><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_new_tensor_2d</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_TYPE_F32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cols_A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rows_A</span><span class=\"p\">);</span>\n<a id=\"__codelineno-23-3\" name=\"__codelineno-23-3\"></a><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_new_tensor_2d</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_TYPE_F32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cols_B</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rows_B</span><span class=\"p\">);</span>\n<a id=\"__codelineno-23-4\" name=\"__codelineno-23-4\"></a>\n<a id=\"__codelineno-23-5\" name=\"__codelineno-23-5\"></a><span class=\"n\">memcpy</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"o\">-&gt;</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ggml_nbytes</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"p\">));</span>\n<a id=\"__codelineno-23-6\" name=\"__codelineno-23-6\"></a><span class=\"n\">memcpy</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"o\">-&gt;</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ggml_nbytes</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">));</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5173\u4e8eview_src\u7684\u5185\u5bb9\u53ef\u4ee5\u8df3\u8fc7\uff0c\u4e3b\u8981\u7528\u4e8e\u5904\u7406\u5f20\u91cf\u89c6\u56fe\uff0c\u73b0\u5728\u53ef\u4ee5\u4e0d\u7528\u5173\u5fc3\u3002</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-new-tensor-impl.png\" /></p>\n<p>\u9996\u5148\uff0c\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\uff1aGGML\u7684\u5f20\u91cf\u7ef4\u5ea6\u662f\u5982\u4f55\u8868\u793a\u7684\uff1f</p>\n<p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u548cpytorch\u7684\u5f20\u91cf\u8868\u793a\u8fdb\u884c\u5bf9\u6bd4\uff0c\u56e0\u4e3a\u4f60\u53ef\u4ee5\u53d1\u73b0\uff0c\u5b83\u4eec\u7684\u8868\u793a\u65b9\u5f0f\u6b63\u597d\u76f8\u53cd\u3002</p>\n<p>ggml\u91c7\u7528\u4e00\u4e2a\u56db\u7ef4\u6570\u7ec4\u8868\u793ashape\u4fe1\u606f\u3002\u5728pytorch\u4e2d\u4e00\u4e2a[batch, channels, height, width]\u7684\u5f20\u91cf\uff0cggml\u4e2d\u8868\u793a\u4e3a[width, height, channels, batch]\u3002</p>\n<p>pytorch\u4ece\u6700\u5916\u5c42\u5230\u6700\u5185\u5c42\u7684\u6570\u636e\uff0c\u662f\u4ece\u5de6\u5230\u53f3\u8868\u793a\u7684\u3002\u8fd9\u91cc\u6700\u5185\u5c42\uff0c\u8868\u793a\u5728\u5185\u5b58\u5b58\u50a8\u4e0a\u8fde\u7eed\u7684\u7ef4\u5ea6\u3002</p>\n<p>\u6bd4\u5982row\u4f18\u5148\u5b58\u50a8\uff0c\u4e00\u4e2a3 * 4\u7684\u77e9\u9635\uff083\u884c\uff0c4\u5217\uff09\uff0c\u90a3\u6700\u5185\u5c42\u7ef4\u5ea6\u5c31\u662f\u5217\uff0c\u4e5f\u5c31\u662f4\u5217\u3002pytorch\u8868\u793a\u4e3a[3, 4]\uff0cggml\u8868\u793a\u4e3a[4, 3]\u3002</p>\n<p><img alt=\"picture from https://en.wikipedia.org/wiki/Row-_and_column-major_order\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/row-colomn-matrix.png\" /></p>\n<p>\u4e0a\u9762\u8ba1\u7b97\u51fa\u7684data_size\uff0c\u5148\u8ba1\u7b97\u5355\u884c\u7684size\uff0c\u7136\u540e\u4e58\u4ee5\u884c\u6570\uff0c\u5f97\u5230\u77e9\u9635\u7684size\u3002\u8fd9\u91cc\u7684type\u662ffloat32\u7c7b\u578b\uff0c\u5982\u679c\u662f\u91cf\u5316\u7c7b\u578b\uff0csize\u5c31\u4f1a\u4e0d\u540c\uff0c\u540e\u9762\u7528\u5230\u5728\u8ba8\u8bba\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-24-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-24-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-24-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-24-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-24-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-24-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-24-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-24-8\">8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-24-9\">9</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-24-1\" name=\"__codelineno-24-1\"></a><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">obj_alloc_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-24-2\" name=\"__codelineno-24-2\"></a>\n<a id=\"__codelineno-24-3\" name=\"__codelineno-24-3\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">view_src</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"n\">ctx</span><span class=\"o\">-&gt;</span><span class=\"n\">no_alloc</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-24-4\" name=\"__codelineno-24-4\"></a><span class=\"w\">    </span><span class=\"c1\">// allocate tensor data in the context&#39;s memory pool</span>\n<a id=\"__codelineno-24-5\" name=\"__codelineno-24-5\"></a><span class=\"w\">    </span><span class=\"n\">obj_alloc_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_size</span><span class=\"p\">;</span>\n<a id=\"__codelineno-24-6\" name=\"__codelineno-24-6\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-24-7\" name=\"__codelineno-24-7\"></a>\n<a id=\"__codelineno-24-8\" name=\"__codelineno-24-8\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">obj_new</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_new_object</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_OBJECT_TYPE_TENSOR</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_TENSOR_SIZE</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">obj_alloc_size</span><span class=\"p\">);</span>\n<a id=\"__codelineno-24-9\" name=\"__codelineno-24-9\"></a><span class=\"n\">GGML_ASSERT</span><span class=\"p\">(</span><span class=\"n\">obj_new</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5982\u679cview_src\u4e3a\u7a7a\uff0c\u4e14no_alloc\u4e3afalse\uff0c\u5219\u8c03\u7528ggml_new_object\u51fd\u6570\uff0c\u5206\u914d\u4e00\u4e2astruct ggml_object *\uff0c\u5e76\u521d\u59cb\u5316\u3002\u5206\u914d\u7684size\u5c31\u662ftensor\u7684size\uff0c\u8fd9\u91cc\u5c31\u662fdata_size\u3002</p>\n<p>!!! [warning]\n    view_src\u8868\u793a\u8be5obj\u662f\u5176\u5b83\u5185\u5b58\u7684\u89c6\u56fe\uff0c\u4e0d\u9700\u8981\u5206\u914d\u5185\u5b58\uff0c\u76f4\u63a5\u590d\u7528\u5185\u5b58\u3002</p>\n<p>\u5206\u914d\u7684ggml_object\u7ed3\u6784\u4f53\u6709\u4ec0\u4e48\u7528\u5462\uff1f</p>\n<h4 id=\"\u7406\u89e3ggml_new_object\">\u7406\u89e3ggml_new_object<a class=\"headerlink\" href=\"#\u7406\u89e3ggml_new_object\" title=\"Permanent link\">&para;</a></h4>\n<p>\u76f4\u63a5\u770b\u4ee3\u7801\uff0c\u53ef\u80fd\u6709\u70b9\u56f0\u96be\uff0c\u6211\u4eec\u5bf9\u5173\u952e\u70b9\u8fdb\u884c\u603b\u7ed3\u3002</p>\n<ul>\n<li>\n<p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u9996\u5148\u8ba1\u7b97\u4e86context\u7684size\uff0c\u636e\u6b64\u5206\u914d\u4e86ggml_context\u3002\u63a5\u4e0b\u6765\u7684\u5185\u5b58\u5206\u914d\uff0c\u5305\u62ecobj\u7684\u5206\u914d\uff0c\u90fd\u662f\u5728context\u7684memory pool\u4e2d\u5b8c\u6210\u3002</p>\n</li>\n<li>\n<p>ggml_object\u7684\u5b9a\u4e49\u53ef\u4ee5\u770b\u51fa\uff0c\u6709\u4e00\u4e2anext\u6307\u9488\u6307\u5411\u4e0b\u4e00\u4e2aggml_object\u3002\u56e0\u6b64\u5b83\u662f\u901a\u8fc7\u94fe\u8868\u6765\u7ba1\u7406\u5185\u5b58\u7684\uff0c\u6bcf\u4e2aggml_object\u5bf9\u8c61\u90fd\u662f\u4e00\u4e2a\u94fe\u8868\u8282\u70b9\u3002</p>\n</li>\n<li>\n<p>\u521d\u59cb\u72b6\u6001\u4e0b\uff0cggml_object\u7684objects_begin\u548cobjects_end\u90fd\u4e3aNULL\uff0c\u8868\u793a\u8fd9\u4e2a\u94fe\u8868\u4e3a\u7a7a\u3002</p>\n</li>\n<li>\n<p>ggml_object\u7684\u7528\u9014\u662f\u4ec0\u4e48\u5462\uff1fggml\u901a\u8fc7\u5b83\u6765\u9690\u5f0f\u7684\u7ba1\u7406\u5404\u79cd\u8d44\u6e90&ndash;\u5305\u62ectensor\u5f20\u91cf\u3001\u8ba1\u7b97\u56fe\u3001work buffer\u7b49\u3002\u94fe\u63a5\u5177\u6709O(n)\u7684\u67e5\u627e\u65f6\u95f4\u590d\u6742\u5ea6\u3002</p>\n</li>\n</ul>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-new-obj.png\" /></p>\n<p>\u5206\u914d\u4e00\u4e2aggml_object\u5bf9\u8c61\uff0c\u9700\u8981\u591a\u5927\u7684\u5185\u5b58\u5462\uff1f</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-25-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-25-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-25-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-25-1\" name=\"__codelineno-25-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">obj_new</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_new_object</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_OBJECT_TYPE_TENSOR</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_TENSOR_SIZE</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">obj_alloc_size</span><span class=\"p\">);</span>\n<a id=\"__codelineno-25-2\" name=\"__codelineno-25-2\"></a>\n<a id=\"__codelineno-25-3\" name=\"__codelineno-25-3\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">GGML_TENSOR_SIZE</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div>\n<p>\u4ee5\u8fd9\u91ccggml_object\u5206\u914d\u7684\u662ftensor\u7c7b\u578b\u4e3a\u4f8b\u5b50\uff1a\n\u5305\u62ec\u4e86 struct ggml_object\u7684size + struct ggml_tensor\u7684size + obj_alloc_size\uff08\u4e5f\u5c31\u662ftensor\u7684data\u5185\u5b58\u5927\u5c0f\uff09\u3002\u5f53\u7136ggml_tensor struc\u7684size\u548cobj_alloc_size\u8fd8\u9700\u8981\u8fdb\u884c\u5185\u5b58\u5bf9\u9f50\u3002</p>\n<p>\u5230\u6b64\uff0c\u6211\u4eec\u7684ggml_context\u5185\u5b58\u5e03\u5c40\uff08\u6ca1\u6709\u5206\u914d\u65b0\u7684\u5185\u5b58\uff0c\u6240\u6709\u7684\u5185\u5b58\u90fd\u662f\u5206\u914dctx\u65f6\u5206\u914d\uff09\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph2.png\" /></p>\n<h4 id=\"ggml_tensor\u5982\u4f55\u5b9a\u4e49\">ggml_tensor\u5982\u4f55\u5b9a\u4e49<a class=\"headerlink\" href=\"#ggml_tensor\u5982\u4f55\u5b9a\u4e49\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4e0a\u8282\uff0c\u6211\u4eec\u7684\u7b2c\u4e00\u4e2atensor\uff0c\u4ee5\u53ca\u901a\u8fc7ggml_object\u8fdb\u884c\u4e86\u8868\u793a\u7ba1\u7406\uff0c\u5e76\u4e3a\u5176\u5728ggml_context\u4e2d\u5206\u914d\u4e86\u5185\u5b58\uff0c\u90a3\u4e48ggml_tensor\u7ed3\u6784\u4f53\u7684\u5b9a\u4e49\u5462\uff1f</p>\n<p>\u6211\u4eec\u7ee7\u7eed\u770bggml_new_tensor_impl\u51fd\u6570\u4e2d\u7684\u4e0b\u534a\u90e8\u5206\u5185\u5bb9\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-26-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-26-32\">32</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-26-1\" name=\"__codelineno-26-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)((</span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">ctx</span><span class=\"o\">-&gt;</span><span class=\"n\">mem_buffer</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">obj_new</span><span class=\"o\">-&gt;</span><span class=\"n\">offs</span><span class=\"p\">);</span>\n<a id=\"__codelineno-26-2\" name=\"__codelineno-26-2\"></a>\n<a id=\"__codelineno-26-3\" name=\"__codelineno-26-3\"></a><span class=\"o\">*</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-26-4\" name=\"__codelineno-26-4\"></a><span class=\"w\">    </span><span class=\"cm\">/*.type         =*/</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"p\">,</span>\n<a id=\"__codelineno-26-5\" name=\"__codelineno-26-5\"></a><span class=\"w\">    </span><span class=\"cm\">/*.buffer       =*/</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">,</span>\n<a id=\"__codelineno-26-6\" name=\"__codelineno-26-6\"></a><span class=\"w\">    </span><span class=\"cm\">/*.ne           =*/</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">},</span>\n<a id=\"__codelineno-26-7\" name=\"__codelineno-26-7\"></a><span class=\"w\">    </span><span class=\"cm\">/*.nb           =*/</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">},</span>\n<a id=\"__codelineno-26-8\" name=\"__codelineno-26-8\"></a><span class=\"w\">    </span><span class=\"cm\">/*.op           =*/</span><span class=\"w\"> </span><span class=\"n\">GGML_OP_NONE</span><span class=\"p\">,</span>\n<a id=\"__codelineno-26-9\" name=\"__codelineno-26-9\"></a><span class=\"w\">    </span><span class=\"cm\">/*.op_params    =*/</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">},</span>\n<a id=\"__codelineno-26-10\" name=\"__codelineno-26-10\"></a><span class=\"w\">    </span><span class=\"cm\">/*.flags        =*/</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span>\n<a id=\"__codelineno-26-11\" name=\"__codelineno-26-11\"></a><span class=\"w\">    </span><span class=\"cm\">/*.src          =*/</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"w\"> </span><span class=\"p\">},</span>\n<a id=\"__codelineno-26-12\" name=\"__codelineno-26-12\"></a><span class=\"w\">    </span><span class=\"cm\">/*.view_src     =*/</span><span class=\"w\"> </span><span class=\"n\">view_src</span><span class=\"p\">,</span>\n<a id=\"__codelineno-26-13\" name=\"__codelineno-26-13\"></a><span class=\"w\">    </span><span class=\"cm\">/*.view_offs    =*/</span><span class=\"w\"> </span><span class=\"n\">view_offs</span><span class=\"p\">,</span>\n<a id=\"__codelineno-26-14\" name=\"__codelineno-26-14\"></a><span class=\"w\">    </span><span class=\"cm\">/*.data         =*/</span><span class=\"w\"> </span><span class=\"n\">obj_alloc_size</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">,</span>\n<a id=\"__codelineno-26-15\" name=\"__codelineno-26-15\"></a><span class=\"w\">    </span><span class=\"cm\">/*.name         =*/</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">},</span>\n<a id=\"__codelineno-26-16\" name=\"__codelineno-26-16\"></a><span class=\"w\">    </span><span class=\"cm\">/*.extra        =*/</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">,</span>\n<a id=\"__codelineno-26-17\" name=\"__codelineno-26-17\"></a><span class=\"w\">    </span><span class=\"cm\">/*.padding      =*/</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">},</span>\n<a id=\"__codelineno-26-18\" name=\"__codelineno-26-18\"></a><span class=\"p\">};</span>\n<a id=\"__codelineno-26-19\" name=\"__codelineno-26-19\"></a>\n<a id=\"__codelineno-26-20\" name=\"__codelineno-26-20\"></a><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n_dims</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-26-21\" name=\"__codelineno-26-21\"></a><span class=\"w\">    </span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">ne</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">];</span>\n<a id=\"__codelineno-26-22\" name=\"__codelineno-26-22\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-26-23\" name=\"__codelineno-26-23\"></a>\n<a id=\"__codelineno-26-24\" name=\"__codelineno-26-24\"></a><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_type_size</span><span class=\"p\">(</span><span class=\"n\">type</span><span class=\"p\">);</span>\n<a id=\"__codelineno-26-25\" name=\"__codelineno-26-25\"></a><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">ne</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">/</span><span class=\"n\">ggml_blck_size</span><span class=\"p\">(</span><span class=\"n\">type</span><span class=\"p\">));</span>\n<a id=\"__codelineno-26-26\" name=\"__codelineno-26-26\"></a><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">GGML_MAX_DIMS</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-26-27\" name=\"__codelineno-26-27\"></a><span class=\"w\">    </span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">*</span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">ne</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">];</span>\n<a id=\"__codelineno-26-28\" name=\"__codelineno-26-28\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-26-29\" name=\"__codelineno-26-29\"></a>\n<a id=\"__codelineno-26-30\" name=\"__codelineno-26-30\"></a><span class=\"n\">ctx</span><span class=\"o\">-&gt;</span><span class=\"n\">n_objects</span><span class=\"o\">++</span><span class=\"p\">;</span>\n<a id=\"__codelineno-26-31\" name=\"__codelineno-26-31\"></a>\n<a id=\"__codelineno-26-32\" name=\"__codelineno-26-32\"></a><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">;</span>\n</code></pre></div></td></tr></table></div>\n<p>result\u6307\u9488\u6307\u5411\u4e86ctx-&gt;mem_buffer + obj_new-&gt;offs\uff0c\u4e5f\u5c31\u662fggml_tensor\u7ed3\u6784\u4f53\u5bf9\u8c61\u6240\u5206\u914d\u7684\u5185\u5b58\u3002</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph3.png\" /></p>\n<p>ggml_tensor\u7ed3\u6784\u4f53\u7684\u5173\u952e\u5b57\u6bb5\u5982\u4e0b\uff1a</p>\n<ul>\n<li>\n<p>data\uff1a\u6307\u5411tensor\u5f20\u91cf\u6570\u636e\u5b58\u50a8\u8d77\u59cb\u5730\u5740\uff0c\u8fd9\u91cc\u5c31\u662fggml_tensor\u7ed3\u6784\u4f53\u81ea\u8eab\u4e4b\u540e\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u3002</p>\n</li>\n<li>\n<p>ne\uff1a\u4e00\u4e2a\u5927\u5c0f\u4e3a4\u7684\u6570\u7ec4\uff0c\u8868\u793a\u6bcf\u4e2a\u7ef4\u5ea6\u7684\u5143\u7d20\u6570\u91cf\uff0c\u8fd9\u91cc\u662f[2, 4, 1, 1]\u3002</p>\n</li>\n<li>\n<p>nb\uff1a\u4e00\u4e2a\u5927\u5c0f\u4e3a4\u7684\u6570\u7ec4\uff0c\u8868\u793a\u6bcf\u4e2a\u7ef4\u5ea6\u7684\u5143\u7d20\u5b57\u8282\u6570\uff0c\u8fd9\u91cc\u662f[4, 8, 32, 32]\u3002</p>\n</li>\n</ul>\n<p>\u5982\u679c\u4e0d\u8003\u8651\u91cf\u5316\uff0c\u8ba1\u7b97\u65b9\u5f0f\u5982\u4e0b:</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-27-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-27-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-27-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-27-4\">4</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-27-1\" name=\"__codelineno-27-1\"></a><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">float</span><span class=\"p\">);</span>\n<a id=\"__codelineno-27-2\" name=\"__codelineno-27-2\"></a><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">];</span>\n<a id=\"__codelineno-27-3\" name=\"__codelineno-27-3\"></a><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n<a id=\"__codelineno-27-4\" name=\"__codelineno-27-4\"></a><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">];</span>\n</code></pre></div></td></tr></table></div>\n<p>\u901a\u8fc7\u4e0a\u9762\u7684\u5185\u5bb9\u6211\u4eec\u4ee5\u53ca\u4e86\u89e3\u4e86ggml_new_tensor_2d\u7684\u5de5\u4f5c\u539f\u7406\u3002\u5728simple-ctx\u4f8b\u5b50\u4e2d\uff0c\u4f1a\u8c03\u7528\u4e24\u6b21\u4ee5\u5206\u914d\u4e24\u4e2atensor\u5f20\u91cf\uff0c\u4e00\u6b21\u4e3ax\uff0c\u4e00\u6b21\u4e3ay\uff0c\u5206\u914d\u540e\u7684\u5185\u5b58\u5e03\u5c40\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph4.png\" /></p>\n<p>\u7136\u540e\u901a\u8fc7memcpy\u5c06\u6570\u636e\u590d\u5236\u5230ggml_tensor\u7684data\u5b57\u6bb5\u4e2d\u3002</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph5.png\" /></p>\n<p>\u8fd9\u91cc\u7684\u5f20\u91cf\u6570\u636e\u76f4\u63a5\u786c\u7f16\u7801\u5b9a\u4e49\u5230\u4e86\u6e90\u4ee3\u7801\u4e2d\uff0c\u56e0\u6b64\u4e0d\u9700\u8981\u52a0\u8f7dGGU\u6587\u4ef6\uff0c\u518d\u66f4\u590d\u6742\u7684\u4f8b\u5b50\u4e2d\u4f1a\u901a\u8fc7GGU\u6587\u4ef6\u52a0\u8f7d\u6570\u636e\u3002</p>\n<h3 id=\"\u8981\u70b9\">\u8981\u70b9<a class=\"headerlink\" href=\"#\u8981\u70b9\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li>\n<p>ggml \u901a\u8fc7ggml_context\u6765\u5904\u7406\u5185\u5b58\u5206\u914d</p>\n</li>\n<li>\n<p>ggml_context\u4e2d\u901a\u8fc7\u94fe\u8868\u6765\u7ba1\u7406\u5185\u5b58\uff0c\u6bcf\u4e2a\u8282\u70b9\u90fd\u662fggml_object\u7ed3\u6784\u4f53\uff0c\u9690\u5f0f\u7ba1\u7406tensor\u5f20\u91cf\u3001\u8ba1\u7b97\u56fe\u3001work buffer\u7b49\u8d44\u6e90\u3002</p>\n</li>\n<li>\n<p>ggml_tensor\u7684\u7ef4\u5ea6\u8868\u793a\u548cpytorch\u662f\u76f8\u53cd\u7684\uff0c\u8fd9\u4e2a\u9700\u8981\u6ce8\u610f\u3002</p>\n</li>\n</ul>\n<h2 id=\"\u63a2\u7d22ggml\u7684\u5b9e\u73b0ggml\u8ba1\u7b97\u56fe\u6784\u5efa\">\u63a2\u7d22ggml\u7684\u5b9e\u73b0&ndash;GGML\u8ba1\u7b97\u56fe\u6784\u5efa<a class=\"headerlink\" href=\"#\u63a2\u7d22ggml\u7684\u5b9e\u73b0ggml\u8ba1\u7b97\u56fe\u6784\u5efa\" title=\"Permanent link\">&para;</a></h2>\n<p>\u672c\u5c0f\u8282\u4ecb\u7ecdGGML\u5982\u4f55\u6784\u5efa\u548c\u7ba1\u7406\u8ba1\u7b97\u56fe\u76f8\u5173\u7684\u6570\u636e\u7ed3\u6784\u3002</p>\n<h3 id=\"\u5728ggml_context\u4e2d\u521b\u5efa\u8ba1\u7b97\u56fe\">\u5728ggml_context\u4e2d\u521b\u5efa\u8ba1\u7b97\u56fe<a class=\"headerlink\" href=\"#\u5728ggml_context\u4e2d\u521b\u5efa\u8ba1\u7b97\u56fe\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0a\u4e00\u8282\uff0c\u5b8c\u6210\u4e86ggml_context\u7684\u521b\u5efa\uff0c\u5e76\u4e14\u5b8c\u6210\u4e86\u77e9\u9635\u8ba1\u7b97\u6240\u9700\u7684ggml_tensor\u5f20\u91cf\u7684\u521b\u5efa\u3002(load_model\u51fd\u6570\u4e2d\u5b9e\u73b0\u7684\u529f\u80fd)</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-28-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-28-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-28-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-28-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-28-5\">5</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-28-1\" name=\"__codelineno-28-1\"></a><span class=\"n\">simple_model</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">;</span>\n<a id=\"__codelineno-28-2\" name=\"__codelineno-28-2\"></a><span class=\"n\">load_model</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">matrix_A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">matrix_B</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rows_A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cols_A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rows_B</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cols_B</span><span class=\"p\">);</span>\n<a id=\"__codelineno-28-3\" name=\"__codelineno-28-3\"></a>\n<a id=\"__codelineno-28-4\" name=\"__codelineno-28-4\"></a><span class=\"c1\">// perform computation in cpu</span>\n<a id=\"__codelineno-28-5\" name=\"__codelineno-28-5\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">compute</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div>\n<p>\u63a5\u4e0b\u6765\u91cd\u70b9\u7814\u7a76\u7684\u5c31\u662fcompute\u51fd\u6570\uff0c\u5206\u4e3a\u6784\u5efa\u8ba1\u7b97\u56fe\u3001\u6267\u884c\u56fe\u8ba1\u7b97\u3001\u83b7\u53d6\u7ed3\u679c\uff08\u83b7\u53d6\u6700\u540e\u4e00\u4e2a\u8ba1\u7b97\u8282\u70b9\u7684\u8f93\u51fa\u7ed3\u679c\uff09\u4e09\u4e2a\u6b65\u9aa4\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-29-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-29-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-29-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-29-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-29-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-29-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-29-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-29-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-29-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-29-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-29-11\">11</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-29-1\" name=\"__codelineno-29-1\"></a><span class=\"c1\">// compute with backend</span>\n<a id=\"__codelineno-29-2\" name=\"__codelineno-29-2\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">compute</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">simple_model</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-29-3\" name=\"__codelineno-29-3\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_cgraph</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">gf</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">build_graph</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">);</span>\n<a id=\"__codelineno-29-4\" name=\"__codelineno-29-4\"></a>\n<a id=\"__codelineno-29-5\" name=\"__codelineno-29-5\"></a><span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">n_threads</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// number of threads to perform some operations with multi-threading</span>\n<a id=\"__codelineno-29-6\" name=\"__codelineno-29-6\"></a>\n<a id=\"__codelineno-29-7\" name=\"__codelineno-29-7\"></a><span class=\"w\">    </span><span class=\"n\">ggml_graph_compute_with_ctx</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">gf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">n_threads</span><span class=\"p\">);</span>\n<a id=\"__codelineno-29-8\" name=\"__codelineno-29-8\"></a>\n<a id=\"__codelineno-29-9\" name=\"__codelineno-29-9\"></a><span class=\"w\">    </span><span class=\"c1\">// in this case, the output tensor is the last one in the graph</span>\n<a id=\"__codelineno-29-10\" name=\"__codelineno-29-10\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">ggml_graph_node</span><span class=\"p\">(</span><span class=\"n\">gf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"p\">);</span>\n<a id=\"__codelineno-29-11\" name=\"__codelineno-29-11\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5728build_graph\u51fd\u6570\u4e2d\uff0c\u9996\u5148\u4f1a\u8c03\u7528<strong>ggml_new_graph</strong>\uff0c\u8fd9\u4e2a\u51fd\u6570\u53ef\u4ee5\u548c\u524d\u4e00\u8282\u4e2dggml_new_tensor\u51fd\u6570\u4e00\u6837\u7684\u65b9\u5f0f\u7406\u89e3\u3002\u5b83\u4e5f\u662f\u521b\u5efa\u4e86ggml_object\u5bf9\u8c61\uff0c\u4f46\u662f\u4e0d\u540c\u7684\u662f\uff0c<strong>\u8fd9\u4e2aobject\u7ba1\u7406\u7684\u662f\u8ba1\u7b97\u56fe\uff08ggml_cgraph\u7ed3\u6784\u4f53\u5bf9\u8c61\uff09</strong>\uff0c\u800c\u4e0d\u662ftensor\u5f20\u91cf\u3002</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-new-graph-custom.png\" /></p>\n<ul>\n<li>\n<p>\u901a\u8fc7ggml_graph_nbytes\u51fd\u6570\u83b7\u53d6\u8ba1\u7b97\u56fe\u9700\u8981\u5360\u7528\u7684\u5185\u5b58\u5927\u5c0f</p>\n</li>\n<li>\n<p>ggml_new_object\u6839\u636e\u8ba1\u7b97\u56fe\u5927\u5c0f\u5728ggml_context\u5185\u5b58\u533a\u57df\u4e2d\u5206\u914d\u4e00\u5757\u5185\u5b58\uff0c\u521b\u5efaggml_object\u5bf9\u8c61</p>\n</li>\n<li>\n<p>\u901a\u8fc7offs\u504f\u79fb\u83b7\u53d6ggml_object\u4e2d\u7ba1\u7406\u7684ggml_cgraph\u7ed3\u6784\u4f53\u5bf9\u8c61\u6307\u9488\uff0c\u5b8c\u6210\u8ba1\u7b97\u56fe\u7684\u6784\u5efa</p>\n</li>\n</ul>\n<p>\u73b0\u5728\u6211\u4eec\u518d\u5bf9\u7ec6\u8282\u8fdb\u884c\u5c55\u5f00\u4ecb\u7ecd\uff1a</p>\n<h4 id=\"ggml_gral_nbytes\u8ba1\u7b97\u7ec6\u8282\">ggml_gral_nbytes\u8ba1\u7b97\u7ec6\u8282<a class=\"headerlink\" href=\"#ggml_gral_nbytes\u8ba1\u7b97\u7ec6\u8282\" title=\"Permanent link\">&para;</a></h4>\n<p>GGML_DEFAULT_GRAPH_SIZE\u662f\u4e00\u4e2a\u5b8f\u5b9a\u4e49\uff0c\u9ed8\u8ba4\u503c\u4e3a2048\u3002\u5b9a\u4e49\u4e86\u5355\u4e2aggml_cgraph\u4e2d\u53ef\u5206\u914d\u7684\u6700\u5927\u8282\u70b9\u6811\u548cleaf\uff08\u53f6\u8282\u70b9\uff09\u5f20\u91cf\u6570\u3002\u7136\u540e\u4f7f\u7528ggml_hash_size\u51fd\u6570\u8ba1\u7b97hash\u8868\u9700\u8981\u7684\u5185\u5b58\u5927\u5c0f\uff0c\u4e58\u4ee52\u662f\u9700\u8981\u7ba1\u7406nodes\u548cleafs\u4e24\u79cd\u7c7b\u578b\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-30-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-30-23\">23</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-30-1\" name=\"__codelineno-30-1\"></a><span class=\"c1\">// \u8c03\u7528ggml_new_graph_custom\u4f20\u9012\u7684\u53c2\u6570</span>\n<a id=\"__codelineno-30-2\" name=\"__codelineno-30-2\"></a><span class=\"n\">ggml_new_graph_custom</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_DEFAULT_GRAPH_SIZE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n<a id=\"__codelineno-30-3\" name=\"__codelineno-30-3\"></a>\n<a id=\"__codelineno-30-4\" name=\"__codelineno-30-4\"></a><span class=\"cp\">#define GGML_DEFAULT_GRAPH_SIZE 2048</span>\n<a id=\"__codelineno-30-5\" name=\"__codelineno-30-5\"></a>\n<a id=\"__codelineno-30-6\" name=\"__codelineno-30-6\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"nf\">ggml_graph_nbytes</span><span class=\"p\">(</span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">grads</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-30-7\" name=\"__codelineno-30-7\"></a><span class=\"w\">    </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">hash_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_hash_size</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">);</span>\n<a id=\"__codelineno-30-8\" name=\"__codelineno-30-8\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-30-9\" name=\"__codelineno-30-9\"></a><span class=\"w\">    </span><span class=\"n\">incr_ptr_aligned</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_cgraph</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<a id=\"__codelineno-30-10\" name=\"__codelineno-30-10\"></a><span class=\"w\">    </span><span class=\"n\">incr_ptr_aligned</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">));</span><span class=\"w\"> </span><span class=\"c1\">// nodes</span>\n<a id=\"__codelineno-30-11\" name=\"__codelineno-30-11\"></a><span class=\"w\">    </span><span class=\"n\">incr_ptr_aligned</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">));</span><span class=\"w\"> </span><span class=\"c1\">// leafs</span>\n<a id=\"__codelineno-30-12\" name=\"__codelineno-30-12\"></a><span class=\"w\">    </span><span class=\"n\">incr_ptr_aligned</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">hash_size</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">int32_t</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">int32_t</span><span class=\"p\">));</span><span class=\"w\"> </span><span class=\"c1\">// use_counts</span>\n<a id=\"__codelineno-30-13\" name=\"__codelineno-30-13\"></a><span class=\"w\">    </span><span class=\"n\">incr_ptr_aligned</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">hash_size</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">));</span><span class=\"w\"> </span><span class=\"c1\">// hash keys</span>\n<a id=\"__codelineno-30-14\" name=\"__codelineno-30-14\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">grads</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-30-15\" name=\"__codelineno-30-15\"></a><span class=\"w\">        </span><span class=\"n\">incr_ptr_aligned</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">hash_size</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">));</span><span class=\"w\"> </span><span class=\"c1\">// grads</span>\n<a id=\"__codelineno-30-16\" name=\"__codelineno-30-16\"></a><span class=\"w\">        </span><span class=\"n\">incr_ptr_aligned</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">hash_size</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">));</span><span class=\"w\"> </span><span class=\"c1\">// grad_accs</span>\n<a id=\"__codelineno-30-17\" name=\"__codelineno-30-17\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-30-18\" name=\"__codelineno-30-18\"></a><span class=\"w\">    </span><span class=\"c1\">// \u8ba1\u7b97hash_size\u9700\u8981\u591a\u5c11\u4e2aggml_bitset_t\u8868\u793a\u72b6\u6001\uff0c\u8fd9\u4e9b\u591a\u4e2aggml_bitset_t\u6784\u6210\u4e86bit\u4f4d\u56fe</span>\n<a id=\"__codelineno-30-19\" name=\"__codelineno-30-19\"></a><span class=\"w\">    </span><span class=\"n\">incr_ptr_aligned</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ggml_bitset_size</span><span class=\"p\">(</span><span class=\"n\">hash_size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">ggml_bitset_t</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">ggml_bitset_t</span><span class=\"p\">));</span>\n<a id=\"__codelineno-30-20\" name=\"__codelineno-30-20\"></a>\n<a id=\"__codelineno-30-21\" name=\"__codelineno-30-21\"></a><span class=\"w\">    </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">nbytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">size_t</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n<a id=\"__codelineno-30-22\" name=\"__codelineno-30-22\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">nbytes</span><span class=\"p\">;</span>\n<a id=\"__codelineno-30-23\" name=\"__codelineno-30-23\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>ggml_hash_size\u4ece\u5176\u5b9e\u73b0\u6765\u770b\uff0c\u901a\u8fc7\u4e8c\u5206\u67e5\u627e\u627e\u5230\u5927\u4e8e\u6216\u7b49\u4e8e2 * GGML_DEFAULT_GRAPH_SIZE\u7684\u6700\u5c0f\u8d28\u6570\uff0c\u8fd9\u4e2a\u8d28\u6570\u51b3\u5b9a\u4e86\u8ba1\u7b97\u56fe\u54c8\u5e0c\u8868\u7684\u5927\u5c0f\u3002\u9009\u62e9\u8d28\u6570\u4e3b\u8981\u662f\u51fa\u4e8e\u6027\u80fd\u8003\u8651\uff1aGGML\u91c7\u7528\u4e86\u4e00\u79cd\u7b80\u5355\u7684\u5f00\u653e\u5730\u5740\u54c8\u5e0c\u51fd\u6570\uff0c\u5e76\u4f7f\u7528\u7ebf\u6027\u63a2\u6d4b\u6cd5\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-31-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-31-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-31-1\" name=\"__codelineno-31-1\"></a><span class=\"c1\">// the last 4 bits are always zero due to alignment</span>\n<a id=\"__codelineno-31-2\" name=\"__codelineno-31-2\"></a><span class=\"n\">Key</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ggml_tensor_pointer_value</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"n\">table_size</span>\n</code></pre></div></td></tr></table></div>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>\u4f7f\u7528\u8d28\u6570\u8868\u5927\u5c0f\u6709\u52a9\u4e8e\u66f4\u5747\u5300\u5730\u5206\u5e03\u952e\uff0c\u51cf\u5c11\u805a\u96c6\u3001\u63d0\u9ad8\u67e5\u627e\u6548\u7387\u3002</p>\n</blockquote>\n</blockquote>\n</blockquote>\n<p>ggml_graph\u7684\u5185\u5b58\u5e03\u5c40\uff1a</p>\n<ul>\n<li>\n<p>ggml_cgraph\u7ed3\u6784\u4f53\u5bf9\u8c61\u5360\u7528\u7a7a\u95f4\uff1asizeof(struct ggml_cgraph)</p>\n</li>\n<li>\n<p>2048\u4e2atensor\u5f20\u91cf\u6307\u9488\uff0c\u6307\u5411nodes</p>\n</li>\n<li>\n<p>2048\u4e2atensor\u5f20\u91cf\u6307\u9488\uff0c\u6307\u5411leafs</p>\n</li>\n<li>\n<p>hash_size\u4e2aint32_t\uff0c\u7528\u4e8e\u8bb0\u5f55\u5f20\u91cf\u7684\u4f7f\u7528\u6b21\u6570</p>\n</li>\n<li>\n<p>hash_size\u4e2atensor\u5f20\u91cf\u6307\u9488\uff0c\u7528\u4e8e\u5b58\u50a8\u5f20\u91cf\u7684\u54c8\u5e0c\u952e</p>\n</li>\n<li>\n<p>\u68af\u5ea6\u76f8\u5173\uff0csimple_ctx\u4f8b\u5b50\u4e0d\u6d89\u53ca</p>\n</li>\n<li>\n<p>\u54c8\u5e0c\u8868bit\u4f4d\u56fe\uff0c\u7528\u4e8e\u8bb0\u5f55\u5f20\u91cf\u7684\u4f7f\u7528\u60c5\u51b5</p>\n</li>\n</ul>\n<p>\u5173\u4e8ebit\u4f4d\u56fe\uff0c</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-32-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-32-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-32-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-32-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-32-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-32-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-32-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-32-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-32-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-32-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-32-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-32-12\">12</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-32-1\" name=\"__codelineno-32-1\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">ggml_bitset_t</span><span class=\"p\">;</span>\n<a id=\"__codelineno-32-2\" name=\"__codelineno-32-2\"></a>\n<a id=\"__codelineno-32-3\" name=\"__codelineno-32-3\"></a><span class=\"k\">static_assert</span><span class=\"p\">(</span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">ggml_bitset_t</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;bitset_t constants must be updated&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-32-4\" name=\"__codelineno-32-4\"></a><span class=\"cp\">#define BITSET_SHR 5 </span><span class=\"c1\">// log2(sizeof(ggml_bitset_t)*8)</span>\n<a id=\"__codelineno-32-5\" name=\"__codelineno-32-5\"></a><span class=\"cp\">#define BITSET_MASK (sizeof(ggml_bitset_t)*8 - 1)</span>\n<a id=\"__codelineno-32-6\" name=\"__codelineno-32-6\"></a>\n<a id=\"__codelineno-32-7\" name=\"__codelineno-32-7\"></a>\n<a id=\"__codelineno-32-8\" name=\"__codelineno-32-8\"></a><span class=\"c1\">// &gt;&gt; BITSET_SHR\u76f8\u5f53\u4e8e\u9664\u4ee532\uff0c\u8868\u793a\u6570\u5b57n\u7684bit\u8bb0\u5f55\u4f4d\u4e8e\u7b2c\u51e0\u4e2aggml_bitset_t\u4e2d</span>\n<a id=\"__codelineno-32-9\" name=\"__codelineno-32-9\"></a><span class=\"c1\">// \u4e00\u4e2aggml_bitset_t\u53ef\u4ee5\u8868\u793a32\u4e2a\u6570\u7684\u72b6\u6001\uff0c\u5728\u672c\u6587\u4e0a\u4e0b\u6587\u4e2d\u5373\u8868\u793a\u4e00\u4e2ahash\u4f4d\u7f6e</span>\n<a id=\"__codelineno-32-10\" name=\"__codelineno-32-10\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"nf\">ggml_bitset_size</span><span class=\"p\">(</span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-32-11\" name=\"__codelineno-32-11\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">BITSET_MASK</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">BITSET_SHR</span><span class=\"p\">;</span>\n<a id=\"__codelineno-32-12\" name=\"__codelineno-32-12\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u6839\u636eggml_graph_nbytes\u51fd\u6570\u8ba1\u7b97\u51fa\u6765\u7684\u5185\u5b58\u5927\u5c0f\uff0c\u5728ctx\u4e2d\u5206\u914d\u5185\u5b58\uff0c\u5206\u914d\u540e\u7684\u5185\u5b58\u5e03\u5c40\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_graph_graph1.png\" /></p>\n<p>\u5305\u62ec\u8ba1\u7b97\u56fe\u5bf9\u8c61\u3001\u8282\u70b9\u6307\u9488\u3001\u53f6\u5b50\u6307\u9488\u3001\u4f7f\u7528\u6b21\u6570\u3001\u54c8\u5e0c\u952e\u3001\u68af\u5ea6\u3001\u54c8\u5e0c\u8868bit\u4f4d\u56fe\u3002\u63a5\u4e0b\u6765\u7684\u51e0\u884c\u4ee3\u7801\u521d\u59cb\u5316\u6307\u5411\u5df2\u5206\u914d\u5185\u5b58\u4e2d\u4e0d\u540c\u533a\u57df\u7684\u6307\u9488\uff0c\u5e76\u5c06\u5b83\u4eec\u5b58\u50a8\u5728ggml_cgraph\u7ed3\u6784\u4f53\u4e2d\u3002\u6700\u540e\uff0c\u54c8\u5e0c\u8868\u88ab\u91cd\u7f6e\uff0c\u6240\u6709\u69fd\u4f4d\u90fd\u88ab\u6807\u8bb0\u4e3a\u672a\u5360\u7528\u3002</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_graph_graph2.png\" /></p>\n<h3 id=\"\u6784\u5efa\u77e9\u9635\u4e58\u8ba1\u7b97\u56fe\">\u6784\u5efa\u77e9\u9635\u4e58\u8ba1\u7b97\u56fe<a class=\"headerlink\" href=\"#\u6784\u5efa\u77e9\u9635\u4e58\u8ba1\u7b97\u56fe\" title=\"Permanent link\">&para;</a></h3>\n<p>\u524d\u9762\u7684\u5185\u5bb9\u4ecb\u7ecd\u4e86\u5728ggml_context\u4e2d\u5206\u914d\u4e00\u4e2a\u8ba1\u7b97\u56fe\u5185\u5b58\uff0c\u5e76\u4e14\u521d\u59cb\u5316\u4e86\u76f8\u5173\u6210\u5458\u9ed8\u8ba4\u503c\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-33-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-33-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-33-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-33-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-33-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-33-6\">6</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-33-1\" name=\"__codelineno-33-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_cgraph</span><span class=\"w\">  </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">gf</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_new_graph</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">ctx</span><span class=\"p\">);</span>\n<a id=\"__codelineno-33-2\" name=\"__codelineno-33-2\"></a>\n<a id=\"__codelineno-33-3\" name=\"__codelineno-33-3\"></a><span class=\"c1\">// \u7528gf\u8868\u793a\u77e9\u9635\u4e58\u4efb\u52a1</span>\n<a id=\"__codelineno-33-4\" name=\"__codelineno-33-4\"></a><span class=\"c1\">// result = a*b^T</span>\n<a id=\"__codelineno-33-5\" name=\"__codelineno-33-5\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_mul_mat</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">);</span>\n<a id=\"__codelineno-33-6\" name=\"__codelineno-33-6\"></a><span class=\"n\">ggml_build_forward_expand</span><span class=\"p\">(</span><span class=\"n\">gf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div>\n<p>\u73b0\u5728\u8fd9\u4e2a\u8ba1\u7b97\u56fegf\u652f\u6301\u6dfb\u52a02048\u4e2a\u5f20\u91cf\u8282\u70b9\u548c\u53f6\u8282\u70b9\uff0c\u4f46\u662f\u8fd8\u6ca1\u6709\u5c06\u77e9\u9635\u4e58\u8fd9\u4e2a\u8ba1\u7b97\u7684\u8282\u70b9\u52a0\u5165\u8ba1\u7b97\u56fe\u3002\u63a5\u4e0b\u6765\u7684\u5185\u5bb9\u5c31\u662f\u4ecb\u7ecd\u5982\u4f55\u5c06\u77e9\u9635\u4e58\u4efb\u52a1\u4fe1\u606f\u7528\u8ba1\u7b97\u56fe\u8fdb\u884c\u8868\u793a\u3002</p>\n<p>\u5728ggml_mul_mat\u51fd\u6570\u4e2d\uff0c\u9996\u5148\u68c0\u67e5\u8f93\u5165\u5f20\u91cf\u7684\u5408\u6cd5\u6027\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u7ed3\u679c\u5f20\u91cf\uff0c\u5e76\u8bbe\u7f6e\u5f20\u91cf\u7684\u8fd0\u7b97\u7c7b\u578b\u4e3a\u77e9\u9635\u4e58\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-34-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-34-18\">18</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-34-1\" name=\"__codelineno-34-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ggml_mul_mat</span><span class=\"p\">(</span>\n<a id=\"__codelineno-34-2\" name=\"__codelineno-34-2\"></a><span class=\"w\">        </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_context</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"p\">,</span>\n<a id=\"__codelineno-34-3\" name=\"__codelineno-34-3\"></a><span class=\"w\">        </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\">  </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">,</span>\n<a id=\"__codelineno-34-4\" name=\"__codelineno-34-4\"></a><span class=\"w\">        </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\">  </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-34-5\" name=\"__codelineno-34-5\"></a><span class=\"w\">    </span><span class=\"n\">GGML_ASSERT</span><span class=\"p\">(</span><span class=\"n\">ggml_can_mul_mat</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">));</span>\n<a id=\"__codelineno-34-6\" name=\"__codelineno-34-6\"></a><span class=\"w\">    </span><span class=\"n\">GGML_ASSERT</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">ggml_is_transposed</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">));</span>\n<a id=\"__codelineno-34-7\" name=\"__codelineno-34-7\"></a>\n<a id=\"__codelineno-34-8\" name=\"__codelineno-34-8\"></a><span class=\"w\">    </span><span class=\"c1\">// \u8ba1\u7b97\u7ed3\u679c\u7684shape</span>\n<a id=\"__codelineno-34-9\" name=\"__codelineno-34-9\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">int64_t</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">-&gt;</span><span class=\"n\">ne</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">-&gt;</span><span class=\"n\">ne</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">-&gt;</span><span class=\"n\">ne</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">-&gt;</span><span class=\"n\">ne</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">};</span>\n<a id=\"__codelineno-34-10\" name=\"__codelineno-34-10\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_new_tensor</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_TYPE_F32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"p\">);</span>\n<a id=\"__codelineno-34-11\" name=\"__codelineno-34-11\"></a>\n<a id=\"__codelineno-34-12\" name=\"__codelineno-34-12\"></a><span class=\"w\">    </span><span class=\"c1\">// \u5c06\u52a0\u5165graph nodes\u4e2d\u7684\u4e00\u4e2anode\uff0c\u7c7b\u578b\u4f4d\u77e9\u9635\u4e58</span>\n<a id=\"__codelineno-34-13\" name=\"__codelineno-34-13\"></a><span class=\"w\">    </span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">op</span><span class=\"w\">     </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">GGML_OP_MUL_MAT</span><span class=\"p\">;</span>\n<a id=\"__codelineno-34-14\" name=\"__codelineno-34-14\"></a><span class=\"w\">    </span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">src</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">;</span>\n<a id=\"__codelineno-34-15\" name=\"__codelineno-34-15\"></a><span class=\"w\">    </span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">src</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">;</span>\n<a id=\"__codelineno-34-16\" name=\"__codelineno-34-16\"></a>\n<a id=\"__codelineno-34-17\" name=\"__codelineno-34-17\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">;</span>\n<a id=\"__codelineno-34-18\" name=\"__codelineno-34-18\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u73b0\u5728\uff0c\u5230\u4e86\u6211\u4eec\u6784\u5efa\u8ba1\u7b97\u56fe\u7684\u6700\u540e\u9636\u6bb5\u4e86\uff0c\u79d8\u5bc6\u5c31\u85cf\u5728ggml_build_forward_expand\u51fd\u6570\u4e2d\u3002</p>\n<p>\u51fd\u6570\u7684\u8f93\u5165\u53c2\u6570\u662f\u6211\u4eec\u521b\u5efa\u7684\u201c\u7a7a\u56fe\u201d\u548c\u77e9\u9635\u4e58\u4efb\u52a1\u6240\u8fd4\u56de\u7684\u77e9\u9635\u4e58\u7ed3\u679c\u8282\u70b9\uff08\u5728\u590d\u6742\u7684\u6848\u4f8b\u4e2d\uff0c\u5c31\u662f\u6a21\u578b\u7684\u8f93\u51fa\u8282\u70b9\u6216\u8005LLM\u4e2d\u7684logits\uff09\u3002</p>\n<h4 id=\"ggml_build_forward_expand-\u51fd\u6570\u7ec6\u8282\u63a2\u7d22\">ggml_build_forward_expand \u51fd\u6570\u7ec6\u8282\u63a2\u7d22<a class=\"headerlink\" href=\"#ggml_build_forward_expand-\u51fd\u6570\u7ec6\u8282\u63a2\u7d22\" title=\"Permanent link\">&para;</a></h4>\n<p>\u8be5\u51fd\u6570\u8c03\u7528\u5230\u4e86ggml_build_forward_impl\u51fd\u6570\uff0c\u6838\u5fc3\u5b9e\u73b0\u5728ggml_visit_parents\u4e2d\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-35-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-35-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-35-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-35-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-35-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-35-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-35-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-35-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-35-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-35-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-35-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-35-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-35-13\">13</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-35-1\" name=\"__codelineno-35-1\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">ggml_build_forward_impl</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_cgraph</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">cgraph</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">tensor</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">expand</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-35-2\" name=\"__codelineno-35-2\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">n0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">cgraph</span><span class=\"o\">-&gt;</span><span class=\"n\">n_nodes</span><span class=\"p\">;</span>\n<a id=\"__codelineno-35-3\" name=\"__codelineno-35-3\"></a>\n<a id=\"__codelineno-35-4\" name=\"__codelineno-35-4\"></a><span class=\"w\">    </span><span class=\"n\">ggml_visit_parents</span><span class=\"p\">(</span><span class=\"n\">cgraph</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tensor</span><span class=\"p\">);</span>\n<a id=\"__codelineno-35-5\" name=\"__codelineno-35-5\"></a>\n<a id=\"__codelineno-35-6\" name=\"__codelineno-35-6\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">n_new</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">cgraph</span><span class=\"o\">-&gt;</span><span class=\"n\">n_nodes</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">n0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-35-7\" name=\"__codelineno-35-7\"></a><span class=\"w\">    </span><span class=\"n\">GGML_PRINT_DEBUG</span><span class=\"p\">(</span><span class=\"s\">&quot;%s: visited %d new nodes</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">__func__</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">n_new</span><span class=\"p\">);</span>\n<a id=\"__codelineno-35-8\" name=\"__codelineno-35-8\"></a>\n<a id=\"__codelineno-35-9\" name=\"__codelineno-35-9\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">n_new</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-35-10\" name=\"__codelineno-35-10\"></a><span class=\"w\">        </span><span class=\"c1\">// the last added node should always be starting point</span>\n<a id=\"__codelineno-35-11\" name=\"__codelineno-35-11\"></a><span class=\"w\">        </span><span class=\"n\">GGML_ASSERT</span><span class=\"p\">(</span><span class=\"n\">cgraph</span><span class=\"o\">-&gt;</span><span class=\"n\">nodes</span><span class=\"p\">[</span><span class=\"n\">cgraph</span><span class=\"o\">-&gt;</span><span class=\"n\">n_nodes</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">tensor</span><span class=\"p\">);</span>\n<a id=\"__codelineno-35-12\" name=\"__codelineno-35-12\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-35-13\" name=\"__codelineno-35-13\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>ggml_visit_parents\u51fd\u6570\u901a\u8fc7\u9012\u5f52\u7684\u65b9\u5f0f\u6784\u5efa\u4e86\u8ba1\u7b97\u56fe\u3002</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_visit_parents-1.png\" /></p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_visit_parents-2.png\" /></p>\n<p>\u6838\u5fc3\u903b\u8f91\uff1a</p>\n<ul>\n<li>\n<p>\u68c0\u67e5\u5f53\u524d\u5f20\u91cf\u662f\u5426\u5df2\u5b58\u5728\u4e8e\u54c8\u5e0c\u8868\u4e2d\u3002\u5982\u679c\u5b58\u5728\uff0c\u5219\u505c\u6b62\u6267\u884c\u5e76\u8fd4\u56de\u3002</p>\n</li>\n<li>\n<p>\u5bf9\u6240\u6709src\u5f20\u91cf\u9012\u5f52\u8c03\u7528ggml_visit_parents\u51fd\u6570\u3002</p>\n</li>\n<li>\n<p>\u5982\u679c\u5b83\u662f\u4e00\u4e2a\u53f6\u8282\u70b9\uff08\u5373\u5e38\u91cf\u5f20\u91cf\u6216\u4e0d\u7531\u8fd0\u7b97\u751f\u6210\u7684\u8f93\u5165\u5f20\u91cf\uff09\uff0c\u5219\u5c06\u5176\u5b58\u50a8\u5728\u56fe\u7684\u53f6\u6570\u7ec4\uff08leafs\u6570\u7ec4\uff09\u4e2d\u3002</p>\n</li>\n<li>\n<p>\u5426\u5219\uff0c\u5c06\u5176\u5b58\u50a8\u5728\u56fe\u7684\u8282\u70b9\u6570\u7ec4\uff08nodes\u6570\u7ec4\uff09\u4e2d\u3002</p>\n</li>\n</ul>\n<p>\u6240\u6709\u9012\u5f52\u8c03\u7528\u8fd4\u56de\u540e\uff0c\u6700\u540e\u4e00\u6b21\u68c0\u67e5\u4f1a\u786e\u4fdd\u6700\u540e\u8bb0\u5f55\u7684\u8282\u70b9\u662f\u7ed3\u679c\u5f20\u91cf\u3002\u56e0\u4e3a\u4f7f\u7528\u4e86\u540e\u5e8f\u904d\u5386\uff0c\u8fd9\u610f\u5473\u7740\u8f93\u5165\u8282\u70b9\uff08\u5f20\u91cf\uff09\u662f\u6700\u540e\u63d2\u5165\u7684\u3002</p>\n<p>\u91c7\u7528debug\u6253\u5370gf\u8ba1\u7b97\u56fe\u4fe1\u606f\uff0c1\u4e2anode\u8282\u70b9\u5c31\u662fmat mul op\u8282\u70b9\uff0c\u4e24\u4e2aleaf\u8282\u70b9\u5c31\u662f\u4e24\u4e2a\u8f93\u5165\u5f20\u91cfa\u3001b\u77e9\u9635\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-36-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-36-17\">17</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-36-1\" name=\"__codelineno-36-1\"></a><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">gf</span>\n<a id=\"__codelineno-36-2\" name=\"__codelineno-36-2\"></a><span class=\"p\">(</span><span class=\"n\">ggml_cgraph</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-36-3\" name=\"__codelineno-36-3\"></a><span class=\"w\">  </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2048</span>\n<a id=\"__codelineno-36-4\" name=\"__codelineno-36-4\"></a><span class=\"w\">  </span><span class=\"n\">n_nodes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<a id=\"__codelineno-36-5\" name=\"__codelineno-36-5\"></a><span class=\"w\">  </span><span class=\"n\">n_leafs</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<a id=\"__codelineno-36-6\" name=\"__codelineno-36-6\"></a><span class=\"w\">  </span><span class=\"n\">nodes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x000055555556ddd8</span>\n<a id=\"__codelineno-36-7\" name=\"__codelineno-36-7\"></a><span class=\"w\">  </span><span class=\"n\">grads</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">nullptr</span>\n<a id=\"__codelineno-36-8\" name=\"__codelineno-36-8\"></a><span class=\"w\">  </span><span class=\"n\">grad_accs</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">nullptr</span>\n<a id=\"__codelineno-36-9\" name=\"__codelineno-36-9\"></a><span class=\"w\">  </span><span class=\"n\">leafs</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x0000555555571dd8</span>\n<a id=\"__codelineno-36-10\" name=\"__codelineno-36-10\"></a><span class=\"w\">  </span><span class=\"n\">use_counts</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x0000555555575dd8</span>\n<a id=\"__codelineno-36-11\" name=\"__codelineno-36-11\"></a><span class=\"w\">  </span><span class=\"n\">visited_hash_set</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-36-12\" name=\"__codelineno-36-12\"></a><span class=\"w\">    </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">4099</span>\n<a id=\"__codelineno-36-13\" name=\"__codelineno-36-13\"></a><span class=\"w\">    </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x0000555555581e00</span>\n<a id=\"__codelineno-36-14\" name=\"__codelineno-36-14\"></a><span class=\"w\">    </span><span class=\"n\">keys</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x0000555555579de8</span>\n<a id=\"__codelineno-36-15\" name=\"__codelineno-36-15\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-36-16\" name=\"__codelineno-36-16\"></a><span class=\"w\">  </span><span class=\"n\">order</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">GGML_CGRAPH_EVAL_ORDER_LEFT_TO_RIGHT</span>\n<a id=\"__codelineno-36-17\" name=\"__codelineno-36-17\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u6784\u5efa\u597d\u4e86a\u3001b\u77e9\u9635\u4e58\u8fd9\u4e2a\u4efb\u52a1\u7684\u8ba1\u7b97\u56fe\uff0c\u63a5\u4e0b\u6765\u5c31\u662f\u770bGGML\u5982\u4f55\u6267\u884c\u8fd9\u4e2a\u8ba1\u7b97\u56fe\u5e76\u83b7\u53d6\u8ba1\u7b97\u7ed3\u679c\u4e86\u3002</p>\n<h2 id=\"\u63a2\u7d22ggml\u7684\u5b9e\u73b0\u6267\u884cggml\u8ba1\u7b97\u56fe\">\u63a2\u7d22ggml\u7684\u5b9e\u73b0&ndash;\u6267\u884cGGML\u8ba1\u7b97\u56fe<a class=\"headerlink\" href=\"#\u63a2\u7d22ggml\u7684\u5b9e\u73b0\u6267\u884cggml\u8ba1\u7b97\u56fe\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u8282\u4e3b\u8981\u4ecb\u7ecd\u5982\u4f55\u8ba1\u7b97GGML\u8ba1\u7b97\u56fe\uff0c\u5b9e\u73b0\u7684\u6838\u5fc3\u903b\u8f91\u5728ggml_graph_compute_with_ctx\u51fd\u6570\u4e2d\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-37-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-37-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-37-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-37-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-37-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-37-6\">6</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-37-1\" name=\"__codelineno-37-1\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">n_threads</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// number of threads to perform some operations with multi-threading</span>\n<a id=\"__codelineno-37-2\" name=\"__codelineno-37-2\"></a>\n<a id=\"__codelineno-37-3\" name=\"__codelineno-37-3\"></a><span class=\"n\">ggml_graph_compute_with_ctx</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">gf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">n_threads</span><span class=\"p\">);</span>\n<a id=\"__codelineno-37-4\" name=\"__codelineno-37-4\"></a>\n<a id=\"__codelineno-37-5\" name=\"__codelineno-37-5\"></a><span class=\"c1\">// in this case, the output tensor is the last one in the graph</span>\n<a id=\"__codelineno-37-6\" name=\"__codelineno-37-6\"></a><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">ggml_graph_node</span><span class=\"p\">(</span><span class=\"n\">gf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5728\u8be5\u51fd\u6570\u4e2d\uff0c\u9996\u5148\u521b\u5efa\u4e86\u4e2a\u4e00\u4e2a\u8ba1\u7b97\u8ba1\u5212\uff0c\u5e76\u4e14\u6839\u636ecplan\u7684work_size\u5206\u914d\u4e86\u5b8c\u6210\u8fd9\u4e2aplan\u6240\u9700\u7684buffer\uff0c\u7136\u540e\u8c03\u7528ggml_graph_compute\u51fd\u6570\u6267\u884c\u8ba1\u7b97\u8ba1\u5212\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-38-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-38-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-38-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-38-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-38-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-38-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-38-7\">7</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-38-1\" name=\"__codelineno-38-1\"></a><span class=\"k\">enum</span><span class=\"w\"> </span><span class=\"nc\">ggml_status</span><span class=\"w\"> </span><span class=\"n\">ggml_graph_compute_with_ctx</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_context</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_cgraph</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">cgraph</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">n_threads</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-38-2\" name=\"__codelineno-38-2\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_cplan</span><span class=\"w\"> </span><span class=\"n\">cplan</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_graph_plan</span><span class=\"p\">(</span><span class=\"n\">cgraph</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">n_threads</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">);</span>\n<a id=\"__codelineno-38-3\" name=\"__codelineno-38-3\"></a>\n<a id=\"__codelineno-38-4\" name=\"__codelineno-38-4\"></a><span class=\"w\">    </span><span class=\"n\">cplan</span><span class=\"p\">.</span><span class=\"n\">work_data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">ggml_new_buffer</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cplan</span><span class=\"p\">.</span><span class=\"n\">work_size</span><span class=\"p\">);</span>\n<a id=\"__codelineno-38-5\" name=\"__codelineno-38-5\"></a>\n<a id=\"__codelineno-38-6\" name=\"__codelineno-38-6\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">ggml_graph_compute</span><span class=\"p\">(</span><span class=\"n\">cgraph</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">cplan</span><span class=\"p\">);</span>\n<a id=\"__codelineno-38-7\" name=\"__codelineno-38-7\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>ggml_cplan\u7ed3\u6784\u4f53\u7684\u6838\u5fc3\u76ee\u7684\u662f\uff1a<strong>\u786e\u5b9a\u8ba1\u7b97\u7684\u5173\u952e\u6267\u884c\u53c2\u6570</strong>\u3002</p>\n<ul>\n<li>\n<p>n_threads\uff1a\u7528\u4e8e\u56fe\u8ba1\u7b97\u7684\u7ebf\u7a0b\u6570\uff0c\u8fd9\u4e2a\u8bbe\u7f6e\u4e3a\u4e861\u3002</p>\n</li>\n<li>\n<p>work_size\uff1a\u8ba1\u7b97\u8ba1\u5212\u6240\u9700\u7684\u4e34\u65f6\u5185\u5b58\u5927\u5c0f\uff08\u5b57\u8282\u4e3a\u5355\u4f4d\uff09\u3002\u5728simple-ctx\u8fd9\u4e2a\u793a\u4f8b\u4e2d\uff0c\u8fd9\u4e2a\u503c\u88ab\u8bbe\u7f6e\u4e3a0\uff0c\u4e0d\u540c\u7684\u540e\u7aef\u548cop\u9700\u8981\u7684work_size\u6709\u4e0d\u540c\u3002</p>\n</li>\n</ul>\n<h3 id=\"\u63a2\u7d22ggml_graph_plan\u7ec6\u8282\">\u63a2\u7d22ggml_graph_plan\u7ec6\u8282<a class=\"headerlink\" href=\"#\u63a2\u7d22ggml_graph_plan\u7ec6\u8282\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"\u5982\u4f55\u786e\u5b9a\u7ebf\u7a0b\u6570\u91cf\">\u5982\u4f55\u786e\u5b9a\u7ebf\u7a0b\u6570\u91cf<a class=\"headerlink\" href=\"#\u5982\u4f55\u786e\u5b9a\u7ebf\u7a0b\u6570\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>ggml_graph_plan\u51fd\u6570\u5b9e\u73b0\u7684\u4e3b\u8981\u529f\u80fd\u5c31\u662f\u786e\u5b9a\u8ba1\u7b97\u8ba1\u5212\u6240\u9700\u7684\u7ebf\u7a0b\u6570\u548c\u4e34\u65f6\u5185\u5b58\u5927\u5c0f\u3002</p>\n<p>\u786e\u5b9a\u7ebf\u7a0b\u6570\u7684\u903b\u8f91\uff1a</p>\n<ul>\n<li>\n<p>\u9996\u5148\uff0c\u4f20\u9012\u7684\u53c2\u6570n_threads\u51b3\u5b9a\u4e86cplan\u7684\u7ebf\u7a0b\u6570\u4e0a\u9650\u3002</p>\n</li>\n<li>\n<p>\u901a\u8fc7\u8fed\u4ee3\u6240\u6709\u7684op node\uff0c\u6839\u636eop\u7c7b\u578b\u7684\u7ebf\u7a0b\u9650\u5236\u548cn_threads\u53c2\u6570\uff0c\u786emax_threads\u3002\uff08\u901a\u8fc7op\u7684swich case\u5b9e\u73b0\uff09</p>\n</li>\n<li>\n<p>\u6700\u7ec8\u7ebf\u7a0b\u8ba1\u7b97\u5982\u4e0b\uff1a</p>\n</li>\n</ul>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-39-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-39-1\" name=\"__codelineno-39-1\"></a><span class=\"n\">final_n_threads</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">MIN</span><span class=\"p\">(</span><span class=\"n\">n_threads</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">MAX</span><span class=\"p\">(</span><span class=\"n\">each</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"err\">&#39;</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">multithreading</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"p\">))</span>\n</code></pre></div></td></tr></table></div>\n<h4 id=\"\u786e\u5b9a\u5de5\u4f5c\u7f13\u5b58\u533a\u5927\u5c0f\">\u786e\u5b9a\u5de5\u4f5c\u7f13\u5b58\u533a\u5927\u5c0f<a class=\"headerlink\" href=\"#\u786e\u5b9a\u5de5\u4f5c\u7f13\u5b58\u533a\u5927\u5c0f\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>\u904d\u5386\u6240\u6709\u7684op node\uff0c\u6839\u636e\u6bcf\u4e2aop type\u4ee5\u53ca\u8ba1\u7b97\u7684\u6570\u636e\u7c7b\u578b\uff08\u6bd4\u5982\u8ba1\u7b97\u7684\u77e9\u9635\u4e58\u4e24\u4e2a\u53c2\u6570\u6570\u636e\u7c7b\u4e0d\u540c\uff0c\u9700\u8981\u989d\u5916\u7684\u7f13\u5b58\u533a\uff09\uff0c\u786e\u5b9a\u9700\u8981\u7684\u4e34\u65f6\u5185\u5b58\u5927\u5c0f\u3002</p>\n</li>\n<li>\n<p>\u6700\u7ec8\u5de5\u4f5c\u7f13\u5b58\u533a\u5927\u5c0f\u8ba1\u7b97\u5982\u4e0b\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-40-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-40-1\" name=\"__codelineno-40-1\"></a><span class=\"n\">final_work_buffer_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">MAX</span><span class=\"p\">(</span><span class=\"n\">each</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"err\">&#39;</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">work</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span>\n</code></pre></div></td></tr></table></div></p>\n</li>\n</ul>\n<p>\u5728simple-ctx\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0cthreads_count = 1\uff0c work_buffer_size = 0\u3002\u5728\u63a5\u4e0b\u6765\u7684\u51fd\u6570ggml_new_buffer\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230\u5206\u914d\u7684work_buffer_size\u5927\u5c0f\u7684\u7f13\u5b58\u533a\uff0c\u4e5f\u662f\u5728context\u7684\u5185\u5b58buffer\u4e2d\u5206\u914d\u7684\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-41-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-41-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-41-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-41-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-41-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-41-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-41-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-41-8\">8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-41-9\">9</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-41-1\" name=\"__codelineno-41-1\"></a><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cplan</span>\n<a id=\"__codelineno-41-2\" name=\"__codelineno-41-2\"></a><span class=\"p\">(</span><span class=\"n\">ggml_cplan</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-41-3\" name=\"__codelineno-41-3\"></a><span class=\"w\">  </span><span class=\"n\">work_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<a id=\"__codelineno-41-4\" name=\"__codelineno-41-4\"></a><span class=\"w\">  </span><span class=\"n\">work_data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x00005555555821d0</span><span class=\"w\"> </span><span class=\"s\">&quot;&quot;</span>\n<a id=\"__codelineno-41-5\" name=\"__codelineno-41-5\"></a><span class=\"w\">  </span><span class=\"n\">n_threads</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<a id=\"__codelineno-41-6\" name=\"__codelineno-41-6\"></a><span class=\"w\">  </span><span class=\"n\">threadpool</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span>\n<a id=\"__codelineno-41-7\" name=\"__codelineno-41-7\"></a><span class=\"w\">  </span><span class=\"n\">abort_callback</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x0000000000000000</span>\n<a id=\"__codelineno-41-8\" name=\"__codelineno-41-8\"></a><span class=\"w\">  </span><span class=\"n\">abort_callback_data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x0000000000000000</span>\n<a id=\"__codelineno-41-9\" name=\"__codelineno-41-9\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"\u8ba1\u7b97\u56fe\u7684\u6267\u884c\u8ba1\u7b97\">\u8ba1\u7b97\u56fe\u7684\u6267\u884c\u8ba1\u7b97<a class=\"headerlink\" href=\"#\u8ba1\u7b97\u56fe\u7684\u6267\u884c\u8ba1\u7b97\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u4e3a\u4e86\u6267\u884c\u8ba1\u7b97\u56fe\uff0c\u5df2\u7ecf\u51c6\u5907\u597d\u4e86\u5f20\u91cf\u6570\u636e\u3001\u8ba1\u7b97\u56fe\u3001\u8ba1\u7b97\u8ba1\u5212\uff08plan\uff09\uff0c\u6267\u884c\u7684\u5173\u952e\u903b\u8f91\u6765\u5230\u4e86ggml_graph_compute\u51fd\u6570\uff0c\u5c06\u8ba1\u7b97\u56fecgraph\u548ccplan\u4f5c\u4e3a\u53c2\u6570\u4f20\u5165\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-42-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-42-1\" name=\"__codelineno-42-1\"></a><span class=\"n\">ggml_graph_compute</span><span class=\"p\">(</span><span class=\"n\">cgraph</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">cplan</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-graph-compute.png\" /></p>\n<p>\u5728ggml_graph_compute\u51fd\u6570\u4e2d, \u5b9e\u73b0\u4e86\u5982\u4e0b\u6838\u5fc3\u529f\u80fd\uff1a</p>\n<ul>\n<li>\u5728ggml_cpu_init\u51fd\u6570\u4e2d\uff0c\u521b\u5efa\u4e86\u4e00\u4e9b\u5feb\u901f\u8ba1\u7b97\u7684\u67e5\u627e\u8868\u3002\u6bd4\u5982f32\u5230f16\u7684\u8f6c\u6362\u8868\u3001gelu\u8ba1\u7b97\u7684\u67e5\u627e\u8868\u3002</li>\n</ul>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-43-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-43-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-43-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-43-1\" name=\"__codelineno-43-1\"></a><span class=\"n\">ggml_table_f32_f16</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"p\">;</span>\n<a id=\"__codelineno-43-2\" name=\"__codelineno-43-2\"></a><span class=\"n\">ggml_table_gelu_f16</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">GGML_CPU_FP32_TO_FP16</span><span class=\"p\">(</span><span class=\"n\">ggml_gelu_f32</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">));</span>\n<a id=\"__codelineno-43-3\" name=\"__codelineno-43-3\"></a><span class=\"n\">ggml_table_gelu_quick_f16</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">GGML_CPU_FP32_TO_FP16</span><span class=\"p\">(</span><span class=\"n\">ggml_gelu_quick_f32</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">));</span>\n</code></pre></div></td></tr></table></div>\n<ul>\n<li>\u521b\u5efa\u4e86\u7ebf\u7a0b\u6c60\uff0c\u5c06\u8ba1\u7b97\u56fe\u548c\u8ba1\u7b97\u4efb\u52a1dispath\u7ed9\u7ebf\u7a0b\u6c60\u6267\u884c\u3002\u5728linux\u4e0b\uff0cggml\u91c7\u7528pthread\u5b9e\u73b0\u7ebf\u7a0b\u76f8\u5173\u64cd\u4f5c\u3002\uff08\u5173\u4e8eGGML_USE_OPENMP\u7684\u903b\u8f91\u53ef\u4ee5\u5148\u8df3\u8fc7\uff09</li>\n</ul>\n<h4 id=\"ggml\u7ebf\u7a0b\u6c60\u5b9e\u73b0\">GGML\u7ebf\u7a0b\u6c60\u5b9e\u73b0<a class=\"headerlink\" href=\"#ggml\u7ebf\u7a0b\u6c60\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h4>\n<p>GGML \u5b9e\u73b0\u4e86\u4e00\u4e2a\u7ebf\u7a0b\u6c60\uff0c\u8be5\u7ebf\u7a0b\u6c60\u7ecf\u8fc7\u4f18\u5316\uff0c\u53ef\u9ad8\u6548\u8fd0\u884c\u8ba1\u7b97\u56fe\uff0c\u5e76\u9488\u5bf9 NUMA \u67b6\u6784\u8fdb\u884c\u4e86\u4f18\u5316\u3002</p>\n<p>ggml\u9996\u5148\u4f7f\u7528\u9ed8\u8ba4\u53c2\u6570\u521d\u59cb\u5316\u4e00\u4e2aggml_thread_pool\u7ed3\u6784\u4f53\uff0c\u7136\u540e\u4e3a\u6bcf\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\u5206\u914d\u4e00\u4e2a\u72b6\u6001\u7ed3\u6784\u4f53\uff08ggml_compute_state\uff09\uff0c\u8d1f\u8d23\u7ebf\u7a0b\u6c60\u4e2d\u7684\u6bcf\u4e2a\u7ebf\u7a0b\u7684\u72b6\u6001\u8bb0\u5f55\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-44-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-44-15\">15</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-44-1\" name=\"__codelineno-44-1\"></a><span class=\"c1\">// Per-thread state</span>\n<a id=\"__codelineno-44-2\" name=\"__codelineno-44-2\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_compute_state</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-44-3\" name=\"__codelineno-44-3\"></a><span class=\"cp\">#ifndef GGML_USE_OPENMP</span>\n<a id=\"__codelineno-44-4\" name=\"__codelineno-44-4\"></a><span class=\"w\">    </span><span class=\"c1\">// linux\u4e0b\u5b9e\u9645\u4e3apthread</span>\n<a id=\"__codelineno-44-5\" name=\"__codelineno-44-5\"></a><span class=\"w\">    </span><span class=\"n\">ggml_thread_t</span><span class=\"w\"> </span><span class=\"n\">thrd</span><span class=\"p\">;</span>\n<a id=\"__codelineno-44-6\" name=\"__codelineno-44-6\"></a><span class=\"w\">    </span><span class=\"c1\">// \u7528\u4e8e\u8bbe\u7f6ecpu\u4eb2\u548c\u6027\uff08NUMA\u76f8\u5173\u4f18\u5316\uff09</span>\n<a id=\"__codelineno-44-7\" name=\"__codelineno-44-7\"></a><span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">cpumask</span><span class=\"p\">[</span><span class=\"n\">GGML_MAX_N_THREADS</span><span class=\"p\">];</span>\n<a id=\"__codelineno-44-8\" name=\"__codelineno-44-8\"></a><span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">  </span><span class=\"n\">last_graph</span><span class=\"p\">;</span>\n<a id=\"__codelineno-44-9\" name=\"__codelineno-44-9\"></a><span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">pending</span><span class=\"p\">;</span>\n<a id=\"__codelineno-44-10\" name=\"__codelineno-44-10\"></a><span class=\"cp\">#endif</span>\n<a id=\"__codelineno-44-11\" name=\"__codelineno-44-11\"></a><span class=\"w\">    </span><span class=\"c1\">// \u6307\u5411\u7ebf\u7a0b\u6c60\u7684\u6307\u9488</span>\n<a id=\"__codelineno-44-12\" name=\"__codelineno-44-12\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_threadpool</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">threadpool</span><span class=\"p\">;</span>\n<a id=\"__codelineno-44-13\" name=\"__codelineno-44-13\"></a><span class=\"w\">    </span><span class=\"c1\">// \u7ebf\u7a0b\u7f16\u53f7</span>\n<a id=\"__codelineno-44-14\" name=\"__codelineno-44-14\"></a><span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">ith</span><span class=\"p\">;</span>\n<a id=\"__codelineno-44-15\" name=\"__codelineno-44-15\"></a><span class=\"p\">};</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u5982\u679c\u542f\u7528\u4e86 OpenMP\uff0c\u7ebf\u7a0b\u7ba1\u7406\u4f1a\u81ea\u52a8\u5904\u7406\uff1b\u5426\u5219\uff0cGGML \u4f1a\u624b\u52a8\u521b\u5efa\u548c\u7ba1\u7406 pthread\uff0c\u5373\u624b\u52a8\u8bbe\u7f6ecpu\u4eb2\u548c\u6027\u7b49\u64cd\u4f5c\u3002</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_threadpool.png\" /></p>\n<h4 id=\"cpu\u4eb2\u548c\u6027\u8bbe\u7f6e\">cpu\u4eb2\u548c\u6027\u8bbe\u7f6e<a class=\"headerlink\" href=\"#cpu\u4eb2\u548c\u6027\u8bbe\u7f6e\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7531\u4e8e\u5728numa\u67b6\u6784\u4e0b\uff0c\u672c\u5730/\u8fdc\u7a0b\u5185\u5b58\u8bbf\u95ee\u901f\u5ea6\u5dee\u5f02\u5927\uff0c\u901a\u8fc7NUMA\u611f\u77e5\u8c03\u5ea6\uff08\u5982\u7ebf\u7a0b\u7ed1\u5b9a\u3001\u5185\u5b58\u5206\u914d\u4f18\u5316\uff09\u53ef\u63d0\u5347\u6027\u80fd\u200c\u3002\u901a\u8fc7\u8bbe\u7f6ecpu\u4eb2\u548c\u6027\uff0c\u7ed1\u5b9a\u7ebf\u7a0b\u5230\u672c\u5730NUMA\u8282\u70b9\uff0c\u51cf\u5c11\u8fdc\u7a0b\u8bbf\u95ee\u200c\u3002</p>\n<p>\u5728ggml\u7684\u5b9e\u73b0\u4e2d\uff0c\u901a\u8fc7\u51fd\u6570ggml_thread_cpumask_next()\u4e3a\u6bcf\u4e2aworker\u7ebf\u7a0b\u5206\u914dcpu\u4eb2\u548c\u6027\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-45-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-45-21\">21</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-45-1\" name=\"__codelineno-45-1\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">ggml_thread_cpumask_next</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">global_mask</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">local_mask</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">strict</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int32_t</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">iter</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-45-2\" name=\"__codelineno-45-2\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">strict</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-45-3\" name=\"__codelineno-45-3\"></a><span class=\"w\">        </span><span class=\"n\">memcpy</span><span class=\"p\">(</span><span class=\"n\">local_mask</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">global_mask</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_MAX_N_THREADS</span><span class=\"p\">);</span>\n<a id=\"__codelineno-45-4\" name=\"__codelineno-45-4\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<a id=\"__codelineno-45-5\" name=\"__codelineno-45-5\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-45-6\" name=\"__codelineno-45-6\"></a><span class=\"w\">        </span><span class=\"n\">memset</span><span class=\"p\">(</span><span class=\"n\">local_mask</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GGML_MAX_N_THREADS</span><span class=\"p\">);</span>\n<a id=\"__codelineno-45-7\" name=\"__codelineno-45-7\"></a><span class=\"w\">        </span><span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">base_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">iter</span><span class=\"p\">;</span>\n<a id=\"__codelineno-45-8\" name=\"__codelineno-45-8\"></a><span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">GGML_MAX_N_THREADS</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-45-9\" name=\"__codelineno-45-9\"></a><span class=\"w\">            </span><span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">base_idx</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">;</span>\n<a id=\"__codelineno-45-10\" name=\"__codelineno-45-10\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"n\">GGML_MAX_N_THREADS</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-45-11\" name=\"__codelineno-45-11\"></a><span class=\"w\">                </span><span class=\"c1\">// Just a cheaper modulo</span>\n<a id=\"__codelineno-45-12\" name=\"__codelineno-45-12\"></a><span class=\"w\">                </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">-=</span><span class=\"w\"> </span><span class=\"n\">GGML_MAX_N_THREADS</span><span class=\"p\">;</span>\n<a id=\"__codelineno-45-13\" name=\"__codelineno-45-13\"></a><span class=\"w\">            </span><span class=\"p\">}</span>\n<a id=\"__codelineno-45-14\" name=\"__codelineno-45-14\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">global_mask</span><span class=\"p\">[</span><span class=\"n\">idx</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-45-15\" name=\"__codelineno-45-15\"></a><span class=\"w\">                </span><span class=\"n\">local_mask</span><span class=\"p\">[</span><span class=\"n\">idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<a id=\"__codelineno-45-16\" name=\"__codelineno-45-16\"></a><span class=\"w\">                </span><span class=\"o\">*</span><span class=\"n\">iter</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<a id=\"__codelineno-45-17\" name=\"__codelineno-45-17\"></a><span class=\"w\">                </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<a id=\"__codelineno-45-18\" name=\"__codelineno-45-18\"></a><span class=\"w\">            </span><span class=\"p\">}</span>\n<a id=\"__codelineno-45-19\" name=\"__codelineno-45-19\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-45-20\" name=\"__codelineno-45-20\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-45-21\" name=\"__codelineno-45-21\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5728\u8be5\u51fd\u6570\u4e2d\u901a\u8fc7strict\u53c2\u6570\u63a7\u5236\u7ebf\u7a0b\u7684\u4eb2\u548c\u6027\u8bbe\u7f6e\u3002</p>\n<ul>\n<li>\n<p>\u5982\u679cstrict\u4e3afalse\uff0c\u5219\u5c06\u5168\u5c40mask\u590d\u5236\u7ed9\u7ebf\u7a0b\u7684mask\u3002\u5728\u6ca1\u6709NUMA\u7684\u67b6\u6784\u4e2d\uff0c\u8fd9\u4f1a\u5bfc\u81f4\u6240\u6709\u7ebf\u7a0b\u90fd\u88ab\u5141\u8bb8\u5728\u4efb\u4f55\u6838\u5fc3\u4e0a\u8fd0\u884c\u3002</p>\n</li>\n<li>\n<p>\u5982\u679cstrict\u4e3atrue\uff0c\u5219\u901a\u8fc7\u5faa\u73af\u904d\u5386\u5168\u5c40mask\uff0c\u627e\u5230\u7b2c\u4e00\u4e2a\u53ef\u7528\u7684CPU\u6838\u5fc3\uff0c\u5e76\u5c06\u5176\u5206\u914d\u7ed9\u7ebf\u7a0b\u3002</p>\n</li>\n</ul>\n<p>\u8fd9\u79cd\u903b\u8f91\u786e\u4fdd\u7ebf\u7a0b\u5728\u53ef\u7528\u7684CPU\u6838\u5fc3\u4e4b\u95f4\u5747\u5300\u5206\u5e03\uff0c\u4ece\u800c\u51cf\u5c11\u7ade\u4e89\u3002</p>\n<h4 id=\"\u8ba1\u7b97\u56fe\u5de5\u4f5c\u7ebf\u7a0b\u521b\u5efa\u53ca\u8c03\u5ea6\">\u8ba1\u7b97\u56fe\u5de5\u4f5c\u7ebf\u7a0b\u521b\u5efa\u53ca\u8c03\u5ea6<a class=\"headerlink\" href=\"#\u8ba1\u7b97\u56fe\u5de5\u4f5c\u7ebf\u7a0b\u521b\u5efa\u53ca\u8c03\u5ea6\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4e0a\u9762\u7684\u903b\u8f91\u5b8c\u6210\u4e86\u7ebf\u7a0b\u6c60\u7684\u521b\u5efa\u3001\u4eb2\u548c\u6027\u7684\u8bbe\u7f6e\uff0c\u63a5\u4e0b\u6765\u5c31\u662f\u521b\u5efa\u5177\u4f53\u7684\u5de5\u4f5c\u7ebf\u7a0b\u4e86\uff0c\u4e5f\u5c31\u662f\u7ebf\u7a0b\u8dd1\u8d77\u6765\u8981\u6267\u884c\u600e\u6837\u7684\u8fd0\u7b97\u903b\u8f91\u3002</p>\n<p>\u6ce8\u610f\uff0c\u8fd9\u91cc\u521b\u5efa\u5de5\u4f5c\u7ebf\u7a0b\u662f\u4ecethread 1\u5f00\u59cb\u7684\uff0c\u56e0\u4e3athread 0\u7684\u89e6\u53d1\u4e0d\u5728\u8fd9\u91cc\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-46-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-46-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-46-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-46-1\" name=\"__codelineno-46-1\"></a><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">tpp</span><span class=\"o\">-&gt;</span><span class=\"n\">n_threads</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-46-2\" name=\"__codelineno-46-2\"></a><span class=\"w\">    </span><span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">rc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ggml_thread_create</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">workers</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"p\">].</span><span class=\"n\">thrd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ggml_graph_compute_secondary_thread</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">workers</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"p\">]);</span>\n<a id=\"__codelineno-46-3\" name=\"__codelineno-46-3\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u63a5\u4e0b\u6765\uff0c\u8bf7\u770bggml_graph_compute_secondary_thread\u51fd\u6570\u3002</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-47-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-47-39\">39</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-47-1\" name=\"__codelineno-47-1\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">thread_ret_t</span><span class=\"w\"> </span><span class=\"nf\">ggml_graph_compute_secondary_thread</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-47-2\" name=\"__codelineno-47-2\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_compute_state</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_compute_state</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">;</span>\n<a id=\"__codelineno-47-3\" name=\"__codelineno-47-3\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_threadpool</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">threadpool</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">threadpool</span><span class=\"p\">;</span>\n<a id=\"__codelineno-47-4\" name=\"__codelineno-47-4\"></a>\n<a id=\"__codelineno-47-5\" name=\"__codelineno-47-5\"></a><span class=\"w\">    </span><span class=\"c1\">// \u8bbe\u7f6e\u7ebf\u7a0b\u4f18\u5148\u7ea7</span>\n<a id=\"__codelineno-47-6\" name=\"__codelineno-47-6\"></a><span class=\"w\">    </span><span class=\"n\">ggml_thread_apply_priority</span><span class=\"p\">(</span><span class=\"n\">threadpool</span><span class=\"o\">-&gt;</span><span class=\"n\">prio</span><span class=\"p\">);</span>\n<a id=\"__codelineno-47-7\" name=\"__codelineno-47-7\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ggml_thread_cpumask_is_valid</span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">cpumask</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-47-8\" name=\"__codelineno-47-8\"></a><span class=\"w\">        </span><span class=\"c1\">// \u8bbe\u7f6e\u7ebf\u7a0b affinity</span>\n<a id=\"__codelineno-47-9\" name=\"__codelineno-47-9\"></a><span class=\"w\">        </span><span class=\"n\">ggml_thread_apply_affinity</span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">cpumask</span><span class=\"p\">);</span>\n<a id=\"__codelineno-47-10\" name=\"__codelineno-47-10\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-47-11\" name=\"__codelineno-47-11\"></a>\n<a id=\"__codelineno-47-12\" name=\"__codelineno-47-12\"></a><span class=\"w\">    </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nb\">true</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-47-13\" name=\"__codelineno-47-13\"></a><span class=\"w\">        </span><span class=\"c1\">// Check if we need to sleep</span>\n<a id=\"__codelineno-47-14\" name=\"__codelineno-47-14\"></a><span class=\"w\">        </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">threadpool</span><span class=\"o\">-&gt;</span><span class=\"n\">pause</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-47-15\" name=\"__codelineno-47-15\"></a><span class=\"w\">            </span><span class=\"n\">GGML_PRINT_DEBUG</span><span class=\"p\">(</span><span class=\"s\">&quot;thread #%d inside pause loop</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">ith</span><span class=\"p\">);</span>\n<a id=\"__codelineno-47-16\" name=\"__codelineno-47-16\"></a><span class=\"w\">            </span><span class=\"n\">ggml_mutex_lock_shared</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">threadpool</span><span class=\"o\">-&gt;</span><span class=\"n\">mutex</span><span class=\"p\">);</span>\n<a id=\"__codelineno-47-17\" name=\"__codelineno-47-17\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">threadpool</span><span class=\"o\">-&gt;</span><span class=\"n\">pause</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-47-18\" name=\"__codelineno-47-18\"></a><span class=\"w\">                </span><span class=\"n\">ggml_cond_wait</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">threadpool</span><span class=\"o\">-&gt;</span><span class=\"n\">cond</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">threadpool</span><span class=\"o\">-&gt;</span><span class=\"n\">mutex</span><span class=\"p\">);</span>\n<a id=\"__codelineno-47-19\" name=\"__codelineno-47-19\"></a><span class=\"w\">            </span><span class=\"p\">}</span>\n<a id=\"__codelineno-47-20\" name=\"__codelineno-47-20\"></a><span class=\"w\">            </span><span class=\"n\">GGML_PRINT_DEBUG</span><span class=\"p\">(</span><span class=\"s\">&quot;thread #%d resuming after wait</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">ith</span><span class=\"p\">);</span>\n<a id=\"__codelineno-47-21\" name=\"__codelineno-47-21\"></a><span class=\"w\">            </span><span class=\"n\">ggml_mutex_unlock_shared</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">threadpool</span><span class=\"o\">-&gt;</span><span class=\"n\">mutex</span><span class=\"p\">);</span>\n<a id=\"__codelineno-47-22\" name=\"__codelineno-47-22\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-47-23\" name=\"__codelineno-47-23\"></a>\n<a id=\"__codelineno-47-24\" name=\"__codelineno-47-24\"></a><span class=\"w\">        </span><span class=\"c1\">// This needs to be checked for after the cond_wait</span>\n<a id=\"__codelineno-47-25\" name=\"__codelineno-47-25\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">threadpool</span><span class=\"o\">-&gt;</span><span class=\"n\">stop</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">break</span><span class=\"p\">;</span>\n<a id=\"__codelineno-47-26\" name=\"__codelineno-47-26\"></a>\n<a id=\"__codelineno-47-27\" name=\"__codelineno-47-27\"></a><span class=\"w\">        </span><span class=\"c1\">// Check if there is new work</span>\n<a id=\"__codelineno-47-28\" name=\"__codelineno-47-28\"></a><span class=\"w\">        </span><span class=\"c1\">// The main thread is the only one that can dispatch new work</span>\n<a id=\"__codelineno-47-29\" name=\"__codelineno-47-29\"></a>\n<a id=\"__codelineno-47-30\" name=\"__codelineno-47-30\"></a><span class=\"w\">        </span><span class=\"n\">ggml_graph_compute_check_for_work</span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"p\">);</span>\n<a id=\"__codelineno-47-31\" name=\"__codelineno-47-31\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">pending</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-47-32\" name=\"__codelineno-47-32\"></a><span class=\"w\">            </span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">pending</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">;</span>\n<a id=\"__codelineno-47-33\" name=\"__codelineno-47-33\"></a>\n<a id=\"__codelineno-47-34\" name=\"__codelineno-47-34\"></a><span class=\"w\">            </span><span class=\"n\">ggml_graph_compute_thread</span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"p\">);</span>\n<a id=\"__codelineno-47-35\" name=\"__codelineno-47-35\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-47-36\" name=\"__codelineno-47-36\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-47-37\" name=\"__codelineno-47-37\"></a>\n<a id=\"__codelineno-47-38\" name=\"__codelineno-47-38\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">thread_ret_t</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-47-39\" name=\"__codelineno-47-39\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n\u53ef\u4ee5\u770b\u5230\u5de5\u4f5c\u7ebf\u7a0b\u4e0d\u662f\u4e0a\u6765\u5c31\u5f00\u59cb\u6267\u884c\uff0c\u800c\u662f\u901a\u8fc7threadpool-&gt;pause\u8fdb\u884c\u4e86\u6682\u505c\u7b49\u5f85\u3002</p>\n<p>\u8ba9\u6211\u4eec\u56de\u5934\u770b\u770b\u4e3b\u7ebf\u7a0b\u4e2d\u7684ggml_graph_compute\u903b\u8f91\uff0c\u5b83\u9996\u5148\u521b\u5efa\u7ebf\u7a0b\u6c60\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u7684\u90e8\u5206\u3002\u521b\u5efa\u597d\u4ece1\u5f00\u59cb\u7684\u5de5\u4f5c\u7ebf\u7a0b\u540e\uff0c\u7136\u540e\u8c03\u7528\u4e86ggml_graph_compute_kickoff\uff0c\u5c31\u662f\u5b83\u628a\u7ebf\u7a0b\u6c60\u7684pause\u8bbe\u7f6e\u4e3afalse\u3002</p>\n<p>\u7136\u540e\u7ebf\u7a0b0\u5728\u8fd9\u4e2a\u542f\u52a8\u5176\u5b83\u7ebf\u7a0b\u7684\u7ebf\u7a0b\u5f00\u59cb\u6267\u884cggml_graph_compute_thread\u8ba1\u7b97\u4efb\u52a1\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-48-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-48-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-48-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-48-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-48-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-48-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-48-7\">7</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-48-1\" name=\"__codelineno-48-1\"></a><span class=\"k\">enum</span><span class=\"w\"> </span><span class=\"nc\">ggml_status</span><span class=\"w\"> </span><span class=\"n\">ggml_graph_compute</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_cgraph</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">cgraph</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_cplan</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">cplan</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-48-2\" name=\"__codelineno-48-2\"></a><span class=\"w\">    </span><span class=\"c1\">// Kick all threads to start the new graph</span>\n<a id=\"__codelineno-48-3\" name=\"__codelineno-48-3\"></a><span class=\"w\">    </span><span class=\"n\">ggml_graph_compute_kickoff</span><span class=\"p\">(</span><span class=\"n\">threadpool</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">n_threads</span><span class=\"p\">);</span>\n<a id=\"__codelineno-48-4\" name=\"__codelineno-48-4\"></a>\n<a id=\"__codelineno-48-5\" name=\"__codelineno-48-5\"></a><span class=\"w\">    </span><span class=\"c1\">// This is a work thread too</span>\n<a id=\"__codelineno-48-6\" name=\"__codelineno-48-6\"></a><span class=\"w\">    </span><span class=\"n\">ggml_graph_compute_thread</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">threadpool</span><span class=\"o\">-&gt;</span><span class=\"n\">workers</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]);</span>\n<a id=\"__codelineno-48-7\" name=\"__codelineno-48-7\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"\u591a\u7ebf\u7a0b\u5982\u4f55\u6267\u884c\u77e9\u9635\u4e58\u5f20\u91cf\u8ba1\u7b97\">\u591a\u7ebf\u7a0b\u5982\u4f55\u6267\u884c\u77e9\u9635\u4e58\u5f20\u91cf\u8ba1\u7b97<a class=\"headerlink\" href=\"#\u591a\u7ebf\u7a0b\u5982\u4f55\u6267\u884c\u77e9\u9635\u4e58\u5f20\u91cf\u8ba1\u7b97\" title=\"Permanent link\">&para;</a></h3>\n<p>GGML\u7684\u6240\u6709\u7ebf\u7a0b\u6bcf\u6b21\u53ea\u5904\u7406\u4e00\u4e2a\u8282\u70b9\u3002\u8ba9\u6211\u4eec\u770b\u770bggml_compute_forward\uff0c\u5176\u4e2d\u4f1a\u6839\u636e\u8282\u70b9\u7684\u8fd0\u7b97\u7b26\u7c7b\u578b\u9009\u62e9\u5b9e\u9645\u7684\u8ba1\u7b97\u51fd\u6570\u3002\u8fd9\u662f\u901a\u8fc7\u4e00\u4e2a\u5e9e\u5927\u7684switch-case\u8bed\u53e5\u5757\u6765\u5904\u7406\u7684\u3002</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-49-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-49-37\">37</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-49-1\" name=\"__codelineno-49-1\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">thread_ret_t</span><span class=\"w\"> </span><span class=\"nf\">ggml_graph_compute_thread</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-49-2\" name=\"__codelineno-49-2\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_compute_state</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_compute_state</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">;</span>\n<a id=\"__codelineno-49-3\" name=\"__codelineno-49-3\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_threadpool</span><span class=\"w\">    </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">tp</span><span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">threadpool</span><span class=\"p\">;</span>\n<a id=\"__codelineno-49-4\" name=\"__codelineno-49-4\"></a>\n<a id=\"__codelineno-49-5\" name=\"__codelineno-49-5\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_cgraph</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">cgraph</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tp</span><span class=\"o\">-&gt;</span><span class=\"n\">cgraph</span><span class=\"p\">;</span>\n<a id=\"__codelineno-49-6\" name=\"__codelineno-49-6\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_cplan</span><span class=\"w\">  </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">cplan</span><span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tp</span><span class=\"o\">-&gt;</span><span class=\"n\">cplan</span><span class=\"p\">;</span>\n<a id=\"__codelineno-49-7\" name=\"__codelineno-49-7\"></a>\n<a id=\"__codelineno-49-8\" name=\"__codelineno-49-8\"></a><span class=\"w\">    </span><span class=\"n\">set_numa_thread_affinity</span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">ith</span><span class=\"p\">);</span>\n<a id=\"__codelineno-49-9\" name=\"__codelineno-49-9\"></a>\n<a id=\"__codelineno-49-10\" name=\"__codelineno-49-10\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_compute_params</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-49-11\" name=\"__codelineno-49-11\"></a><span class=\"w\">        </span><span class=\"cm\">/*.ith       =*/</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">ith</span><span class=\"p\">,</span>\n<a id=\"__codelineno-49-12\" name=\"__codelineno-49-12\"></a><span class=\"w\">        </span><span class=\"cm\">/*.nth       =*/</span><span class=\"w\"> </span><span class=\"n\">atomic_load_explicit</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">tp</span><span class=\"o\">-&gt;</span><span class=\"n\">n_threads_cur</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">memory_order_relaxed</span><span class=\"p\">),</span>\n<a id=\"__codelineno-49-13\" name=\"__codelineno-49-13\"></a><span class=\"w\">        </span><span class=\"cm\">/*.wsize     =*/</span><span class=\"w\"> </span><span class=\"n\">cplan</span><span class=\"o\">-&gt;</span><span class=\"n\">work_size</span><span class=\"p\">,</span>\n<a id=\"__codelineno-49-14\" name=\"__codelineno-49-14\"></a><span class=\"w\">        </span><span class=\"cm\">/*.wdata     =*/</span><span class=\"w\"> </span><span class=\"n\">cplan</span><span class=\"o\">-&gt;</span><span class=\"n\">work_data</span><span class=\"p\">,</span>\n<a id=\"__codelineno-49-15\" name=\"__codelineno-49-15\"></a><span class=\"w\">        </span><span class=\"cm\">/*.threadpool=*/</span><span class=\"w\"> </span><span class=\"n\">tp</span><span class=\"p\">,</span>\n<a id=\"__codelineno-49-16\" name=\"__codelineno-49-16\"></a><span class=\"w\">    </span><span class=\"p\">};</span>\n<a id=\"__codelineno-49-17\" name=\"__codelineno-49-17\"></a>\n<a id=\"__codelineno-49-18\" name=\"__codelineno-49-18\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">node_n</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">node_n</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">cgraph</span><span class=\"o\">-&gt;</span><span class=\"n\">n_nodes</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">atomic_load_explicit</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">tp</span><span class=\"o\">-&gt;</span><span class=\"n\">abort</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">memory_order_relaxed</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">node_n</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">node_n</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-49-19\" name=\"__codelineno-49-19\"></a><span class=\"w\">        </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">cgraph</span><span class=\"o\">-&gt;</span><span class=\"n\">nodes</span><span class=\"p\">[</span><span class=\"n\">node_n</span><span class=\"p\">];</span>\n<a id=\"__codelineno-49-20\" name=\"__codelineno-49-20\"></a>\n<a id=\"__codelineno-49-21\" name=\"__codelineno-49-21\"></a><span class=\"w\">        </span><span class=\"n\">ggml_compute_forward</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">params</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"p\">);</span>\n<a id=\"__codelineno-49-22\" name=\"__codelineno-49-22\"></a>\n<a id=\"__codelineno-49-23\" name=\"__codelineno-49-23\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">ith</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">cplan</span><span class=\"o\">-&gt;</span><span class=\"n\">abort_callback</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span>\n<a id=\"__codelineno-49-24\" name=\"__codelineno-49-24\"></a><span class=\"w\">                </span><span class=\"n\">cplan</span><span class=\"o\">-&gt;</span><span class=\"n\">abort_callback</span><span class=\"p\">(</span><span class=\"n\">cplan</span><span class=\"o\">-&gt;</span><span class=\"n\">abort_callback_data</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-49-25\" name=\"__codelineno-49-25\"></a><span class=\"w\">            </span><span class=\"n\">atomic_store_explicit</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">tp</span><span class=\"o\">-&gt;</span><span class=\"n\">abort</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">node_n</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">memory_order_relaxed</span><span class=\"p\">);</span>\n<a id=\"__codelineno-49-26\" name=\"__codelineno-49-26\"></a><span class=\"w\">            </span><span class=\"n\">tp</span><span class=\"o\">-&gt;</span><span class=\"n\">ec</span><span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">GGML_STATUS_ABORTED</span><span class=\"p\">;</span>\n<a id=\"__codelineno-49-27\" name=\"__codelineno-49-27\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-49-28\" name=\"__codelineno-49-28\"></a>\n<a id=\"__codelineno-49-29\" name=\"__codelineno-49-29\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">node_n</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">cgraph</span><span class=\"o\">-&gt;</span><span class=\"n\">n_nodes</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-49-30\" name=\"__codelineno-49-30\"></a><span class=\"w\">            </span><span class=\"n\">ggml_barrier</span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">threadpool</span><span class=\"p\">);</span>\n<a id=\"__codelineno-49-31\" name=\"__codelineno-49-31\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-49-32\" name=\"__codelineno-49-32\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-49-33\" name=\"__codelineno-49-33\"></a>\n<a id=\"__codelineno-49-34\" name=\"__codelineno-49-34\"></a><span class=\"w\">    </span><span class=\"n\">ggml_barrier</span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">threadpool</span><span class=\"p\">);</span>\n<a id=\"__codelineno-49-35\" name=\"__codelineno-49-35\"></a>\n<a id=\"__codelineno-49-36\" name=\"__codelineno-49-36\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-49-37\" name=\"__codelineno-49-37\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\nggml_compute_forward\u8c03\u7528\u7684\u662fggml_compute_forward_mul_mat\u7684\u5b9e\u73b0\uff0c\u5b8c\u6210\u77e9\u9635\u4e58\u6cd5\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-50-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-50-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-50-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-50-4\">4</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-50-1\" name=\"__codelineno-50-1\"></a><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"no\">GGML_OP_MUL_MAT</span><span class=\"p\">:</span>\n<a id=\"__codelineno-50-2\" name=\"__codelineno-50-2\"></a><span class=\"w\">    </span><span class=\"p\">{</span>\n<a id=\"__codelineno-50-3\" name=\"__codelineno-50-3\"></a><span class=\"w\">        </span><span class=\"n\">ggml_compute_forward_mul_mat</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tensor</span><span class=\"p\">);</span>\n<a id=\"__codelineno-50-4\" name=\"__codelineno-50-4\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">break</span><span class=\"p\">;</span>\n</code></pre></div></td></tr></table></div>\n<p>\u67e5\u770bggml_compute_forward_mul_mat\u7684\u5b9e\u73b0\u53ef\u77e5\uff0c\u77e9\u9635\u7684\u8ba1\u7b97\u4e0d\u662f\u4e00\u4e2a\u7ebf\u7a0b\u5b8c\u6210\u6574\u4e2a\u77e9\u9635\u7684\u8ba1\u7b97\uff0c\u800c\u662f\u4f20\u9012\u4e86thread_id\u53c2\u6570\uff0c\u6839\u636ethread_id\u6765\u62c6\u5206\u77e9\u9635\u5757\uff0c\u5206\u5757\u8ba1\u7b97\u3002</p>\n<p>\u8fd9\u91cc\u4e5f\u53ef\u4ee5\u770b\u5230GGML\u7684\u8ba1\u7b97\u56fe\u6267\u884c\u8c03\u5ea6\u548c\u4e00\u822c\u56fe\u8ba1\u7b97\u7684\u533a\u522b\uff0c\u4e00\u822c\u573a\u666f\u7684\u6709\u5411\u65e0\u73af\u56fe\uff0c\u591a\u4e2a\u7ebf\u7a0b\u5e76\u884c\u6267\u884c\u591a\u4e2a\u53ef\u4ee5\u5e76\u884c\u7684node\uff0c\u8fd9\u91ccGGML\u662f\u4e00\u6b21\u53ea\u6267\u884c\u4e00\u4e2anode\uff0cnode\u4e2d\u591a\u4e2a\u7ebf\u7a0b\u5206\u5757\u8ba1\u7b97\u3002\u7136\u540e\u8fdb\u5165\u4e0b\u4e00\u4e2a\u8282\u70b9\u8ba1\u7b97\u3002</p>\n<p>\u4e00\u65e6\u4e00\u4e2a\u8282\u70b9node\u7684\u8ba1\u7b97\u5b8c\u6210\uff0c\u6240\u6709\u7ebf\u7a0b\u90fd\u4f1a\u5728\u5c4f\u969cggml_barrier\u5904\u540c\u6b65\uff0c\u786e\u4fdd\u5b83\u4eec\u5728\u8fdb\u5165\u4e0b\u4e00\u4e2a\u8282\u70b9\u4e4b\u524d\u5b8c\u6210\u5f53\u524d\u8282\u70b9\u7684\u8ba1\u7b97\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4f1a\u91cd\u590d\u8fdb\u884c\uff0c\u76f4\u5230\u56fe\u4e2d\u7684\u6240\u6709\u8282\u70b9\u90fd\u88ab\u8bc4\u4f30\u5b8c\u6bd5\u3002</p>\n<p>\u4e0a\u9762\u66f4\u591a\u7684\u8c08\u5230\u7684\u662f\u4e0d\u4f7f\u7528OpenMP\uff0c\u624b\u52a8\u7ba1\u7406\u7ebf\u7a0b\u7684\u51e1\u662f\u3002\u5982\u679c\u542f\u7528OpenMP\u540e\uff0c\u5b83\u4f1a\u81ea\u52a8\u7ba1\u7406\u5e76\u884c\u8ba1\u7b97\uff0c\u65e0\u9700\u624b\u52a8\u521b\u5efa\u548c\u540c\u6b65\u7ebf\u7a0b\u3002\u6211\u4eec\u65e0\u9700\u81ea\u5df1\u5904\u7406\u7ebf\u7a0b\u6c60\u3001\u6761\u4ef6\u53d8\u91cf\u548c\u7ade\u4e89\u6761\u4ef6\uff0c\u53ea\u9700\u8bbe\u7f6e\u7ebf\u7a0b\u6570\u91cf\uff0c\u8ba9\u6bcf\u4e2a\u7ebf\u7a0b\u6267\u884cggml_graph_compute_thread\u5373\u53ef\u3002</p>\n<h3 id=\"\u83b7\u53d6\u8ba1\u7b97\u7ed3\u679c\">\u83b7\u53d6\u8ba1\u7b97\u7ed3\u679c<a class=\"headerlink\" href=\"#\u83b7\u53d6\u8ba1\u7b97\u7ed3\u679c\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-51-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-51-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-51-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-51-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-51-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-51-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-51-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-51-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-51-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-51-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-51-11\">11</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-51-1\" name=\"__codelineno-51-1\"></a><span class=\"c1\">// perform computation in cpu</span>\n<a id=\"__codelineno-51-2\" name=\"__codelineno-51-2\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ggml_tensor</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">compute</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">);</span>\n<a id=\"__codelineno-51-3\" name=\"__codelineno-51-3\"></a>\n<a id=\"__codelineno-51-4\" name=\"__codelineno-51-4\"></a><span class=\"c1\">// get the result data pointer as a float array to print</span>\n<a id=\"__codelineno-51-5\" name=\"__codelineno-51-5\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">vector</span><span class=\"o\">&lt;</span><span class=\"kt\">float</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">out_data</span><span class=\"p\">(</span><span class=\"n\">ggml_nelements</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">));</span>\n<a id=\"__codelineno-51-6\" name=\"__codelineno-51-6\"></a><span class=\"n\">memcpy</span><span class=\"p\">(</span><span class=\"n\">out_data</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"o\">-&gt;</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ggml_nbytes</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">));</span>\n<a id=\"__codelineno-51-7\" name=\"__codelineno-51-7\"></a>\n<a id=\"__codelineno-51-8\" name=\"__codelineno-51-8\"></a><span class=\"c1\">// expected result:</span>\n<a id=\"__codelineno-51-9\" name=\"__codelineno-51-9\"></a><span class=\"c1\">// [ 60.00 55.00 50.00 110.00</span>\n<a id=\"__codelineno-51-10\" name=\"__codelineno-51-10\"></a><span class=\"c1\">//   90.00 54.00 54.00 126.00</span>\n<a id=\"__codelineno-51-11\" name=\"__codelineno-51-11\"></a><span class=\"c1\">//   42.00 29.00 28.00 64.00 ]</span>\n</code></pre></div></td></tr></table></div>\n<p>\u6700\u540e\u5c31\u662f\u83b7\u53d6result node\uff0c\u7136\u540e\u5c06\u8ba1\u7b97\u7ed3\u679c\u62f7\u8d1d\u51fa\u6765\u3002\u5230\u6b64\uff0c\u901a\u8fc7simple-ctx\u7684\u4f8b\u5b50\uff0c\u6211\u4eec\u4ece\u6e90\u7801\u7406\u89e3\u4e86GGML\u5982\u4f55\u5b9e\u73b0\u5728ggml_context\u4e2d\u5206\u914d\u6240\u6709\u9700\u8981\u7684\u5185\u5b58\uff0c\u901a\u8fc7cpu backend\u7684\u65b9\u5f0f\u6267\u884c\u8ba1\u7b97\u56fe\u3002</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c20\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8e\u5c5e\u6027\u6d4b\u8bd5\u7684quickcheck-cpp\u5e93/\" target=\"_blank\">C++20\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8e\u5c5e\u6027\u6d4b\u8bd5\u7684quickcheck-cpp\u5e93</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898/\" target=\"_blank\">C++\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-09-01T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/bitnet%E4%B8%ADint2%E5%92%8Cint8%E7%9A%84%E4%BD%BF%E7%94%A8/",
            "url": "https://github.com/KenForever1/blog/bitnet%E4%B8%ADint2%E5%92%8Cint8%E7%9A%84%E4%BD%BF%E7%94%A8/",
            "title": "bitnet\u4e2dint2\u548cint8\u7684\u4f7f\u7528",
            "content_html": "<!-- more -->\n\n<h2 id=\"bitnet\u4e2dint2\u548cint8\u7684\u4f7f\u7528\">bitnet\u4e2dint2\u548cint8\u7684\u4f7f\u7528<a class=\"headerlink\" href=\"#bitnet\u4e2dint2\u548cint8\u7684\u4f7f\u7528\" title=\"Permanent link\">&para;</a></h2>\n<p>W2A8\u200c\uff082-bit\u6743\u91cd + 8-bit\u6fc0\u6d3b\uff09\u662f\u4e00\u79cd\u6781\u4f4e\u7cbe\u5ea6\u91cf\u5316\u65b9\u6848\uff0c\u65e8\u5728\u901a\u8fc7\u727a\u7272\u90e8\u5206\u6a21\u578b\u7cbe\u5ea6\u6362\u53d6\u663e\u8457\u7684\u5b58\u50a8\u548c\u8ba1\u7b97\u6548\u7387\u63d0\u5347\u3002\u9002\u7528\u4e8e\u8ba1\u7b97\u8d44\u6e90\u53d7\u9650\u7684\u573a\u666f\u8fb9\u7f18\u8bbe\u5907\u90e8\u7f72\u200c\uff0c\u5982\u79fb\u52a8\u7aef\u6216\u5d4c\u5165\u5f0f\u8bbe\u5907\u200c\u3002</p>\n<h3 id=\"gpu\u7248\u672c\u63a8\u7406\">gpu\u7248\u672c\u63a8\u7406<a class=\"headerlink\" href=\"#gpu\u7248\u672c\u63a8\u7406\" title=\"Permanent link\">&para;</a></h3>\n<p><a href=\"https://github.com/microsoft/BitNet/tree/main/gpu\">\u53c2\u8003readme\u4e2d</a>\u4f7f\u7528\u7684 BitNet-b1.58-2B-4T\u6a21\u578b\u3002</p>\n<p>\u6743\u91cdweight\u91c7\u7528int2\u5b58\u50a8\uff0c\u6fc0\u6d3bactivation\u91c7\u7528int8\u5b58\u50a8\u3002\u81ea\u5b9a\u4e49\u4e86\u4e2acuda kernel\u51fd\u6570\uff0c\u7528\u4e8e\u8ba1\u7b97int2\u548cint8\u7684\u4e58\u6cd5\u3002</p>\n<ul>\n<li>\n<p>\u5728\u8f6c\u6362checkpoint\u65f6\uff0c\u5c06int8\u6743\u91cd\u8f6c\u4e3aint2\uff08convert_weight_int8_to_int2\uff09\uff0c\u5e76\u4e14\u5bf9\u6743\u91cd\u8fdb\u884c\u4e86\u5212\u5206\u4e3a16\u00d732 blocks\u548c\u91cd\u6392\uff0c\u4fbf\u4e8egpu\u7684\u9ad8\u6548\u8fd0\u7b97\u3002</p>\n</li>\n<li>\n<p>\u81ea\u5b9a\u4e49kernel\u51fd\u6570ladder_int8xint2_kernel\uff0c\u91c7\u7528gpu dp4a\u6307\u4ee4(__dp4a)\u8fdb\u884c\u4f4e\u7cbe\u5ea6\u7684\u70b9\u79ef\u64cd\u4f5c\u3002</p>\n</li>\n</ul>\n<p><img alt=\"\" src=\"https://developer.nvidia.com/blog/parallelforall/wp-content/uploads/2016/10/DP4A_DP2A-624x223.png\" /></p>\n<p>\u5728prefill\u65f6\uff0c\u4f7f\u7528fp16\uff1b\u5728decode\u65f6\uff0c\u4f7f\u7528int2\uff0c\u91c7\u7528\u81ea\u5b9a\u4e49cuda kernel\u51fd\u6570\u8fdb\u884cint2\u548cint8\u7684\u4e58\u6cd5\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Python</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-14\">14</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"c1\"># \\gpu\\generate.py</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a><span class=\"n\">model_args_prefill</span> <span class=\"o\">=</span> <span class=\"n\">fast</span><span class=\"o\">.</span><span class=\"n\">ModelArgs</span><span class=\"p\">(</span><span class=\"n\">use_kernel</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a><span class=\"n\">model_args_decode</span> <span class=\"o\">=</span> <span class=\"n\">fast</span><span class=\"o\">.</span><span class=\"n\">ModelArgs</span><span class=\"p\">(</span><span class=\"n\">use_kernel</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\"></a><span class=\"n\">tokenizer</span> <span class=\"o\">=</span> <span class=\"n\">Tokenizer</span><span class=\"p\">(</span><span class=\"s2\">&quot;./tokenizer.model&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\"></a>\n<a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\"></a><span class=\"n\">prefill_model</span> <span class=\"o\">=</span> <span class=\"n\">fast</span><span class=\"o\">.</span><span class=\"n\">Transformer</span><span class=\"p\">(</span><span class=\"n\">model_args_prefill</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\"></a><span class=\"n\">decode_model</span> <span class=\"o\">=</span> <span class=\"n\">fast</span><span class=\"o\">.</span><span class=\"n\">Transformer</span><span class=\"p\">(</span><span class=\"n\">model_args_decode</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\"></a>\n<a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\"></a><span class=\"n\">fp16_ckpt_path</span> <span class=\"o\">=</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">Path</span><span class=\"p\">(</span><span class=\"n\">ckpt_dir</span><span class=\"p\">)</span> <span class=\"o\">/</span> <span class=\"s2\">&quot;model_state_fp16.pt&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\"></a><span class=\"n\">fp16_checkpoint</span> <span class=\"o\">=</span> <span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">(</span><span class=\"n\">fp16_ckpt_path</span><span class=\"p\">,</span> <span class=\"n\">map_location</span><span class=\"o\">=</span><span class=\"s2\">&quot;cpu&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\"></a><span class=\"n\">int2_ckpt_path</span> <span class=\"o\">=</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">Path</span><span class=\"p\">(</span><span class=\"n\">ckpt_dir</span><span class=\"p\">)</span> <span class=\"o\">/</span> <span class=\"s2\">&quot;model_state_int2.pt&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\"></a><span class=\"n\">int2_checkpoint</span> <span class=\"o\">=</span> <span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">(</span><span class=\"n\">int2_ckpt_path</span><span class=\"p\">,</span> <span class=\"n\">map_location</span><span class=\"o\">=</span><span class=\"s2\">&quot;cpu&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\"></a><span class=\"n\">prefill_model</span><span class=\"o\">.</span><span class=\"n\">load_state_dict</span><span class=\"p\">(</span><span class=\"n\">fp16_checkpoint</span><span class=\"p\">,</span> <span class=\"n\">strict</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\"></a><span class=\"n\">decode_model</span><span class=\"o\">.</span><span class=\"n\">load_state_dict</span><span class=\"p\">(</span><span class=\"n\">int2_checkpoint</span><span class=\"p\">,</span> <span class=\"n\">strict</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</code></pre></div></td></tr></table></div>\nladder_int8xint2_kernel\u6838\u51fd\u6570\u7528\u4e8e\u8ba1\u7b97int2\u4e58int8\u7684\u5411\u91cf\u4e58\u6cd5\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-38\">38</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">ws_num</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">K_block_size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">N_block_size</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"n\">__global__</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">__launch_bounds__</span><span class=\"p\">(</span><span class=\"mi\">128</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ladder_int8xint2_kernel</span><span class=\"p\">(</span><span class=\"kt\">int8_t</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">__restrict__</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int8_t</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">__restrict__</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">__nv_bfloat16</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">__restrict__</span><span class=\"w\"> </span><span class=\"n\">dtype_transform</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">__nv_bfloat16</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">__restrict__</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">__nv_bfloat16</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">__restrict__</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a><span class=\"w\">  </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">K_per_loop</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">;</span>\n<a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\"></a><span class=\"w\">  </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">wmma_K</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"p\">;</span>\n<a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\"></a><span class=\"w\">  </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">wmma_N</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">;</span>\n<a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">in_thread_C_local</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n<a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\"></a><span class=\"w\">  </span><span class=\"kt\">signed</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">A_local</span><span class=\"p\">[</span><span class=\"n\">K_per_loop</span><span class=\"p\">];</span>\n<a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">B_reshape_local</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n<a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\"></a><span class=\"w\">  </span><span class=\"kt\">signed</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">B_decode_local</span><span class=\"p\">[</span><span class=\"n\">K_per_loop</span><span class=\"p\">];</span>\n<a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">red_buf0</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n<a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\"></a><span class=\"w\">  </span><span class=\"n\">in_thread_C_local</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\"></a><span class=\"w\">  </span><span class=\"cp\">#pragma unroll</span>\n<a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">k_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">k_0</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">/</span><span class=\"p\">(</span><span class=\"n\">K_per_loop</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">K_block_size</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"n\">k_0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\"></a><span class=\"w\">    </span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"n\">int4</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">A_local</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"n\">int4</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">k_0</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">K_per_loop</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">K_block_size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"p\">(((</span><span class=\"kt\">int</span><span class=\"p\">)</span><span class=\"n\">threadIdx</span><span class=\"p\">.</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">K_per_loop</span><span class=\"p\">)));</span>\n<a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\"></a><span class=\"w\">    </span><span class=\"n\">B_reshape_local</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span>\n<a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\"></a><span class=\"w\">      </span><span class=\"p\">(((</span><span class=\"kt\">int</span><span class=\"p\">)</span><span class=\"n\">blockIdx</span><span class=\"p\">.</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">N_block_size</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span>\n<a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\"></a><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">k_0</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">K_block_size</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">K_per_loop</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">wmma_N</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span>\n<a id=\"__codelineno-1-18\" name=\"__codelineno-1-18\"></a><span class=\"w\">      </span><span class=\"p\">((((</span><span class=\"kt\">int</span><span class=\"p\">)</span><span class=\"n\">threadIdx</span><span class=\"p\">.</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">wmma_K</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">wmma_N</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span>\n<a id=\"__codelineno-1-19\" name=\"__codelineno-1-19\"></a><span class=\"w\">      </span><span class=\"p\">((((</span><span class=\"kt\">int</span><span class=\"p\">)</span><span class=\"n\">threadIdx</span><span class=\"p\">.</span><span class=\"n\">y</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">wmma_K</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">wmma_N</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span>\n<a id=\"__codelineno-1-20\" name=\"__codelineno-1-20\"></a><span class=\"w\">      </span><span class=\"p\">((((</span><span class=\"kt\">int</span><span class=\"p\">)</span><span class=\"n\">threadIdx</span><span class=\"p\">.</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">wmma_K</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">wmma_N</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span>\n<a id=\"__codelineno-1-21\" name=\"__codelineno-1-21\"></a><span class=\"w\">      </span><span class=\"p\">((((</span><span class=\"kt\">int</span><span class=\"p\">)</span><span class=\"n\">threadIdx</span><span class=\"p\">.</span><span class=\"n\">y</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">wmma_K</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">)</span>\n<a id=\"__codelineno-1-22\" name=\"__codelineno-1-22\"></a><span class=\"w\">      </span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-23\" name=\"__codelineno-1-23\"></a><span class=\"w\">    </span><span class=\"n\">decode_i2s_to_i8s</span><span class=\"p\">(</span><span class=\"n\">B_reshape_local</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">B_decode_local</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-24\" name=\"__codelineno-1-24\"></a><span class=\"w\">    </span><span class=\"cp\">#pragma unroll</span>\n<a id=\"__codelineno-1-25\" name=\"__codelineno-1-25\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">k_2_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">k_2_0</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"n\">k_2_0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-26\" name=\"__codelineno-1-26\"></a><span class=\"w\">      </span><span class=\"n\">in_thread_C_local</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">__dp4a</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"o\">&amp;</span><span class=\"n\">A_local</span><span class=\"p\">[((</span><span class=\"n\">k_2_0</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">))],</span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"o\">&amp;</span><span class=\"n\">B_decode_local</span><span class=\"p\">[((</span><span class=\"n\">k_2_0</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">))],</span><span class=\"w\"> </span><span class=\"n\">in_thread_C_local</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]);</span>\n<a id=\"__codelineno-1-27\" name=\"__codelineno-1-27\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-1-28\" name=\"__codelineno-1-28\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-1-29\" name=\"__codelineno-1-29\"></a><span class=\"w\">  </span><span class=\"n\">red_buf0</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">in_thread_C_local</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">];</span>\n<a id=\"__codelineno-1-30\" name=\"__codelineno-1-30\"></a><span class=\"w\">  </span><span class=\"cp\">#pragma unroll</span>\n<a id=\"__codelineno-1-31\" name=\"__codelineno-1-31\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">K_block_size</span><span class=\"o\">/</span><span class=\"mi\">2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"o\">/=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-32\" name=\"__codelineno-1-32\"></a><span class=\"w\">    </span><span class=\"n\">red_buf0</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"n\">__shfl_down_sync</span><span class=\"p\">(</span><span class=\"n\">__activemask</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">red_buf0</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">K_block_size</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-33\" name=\"__codelineno-1-33\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-1-34\" name=\"__codelineno-1-34\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">out_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">((((</span><span class=\"kt\">int</span><span class=\"p\">)</span><span class=\"n\">blockIdx</span><span class=\"p\">.</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">N_block_size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">int</span><span class=\"p\">)</span><span class=\"n\">threadIdx</span><span class=\"p\">.</span><span class=\"n\">y</span><span class=\"p\">));</span>\n<a id=\"__codelineno-1-35\" name=\"__codelineno-1-35\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">ws_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">out_idx</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">ws_num</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-36\" name=\"__codelineno-1-36\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">threadIdx</span><span class=\"p\">.</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n<a id=\"__codelineno-1-37\" name=\"__codelineno-1-37\"></a><span class=\"w\">    </span><span class=\"n\">dtype_transform</span><span class=\"p\">[</span><span class=\"n\">out_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__nv_bfloat16</span><span class=\"p\">)(((</span><span class=\"kt\">float</span><span class=\"p\">)</span><span class=\"n\">red_buf0</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span><span class=\"o\">/</span><span class=\"p\">(</span><span class=\"kt\">float</span><span class=\"p\">)</span><span class=\"n\">s</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"kt\">float</span><span class=\"p\">)</span><span class=\"n\">ws</span><span class=\"p\">[</span><span class=\"n\">ws_idx</span><span class=\"p\">]);</span>\n<a id=\"__codelineno-1-38\" name=\"__codelineno-1-38\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u81ea\u5b9a\u4e49kernel NVIDIA GeForce RTX 4050\u6027\u80fd\u6d4b\u8bd5\u8fd0\u884c\u7ed3\u679c\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Text Only</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-16\">16</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a>custom == np True\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a>Shape(2560, 2560), W2A8: 54.40us, torch BF16: 73.39us\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a>custom == np True\n<a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a>Shape(3840, 2560), W2A8: 22.66us, torch BF16: 75.50us\n<a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\"></a>custom == np True\n<a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\"></a>Shape(13824, 2560), W2A8: 39.99us, torch BF16: 364.94us\n<a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\"></a>custom == np True\n<a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\"></a>Shape(2560, 6912), W2A8: 48.95us, torch BF16: 221.11us\n<a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\"></a>custom == np True\n<a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\"></a>Shape(3200, 3200), W2A8: 45.98us, torch BF16: 128.34us\n<a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\"></a>custom == np True\n<a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\"></a>Shape(4800, 3200), W2A8: 25.54us, torch BF16: 171.50us\n<a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\"></a>custom == np True\n<a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\"></a>Shape(3200, 10240), W2A8: 37.18us, torch BF16: 342.03us\n<a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\"></a>custom == np True\n<a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\"></a>Shape(20480, 3200), W2A8: 74.29us, torch BF16: 805.49us\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"cpu\u7248\u672c\u63a8\u7406\">cpu\u7248\u672c\u63a8\u7406<a class=\"headerlink\" href=\"#cpu\u7248\u672c\u63a8\u7406\" title=\"Permanent link\">&para;</a></h3>\n<p>cpu\u63a8\u7406\u57fa\u4e8ellama.cpp\u9879\u76ee\uff0c\u91c7\u7528T-MAC(\u67e5\u627e\u8868)\u7b97\u6cd5\u63d0\u9ad8\u4e86\u63a8\u7406\u6027\u80fd\u3002</p>\n<p>\u4f20\u7edf\u65b9\u5f0f\uff0c\u9700\u8981\u628a\u6743\u91cd\u53cd\u91cf\u5316\u4e3a\u6d6e\u70b9\u6570\uff0c\u7136\u540e\u548c\u6fc0\u6d3b\u8fdb\u884c\u8ba1\u7b97\u3002\u91c7\u7528\u67e5\u627e\u8868\u5c31\u662f\uff0c\u628a1bit\u7684\u5404\u79cd\u8ba1\u7b97\u53ef\u80fd\u63d0\u524d\u8ba1\u7b97\u597d\u5b58\u50a8\u5230\u4e00\u4e2a\u67e5\u627e\u8868\u4e2d\uff0c\u7136\u540e\u901a\u8fc7\u7d22\u5f15\u8fdb\u884c\u67e5\u627e\u5b8c\u6210\u8ba1\u7b97\u3002</p>\n<h4 id=\"simd\u8ba1\u7b97int2\u548cint8\u7684\u5411\u91cf\u70b9\u79ef\">SIMD\u8ba1\u7b97int2\u548cint8\u7684\u5411\u91cf\u70b9\u79ef<a class=\"headerlink\" href=\"#simd\u8ba1\u7b97int2\u548cint8\u7684\u5411\u91cf\u70b9\u79ef\" title=\"Permanent link\">&para;</a></h4>\n<p>bitnet\u7684\u5b9e\u73b0\u5206\u4e3aintel\u7684AVX \u548c ARM \u7684 neon \u6307\u4ee4\uff0c \u8fd9\u91cc\u5bf9<a href=\"https://github.com/microsoft/BitNet/blob/main/src/ggml-bitnet-mad.cpp\">AVX\u6307\u4ee4\u7248\u672c</a>\u8fdb\u884c\u4ecb\u7ecd\u3002</p>\n<p>\u5c06\u91cf\u5316\u540e\u7684 i2 \u6570\u636e\u4e0e i8 \u6570\u636e\u505a\u70b9\u79ef\uff0c\u5229\u7528\u5e73\u53f0 SIMD \u6307\u4ee4\u505a\u5e76\u884c\u52a0\u901f\u3002\n\u4e3a\u4e86\u9ad8\u6548\u5904\u7406\uff0c\u6570\u636e\u6309\u7ec4\u5206\u5757\uff0c\u6bcf\u7ec4\u505a\u5e76\u884c\u5904\u7406\uff0c\u6700\u540e\u5408\u5e76\u7ed3\u679c\u3002\n\u9488\u5bf9\u4e0d\u540c\u5e73\u53f0\u5206\u522b\u4f18\u5316\uff08AVX2/NEON\uff09\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-7\">7</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">each</span><span class=\"w\"> </span><span class=\"n\">block</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"n\">groups</span><span class=\"o\">:</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">each</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">block</span><span class=\"o\">:</span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a><span class=\"w\">        </span><span class=\"mf\">1.</span><span class=\"w\"> </span><span class=\"n\">\u63d0\u53d62</span><span class=\"o\">-</span><span class=\"n\">bit\u6570\u636e</span>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a><span class=\"w\">        </span><span class=\"mf\">2.</span><span class=\"w\"> </span><span class=\"n\">\u8f7d\u51658</span><span class=\"o\">-</span><span class=\"n\">bit\u6570\u636e</span>\n<a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\"></a><span class=\"w\">        </span><span class=\"mf\">3.</span><span class=\"w\"> </span><span class=\"n\">\u505a\u4e58\u6cd5\u7d2f\u52a0</span><span class=\"err\">\uff08</span><span class=\"n\">SIMD\u5e76\u884c</span><span class=\"err\">\uff09</span>\n<a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\"></a><span class=\"w\">    </span><span class=\"n\">\u7d2f\u52a0\u6240\u6709\u7ec4\u7684\u7ed3\u679c</span>\n<a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\"></a><span class=\"n\">\u6700\u540e\u5408\u5e76\u6240\u6709\u5757\u7684\u7ed3\u679c</span><span class=\"err\">\uff0c</span><span class=\"n\">\u8f93\u51fa\u70b9\u79ef</span>\n</code></pre></div></td></tr></table></div></p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\">  1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\">  2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-3\">  3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-4\">  4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-5\">  5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-6\">  6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-7\">  7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-8\">  8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-9\">  9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-10\"> 10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-11\"> 11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-12\"> 12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-13\"> 13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-14\"> 14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-15\"> 15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-16\"> 16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-17\"> 17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-18\"> 18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-19\"> 19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-20\"> 20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-21\"> 21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-22\"> 22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-23\"> 23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-24\"> 24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-25\"> 25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-26\"> 26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-27\"> 27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-28\"> 28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-29\"> 29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-30\"> 30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-31\"> 31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-32\"> 32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-33\"> 33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-34\"> 34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-35\"> 35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-36\"> 36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-37\"> 37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-38\"> 38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-39\"> 39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-40\"> 40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-41\"> 41</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-42\"> 42</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-43\"> 43</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-44\"> 44</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-45\"> 45</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-46\"> 46</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-47\"> 47</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-48\"> 48</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-49\"> 49</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-50\"> 50</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-51\"> 51</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-52\"> 52</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-53\"> 53</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-54\"> 54</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-55\"> 55</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-56\"> 56</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-57\"> 57</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-58\"> 58</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-59\"> 59</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-60\"> 60</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-61\"> 61</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-62\"> 62</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-63\"> 63</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-64\"> 64</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-65\"> 65</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-66\"> 66</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-67\"> 67</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-68\"> 68</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-69\"> 69</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-70\"> 70</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-71\"> 71</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-72\"> 72</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-73\"> 73</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-74\"> 74</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-75\"> 75</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-76\"> 76</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-77\"> 77</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-78\"> 78</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-79\"> 79</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-80\"> 80</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-81\"> 81</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-82\"> 82</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-83\"> 83</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-84\"> 84</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-85\"> 85</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-86\"> 86</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-87\"> 87</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-88\"> 88</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-89\"> 89</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-90\"> 90</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-91\"> 91</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-92\"> 92</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-93\"> 93</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-94\"> 94</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-95\"> 95</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-96\"> 96</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-97\"> 97</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-98\"> 98</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-99\"> 99</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-100\">100</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-101\">101</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-102\">102</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-103\">103</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-104\">104</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-105\">105</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-106\">106</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-107\">107</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-108\">108</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-109\">109</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-110\">110</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-111\">111</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-112\">112</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-113\">113</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-114\">114</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-115\">115</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-116\">116</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-117\">117</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-118\">118</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-119\">119</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-120\">120</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-121\">121</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-122\">122</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-123\">123</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-124\">124</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-125\">125</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-126\">126</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-127\">127</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-128\">128</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-129\">129</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-130\">130</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-131\">131</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-132\">132</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-133\">133</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-134\">134</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-135\">135</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-136\">136</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-137\">137</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-138\">138</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-139\">139</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-140\">140</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-141\">141</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-142\">142</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-143\">143</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-144\">144</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-145\">145</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-146\">146</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-147\">147</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-148\">148</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-149\">149</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-150\">150</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-151\">151</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-152\">152</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-153\">153</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-154\">154</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-155\">155</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-156\">156</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-157\">157</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-158\">158</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-159\">159</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-160\">160</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-161\">161</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-162\">162</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-163\">163</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-164\">164</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-165\">165</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-166\">166</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-167\">167</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-168\">168</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-169\">169</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-170\">170</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-171\">171</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-172\">172</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-173\">173</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-174\">174</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-175\">175</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-176\">176</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-177\">177</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-178\">178</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-179\">179</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-180\">180</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-181\">181</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-182\">182</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-183\">183</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-184\">184</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-185\">185</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-186\">186</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-187\">187</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-188\">188</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-189\">189</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-190\">190</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-191\">191</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-192\">192</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-193\">193</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-194\">194</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-195\">195</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-196\">196</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-197\">197</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-198\">198</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-199\">199</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-200\">200</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-201\">201</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-202\">202</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-203\">203</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-204\">204</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-205\">205</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-206\">206</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-207\">207</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-208\">208</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-209\">209</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-210\">210</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-211\">211</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-212\">212</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-213\">213</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-214\">214</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-215\">215</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-216\">216</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-217\">217</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-218\">218</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-219\">219</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-220\">220</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-221\">221</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-222\">222</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-223\">223</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-224\">224</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-225\">225</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-226\">226</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-227\">227</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-228\">228</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-229\">229</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-230\">230</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-231\">231</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-232\">232</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-233\">233</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-234\">234</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-235\">235</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-236\">236</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-237\">237</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-238\">238</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-239\">239</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-240\">240</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-241\">241</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-242\">242</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-243\">243</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-244\">244</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-245\">245</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-246\">246</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a><span class=\"c1\">// 1. \u521d\u59cb\u5316\u63a9\u7801\u548c\u7d2f\u52a0\u5668</span>\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a><span class=\"c1\">// mask = _mm256_set1_epi8(0x03); \u7528\u4e8e\u63d0\u53d62-bit\u6570\u636e\u3002</span>\n<a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\"></a><span class=\"c1\">// accu = _mm256_setzero_si256(); \u7528\u4e8e\u7d2f\u52a0\u7ed3\u679c\u3002</span>\n<a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\"></a><span class=\"c1\">// 2. \u5206\u7ec4\u5904\u7406</span>\n<a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\"></a><span class=\"c1\">// \u5916\u5c42\u5faa\u73af\uff1a\u6bcf\u6b21\u5904\u740632\u7ec4\u3002</span>\n<a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\"></a><span class=\"c1\">// \u5185\u5c42\u5faa\u73af\uff1a\u904d\u5386\u6bcf\u7ec4\u4e2d\u768432\u4e2a\u5143\u7d20\u3002</span>\n<a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\"></a><span class=\"c1\">// \u5bf9\u6bcf\u4e00\u7ec4\u6570\u636e\uff0c\u5206\u522b\u53d6\u51fa2-bit\u5e76\u4e0e8-bit\u6570\u636e\u505a\u4e58\u6cd5\u7d2f\u52a0\uff08\u70b9\u79ef\uff09\u3002</span>\n<a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\"></a><span class=\"c1\">// 3. \u6570\u636e\u89e3\u7801</span>\n<a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\"></a><span class=\"c1\">// 2-bit\u6570\u636e\u62c6\u62104\u4e2abit\u7ec4\uff08shift\u548cmask\u64cd\u4f5c\uff09\u3002</span>\n<a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\"></a><span class=\"c1\">// 8-bit\u76f4\u63a5\u8f7d\u5165\u3002</span>\n<a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\"></a><span class=\"c1\">// \u4f7f\u7528 _mm256_maddubs_epi16 \u6307\u4ee4\u505a\u4e58\u6cd5\u7d2f\u52a0\u3002</span>\n<a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\"></a><span class=\"c1\">// 4. \u7d2f\u52a0\u6240\u6709\u7ed3\u679c</span>\n<a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\"></a><span class=\"c1\">// \u4f7f\u7528 _mm256_add_epi16 \u548c _mm256_add_epi32 \u6307\u4ee4\u5408\u5e76\u7ed3\u679c\u3002</span>\n<a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\"></a><span class=\"c1\">// \u6700\u540e\u7528 hsum_i32_8 \u5bf9 SIMD \u7d2f\u52a0\u7ed3\u679c\u6c42\u548c\uff0c\u5f97\u5230\u6700\u7ec8\u70b9\u79ef\u3002</span>\n<a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\"></a>\n<a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\"></a><span class=\"o\">*</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">float</span><span class=\"p\">)</span><span class=\"n\">sumi</span><span class=\"p\">;</span><span class=\"err\">\uff0c</span><span class=\"n\">\u5c06\u7ed3\u679c\u8d4b\u503c\u7ed9\u8f93\u51fa\u6307\u9488</span><span class=\"err\">\u3002</span>\n<a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\"></a>\n<a id=\"__codelineno-4-18\" name=\"__codelineno-4-18\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;vector&gt;</span>\n<a id=\"__codelineno-4-19\" name=\"__codelineno-4-19\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;type_traits&gt;</span>\n<a id=\"__codelineno-4-20\" name=\"__codelineno-4-20\"></a>\n<a id=\"__codelineno-4-21\" name=\"__codelineno-4-21\"></a><span class=\"c1\">// #include &quot;ggml-bitnet.h&quot;</span>\n<a id=\"__codelineno-4-22\" name=\"__codelineno-4-22\"></a><span class=\"c1\">// #include &quot;ggml-quants.h&quot;</span>\n<a id=\"__codelineno-4-23\" name=\"__codelineno-4-23\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cmath&gt;</span>\n<a id=\"__codelineno-4-24\" name=\"__codelineno-4-24\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cstring&gt;</span>\n<a id=\"__codelineno-4-25\" name=\"__codelineno-4-25\"></a>\n<a id=\"__codelineno-4-26\" name=\"__codelineno-4-26\"></a><span class=\"cp\">#define QK_I2_S 128</span>\n<a id=\"__codelineno-4-27\" name=\"__codelineno-4-27\"></a><span class=\"cp\">#define QK_I2 128</span>\n<a id=\"__codelineno-4-28\" name=\"__codelineno-4-28\"></a>\n<a id=\"__codelineno-4-29\" name=\"__codelineno-4-29\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;immintrin.h&gt;</span>\n<a id=\"__codelineno-4-30\" name=\"__codelineno-4-30\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cstdint&gt;</span>\n<a id=\"__codelineno-4-31\" name=\"__codelineno-4-31\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cstdio&gt;</span>\n<a id=\"__codelineno-4-32\" name=\"__codelineno-4-32\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;iostream&gt;</span>\n<a id=\"__codelineno-4-33\" name=\"__codelineno-4-33\"></a><span class=\"c1\">// horizontally add 8 int32_t</span>\n<a id=\"__codelineno-4-34\" name=\"__codelineno-4-34\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kr\">inline</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">hsum_i32_8</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-35\" name=\"__codelineno-4-35\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kr\">__m128i</span><span class=\"w\"> </span><span class=\"n\">sum128</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm_add_epi32</span><span class=\"p\">(</span><span class=\"n\">_mm256_castsi256_si128</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">_mm256_extractf128_si256</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-36\" name=\"__codelineno-4-36\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kr\">__m128i</span><span class=\"w\"> </span><span class=\"n\">hi64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm_unpackhi_epi64</span><span class=\"p\">(</span><span class=\"n\">sum128</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sum128</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-37\" name=\"__codelineno-4-37\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kr\">__m128i</span><span class=\"w\"> </span><span class=\"n\">sum64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm_add_epi32</span><span class=\"p\">(</span><span class=\"n\">hi64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sum128</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-38\" name=\"__codelineno-4-38\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kr\">__m128i</span><span class=\"w\"> </span><span class=\"n\">hi32</span><span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm_shuffle_epi32</span><span class=\"p\">(</span><span class=\"n\">sum64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_MM_SHUFFLE</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-39\" name=\"__codelineno-4-39\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">_mm_cvtsi128_si32</span><span class=\"p\">(</span><span class=\"n\">_mm_add_epi32</span><span class=\"p\">(</span><span class=\"n\">sum64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">hi32</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-40\" name=\"__codelineno-4-40\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-4-41\" name=\"__codelineno-4-41\"></a>\n<a id=\"__codelineno-4-42\" name=\"__codelineno-4-42\"></a>\n<a id=\"__codelineno-4-43\" name=\"__codelineno-4-43\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">print_m256i</span><span class=\"p\">(</span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">vec</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-44\" name=\"__codelineno-4-44\"></a><span class=\"w\">    </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">[</span><span class=\"mi\">32</span><span class=\"p\">];</span>\n<a id=\"__codelineno-4-45\" name=\"__codelineno-4-45\"></a><span class=\"w\">    </span><span class=\"n\">_mm256_storeu_si256</span><span class=\"p\">((</span><span class=\"n\">__m256i</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">bytes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vec</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-46\" name=\"__codelineno-4-46\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"n\">i</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-47\" name=\"__codelineno-4-47\"></a><span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;%02x &quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]);</span>\n<a id=\"__codelineno-4-48\" name=\"__codelineno-4-48\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-49\" name=\"__codelineno-4-49\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-4-50\" name=\"__codelineno-4-50\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-4-51\" name=\"__codelineno-4-51\"></a>\n<a id=\"__codelineno-4-52\" name=\"__codelineno-4-52\"></a><span class=\"c1\">// x \u6307\u5411 2-bit \u91cf\u5316\u6570\u636e\uff0cy \u6307\u5411 8-bit \u6570\u636e\u3002</span>\n<a id=\"__codelineno-4-53\" name=\"__codelineno-4-53\"></a><span class=\"c1\">// \u6570\u636e\u88ab\u5206\u6210\u591a\u4e2a\u7ec4\uff0c\u4fbf\u4e8e\u540e\u9762\u7684 SIMD \u5e76\u884c\u5904\u7406\u3002</span>\n<a id=\"__codelineno-4-54\" name=\"__codelineno-4-54\"></a><span class=\"c1\">// \u4e3b\u8981\u53d8\u91cf\uff1a</span>\n<a id=\"__codelineno-4-55\" name=\"__codelineno-4-55\"></a><span class=\"c1\">// QK_I2_S \u901a\u5e38\u4e3a 128\uff0c\u8868\u793a\u6bcf\u7ec4\u7684\u5143\u7d20\u6570\u3002</span>\n<a id=\"__codelineno-4-56\" name=\"__codelineno-4-56\"></a><span class=\"c1\">// nb = n / QK_I2_S\uff0c\u7ec4\u6570\u3002</span>\n<a id=\"__codelineno-4-57\" name=\"__codelineno-4-57\"></a><span class=\"c1\">// group32_num = nb / 32\uff0c\u6bcf 32 \u7ec4\u4e3a\u4e00\u5927\u7ec4\u3002</span>\n<a id=\"__codelineno-4-58\" name=\"__codelineno-4-58\"></a><span class=\"c1\">// la_num = nb % 32\uff0c\u5269\u4f59\u7ec4\u6570\u3002</span>\n<a id=\"__codelineno-4-59\" name=\"__codelineno-4-59\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">ggml_vec_dot_i2_i8_s</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">float</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">bs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">vx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">bx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">vy</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">nrc</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-60\" name=\"__codelineno-4-60\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">vx</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-61\" name=\"__codelineno-4-61\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">int8_t</span><span class=\"w\">  </span><span class=\"o\">*</span><span class=\"w\">    </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int8_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">vy</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-62\" name=\"__codelineno-4-62\"></a>\n<a id=\"__codelineno-4-63\" name=\"__codelineno-4-63\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">QK_I2_S</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-64\" name=\"__codelineno-4-64\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">group32_num</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-65\" name=\"__codelineno-4-65\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">la_num</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-66\" name=\"__codelineno-4-66\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">groupla_num</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-67\" name=\"__codelineno-4-67\"></a>\n<a id=\"__codelineno-4-68\" name=\"__codelineno-4-68\"></a><span class=\"w\">    </span><span class=\"c1\">// n : 128 nb : 1 group32_num : 0 la_num : 1 groupla_num : 1</span>\n<a id=\"__codelineno-4-69\" name=\"__codelineno-4-69\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">cout</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;n : &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<a id=\"__codelineno-4-70\" name=\"__codelineno-4-70\"></a><span class=\"w\">              </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot; nb : &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">nb</span>\n<a id=\"__codelineno-4-71\" name=\"__codelineno-4-71\"></a><span class=\"w\">              </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot; group32_num : &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">group32_num</span>\n<a id=\"__codelineno-4-72\" name=\"__codelineno-4-72\"></a><span class=\"w\">              </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot; la_num : &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">la_num</span>\n<a id=\"__codelineno-4-73\" name=\"__codelineno-4-73\"></a><span class=\"w\">              </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot; groupla_num : &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">groupla_num</span>\n<a id=\"__codelineno-4-74\" name=\"__codelineno-4-74\"></a><span class=\"w\">              </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-75\" name=\"__codelineno-4-75\"></a>\n<a id=\"__codelineno-4-76\" name=\"__codelineno-4-76\"></a><span class=\"w\">    </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">mask</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_set1_epi8</span><span class=\"p\">(</span><span class=\"mh\">0x03</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-77\" name=\"__codelineno-4-77\"></a><span class=\"w\">    </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">accu</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_setzero_si256</span><span class=\"p\">();</span>\n<a id=\"__codelineno-4-78\" name=\"__codelineno-4-78\"></a>\n<a id=\"__codelineno-4-79\" name=\"__codelineno-4-79\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">group32_num</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">){</span>\n<a id=\"__codelineno-4-80\" name=\"__codelineno-4-80\"></a><span class=\"w\">        </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">cout</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;i : &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-81\" name=\"__codelineno-4-81\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">accu32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_setzero_si256</span><span class=\"p\">();</span>\n<a id=\"__codelineno-4-82\" name=\"__codelineno-4-82\"></a><span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-83\" name=\"__codelineno-4-83\"></a><span class=\"w\">        </span><span class=\"c1\">// 128 index</span>\n<a id=\"__codelineno-4-84\" name=\"__codelineno-4-84\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">xq8_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_loadu_si256</span><span class=\"p\">((</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">__m256i</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-85\" name=\"__codelineno-4-85\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">xq8_2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_srli_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-86\" name=\"__codelineno-4-86\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">xq8_1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_srli_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-87\" name=\"__codelineno-4-87\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">xq8_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_srli_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-88\" name=\"__codelineno-4-88\"></a>\n<a id=\"__codelineno-4-89\" name=\"__codelineno-4-89\"></a><span class=\"w\">        </span><span class=\"c1\">// each 32 index</span>\n<a id=\"__codelineno-4-90\" name=\"__codelineno-4-90\"></a><span class=\"w\">        </span><span class=\"n\">xq8_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_and_si256</span><span class=\"p\">(</span><span class=\"n\">xq8_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mask</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-91\" name=\"__codelineno-4-91\"></a><span class=\"w\">        </span><span class=\"n\">xq8_2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_and_si256</span><span class=\"p\">(</span><span class=\"n\">xq8_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mask</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-92\" name=\"__codelineno-4-92\"></a><span class=\"w\">        </span><span class=\"n\">xq8_1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_and_si256</span><span class=\"p\">(</span><span class=\"n\">xq8_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mask</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-93\" name=\"__codelineno-4-93\"></a><span class=\"w\">        </span><span class=\"n\">xq8_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_and_si256</span><span class=\"p\">(</span><span class=\"n\">xq8_0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mask</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-94\" name=\"__codelineno-4-94\"></a>\n<a id=\"__codelineno-4-95\" name=\"__codelineno-4-95\"></a><span class=\"w\">        </span><span class=\"c1\">// each 32 index</span>\n<a id=\"__codelineno-4-96\" name=\"__codelineno-4-96\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">yq8_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_loadu_si256</span><span class=\"p\">((</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">__m256i</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-97\" name=\"__codelineno-4-97\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">yq8_1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_loadu_si256</span><span class=\"p\">((</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">__m256i</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-98\" name=\"__codelineno-4-98\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">yq8_2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_loadu_si256</span><span class=\"p\">((</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">__m256i</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-99\" name=\"__codelineno-4-99\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">yq8_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_loadu_si256</span><span class=\"p\">((</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">__m256i</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">96</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-100\" name=\"__codelineno-4-100\"></a>\n<a id=\"__codelineno-4-101\" name=\"__codelineno-4-101\"></a><span class=\"w\">        </span><span class=\"c1\">// 128 index accumulation add</span>\n<a id=\"__codelineno-4-102\" name=\"__codelineno-4-102\"></a><span class=\"w\">        </span><span class=\"c1\">// split into 32 accumulation block</span>\n<a id=\"__codelineno-4-103\" name=\"__codelineno-4-103\"></a><span class=\"w\">        </span><span class=\"c1\">// each block each 128 index accumulated 4index</span>\n<a id=\"__codelineno-4-104\" name=\"__codelineno-4-104\"></a><span class=\"w\">        </span><span class=\"c1\">// each index maximum 256</span>\n<a id=\"__codelineno-4-105\" name=\"__codelineno-4-105\"></a><span class=\"w\">        </span><span class=\"c1\">// each block maximum 4 * 256</span>\n<a id=\"__codelineno-4-106\" name=\"__codelineno-4-106\"></a><span class=\"w\">        </span><span class=\"c1\">// each block accumulation maximum 127 * 256</span>\n<a id=\"__codelineno-4-107\" name=\"__codelineno-4-107\"></a><span class=\"w\">        </span><span class=\"c1\">// each 32 group index (128 index in one group) needs cast to int32</span>\n<a id=\"__codelineno-4-108\" name=\"__codelineno-4-108\"></a><span class=\"w\">        </span><span class=\"n\">xq8_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_maddubs_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">yq8_0</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-109\" name=\"__codelineno-4-109\"></a><span class=\"w\">        </span><span class=\"n\">xq8_1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_maddubs_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">yq8_1</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-110\" name=\"__codelineno-4-110\"></a><span class=\"w\">        </span><span class=\"n\">xq8_2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_maddubs_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">yq8_2</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-111\" name=\"__codelineno-4-111\"></a><span class=\"w\">        </span><span class=\"n\">xq8_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_maddubs_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">yq8_3</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-112\" name=\"__codelineno-4-112\"></a>\n<a id=\"__codelineno-4-113\" name=\"__codelineno-4-113\"></a><span class=\"w\">        </span><span class=\"n\">accu32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_add_epi16</span><span class=\"p\">(</span><span class=\"n\">accu32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_mm256_add_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xq8_1</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-114\" name=\"__codelineno-4-114\"></a><span class=\"w\">        </span><span class=\"n\">accu32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_add_epi16</span><span class=\"p\">(</span><span class=\"n\">accu32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_mm256_add_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xq8_3</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-115\" name=\"__codelineno-4-115\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-4-116\" name=\"__codelineno-4-116\"></a><span class=\"w\">        </span><span class=\"n\">accu</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_add_epi32</span><span class=\"p\">(</span><span class=\"n\">_mm256_madd_epi16</span><span class=\"p\">(</span><span class=\"n\">accu32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_mm256_set1_epi16</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)),</span><span class=\"w\"> </span><span class=\"n\">accu</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-117\" name=\"__codelineno-4-117\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-4-118\" name=\"__codelineno-4-118\"></a>\n<a id=\"__codelineno-4-119\" name=\"__codelineno-4-119\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">groupla_num</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">){</span>\n<a id=\"__codelineno-4-120\" name=\"__codelineno-4-120\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">accula</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_setzero_si256</span><span class=\"p\">();</span>\n<a id=\"__codelineno-4-121\" name=\"__codelineno-4-121\"></a><span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">la_num</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-122\" name=\"__codelineno-4-122\"></a><span class=\"w\">        </span><span class=\"c1\">// 128 index</span>\n<a id=\"__codelineno-4-123\" name=\"__codelineno-4-123\"></a><span class=\"w\">        </span><span class=\"c1\">// \u4f8b\u5b50\u4e2d\u7684128\u4e2aint2\uff0c\u5206\u62104\u7ec4\uff0c\u6bcf\u7ec432\u4e2aint2</span>\n<a id=\"__codelineno-4-124\" name=\"__codelineno-4-124\"></a><span class=\"w\">        </span><span class=\"c1\">// 128\u4e2aint2</span>\n<a id=\"__codelineno-4-125\" name=\"__codelineno-4-125\"></a><span class=\"w\">        </span><span class=\"c1\">// xx1 xx2 xx3 xx4 xx5 xx6 xx7 xx8 (int 16)</span>\n<a id=\"__codelineno-4-126\" name=\"__codelineno-4-126\"></a><span class=\"w\">        </span><span class=\"c1\">// 00  xx1 xx2 xx3 xx4 xx5 xx6 xx7 (shift right 2bit)</span>\n<a id=\"__codelineno-4-127\" name=\"__codelineno-4-127\"></a><span class=\"w\">        </span><span class=\"c1\">// 00  00  xx1 xx2 xx3 xx4 xx5 xx6 (shift right 4bit)</span>\n<a id=\"__codelineno-4-128\" name=\"__codelineno-4-128\"></a><span class=\"w\">        </span><span class=\"c1\">// 00  00  00  xx1 xx2 xx3 xx4 xx5 (shift right 6bit)</span>\n<a id=\"__codelineno-4-129\" name=\"__codelineno-4-129\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">xq8_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_loadu_si256</span><span class=\"p\">((</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">__m256i</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">group32_num</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-130\" name=\"__codelineno-4-130\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">xq8_2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_srli_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-131\" name=\"__codelineno-4-131\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">xq8_1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_srli_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-132\" name=\"__codelineno-4-132\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">xq8_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_srli_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-133\" name=\"__codelineno-4-133\"></a>\n<a id=\"__codelineno-4-134\" name=\"__codelineno-4-134\"></a><span class=\"w\">        </span><span class=\"c1\">// each 32 index</span>\n<a id=\"__codelineno-4-135\" name=\"__codelineno-4-135\"></a><span class=\"w\">        </span><span class=\"c1\">// mask: 00000011 00000011</span>\n<a id=\"__codelineno-4-136\" name=\"__codelineno-4-136\"></a><span class=\"w\">        </span><span class=\"c1\">// --  --  --  xx4 -- -- -- xx8 (int 16)</span>\n<a id=\"__codelineno-4-137\" name=\"__codelineno-4-137\"></a><span class=\"w\">        </span><span class=\"c1\">// 00  --  --  xx3 -- -- -- xx7 (shift right 2bit)</span>\n<a id=\"__codelineno-4-138\" name=\"__codelineno-4-138\"></a><span class=\"w\">        </span><span class=\"c1\">// 00  00  --  xx2 -- -- -- xx6 (shift right 4bit)</span>\n<a id=\"__codelineno-4-139\" name=\"__codelineno-4-139\"></a><span class=\"w\">        </span><span class=\"c1\">// 00  00  00  xx1 -- -- -- xx5 (shift right 6bit)</span>\n<a id=\"__codelineno-4-140\" name=\"__codelineno-4-140\"></a><span class=\"w\">        </span><span class=\"c1\">// int2\u901a\u8fc7\u79fb\u52a8bit\u4f4d\u7f6e\u548cmask\uff0c\u62c6\u5206\u6210\u4e86int8\u8868\u793a\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u548cint8\u8fdb\u884c\u8fd0\u7b97\u4e86</span>\n<a id=\"__codelineno-4-141\" name=\"__codelineno-4-141\"></a><span class=\"w\">        </span><span class=\"n\">xq8_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_and_si256</span><span class=\"p\">(</span><span class=\"n\">xq8_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mask</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-142\" name=\"__codelineno-4-142\"></a><span class=\"w\">        </span><span class=\"n\">xq8_2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_and_si256</span><span class=\"p\">(</span><span class=\"n\">xq8_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mask</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-143\" name=\"__codelineno-4-143\"></a><span class=\"w\">        </span><span class=\"n\">xq8_1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_and_si256</span><span class=\"p\">(</span><span class=\"n\">xq8_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mask</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-144\" name=\"__codelineno-4-144\"></a><span class=\"w\">        </span><span class=\"n\">xq8_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_and_si256</span><span class=\"p\">(</span><span class=\"n\">xq8_0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mask</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-145\" name=\"__codelineno-4-145\"></a>\n<a id=\"__codelineno-4-146\" name=\"__codelineno-4-146\"></a>\n<a id=\"__codelineno-4-147\" name=\"__codelineno-4-147\"></a><span class=\"w\">        </span><span class=\"n\">print_m256i</span><span class=\"p\">(</span><span class=\"n\">xq8_3</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-148\" name=\"__codelineno-4-148\"></a><span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;-----</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-149\" name=\"__codelineno-4-149\"></a><span class=\"w\">        </span><span class=\"n\">print_m256i</span><span class=\"p\">(</span><span class=\"n\">xq8_2</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-150\" name=\"__codelineno-4-150\"></a><span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;-----</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-151\" name=\"__codelineno-4-151\"></a><span class=\"w\">        </span><span class=\"n\">print_m256i</span><span class=\"p\">(</span><span class=\"n\">xq8_1</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-152\" name=\"__codelineno-4-152\"></a><span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;-----</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-153\" name=\"__codelineno-4-153\"></a><span class=\"w\">        </span><span class=\"n\">print_m256i</span><span class=\"p\">(</span><span class=\"n\">xq8_0</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-154\" name=\"__codelineno-4-154\"></a><span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;-----</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-155\" name=\"__codelineno-4-155\"></a>\n<a id=\"__codelineno-4-156\" name=\"__codelineno-4-156\"></a><span class=\"w\">        </span><span class=\"c1\">// x\u4e2d\u7684int2\u6bcf\u95f4\u96944\u4e2a\u6570\u5b57\u4e3a\u4e00\u7ec4</span>\n<a id=\"__codelineno-4-157\" name=\"__codelineno-4-157\"></a><span class=\"w\">        </span><span class=\"c1\">// 03 03 03 03 03 03 03 03 03 03 03 03 03 03 03 03 </span>\n<a id=\"__codelineno-4-158\" name=\"__codelineno-4-158\"></a><span class=\"w\">        </span><span class=\"c1\">// 03 03 03 03 03 03 03 03 03 03 03 03 03 03 03 03 </span>\n<a id=\"__codelineno-4-159\" name=\"__codelineno-4-159\"></a><span class=\"w\">        </span><span class=\"c1\">// -----</span>\n<a id=\"__codelineno-4-160\" name=\"__codelineno-4-160\"></a><span class=\"w\">        </span><span class=\"c1\">// 02 02 02 02 02 02 02 02 02 02 02 02 02 02 02 02 </span>\n<a id=\"__codelineno-4-161\" name=\"__codelineno-4-161\"></a><span class=\"w\">        </span><span class=\"c1\">// 02 02 02 02 02 02 02 02 02 02 02 02 02 02 02 02 </span>\n<a id=\"__codelineno-4-162\" name=\"__codelineno-4-162\"></a><span class=\"w\">        </span><span class=\"c1\">// -----</span>\n<a id=\"__codelineno-4-163\" name=\"__codelineno-4-163\"></a><span class=\"w\">        </span><span class=\"c1\">// 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 </span>\n<a id=\"__codelineno-4-164\" name=\"__codelineno-4-164\"></a><span class=\"w\">        </span><span class=\"c1\">// 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 </span>\n<a id=\"__codelineno-4-165\" name=\"__codelineno-4-165\"></a><span class=\"w\">        </span><span class=\"c1\">// -----</span>\n<a id=\"__codelineno-4-166\" name=\"__codelineno-4-166\"></a><span class=\"w\">        </span><span class=\"c1\">// 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 </span>\n<a id=\"__codelineno-4-167\" name=\"__codelineno-4-167\"></a><span class=\"w\">        </span><span class=\"c1\">// 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span>\n<a id=\"__codelineno-4-168\" name=\"__codelineno-4-168\"></a>\n<a id=\"__codelineno-4-169\" name=\"__codelineno-4-169\"></a>\n<a id=\"__codelineno-4-170\" name=\"__codelineno-4-170\"></a><span class=\"w\">        </span><span class=\"c1\">// each 32 index</span>\n<a id=\"__codelineno-4-171\" name=\"__codelineno-4-171\"></a><span class=\"w\">        </span><span class=\"c1\">// \u4f8b\u5b50\u4e2d\u7684128\u4e2aint8\u6570\u636e\uff0c\u5206\u62104\u7ec4\uff0c\u6bcf\u7ec432\u4e2aint8\u6570\u636e</span>\n<a id=\"__codelineno-4-172\" name=\"__codelineno-4-172\"></a><span class=\"w\">        </span><span class=\"c1\">// xx1 xx2</span>\n<a id=\"__codelineno-4-173\" name=\"__codelineno-4-173\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">yq8_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_loadu_si256</span><span class=\"p\">((</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">__m256i</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">group32_num</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-174\" name=\"__codelineno-4-174\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">yq8_1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_loadu_si256</span><span class=\"p\">((</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">__m256i</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">group32_num</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-175\" name=\"__codelineno-4-175\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">yq8_2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_loadu_si256</span><span class=\"p\">((</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">__m256i</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">group32_num</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-176\" name=\"__codelineno-4-176\"></a><span class=\"w\">        </span><span class=\"n\">__m256i</span><span class=\"w\"> </span><span class=\"n\">yq8_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_loadu_si256</span><span class=\"p\">((</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">__m256i</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">group32_num</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">96</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-177\" name=\"__codelineno-4-177\"></a>\n<a id=\"__codelineno-4-178\" name=\"__codelineno-4-178\"></a><span class=\"w\">        </span><span class=\"n\">print_m256i</span><span class=\"p\">(</span><span class=\"n\">yq8_0</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-179\" name=\"__codelineno-4-179\"></a><span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;-----</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-180\" name=\"__codelineno-4-180\"></a><span class=\"w\">        </span><span class=\"n\">print_m256i</span><span class=\"p\">(</span><span class=\"n\">yq8_1</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-181\" name=\"__codelineno-4-181\"></a><span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;-----</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-182\" name=\"__codelineno-4-182\"></a><span class=\"w\">        </span><span class=\"n\">print_m256i</span><span class=\"p\">(</span><span class=\"n\">yq8_2</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-183\" name=\"__codelineno-4-183\"></a><span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;-----</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-184\" name=\"__codelineno-4-184\"></a><span class=\"w\">        </span><span class=\"n\">print_m256i</span><span class=\"p\">(</span><span class=\"n\">yq8_3</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-185\" name=\"__codelineno-4-185\"></a>\n<a id=\"__codelineno-4-186\" name=\"__codelineno-4-186\"></a><span class=\"w\">        </span><span class=\"c1\">// \u6309\u987a\u5e8f\u5b58\u50a8\uff0c\u76f8\u90bb\u768432\u4e2aint8\u4e3a\u4e00\u7ec4</span>\n<a id=\"__codelineno-4-187\" name=\"__codelineno-4-187\"></a><span class=\"w\">        </span><span class=\"c1\">// -----</span>\n<a id=\"__codelineno-4-188\" name=\"__codelineno-4-188\"></a><span class=\"w\">        </span><span class=\"c1\">// 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f </span>\n<a id=\"__codelineno-4-189\" name=\"__codelineno-4-189\"></a><span class=\"w\">        </span><span class=\"c1\">// 10 11 12 13 14 15 16 17 18 19 1a 1b 1c 1d 1e 1f </span>\n<a id=\"__codelineno-4-190\" name=\"__codelineno-4-190\"></a><span class=\"w\">        </span><span class=\"c1\">// -----</span>\n<a id=\"__codelineno-4-191\" name=\"__codelineno-4-191\"></a><span class=\"w\">        </span><span class=\"c1\">// 20 21 22 23 24 25 26 27 28 29 2a 2b 2c 2d 2e 2f </span>\n<a id=\"__codelineno-4-192\" name=\"__codelineno-4-192\"></a><span class=\"w\">        </span><span class=\"c1\">// 30 31 32 33 34 35 36 37 38 39 3a 3b 3c 3d 3e 3f </span>\n<a id=\"__codelineno-4-193\" name=\"__codelineno-4-193\"></a><span class=\"w\">        </span><span class=\"c1\">// -----</span>\n<a id=\"__codelineno-4-194\" name=\"__codelineno-4-194\"></a><span class=\"w\">        </span><span class=\"c1\">// 40 41 42 43 44 45 46 47 48 49 4a 4b 4c 4d 4e 4f </span>\n<a id=\"__codelineno-4-195\" name=\"__codelineno-4-195\"></a><span class=\"w\">        </span><span class=\"c1\">// 50 51 52 53 54 55 56 57 58 59 5a 5b 5c 5d 5e 5f </span>\n<a id=\"__codelineno-4-196\" name=\"__codelineno-4-196\"></a><span class=\"w\">        </span><span class=\"c1\">// -----</span>\n<a id=\"__codelineno-4-197\" name=\"__codelineno-4-197\"></a><span class=\"w\">        </span><span class=\"c1\">// 60 61 62 63 64 65 66 67 68 69 6a 6b 6c 6d 6e 6f </span>\n<a id=\"__codelineno-4-198\" name=\"__codelineno-4-198\"></a><span class=\"w\">        </span><span class=\"c1\">// 70 71 72 73 74 75 76 77 78 79 7a 7b 7c 7d 7e 7f</span>\n<a id=\"__codelineno-4-199\" name=\"__codelineno-4-199\"></a>\n<a id=\"__codelineno-4-200\" name=\"__codelineno-4-200\"></a>\n<a id=\"__codelineno-4-201\" name=\"__codelineno-4-201\"></a><span class=\"w\">        </span><span class=\"c1\">// 128 index accumulation add</span>\n<a id=\"__codelineno-4-202\" name=\"__codelineno-4-202\"></a><span class=\"w\">        </span><span class=\"c1\">// split into 32 accumulation block</span>\n<a id=\"__codelineno-4-203\" name=\"__codelineno-4-203\"></a><span class=\"w\">        </span><span class=\"c1\">// each block each 128 index accumulated 4index</span>\n<a id=\"__codelineno-4-204\" name=\"__codelineno-4-204\"></a><span class=\"w\">        </span><span class=\"c1\">// each index maximum 256</span>\n<a id=\"__codelineno-4-205\" name=\"__codelineno-4-205\"></a><span class=\"w\">        </span><span class=\"c1\">// each block maximum 4 * 256</span>\n<a id=\"__codelineno-4-206\" name=\"__codelineno-4-206\"></a><span class=\"w\">        </span><span class=\"c1\">// each block accumulation maximum 127 * 256</span>\n<a id=\"__codelineno-4-207\" name=\"__codelineno-4-207\"></a><span class=\"w\">        </span><span class=\"c1\">// each 32 group index (128 index in one group) needs cast to int32</span>\n<a id=\"__codelineno-4-208\" name=\"__codelineno-4-208\"></a><span class=\"w\">        </span><span class=\"c1\">// \u4e58\u52a0\u8fd0\u7b97</span>\n<a id=\"__codelineno-4-209\" name=\"__codelineno-4-209\"></a><span class=\"w\">        </span><span class=\"c1\">// xx1, xx5 (16bit)</span>\n<a id=\"__codelineno-4-210\" name=\"__codelineno-4-210\"></a><span class=\"w\">        </span><span class=\"c1\">// yy1, yy2 (16bit)</span>\n<a id=\"__codelineno-4-211\" name=\"__codelineno-4-211\"></a><span class=\"w\">        </span><span class=\"c1\">// res = xx1 * yy1  + xx5 * yy2</span>\n<a id=\"__codelineno-4-212\" name=\"__codelineno-4-212\"></a><span class=\"w\">        </span><span class=\"n\">xq8_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_maddubs_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">yq8_0</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-213\" name=\"__codelineno-4-213\"></a><span class=\"w\">        </span><span class=\"n\">xq8_1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_maddubs_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">yq8_1</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-214\" name=\"__codelineno-4-214\"></a><span class=\"w\">        </span><span class=\"n\">xq8_2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_maddubs_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">yq8_2</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-215\" name=\"__codelineno-4-215\"></a><span class=\"w\">        </span><span class=\"n\">xq8_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_maddubs_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">yq8_3</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-216\" name=\"__codelineno-4-216\"></a>\n<a id=\"__codelineno-4-217\" name=\"__codelineno-4-217\"></a><span class=\"w\">        </span><span class=\"c1\">// printf(&quot;-----\\n&quot;);</span>\n<a id=\"__codelineno-4-218\" name=\"__codelineno-4-218\"></a><span class=\"w\">        </span><span class=\"c1\">// print_m256i(xq8_3);</span>\n<a id=\"__codelineno-4-219\" name=\"__codelineno-4-219\"></a><span class=\"w\">        </span><span class=\"c1\">// printf(&quot;-----\\n&quot;);</span>\n<a id=\"__codelineno-4-220\" name=\"__codelineno-4-220\"></a><span class=\"w\">        </span><span class=\"c1\">// print_m256i(xq8_2);</span>\n<a id=\"__codelineno-4-221\" name=\"__codelineno-4-221\"></a><span class=\"w\">        </span><span class=\"c1\">// printf(&quot;-----\\n&quot;);\u3001</span>\n<a id=\"__codelineno-4-222\" name=\"__codelineno-4-222\"></a><span class=\"w\">        </span><span class=\"c1\">// \u6253\u5370\u7b2c1\u7ec4\u4e58\u52a0\u8ba1\u7b97\u7ed3\u679c</span>\n<a id=\"__codelineno-4-223\" name=\"__codelineno-4-223\"></a><span class=\"w\">        </span><span class=\"n\">print_m256i</span><span class=\"p\">(</span><span class=\"n\">xq8_1</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-224\" name=\"__codelineno-4-224\"></a><span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;-----</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-225\" name=\"__codelineno-4-225\"></a><span class=\"w\">        </span><span class=\"c1\">// print_m256i(xq8_0);</span>\n<a id=\"__codelineno-4-226\" name=\"__codelineno-4-226\"></a><span class=\"w\">        </span><span class=\"c1\">// printf(&quot;-----\\n&quot;);</span>\n<a id=\"__codelineno-4-227\" name=\"__codelineno-4-227\"></a>\n<a id=\"__codelineno-4-228\" name=\"__codelineno-4-228\"></a>\n<a id=\"__codelineno-4-229\" name=\"__codelineno-4-229\"></a><span class=\"w\">        </span><span class=\"c1\">// 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 </span>\n<a id=\"__codelineno-4-230\" name=\"__codelineno-4-230\"></a><span class=\"w\">        </span><span class=\"c1\">// 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01</span>\n<a id=\"__codelineno-4-231\" name=\"__codelineno-4-231\"></a><span class=\"w\">        </span><span class=\"c1\">// \u4e58\u52a0\u8ba1\u7b97</span>\n<a id=\"__codelineno-4-232\" name=\"__codelineno-4-232\"></a><span class=\"w\">        </span><span class=\"c1\">// 20 21 22 23 24 25 26 27 28 29 2a 2b 2c 2d 2e 2f </span>\n<a id=\"__codelineno-4-233\" name=\"__codelineno-4-233\"></a><span class=\"w\">        </span><span class=\"c1\">// 30 31 32 33 34 35 36 37 38 39 3a 3b 3c 3d 3e 3f</span>\n<a id=\"__codelineno-4-234\" name=\"__codelineno-4-234\"></a><span class=\"w\">        </span><span class=\"c1\">// \u7ed3\u679c</span>\n<a id=\"__codelineno-4-235\" name=\"__codelineno-4-235\"></a><span class=\"w\">        </span><span class=\"c1\">// 41 00 45 00 49 00 4d 00 51 00 55 00 59 00 5d 00 </span>\n<a id=\"__codelineno-4-236\" name=\"__codelineno-4-236\"></a><span class=\"w\">        </span><span class=\"c1\">// 61 00 65 00 69 00 6d 00 71 00 75 00 79 00 7d 00</span>\n<a id=\"__codelineno-4-237\" name=\"__codelineno-4-237\"></a>\n<a id=\"__codelineno-4-238\" name=\"__codelineno-4-238\"></a>\n<a id=\"__codelineno-4-239\" name=\"__codelineno-4-239\"></a><span class=\"w\">        </span><span class=\"n\">accula</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_add_epi16</span><span class=\"p\">(</span><span class=\"n\">accula</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_mm256_add_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xq8_1</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-240\" name=\"__codelineno-4-240\"></a><span class=\"w\">        </span><span class=\"n\">accula</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_add_epi16</span><span class=\"p\">(</span><span class=\"n\">accula</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_mm256_add_epi16</span><span class=\"p\">(</span><span class=\"n\">xq8_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xq8_3</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-241\" name=\"__codelineno-4-241\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-4-242\" name=\"__codelineno-4-242\"></a><span class=\"w\">        </span><span class=\"n\">accu</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_mm256_add_epi32</span><span class=\"p\">(</span><span class=\"n\">accu</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_mm256_madd_epi16</span><span class=\"p\">(</span><span class=\"n\">accula</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_mm256_set1_epi16</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)));</span>\n<a id=\"__codelineno-4-243\" name=\"__codelineno-4-243\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-4-244\" name=\"__codelineno-4-244\"></a><span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">sumi</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">hsum_i32_8</span><span class=\"p\">(</span><span class=\"n\">accu</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-245\" name=\"__codelineno-4-245\"></a><span class=\"w\">    </span><span class=\"o\">*</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">float</span><span class=\"p\">)</span><span class=\"n\">sumi</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-246\" name=\"__codelineno-4-246\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n\u6d4b\u8bd5\u4ee3\u7801\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-39\">39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-40\">40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-41\">41</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-42\">42</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-43\">43</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-44\">44</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-45\">45</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a><span class=\"c1\">// g++ int2_int8.cpp  -mavx2</span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a><span class=\"c1\">// cat /proc/cpuinfo | grep avx</span>\n<a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span>\n<a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\"></a><span class=\"p\">{</span>\n<a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\"></a><span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">is_debug</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\"></a>\n<a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\"></a><span class=\"w\">    </span><span class=\"c1\">// \u8bbe\u5b9a\u5411\u91cf\u957f\u5ea6\u4e3a128\uff08\u4e00\u4e2ablock\uff09</span>\n<a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\"></a><span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">QK_I2_S</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\"></a><span class=\"w\">    </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">i2_data</span><span class=\"p\">[</span><span class=\"n\">QK_I2_S</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">];</span><span class=\"w\"> </span><span class=\"c1\">// \u6bcf4\u4e2a2bit\u538b\u7f29\u62101\u5b57\u8282\uff0c128\u4e2aint2, \u4e5f\u5c31\u662f_mm256_loadu_si256\u4e00\u6b21load256bit\uff0c\u8981load 1\u6b21\uff0c\u4e00\u6b21load 128\u4e2aint2\u6570\u5b57\uff0c\u518d\u901a\u8fc7\u504f\u79fb\u91cf\u5206\u621032\u4e2aint2\u4e00\u7ec4\uff0c\u5206\u62104\u7ec4</span>\n<a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\"></a><span class=\"w\">    </span><span class=\"kt\">int8_t</span><span class=\"w\"> </span><span class=\"n\">i8_data</span><span class=\"p\">[</span><span class=\"n\">QK_I2_S</span><span class=\"p\">];</span><span class=\"w\"> </span><span class=\"c1\">// 128\u4e2aint8\uff0c\u4e5f\u5c31\u662f_mm256_loadu_si256\u4e00\u6b21load256bit,\u8981load 4\u6b21\uff0c\u6bcf\u6b21load32\u4e2aint8\u6570\u5b57</span>\n<a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\"></a>\n<a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\"></a><span class=\"w\">    </span><span class=\"c1\">// _mm256_maddubs_epi16\u5c31\u53ef\u4ee5\u4e00\u6b21\u8ba1\u7b9732\u4e2aint8\u6570\u5b57\u548cint2\u6570\u5b57</span>\n<a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\"></a>\n<a id=\"__codelineno-5-14\" name=\"__codelineno-5-14\"></a><span class=\"w\">    </span><span class=\"c1\">// \u6784\u9020\u7b80\u5355\u6570\u636e\uff1ai2\u5168\u90e8\u4e3a1\uff0ci8\u5168\u90e8\u4e3a1</span>\n<a id=\"__codelineno-5-15\" name=\"__codelineno-5-15\"></a><span class=\"w\">    </span><span class=\"c1\">// 2bit\u7f16\u7801\uff1a2bit\u53ef\u8868\u793a4\u79cd\u72b6\u6001\uff0800, 01, 10, 11\uff09\uff0c\u82e5\u91c7\u7528\u5e26\u7b26\u53f7\u6574\u6570\u8868\u793a\uff0c\u8303\u56f4\u4e3a-2\u52301\uff1b\u65e0\u7b26\u53f7\u6574\u6570\u8303\u56f4\u4e3a0\u52303</span>\n<a id=\"__codelineno-5-16\" name=\"__codelineno-5-16\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">QK_I2_S</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"n\">i</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-17\" name=\"__codelineno-5-17\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">is_debug</span><span class=\"p\">){</span>\n<a id=\"__codelineno-5-18\" name=\"__codelineno-5-18\"></a><span class=\"w\">            </span><span class=\"c1\">// \u6bcf\u5b57\u8282\u586b\u5145\u4e3a 0x55 (01010101) \u5373\u6bcf\u4e2a2bit\u4e3a&quot;1&quot;</span>\n<a id=\"__codelineno-5-19\" name=\"__codelineno-5-19\"></a><span class=\"w\">            </span><span class=\"n\">i2_data</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x55</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-20\" name=\"__codelineno-5-20\"></a><span class=\"w\">        </span><span class=\"p\">}</span><span class=\"k\">else</span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-21\" name=\"__codelineno-5-21\"></a><span class=\"w\">            </span><span class=\"c1\">// 00 01 10 11</span>\n<a id=\"__codelineno-5-22\" name=\"__codelineno-5-22\"></a><span class=\"w\">            </span><span class=\"n\">i2_data</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x1B</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-23\" name=\"__codelineno-5-23\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-24\" name=\"__codelineno-5-24\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-25\" name=\"__codelineno-5-25\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">QK_I2_S</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"n\">i</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-26\" name=\"__codelineno-5-26\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">is_debug</span><span class=\"p\">){</span>\n<a id=\"__codelineno-5-27\" name=\"__codelineno-5-27\"></a><span class=\"w\">            </span><span class=\"n\">i8_data</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-28\" name=\"__codelineno-5-28\"></a><span class=\"w\">        </span><span class=\"p\">}</span><span class=\"k\">else</span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-29\" name=\"__codelineno-5-29\"></a><span class=\"w\">            </span><span class=\"n\">i8_data</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-30\" name=\"__codelineno-5-30\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-31\" name=\"__codelineno-5-31\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-32\" name=\"__codelineno-5-32\"></a>\n<a id=\"__codelineno-5-33\" name=\"__codelineno-5-33\"></a><span class=\"w\">    </span><span class=\"kt\">float</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0f</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-34\" name=\"__codelineno-5-34\"></a><span class=\"w\">    </span><span class=\"n\">ggml_vec_dot_i2_i8_s</span><span class=\"p\">(</span><span class=\"n\">n</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i2_data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i8_data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<a id=\"__codelineno-5-35\" name=\"__codelineno-5-35\"></a>\n<a id=\"__codelineno-5-36\" name=\"__codelineno-5-36\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">cout</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;\u6d4b\u8bd5\u7ed3\u679c: &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-37\" name=\"__codelineno-5-37\"></a>\n<a id=\"__codelineno-5-38\" name=\"__codelineno-5-38\"></a><span class=\"w\">    </span><span class=\"c1\">// \u7406\u8bba\u4e0a\uff0c\u5982\u679ci2\u90fd\u89e3\u7801\u4e3a1\uff0ci8\u90fd\u4e3a1\uff0c\u70b9\u79ef\u5e94\u4e3a128</span>\n<a id=\"__codelineno-5-39\" name=\"__codelineno-5-39\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mf\">128.0f</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-40\" name=\"__codelineno-5-40\"></a><span class=\"w\">        </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">cout</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;\u901a\u8fc7&quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-41\" name=\"__codelineno-5-41\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-42\" name=\"__codelineno-5-42\"></a><span class=\"w\">        </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">cout</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;\u672a\u901a\u8fc7&quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-43\" name=\"__codelineno-5-43\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-44\" name=\"__codelineno-5-44\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-45\" name=\"__codelineno-5-45\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u4ee3\u7801\u4f3c\u4e4e\u6ca1\u6709\u5b8c\u5168\u5f00\u6e90\uff0c\u6bd4\u5982\u6ca1\u6709\u5728\u4ee3\u7801\u4e2d\u770b\u5230\u5982\u4e0b\u5185\u5bb9\uff1a\n+ T-MAC\u7684\u5b9e\u73b0\u548c\u5e94\u7528\uff1f\n+ ggml_vec_dot_i2_i8_s\u5982\u4f55\u88ab\u8c03\u7528\u4e0a\u7684\uff1f</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c20\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8e\u5c5e\u6027\u6d4b\u8bd5\u7684quickcheck-cpp\u5e93/\" target=\"_blank\">C++20\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8e\u5c5e\u6027\u6d4b\u8bd5\u7684quickcheck-cpp\u5e93</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898/\" target=\"_blank\">C++\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-08-24T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/%E4%B8%A4%E7%A7%8D%E4%B8%8D%E5%90%8C%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5%E7%9A%84%E8%A7%A3%E6%9E%90%E5%BA%93nom%E5%92%8Cpest/",
            "url": "https://github.com/KenForever1/blog/%E4%B8%A4%E7%A7%8D%E4%B8%8D%E5%90%8C%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5%E7%9A%84%E8%A7%A3%E6%9E%90%E5%BA%93nom%E5%92%8Cpest/",
            "title": "\u4e24\u79cd\u4e0d\u540c\u8bbe\u8ba1\u7406\u5ff5\u7684\u89e3\u6790\u5e93nom\u548cpest",
            "content_html": "<!-- more -->\n\n<h2 id=\"nom\u548cpest\u89e3\u6790\u5e93\u8bbe\u8ba1\">nom\u548cpest\u89e3\u6790\u5e93\u8bbe\u8ba1<a class=\"headerlink\" href=\"#nom\u548cpest\u89e3\u6790\u5e93\u8bbe\u8ba1\" title=\"Permanent link\">&para;</a></h2>\n<p>nom \u548c pest\u65f6Rust \u751f\u6001\u4e2d\u4e24\u4e2a\u4e3b\u6d41\u7684\u89e3\u6790\u5e93\uff0c\u4f46\u662f\u8bbe\u8ba1\u7406\u5ff5\u548c\u4f7f\u7528\u65b9\u5f0f\u6709\u663e\u8457\u5dee\u5f02\u3002</p>\n<h3 id=\"-nom\u5e93\u89e3\u6790\u5668\u7ec4\u5408\u5e93\">\ud83d\udd27 nom\u5e93\uff1a\u89e3\u6790\u5668\u7ec4\u5408\u5e93<a class=\"headerlink\" href=\"#-nom\u5e93\u89e3\u6790\u5668\u7ec4\u5408\u5e93\" title=\"Permanent link\">&para;</a></h3>\n<p>\u57fa\u4e8e\u200c\u89e3\u6790\u5668\u7ec4\u5408\u5668\u200c\uff08Parser Combinators\uff09\u6a21\u5f0f\uff0c\u901a\u8fc7\u7ec4\u5408\u5c0f\u578b\u89e3\u6790\u5668\u6784\u5efa\u590d\u6742\u903b\u8f91\u3002\n\u652f\u6301\u200c\u96f6\u62f7\u8d1d\u89e3\u6790\u200c\uff0c\u76f4\u63a5\u64cd\u4f5c\u8f93\u5165\u6570\u636e\u5207\u7247\uff0c\u9ad8\u6548\u5904\u7406\u4e8c\u8fdb\u5236\u6216\u6587\u672c\u3002</p>\n<p>\u9002\u7528\u4e8e\u7f51\u7edc\u534f\u8bae\u89e3\u6790\uff08HTTP\u3001WebSocket\uff09\u3001\u81ea\u5b9a\u4e49\u4e8c\u8fdb\u5236\u683c\u5f0f\uff08\u5982\u6587\u4ef6\u5934\u3001\u6570\u636e\u5305\uff09\n\u9ad8\u6027\u80fd\u6587\u672c\u5904\u7406\uff08CSV\u3001\u65e5\u5fd7\uff09\u3002</p>\n<p>\u5bf9\u4e8e\u89e3\u6790\u4e00\u4e2acvs\u6587\u4ef6\uff0c\u9996\u5148\u8981\u4f7f\u7528nom\u63d0\u4f9b\u7684\u5c0f\u578b\u89e3\u6790\u5668\uff0c\u5b9a\u4e49\u5982\u4f55\u89e3\u6790\u4e00\u4e2afield,\u7136\u540e\u5982\u4f55\u89e3\u6790&rdquo;,&rdquo;\u53f7\u5206\u9694\uff0c\u7136\u540e\u5b9a\u4e49\u5982\u4f55\u89e3\u6790\u4e00\u884c\uff0c\u6700\u540e\u5b9a\u4e49\u5982\u4f55\u89e3\u6790\u4e00\u4e2acsv\u6587\u4ef6\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-36\">36</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"c1\">// \u89e3\u6790\u672a\u52a0\u5f15\u53f7\u7684\u5b57\u6bb5</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">parse_unquoted_field</span><span class=\"p\">(</span><span class=\"n\">input</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"kt\">str</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">IResult</span><span class=\"o\">&lt;&amp;</span><span class=\"kt\">str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">String</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a><span class=\"w\">    </span><span class=\"n\">escaped_transform</span><span class=\"p\">(</span><span class=\"n\">alphanumeric1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"sc\">&#39;\\\\&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">one_of</span><span class=\"p\">(</span><span class=\"s\">&quot;</span><span class=\"se\">\\&quot;</span><span class=\"s\">bfnrt</span><span class=\"se\">\\\\</span><span class=\"s\">&quot;</span><span class=\"p\">)).</span><span class=\"n\">parse</span><span class=\"p\">(</span><span class=\"n\">input</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\"></a>\n<a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\"></a><span class=\"c1\">// \u5355\u4e2a\u5b57\u6bb5\u89e3\u6790</span>\n<a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\"></a><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">parse_field</span><span class=\"p\">(</span><span class=\"n\">input</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"kt\">str</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">IResult</span><span class=\"o\">&lt;&amp;</span><span class=\"kt\">str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">String</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\"></a><span class=\"w\">    </span><span class=\"n\">parse_unquoted_field</span><span class=\"p\">.</span><span class=\"n\">parse</span><span class=\"p\">(</span><span class=\"n\">input</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\"></a>\n<a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\"></a><span class=\"c1\">// \u89e3\u6790\u5355\u884cCSV\u6570\u636e</span>\n<a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\"></a><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">parse_line</span><span class=\"p\">(</span><span class=\"n\">input</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"kt\">str</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">IResult</span><span class=\"o\">&lt;&amp;</span><span class=\"kt\">str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"nb\">String</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\"></a><span class=\"w\">    </span><span class=\"n\">alt</span><span class=\"p\">((</span>\n<a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\"></a><span class=\"w\">        </span><span class=\"c1\">// \u6b63\u5e38\u884c\u89e3\u6790\uff08\u4ee5\u6362\u884c\u7b26\u7ed3\u675f\uff09</span>\n<a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\"></a><span class=\"w\">        </span><span class=\"n\">terminated</span><span class=\"p\">(</span>\n<a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\"></a><span class=\"w\">            </span><span class=\"n\">separated_list0</span><span class=\"p\">(</span><span class=\"kt\">char</span><span class=\"p\">(</span><span class=\"sc\">&#39;,&#39;</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">parse_field</span><span class=\"p\">),</span>\n<a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\"></a><span class=\"w\">            </span><span class=\"n\">alt</span><span class=\"p\">((</span><span class=\"n\">tag</span><span class=\"p\">(</span><span class=\"s\">&quot;</span><span class=\"se\">\\r\\n</span><span class=\"s\">&quot;</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"p\">(</span><span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">eof</span><span class=\"p\">)),</span>\n<a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\"></a><span class=\"w\">        </span><span class=\"p\">),</span>\n<a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\"></a><span class=\"w\">        </span><span class=\"c1\">// \u5904\u7406\u7a7a\u884c</span>\n<a id=\"__codelineno-0-20\" name=\"__codelineno-0-20\"></a><span class=\"w\">        </span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"n\">alt</span><span class=\"p\">((</span><span class=\"n\">tag</span><span class=\"p\">(</span><span class=\"s\">&quot;</span><span class=\"se\">\\r\\n</span><span class=\"s\">&quot;</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"p\">(</span><span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">))),</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">_</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"fm\">vec!</span><span class=\"p\">[]),</span>\n<a id=\"__codelineno-0-21\" name=\"__codelineno-0-21\"></a><span class=\"w\">    </span><span class=\"p\">))</span>\n<a id=\"__codelineno-0-22\" name=\"__codelineno-0-22\"></a><span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">parse</span><span class=\"p\">(</span><span class=\"n\">input</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-23\" name=\"__codelineno-0-23\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-0-24\" name=\"__codelineno-0-24\"></a>\n<a id=\"__codelineno-0-25\" name=\"__codelineno-0-25\"></a><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span>\n<a id=\"__codelineno-0-26\" name=\"__codelineno-0-26\"></a><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">csv_line</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">r#&quot;2,Escapedquote,314\\r\\n&quot;#</span><span class=\"p\">;</span>\n<a id=\"__codelineno-0-27\" name=\"__codelineno-0-27\"></a>\n<a id=\"__codelineno-0-28\" name=\"__codelineno-0-28\"></a><span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">parse_line</span><span class=\"p\">(</span><span class=\"n\">csv_line</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-29\" name=\"__codelineno-0-29\"></a><span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">((</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rows</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-30\" name=\"__codelineno-0-30\"></a><span class=\"w\">            </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">rows</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-31\" name=\"__codelineno-0-31\"></a><span class=\"w\">                </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">&quot;{:?}&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">row</span><span class=\"p\">);</span>\n<a id=\"__codelineno-0-32\" name=\"__codelineno-0-32\"></a><span class=\"w\">            </span><span class=\"p\">}</span>\n<a id=\"__codelineno-0-33\" name=\"__codelineno-0-33\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-0-34\" name=\"__codelineno-0-34\"></a><span class=\"w\">        </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">&quot;Parse error: {:?}&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">),</span>\n<a id=\"__codelineno-0-35\" name=\"__codelineno-0-35\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-0-36\" name=\"__codelineno-0-36\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"-pest\u57fa\u4e8e-peg-\u7684\u89e3\u6790\u5668\u751f\u6210\u5668\">\ud83d\udcdd pest\uff1a\u57fa\u4e8e PEG \u7684\u89e3\u6790\u5668\u751f\u6210\u5668<a class=\"headerlink\" href=\"#-pest\u57fa\u4e8e-peg-\u7684\u89e3\u6790\u5668\u751f\u6210\u5668\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4f7f\u7528\u200c\u89e3\u6790\u8868\u8fbe\u5f0f\u6587\u6cd5\u200c\uff08Parsing Expression Grammar, PEG\uff09\u5b9a\u4e49\u8bed\u6cd5\u89c4\u5219\u3002\n\u8bed\u6cd5\u89c4\u5219\u4e0e Rust \u4ee3\u7801\u5206\u79bb\uff08.pest \u6587\u4ef6\uff09\uff0c\u63d0\u5347\u53ef\u8bfb\u6027\u3002</p>\n<p>\u9002\u7528\u4e8e\u7f16\u7a0b\u8bed\u8a00\u89e3\u6790\uff08\u81ea\u5b9a\u4e49 DSL\uff09\uff0c\u590d\u6742\u6587\u672c\u683c\u5f0f\uff08\u914d\u7f6e\u6587\u4ef6\u3001\u6a21\u677f\u5f15\u64ce\uff09\uff0c\u9700\u8981\u4e25\u683c\u8bed\u6cd5\u5b9a\u4e49\u7684\u573a\u666f\uff08\u5982\u7f16\u8bd1\u5668\u524d\u7aef\uff09\u3002</p>\n<p>\u6bd4\u5982\u89e3\u6790\u4e00\u4e2acsv\u6587\u4ef6\uff1a\n<a href=\"https://pest.rs/book/examples/csv.html\">pest csv</a></p>\n<p>\u5b9a\u4e49\u4e00\u4e2a.pest\u6587\u4ef6\u63cf\u8ff0\u8bed\u6cd5\u7684\u89c4\u5219\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"nv\">field</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"o\">(</span>ASCII_DIGIT<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span><span class=\"s2\">&quot;.&quot;</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span><span class=\"s2\">&quot;-&quot;</span><span class=\"o\">)</span>+<span class=\"w\"> </span><span class=\"o\">}</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"nv\">record</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span>field<span class=\"w\"> </span>~<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">&quot;,&quot;</span><span class=\"w\"> </span>~<span class=\"w\"> </span>field<span class=\"o\">)</span>*<span class=\"w\"> </span><span class=\"o\">}</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a><span class=\"nv\">file</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span>SOI<span class=\"w\"> </span>~<span class=\"w\"> </span><span class=\"o\">(</span>record<span class=\"w\"> </span>~<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">&quot;\\r\\n&quot;</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span><span class=\"s2\">&quot;\\n&quot;</span><span class=\"o\">))</span>*<span class=\"w\"> </span>~<span class=\"w\"> </span>EOI<span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<h2 id=\"\u9009\u62e9\">\u9009\u62e9<a class=\"headerlink\" href=\"#\u9009\u62e9\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4ee5\u89e3\u6790json\u4e3a\u4f8b\uff0cnom\u7684\u6027\u80fd\u76f8\u6bd4pest\u7684\u66f4\u9ad8\u4e00\u4e9b\u3002</p>\n<pre class=\"mermaid\"><code>graph TD     \n    A[\u9700\u89e3\u6790\u4ec0\u4e48\u6570\u636e?] --&gt;|\u4e8c\u8fdb\u5236/\u9ad8\u6027\u80fd| B(nom)     \n    A --&gt;|\u4e25\u683c\u8bed\u6cd5/DSL| C(pest)     \n    B --&gt; D{\u9700\u8981\u52a8\u6001\u8c03\u6574\u89e3\u6790\u903b\u8f91?}     \n    D --&gt;|\u662f| E[\u9009\u62e9nom+\u81ea\u5b9a\u4e49\u7ec4\u5408\u5668]     \n    D --&gt;|\u5426| F[\u76f4\u63a5\u4f7f\u7528nom\u5185\u7f6e\u7ec4\u5408\u5668]     \n    C --&gt; G{\u662f\u5426\u9700\u8981IDE\u5de5\u5177\u652f\u6301?}     \n    G --&gt;|\u662f| H[\u9009\u62e9pest+\u8bed\u6cd5\u9ad8\u4eae\u63d2\u4ef6]     \n    G --&gt;|\u5426| I[\u7eafpest\u89c4\u5219\u6587\u4ef6]</code></pre>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/pyo3\u5b9e\u73b0python\u548crust\u8de8\u8bed\u8a00\u8c03\u7528/\" target=\"_blank\">pyo3\u5b9e\u73b0python\u548crust\u8de8\u8bed\u8a00\u8c03\u7528</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/\u4f7f\u7528aya\u548cc\u6df7\u5408\u7f16\u5199uprobe\u7a0b\u5e8f/\" target=\"_blank\">\u4f7f\u7528aya\u548cc\u6df7\u5408\u7f16\u5199uprobe\u7a0b\u5e8f</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898/\" target=\"_blank\">C++\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-08-10T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/c%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%94%AF%E6%8C%81%E5%8A%A8%E6%80%81%E9%9D%99%E6%80%81%E6%8F%92%E4%BB%B6%E7%9A%84%E7%B3%BB%E7%BB%9F/",
            "url": "https://github.com/KenForever1/blog/c%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%94%AF%E6%8C%81%E5%8A%A8%E6%80%81%E9%9D%99%E6%80%81%E6%8F%92%E4%BB%B6%E7%9A%84%E7%B3%BB%E7%BB%9F/",
            "title": "C++\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u652f\u6301\u52a8\u6001\u3001\u9759\u6001\u63d2\u4ef6\u7684\u7cfb\u7edf",
            "content_html": "<!-- more -->\n\n<h2 id=\"\u5f15\u8a00\">\u5f15\u8a00<a class=\"headerlink\" href=\"#\u5f15\u8a00\" title=\"Permanent link\">&para;</a></h2>\n<p>\u901a\u8fc7<a href=\"https://github.com/ai-dynamo/nixl\">\u82f1\u4f1f\u8fbe\u63a8\u7406\u4f20\u8f93\u5e93\uff08NIXL\uff09</a>\u5b66\u4e60C++\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u652f\u6301\u52a8\u6001\u3001\u9759\u6001\u63d2\u4ef6\u6ce8\u518c\u548c\u7ba1\u7406\uff01</p>\n<p>NIXL\u662f\u4e00\u4e2a\u5f00\u6e90\u9879\u76ee\uff0c\u82f1\u4f1f\u8fbe\u63a8\u7406\u4f20\u8f93\u5e93\uff08NIXL\uff09\u65e8\u5728\u52a0\u901f\u8bf8\u5982\u82f1\u4f1f\u8fbeDynamo\u7b49\u4eba\u5de5\u667a\u80fd\u63a8\u7406\u6846\u67b6\u4e2d\u7684\u70b9\u5bf9\u70b9\u901a\u4fe1\uff0c\u540c\u65f6\u901a\u8fc7\u6a21\u5757\u5316\u63d2\u4ef6\u67b6\u6784\uff0c\u4e3a\u5404\u79cd\u7c7b\u578b\u7684\u5185\u5b58\uff08\u5982CPU\u548cGPU\uff09\u548c\u5b58\u50a8\uff08\u5982\u6587\u4ef6\u3001\u5757\u5b58\u50a8\u548c\u5bf9\u8c61\u5b58\u50a8\uff09\u63d0\u4f9b\u62bd\u8c61\u3002</p>\n<ul>\n<li>\u652f\u6301Python\u3001Rust\u8bed\u8a00\u7ed1\u5b9a\u3002python\u91c7\u7528pybind11\u5b9e\u73b0\uff0cRust\u91c7\u7528bindgen\u5b9e\u73b0\u3002</li>\n<li>\u91c7\u7528meson\u6784\u5efa\u7cfb\u7edf\u8fdb\u884c\u6784\u5efa\u3002</li>\n<li>\u91c7\u7528\u63d2\u4ef6\u673a\u5236\uff0c\u533a\u5206\u4e86\u52a8\u6001\u63d2\u4ef6\uff08dlsym\u52a8\u6001\u5e93\u52a0\u8f7d\uff09\u548c\u9759\u6001\u63d2\u4ef6\uff08\u7f16\u8bd1\u65f6\u94fe\u63a5\uff09\u3002</li>\n<li>\u63a5\u53e3api\u5b9e\u73b0\u6e05\u6670\uff0c\u63a5\u53e3\u548c\u5b9e\u73b0\u5206\u79bb\uff0c\u65b9\u4fbf\u8fdb\u884c\u8de8\u8bed\u8a00FFI\u7ed1\u5b9a\u3002</li>\n</ul>\n<h2 id=\"c\u63d2\u4ef6\u7cfb\u7edf\u63a5\u53e3\u548c\u7ba1\u7406\">C++\u63d2\u4ef6\u7cfb\u7edf\u63a5\u53e3\u548c\u7ba1\u7406<a class=\"headerlink\" href=\"#c\u63d2\u4ef6\u7cfb\u7edf\u63a5\u53e3\u548c\u7ba1\u7406\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e00\u4e2a\u63d2\u4ef6\u7cfb\u7edf\u9700\u8981\u5982\u4f55\u8003\u8651\u63a5\u53e3\u5b9e\u73b0\u5462\uff1f\u9700\u8981\u5305\u62ec\u54ea\u4e9b\u4fe1\u606f\uff1f</p>\n<ul>\n<li>\n<p>\u63d2\u4ef6\u7248\u672c\u5b9a\u4e49\uff0c\u5728\u63d2\u4ef6\u52a0\u8f7d\u65f6\u53ef\u4ee5\u5bf9\u63d2\u4ef6\u7248\u672c\u8fdb\u884c\u6821\u9a8c\uff0c\u786e\u4fdd\u63d2\u4ef6\u548c\u4e3b\u7a0b\u5e8f\u517c\u5bb9\u3002</p>\n</li>\n<li>\n<p>\u901a\u8fc7 <strong>attribute</strong>((visibility(&ldquo;default&rdquo;))) \u5bfc\u51fa\u63a5\u53e3\u51fd\u6570\uff0c\u4f7f\u5f97\u52a8\u6001\u5e93\u52a0\u8f7d\u65f6\u53ef\u4ee5\u627e\u5230\u8fd9\u4e9b\u51fd\u6570\u3002\u663e\u5f0f\u58f0\u660e\u9700\u8981\u5bf9\u5916\u66b4\u9732\u7684\u63a5\u53e3\uff0c\u907f\u514d\u9ed8\u8ba4\u5bfc\u51fa\u6240\u6709\u7b26\u53f7\uff0c\u786e\u4fdd\u5173\u952e\u51fd\u6570\u6216\u53d8\u91cf\u53ef\u88ab\u5916\u90e8\u94fe\u63a5\u3002</p>\n</li>\n</ul>\n<h3 id=\"\u63d2\u4ef6\u63a5\u53e3\u5b9a\u4e49\">\u63d2\u4ef6\u63a5\u53e3\u5b9a\u4e49<a class=\"headerlink\" href=\"#\u63d2\u4ef6\u63a5\u53e3\u5b9a\u4e49\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u4e00\u4e2aapi\u63a5\u53e3\u5934\u6587\u4ef6\u4e2d\u5b9a\u4e49\u63d2\u4ef6\u63a5\u53e3\uff0c\u5305\u62ec\u63d2\u4ef6\u7248\u672c\u3001\u63d2\u4ef6\u540d\u79f0\u3001\u63d2\u4ef6\u521d\u59cb\u5316\u3001\u63d2\u4ef6\u9500\u6bc1\u7b49\u51fd\u6570\u3002\u5728\u9879\u76ee\u7684\u7ec4\u7ec7\u7ed3\u6784\u4e2d\uff0c\u53ef\u4ee5\u4e13\u95e8\u653e\u5230\u4e00\u4e2aapi\u76ee\u5f55\u4e0b\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-39\">39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-40\">40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-41\">41</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-42\">42</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-43\">43</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&quot;backend/backend_engine.h&quot;</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a><span class=\"c1\">// Define the plugin API version</span>\n<a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\"></a><span class=\"cp\">#define NIXL_PLUGIN_API_VERSION 1</span>\n<a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\"></a>\n<a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\"></a><span class=\"c1\">// Define the plugin interface class</span>\n<a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\"></a><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">nixlBackendPlugin</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\"></a><span class=\"k\">public</span><span class=\"o\">:</span>\n<a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\"></a><span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">api_version</span><span class=\"p\">;</span>\n<a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\"></a>\n<a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\"></a><span class=\"w\">    </span><span class=\"c1\">// Function pointer for creating a new backend engine instance</span>\n<a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\"></a><span class=\"w\">    </span><span class=\"n\">nixlBackendEngine</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">create_engine</span><span class=\"p\">)(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">nixlBackendInitParams</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">init_params</span><span class=\"p\">);</span>\n<a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\"></a>\n<a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\"></a><span class=\"w\">    </span><span class=\"c1\">// Function pointer for destroying a backend engine instance</span>\n<a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">destroy_engine</span><span class=\"p\">)(</span><span class=\"n\">nixlBackendEngine</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"p\">);</span>\n<a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\"></a>\n<a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\"></a><span class=\"w\">    </span><span class=\"c1\">// Function to get the plugin name</span>\n<a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">get_plugin_name</span><span class=\"p\">)();</span>\n<a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\"></a>\n<a id=\"__codelineno-0-20\" name=\"__codelineno-0-20\"></a><span class=\"w\">    </span><span class=\"c1\">// Function to get the plugin version</span>\n<a id=\"__codelineno-0-21\" name=\"__codelineno-0-21\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">get_plugin_version</span><span class=\"p\">)();</span>\n<a id=\"__codelineno-0-22\" name=\"__codelineno-0-22\"></a>\n<a id=\"__codelineno-0-23\" name=\"__codelineno-0-23\"></a><span class=\"w\">    </span><span class=\"c1\">// Function to get backend options</span>\n<a id=\"__codelineno-0-24\" name=\"__codelineno-0-24\"></a><span class=\"w\">    </span><span class=\"n\">nixl_b_params_t</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">get_backend_options</span><span class=\"p\">)();</span>\n<a id=\"__codelineno-0-25\" name=\"__codelineno-0-25\"></a>\n<a id=\"__codelineno-0-26\" name=\"__codelineno-0-26\"></a><span class=\"w\">    </span><span class=\"c1\">// Function to get supported backend mem types</span>\n<a id=\"__codelineno-0-27\" name=\"__codelineno-0-27\"></a><span class=\"w\">    </span><span class=\"n\">nixl_mem_list_t</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">get_backend_mems</span><span class=\"p\">)();</span>\n<a id=\"__codelineno-0-28\" name=\"__codelineno-0-28\"></a><span class=\"p\">};</span>\n<a id=\"__codelineno-0-29\" name=\"__codelineno-0-29\"></a>\n<a id=\"__codelineno-0-30\" name=\"__codelineno-0-30\"></a><span class=\"c1\">// Macro to define exported C functions for the plugin</span>\n<a id=\"__codelineno-0-31\" name=\"__codelineno-0-31\"></a><span class=\"cp\">#define NIXL_PLUGIN_EXPORT __attribute__((visibility(&quot;default&quot;)))</span>\n<a id=\"__codelineno-0-32\" name=\"__codelineno-0-32\"></a>\n<a id=\"__codelineno-0-33\" name=\"__codelineno-0-33\"></a><span class=\"c1\">// Creator Function type for static plugins</span>\n<a id=\"__codelineno-0-34\" name=\"__codelineno-0-34\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">nixlStaticPluginCreatorFunc</span><span class=\"p\">)();</span>\n<a id=\"__codelineno-0-35\" name=\"__codelineno-0-35\"></a>\n<a id=\"__codelineno-0-36\" name=\"__codelineno-0-36\"></a><span class=\"c1\">// Plugin must implement these functions for dynamic loading</span>\n<a id=\"__codelineno-0-37\" name=\"__codelineno-0-37\"></a><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">&quot;C&quot;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-38\" name=\"__codelineno-0-38\"></a><span class=\"w\">    </span><span class=\"c1\">// Initialize the plugin</span>\n<a id=\"__codelineno-0-39\" name=\"__codelineno-0-39\"></a><span class=\"w\">    </span><span class=\"n\">NIXL_PLUGIN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">nixl_plugin_init</span><span class=\"p\">();</span>\n<a id=\"__codelineno-0-40\" name=\"__codelineno-0-40\"></a>\n<a id=\"__codelineno-0-41\" name=\"__codelineno-0-41\"></a><span class=\"w\">    </span><span class=\"c1\">// Cleanup the plugin</span>\n<a id=\"__codelineno-0-42\" name=\"__codelineno-0-42\"></a><span class=\"w\">    </span><span class=\"n\">NIXL_PLUGIN_EXPORT</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">nixl_plugin_fini</span><span class=\"p\">();</span>\n<a id=\"__codelineno-0-43\" name=\"__codelineno-0-43\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"\u63d2\u4ef6\u7ba1\u7406\u5668\">\u63d2\u4ef6\u7ba1\u7406\u5668<a class=\"headerlink\" href=\"#\u63d2\u4ef6\u7ba1\u7406\u5668\" title=\"Permanent link\">&para;</a></h3>\n<p>\u901a\u8fc7\u4e00\u4e2a\u5355\u4f8b\uff0c\u8fdb\u884c\u63d2\u4ef6\u7ba1\u7406\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-6\">6</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"n\">nixlPluginManager</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"nf\">nixlPluginManager::getInstance</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"w\">    </span><span class=\"c1\">// Meyers singleton initialization is safe in multi-threaded environment.</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a><span class=\"w\">    </span><span class=\"c1\">// Consult standard [stmt.dcl] chapter for details.</span>\n<a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\"></a><span class=\"w\">    </span><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">nixlPluginManager</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">;</span>\n<a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">;</span>\n<a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n\u770b\u4e00\u4e0bnixlPluginManager\u7684\u6210\u5458\u53d8\u91cf\u5b9a\u4e49\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-8\">8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-9\">9</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"k\">using</span><span class=\"w\"> </span><span class=\"n\">nixl_backend_t</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a>\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">nixlPluginManager</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a><span class=\"k\">private</span><span class=\"o\">:</span>\n<a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">map</span><span class=\"o\">&lt;</span><span class=\"n\">nixl_backend_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">shared_ptr</span><span class=\"o\">&lt;</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">nixlPluginHandle</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">loaded_plugins_</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// \u540c\u65f6\u4fdd\u5b58\u4e86\u6ce8\u518c\u7684\u52a8\u6001\u63d2\u4ef6\u548c\u9759\u6001\u63d2\u4ef6\u4fe1\u606f</span>\n<a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">vector</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">plugin_dirs_</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// \u4fdd\u5b58\u63d2\u4ef6\u641c\u7d22\u8def\u5f84</span>\n<a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">vector</span><span class=\"o\">&lt;</span><span class=\"n\">nixlStaticPluginInfo</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">static_plugins_</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// \u4fdd\u5b58\u6709\u9759\u6001\u63d2\u4ef6\u7684\u4fe1\u606f\uff0c\u65b9\u4fbf\u5728unload\u65f6\u8fdb\u884c\u8fc7\u6ee4\u9759\u6001\u63d2\u4ef6\uff0c\u56e0\u4e3a\u9759\u6001\u63d2\u4ef6\u4e0d\u9700\u8981dlclose\u3002</span>\n<a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\"></a><span class=\"w\">    </span><span class=\"c1\">// ......</span>\n<a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"\u7ef4\u62a4\u63d2\u4ef6\u4fe1\u606f\">\u7ef4\u62a4\u63d2\u4ef6\u4fe1\u606f<a class=\"headerlink\" href=\"#\u7ef4\u62a4\u63d2\u4ef6\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h3>\n<p>nixlPluginHandle\u540c\u65f6\u652f\u6301\u4fdd\u5b58\u52a8\u6001\u63d2\u4ef6\u548c\u9759\u6001\u63d2\u4ef6\u7684\u4fe1\u606f\u3002nixlPluginHandle\u7ed3\u6784\u53ea\u5728\u6784\u9020\u548c\u6790\u6784\u65f6\u4fee\u6539\uff0c\u5728\u67e5\u8be2\u548c\u63d2\u4ef6\u5b9e\u4f8b\u5316\u65f6\u53ea\u8bfb\u3002\u56e0\u6b64\u53ef\u4ee5\u5728\u591a\u7ebf\u7a0b\u4e2d\u5b89\u5168\u4f7f\u7528\uff0c\u4e0d\u9700\u8981\u52a0\u9501\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-16\">16</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">nixlPluginHandle</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a><span class=\"k\">private</span><span class=\"o\">:</span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">handle_</span><span class=\"p\">;</span><span class=\"w\">         </span><span class=\"c1\">// Handle to the dynamically loaded library</span>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a><span class=\"w\">    </span><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">plugin_</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// Plugin interface</span>\n<a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\"></a>\n<a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\"></a><span class=\"k\">public</span><span class=\"o\">:</span>\n<a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\"></a><span class=\"w\">    </span><span class=\"n\">nixlPluginHandle</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\"></a><span class=\"w\">    </span><span class=\"o\">~</span><span class=\"n\">nixlPluginHandle</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\"></a>\n<a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\"></a><span class=\"w\">    </span><span class=\"n\">nixlBackendEngine</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"nf\">createEngine</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">nixlBackendInitParams</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">init_params</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">destroyEngine</span><span class=\"p\">(</span><span class=\"n\">nixlBackendEngine</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"nf\">getName</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"nf\">getVersion</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\"></a><span class=\"w\">    </span><span class=\"n\">nixl_b_params_t</span><span class=\"w\"> </span><span class=\"nf\">getBackendOptions</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\"></a><span class=\"w\">    </span><span class=\"n\">nixl_mem_list_t</span><span class=\"w\"> </span><span class=\"nf\">getBackendMems</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\"></a><span class=\"p\">};</span>\n</code></pre></div></td></tr></table></div>\n<h2 id=\"\u9759\u6001\u63d2\u4ef6\u548c\u52a8\u6001\u63d2\u4ef6\u6ce8\u518c\">\u9759\u6001\u63d2\u4ef6\u548c\u52a8\u6001\u63d2\u4ef6\u6ce8\u518c<a class=\"headerlink\" href=\"#\u9759\u6001\u63d2\u4ef6\u548c\u52a8\u6001\u63d2\u4ef6\u6ce8\u518c\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u9759\u6001\u63d2\u4ef6\">\u9759\u6001\u63d2\u4ef6<a class=\"headerlink\" href=\"#\u9759\u6001\u63d2\u4ef6\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-8\">8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-9\">9</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a><span class=\"c1\">// Creator Function for static plugins</span>\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">nixlStaticPluginCreatorFunc</span><span class=\"p\">)();</span>\n<a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\"></a>\n<a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\"></a>\n<a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\"></a><span class=\"c1\">// Structure to hold static plugin info</span>\n<a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">nixlStaticPluginInfo</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\"></a><span class=\"w\">    </span><span class=\"n\">nixlStaticPluginCreatorFunc</span><span class=\"w\"> </span><span class=\"n\">createFunc</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\"></a><span class=\"p\">};</span>\n</code></pre></div></td></tr></table></div>\n<p>\u6ce8\u518c\u9759\u6001\u63d2\u4ef6: \u9759\u6001\u63d2\u4ef6\u53ea\u9700\u8981\u4fdd\u5b58\u4e00\u4e2aname\u548ccreateFunc\uff0c\u5e76\u4e14\u5728\u6ce8\u518c\u65f6\uff0c\u6267\u884ccreateFunc\u8fdb\u884c\u5b9e\u4f8b\u5316\uff08\u4e00\u4e2a\u9759\u6001\u5168\u5c40\u5b9e\u4f8b\uff09\u3002\u7136\u540e\u5c06nixlBackendPlugin*\u4fe1\u606f\u4fdd\u5b58\u5230loaded_plugins_\u7684map\u4e2d\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-17\">17</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">nixlPluginManager::registerStaticPlugin</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nixlStaticPluginCreatorFunc</span><span class=\"w\"> </span><span class=\"n\">creator</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a><span class=\"w\">    </span><span class=\"n\">lock_guard</span><span class=\"w\"> </span><span class=\"n\">lg</span><span class=\"p\">(</span><span class=\"n\">lock</span><span class=\"p\">);</span>\n<a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\"></a>\n<a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\"></a><span class=\"w\">    </span><span class=\"n\">nixlStaticPluginInfo</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\"></a><span class=\"w\">    </span><span class=\"n\">info</span><span class=\"p\">.</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\"></a><span class=\"w\">    </span><span class=\"n\">info</span><span class=\"p\">.</span><span class=\"n\">createFunc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">creator</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\"></a><span class=\"w\">    </span><span class=\"n\">static_plugins_</span><span class=\"p\">.</span><span class=\"n\">push_back</span><span class=\"p\">(</span><span class=\"n\">info</span><span class=\"p\">);</span>\n<a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\"></a>\n<a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\"></a><span class=\"w\">    </span><span class=\"c1\">//Static Plugins are considered pre-loaded</span>\n<a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\"></a><span class=\"w\">    </span><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"p\">.</span><span class=\"n\">createFunc</span><span class=\"p\">();</span>\n<a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\"></a><span class=\"w\">    </span><span class=\"n\">NIXL_INFO</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;Loading static plugin: &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">plugin</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\"></a><span class=\"w\">        </span><span class=\"c1\">// Register the loaded plugin</span>\n<a id=\"__codelineno-5-14\" name=\"__codelineno-5-14\"></a><span class=\"w\">        </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">plugin_handle</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">make_shared</span><span class=\"o\">&lt;</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">nixlPluginHandle</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"k\">nullptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"p\">);</span>\n<a id=\"__codelineno-5-15\" name=\"__codelineno-5-15\"></a><span class=\"w\">        </span><span class=\"n\">loaded_plugins_</span><span class=\"p\">[</span><span class=\"n\">name</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">plugin_handle</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-16\" name=\"__codelineno-5-16\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-17\" name=\"__codelineno-5-17\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u9759\u6001\u63d2\u4ef6\u4e0d\u9700\u8981unload, \u76f8\u6bd4\u52a8\u6001\u63d2\u4ef6\u9700\u8981dlclose\u3002</p>\n<p>\u5728\u7f16\u8bd1\u65f6\uff0c\u51b3\u5b9a\u662f\u5426\u6ce8\u518c\u9759\u6001\u63d2\u4ef6\u3002createStaticPosixPlugin\u51fd\u6570\u5728\u63d2\u4ef6\u6a21\u5757\u4e2d\u5b9e\u73b0\uff08\u540e\u9762\u5b9e\u73b0\u73af\u8282\u6709\u4ecb\u7ecd\uff09\uff0c\u8fd9\u91cc\u901a\u8fc7\u5b8f\u63a7\u5236\u662f\u5426\u6ce8\u518c\u9759\u6001\u63d2\u4ef6\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-11\">11</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a><span class=\"cp\">#ifdef STATIC_PLUGIN_POSIX</span>\n<a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\"></a><span class=\"w\">        </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"nf\">createStaticPosixPlugin</span><span class=\"p\">();</span>\n<a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\"></a><span class=\"w\">        </span><span class=\"n\">registerStaticPlugin</span><span class=\"p\">(</span><span class=\"s\">&quot;POSIX&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">createStaticPosixPlugin</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\"></a><span class=\"cp\">#endif </span><span class=\"c1\">// STATIC_PLUGIN_POSIX</span>\n<a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\"></a>\n<a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\"></a><span class=\"cp\">#ifdef STATIC_PLUGIN_GDS</span>\n<a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\"></a><span class=\"cp\">#ifndef DISABLE_GDS_BACKEND</span>\n<a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\"></a><span class=\"w\">        </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"nf\">createStaticGdsPlugin</span><span class=\"p\">();</span>\n<a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\"></a><span class=\"w\">        </span><span class=\"n\">registerStaticPlugin</span><span class=\"p\">(</span><span class=\"s\">&quot;GDS&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">createStaticGdsPlugin</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\"></a><span class=\"cp\">#endif </span><span class=\"c1\">// DISABLE_GDS_BACKEND</span>\n<a id=\"__codelineno-6-11\" name=\"__codelineno-6-11\"></a><span class=\"cp\">#endif </span><span class=\"c1\">// STATIC_PLUGIN_GDS</span>\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"\u52a8\u6001\u63d2\u4ef6\u52a0\u8f7d\">\u52a8\u6001\u63d2\u4ef6\u52a0\u8f7d<a class=\"headerlink\" href=\"#\u52a8\u6001\u63d2\u4ef6\u52a0\u8f7d\" title=\"Permanent link\">&para;</a></h3>\n<p>\u901a\u8fc7\u4e00\u4e2avoid *handle\uff0c\u4fdd\u5b58\u52a8\u6001\u5e93\u7684\u53e5\u67c4\u3002</p>\n<p>\u652f\u6301\u8bbe\u7f6e\u63d2\u4ef6\u641c\u7d22\u8def\u5f84\uff0c\u5e76\u52a0\u8f7d\u63d2\u4ef6\u3002\u5728\u52a0\u8f7d\u63d2\u4ef6\u65f6\uff0c\u5148\u6839\u636e\u63d2\u4ef6\u540d\u79f0\u6821\u9a8c\u662f\u5426\u5df2\u7ecf\u4e3a\u9759\u6001\u63d2\u4ef6\uff0c\u5373\u5df2\u7ecfpreload\uff0c\u53ef\u4ee5\u76f4\u63a5\u8fd4\u56de\u9759\u6001\u63d2\u4ef6\u7684handle\u3002</p>\n<p>\u5728\u63d2\u4ef6\u52a0\u8f7d\u65f6\uff0c\u4f1a\u8fdb\u884c\u63d2\u4ef6\u7248\u672c\u6821\u9a8c\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-7-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-39\">39</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">shared_ptr</span><span class=\"o\">&lt;</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">nixlPluginHandle</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">nixlPluginManager</span><span class=\"o\">::</span><span class=\"n\">loadPluginFromPath</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">plugin_path</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\"></a><span class=\"w\">    </span><span class=\"c1\">// Open the plugin file</span>\n<a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">dlopen</span><span class=\"p\">(</span><span class=\"n\">plugin_path</span><span class=\"p\">.</span><span class=\"n\">c_str</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">RTLD_NOW</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">RTLD_LOCAL</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">handle</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\"></a><span class=\"w\">        </span><span class=\"n\">NIXL_ERROR</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;Failed to load plugin from &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">plugin_path</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;: &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">dlerror</span><span class=\"p\">();</span>\n<a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\"></a>\n<a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\"></a><span class=\"w\">    </span><span class=\"c1\">// Get the initialization function</span>\n<a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\"></a><span class=\"w\">    </span><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">init_func_t</span><span class=\"p\">)();</span>\n<a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\"></a><span class=\"w\">    </span><span class=\"n\">init_func_t</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">init_func_t</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">dlsym</span><span class=\"p\">(</span><span class=\"n\">handle</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;nixl_plugin_init&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">init</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\"></a><span class=\"w\">        </span><span class=\"n\">NIXL_ERROR</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;Failed to find nixl_plugin_init in &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">plugin_path</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;: &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">dlerror</span><span class=\"p\">();</span>\n<a id=\"__codelineno-7-14\" name=\"__codelineno-7-14\"></a><span class=\"w\">        </span><span class=\"n\">dlclose</span><span class=\"p\">(</span><span class=\"n\">handle</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-15\" name=\"__codelineno-7-15\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-16\" name=\"__codelineno-7-16\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-7-17\" name=\"__codelineno-7-17\"></a>\n<a id=\"__codelineno-7-18\" name=\"__codelineno-7-18\"></a><span class=\"w\">    </span><span class=\"c1\">// Call the initialization function</span>\n<a id=\"__codelineno-7-19\" name=\"__codelineno-7-19\"></a><span class=\"w\">    </span><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"p\">();</span>\n<a id=\"__codelineno-7-20\" name=\"__codelineno-7-20\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">plugin</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-21\" name=\"__codelineno-7-21\"></a><span class=\"w\">        </span><span class=\"n\">NIXL_ERROR</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;Plugin initialization failed for &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">plugin_path</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-22\" name=\"__codelineno-7-22\"></a><span class=\"w\">        </span><span class=\"n\">dlclose</span><span class=\"p\">(</span><span class=\"n\">handle</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-23\" name=\"__codelineno-7-23\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-24\" name=\"__codelineno-7-24\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-7-25\" name=\"__codelineno-7-25\"></a>\n<a id=\"__codelineno-7-26\" name=\"__codelineno-7-26\"></a><span class=\"w\">    </span><span class=\"c1\">// Check API version</span>\n<a id=\"__codelineno-7-27\" name=\"__codelineno-7-27\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">plugin</span><span class=\"o\">-&gt;</span><span class=\"n\">api_version</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">NIXL_PLUGIN_API_VERSION</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-28\" name=\"__codelineno-7-28\"></a><span class=\"w\">        </span><span class=\"n\">NIXL_ERROR</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;Plugin API version mismatch for &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">plugin_path</span>\n<a id=\"__codelineno-7-29\" name=\"__codelineno-7-29\"></a><span class=\"w\">                   </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;: expected &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">NIXL_PLUGIN_API_VERSION</span>\n<a id=\"__codelineno-7-30\" name=\"__codelineno-7-30\"></a><span class=\"w\">                   </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;, got &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"o\">-&gt;</span><span class=\"n\">api_version</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-31\" name=\"__codelineno-7-31\"></a><span class=\"w\">        </span><span class=\"n\">dlclose</span><span class=\"p\">(</span><span class=\"n\">handle</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-32\" name=\"__codelineno-7-32\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-33\" name=\"__codelineno-7-33\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-7-34\" name=\"__codelineno-7-34\"></a>\n<a id=\"__codelineno-7-35\" name=\"__codelineno-7-35\"></a><span class=\"w\">    </span><span class=\"c1\">// Create and store the plugin handle</span>\n<a id=\"__codelineno-7-36\" name=\"__codelineno-7-36\"></a><span class=\"w\">    </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">plugin_handle</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">make_shared</span><span class=\"o\">&lt;</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">nixlPluginHandle</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">handle</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-37\" name=\"__codelineno-7-37\"></a>\n<a id=\"__codelineno-7-38\" name=\"__codelineno-7-38\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">plugin_handle</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-39\" name=\"__codelineno-7-39\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u4ecb\u7ecd\u5230\u73b0\u5728\uff0c\u4e00\u4e2a\u63d2\u4ef6\u7684\u6846\u67b6\u5df2\u7ecf\u642d\u5efa\u597d\u4e86\u3002\u652f\u6301\u63d2\u4ef6\u7ba1\u7406\u3001\u63d2\u4ef6\u63a5\u53e3\u5b9a\u4e49\u3001\u52a8\u6001\u548c\u9759\u6001\u63d2\u4ef6\u52a0\u8f7d\u3002\n\u63a5\u4e0b\u6765\uff0c\u5c31\u662f\u6839\u636e\u63d2\u4ef6\u63a5\u53e3\uff0c\u5b9e\u73b0\u5177\u4f53\u7684\u63d2\u4ef6\u3002\u5982\u4f55\u5b9e\u73b0\u652f\u6301\u52a8\u6001\u52a0\u8f7d\u7684\u63d2\u4ef6\u548c\u9759\u6001\u63d2\u4ef6\u3002</p>\n<h2 id=\"\u5982\u4f55\u5b9e\u73b0\u63d2\u4ef6plugin\">\u5982\u4f55\u5b9e\u73b0\u63d2\u4ef6Plugin<a class=\"headerlink\" href=\"#\u5982\u4f55\u5b9e\u73b0\u63d2\u4ef6plugin\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5b9e\u73b0\u63d2\u4ef6\u53ea\u9700\u8981\u5bfc\u5165\u5934\u6587\u4ef6\uff0c\u5e76\u5b9e\u73b0\u63d2\u4ef6\u63a5\u53e3\u3002\u4fdd\u8bc1\u4e86\u63d2\u4ef6\u63a5\u53e3\u7684\u7edf\u4e00\u6027\uff0c\u7ed3\u6784\u7ec4\u7ec7\u7684\u6e05\u6670\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-8-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&quot;backend/backend_plugin.h&quot;</span>\n</code></pre></div></td></tr></table></div>\n\u8fd9\u4e2aPosix\u662f\u82f1\u4f1f\u8fbe\u63a8\u7406\u4f20\u8f93\u5e93\uff08NIXL\uff09\u4e2d\u5176\u4e2d\u4e00\u4e2a\u63d2\u4ef6\u5b9e\u73b0\uff0c\u5176\u4ed6\u63d2\u4ef6\u8fd8\u5305\u62ec\u4e86hf3fs\u3001mooncake\u3001cuda_gds\u7b49\u3002\u770b\u4e00\u4e0b\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2aPosix\u63d2\u4ef6\uff0c\u4e0b\u9762\u662f\u5bf9\u63d2\u4ef6\u63a5\u53e3\u51fd\u6570\u7684\u5b9e\u73b0\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-9-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-30\">30</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\"></a><span class=\"c1\">// Function to create a new POSIX backend engine instance</span>\n<a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">nixlBackendEngine</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"nf\">create_posix_engine</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">nixlBackendInitParams</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">init_params</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"n\">nixlPosixEngine</span><span class=\"p\">(</span><span class=\"n\">init_params</span><span class=\"p\">);</span>\n<a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\"></a>\n<a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\"></a><span class=\"c1\">// \u8d44\u6e90\u7684\u6b63\u786e\u91ca\u653e</span>\n<a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">destroy_posix_engine</span><span class=\"p\">(</span><span class=\"n\">nixlBackendEngine</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">engine</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-8\" name=\"__codelineno-9-8\"></a><span class=\"w\">    </span><span class=\"k\">delete</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-9\" name=\"__codelineno-9-9\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-9-10\" name=\"__codelineno-9-10\"></a>\n<a id=\"__codelineno-9-11\" name=\"__codelineno-9-11\"></a><span class=\"c1\">// Function to get the plugin name\uff0c\u63d2\u4ef6\u540d\u79f0</span>\n<a id=\"__codelineno-9-12\" name=\"__codelineno-9-12\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"nf\">get_plugin_name</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-13\" name=\"__codelineno-9-13\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"s\">&quot;POSIX&quot;</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-14\" name=\"__codelineno-9-14\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-9-15\" name=\"__codelineno-9-15\"></a>\n<a id=\"__codelineno-9-16\" name=\"__codelineno-9-16\"></a><span class=\"c1\">// Function to get the plugin version\uff0c\u63d2\u4ef6\u7248\u672c</span>\n<a id=\"__codelineno-9-17\" name=\"__codelineno-9-17\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"nf\">get_plugin_version</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-18\" name=\"__codelineno-9-18\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"s\">&quot;0.1.0&quot;</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-19\" name=\"__codelineno-9-19\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-9-20\" name=\"__codelineno-9-20\"></a>\n<a id=\"__codelineno-9-21\" name=\"__codelineno-9-21\"></a><span class=\"c1\">// Function to get backend options</span>\n<a id=\"__codelineno-9-22\" name=\"__codelineno-9-22\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">nixl_b_params_t</span><span class=\"w\"> </span><span class=\"nf\">get_backend_options</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-23\" name=\"__codelineno-9-23\"></a><span class=\"w\">    </span><span class=\"n\">nixl_b_params_t</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-24\" name=\"__codelineno-9-24\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-25\" name=\"__codelineno-9-25\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-9-26\" name=\"__codelineno-9-26\"></a>\n<a id=\"__codelineno-9-27\" name=\"__codelineno-9-27\"></a><span class=\"c1\">// Function to get supported backend mem types</span>\n<a id=\"__codelineno-9-28\" name=\"__codelineno-9-28\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">nixl_mem_list_t</span><span class=\"w\"> </span><span class=\"nf\">get_backend_mems</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-29\" name=\"__codelineno-9-29\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">DRAM_SEG</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">FILE_SEG</span><span class=\"p\">};</span>\n<a id=\"__codelineno-9-30\" name=\"__codelineno-9-30\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u9759\u6001\u63d2\u4ef6\u548c\u52a8\u6001\u63d2\u4ef6\u5b9e\u73b0\u7684\u533a\u522b\uff1a</p>\n<ul>\n<li>\n<p>\u9759\u6001\u63d2\u4ef6\u5728\u7f16\u8bd1\u65f6\uff0c\u901a\u8fc7\u5b8f\u63a7\u5236\u662f\u5426\u6ce8\u518c\u9759\u6001\u63d2\u4ef6\uff0c\u5728\u7a0b\u5e8f\u7f16\u8bd1\u65f6\uff0c\u6839\u636e\u5b8f\u5b9a\u4e49\uff0c\u51b3\u5b9a\u662f\u5426\u8c03\u7528createStaticPosixPlugin\u51fd\u6570\u3002\u5c06\u9759\u6001\u5168\u5c40\u53d8\u91cfnixlBackendPlugin*\u4fe1\u606f\u4fdd\u5b58\u5230loaded_plugins_\u7684map\u4e2d\u3002</p>\n</li>\n<li>\n<p>\u52a8\u6001\u63d2\u4ef6\u5728\u8fd0\u884c\u65f6\uff0c\u901a\u8fc7dlopen\u52a0\u8f7d\u52a8\u6001\u5e93\uff0c\u5e76\u8c03\u7528nixl_plugin_init\u51fd\u6570\uff0c\u521d\u59cb\u5316\u63d2\u4ef6\u3002</p>\n</li>\n</ul>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-10-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-39\">39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-40\">40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-41\">41</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\"></a><span class=\"cp\">#ifdef STATIC_PLUGIN_POSIX</span>\n<a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\"></a>\n<a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\"></a><span class=\"c1\">// \u901a\u8fc7\u9759\u6001\u5168\u5c40\u53d8\u91cf\uff0c\u6ce8\u518c\u9759\u6001\u63d2\u4ef6\u5b9e\u4f8b\uff0c\u5728\u7a0b\u5e8f\u7f16\u8bd1\u65f6\uff0c\u6839\u636e\u5b8f\u5b9a\u4e49\uff0c\u51b3\u5b9a\u662f\u5426\u8c03\u7528createStaticPosixPlugin\u51fd\u6570</span>\n<a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\"></a><span class=\"c1\">// \u51b3\u5b9a\u662f\u5426\u6ce8\u518c\u9759\u6001\u63d2\u4ef6</span>\n<a id=\"__codelineno-10-5\" name=\"__codelineno-10-5\"></a><span class=\"c1\">// Static plugin structure</span>\n<a id=\"__codelineno-10-6\" name=\"__codelineno-10-6\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">nixlBackendPlugin</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-10-7\" name=\"__codelineno-10-7\"></a><span class=\"w\">    </span><span class=\"n\">NIXL_PLUGIN_API_VERSION</span><span class=\"p\">,</span>\n<a id=\"__codelineno-10-8\" name=\"__codelineno-10-8\"></a><span class=\"w\">    </span><span class=\"n\">create_posix_engine</span><span class=\"p\">,</span>\n<a id=\"__codelineno-10-9\" name=\"__codelineno-10-9\"></a><span class=\"w\">    </span><span class=\"n\">destroy_posix_engine</span><span class=\"p\">,</span>\n<a id=\"__codelineno-10-10\" name=\"__codelineno-10-10\"></a><span class=\"w\">    </span><span class=\"n\">get_plugin_name</span><span class=\"p\">,</span>\n<a id=\"__codelineno-10-11\" name=\"__codelineno-10-11\"></a><span class=\"w\">    </span><span class=\"n\">get_plugin_version</span><span class=\"p\">,</span>\n<a id=\"__codelineno-10-12\" name=\"__codelineno-10-12\"></a><span class=\"w\">    </span><span class=\"n\">get_backend_options</span><span class=\"p\">,</span>\n<a id=\"__codelineno-10-13\" name=\"__codelineno-10-13\"></a><span class=\"w\">    </span><span class=\"n\">get_backend_mems</span>\n<a id=\"__codelineno-10-14\" name=\"__codelineno-10-14\"></a><span class=\"p\">};</span>\n<a id=\"__codelineno-10-15\" name=\"__codelineno-10-15\"></a>\n<a id=\"__codelineno-10-16\" name=\"__codelineno-10-16\"></a><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"nf\">createStaticPosixPlugin</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-10-17\" name=\"__codelineno-10-17\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">plugin</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// Return the static plugin instance</span>\n<a id=\"__codelineno-10-18\" name=\"__codelineno-10-18\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-10-19\" name=\"__codelineno-10-19\"></a>\n<a id=\"__codelineno-10-20\" name=\"__codelineno-10-20\"></a><span class=\"cp\">#else</span>\n<a id=\"__codelineno-10-21\" name=\"__codelineno-10-21\"></a>\n<a id=\"__codelineno-10-22\" name=\"__codelineno-10-22\"></a><span class=\"c1\">// Plugin initialization function</span>\n<a id=\"__codelineno-10-23\" name=\"__codelineno-10-23\"></a><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">&quot;C&quot;</span><span class=\"w\"> </span><span class=\"n\">NIXL_PLUGIN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">nixl_plugin_init</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-10-24\" name=\"__codelineno-10-24\"></a><span class=\"w\">    </span><span class=\"k\">try</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-10-25\" name=\"__codelineno-10-25\"></a><span class=\"w\">        </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">make_unique</span><span class=\"o\">&lt;</span><span class=\"n\">nixlBackendPlugin</span><span class=\"o\">&gt;</span><span class=\"p\">();</span>\n<a id=\"__codelineno-10-26\" name=\"__codelineno-10-26\"></a><span class=\"w\">        </span><span class=\"n\">plugin</span><span class=\"o\">-&gt;</span><span class=\"n\">create_engine</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">create_posix_engine</span><span class=\"p\">;</span>\n<a id=\"__codelineno-10-27\" name=\"__codelineno-10-27\"></a><span class=\"w\">        </span><span class=\"n\">plugin</span><span class=\"o\">-&gt;</span><span class=\"n\">destroy_engine</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">destroy_posix_engine</span><span class=\"p\">;</span>\n<a id=\"__codelineno-10-28\" name=\"__codelineno-10-28\"></a><span class=\"w\">        </span><span class=\"n\">plugin</span><span class=\"o\">-&gt;</span><span class=\"n\">get_plugin_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">get_plugin_name</span><span class=\"p\">;</span>\n<a id=\"__codelineno-10-29\" name=\"__codelineno-10-29\"></a><span class=\"w\">        </span><span class=\"n\">plugin</span><span class=\"o\">-&gt;</span><span class=\"n\">get_plugin_version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">get_plugin_version</span><span class=\"p\">;</span>\n<a id=\"__codelineno-10-30\" name=\"__codelineno-10-30\"></a><span class=\"w\">        </span><span class=\"n\">plugin</span><span class=\"o\">-&gt;</span><span class=\"n\">get_backend_options</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">get_backend_options</span><span class=\"p\">;</span>\n<a id=\"__codelineno-10-31\" name=\"__codelineno-10-31\"></a><span class=\"w\">        </span><span class=\"n\">plugin</span><span class=\"o\">-&gt;</span><span class=\"n\">get_backend_mems</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">get_backend_mems</span><span class=\"p\">;</span>\n<a id=\"__codelineno-10-32\" name=\"__codelineno-10-32\"></a><span class=\"w\">        </span><span class=\"n\">plugin</span><span class=\"o\">-&gt;</span><span class=\"n\">api_version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">NIXL_PLUGIN_API_VERSION</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// Set the API version</span>\n<a id=\"__codelineno-10-33\" name=\"__codelineno-10-33\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"p\">.</span><span class=\"n\">release</span><span class=\"p\">();</span>\n<a id=\"__codelineno-10-34\" name=\"__codelineno-10-34\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">catch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">exception</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-10-35\" name=\"__codelineno-10-35\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">;</span>\n<a id=\"__codelineno-10-36\" name=\"__codelineno-10-36\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-10-37\" name=\"__codelineno-10-37\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-10-38\" name=\"__codelineno-10-38\"></a>\n<a id=\"__codelineno-10-39\" name=\"__codelineno-10-39\"></a><span class=\"c1\">// Plugin cleanup function</span>\n<a id=\"__codelineno-10-40\" name=\"__codelineno-10-40\"></a><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">&quot;C&quot;</span><span class=\"w\"> </span><span class=\"n\">NIXL_PLUGIN_EXPORT</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">nixl_plugin_fini</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-10-41\" name=\"__codelineno-10-41\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u611f\u8c22\u60a8\u7684\u9605\u8bfb\uff0c\u4eca\u5929\u7684\u5185\u5bb9\u5c31\u5230\u8fd9\u91cc\u4e86\u3002\u901a\u8fc7\u672c\u6587\u6211\u4eec\u4e86\u89e3\u4e86c++\u9879\u76eeNIXL\u63d2\u4ef6\u6846\u67b6\u7684\u8bbe\u8ba1\u548c\u5b9e\u73b0\uff0c\u4ee5\u53ca\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u63d2\u4ef6\u3002</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/c\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898/\" target=\"_blank\">C++\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u6280\u6cd5\u5982\u4f55\u4e3a\u4e00\u4e2a\u7c7b\u52a8\u6001\u9644\u52a0\u4efb\u610f\u7c7b\u578b\u6570\u636e/\" target=\"_blank\">C++\u6280\u6cd5\uff1a\u5982\u4f55\u4e3a\u4e00\u4e2a\u7c7b\u52a8\u6001\u9644\u52a0\u4efb\u610f\u7c7b\u578b\u6570\u636e</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-08-03T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/rust-facet%E5%BA%93%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8F%8D%E5%B0%84/",
            "url": "https://github.com/KenForever1/blog/rust-facet%E5%BA%93%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8F%8D%E5%B0%84/",
            "title": "rust-facet\u5e93\u5982\u4f55\u5b9e\u73b0\u8fd0\u884c\u65f6\u53cd\u5c04",
            "content_html": "<!-- more -->\n\n<h2 id=\"\u4ecefacet-\u53cd\u5c04\u5b9e\u73b0\">\u4ecefacet \u53cd\u5c04\u5b9e\u73b0<a class=\"headerlink\" href=\"#\u4ecefacet-\u53cd\u5c04\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u4ece\u4f8b\u5b50\u770bfacet\u53cd\u5c04\u7684\u4e24\u5927\u529f\u80fd\">\u4ece\u4f8b\u5b50\u770bfacet\u53cd\u5c04\u7684\u4e24\u5927\u529f\u80fd<a class=\"headerlink\" href=\"#\u4ece\u4f8b\u5b50\u770bfacet\u53cd\u5c04\u7684\u4e24\u5927\u529f\u80fd\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\uff0c\u6bd4\u5982json\u3001yaml\u670d\u52a1\u3002</p>\n<h4 id=\"partial\u529f\u80fd\u4ecb\u7ecd\">Partial\u529f\u80fd\u4ecb\u7ecd<a class=\"headerlink\" href=\"#partial\u529f\u80fd\u4ecb\u7ecd\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7528\u4e8e\u6784\u5efa\u503c\uff0c\u53ef\u4ee5\u7528\u4e8e\u6839\u636ejson\u3001yaml\u7b49\u683c\u5f0f\uff0c\u53cd\u5e8f\u5217\u5316\u6784\u5efarust\u7c7b\u578b\u4ee5\u53ca\u8bbe\u7f6e\u6210\u5458\u7684\u503c\u3002\u5148\u901a\u8fc7Partial::alloc\u5206\u914d\u5173\u4e8e\u7c7b\u578bOuter\u7684\u672a\u521d\u59cb\u5316\u5185\u5b58\uff0c\u7136\u540e\u901a\u8fc7.begin_field(&ldquo;name&rdquo;).set(String::from(&ldquo;Hello, world!&rdquo;))\u4e3a\u6210\u5458name\u8bbe\u7f6e\u503c\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-36\">36</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"cp\">#[derive(Facet, PartialEq, Eq, Debug)]</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Outer</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a><span class=\"w\">    </span><span class=\"n\">name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">String</span><span class=\"p\">,</span>\n<a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\"></a><span class=\"w\">    </span><span class=\"n\">inner</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Inner</span><span class=\"p\">,</span>\n<a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\"></a>\n<a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\"></a><span class=\"cp\">#[derive(Facet, PartialEq, Eq, Debug)]</span>\n<a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Inner</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\"></a><span class=\"w\">    </span><span class=\"n\">x</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span>\n<a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\"></a><span class=\"w\">    </span><span class=\"n\">b</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span>\n<a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\"></a>\n<a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\"></a><span class=\"cp\">#[test]</span>\n<a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\"></a><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">wip_struct_testleak1</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\"></a><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Partial</span><span class=\"p\">::</span><span class=\"n\">alloc</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">Outer</span><span class=\"o\">&gt;</span><span class=\"p\">()</span>\n<a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">begin_field</span><span class=\"p\">(</span><span class=\"s\">&quot;name&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">set</span><span class=\"p\">(</span><span class=\"nb\">String</span><span class=\"p\">::</span><span class=\"n\">from</span><span class=\"p\">(</span><span class=\"s\">&quot;Hello, world!&quot;</span><span class=\"p\">))</span>\n<a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">end</span><span class=\"p\">()</span>\n<a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">begin_field</span><span class=\"p\">(</span><span class=\"s\">&quot;inner&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-20\" name=\"__codelineno-0-20\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">begin_field</span><span class=\"p\">(</span><span class=\"s\">&quot;x&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-21\" name=\"__codelineno-0-21\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">set</span><span class=\"p\">(</span><span class=\"mi\">42</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-22\" name=\"__codelineno-0-22\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">end</span><span class=\"p\">()</span>\n<a id=\"__codelineno-0-23\" name=\"__codelineno-0-23\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">begin_field</span><span class=\"p\">(</span><span class=\"s\">&quot;b&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-24\" name=\"__codelineno-0-24\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">set</span><span class=\"p\">(</span><span class=\"mi\">43</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-25\" name=\"__codelineno-0-25\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">end</span><span class=\"p\">()</span>\n<a id=\"__codelineno-0-26\" name=\"__codelineno-0-26\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">end</span><span class=\"p\">()</span>\n<a id=\"__codelineno-0-27\" name=\"__codelineno-0-27\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">build</span><span class=\"p\">();</span>\n<a id=\"__codelineno-0-28\" name=\"__codelineno-0-28\"></a>\n<a id=\"__codelineno-0-29\" name=\"__codelineno-0-29\"></a><span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span>\n<a id=\"__codelineno-0-30\" name=\"__codelineno-0-30\"></a><span class=\"w\">        </span><span class=\"o\">*</span><span class=\"n\">v</span><span class=\"p\">,</span>\n<a id=\"__codelineno-0-31\" name=\"__codelineno-0-31\"></a><span class=\"w\">        </span><span class=\"n\">Outer</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-32\" name=\"__codelineno-0-32\"></a><span class=\"w\">            </span><span class=\"n\">name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">String</span><span class=\"p\">::</span><span class=\"n\">from</span><span class=\"p\">(</span><span class=\"s\">&quot;Hello, world!&quot;</span><span class=\"p\">),</span>\n<a id=\"__codelineno-0-33\" name=\"__codelineno-0-33\"></a><span class=\"w\">            </span><span class=\"n\">inner</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Inner</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">43</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<a id=\"__codelineno-0-34\" name=\"__codelineno-0-34\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-0-35\" name=\"__codelineno-0-35\"></a><span class=\"w\">    </span><span class=\"p\">);</span>\n<a id=\"__codelineno-0-36\" name=\"__codelineno-0-36\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h4 id=\"peekvalue\u529f\u80fd\u4ecb\u7ecd\">PeekValue\u529f\u80fd\u4ecb\u7ecd<a class=\"headerlink\" href=\"#peekvalue\u529f\u80fd\u4ecb\u7ecd\" title=\"Permanent link\">&para;</a></h4>\n<p>\u67e5\u770b\u5b58\u5728\u7684\u503c\u3002\u4f8b\u5982\uff1a\u901a\u8fc7.field_by_name(&ldquo;number&rdquo;)\u83b7\u53d6number\u6210\u5458\u7684\u503c\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-35\">35</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"cp\">#[derive(Facet)]</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">TestStruct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a><span class=\"w\">    </span><span class=\"n\">number</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span>\n<a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\"></a><span class=\"w\">    </span><span class=\"n\">text</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">String</span><span class=\"p\">,</span>\n<a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\"></a>\n<a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\"></a><span class=\"cp\">#[test]</span>\n<a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\"></a><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">peek_struct</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\"></a><span class=\"w\">    </span><span class=\"c1\">// Create test struct instance</span>\n<a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\"></a><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">test_struct</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TestStruct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\"></a><span class=\"w\">        </span><span class=\"n\">number</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"p\">,</span>\n<a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\"></a><span class=\"w\">        </span><span class=\"n\">text</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;hello&quot;</span><span class=\"p\">.</span><span class=\"n\">to_string</span><span class=\"p\">(),</span>\n<a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\"></a><span class=\"w\">    </span><span class=\"p\">};</span>\n<a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\"></a><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">peek_value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Peek</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">test_struct</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\"></a>\n<a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\"></a><span class=\"w\">    </span><span class=\"c1\">// Convert to struct and check we can convert to PeekStruct</span>\n<a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\"></a><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">peek_struct</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">peek_value</span>\n<a id=\"__codelineno-1-18\" name=\"__codelineno-1-18\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">into_struct</span><span class=\"p\">()</span>\n<a id=\"__codelineno-1-19\" name=\"__codelineno-1-19\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">&quot;Should be convertible to struct&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-20\" name=\"__codelineno-1-20\"></a>\n<a id=\"__codelineno-1-21\" name=\"__codelineno-1-21\"></a><span class=\"w\">    </span><span class=\"c1\">// Test field access by name</span>\n<a id=\"__codelineno-1-22\" name=\"__codelineno-1-22\"></a><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">number_field</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">peek_struct</span>\n<a id=\"__codelineno-1-23\" name=\"__codelineno-1-23\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">field_by_name</span><span class=\"p\">(</span><span class=\"s\">&quot;number&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-1-24\" name=\"__codelineno-1-24\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">&quot;Should have a number field&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-25\" name=\"__codelineno-1-25\"></a><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">text_field</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">peek_struct</span>\n<a id=\"__codelineno-1-26\" name=\"__codelineno-1-26\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">field_by_name</span><span class=\"p\">(</span><span class=\"s\">&quot;text&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-1-27\" name=\"__codelineno-1-27\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">&quot;Should have a text field&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-28\" name=\"__codelineno-1-28\"></a>\n<a id=\"__codelineno-1-29\" name=\"__codelineno-1-29\"></a><span class=\"w\">    </span><span class=\"c1\">// Test field values</span>\n<a id=\"__codelineno-1-30\" name=\"__codelineno-1-30\"></a><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">number_value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">number_field</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"kt\">i32</span><span class=\"o\">&gt;</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<a id=\"__codelineno-1-31\" name=\"__codelineno-1-31\"></a><span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">number_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-32\" name=\"__codelineno-1-32\"></a>\n<a id=\"__codelineno-1-33\" name=\"__codelineno-1-33\"></a><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">text_value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">text_field</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"nb\">String</span><span class=\"o\">&gt;</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<a id=\"__codelineno-1-34\" name=\"__codelineno-1-34\"></a><span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">text_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;hello&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-35\" name=\"__codelineno-1-35\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"\u6838\u5fc3\u5b58\u50a8\u7ed3\u6784\">\u6838\u5fc3\u5b58\u50a8\u7ed3\u6784<a class=\"headerlink\" href=\"#\u6838\u5fc3\u5b58\u50a8\u7ed3\u6784\" title=\"Permanent link\">&para;</a></h3>\n<p>facet\u5b58\u50a8\u7684\u6838\u5fc3\u6570\u636e\u7ed3\u6784\uff0c</p>\n<ul>\n<li>SHAPE</li>\n<li>VTABLE\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-15\">15</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">Facet</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">facet</span><span class=\"o\">&gt;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">&#39;</span><span class=\"na\">facet</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a><span class=\"w\">    </span><span class=\"sd\">/// The shape of this type</span>\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a><span class=\"w\">    </span><span class=\"sd\">///</span>\n<a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a><span class=\"w\">    </span><span class=\"sd\">/// Shape embeds all other constants of this trait.</span>\n<a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">SHAPE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"o\">&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"nc\">Shape</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\"></a>\n<a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\"></a><span class=\"w\">    </span><span class=\"sd\">/// Function pointers to perform various operations: print the full type</span>\n<a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\"></a><span class=\"w\">    </span><span class=\"sd\">/// name (with generic type parameters), use the Display implementation,</span>\n<a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\"></a><span class=\"w\">    </span><span class=\"sd\">/// the Debug implementation, build a default value, clone, etc.</span>\n<a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\"></a><span class=\"w\">    </span><span class=\"sd\">///</span>\n<a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\"></a><span class=\"w\">    </span><span class=\"sd\">/// If [`Self::SHAPE`] has `ShapeLayout::Unsized`, then the parent pointer needs to be passed.</span>\n<a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\"></a><span class=\"w\">    </span><span class=\"sd\">///</span>\n<a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\"></a><span class=\"w\">    </span><span class=\"sd\">/// There are more specific vtables in variants of [`Def`]</span>\n<a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">VTABLE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"o\">&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"nc\">ValueVTable</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></li>\n</ul>\n<p>\u4e3acore\u3001alloc\u3001std\u7b49\u6a21\u5757\u4e2d\u7684\u6570\u636e\u7ed3\u6784\u90fd\u5b9e\u73b0\u4e86Facet trait\u3002\u4ee5\u5b9e\u73b0\u53cd\u5c04\u7684\u4e24\u5927\u529f\u80fd\u3002</p>\n<h3 id=\"string\u7c7b\u578b\u5982\u4f55\u5b9e\u73b0trait\">String\u7c7b\u578b\u5982\u4f55\u5b9e\u73b0trait<a class=\"headerlink\" href=\"#string\u7c7b\u578b\u5982\u4f55\u5b9e\u73b0trait\" title=\"Permanent link\">&para;</a></h3>\n<p>\u770b\u4e2a\u6700\u7b80\u5355\u7684\u7c7b\u578b\uff0c\u4ecealloc\u6a21\u5757\u4e2d\u5f15\u5165\u7684String\u7c7b\u578b\u3002\u5bf9\u6bcf\u4e2a\u7c7b\u578b\u4e3a\u4e86\u5b9e\u73b0\u53cd\u5c04\uff0c\u90fd\u6709\u4e00\u4e2a\u5b57\u7b26\u4e32\u7c7b\u578b\u7684\u63cf\u8ff0\u6807\u5fd7\uff0cString\u7c7b\u578b\u5c31\u662f&rdquo;String&rdquo;\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-29\">29</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"cp\">#[cfg(feature = </span><span class=\"s\">&quot;alloc&quot;</span><span class=\"cp\">)]</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Facet</span><span class=\"o\">&lt;&#39;</span><span class=\"nb\">_</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">alloc</span><span class=\"p\">::</span><span class=\"n\">string</span><span class=\"p\">::</span><span class=\"nb\">String</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">VTABLE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"o\">&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"nc\">ValueVTable</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a><span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">vtable</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">value_vtable</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">alloc</span><span class=\"p\">::</span><span class=\"n\">string</span><span class=\"p\">::</span><span class=\"nb\">String</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">f</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_opts</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"fm\">write!</span><span class=\"p\">(</span>\n<a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\"></a><span class=\"w\">            </span><span class=\"n\">f</span><span class=\"p\">,</span>\n<a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\"></a><span class=\"w\">            </span><span class=\"s\">&quot;{}&quot;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\"></a><span class=\"w\">            </span><span class=\"bp\">Self</span><span class=\"p\">::</span><span class=\"n\">SHAPE</span><span class=\"p\">.</span><span class=\"n\">type_identifier</span>\n<a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\"></a><span class=\"w\">        </span><span class=\"p\">));</span>\n<a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\"></a>\n<a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\"></a><span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">vtable_sized</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vtable</span><span class=\"p\">.</span><span class=\"n\">sized_mut</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\"></a><span class=\"w\">        </span><span class=\"c1\">// \u5982\u4f55\u89e3\u6790String\u7c7b\u578b</span>\n<a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\"></a><span class=\"w\">        </span><span class=\"n\">vtable_sized</span><span class=\"p\">.</span><span class=\"n\">parse</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\"></a><span class=\"w\">            </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">s</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\"></a><span class=\"w\">                </span><span class=\"c1\">// For String, parsing from a string is just copying the string</span>\n<a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\"></a><span class=\"w\">                </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">.</span><span class=\"n\">put</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">.</span><span class=\"n\">to_string</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">})</span>\n<a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\"></a><span class=\"w\">            </span><span class=\"p\">})</span>\n<a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\"></a><span class=\"w\">        </span><span class=\"p\">};</span>\n<a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\"></a>\n<a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\"></a><span class=\"w\">        </span><span class=\"n\">vtable</span>\n<a id=\"__codelineno-3-20\" name=\"__codelineno-3-20\"></a><span class=\"w\">    </span><span class=\"p\">};</span>\n<a id=\"__codelineno-3-21\" name=\"__codelineno-3-21\"></a>\n<a id=\"__codelineno-3-22\" name=\"__codelineno-3-22\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">SHAPE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"o\">&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"nc\">Shape</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-23\" name=\"__codelineno-3-23\"></a><span class=\"w\">        </span><span class=\"n\">Shape</span><span class=\"p\">::</span><span class=\"n\">builder_for_sized</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"bp\">Self</span><span class=\"o\">&gt;</span><span class=\"p\">()</span>\n<a id=\"__codelineno-3-24\" name=\"__codelineno-3-24\"></a><span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">def</span><span class=\"p\">(</span><span class=\"n\">Def</span><span class=\"p\">::</span><span class=\"n\">Scalar</span><span class=\"p\">)</span>\n<a id=\"__codelineno-3-25\" name=\"__codelineno-3-25\"></a><span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">type_identifier</span><span class=\"p\">(</span><span class=\"s\">&quot;String&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-3-26\" name=\"__codelineno-3-26\"></a><span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">ty</span><span class=\"p\">(</span><span class=\"n\">Type</span><span class=\"p\">::</span><span class=\"n\">User</span><span class=\"p\">(</span><span class=\"n\">UserType</span><span class=\"p\">::</span><span class=\"n\">Opaque</span><span class=\"p\">))</span>\n<a id=\"__codelineno-3-27\" name=\"__codelineno-3-27\"></a><span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">build</span><span class=\"p\">()</span>\n<a id=\"__codelineno-3-28\" name=\"__codelineno-3-28\"></a><span class=\"w\">    </span><span class=\"p\">};</span>\n<a id=\"__codelineno-3-29\" name=\"__codelineno-3-29\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"vtable\u5982\u4f55\u5b9e\u73b0\">VTABLE\u5982\u4f55\u5b9e\u73b0<a class=\"headerlink\" href=\"#vtable\u5982\u4f55\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h3>\n<p>\u901a\u8fc7ValueVTableBuilder\u7ed1\u5b9a\u4e86\u51fd\u6570\u6307\u9488\uff0c\u901a\u8fc7Spez\u7edf\u4e00\u8c03\u7528\u5230\u5bf9\u5e94\u7684\u51fd\u6570\u3002\nimpl! crate\n\u53ef\u4ee5\u5224\u65ad\u67d0\u4e2a\u7c7b\u578b\u662f\u5426\u5b9e\u73b0\u4e86\u67d0\u4e2a trait\uff0c<a href=\"https://docs.rs/impls/latest/impls/\">impls crate</a>\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-21\">21</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a><span class=\"cp\">#[macro_export]</span>\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a><span class=\"fm\">macro_rules!</span><span class=\"w\"> </span><span class=\"n\">value_vtable</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"cp\">$type_name</span><span class=\"p\">:</span><span class=\"nc\">ty</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"cp\">$type_name_fn</span><span class=\"p\">:</span><span class=\"nc\">expr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\"></a><span class=\"w\">        </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\"></a><span class=\"w\">            </span><span class=\"cp\">$crate</span><span class=\"p\">::</span><span class=\"n\">ValueVTable</span><span class=\"p\">::</span><span class=\"n\">builder</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"cp\">$type_name</span><span class=\"o\">&gt;</span><span class=\"p\">()</span>\n<a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\"></a><span class=\"w\">                </span><span class=\"p\">.</span><span class=\"n\">type_name</span><span class=\"p\">(</span><span class=\"cp\">$type_name_fn</span><span class=\"p\">)</span>\n<a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\"></a><span class=\"w\">                </span><span class=\"p\">.</span><span class=\"n\">display</span><span class=\"p\">(</span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\"></a><span class=\"w\">                    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"cp\">$crate</span><span class=\"p\">::</span><span class=\"n\">spez</span><span class=\"p\">::</span><span class=\"n\">impls</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"cp\">$type_name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">core</span><span class=\"p\">::</span><span class=\"n\">fmt</span><span class=\"p\">::</span><span class=\"n\">Display</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\"></a><span class=\"w\">                        </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\"></a><span class=\"w\">                            </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"cp\">$crate</span><span class=\"p\">::</span><span class=\"n\">spez</span><span class=\"p\">::</span><span class=\"o\">*</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\"></a><span class=\"w\">                            </span><span class=\"p\">(</span><span class=\"o\">&amp;&amp;</span><span class=\"n\">Spez</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">)).</span><span class=\"n\">spez_display</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">)</span>\n<a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\"></a><span class=\"w\">                        </span><span class=\"p\">})</span>\n<a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\"></a><span class=\"w\">                    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\"></a><span class=\"w\">                        </span><span class=\"nb\">None</span>\n<a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\"></a><span class=\"w\">                    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\"></a><span class=\"w\">                </span><span class=\"p\">})</span>\n<a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\"></a><span class=\"w\">                </span><span class=\"c1\">// ...</span>\n<a id=\"__codelineno-4-18\" name=\"__codelineno-4-18\"></a><span class=\"w\">                </span><span class=\"p\">.</span><span class=\"n\">build</span><span class=\"p\">()</span>\n<a id=\"__codelineno-4-19\" name=\"__codelineno-4-19\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-4-20\" name=\"__codelineno-4-20\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-4-21\" name=\"__codelineno-4-21\"></a><span class=\"p\">};</span><span class=\"w\">        </span>\n</code></pre></div></td></tr></table></div>\n<p>spec\u6a21\u5757\u5b9e\u73b0\u4e86\u201c\u81ea\u52a8\u89e3\u5f15\u7528\u7279\u5316\u8f85\u52a9\u5de5\u5177\u201d\u6307\u7684\u662f\u901a\u8fc7\u81ea\u52a8\u89e3\u5f15\u7528\uff08auto-deref\uff09\u6280\u672f\uff0c\u5b9e\u73b0\u7c7b\u4f3c\u4e8especialization\u7684\u529f\u80fd\u3002\n\u7b80\u800c\u8a00\u4e4b\uff0c\u672c\u6a21\u5757\u8ba9\u4f60\u53ef\u4ee5\u6839\u636e\u7c7b\u578b\u5b9e\u73b0\u7684 trait \u81ea\u52a8\u9009\u62e9\u66f4\u5408\u9002\u7684\u5b9e\u73b0\uff0c\u4e14\u4e0d\u9700\u8981\u7528\u5230 Rust \u8fd8\u672a\u7a33\u5b9a\u7684specialization feature\u529f\u80fd\u3002</p>\n<p><a href=\"https://github.com/dtolnay/case-studies/blob/master/autoref-specialization/README.md\">rust\u81ea\u52a8\u5f15\u7528\u7279\u5316\u53c2\u8003</a>\u3002</p>\n<p>\u4f8b\u5982\uff0c\u4e00\u4e2a\u7c7b\u578b\u5b9e\u73b0\u4e86 <code>Default</code> trait\uff0c\u90a3\u4e48 <code>spez_default_in_place</code> \u65b9\u6cd5\u4f1a\u8fd4\u56de\u4e00\u4e2a\u6307\u5411\u9ed8\u8ba4\u503c\u7684\u6307\u9488\u3002\u5c06\u9ed8\u8ba4\u503c\u5199\u5165\u5230\u6307\u5b9a\u7684\u5185\u5b58\u4f4d\u7f6e\uff0c\u4e5f\u5c31\u662fPtrUninit\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-39\">39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-40\">40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-41\">41</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a><span class=\"c1\">//////////////////////////////////////////////////////////////////////////////////////</span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a><span class=\"c1\">// Default (in place, because we can&#39;t have sized) \ud83c\udfe0\ud83d\udd04</span>\n<a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\"></a><span class=\"c1\">//////////////////////////////////////////////////////////////////////////////////////</span>\n<a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\"></a>\n<a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\"></a><span class=\"sd\">/// Specialization proxy for [`core::default::Default`]</span>\n<a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">SpezDefaultInPlaceYes</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\"></a><span class=\"w\">    </span><span class=\"sd\">/// Creates a default value for the inner type in place.</span>\n<a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\"></a><span class=\"w\">    </span><span class=\"sd\">///</span>\n<a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\"></a><span class=\"w\">    </span><span class=\"sd\">/// This method is called when the wrapped type implements `Default`.</span>\n<a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\"></a><span class=\"w\">    </span><span class=\"sd\">/// It writes the default value into the provided uninitialized memory.</span>\n<a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\"></a><span class=\"w\">    </span><span class=\"sd\">///</span>\n<a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\"></a><span class=\"w\">    </span><span class=\"sd\">/// # Safety</span>\n<a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\"></a><span class=\"w\">    </span><span class=\"sd\">///</span>\n<a id=\"__codelineno-5-14\" name=\"__codelineno-5-14\"></a><span class=\"w\">    </span><span class=\"sd\">/// This function operates on uninitialized memory and requires that `target`</span>\n<a id=\"__codelineno-5-15\" name=\"__codelineno-5-15\"></a><span class=\"w\">    </span><span class=\"sd\">/// has sufficient space allocated for type `T`.</span>\n<a id=\"__codelineno-5-16\" name=\"__codelineno-5-16\"></a><span class=\"w\">    </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">spez_default_in_place</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">PtrUninit</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">PtrMut</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-17\" name=\"__codelineno-5-17\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-5-18\" name=\"__codelineno-5-18\"></a><span class=\"k\">impl</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Default</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">SpezDefaultInPlaceYes</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">SpezEmpty</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-19\" name=\"__codelineno-5-19\"></a><span class=\"w\">    </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">spez_default_in_place</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">PtrUninit</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">PtrMut</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-20\" name=\"__codelineno-5-20\"></a><span class=\"w\">        </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">.</span><span class=\"n\">put</span><span class=\"p\">(</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nb\">Default</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">default</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-21\" name=\"__codelineno-5-21\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-22\" name=\"__codelineno-5-22\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-5-23\" name=\"__codelineno-5-23\"></a>\n<a id=\"__codelineno-5-24\" name=\"__codelineno-5-24\"></a><span class=\"sd\">/// Specialization proxy for [`core::default::Default`]</span>\n<a id=\"__codelineno-5-25\" name=\"__codelineno-5-25\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">SpezDefaultInPlaceNo</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-26\" name=\"__codelineno-5-26\"></a><span class=\"w\">    </span><span class=\"sd\">/// Fallback implementation when the type doesn&#39;t implement `Default`.</span>\n<a id=\"__codelineno-5-27\" name=\"__codelineno-5-27\"></a><span class=\"w\">    </span><span class=\"sd\">///</span>\n<a id=\"__codelineno-5-28\" name=\"__codelineno-5-28\"></a><span class=\"w\">    </span><span class=\"sd\">/// This method is used as a fallback and is designed to be unreachable in practice.</span>\n<a id=\"__codelineno-5-29\" name=\"__codelineno-5-29\"></a><span class=\"w\">    </span><span class=\"sd\">/// It&#39;s only selected when the wrapped type doesn&#39;t implement `Default`.</span>\n<a id=\"__codelineno-5-30\" name=\"__codelineno-5-30\"></a><span class=\"w\">    </span><span class=\"sd\">///</span>\n<a id=\"__codelineno-5-31\" name=\"__codelineno-5-31\"></a><span class=\"w\">    </span><span class=\"sd\">/// # Safety</span>\n<a id=\"__codelineno-5-32\" name=\"__codelineno-5-32\"></a><span class=\"w\">    </span><span class=\"sd\">///</span>\n<a id=\"__codelineno-5-33\" name=\"__codelineno-5-33\"></a><span class=\"w\">    </span><span class=\"sd\">/// This function is marked unsafe as it deals with uninitialized memory,</span>\n<a id=\"__codelineno-5-34\" name=\"__codelineno-5-34\"></a><span class=\"w\">    </span><span class=\"sd\">/// but it should never be reachable in practice.</span>\n<a id=\"__codelineno-5-35\" name=\"__codelineno-5-35\"></a><span class=\"w\">    </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">spez_default_in_place</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_target</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">PtrUninit</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">PtrMut</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-36\" name=\"__codelineno-5-36\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-5-37\" name=\"__codelineno-5-37\"></a><span class=\"k\">impl</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">SpezDefaultInPlaceNo</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">SpezEmpty</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-38\" name=\"__codelineno-5-38\"></a><span class=\"w\">    </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">spez_default_in_place</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_target</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">PtrUninit</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">PtrMut</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-39\" name=\"__codelineno-5-39\"></a><span class=\"w\">        </span><span class=\"fm\">unreachable!</span><span class=\"p\">()</span>\n<a id=\"__codelineno-5-40\" name=\"__codelineno-5-40\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-41\" name=\"__codelineno-5-41\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>ValueVTableBuilder\u662fValueVTable\u7c7b\u578b\u7684\u6784\u5efa\u5668\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-5\">5</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ValueVTableBuilder</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\"></a><span class=\"w\">    </span><span class=\"n\">type_name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">TypeNameFn</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\"></a><span class=\"w\">    </span><span class=\"n\">display</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">fn</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">DisplayFn</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\"></a><span class=\"w\">    </span><span class=\"c1\">// ...</span>\n<a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\ndisplay\u51fd\u6570\u5b9e\u73b0\u5c31\u662f\u901a\u8fc7transmute\u8fdb\u884c\u7c7b\u578b\u8f6c\u6362\uff0c\u4eceDisplayFnTyped\u7c7b\u578b\u8f6c\u6362\u4e3aDisplayFn\u3002</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-7-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-6\">6</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">display</span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">display</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">fn</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">DisplayFnTyped</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">Self</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\"></a><span class=\"w\">    </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">display</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\"></a><span class=\"w\">        </span><span class=\"n\">mem</span><span class=\"p\">::</span><span class=\"n\">transmute</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"k\">fn</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">DisplayFnTyped</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">DisplayFn</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"n\">display</span><span class=\"p\">)</span>\n<a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\"></a><span class=\"w\">    </span><span class=\"p\">};</span>\n<a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\"></a><span class=\"w\">    </span><span class=\"bp\">self</span>\n<a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-8-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-15\">15</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\"></a><span class=\"sd\">/// Function to format a value for display</span>\n<a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\"></a><span class=\"sd\">///</span>\n<a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\"></a><span class=\"sd\">/// If both [`DisplayFn`] and [`ParseFn`] are set, we should be able to round-trip the value.</span>\n<a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\"></a><span class=\"sd\">///</span>\n<a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\"></a><span class=\"sd\">/// # Safety</span>\n<a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\"></a><span class=\"sd\">///</span>\n<a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\"></a><span class=\"sd\">/// The `value` parameter must point to aligned, initialized memory of the correct type.</span>\n<a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">DisplayFn</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">PtrConst</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">mem</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">fmt</span><span class=\"p\">::</span><span class=\"n\">Formatter</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">core</span><span class=\"p\">::</span><span class=\"n\">fmt</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"p\">;</span>\n<a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\"></a>\n<a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\"></a>\n<a id=\"__codelineno-8-12\" name=\"__codelineno-8-12\"></a><span class=\"sd\">/// Function to format a value for display</span>\n<a id=\"__codelineno-8-13\" name=\"__codelineno-8-13\"></a><span class=\"sd\">///</span>\n<a id=\"__codelineno-8-14\" name=\"__codelineno-8-14\"></a><span class=\"sd\">/// If both [`DisplayFn`] and [`ParseFn`] are set, we should be able to round-trip the value.</span>\n<a id=\"__codelineno-8-15\" name=\"__codelineno-8-15\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">DisplayFnTyped</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">fmt</span><span class=\"p\">::</span><span class=\"n\">Formatter</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">core</span><span class=\"p\">::</span><span class=\"n\">fmt</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"p\">;</span><span class=\"o\">****</span>\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"shape\u5982\u4f55\u5b9e\u73b0\">SHAPE\u5982\u4f55\u5b9e\u73b0<a class=\"headerlink\" href=\"#shape\u5982\u4f55\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-9-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-8\">8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-9\">9</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\"></a><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\"></a><span class=\"w\">    </span><span class=\"sd\">/// Returns a builder for a shape for some type `T`.</span>\n<a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\"></a><span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">builder_for_sized</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Facet</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">a</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">ShapeBuilder</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\"></a><span class=\"w\">        </span><span class=\"n\">ShapeBuilder</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">::</span><span class=\"n\">VTABLE</span><span class=\"p\">)</span>\n<a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\"></a><span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">layout</span><span class=\"p\">(</span><span class=\"n\">Layout</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">())</span>\n<a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\"></a><span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"p\">(</span><span class=\"n\">ConstTypeId</span><span class=\"p\">::</span><span class=\"n\">of</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">())</span>\n<a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-9-8\" name=\"__codelineno-9-8\"></a><span class=\"w\">    </span><span class=\"c1\">// ....</span>\n<a id=\"__codelineno-9-9\" name=\"__codelineno-9-9\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-10-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-14\">14</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\"></a><span class=\"sd\">/// Builder for [`Shape`]</span>\n<a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ShapeBuilder</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\"></a><span class=\"w\">    </span><span class=\"n\">id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">ConstTypeId</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\"></a><span class=\"w\">    </span><span class=\"n\">layout</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">ShapeLayout</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"c1\">// \u8bb0\u5f55\u4e86layout\u4fe1\u606f</span>\n<a id=\"__codelineno-10-5\" name=\"__codelineno-10-5\"></a><span class=\"w\">    </span><span class=\"n\">vtable</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"o\">&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"nc\">ValueVTable</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"c1\">// \u8bb0\u5f55\u4e86vtable\u4fe1\u606f\uff0c\u5c31\u662f\u4e0a\u9762\u7684value_vtable\uff0c\u5b58\u50a8\u4e86\u51fd\u6570\u6307\u9488</span>\n<a id=\"__codelineno-10-6\" name=\"__codelineno-10-6\"></a><span class=\"w\">    </span><span class=\"n\">def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Def</span><span class=\"p\">,</span>\n<a id=\"__codelineno-10-7\" name=\"__codelineno-10-7\"></a><span class=\"w\">    </span><span class=\"n\">ty</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">Type</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-10-8\" name=\"__codelineno-10-8\"></a><span class=\"w\">    </span><span class=\"n\">type_identifier</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Option</span><span class=\"o\">&lt;&amp;&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"kt\">str</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-10-9\" name=\"__codelineno-10-9\"></a><span class=\"w\">    </span><span class=\"n\">type_params</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"o\">&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">TypeParam</span><span class=\"p\">],</span>\n<a id=\"__codelineno-10-10\" name=\"__codelineno-10-10\"></a><span class=\"w\">    </span><span class=\"n\">doc</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"o\">&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">&amp;&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"kt\">str</span><span class=\"p\">],</span>\n<a id=\"__codelineno-10-11\" name=\"__codelineno-10-11\"></a><span class=\"w\">    </span><span class=\"n\">attributes</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"o\">&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">ShapeAttribute</span><span class=\"p\">],</span>\n<a id=\"__codelineno-10-12\" name=\"__codelineno-10-12\"></a><span class=\"w\">    </span><span class=\"n\">type_tag</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Option</span><span class=\"o\">&lt;&amp;&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"kt\">str</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-10-13\" name=\"__codelineno-10-13\"></a><span class=\"w\">    </span><span class=\"n\">inner</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"k\">fn</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"o\">&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"nc\">Shape</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-10-14\" name=\"__codelineno-10-14\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>layout\u662f\u4ec0\u4e48\u5462\uff1f\u5b9e\u9645\u4e0a\u5c31\u662f\u5b58\u50a8\u7684core::alloc::Layout\uff0c\u8bb0\u5f55\u4e86Size\u3001Align\u7b49\u4fe1\u606f\u3002\u53ef\u4ee5\u5206\u914d\u4e00\u6bb5\u8be5\u7c7b\u578b\u7684\u672a\u521d\u59cb\u5316\u5185\u5b58\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u53cd\u5e8f\u5217\u5316\u65f6\u5c06\u5185\u5b58\u5199\u5165\u5230\u6307\u5b9a\u7684\u5185\u5b58\u4e2d\uff0c\u5c31\u6784\u9020\u51fa\u4e86type\u7684\u5b9e\u4f8b\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-11-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-32\">32</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\"></a><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">alloc</span><span class=\"p\">::</span><span class=\"n\">Layout</span><span class=\"p\">;</span>\n<a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\"></a>\n<a id=\"__codelineno-11-3\" name=\"__codelineno-11-3\"></a><span class=\"sd\">/// Schema for reflection of a type</span>\n<a id=\"__codelineno-11-4\" name=\"__codelineno-11-4\"></a><span class=\"cp\">#[derive(Clone, Copy)]</span>\n<a id=\"__codelineno-11-5\" name=\"__codelineno-11-5\"></a><span class=\"cp\">#[repr(C)]</span>\n<a id=\"__codelineno-11-6\" name=\"__codelineno-11-6\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Shape</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-11-7\" name=\"__codelineno-11-7\"></a><span class=\"w\">    </span><span class=\"sd\">/// Unique type identifier, provided by the compiler.</span>\n<a id=\"__codelineno-11-8\" name=\"__codelineno-11-8\"></a><span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ConstTypeId</span><span class=\"p\">,</span>\n<a id=\"__codelineno-11-9\" name=\"__codelineno-11-9\"></a>\n<a id=\"__codelineno-11-10\" name=\"__codelineno-11-10\"></a><span class=\"w\">    </span><span class=\"sd\">/// Size, alignment \u2014 enough to allocate a value of this type</span>\n<a id=\"__codelineno-11-11\" name=\"__codelineno-11-11\"></a><span class=\"w\">    </span><span class=\"sd\">/// (but not initialize it.)</span>\n<a id=\"__codelineno-11-12\" name=\"__codelineno-11-12\"></a><span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"n\">layout</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ShapeLayout</span><span class=\"p\">,</span>\n<a id=\"__codelineno-11-13\" name=\"__codelineno-11-13\"></a>\n<a id=\"__codelineno-11-14\" name=\"__codelineno-11-14\"></a><span class=\"w\">    </span><span class=\"sd\">/// Function pointers to perform various operations: print the full type</span>\n<a id=\"__codelineno-11-15\" name=\"__codelineno-11-15\"></a><span class=\"w\">    </span><span class=\"sd\">/// name (with generic type parameters), use the Display implementation,</span>\n<a id=\"__codelineno-11-16\" name=\"__codelineno-11-16\"></a><span class=\"w\">    </span><span class=\"sd\">/// the Debug implementation, build a default value, clone, etc.</span>\n<a id=\"__codelineno-11-17\" name=\"__codelineno-11-17\"></a><span class=\"w\">    </span><span class=\"sd\">///</span>\n<a id=\"__codelineno-11-18\" name=\"__codelineno-11-18\"></a><span class=\"w\">    </span><span class=\"sd\">/// If the shape has `ShapeLayout::Unsized`, then the parent pointer needs to be passed.</span>\n<a id=\"__codelineno-11-19\" name=\"__codelineno-11-19\"></a><span class=\"w\">    </span><span class=\"sd\">///</span>\n<a id=\"__codelineno-11-20\" name=\"__codelineno-11-20\"></a><span class=\"w\">    </span><span class=\"sd\">/// There are more specific vtables in variants of [`Def`]</span>\n<a id=\"__codelineno-11-21\" name=\"__codelineno-11-21\"></a><span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"n\">vtable</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"o\">&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"nc\">ValueVTable</span><span class=\"p\">,</span>\n<a id=\"__codelineno-11-22\" name=\"__codelineno-11-22\"></a><span class=\"w\">    </span><span class=\"c1\">// ...</span>\n<a id=\"__codelineno-11-23\" name=\"__codelineno-11-23\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-11-24\" name=\"__codelineno-11-24\"></a>\n<a id=\"__codelineno-11-25\" name=\"__codelineno-11-25\"></a><span class=\"sd\">/// Layout of the shape</span>\n<a id=\"__codelineno-11-26\" name=\"__codelineno-11-26\"></a><span class=\"cp\">#[derive(Clone, Copy, Debug, Hash)]</span>\n<a id=\"__codelineno-11-27\" name=\"__codelineno-11-27\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">enum</span><span class=\"w\"> </span><span class=\"nc\">ShapeLayout</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-11-28\" name=\"__codelineno-11-28\"></a><span class=\"w\">    </span><span class=\"sd\">/// `Sized` type</span>\n<a id=\"__codelineno-11-29\" name=\"__codelineno-11-29\"></a><span class=\"w\">    </span><span class=\"nb\">Sized</span><span class=\"p\">(</span><span class=\"n\">Layout</span><span class=\"p\">),</span>\n<a id=\"__codelineno-11-30\" name=\"__codelineno-11-30\"></a><span class=\"w\">    </span><span class=\"sd\">/// `!Sized` type</span>\n<a id=\"__codelineno-11-31\" name=\"__codelineno-11-31\"></a><span class=\"w\">    </span><span class=\"n\">Unsized</span><span class=\"p\">,</span>\n<a id=\"__codelineno-11-32\" name=\"__codelineno-11-32\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<h4 id=\"\u5982\u4f55\u5728\u5806\u4e0a\u5206\u914d\u4e00\u6bb5\u672a\u521d\u59cb\u5316\u5185\u5b58\">\u5982\u4f55\u5728\u5806\u4e0a\u5206\u914d\u4e00\u6bb5\u672a\u521d\u59cb\u5316\u5185\u5b58\uff1f<a class=\"headerlink\" href=\"#\u5982\u4f55\u5728\u5806\u4e0a\u5206\u914d\u4e00\u6bb5\u672a\u521d\u59cb\u5316\u5185\u5b58\" title=\"Permanent link\">&para;</a></h4>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-12-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-35\">35</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-12-1\" name=\"__codelineno-12-1\"></a><span class=\"c1\">// facet/facet-core/src/types/mod.rs</span>\n<a id=\"__codelineno-12-2\" name=\"__codelineno-12-2\"></a><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-12-3\" name=\"__codelineno-12-3\"></a><span class=\"w\">    </span><span class=\"sd\">/// Heap-allocate a value of this shape</span>\n<a id=\"__codelineno-12-4\" name=\"__codelineno-12-4\"></a><span class=\"w\">    </span><span class=\"cp\">#[cfg(feature = </span><span class=\"s\">&quot;alloc&quot;</span><span class=\"cp\">)]</span>\n<a id=\"__codelineno-12-5\" name=\"__codelineno-12-5\"></a><span class=\"w\">    </span><span class=\"cp\">#[inline]</span>\n<a id=\"__codelineno-12-6\" name=\"__codelineno-12-6\"></a><span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">allocate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"k\">crate</span><span class=\"p\">::</span><span class=\"n\">ptr</span><span class=\"p\">::</span><span class=\"n\">PtrUninit</span><span class=\"o\">&lt;&#39;</span><span class=\"nb\">static</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">UnsizedError</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-12-7\" name=\"__codelineno-12-7\"></a><span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">layout</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">layout</span><span class=\"p\">.</span><span class=\"n\">sized_layout</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<a id=\"__codelineno-12-8\" name=\"__codelineno-12-8\"></a>\n<a id=\"__codelineno-12-9\" name=\"__codelineno-12-9\"></a><span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"k\">crate</span><span class=\"p\">::</span><span class=\"n\">ptr</span><span class=\"p\">::</span><span class=\"n\">PtrUninit</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">layout</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-12-10\" name=\"__codelineno-12-10\"></a><span class=\"w\">            </span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">ptr</span><span class=\"p\">::</span><span class=\"n\">without_provenance_mut</span><span class=\"p\">(</span><span class=\"n\">layout</span><span class=\"p\">.</span><span class=\"n\">align</span><span class=\"p\">())</span>\n<a id=\"__codelineno-12-11\" name=\"__codelineno-12-11\"></a><span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-12-12\" name=\"__codelineno-12-12\"></a><span class=\"w\">            </span><span class=\"c1\">// SAFETY: We have checked that layout&#39;s size is non-zero</span>\n<a id=\"__codelineno-12-13\" name=\"__codelineno-12-13\"></a><span class=\"w\">            </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">alloc</span><span class=\"p\">::</span><span class=\"n\">alloc</span><span class=\"p\">::</span><span class=\"n\">alloc</span><span class=\"p\">(</span><span class=\"n\">layout</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<a id=\"__codelineno-12-14\" name=\"__codelineno-12-14\"></a><span class=\"w\">        </span><span class=\"p\">}))</span>\n<a id=\"__codelineno-12-15\" name=\"__codelineno-12-15\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-12-16\" name=\"__codelineno-12-16\"></a>\n<a id=\"__codelineno-12-17\" name=\"__codelineno-12-17\"></a><span class=\"w\">    </span><span class=\"sd\">/// Deallocate a heap-allocated value of this shape</span>\n<a id=\"__codelineno-12-18\" name=\"__codelineno-12-18\"></a><span class=\"w\">    </span><span class=\"cp\">#[cfg(feature = </span><span class=\"s\">&quot;alloc&quot;</span><span class=\"cp\">)]</span>\n<a id=\"__codelineno-12-19\" name=\"__codelineno-12-19\"></a><span class=\"w\">    </span><span class=\"cp\">#[inline]</span>\n<a id=\"__codelineno-12-20\" name=\"__codelineno-12-20\"></a><span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">deallocate_mut</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">PtrMut</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">UnsizedError</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-12-21\" name=\"__codelineno-12-21\"></a><span class=\"w\">        </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">alloc</span><span class=\"p\">::</span><span class=\"n\">alloc</span><span class=\"p\">::</span><span class=\"n\">dealloc</span><span class=\"p\">;</span>\n<a id=\"__codelineno-12-22\" name=\"__codelineno-12-22\"></a>\n<a id=\"__codelineno-12-23\" name=\"__codelineno-12-23\"></a><span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">layout</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">layout</span><span class=\"p\">.</span><span class=\"n\">sized_layout</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<a id=\"__codelineno-12-24\" name=\"__codelineno-12-24\"></a>\n<a id=\"__codelineno-12-25\" name=\"__codelineno-12-25\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">layout</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-12-26\" name=\"__codelineno-12-26\"></a><span class=\"w\">            </span><span class=\"c1\">// Nothing to deallocate</span>\n<a id=\"__codelineno-12-27\" name=\"__codelineno-12-27\"></a><span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Ok</span><span class=\"p\">(());</span>\n<a id=\"__codelineno-12-28\" name=\"__codelineno-12-28\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-12-29\" name=\"__codelineno-12-29\"></a><span class=\"w\">        </span><span class=\"c1\">// SAFETY: The user guarantees ptr is valid and from allocate, we checked size isn&#39;t 0</span>\n<a id=\"__codelineno-12-30\" name=\"__codelineno-12-30\"></a><span class=\"w\">        </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">dealloc</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"p\">.</span><span class=\"n\">as_mut_byte_ptr</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">layout</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<a id=\"__codelineno-12-31\" name=\"__codelineno-12-31\"></a>\n<a id=\"__codelineno-12-32\" name=\"__codelineno-12-32\"></a><span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<a id=\"__codelineno-12-33\" name=\"__codelineno-12-33\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-12-34\" name=\"__codelineno-12-34\"></a><span class=\"w\">    </span><span class=\"c1\">// ...</span>\n<a id=\"__codelineno-12-35\" name=\"__codelineno-12-35\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u4ec0\u4e48\u65f6\u5019\u4f1a\u7528\u5230\u6839\u636elayout\u5206\u914d\u5185\u5b58\u5462\uff1f\u5728facet reflect\u7684Partial\u529f\u80fd\u4e2d\u3002\u8fd8\u8bb0\u5f97\u6700\u524d\u9762\u7684Partial\u5c31\u662f\u8c03\u7528\u4e86alloc\u51fd\u6570\u5206\u914dOuter\u7c7b\u578b\u7684\u5185\u5b58\u5417\uff1f\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-13-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-27\">27</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-13-1\" name=\"__codelineno-13-1\"></a><span class=\"k\">impl</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">facet</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">Partial</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">facet</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-13-2\" name=\"__codelineno-13-2\"></a><span class=\"w\">    </span><span class=\"sd\">/// Allocates a new Partial instance with the given shape</span>\n<a id=\"__codelineno-13-3\" name=\"__codelineno-13-3\"></a><span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">alloc_shape</span><span class=\"p\">(</span><span class=\"n\">shape</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"o\">&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"nc\">Shape</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"bp\">Self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ReflectError</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-13-4\" name=\"__codelineno-13-4\"></a><span class=\"w\">        </span><span class=\"k\">crate</span><span class=\"p\">::</span><span class=\"n\">trace</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<a id=\"__codelineno-13-5\" name=\"__codelineno-13-5\"></a><span class=\"w\">            </span><span class=\"s\">&quot;alloc_shape({:?}), with layout {:?}&quot;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-13-6\" name=\"__codelineno-13-6\"></a><span class=\"w\">            </span><span class=\"n\">shape</span><span class=\"p\">,</span>\n<a id=\"__codelineno-13-7\" name=\"__codelineno-13-7\"></a><span class=\"w\">            </span><span class=\"n\">shape</span><span class=\"p\">.</span><span class=\"n\">layout</span><span class=\"p\">.</span><span class=\"n\">sized_layout</span><span class=\"p\">()</span>\n<a id=\"__codelineno-13-8\" name=\"__codelineno-13-8\"></a><span class=\"w\">        </span><span class=\"p\">);</span>\n<a id=\"__codelineno-13-9\" name=\"__codelineno-13-9\"></a>\n<a id=\"__codelineno-13-10\" name=\"__codelineno-13-10\"></a><span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"p\">.</span><span class=\"n\">allocate</span><span class=\"p\">().</span><span class=\"n\">map_err</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">_</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">ReflectError</span><span class=\"p\">::</span><span class=\"n\">Unsized</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-13-11\" name=\"__codelineno-13-11\"></a><span class=\"w\">            </span><span class=\"n\">shape</span><span class=\"p\">,</span>\n<a id=\"__codelineno-13-12\" name=\"__codelineno-13-12\"></a><span class=\"w\">            </span><span class=\"n\">operation</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;alloc_shape&quot;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-13-13\" name=\"__codelineno-13-13\"></a><span class=\"w\">        </span><span class=\"p\">})</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<a id=\"__codelineno-13-14\" name=\"__codelineno-13-14\"></a><span class=\"w\">        </span><span class=\"c1\">// ....</span>\n<a id=\"__codelineno-13-15\" name=\"__codelineno-13-15\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-13-16\" name=\"__codelineno-13-16\"></a>\n<a id=\"__codelineno-13-17\" name=\"__codelineno-13-17\"></a><span class=\"w\">    </span><span class=\"sd\">/// Allocates a new TypedPartial instance with the given shape and type</span>\n<a id=\"__codelineno-13-18\" name=\"__codelineno-13-18\"></a><span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">alloc</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">TypedPartial</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">facet</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ReflectError</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-13-19\" name=\"__codelineno-13-19\"></a><span class=\"w\">    </span><span class=\"k\">where</span>\n<a id=\"__codelineno-13-20\" name=\"__codelineno-13-20\"></a><span class=\"w\">        </span><span class=\"n\">T</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Facet</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">facet</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-13-21\" name=\"__codelineno-13-21\"></a><span class=\"w\">    </span><span class=\"p\">{</span>\n<a id=\"__codelineno-13-22\" name=\"__codelineno-13-22\"></a><span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">TypedPartial</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-13-23\" name=\"__codelineno-13-23\"></a><span class=\"w\">            </span><span class=\"n\">inner</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Self</span><span class=\"p\">::</span><span class=\"n\">alloc_shape</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">::</span><span class=\"n\">SHAPE</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<a id=\"__codelineno-13-24\" name=\"__codelineno-13-24\"></a><span class=\"w\">            </span><span class=\"n\">phantom</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">PhantomData</span><span class=\"p\">,</span>\n<a id=\"__codelineno-13-25\" name=\"__codelineno-13-25\"></a><span class=\"w\">        </span><span class=\"p\">})</span>\n<a id=\"__codelineno-13-26\" name=\"__codelineno-13-26\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-13-27\" name=\"__codelineno-13-27\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"partial\u7684\u5b9e\u73b0\u539f\u7406\">Partial\u7684\u5b9e\u73b0\u539f\u7406<a class=\"headerlink\" href=\"#partial\u7684\u5b9e\u73b0\u539f\u7406\" title=\"Permanent link\">&para;</a></h3>\n<p>Partial\u901a\u8fc7\u4e00\u4e2aVec&lt;Frame&gt;\u6765\u4fdd\u5b58\u64cd\u4f5c\u7684\u5143\u7d20\u3002\u4ee5Partial\u6784\u9020\u4e00\u4e2aStruct\u4e3a\u4f8b\u3002\u5f53\u524d\u64cd\u4f5cname field\uff0c\u90a3\u4e48Vec\u4fdd\u5b58\u7684\u6700\u540e\u4e00\u5e27\u5c31\u662f\u8bb0\u5f55\u7684name fileld\u7684\u4fe1\u606f\uff0c\u5305\u62ecshape\u3001\u6570\u636e\u6307\u9488\u3001\u72b6\u6001Tracker\u7b49\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-14-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-19\">19</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-14-1\" name=\"__codelineno-14-1\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Partial</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">facet</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-14-2\" name=\"__codelineno-14-2\"></a><span class=\"w\">    </span><span class=\"sd\">/// stack of frames to keep track of deeply nested initialization</span>\n<a id=\"__codelineno-14-3\" name=\"__codelineno-14-3\"></a><span class=\"w\">    </span><span class=\"n\">frames</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"n\">Frame</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-14-4\" name=\"__codelineno-14-4\"></a><span class=\"w\">    </span><span class=\"c1\">// ...</span>\n<a id=\"__codelineno-14-5\" name=\"__codelineno-14-5\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-14-6\" name=\"__codelineno-14-6\"></a>\n<a id=\"__codelineno-14-7\" name=\"__codelineno-14-7\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Frame</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-14-8\" name=\"__codelineno-14-8\"></a><span class=\"w\">    </span><span class=\"sd\">/// Address of the value being initialized</span>\n<a id=\"__codelineno-14-9\" name=\"__codelineno-14-9\"></a><span class=\"w\">    </span><span class=\"n\">data</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">PtrUninit</span><span class=\"o\">&lt;&#39;</span><span class=\"nb\">static</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-14-10\" name=\"__codelineno-14-10\"></a>\n<a id=\"__codelineno-14-11\" name=\"__codelineno-14-11\"></a><span class=\"w\">    </span><span class=\"sd\">/// Shape of the value being initialized</span>\n<a id=\"__codelineno-14-12\" name=\"__codelineno-14-12\"></a><span class=\"w\">    </span><span class=\"n\">shape</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"o\">&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"nc\">Shape</span><span class=\"p\">,</span>\n<a id=\"__codelineno-14-13\" name=\"__codelineno-14-13\"></a>\n<a id=\"__codelineno-14-14\" name=\"__codelineno-14-14\"></a><span class=\"w\">    </span><span class=\"sd\">/// Tracks initialized fields</span>\n<a id=\"__codelineno-14-15\" name=\"__codelineno-14-15\"></a><span class=\"w\">    </span><span class=\"n\">tracker</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Tracker</span><span class=\"p\">,</span>\n<a id=\"__codelineno-14-16\" name=\"__codelineno-14-16\"></a>\n<a id=\"__codelineno-14-17\" name=\"__codelineno-14-17\"></a><span class=\"w\">    </span><span class=\"sd\">/// Whether this frame owns the allocation or is just a field pointer</span>\n<a id=\"__codelineno-14-18\" name=\"__codelineno-14-18\"></a><span class=\"w\">    </span><span class=\"n\">ownership</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">FrameOwnership</span><span class=\"p\">,</span>\n<a id=\"__codelineno-14-19\" name=\"__codelineno-14-19\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n\u4ece\u524d\u9762\u7684\u4f8b\u5b50\u770b\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-15-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-13\">13</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-15-1\" name=\"__codelineno-15-1\"></a><span class=\"cp\">#[derive(Facet, PartialEq, Eq, Debug)]</span>\n<a id=\"__codelineno-15-2\" name=\"__codelineno-15-2\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Outer</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-15-3\" name=\"__codelineno-15-3\"></a><span class=\"w\">    </span><span class=\"n\">name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">String</span><span class=\"p\">,</span>\n<a id=\"__codelineno-15-4\" name=\"__codelineno-15-4\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-15-5\" name=\"__codelineno-15-5\"></a>\n<a id=\"__codelineno-15-6\" name=\"__codelineno-15-6\"></a><span class=\"cp\">#[test]</span>\n<a id=\"__codelineno-15-7\" name=\"__codelineno-15-7\"></a><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">wip_struct_testleak1</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-15-8\" name=\"__codelineno-15-8\"></a><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Partial</span><span class=\"p\">::</span><span class=\"n\">alloc</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">Outer</span><span class=\"o\">&gt;</span><span class=\"p\">()</span>\n<a id=\"__codelineno-15-9\" name=\"__codelineno-15-9\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">begin_field</span><span class=\"p\">(</span><span class=\"s\">&quot;name&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-15-10\" name=\"__codelineno-15-10\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">set</span><span class=\"p\">(</span><span class=\"nb\">String</span><span class=\"p\">::</span><span class=\"n\">from</span><span class=\"p\">(</span><span class=\"s\">&quot;Hello, world!&quot;</span><span class=\"p\">))</span>\n<a id=\"__codelineno-15-11\" name=\"__codelineno-15-11\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">end</span><span class=\"p\">()</span>\n<a id=\"__codelineno-15-12\" name=\"__codelineno-15-12\"></a><span class=\"w\">    </span><span class=\"c1\">// ......</span>\n<a id=\"__codelineno-15-13\" name=\"__codelineno-15-13\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u9996\u5148,alloc\u5206\u914dOuter\u7c7b\u578b\u6211\u4eec\u5df2\u7ecf\u4ecb\u7ecd\u6e05\u695a\u4e86\u3002\u4ecebegin_field\u8bf4\u8d77\u3002\n\u6839\u636efield_name, \u4f8b\u5982Outer \u7ed3\u6784\u4f53\u7684name\u5b57\u6bb5\uff0c\u5148\u83b7\u53d6Struct\u7684struct_type.fields\uff0c\u7136\u540e\u83b7\u53d6\u5230\u4e00\u4e2aindex\u3002\u5c31\u53ef\u4ee5\u6839\u636eindex\u53bb\u83b7\u53d6\u8fd9\u4e2afield\u7684\u4fe1\u606f\u4e86\u3002\u6211\u4eec\u7684\u76ee\u7684\u662f\u83b7\u53d6field\u7684Shape\u548c\u672a\u521d\u59cb\u5316\u6307\u9488\uff0c\u540e\u7eed\u5c31\u53ef\u4ee5\u901a\u8fc7set\u51fd\u6570\u8bbe\u7f6e\u8be5\u5b57\u6bb5\u7684\u503c\u3002</p>\n<p>self.frames.last_mut()\u5c31\u662f\u83b7\u53d6\u5f53\u524d\u6808\u5e27\u3002\u5f53\u524d\u64cd\u4f5c\u7684\u662fStruct\u7c7b\u578b\u7684\u6808\u5e27\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-16-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-22\">22</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-16-1\" name=\"__codelineno-16-1\"></a><span class=\"c1\">// /home/ken/tmp/facet/facet-reflect/src/partial/mod.rs</span>\n<a id=\"__codelineno-16-2\" name=\"__codelineno-16-2\"></a><span class=\"sd\">/// Selects a field of a struct with a given name</span>\n<a id=\"__codelineno-16-3\" name=\"__codelineno-16-3\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">begin_field</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">field_name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"kt\">str</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">Self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ReflectError</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-16-4\" name=\"__codelineno-16-4\"></a><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">frames</span><span class=\"p\">.</span><span class=\"n\">last_mut</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<a id=\"__codelineno-16-5\" name=\"__codelineno-16-5\"></a><span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">frame</span><span class=\"p\">.</span><span class=\"n\">shape</span><span class=\"p\">.</span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-16-6\" name=\"__codelineno-16-6\"></a><span class=\"w\">        </span><span class=\"n\">Type</span><span class=\"p\">::</span><span class=\"n\">User</span><span class=\"p\">(</span><span class=\"n\">user_type</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">user_type</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-16-7\" name=\"__codelineno-16-7\"></a><span class=\"w\">            </span><span class=\"n\">UserType</span><span class=\"p\">::</span><span class=\"n\">Struct</span><span class=\"p\">(</span><span class=\"n\">struct_type</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-16-8\" name=\"__codelineno-16-8\"></a><span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">struct_type</span><span class=\"p\">.</span><span class=\"n\">fields</span><span class=\"p\">.</span><span class=\"n\">iter</span><span class=\"p\">().</span><span class=\"n\">position</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">f</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"p\">.</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">field_name</span><span class=\"p\">);</span>\n<a id=\"__codelineno-16-9\" name=\"__codelineno-16-9\"></a><span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-16-10\" name=\"__codelineno-16-10\"></a><span class=\"w\">                    </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">idx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">,</span>\n<a id=\"__codelineno-16-11\" name=\"__codelineno-16-11\"></a><span class=\"w\">                    </span><span class=\"nb\">None</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-16-12\" name=\"__codelineno-16-12\"></a><span class=\"w\">                        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">ReflectError</span><span class=\"p\">::</span><span class=\"n\">OperationFailed</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-16-13\" name=\"__codelineno-16-13\"></a><span class=\"w\">                            </span><span class=\"n\">shape</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">frame</span><span class=\"p\">.</span><span class=\"n\">shape</span><span class=\"p\">,</span>\n<a id=\"__codelineno-16-14\" name=\"__codelineno-16-14\"></a><span class=\"w\">                            </span><span class=\"n\">operation</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;field not found&quot;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-16-15\" name=\"__codelineno-16-15\"></a><span class=\"w\">                        </span><span class=\"p\">});</span>\n<a id=\"__codelineno-16-16\" name=\"__codelineno-16-16\"></a><span class=\"w\">                    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-16-17\" name=\"__codelineno-16-17\"></a><span class=\"w\">                </span><span class=\"p\">};</span>\n<a id=\"__codelineno-16-18\" name=\"__codelineno-16-18\"></a><span class=\"w\">                </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">begin_nth_field</span><span class=\"p\">(</span><span class=\"n\">idx</span><span class=\"p\">)</span>\n<a id=\"__codelineno-16-19\" name=\"__codelineno-16-19\"></a><span class=\"w\">            </span><span class=\"p\">}</span>\n<a id=\"__codelineno-16-20\" name=\"__codelineno-16-20\"></a><span class=\"w\">        </span><span class=\"p\">},</span>\n<a id=\"__codelineno-16-21\" name=\"__codelineno-16-21\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-16-22\" name=\"__codelineno-16-22\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u8c03\u7528begin_nth_field\u51fd\u6570\u65f6\uff0c\u6700\u540e\u4e00\u4e2aFrame\u8fd8\u662fStruct\u7684\u4fe1\u606f\u3002\n\u5728\u627e\u5230name feild\u540e\uff0c\u5982\u679c\u5df2\u7ecf\u521d\u59cb\u5316\uff0c\u5c31\u5148drop\u521d\u59cb\u5316\u7684\u6570\u636e\uff0c\u7136\u540e\u540e\u7eed\u91cd\u65b0\u521d\u59cb\u5316\u3002\u540c\u65f6\uff0c\u66f4\u65b0\u6700\u540e\u4e00\u5e27\uff0c\u4e5f\u5c31\u662flast_frame\u4e3a\u5f53\u524d\u64cd\u4f5c\u7684Struct\u7684name field\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-17-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-39\">39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-40\">40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-41\">41</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-42\">42</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-43\">43</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-44\">44</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-45\">45</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-46\">46</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-47\">47</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-48\">48</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-49\">49</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-50\">50</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-51\">51</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-52\">52</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-53\">53</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-54\">54</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-55\">55</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-17-1\" name=\"__codelineno-17-1\"></a><span class=\"w\"> </span><span class=\"sd\">/// Selects the nth field of a struct by index</span>\n<a id=\"__codelineno-17-2\" name=\"__codelineno-17-2\"></a><span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">begin_nth_field</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">Self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ReflectError</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-17-3\" name=\"__codelineno-17-3\"></a><span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">frames</span><span class=\"p\">.</span><span class=\"n\">last_mut</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<a id=\"__codelineno-17-4\" name=\"__codelineno-17-4\"></a><span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">frame</span><span class=\"p\">.</span><span class=\"n\">shape</span><span class=\"p\">.</span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-17-5\" name=\"__codelineno-17-5\"></a><span class=\"w\">            </span><span class=\"n\">Type</span><span class=\"p\">::</span><span class=\"n\">User</span><span class=\"p\">(</span><span class=\"n\">user_type</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">user_type</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-17-6\" name=\"__codelineno-17-6\"></a><span class=\"w\">                </span><span class=\"n\">UserType</span><span class=\"p\">::</span><span class=\"n\">Struct</span><span class=\"p\">(</span><span class=\"n\">struct_type</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-17-7\" name=\"__codelineno-17-7\"></a><span class=\"w\">                    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"n\">struct_type</span><span class=\"p\">.</span><span class=\"n\">fields</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-17-8\" name=\"__codelineno-17-8\"></a><span class=\"w\">                        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">ReflectError</span><span class=\"p\">::</span><span class=\"n\">OperationFailed</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-17-9\" name=\"__codelineno-17-9\"></a><span class=\"w\">                            </span><span class=\"n\">shape</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">frame</span><span class=\"p\">.</span><span class=\"n\">shape</span><span class=\"p\">,</span>\n<a id=\"__codelineno-17-10\" name=\"__codelineno-17-10\"></a><span class=\"w\">                            </span><span class=\"n\">operation</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;field index out of bounds&quot;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-17-11\" name=\"__codelineno-17-11\"></a><span class=\"w\">                        </span><span class=\"p\">});</span>\n<a id=\"__codelineno-17-12\" name=\"__codelineno-17-12\"></a><span class=\"w\">                    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-17-13\" name=\"__codelineno-17-13\"></a><span class=\"w\">                    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">struct_type</span><span class=\"p\">.</span><span class=\"n\">fields</span><span class=\"p\">[</span><span class=\"n\">idx</span><span class=\"p\">];</span>\n<a id=\"__codelineno-17-14\" name=\"__codelineno-17-14\"></a>\n<a id=\"__codelineno-17-15\" name=\"__codelineno-17-15\"></a><span class=\"w\">                    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">frame</span><span class=\"p\">.</span><span class=\"n\">tracker</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-17-16\" name=\"__codelineno-17-16\"></a><span class=\"w\">                        </span><span class=\"n\">Tracker</span><span class=\"p\">::</span><span class=\"n\">Uninit</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-17-17\" name=\"__codelineno-17-17\"></a><span class=\"w\">                            </span><span class=\"n\">frame</span><span class=\"p\">.</span><span class=\"n\">tracker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Tracker</span><span class=\"p\">::</span><span class=\"n\">Struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-17-18\" name=\"__codelineno-17-18\"></a><span class=\"w\">                                </span><span class=\"n\">iset</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ISet</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">struct_type</span><span class=\"p\">.</span><span class=\"n\">fields</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">()),</span>\n<a id=\"__codelineno-17-19\" name=\"__codelineno-17-19\"></a><span class=\"w\">                                </span><span class=\"n\">current_child</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">idx</span><span class=\"p\">),</span>\n<a id=\"__codelineno-17-20\" name=\"__codelineno-17-20\"></a><span class=\"w\">                            </span><span class=\"p\">}</span>\n<a id=\"__codelineno-17-21\" name=\"__codelineno-17-21\"></a><span class=\"w\">                        </span><span class=\"p\">},</span>\n<a id=\"__codelineno-17-22\" name=\"__codelineno-17-22\"></a><span class=\"w\">                        </span><span class=\"n\">Tracker</span><span class=\"p\">::</span><span class=\"n\">Struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-17-23\" name=\"__codelineno-17-23\"></a><span class=\"w\">                            </span><span class=\"n\">iset</span><span class=\"p\">,</span>\n<a id=\"__codelineno-17-24\" name=\"__codelineno-17-24\"></a><span class=\"w\">                            </span><span class=\"n\">current_child</span><span class=\"p\">,</span>\n<a id=\"__codelineno-17-25\" name=\"__codelineno-17-25\"></a><span class=\"w\">                        </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-17-26\" name=\"__codelineno-17-26\"></a><span class=\"w\">                            </span><span class=\"c1\">// Check if this field was already initialized</span>\n<a id=\"__codelineno-17-27\" name=\"__codelineno-17-27\"></a><span class=\"w\">                            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">iset</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">idx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-17-28\" name=\"__codelineno-17-28\"></a><span class=\"w\">                                </span><span class=\"c1\">// Drop the existing value before re-initializing</span>\n<a id=\"__codelineno-17-29\" name=\"__codelineno-17-29\"></a><span class=\"w\">                                </span><span class=\"c1\">// \u83b7\u53d6name\u5b57\u6bb5\u7684\u6307\u9488\uff0cdrop\u5df2\u7ecf\u521d\u59cb\u5316\u7684\u6570\u636e\uff0c\u8fdb\u884c\u91cd\u65b0\u521d\u59cb\u5316</span>\n<a id=\"__codelineno-17-30\" name=\"__codelineno-17-30\"></a><span class=\"w\">                                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">field_ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">frame</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">field_init_at</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">.</span><span class=\"n\">offset</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">};</span>\n<a id=\"__codelineno-17-31\" name=\"__codelineno-17-31\"></a><span class=\"w\">                                </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">drop_fn</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-17-32\" name=\"__codelineno-17-32\"></a><span class=\"w\">                                    </span><span class=\"n\">field</span><span class=\"p\">.</span><span class=\"n\">shape</span><span class=\"p\">.</span><span class=\"n\">vtable</span><span class=\"p\">.</span><span class=\"n\">sized</span><span class=\"p\">().</span><span class=\"n\">and_then</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">v</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">.</span><span class=\"n\">drop_in_place</span><span class=\"p\">)())</span>\n<a id=\"__codelineno-17-33\" name=\"__codelineno-17-33\"></a><span class=\"w\">                                </span><span class=\"p\">{</span>\n<a id=\"__codelineno-17-34\" name=\"__codelineno-17-34\"></a><span class=\"w\">                                    </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">drop_fn</span><span class=\"p\">(</span><span class=\"n\">field_ptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">};</span>\n<a id=\"__codelineno-17-35\" name=\"__codelineno-17-35\"></a><span class=\"w\">                                </span><span class=\"p\">}</span>\n<a id=\"__codelineno-17-36\" name=\"__codelineno-17-36\"></a><span class=\"w\">                                </span><span class=\"c1\">// Unset the bit so we can re-initialize</span>\n<a id=\"__codelineno-17-37\" name=\"__codelineno-17-37\"></a><span class=\"w\">                                </span><span class=\"n\">iset</span><span class=\"p\">.</span><span class=\"n\">unset</span><span class=\"p\">(</span><span class=\"n\">idx</span><span class=\"p\">);</span>\n<a id=\"__codelineno-17-38\" name=\"__codelineno-17-38\"></a><span class=\"w\">                            </span><span class=\"p\">}</span>\n<a id=\"__codelineno-17-39\" name=\"__codelineno-17-39\"></a><span class=\"w\">                            </span><span class=\"o\">*</span><span class=\"n\">current_child</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">idx</span><span class=\"p\">);</span>\n<a id=\"__codelineno-17-40\" name=\"__codelineno-17-40\"></a><span class=\"w\">                        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-17-41\" name=\"__codelineno-17-41\"></a><span class=\"w\">                        </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"fm\">unreachable!</span><span class=\"p\">(),</span>\n<a id=\"__codelineno-17-42\" name=\"__codelineno-17-42\"></a><span class=\"w\">                    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-17-43\" name=\"__codelineno-17-43\"></a>\n<a id=\"__codelineno-17-44\" name=\"__codelineno-17-44\"></a><span class=\"w\">                    </span><span class=\"c1\">// Push a new frame for this field onto the frames stack.</span>\n<a id=\"__codelineno-17-45\" name=\"__codelineno-17-45\"></a><span class=\"w\">                    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">field_ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">frame</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">field_uninit_at</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">.</span><span class=\"n\">offset</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">};</span>\n<a id=\"__codelineno-17-46\" name=\"__codelineno-17-46\"></a><span class=\"w\">                    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">field_shape</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"p\">.</span><span class=\"n\">shape</span><span class=\"p\">;</span>\n<a id=\"__codelineno-17-47\" name=\"__codelineno-17-47\"></a><span class=\"w\">                    </span><span class=\"c1\">// \u4fee\u6539\u6700\u540e\u4e00\u5e27\uff0c\u4e5f\u5c31\u662flast_frame\u4e3a\u5f53\u524d\u64cd\u4f5c\u7684Struct\u7684name field</span>\n<a id=\"__codelineno-17-48\" name=\"__codelineno-17-48\"></a><span class=\"w\">                    </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">frames</span>\n<a id=\"__codelineno-17-49\" name=\"__codelineno-17-49\"></a><span class=\"w\">                        </span><span class=\"p\">.</span><span class=\"n\">push</span><span class=\"p\">(</span><span class=\"n\">Frame</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">field_ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">field_shape</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">FrameOwnership</span><span class=\"p\">::</span><span class=\"n\">Field</span><span class=\"p\">));</span>\n<a id=\"__codelineno-17-50\" name=\"__codelineno-17-50\"></a>\n<a id=\"__codelineno-17-51\" name=\"__codelineno-17-51\"></a><span class=\"w\">                    </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n<a id=\"__codelineno-17-52\" name=\"__codelineno-17-52\"></a><span class=\"w\">                </span><span class=\"p\">}</span>\n<a id=\"__codelineno-17-53\" name=\"__codelineno-17-53\"></a><span class=\"w\">            </span><span class=\"p\">},</span>\n<a id=\"__codelineno-17-54\" name=\"__codelineno-17-54\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-17-55\" name=\"__codelineno-17-55\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p>set\u8bbe\u7f6e\u503c\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-18-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-18-19\">19</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-18-1\" name=\"__codelineno-18-1\"></a><span class=\"sd\">/// Sets a value wholesale into the current frame</span>\n<a id=\"__codelineno-18-2\" name=\"__codelineno-18-2\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">set</span><span class=\"o\">&lt;</span><span class=\"n\">U</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">U</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">Self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ReflectError</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-18-3\" name=\"__codelineno-18-3\"></a><span class=\"k\">where</span>\n<a id=\"__codelineno-18-4\" name=\"__codelineno-18-4\"></a><span class=\"w\">    </span><span class=\"n\">U</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Facet</span><span class=\"o\">&lt;&#39;</span><span class=\"na\">facet</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-18-5\" name=\"__codelineno-18-5\"></a><span class=\"p\">{</span>\n<a id=\"__codelineno-18-6\" name=\"__codelineno-18-6\"></a><span class=\"w\">    </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">require_active</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<a id=\"__codelineno-18-7\" name=\"__codelineno-18-7\"></a>\n<a id=\"__codelineno-18-8\" name=\"__codelineno-18-8\"></a><span class=\"w\">    </span><span class=\"c1\">// For conversion frames, store the value in the conversion frame itself</span>\n<a id=\"__codelineno-18-9\" name=\"__codelineno-18-9\"></a><span class=\"w\">    </span><span class=\"c1\">// The conversion will happen during end()</span>\n<a id=\"__codelineno-18-10\" name=\"__codelineno-18-10\"></a><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">ptr_const</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">PtrConst</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">raw</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">);</span>\n<a id=\"__codelineno-18-11\" name=\"__codelineno-18-11\"></a><span class=\"w\">    </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-18-12\" name=\"__codelineno-18-12\"></a><span class=\"w\">        </span><span class=\"c1\">// Safety: We are calling set_shape with a valid shape and a valid pointer</span>\n<a id=\"__codelineno-18-13\" name=\"__codelineno-18-13\"></a><span class=\"w\">        </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">set_shape</span><span class=\"p\">(</span><span class=\"n\">ptr_const</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"p\">::</span><span class=\"n\">SHAPE</span><span class=\"p\">)</span><span class=\"o\">?</span>\n<a id=\"__codelineno-18-14\" name=\"__codelineno-18-14\"></a><span class=\"w\">    </span><span class=\"p\">};</span>\n<a id=\"__codelineno-18-15\" name=\"__codelineno-18-15\"></a>\n<a id=\"__codelineno-18-16\" name=\"__codelineno-18-16\"></a><span class=\"w\">    </span><span class=\"c1\">// Prevent the value from being dropped since we&#39;ve copied it</span>\n<a id=\"__codelineno-18-17\" name=\"__codelineno-18-17\"></a><span class=\"w\">    </span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">mem</span><span class=\"p\">::</span><span class=\"n\">forget</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">);</span>\n<a id=\"__codelineno-18-18\" name=\"__codelineno-18-18\"></a><span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n<a id=\"__codelineno-18-19\" name=\"__codelineno-18-19\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\nset\u51fd\u6570\u8c03\u7528\u4e86set_shape\u51fd\u6570\uff0c\u56e0\u4e3abegin_field\u51fd\u6570\u63a5\u7740\u8c03\u7528\u7684\u5c31\u662fset\u51fd\u6570\uff0c\u56e0\u6b64set_shape\u51fd\u6570\u4e2d\u83b7\u53d6\u7684last_mut frame\u5c31\u662fname\u5b57\u6bb5\u7684\u4fe1\u606f\u3002\u7136\u540e\u5c31\u4e3adata\u6307\u9488\u6307\u5411\u7684\u6570\u636e\u8d4b\u503c\u4e86\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Rust</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-19-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-19-15\">15</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-19-1\" name=\"__codelineno-19-1\"></a><span class=\"sd\">/// Sets a value into the current frame by shape, for shape-based operations</span>\n<a id=\"__codelineno-19-2\" name=\"__codelineno-19-2\"></a><span class=\"cp\">#[inline]</span>\n<a id=\"__codelineno-19-3\" name=\"__codelineno-19-3\"></a><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">set_shape</span><span class=\"p\">(</span>\n<a id=\"__codelineno-19-4\" name=\"__codelineno-19-4\"></a><span class=\"w\">    </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span>\n<a id=\"__codelineno-19-5\" name=\"__codelineno-19-5\"></a><span class=\"w\">    </span><span class=\"n\">src_value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">PtrConst</span><span class=\"o\">&lt;&#39;</span><span class=\"nb\">_</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-19-6\" name=\"__codelineno-19-6\"></a><span class=\"w\">    </span><span class=\"n\">src_shape</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"o\">&#39;</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"nc\">Shape</span><span class=\"p\">,</span>\n<a id=\"__codelineno-19-7\" name=\"__codelineno-19-7\"></a><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">Self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ReflectError</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-19-8\" name=\"__codelineno-19-8\"></a><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">fr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">frames</span><span class=\"p\">.</span><span class=\"n\">last_mut</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<a id=\"__codelineno-19-9\" name=\"__codelineno-19-9\"></a>\n<a id=\"__codelineno-19-10\" name=\"__codelineno-19-10\"></a><span class=\"w\">    </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-19-11\" name=\"__codelineno-19-11\"></a><span class=\"w\">        </span><span class=\"n\">fr</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">copy_from</span><span class=\"p\">(</span><span class=\"n\">src_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fr</span><span class=\"p\">.</span><span class=\"n\">shape</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<a id=\"__codelineno-19-12\" name=\"__codelineno-19-12\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-19-13\" name=\"__codelineno-19-13\"></a><span class=\"w\">    </span><span class=\"n\">fr</span><span class=\"p\">.</span><span class=\"n\">tracker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Tracker</span><span class=\"p\">::</span><span class=\"n\">Init</span><span class=\"p\">;</span>\n<a id=\"__codelineno-19-14\" name=\"__codelineno-19-14\"></a><span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n<a id=\"__codelineno-19-15\" name=\"__codelineno-19-15\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n\u5230\u6b64\uff0c\u6210\u529f\u5b9e\u73b0\u4e86Struct\u7684Partial\u529f\u80fd\uff0c\u4ece\u5206\u914d\u672a\u521d\u59cb\u5316\u7684\u5185\u5b58\uff0c\u7136\u540e\u901a\u8fc7string\u7c7b\u578b\u7684field\u540d\u79f0\uff0c\u6784\u9020\u4e00\u4e2a\u4e2afield\uff0c\u6700\u7ec8\u6784\u9020\u51fa\u4e00\u4e2a\u7ed3\u6784\u4f53\u3002</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/pyo3\u5b9e\u73b0python\u548crust\u8de8\u8bed\u8a00\u8c03\u7528/\" target=\"_blank\">pyo3\u5b9e\u73b0python\u548crust\u8de8\u8bed\u8a00\u8c03\u7528</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/\u4f7f\u7528aya\u548cc\u6df7\u5408\u7f16\u5199uprobe\u7a0b\u5e8f/\" target=\"_blank\">\u4f7f\u7528aya\u548cc\u6df7\u5408\u7f16\u5199uprobe\u7a0b\u5e8f</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u5f00\u53d1\u5e38\u89c1\u95ee\u9898\u4e4babi\u517c\u5bb9\u6027\u95ee\u9898/\" target=\"_blank\">C++\u5f00\u53d1\u5e38\u89c1\u95ee\u9898\u4e4bABI\u517c\u5bb9\u6027\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c20\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8e\u5c5e\u6027\u6d4b\u8bd5\u7684quickcheck-cpp\u5e93/\" target=\"_blank\">C++20\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8e\u5c5e\u6027\u6d4b\u8bd5\u7684quickcheck-cpp\u5e93</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-08-02T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/%E5%85%B3%E4%BA%8E%E9%98%85%E8%AF%BB%E6%BA%90%E7%A0%81%E7%9A%84%E4%B8%80%E7%82%B9%E5%BF%83%E5%BE%97/",
            "url": "https://github.com/KenForever1/blog/%E5%85%B3%E4%BA%8E%E9%98%85%E8%AF%BB%E6%BA%90%E7%A0%81%E7%9A%84%E4%B8%80%E7%82%B9%E5%BF%83%E5%BE%97/",
            "title": "\u5173\u4e8e\u9605\u8bfb\u6e90\u7801\u7684\u4e00\u70b9\u5fc3\u5f97",
            "content_html": "<p>\u670b\u53cb\u4eec\uff0c\u9605\u8bfb\u4f18\u79c0\u7684\u6e90\u7801\u53ef\u4ee5\u5b66\u5230\u5f88\u591a\uff0c\u4f8b\u5982\u4ee3\u7801\u7684\u7ed3\u6784\u7ec4\u7ec7\u3001\u8bbe\u8ba1\u6a21\u5f0f\u3001\u4e3a\u4e86\u89e3\u51b3\u4e00\u4e9b\u95ee\u9898\u7279\u6b8a\u5904\u7406\u3001\u5199\u6cd5\u6280\u5de7\u3001\u4f18\u5316\u7b56\u7565\u7b49\uff0c\u540c\u65f6\u4e5f\u6269\u5c55\u4e86\u5bf9\u7f16\u7a0b\u8bed\u8a00\u7684\u719f\u6089\u7a0b\u5ea6\u3001\u5173\u4e8e\u8fd9\u4e2a\u9879\u76ee\u7684\u89e3\u51b3\u95ee\u9898\u601d\u8def\u3002</p>\n<!-- more -->\n\n<p>\u672c\u6587\u4e3b\u8981\u8bb0\u5f55\u548c\u5206\u4eab\u4e00\u4e9b\u6211\u9605\u8bfb\u4ee3\u7801\u8fc7\u7a0b\u4e2d\u7684\u5fc3\u5f97\uff0c\u5305\u62ec\u5982\u4f55\u9605\u8bfb\u4ee3\u7801\u3001\u5229\u7528\u9605\u8bfb\u4ee3\u7801\u5de5\u5177\u3001\u5982\u4f55\u9009\u62e9\u4e00\u4e9b\u4ee3\u7801\u5e93\u9605\u8bfb\u3002</p>\n<h2 id=\"\u5982\u4f55\u9605\u8bfb\u4ee3\u7801\">\u5982\u4f55\u9605\u8bfb\u4ee3\u7801<a class=\"headerlink\" href=\"#\u5982\u4f55\u9605\u8bfb\u4ee3\u7801\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9605\u8bfb\u4ee3\u7801\u7684\u8fc7\u7a0b\uff0c\u5c31\u50cf\u662f\u63a2\u6848\u5bfb\u627e\u5acc\u7591\u4eba\u3001\u7834\u89e3\u654c\u4eba\u7684\u9635\u6cd5\u3001\u53c8\u6216\u8005\u6b23\u8d4f\u4e00\u4ef6\u827a\u672f\u54c1\u3002\u5982\u679c\u6ca1\u6709\u601d\u8def\u3001\u4e00\u5934\u624e\u8fdb\u53bb\uff0c\u6216\u8005\u53d8\u6210\u4e86\u6309\u987a\u5e8f\u8bfb\u4ee3\u7801\uff0c\u5c31\u4f1a\u773c\u775b\u75db\u3001\u5934\u53d1\u6655\u4e86\uff0c\u5f88\u96be\u8fdb\u884c\u4e0b\u53bb\u3002</p>\n<ul>\n<li>\n<p>\u5e26\u7740\u95ee\u9898\u6216\u8005\u76ee\u6807\u53bb\u9605\u8bfb\u4ee3\u7801\uff0c\u5927\u578b\u4ee3\u7801\u5e93\u90fd\u662f\u7531\u5f88\u591a\u4eba\u5f00\u53d1\u7684\u3001\u7531\u5f88\u591a\u529f\u80fd\u7ec4\u6210\uff0c\u7279\u522b\u5e9e\u5927\uff0c\u9700\u8981\u7531\u95ee\u9898\u5207\u5165\u3002\u6bd4\u5982\u8fd9\u4e2a\u4ee3\u7801\u5e93\u4e2d\u5982\u4f55\u5b9e\u73b0\u67d0\u4e2a\u529f\u80fd\u7684\uff1f\u6bd4\u5982Pytorch\u4e2d\u5982\u4f55\u4f7f\u7528cudaIpc\u529f\u80fd\u7684\uff1f\u6bd4\u5982LLM\u63a8\u7406\u5e93\u4e2d\u5982\u4f55\u5b9e\u73b0\u6295\u673a\u91c7\u6837\u7684\uff1f</p>\n</li>\n<li>\n<p>\u4e0d\u63a8\u8350\u987a\u5e8f\u8bfb\u4ee3\u7801\uff0c\u6bd4\u5982\u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\uff0c\u4ece\u5934\u5f00\u59cb\u5f80\u540e\u8bfb\uff0c\u4e00\u4e2a\u4e00\u4e2a\u6587\u4ef6\u8bfb\u3002</p>\n</li>\n</ul>\n<p>\u62ffC++\u7684\u4e00\u4e2a\u6587\u4ef6\u6765\u8bf4\uff0c\u53ef\u80fd\u7531\u4e00\u4e2a\u7c7b\u6216\u8005\u591a\u4e2a\u7c7b\uff0c\u91cc\u9762\u5305\u62ec\u4e86\u6838\u5fc3\u51fd\u6570\u3001\u5de5\u5177\u8f85\u52a9\u51fd\u6570\u3001\u7528\u7684\u5c11\u7684\u51fd\u6570\u53d8\u91cf\u7b49\u3002\u6709\u4e9b\u51fd\u6570\u53d8\u91cf\u5bf9\u89e3\u51b3\u7684\u4f60\u95ee\u9898\u6ca1\u6709\u4efb\u4f55\u610f\u4e49\uff0c\u6309\u987a\u5e8f\u9605\u8bfb\u5c31\u4f1a\u589e\u52a0\u6df7\u4e71\u5ea6\u3002\u63a8\u8350\u6839\u636e\u7c7b\u548c\u65b9\u6cd5\u7684\u8c03\u7528\u5173\u7cfb\uff0c\u4e0d\u65ad\u7684\u8df3\u8f6c\uff0c\u67e5\u770b\u4ee3\u7801\u5982\u4f55\u5b9e\u73b0\u548c\u89e3\u51b3\u95ee\u9898\u7684\u3002</p>\n<ul>\n<li>\u5bf9\u4e8e\u4e00\u4e2a\u4e0d\u4e86\u89e3\u7684\u9879\u76ee\u6216\u8005\u5e93\uff0c\u63a8\u8350\u53ef\u4ee5\u4ece\u6d4b\u8bd5\u770b\u8d77\u3001\u5148\u4ece\u7528\u8d77\u6765\u7684\u89d2\u5ea6\uff0c\u53bb\u7406\u89e3\u8fd9\u4e2a\u9879\u76ee\u662f\u5e72\u561b\u7684\uff0c\u5b83\u80fd\u591f\u89e3\u51b3\u54ea\u4e9b\u95ee\u9898\u3002\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u4f60\u5c31\u4f1a\u53bb\u67e5\u9605\u5b83\u7684\u6587\u6863\uff08readme\u3001blog\uff09\u4ee5\u53ca\u719f\u6089API\u7528\u6cd5\u3002\u540c\u65f6\u4e5f\u4f1a\u5e26\u7ed9\u4f60\u5f88\u591a\u95ee\u9898\uff0c\u8ba9\u4f60\u4f5c\u4e3a\u5207\u5165\u70b9\u9605\u8bfb\u6e90\u7801\u3002</li>\n</ul>\n<h2 id=\"\u9605\u8bfb\u4ee3\u7801\u5de5\u5177\u7684\u5229\u7528\">\u9605\u8bfb\u4ee3\u7801\u5de5\u5177\u7684\u5229\u7528<a class=\"headerlink\" href=\"#\u9605\u8bfb\u4ee3\u7801\u5de5\u5177\u7684\u5229\u7528\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li>\n<p>github1s</p>\n</li>\n<li>\n<p>sourcegraph</p>\n</li>\n<li>\n<p>command\u7b49\u8f6f\u4ef6</p>\n</li>\n</ul>\n<h2 id=\"\u5982\u4f55\u9009\u62e9\u9605\u8bfb\u7684\u4ee3\u7801\u5e93\">\u5982\u4f55\u9009\u62e9\u9605\u8bfb\u7684\u4ee3\u7801\u5e93<a class=\"headerlink\" href=\"#\u5982\u4f55\u9009\u62e9\u9605\u8bfb\u7684\u4ee3\u7801\u5e93\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5174\u8da3\u3001\u6280\u80fd\u63d0\u5347\u3001\u7ed3\u5408\u5de5\u4f5c\u4e2d\u7684\u9700\u6c42\uff08\u6216\u8005\u672a\u6765\u5de5\u4f5c\u7684\u53d1\u5c55\u60c5\u51b5\uff09</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/\u4f7f\u7528pytorch\u4ece\u96f6\u6784\u5efallama3\u5927\u6a21\u578b--\u6df1\u5165\u4e86\u89e3\u8f93\u51fa\u6a21\u5757\u4ee5\u53ca\u8bad\u7ec3\u63a8\u7406/\" target=\"_blank\">\u4f7f\u7528Pytorch\u4ece\u96f6\u6784\u5efaLlama3\u5927\u6a21\u578b--\u6df1\u5165\u4e86\u89e3\u8f93\u51fa\u6a21\u5757\u4ee5\u53ca\u8bad\u7ec3\u63a8\u7406</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/cista\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93\u5b9e\u73b0\u4e4bswiss_table\u54c8\u5e0c\u8868\u5b9e\u73b0/\" target=\"_blank\">cista\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93\u5b9e\u73b0\u4e4bswiss_table\u54c8\u5e0c\u8868\u5b9e\u73b0</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-08-01T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/vllm%E6%8E%A8%E7%90%86%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84sleep_mode%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0/",
            "url": "https://github.com/KenForever1/blog/vllm%E6%8E%A8%E7%90%86%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84sleep_mode%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0/",
            "title": "VLLM\u63a8\u7406\u6846\u67b6\u4e2d\u7684sleep_mode\u5982\u4f55\u5b9e\u73b0",
            "content_html": "<!-- [TOC] -->\n\n<h2 id=\"vllm-sleep_model-\u7b80\u4ecb\">vllm sleep_model \u7b80\u4ecb<a class=\"headerlink\" href=\"#vllm-sleep_model-\u7b80\u4ecb\" title=\"Permanent link\">&para;</a></h2>\n<p>\u524d\u6587<a href=\"https://zhuanlan.zhihu.com/p/1919901725592093271\" title=\"torch_memory_saver \u9ad8\u6027\u80fd CUDA \u5185\u5b58\u7ba1\u7406\u5de5\u5177\u5b9e\u73b0\">torch_memory_saver \u9ad8\u6027\u80fd CUDA \u5185\u5b58\u7ba1\u7406\u5de5\u5177\u5b9e\u73b0</a>\uff0c\u4ecb\u7ecd\u4e86 sglang \u4e2d\u5229\u7528\u4e86\u8be5\u5e93\u5c06\u4fdd\u5b58 kv_cache \u548c\u6743\u91cd\u7684\u663e\u5b58\u91ca\u653e\u51fa\u6765\u3002</p>\n<p>\u5728 VLLM \u4e2d\u4e5f\u6709\u540c\u6837\u7684\u529f\u80fd\u5b9e\u73b0\uff0c\u5728 VLLM \u4e2d\u7684\u76f4\u63a5\u5e94\u7528\u662f\u201csleep mode\u201d\u3002\u5c06\u6a21\u578b\u6743\u91cd\u4ece\u663e\u5b58\uff08\u6216\u8005 NPU \u5185\u5b58\u4e2d\uff09\u5378\u8f7d\uff0c\u5e76\u4e22\u5f03\u5176\u4e2d\u7684 KV \u7f13\u5b58\u3002</p>\n<!-- more -->\n\n<p>\u4e24\u79cd level \u4e0d\u540c\u7b56\u7565\uff1a</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-17\">17</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a>Level<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>Sleep\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a>Action:<span class=\"w\"> </span>Offloads<span class=\"w\"> </span>model<span class=\"w\"> </span>weights<span class=\"w\"> </span>and<span class=\"w\"> </span>discards<span class=\"w\"> </span>the<span class=\"w\"> </span>KV<span class=\"w\"> </span>cache.\n<a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\"></a>\n<a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\"></a>Memory:<span class=\"w\"> </span>Model<span class=\"w\"> </span>weights<span class=\"w\"> </span>are<span class=\"w\"> </span>moved<span class=\"w\"> </span>to<span class=\"w\"> </span>CPU<span class=\"w\"> </span>memory<span class=\"p\">;</span><span class=\"w\"> </span>KV<span class=\"w\"> </span>cache<span class=\"w\"> </span>is<span class=\"w\"> </span>forgotten.\n<a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\"></a>\n<a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\"></a>Use<span class=\"w\"> </span>Case:<span class=\"w\"> </span>Suitable<span class=\"w\"> </span>when<span class=\"w\"> </span>reusing<span class=\"w\"> </span>the<span class=\"w\"> </span>same<span class=\"w\"> </span>model<span class=\"w\"> </span>later.\n<a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\"></a>\n<a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\"></a>Note:<span class=\"w\"> </span>Ensure<span class=\"w\"> </span>sufficient<span class=\"w\"> </span>CPU<span class=\"w\"> </span>memory<span class=\"w\"> </span>is<span class=\"w\"> </span>available<span class=\"w\"> </span>to<span class=\"w\"> </span>hold<span class=\"w\"> </span>the<span class=\"w\"> </span>model<span class=\"w\"> </span>weights.\n<a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\"></a>\n<a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\"></a>Level<span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\"> </span>Sleep\n<a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\"></a>\n<a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\"></a>Action:<span class=\"w\"> </span>Discards<span class=\"w\"> </span>both<span class=\"w\"> </span>model<span class=\"w\"> </span>weights<span class=\"w\"> </span>and<span class=\"w\"> </span>KV<span class=\"w\"> </span>cache.\n<a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\"></a>\n<a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\"></a>Memory:<span class=\"w\"> </span>The<span class=\"w\"> </span>content<span class=\"w\"> </span>of<span class=\"w\"> </span>both<span class=\"w\"> </span>the<span class=\"w\"> </span>model<span class=\"w\"> </span>weights<span class=\"w\"> </span>and<span class=\"w\"> </span>kv<span class=\"w\"> </span>cache<span class=\"w\"> </span>is<span class=\"w\"> </span>forgotten.\n<a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\"></a>\n<a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\"></a>Use<span class=\"w\"> </span>Case:<span class=\"w\"> </span>Ideal<span class=\"w\"> </span>when<span class=\"w\"> </span>switching<span class=\"w\"> </span>to<span class=\"w\"> </span>a<span class=\"w\"> </span>different<span class=\"w\"> </span>model<span class=\"w\"> </span>or<span class=\"w\"> </span>updating<span class=\"w\"> </span>the<span class=\"w\"> </span>current<span class=\"w\"> </span>one.\n</code></pre></div></td></tr></table></div>\n<h2 id=\"\u5982\u4f55\u4f7f\u7528-sleep-\u548c-wake_up\">\u5982\u4f55\u4f7f\u7528 sleep \u548c wake_up?<a class=\"headerlink\" href=\"#\u5982\u4f55\u4f7f\u7528-sleep-\u548c-wake_up\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728 VLLM \u4e2d\u901a\u8fc7 CuMemAllocator.get_instance()\u4f7f\u7528 sleep \u548c wake_up \u65b9\u6cd5\uff0c\u5b9e\u73b0\u91ca\u653e\u663e\u5b58\u548c\u6062\u590d\u663e\u5b58\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Python</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-32\">32</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">load_model</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a>    <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">vllm_config</span><span class=\"o\">.</span><span class=\"n\">model_config</span><span class=\"o\">.</span><span class=\"n\">enable_sleep_mode</span><span class=\"p\">:</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a>        <span class=\"n\">allocator</span> <span class=\"o\">=</span> <span class=\"n\">CuMemAllocator</span><span class=\"o\">.</span><span class=\"n\">get_instance</span><span class=\"p\">()</span>\n<a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\"></a>        <span class=\"k\">assert</span> <span class=\"n\">allocator</span><span class=\"o\">.</span><span class=\"n\">get_current_usage</span><span class=\"p\">()</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">(</span>\n<a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\"></a>            <span class=\"s2\">&quot;Sleep mode can only be &quot;</span>\n<a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\"></a>            <span class=\"s2\">&quot;used for one instance per process.&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\"></a>        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"n\">allocator</span><span class=\"o\">.</span><span class=\"n\">use_memory_pool</span><span class=\"p\">(</span><span class=\"n\">tag</span><span class=\"o\">=</span><span class=\"s2\">&quot;weights&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\"></a>    <span class=\"k\">else</span><span class=\"p\">:</span>\n<a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\"></a>        <span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">contextlib</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">nullcontext</span>\n<a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\"></a>        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"n\">nullcontext</span><span class=\"p\">()</span>\n<a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\"></a>    <span class=\"k\">with</span> <span class=\"n\">context</span><span class=\"p\">:</span>\n<a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\"></a>        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model_runner</span><span class=\"o\">.</span><span class=\"n\">load_model</span><span class=\"p\">()</span>\n<a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\"></a>\n<a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\"></a><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">Worker</span><span class=\"p\">():</span>\n<a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\"></a>\n<a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\"></a>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">sleep</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">level</span><span class=\"p\">:</span> <span class=\"nb\">int</span> <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\"></a>        <span class=\"n\">free_bytes_before_sleep</span> <span class=\"o\">=</span> <span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">cuda</span><span class=\"o\">.</span><span class=\"n\">mem_get_info</span><span class=\"p\">()[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n<a id=\"__codelineno-1-18\" name=\"__codelineno-1-18\"></a>\n<a id=\"__codelineno-1-19\" name=\"__codelineno-1-19\"></a>        <span class=\"n\">allocator</span> <span class=\"o\">=</span> <span class=\"n\">CuMemAllocator</span><span class=\"o\">.</span><span class=\"n\">get_instance</span><span class=\"p\">()</span>\n<a id=\"__codelineno-1-20\" name=\"__codelineno-1-20\"></a>        <span class=\"n\">allocator</span><span class=\"o\">.</span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"n\">offload_tags</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"s2\">&quot;weights&quot;</span><span class=\"p\">,</span> <span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">level</span> <span class=\"o\">==</span> <span class=\"mi\">1</span> <span class=\"k\">else</span> <span class=\"nb\">tuple</span><span class=\"p\">())</span>\n<a id=\"__codelineno-1-21\" name=\"__codelineno-1-21\"></a>        <span class=\"n\">free_bytes_after_sleep</span><span class=\"p\">,</span> <span class=\"n\">total</span> <span class=\"o\">=</span> <span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">cuda</span><span class=\"o\">.</span><span class=\"n\">mem_get_info</span><span class=\"p\">()</span>\n<a id=\"__codelineno-1-22\" name=\"__codelineno-1-22\"></a>        <span class=\"n\">freed_bytes</span> <span class=\"o\">=</span> <span class=\"n\">free_bytes_after_sleep</span> <span class=\"o\">-</span> <span class=\"n\">free_bytes_before_sleep</span>\n<a id=\"__codelineno-1-23\" name=\"__codelineno-1-23\"></a>        <span class=\"n\">used_bytes</span> <span class=\"o\">=</span> <span class=\"n\">total</span> <span class=\"o\">-</span> <span class=\"n\">free_bytes_after_sleep</span>\n<a id=\"__codelineno-1-24\" name=\"__codelineno-1-24\"></a>        <span class=\"k\">assert</span> <span class=\"n\">freed_bytes</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Memory usage increased after sleeping.&quot;</span>\n<a id=\"__codelineno-1-25\" name=\"__codelineno-1-25\"></a>        <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span>\n<a id=\"__codelineno-1-26\" name=\"__codelineno-1-26\"></a>            <span class=\"s2\">&quot;Sleep mode freed </span><span class=\"si\">%.2f</span><span class=\"s2\"> GiB memory, &quot;</span>\n<a id=\"__codelineno-1-27\" name=\"__codelineno-1-27\"></a>            <span class=\"s2\">&quot;</span><span class=\"si\">%.2f</span><span class=\"s2\"> GiB memory is still in use.&quot;</span><span class=\"p\">,</span> <span class=\"n\">freed_bytes</span> <span class=\"o\">/</span> <span class=\"n\">GiB_bytes</span><span class=\"p\">,</span>\n<a id=\"__codelineno-1-28\" name=\"__codelineno-1-28\"></a>            <span class=\"n\">used_bytes</span> <span class=\"o\">/</span> <span class=\"n\">GiB_bytes</span><span class=\"p\">)</span>\n<a id=\"__codelineno-1-29\" name=\"__codelineno-1-29\"></a>\n<a id=\"__codelineno-1-30\" name=\"__codelineno-1-30\"></a>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">wake_up</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">tags</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<a id=\"__codelineno-1-31\" name=\"__codelineno-1-31\"></a>        <span class=\"n\">allocator</span> <span class=\"o\">=</span> <span class=\"n\">CuMemAllocator</span><span class=\"o\">.</span><span class=\"n\">get_instance</span><span class=\"p\">()</span>\n<a id=\"__codelineno-1-32\" name=\"__codelineno-1-32\"></a>        <span class=\"n\">allocator</span><span class=\"o\">.</span><span class=\"n\">wake_up</span><span class=\"p\">(</span><span class=\"n\">tags</span><span class=\"p\">)</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5f53\u8c03\u7528 sleep \u65b9\u6cd5\u65f6\uff0c\u6240\u6709\u5177\u6709\u6307\u5b9a\u6807\u7b7e\u7684\u5f20\u91cf\u90fd\u5c06\u88ab\u5378\u8f7d(offload)\u5230 CPU \u5185\u5b58\u4e2d\uff0c\u5176\u4f59\u5f20\u91cf\u5c06\u88ab\u4e22\u5f03(discard)\u3002\n\u5f53\u6211\u4eec\u8c03\u7528 wake_up \u65f6\uff0c\u4e4b\u524d\u5378\u8f7d\u7684\u6240\u6709\u5f20\u91cf\u90fd\u5c06\u88ab\u52a0\u8f7d\u56de GPU \u5185\u5b58\uff0c\u5176\u4f59\u5f20\u91cf\u4e3a\u7a7a\u3002</p>\n<h2 id=\"sleep-\u548c-wake_up-\u5b9e\u73b0\">sleep \u548c wake_up \u5b9e\u73b0<a class=\"headerlink\" href=\"#sleep-\u548c-wake_up-\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h2>\n<p>cuda \u5b9e\u73b0\u9488\u5bf9 NVIDIA GPU, npu \u5b9e\u73b0\u9488\u5bf9\u534e\u4e3a Ascend NPU\u3002</p>\n<h3 id=\"cuda-\u5b9e\u73b0\">cuda \u5b9e\u73b0<a class=\"headerlink\" href=\"#cuda-\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h3>\n<p>cuda \u5b9e\u73b0\u91c7\u7528 <a href=\"https://github.com/vllm-project/vllm/blob/main/vllm/device_allocator/cumem.py#L106-L107\" title=\"CuMemAllocator \u7c7b\u5b9e\u73b0\">CuMemAllocator \u7c7b\u5b9e\u73b0</a>\u3002pointer_to_data \u4e2d\u4fdd\u5b58\u4e86 ptr \u548c\u5143\u6570\u636e\u3002</p>\n<p>sleep \u65b9\u6cd5\u5c31\u662f\u5c06offload_tags\u4e2d\u7684\u6570\u636e\u5148offload\u5230cpu\uff0c\u5373\u8c03\u7528 cudaMemcpy DeviceToHost \u62f7\u8d1d\u5230 cpu \u5185\u5b58\u4e2d\u3002\u5e76\u4e14\u8bb0\u5f55\u4e0b cpu_backup_tensor\uff0c\u4f9b wakeup \u7684\u65f6\u5019\uff0c\u5c06 cpu \u5185\u5b58\u4e2d\u7684\u6570\u636e\u62f7\u8d1d\u56de gpu \u5185\u5b58\u4e2d\u3002</p>\n<p>\u5bf9\u4e8e\u6ca1\u6709\u5728 offload_tags \u4e2d\u7684\u6570\u636e\uff0csleep \u65b9\u6cd5\u4f1a\u76f4\u63a5\u4e22\u5f03\u6570\u636e\uff0c\u91ca\u653e\u663e\u5b58\u3002\u8c03\u7528 unmap_and_release\u5b9e\u73b0\u3002\u4e3b\u8981\u662f\u4fdd\u6301\u7528\u6237\u4f7f\u7528\u7684\u865a\u62df\u5730\u5740\u4e0d\u53d8\uff0c\u6682\u505c\u540e\u91ca\u653e\u663e\u5b58\uff0c\u6062\u590d\u91cd\u65b0\u5206\u914d\u663e\u5b58\uff0c\u7ed1\u5b9a\u5230\u865a\u62df\u5730\u5740\u4e0a\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Python</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-29\">29</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">sleep</span><span class=\"p\">(</span>\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a>            <span class=\"bp\">self</span><span class=\"p\">,</span>\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a>            <span class=\"n\">offload_tags</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"o\">...</span><span class=\"p\">],</span>\n<a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a>                                         <span class=\"nb\">str</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\"></a>    <span class=\"k\">if</span> <span class=\"n\">offload_tags</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\"></a>        <span class=\"c1\"># by default, allocated tensors are offloaded</span>\n<a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\"></a>        <span class=\"c1\"># when the allocator sleeps</span>\n<a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\"></a>        <span class=\"n\">offload_tags</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">CuMemAllocator</span><span class=\"o\">.</span><span class=\"n\">default_tag</span><span class=\"p\">,</span> <span class=\"p\">)</span>\n<a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\"></a>    <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">offload_tags</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">):</span>\n<a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\"></a>        <span class=\"n\">offload_tags</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">offload_tags</span><span class=\"p\">,</span> <span class=\"p\">)</span>\n<a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\"></a>\n<a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\"></a>    <span class=\"k\">assert</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">offload_tags</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">)</span>\n<a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\"></a>\n<a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\"></a>    <span class=\"k\">for</span> <span class=\"n\">ptr</span><span class=\"p\">,</span> <span class=\"n\">data</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">pointer_to_data</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n<a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\"></a>        <span class=\"n\">handle</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">handle</span>\n<a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\"></a>        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">tag</span> <span class=\"ow\">in</span> <span class=\"n\">offload_tags</span><span class=\"p\">:</span>\n<a id=\"__codelineno-2-17\" name=\"__codelineno-2-17\"></a>            <span class=\"n\">size_in_bytes</span> <span class=\"o\">=</span> <span class=\"n\">handle</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n<a id=\"__codelineno-2-18\" name=\"__codelineno-2-18\"></a>            <span class=\"n\">cpu_backup_tensor</span> <span class=\"o\">=</span> <span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">empty</span><span class=\"p\">(</span>\n<a id=\"__codelineno-2-19\" name=\"__codelineno-2-19\"></a>                <span class=\"n\">size_in_bytes</span><span class=\"p\">,</span>\n<a id=\"__codelineno-2-20\" name=\"__codelineno-2-20\"></a>                <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">uint8</span><span class=\"p\">,</span>\n<a id=\"__codelineno-2-21\" name=\"__codelineno-2-21\"></a>                <span class=\"n\">device</span><span class=\"o\">=</span><span class=\"s1\">&#39;cpu&#39;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-2-22\" name=\"__codelineno-2-22\"></a>                <span class=\"n\">pin_memory</span><span class=\"o\">=</span><span class=\"n\">is_pin_memory_available</span><span class=\"p\">())</span>\n<a id=\"__codelineno-2-23\" name=\"__codelineno-2-23\"></a>            <span class=\"n\">cpu_ptr</span> <span class=\"o\">=</span> <span class=\"n\">cpu_backup_tensor</span><span class=\"o\">.</span><span class=\"n\">data_ptr</span><span class=\"p\">()</span>\n<a id=\"__codelineno-2-24\" name=\"__codelineno-2-24\"></a>            <span class=\"n\">libcudart</span><span class=\"o\">.</span><span class=\"n\">cudaMemcpy</span><span class=\"p\">(</span><span class=\"n\">cpu_ptr</span><span class=\"p\">,</span> <span class=\"n\">ptr</span><span class=\"p\">,</span> <span class=\"n\">size_in_bytes</span><span class=\"p\">)</span>\n<a id=\"__codelineno-2-25\" name=\"__codelineno-2-25\"></a>            <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">cpu_backup_tensor</span> <span class=\"o\">=</span> <span class=\"n\">cpu_backup_tensor</span>\n<a id=\"__codelineno-2-26\" name=\"__codelineno-2-26\"></a>        <span class=\"n\">unmap_and_release</span><span class=\"p\">(</span><span class=\"n\">handle</span><span class=\"p\">)</span>\n<a id=\"__codelineno-2-27\" name=\"__codelineno-2-27\"></a>\n<a id=\"__codelineno-2-28\" name=\"__codelineno-2-28\"></a>    <span class=\"n\">gc</span><span class=\"o\">.</span><span class=\"n\">collect</span><span class=\"p\">()</span>\n<a id=\"__codelineno-2-29\" name=\"__codelineno-2-29\"></a>    <span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">cuda</span><span class=\"o\">.</span><span class=\"n\">empty_cache</span><span class=\"p\">()</span>\n</code></pre></div></td></tr></table></div>\n<p>wake_up \u65b9\u6cd5\u5219\u662f\u8c03\u7528 create_and_map(handle)\u5b9e\u73b0\u91cd\u65b0\u5206\u914d\u663e\u5b58\uff0c\u5e76\u7ed1\u5b9a\u5230\u865a\u62df\u5730\u5740\u4e0a\u3002\u5c06 offload \u7684\u6570\u636e\u4ece cpu \u62f7\u8d1d\u5230 gpu \u4e2d\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Python</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-13\">13</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">wake_up</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">tags</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a>    <span class=\"k\">for</span> <span class=\"n\">ptr</span><span class=\"p\">,</span> <span class=\"n\">data</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">pointer_to_data</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a>        <span class=\"k\">if</span> <span class=\"n\">tags</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">tag</span> <span class=\"ow\">in</span> <span class=\"n\">tags</span><span class=\"p\">:</span>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a>            <span class=\"n\">handle</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">handle</span>\n<a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\"></a>            <span class=\"n\">create_and_map</span><span class=\"p\">(</span><span class=\"n\">handle</span><span class=\"p\">)</span>\n<a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\"></a>            <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">cpu_backup_tensor</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\"></a>                <span class=\"n\">cpu_backup_tensor</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">cpu_backup_tensor</span>\n<a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\"></a>                <span class=\"k\">if</span> <span class=\"n\">cpu_backup_tensor</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\"></a>                    <span class=\"n\">size_in_bytes</span> <span class=\"o\">=</span> <span class=\"n\">cpu_backup_tensor</span><span class=\"o\">.</span><span class=\"n\">numel</span><span class=\"p\">(</span>\n<a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\"></a>                    <span class=\"p\">)</span> <span class=\"o\">*</span> <span class=\"n\">cpu_backup_tensor</span><span class=\"o\">.</span><span class=\"n\">element_size</span><span class=\"p\">()</span>\n<a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\"></a>                    <span class=\"n\">cpu_ptr</span> <span class=\"o\">=</span> <span class=\"n\">cpu_backup_tensor</span><span class=\"o\">.</span><span class=\"n\">data_ptr</span><span class=\"p\">()</span>\n<a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\"></a>                    <span class=\"n\">libcudart</span><span class=\"o\">.</span><span class=\"n\">cudaMemcpy</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"p\">,</span> <span class=\"n\">cpu_ptr</span><span class=\"p\">,</span> <span class=\"n\">size_in_bytes</span><span class=\"p\">)</span>\n<a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\"></a>                    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">cpu_backup_tensor</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</code></pre></div></td></tr></table></div>\n<p>pointer_to_data \u5143\u6570\u636e\uff1a</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Python</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-8\">8</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a><span class=\"c1\"># py_device, py_alignedSize, py_d_mem (\u4fdd\u5b58\u7684\u7528\u6237\u4f7f\u7528\u7684\u6307\u9488), py_p_memHandle\uff08\u5185\u5b58mmap\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff09</span>\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a><span class=\"n\">HandleType</span> <span class=\"o\">=</span> <span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">]</span>\n<a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\"></a>\n<a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\"></a><span class=\"nd\">@dataclasses</span><span class=\"o\">.</span><span class=\"n\">dataclass</span>\n<a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\"></a><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">AllocationData</span><span class=\"p\">:</span>\n<a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\"></a>    <span class=\"n\">handle</span><span class=\"p\">:</span> <span class=\"n\">HandleType</span>\n<a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\"></a>    <span class=\"n\">tag</span><span class=\"p\">:</span> <span class=\"nb\">str</span>\n<a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\"></a>    <span class=\"n\">cpu_backup_tensor</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">Tensor</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span> <span class=\"c1\"># offload\u5230cpu\u7684tensor</span>\n</code></pre></div></td></tr></table></div>\n<p>python \u8c03\u7528\u5e95\u5c42 c++\u5b9e\u73b0\uff0c\u548c<strong>torch_memory_saver</strong>\u539f\u7406\u5b8c\u5168\u4e00\u81f4\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Python</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-6\">6</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">create_and_map</span><span class=\"p\">(</span><span class=\"n\">allocation_handle</span><span class=\"p\">:</span> <span class=\"n\">HandleType</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a>    <span class=\"n\">python_create_and_map</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">allocation_handle</span><span class=\"p\">)</span>\n<a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\"></a>\n<a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\"></a>\n<a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\"></a><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">unmap_and_release</span><span class=\"p\">(</span><span class=\"n\">allocation_handle</span><span class=\"p\">:</span> <span class=\"n\">HandleType</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\"></a>    <span class=\"n\">python_unmap_and_release</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">allocation_handle</span><span class=\"p\">)</span>\n</code></pre></div></td></tr></table></div>\n<p>c++\u5b9e\u73b0\u67e5\u770b<a href=\"https://github.com/vllm-project/vllm/blob/main/csrc/cumem_allocator.cpp#L297\" title=\"cumem_allocator.cpp\">cumem_allocator.cpp</a>\u3002</p>\n<h3 id=\"ascend-npu-\u7684\u5b9e\u73b0\">Ascend NPU \u7684\u5b9e\u73b0<a class=\"headerlink\" href=\"#ascend-npu-\u7684\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3b\u8981\u901a\u8fc7<a href=\"https://github.com/vllm-project/vllm-ascend/blob/main/vllm_ascend/device_allocator/camem.py\" title=\"CaMemAllocator \u7c7b\u7684\u5b9e\u73b0\">CaMemAllocator \u7c7b\u5b9e\u73b0</a>\u3002python \u8c03\u7528\u5e95\u5c42 c++\u5b9e\u73b0\u3002\u548c cuda \u5b9e\u73b0\u7684\u533a\u522b\u5c31\u662f sleep \u4e2d\u7684 unmap_and_release \u51fd\u6570\u3001wake_up \u4e2d\u7684 create_and_map \u51fd\u6570\u5b9e\u73b0\u4e0d\u4e00\u6837\u3002</p>\n<p>\u5177\u4f53\u5b9e\u73b0\u53ef\u4ee5\u53c2\u8003<a href=\"https://github.com/vllm-project/vllm-ascend/blob/main/csrc/camem_allocator.cpp\" title=\"camem_allocator.cpp\">camem_allocator.cpp</a>\uff0c\u4f7f\u7528 Ascend NPU \u7684 aclrt \u5b9e\u73b0\u4e86\u4fdd\u5b58\u6307\u9488 aclrtReserveMemAddress\u3001\u5185\u5b58\u6620\u5c04\u7b49 API\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-39\">39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-40\">40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-41\">41</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-42\">42</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-43\">43</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-44\">44</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-45\">45</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-46\">46</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">create_and_map</span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">ssize_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">d_mem</span><span class=\"p\">,</span>\n<a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\"></a><span class=\"w\">                    </span><span class=\"n\">aclrtDrvMemHandle</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">p_memHandle</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\"></a><span class=\"w\">  </span><span class=\"n\">ensure_context</span><span class=\"p\">(</span><span class=\"n\">device</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\"></a><span class=\"w\">  </span><span class=\"c1\">// Define memory allocation properties</span>\n<a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\"></a><span class=\"w\">  </span><span class=\"n\">aclrtPhysicalMemProp</span><span class=\"w\"> </span><span class=\"n\">prop</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n<a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\"></a><span class=\"w\">  </span><span class=\"n\">prop</span><span class=\"p\">.</span><span class=\"n\">handleType</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ACL_MEM_HANDLE_TYPE_NONE</span><span class=\"w\"> </span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\"></a><span class=\"w\">  </span><span class=\"n\">prop</span><span class=\"p\">.</span><span class=\"n\">allocationType</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ACL_MEM_ALLOCATION_TYPE_PINNED</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\"></a><span class=\"w\">  </span><span class=\"n\">prop</span><span class=\"p\">.</span><span class=\"n\">memAttr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ACL_HBM_MEM_HUGE</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\"></a><span class=\"w\">  </span><span class=\"n\">prop</span><span class=\"p\">.</span><span class=\"n\">location</span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\"></a><span class=\"w\">  </span><span class=\"n\">prop</span><span class=\"p\">.</span><span class=\"n\">location</span><span class=\"p\">.</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ACL_MEM_LOCATION_TYPE_DEVICE</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-11\" name=\"__codelineno-6-11\"></a><span class=\"w\">  </span><span class=\"n\">prop</span><span class=\"p\">.</span><span class=\"n\">reserve</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-12\" name=\"__codelineno-6-12\"></a>\n<a id=\"__codelineno-6-13\" name=\"__codelineno-6-13\"></a><span class=\"w\">  </span><span class=\"c1\">// Allocate memory using aclrtMallocPhysical</span>\n<a id=\"__codelineno-6-14\" name=\"__codelineno-6-14\"></a><span class=\"w\">  </span><span class=\"n\">aclError</span><span class=\"w\"> </span><span class=\"n\">error_code</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">aclrtMallocPhysical</span><span class=\"p\">(</span><span class=\"n\">p_memHandle</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">prop</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-15\" name=\"__codelineno-6-15\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">error_code</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-16\" name=\"__codelineno-6-16\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">cerr</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;acl Error, code: &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">error_code</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot; at &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">__FILE__</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;:&quot;</span><span class=\"w\"> </span>\\\n<a id=\"__codelineno-6-17\" name=\"__codelineno-6-17\"></a><span class=\"w\">            </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">__LINE__</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-18\" name=\"__codelineno-6-18\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-19\" name=\"__codelineno-6-19\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-20\" name=\"__codelineno-6-20\"></a><span class=\"w\">  </span><span class=\"n\">error_code</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">aclrtMapMem</span><span class=\"p\">(</span><span class=\"n\">d_mem</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p_memHandle</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-21\" name=\"__codelineno-6-21\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">error_code</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-22\" name=\"__codelineno-6-22\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">cerr</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;acl Error, code: &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">error_code</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot; at &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">__FILE__</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;:&quot;</span><span class=\"w\"> </span>\\\n<a id=\"__codelineno-6-23\" name=\"__codelineno-6-23\"></a><span class=\"w\">            </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">__LINE__</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-24\" name=\"__codelineno-6-24\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-25\" name=\"__codelineno-6-25\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-26\" name=\"__codelineno-6-26\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-6-27\" name=\"__codelineno-6-27\"></a>\n<a id=\"__codelineno-6-28\" name=\"__codelineno-6-28\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">unmap_and_release</span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">ssize_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span>\n<a id=\"__codelineno-6-29\" name=\"__codelineno-6-29\"></a><span class=\"w\">                       </span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">d_mem</span><span class=\"p\">,</span>\n<a id=\"__codelineno-6-30\" name=\"__codelineno-6-30\"></a><span class=\"w\">                       </span><span class=\"n\">aclrtDrvMemHandle</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">p_memHandle</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-31\" name=\"__codelineno-6-31\"></a><span class=\"w\">  </span><span class=\"c1\">// std::cout &lt;&lt; &quot;unmap_and_release: device=&quot; &lt;&lt; device &lt;&lt; &quot;, size=&quot; &lt;&lt; size &lt;&lt;</span>\n<a id=\"__codelineno-6-32\" name=\"__codelineno-6-32\"></a><span class=\"w\">  </span><span class=\"c1\">// &quot;, d_mem=&quot; &lt;&lt; d_mem &lt;&lt; &quot;, p_memHandle=&quot; &lt;&lt; p_memHandle &lt;&lt; std::endl;</span>\n<a id=\"__codelineno-6-33\" name=\"__codelineno-6-33\"></a><span class=\"w\">  </span><span class=\"n\">ensure_context</span><span class=\"p\">(</span><span class=\"n\">device</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-34\" name=\"__codelineno-6-34\"></a><span class=\"w\">  </span><span class=\"n\">aclError</span><span class=\"w\"> </span><span class=\"n\">error_code</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">aclrtUnmapMem</span><span class=\"p\">(</span><span class=\"n\">d_mem</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-35\" name=\"__codelineno-6-35\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">error_code</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-36\" name=\"__codelineno-6-36\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">cerr</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;acl Error, code: &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">error_code</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot; at &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">__FILE__</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;:&quot;</span><span class=\"w\"> </span>\\\n<a id=\"__codelineno-6-37\" name=\"__codelineno-6-37\"></a><span class=\"w\">            </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">__LINE__</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-38\" name=\"__codelineno-6-38\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-39\" name=\"__codelineno-6-39\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-40\" name=\"__codelineno-6-40\"></a><span class=\"w\">  </span><span class=\"n\">error_code</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">aclrtFreePhysical</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">p_memHandle</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-41\" name=\"__codelineno-6-41\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">error_code</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-42\" name=\"__codelineno-6-42\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">cerr</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;acl Error, code: &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">error_code</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot; at &quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">__FILE__</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;:&quot;</span><span class=\"w\"> </span>\\\n<a id=\"__codelineno-6-43\" name=\"__codelineno-6-43\"></a><span class=\"w\">            </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">__LINE__</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-44\" name=\"__codelineno-6-44\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-45\" name=\"__codelineno-6-45\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-46\" name=\"__codelineno-6-46\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u901a\u8fc7 pytorch \u63d2\u4ef6\u6ce8\u518c\u4e86 NPU \u7684\u81ea\u5b9a\u4e49 my_malloc \u548c my_free \u51fd\u6570\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Python</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-7-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-17\">17</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\"></a><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">get_pluggable_allocator</span><span class=\"p\">(</span>\n<a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\"></a>    <span class=\"n\">python_malloc_fn</span><span class=\"p\">:</span> <span class=\"n\">Callable</span><span class=\"p\">[[</span><span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">]],</span> <span class=\"kc\">None</span><span class=\"p\">],</span>\n<a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\"></a>    <span class=\"n\">python_free_func</span><span class=\"p\">:</span> <span class=\"n\">Callable</span><span class=\"p\">[[</span><span class=\"nb\">int</span><span class=\"p\">],</span> <span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">]]</span>\n<a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\"></a><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">npu</span><span class=\"o\">.</span><span class=\"n\">memory</span><span class=\"o\">.</span><span class=\"n\">NPUPluggableAllocator</span><span class=\"p\">:</span>\n<a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\"></a>    <span class=\"n\">init_module</span><span class=\"p\">(</span><span class=\"n\">python_malloc_fn</span><span class=\"p\">,</span> <span class=\"n\">python_free_func</span><span class=\"p\">)</span>\n<a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\"></a>    <span class=\"n\">new_alloc</span> <span class=\"o\">=</span> <span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">npu</span><span class=\"o\">.</span><span class=\"n\">memory</span><span class=\"o\">.</span><span class=\"n\">NPUPluggableAllocator</span><span class=\"p\">(</span><span class=\"n\">lib_name</span><span class=\"p\">,</span> <span class=\"s1\">&#39;my_malloc&#39;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\"></a>                                                       <span class=\"s1\">&#39;my_free&#39;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\"></a>    <span class=\"k\">return</span> <span class=\"n\">new_alloc</span>\n<a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\"></a>\n<a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\"></a><span class=\"nd\">@contextmanager</span>\n<a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\"></a><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">use_memory_pool_with_allocator</span><span class=\"p\">(</span>\n<a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\"></a>        <span class=\"n\">python_malloc_fn</span><span class=\"p\">:</span> <span class=\"n\">Callable</span><span class=\"p\">[[</span><span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">]],</span> <span class=\"kc\">None</span><span class=\"p\">],</span>\n<a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\"></a>        <span class=\"n\">python_free_func</span><span class=\"p\">:</span> <span class=\"n\">Callable</span><span class=\"p\">[[</span><span class=\"nb\">int</span><span class=\"p\">],</span> <span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">]]):</span>\n<a id=\"__codelineno-7-14\" name=\"__codelineno-7-14\"></a>    <span class=\"n\">new_alloc</span> <span class=\"o\">=</span> <span class=\"n\">get_pluggable_allocator</span><span class=\"p\">(</span><span class=\"n\">python_malloc_fn</span><span class=\"p\">,</span> <span class=\"n\">python_free_func</span><span class=\"p\">)</span>\n<a id=\"__codelineno-7-15\" name=\"__codelineno-7-15\"></a>    <span class=\"n\">mem_pool</span> <span class=\"o\">=</span> <span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">npu</span><span class=\"o\">.</span><span class=\"n\">memory</span><span class=\"o\">.</span><span class=\"n\">MemPool</span><span class=\"p\">(</span><span class=\"n\">new_alloc</span><span class=\"o\">.</span><span class=\"n\">_allocator</span><span class=\"p\">)</span>\n<a id=\"__codelineno-7-16\" name=\"__codelineno-7-16\"></a>    <span class=\"k\">with</span> <span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">npu</span><span class=\"o\">.</span><span class=\"n\">memory</span><span class=\"o\">.</span><span class=\"n\">use_mem_pool</span><span class=\"p\">(</span><span class=\"n\">mem_pool</span><span class=\"p\">):</span>\n<a id=\"__codelineno-7-17\" name=\"__codelineno-7-17\"></a>        <span class=\"k\">yield</span> <span class=\"n\">mem_pool</span><span class=\"p\">,</span> <span class=\"n\">new_alloc</span>\n</code></pre></div></td></tr></table></div>\n<p>torch_memory_saver \u7684\u5b9e\u73b0\u548c vllm \u4e2d sleep_mode \u7528\u5230\u7684 CuMemAllocator \u5b9e\u73b0\u662f\u4e00\u6837\u7684\uff0c\u9664\u6b64\u4e4b\u5916 vllm \u9488\u5bf9 npu \u5b9e\u73b0\u4e86 CaMemAllocator\uff0c\u8c03\u7528\u7684 aclrt \u5b9e\u73b0\u3002\nvllm \u7684 sleep_mode \u9664\u4e86\u5c06 gpu \u5185\u5b58\u91ca\u653e\uff0c\u8fd8\u5b9e\u73b0\u4e86\u6839\u636e offload_tags offload \u5230 cpu\uff08\u4e3b\u8981\u662f\u6743\u91cd\uff09\u3002</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/gpu\u7684pin_memory\u662f\u4ec0\u4e48/\" target=\"_blank\">GPU\u7684pin_memory\u662f\u4ec0\u4e48\uff1f</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898/\" target=\"_blank\">C++\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-07-06T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/%E4%BC%98%E9%9B%85%E5%BC%80%E5%8F%91%E7%AF%87git-worktree%E5%B9%B6%E8%A1%8C%E5%88%86%E6%94%AF%E5%BC%80%E5%8F%91%E5%8F%8A%E4%B8%80%E4%B8%AA%E6%B5%8B%E9%87%8F%E4%BA%8C%E8%BF%9B%E7%A8%8B%E8%86%A8%E8%83%80%E7%9A%84rust%E5%B7%A5%E5%85%B7%E5%BA%94%E7%94%A8/",
            "url": "https://github.com/KenForever1/blog/%E4%BC%98%E9%9B%85%E5%BC%80%E5%8F%91%E7%AF%87git-worktree%E5%B9%B6%E8%A1%8C%E5%88%86%E6%94%AF%E5%BC%80%E5%8F%91%E5%8F%8A%E4%B8%80%E4%B8%AA%E6%B5%8B%E9%87%8F%E4%BA%8C%E8%BF%9B%E7%A8%8B%E8%86%A8%E8%83%80%E7%9A%84rust%E5%B7%A5%E5%85%B7%E5%BA%94%E7%94%A8/",
            "title": "\u4f18\u96c5\u5f00\u53d1\u7bc7\uff1agit worktree\u5e76\u884c\u5206\u652f\u5f00\u53d1\uff0c\u53ca\u4e00\u4e2a\u6d4b\u91cf\u4e8c\u8fdb\u7a0b\u81a8\u80c0\u7684rust\u5de5\u5177\u5e94\u7528",
            "content_html": "<h2 id=\"git-worktree-\u662f\u4ec0\u4e48\">git worktree \u662f\u4ec0\u4e48\uff1f<a class=\"headerlink\" href=\"#git-worktree-\u662f\u4ec0\u4e48\" title=\"Permanent link\">&para;</a></h2>\n<p>Git Worktree \u662f Git \u63d0\u4f9b\u7684\u4e00\u4e2a\u5f3a\u5927\u529f\u80fd\uff0c\u5141\u8bb8\u4f60\u5728\u540c\u4e00\u4e2a\u4ed3\u5e93\u4e2d<strong>\u521b\u5efa\u591a\u4e2a\u72ec\u7acb\u7684\u5de5\u4f5c\u76ee\u5f55</strong>\uff0c\u6bcf\u4e2a\u76ee\u5f55\u53ef\u4ee5\u5173\u8054\u4e0d\u540c\u7684\u5206\u652f\uff08\u6216\u8005 commit\uff09\uff0c\u4ece\u800c\u5b9e\u73b0\u5e76\u884c\u5f00\u53d1\u800c<strong>\u65e0\u9700\u9891\u7e41\u5207\u6362\u5206\u652f\u6216\u4f9d\u8d56 git stash \u6682\u5b58\u4ee3\u7801 \u200c</strong>\u3002</p>\n<!-- more -->\n\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/git-worktree.png\" /></p>\n<h3 id=\"\u53ef\u4ee5\u89e3\u51b3\u4ec0\u4e48\u95ee\u9898\">\u53ef\u4ee5\u89e3\u51b3\u4ec0\u4e48\u95ee\u9898\uff1f<a class=\"headerlink\" href=\"#\u53ef\u4ee5\u89e3\u51b3\u4ec0\u4e48\u95ee\u9898\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6ca1\u6709\u4f7f\u7528 worktree \u7684\u540c\u5b66\uff0c\u5047\u8bbe\u5728 dev \u5206\u652f\u4e0a\u5f00\u53d1\uff0c\u5f00\u53d1\u4e86\u4e00\u534a\uff0c\u9700\u8981\u5207\u6362\u5230 release \u5206\u652f\u4fee\u590d bug\uff0c\u90a3\u4e48\u9700\u8981\uff1a</p>\n<ol>\n<li>\u4fdd\u5b58\u5f53\u524d\u5206\u652f\u7684\u72b6\u6001\uff0c\u6bd4\u5982 git commit \u6216\u8005 git stash\u3002</li>\n<li>\u5207\u6362\u5230 release \u5206\u652f\uff0c\u5207\u4e00\u4e2a hotfix \u5206\u652f\uff0c\u4fee\u590d bug\uff0c\u63d0\u4ea4\u3002</li>\n<li>\u5207\u6362\u56de\u6765\u7ee7\u7eed\u5f00\u53d1\u3002</li>\n</ol>\n<p>\u6216\u8005\uff1a</p>\n<ol>\n<li>git clone repo \u5230\u53e6\u4e00\u4e2a\u76ee\u5f55\uff0c\u4fee\u590d bug\u3002</li>\n<li>\u5207\u6362\u56de\u539f\u76ee\u5f55\uff0c\u7ee7\u7eed\u5f00\u53d1\u3002</li>\n</ol>\n<p>\u7f3a\u70b9\u5c31\u662f\uff1a</p>\n<p>\u7b2c\u4e00\uff0c\u8fd9\u6837\u5f88\u9ebb\u70e6\uff0c\u5207\u6765\u5207\u53bb\u3002</p>\n<p>\u7b2c\u4e8c\uff0c\u5360\u5730\u65b9\uff0c\u591a\u4e2a repo \u62f7\u8d1d\u5360\u78c1\u76d8\u7a7a\u95f4\u3002</p>\n<p>\u7b2c\u4e09\uff0c\u5982\u679c 2 \u4e2a\u7248\u672c\u5206\u652f\u7684\u5de5\u7a0b\u4f9d\u8d56\u73af\u5883\u5dee\u5f02\u8f83\u5927\uff0c\u5bfc\u81f4\u6bcf\u6b21\u5207\u6362\u5206\u652f\u540e\uff0c\u5de5\u7a0b\u90fd\u90fd\u9700\u8981\u91cd\u65b0\u5b89\u88c5\u4f9d\u8d56\u4ee5\u53ca\u505a\u5168\u91cf\u7f16\u8bd1\u2014\u2014\u8fd9\u65e0\u7591\u589e\u52a0\u4e86\u7f16\u8bd1\u65f6\u95f4\uff0c\u5bfc\u81f4\u5f00\u53d1\u6548\u7387\u4e0b\u964d\u3002</p>\n<h3 id=\"\u6709\u4ec0\u4e48\u4f18\u52bf\">\u6709\u4ec0\u4e48\u4f18\u52bf\uff1f<a class=\"headerlink\" href=\"#\u6709\u4ec0\u4e48\u4f18\u52bf\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9488\u5bf9\u8fd9\u4e2a\u75db\u70b9\uff0c Git Worktree \u51fa\u73b0\u4e86, \u5b83\u5177\u6709\u4e0b\u9762\u7684\u4f18\u52bf\uff1a</p>\n<ol>\n<li>\u4e0d\u9700\u8981\u63d0\u4ea4\u6216\u8005\u6682\u5b58\u4ee3\u7801\uff0c\u5c31\u53ef\u4ee5\u5207\u6362\u5206\u652f\u3002\u9762\u5bf9\u591a\u4e2a\u5206\u652f\u7684\u4ee3\u7801\u4e0d\u9700\u8981\u9891\u7e41\u5207\u6362\u3002</li>\n<li>\u6bcf\u4e2a\u5de5\u4f5c\u533a\u5171\u4eab\u540c\u4e00\u4e2a\u7248\u672c\u4ed3\u5e93\u4fe1\u606f\uff0c\u66f4\u8282\u7701\u786c\u76d8\u7a7a\u95f4\u3002</li>\n<li>\u5404\u4e2a\u5de5\u4f5c\u533a\u4e4b\u95f4\u7684\u66f4\u65b0\u540c\u6b65\u66f4\u5feb\uff0cgit clone \u65b9\u5f0f\u4e0b\uff0cA \u5de5\u4f5c\u533a\u548c B \u5de5\u4f5c\u533a\u9700\u8981 A commit-&gt; A push -&gt; B pull\u3002git worktree \u65b9\u5f0f\u4e0b\uff0cA \u5de5\u4f5c\u533a\u53ea\u8981\u672c\u5730\u63d0\u4ea4\u66f4\u65b0\u540e\uff0c\u5176\u4ed6\u5de5\u4f5c\u533a\u5c31\u80fd\u7acb\u5373\u6536\u5230\uff08\u56e0\u4e3a\u5b83\u4eec\u5171\u4eab\u540c\u4e00\u4e2a\u7248\u672c\u4ed3\u5e93\uff09\u3002</li>\n</ol>\n<h2 id=\"\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u5b66\u4e60\u4f7f\u7528-git-worktree\">\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u5b66\u4e60\u4f7f\u7528 git worktree<a class=\"headerlink\" href=\"#\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u5b66\u4e60\u4f7f\u7528-git-worktree\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"git-worktree\u5982\u4f55\u4f7f\u7528\">git worktree\u5982\u4f55\u4f7f\u7528<a class=\"headerlink\" href=\"#git-worktree\u5982\u4f55\u4f7f\u7528\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5047\u8bbe\u6211\u4eec\u6709\u4e2a helloworld \u7684\u4ed3\u5e93\uff1ahttps://github.com/KenForever1/helloworld\u3002</p>\n<p>\u5f53\u524d\u5de5\u4f5c\u5728 dev \u5206\u652f\u4e0a\uff0c\u60f3\u8981\u5728 release \u5206\u652f\u4fee\u590d bug\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u4f7f\u7528 git worktree\uff0c\u800c\u65e0\u9700\u5207\u6362\u5206\u652f\u3002</p>\n<p>\u4e3arelease\u5206\u652f\u589e\u52a0\u4e00\u4e2aworktree\uff1a</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>/workspace/helloworld\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a>git<span class=\"w\"> </span>worktree<span class=\"w\"> </span>add<span class=\"w\"> </span>../release-branch<span class=\"w\"> </span>release\n</code></pre></div></td></tr></table></div>\n<p>\u8fdb\u5165release\u5206\u652f\u7684worktree\u76ee\u5f55\uff0c\u4fee\u590dbug:\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>../release-branch\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a>//<span class=\"w\"> </span>fix<span class=\"w\"> </span>your<span class=\"w\"> </span>bug<span class=\"w\"> </span>here\n</code></pre></div></td></tr></table></div></p>\n<p>\u67e5\u770b\u5f53\u524d worktree \u5217\u8868\uff1a</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a>git<span class=\"w\"> </span>worktree<span class=\"w\"> </span>list\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a>/workspace/helloworld<span class=\"w\"> </span><span class=\"o\">[</span>main<span class=\"o\">]</span>\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a>/workspace/release-branch<span class=\"w\"> </span><span class=\"o\">[</span>release-branch<span class=\"o\">]</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5207\u6362\u56de dev \u5206\u652f\uff0c\u5220\u9664 release \u5206\u652f\uff1a</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>../dev-branch\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a>git<span class=\"w\"> </span>worktree<span class=\"w\"> </span>remove<span class=\"w\"> </span>release-branch\n</code></pre></div></td></tr></table></div>\n<h3 id=\"\u5176\u4ed6\u547d\u4ee4\">\u5176\u4ed6\u547d\u4ee4<a class=\"headerlink\" href=\"#\u5176\u4ed6\u547d\u4ee4\" title=\"Permanent link\">&para;</a></h3>\n<ol>\n<li>\u5220\u9664\u9664\u4e86 remove \u547d\u4ee4\uff0c\u8fd8\u53ef\u4ee5\u624b\u52a8\u5220\u9664\u76ee\u5f55\uff0c\u7136\u540e git worktree \u4f1a\u81ea\u52a8\u6e05\u7406</li>\n</ol>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a>rm<span class=\"w\"> </span>-rf<span class=\"w\"> </span>../release-branch\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a>git<span class=\"w\"> </span>worktree<span class=\"w\"> </span>prune\n</code></pre></div></td></tr></table></div>\n<ol>\n<li>\u9501\u5b9a\u4e0e\u89e3\u9501 \u200c</li>\n</ol>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a>git<span class=\"w\"> </span>worktree<span class=\"w\"> </span>lock<span class=\"w\"> </span>releas-branch<span class=\"w\"> </span>--reason<span class=\"w\"> </span><span class=\"s2\">&quot;\u7ef4\u62a4\u4e2d&quot;</span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a><span class=\"c1\"># \u89e3\u9501\u200c</span>\n<a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\"></a>git<span class=\"w\"> </span>worktree<span class=\"w\"> </span>unlock<span class=\"w\"> </span>releas-branch\n</code></pre></div></td></tr></table></div>\n<p>\u9501\u5b9a\u4e86\u4ee5\u540e\uff0cgit worktree remove \u4f1a\u62a5\u9519\uff0c\u9700\u8981\u5148\u89e3\u9501\u3002</p>\n<h2 id=\"\u4e00\u4e2a\u6d4b\u91cf\u4e8c\u8fdb\u5236\u81a8\u80c0\u7684-rust-\u5c0f\u5de5\u5177\">\u4e00\u4e2a\u6d4b\u91cf\u4e8c\u8fdb\u5236\u81a8\u80c0\u7684 rust \u5c0f\u5de5\u5177<a class=\"headerlink\" href=\"#\u4e00\u4e2a\u6d4b\u91cf\u4e8c\u8fdb\u5236\u81a8\u80c0\u7684-rust-\u5c0f\u5de5\u5177\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u8bbe\u8ba1\u539f\u7406\">\u8bbe\u8ba1\u539f\u7406<a class=\"headerlink\" href=\"#\u8bbe\u8ba1\u539f\u7406\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0b\u9762\u4ecb\u7ecd\u7684\u4e00\u4e2a rust \u5de5\u5177\u6d4b\u91cf\u4e8c\u8fdb\u5236\u81a8\u80c0\uff08Measures bloat\uff09\u7684\u5c0f\u5de5\u5177\uff1a\n<a href=\"https://github.com/facet-rs/limpid/blob/HEAD/limpid/src/main.rs\" title=\"facet-rs/limpid\">facet-rs/limpid</a></p>\n<p>\u4e00\u4e2a\u662f\u5f53\u524d HEAD\uff08\u76ee\u524d\u5f00\u53d1\u7684\u65b0\u7279\u6027\uff09\uff0c\u4e00\u4e2a\u662f main \u5206\u652f\uff08\u5df2\u7ecf\u53d1\u5e03\u7684\u7248\u672c\uff09\u3002\u76ee\u7684\u662f\u60f3\u5bf9\u6bd4\u5206\u6790\u4e24\u4e2a\u76ee\u5f55\u4e0b\u7684\u7f16\u8bd1\u6784\u5efa\u8017\u65f6\uff0c\u4e8c\u8fdb\u5236\u5927\u5c0f\u5dee\u5f02\u7b49\u3002\n\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\uff0c\u9488\u5bf9 HEAD \u5f00\u53d1\u76ee\u5f55\uff0c\u521b\u5efa\u4e86\u4e00\u4e2a worktree \u76ee\u5f55\uff0c\u547d\u540d\u4e3a main\u3002\u5bf9\u6bd4\u5206\u6790\u5b8c\u6210\u540e\uff0c\u5220\u9664 worktree \u76ee\u5f55\u3002</p>\n<p>\u56e0\u4e3a\u5bf9\u6bd4\u7684\u4ed3\u5e93<a href=\"https://github.com/facet-rs/facet\" title=\"facet-rs/facet\">facet-rs/facet</a>\uff0c\u662f\u4e00\u4e2a rust \u5e8f\u5217\u5316\u5e93 crate\uff0c\u53ef\u4ee5\u7406\u89e3\u548c serde \u5dee\u4e0d\u591a\u3002\n\u5728 limpid \u5de5\u5177\u4e2d\uff0c\u5305\u62ec\u4e86\u521b\u5efa worktree \u548c\u7f16\u8bd1\u7edf\u8ba1\u4fe1\u606f\u7684\u4ee3\u7801\uff0c\u53e6\u4e00\u4e2a\u5c31\u662f\u4f7f\u7528 facet \u5e93\u7684\u4f8b\u5b50\uff0c\u91c7\u7528\u76f8\u5bf9\u76ee\u5f55\u5f15\u7528 facet\u3002\u6240\u4ee5\u53ea\u8981\u4fdd\u6301\u5c42\u7ea7\u4e00\u81f4\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u4e0d\u540c\u5206\u652f\u7684 facet \u5e93\u3002</p>\n<p>\u5de5\u4f5c\u76ee\u5f55\u7684\u7ed3\u6784\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-17\">17</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a>facet/<span class=\"w\"> </span><span class=\"c1\"># facet\u5e93HEAD\u5206\u652f</span>\n<a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\"></a><span class=\"w\">  </span>facet/\n<a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\"></a><span class=\"w\">    </span>Cargo.toml\n<a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\"></a><span class=\"w\">  </span>facet-core/\n<a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\"></a><span class=\"w\">    </span>Cargo.toml\n<a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\"></a><span class=\"w\">  </span>facet-reflect/\n<a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\"></a><span class=\"w\">    </span>Cargo.toml\n<a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\"></a>limpid/<span class=\"w\"> </span><span class=\"c1\"># limpid\u5de5\u5177</span>\n<a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\"></a><span class=\"w\">  </span>limpid/<span class=\"w\"> </span><span class=\"c1\"># limpid\u5de5\u5177</span>\n<a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\"></a><span class=\"w\">    </span>Cargo.toml<span class=\"w\"> </span><span class=\"c1\"># this tool</span>\n<a id=\"__codelineno-6-11\" name=\"__codelineno-6-11\"></a><span class=\"w\">  </span>kitchensink/<span class=\"w\"> </span><span class=\"c1\"># \u4f7f\u7528facet\u5e93\u7684\u4f8b\u5b50\uff0c\u53ef\u4ee5\u7f16\u8bd1\u6210\u4e8c\u8fdb\u5236\u7a0b\u5e8f</span>\n<a id=\"__codelineno-6-12\" name=\"__codelineno-6-12\"></a><span class=\"w\">    </span>ks-facet/\n<a id=\"__codelineno-6-13\" name=\"__codelineno-6-13\"></a><span class=\"w\">      </span>Cargo.toml<span class=\"w\"> </span><span class=\"c1\"># \u76f8\u5bf9\u76ee\u5f55\u65b9\u5f0f\uff0c\u5f15\u7528../facet\u5e93</span>\n<a id=\"__codelineno-6-14\" name=\"__codelineno-6-14\"></a><span class=\"w\">    </span>ks-serde/\n<a id=\"__codelineno-6-15\" name=\"__codelineno-6-15\"></a><span class=\"w\">      </span>Cargo.toml\n<a id=\"__codelineno-6-16\" name=\"__codelineno-6-16\"></a><span class=\"w\">    </span>ks-facet-json-read/\n<a id=\"__codelineno-6-17\" name=\"__codelineno-6-17\"></a><span class=\"w\">    </span><span class=\"c1\"># etc.</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5bf9\u6bd4\u7684 main worktree \u76ee\u5f55\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-7-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-13\">13</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\"></a>/tmp/\n<a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\"></a><span class=\"w\">  </span>limpid-main-workspace/\n<a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\"></a><span class=\"w\">    </span>facet/<span class=\"w\">       </span><span class=\"c1\"># worktree from facet repo at main branch</span>\n<a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\"></a><span class=\"w\">      </span>facet/\n<a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\"></a><span class=\"w\">      </span>facet-core/\n<a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\"></a><span class=\"w\">      </span>facet-reflect/\n<a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\"></a><span class=\"w\">    </span>limpid/<span class=\"w\">      </span><span class=\"c1\"># worktree from limpid repo at current HEAD</span>\n<a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\"></a><span class=\"w\">      </span>limpid/\n<a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\"></a><span class=\"w\">      </span>kitchensink/\n<a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\"></a><span class=\"w\">        </span>ks-facet/\n<a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\"></a><span class=\"w\">        </span>ks-serde/\n<a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\"></a><span class=\"w\">        </span>ks-facet-json-read/\n<a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\"></a><span class=\"w\">        </span><span class=\"c1\"># etc.</span>\n</code></pre></div></td></tr></table></div>\n<p>\u901a\u8fc7\uff0c\u8fd9\u4e2a\u5de5\u5177\u6211\u4eec\u53ef\u4ee5\u5b66\u4e60 worktree \u7684\u7528\u6cd5\uff0c\u4e5f\u53ef\u4ee5\u5b66\u4e60\u5230\u4e00\u4e9b\u5de5\u5177\u7684\u8bbe\u8ba1\u7406\u5ff5\u3002\u4e0e\u8bed\u8a00\u65e0\u5173\uff0c\u4f60\u4e5f\u53ef\u4ee5\u7528 python \u6216 c++\u4ee5\u53ca\u5176\u4ed6\u8bed\u8a00\u5b9e\u73b0\u3002</p>\n<h3 id=\"\u6742\u8c08\">\u6742\u8c08<a class=\"headerlink\" href=\"#\u6742\u8c08\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u4e2a\u4f8b\u5b50\u5982\u679c\u4f60\u60f3\u5b66\u4e60 rust \u4e5f\u53ef\u4ee5\u53c2\u8003\uff0c\u91cc\u9762\u6709\u5f88\u591a\u5e38\u7528\u7684\u4e0d\u9519\u7684 crate \u4f7f\u7528\uff0c\u6bd4\u5982\uff1a</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-8-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-6\">6</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\"></a><span class=\"nv\">anyhow</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;1.0&quot;</span><span class=\"w\"> </span><span class=\"c1\"># \u7528\u4e8e\u9519\u8bef\u5904\u7406</span>\n<a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\"></a><span class=\"nv\">substance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;0.7.1&quot;</span><span class=\"w\"> </span><span class=\"c1\"># https://github.com/fasterthanlime/substance.git\uff0c\u68c0\u67e5\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u7b26\u53f7\u3001\u5206\u6790\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u5927\u5c0f\u6784\u6210</span>\n<a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\"></a>owo-colors<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;4.0&quot;</span><span class=\"w\"> </span><span class=\"c1\"># \u7528\u4e8e\u547d\u4ee4\u884c\u8f93\u51fa\u5f69\u8272\u5b57</span>\n<a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\"></a><span class=\"nv\">indicatif</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;0.17&quot;</span><span class=\"w\"> </span><span class=\"c1\"># \u8fdb\u5ea6\u6761</span>\n<a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\"></a><span class=\"nv\">camino</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;1.1.10&quot;</span><span class=\"w\"> </span><span class=\"c1\"># Utf8\u8def\u5f84\u652f\u6301\uff0cPath\u548cPathBuf\u66f4\u597d\u7684\u5305\u88c5</span>\n<a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\"></a>pico-args<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;0.5.0&quot;</span><span class=\"w\"> </span><span class=\"c1\"># \u547d\u4ee4\u884c\u53c2\u6570\u89e3\u6790\uff0c\u6bd4clap\u66f4\u8f7b\u91cf</span>\n</code></pre></div></td></tr></table></div>\n<p>\u987a\u4fbf\u63d0\u4e00\u53e5\uff0c\u9488\u5bf9\u521a\u521a\u63d0\u5230\u7684 substance rust \u5de5\u5177\uff0cgoogle \u4e5f\u6709\u4e2a c++\u5de5\u5177<a href=\"https://github.com/google/bloaty\" title=\"Bloaty\">Bloaty</a>\u3002\u53ef\u4ee5\u89e3\u51b3\u662f\u4ec0\u4e48\u8ba9\u4f60\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u53d8\u5f97\u8fd9\u4e48\u5927\uff1f<strong>Bloaty \u4f1a\u4e3a\u4f60\u5c55\u793a\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u5927\u5c0f\u5206\u5e03</strong>\uff0c\u8fd9\u6837\u4f60\u5c31\u80fd\u4e86\u89e3\u5176\u4e2d\u662f\u4ec0\u4e48\u5360\u7528\u4e86\u7a7a\u95f4\u3002</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/fish\u5982\u4f55\u589e\u52a0\u548c\u5220\u9664\u73af\u5883\u53d8\u91cfpath\u4e3a\u4ec0\u4e48\u6ca1\u6709fish_remove_path\u65b9\u6cd5\u5220\u9664\u73af\u5883\u53d8\u91cf/\" target=\"_blank\">fish\u5982\u4f55\u589e\u52a0\u548c\u5220\u9664\u73af\u5883\u53d8\u91cfPATH\uff1f\u4e3a\u4ec0\u4e48\u6ca1\u6709fish_remove_path\u65b9\u6cd5\u5220\u9664\u73af\u5883\u53d8\u91cf</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u9759\u6001\u5e93\u548c\u52a8\u6001\u5e93\u5168\u5c40\u53d8\u91cf\u521d\u59cb\u5316\u6709\u4f55\u4e0d\u540c/\" target=\"_blank\">c++\u9759\u6001\u5e93\u548c\u52a8\u6001\u5e93\u5168\u5c40\u53d8\u91cf\u521d\u59cb\u5316\u6709\u4f55\u4e0d\u540c\uff1f</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c20\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8e\u5c5e\u6027\u6d4b\u8bd5\u7684quickcheck-cpp\u5e93/\" target=\"_blank\">C++20\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8e\u5c5e\u6027\u6d4b\u8bd5\u7684quickcheck-cpp\u5e93</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-07-01T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/c%E6%8A%80%E6%B3%95%E6%A8%A1%E6%9D%BF%E5%85%83%E7%BC%96%E7%A8%8B%E7%BC%96%E8%AF%91%E6%9C%9F%E8%8E%B7%E5%8F%96%E7%B1%BB%E6%88%90%E5%91%98%E6%95%B0%E9%87%8F/",
            "url": "https://github.com/KenForever1/blog/c%E6%8A%80%E6%B3%95%E6%A8%A1%E6%9D%BF%E5%85%83%E7%BC%96%E7%A8%8B%E7%BC%96%E8%AF%91%E6%9C%9F%E8%8E%B7%E5%8F%96%E7%B1%BB%E6%88%90%E5%91%98%E6%95%B0%E9%87%8F/",
            "title": "C++\u6280\u6cd5:\u6a21\u677f\u5143\u7f16\u7a0b\u7f16\u8bd1\u671f\u83b7\u53d6\u7c7b\u6210\u5458\u6570\u91cf",
            "content_html": "<p>C++\u53cd\u5c04\u4e2d\uff0c\u6709\u4e2a\u5fc5\u8981\u7684\u5c31\u662f\u9700\u8981\u83b7\u53d6\u4e00\u4e2a\u7c7b\u7684\u6210\u5458\u4e2a\u6570\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u6839\u636e\u4e2a\u6570\uff0c\u5c06\u7c7b\u7684\u6210\u5458\u901a\u8fc7std::tie\u8f6c\u6362\u6210tuple\u3002\u7ee7\u800c\u53ef\u4ee5\u5b9e\u73b0equal\u3001hash\u3001serialize\u7b49\u529f\u80fd\u3002</p>\n<!-- more -->\n\n<h3 id=\"\u57fa\u672c\u539f\u7406\">\u57fa\u672c\u539f\u7406<a class=\"headerlink\" href=\"#\u57fa\u672c\u539f\u7406\" title=\"Permanent link\">&para;</a></h3>\n<p>\u672c\u6587\u4ecb\u7ecd\u5206\u6790\u5982\u4f55\u83b7\u53d6\u4e00\u4e2a\u7c7b\u7684\u6210\u5458\u4e2a\u6570\u7684\u65b9\u6cd5\uff0c\u901a\u8fc7\u6a21\u677f\u5143\u7f16\u7a0b\u5b9e\u73b0\uff0c\u57fa\u672c\u539f\u7406\uff1a\n+ <strong>\u7f16\u8bd1\u65f6\u8ba1\u7b97</strong>\u7ed3\u6784\u4f53\u6210\u5458\u6570\u91cf</p>\n<ul>\n<li>\n<p>\u4f7f\u7528<strong>SFINAE</strong>\u6280\u672f\uff0c\u901a\u8fc7<strong>\u9012\u5f52\u5b9e\u4f8b\u5316arity_impl\u6a21\u677f\u6765\u63a2\u6d4b</strong>\u7ed3\u6784\u4f53\u80fd\u63a5\u53d7\u7684\u6700\u5927\u53c2\u6570\u6570\u91cf</p>\n</li>\n<li>\n<p>\u901a\u8fc7\u4e00\u4e2ainstance\u7c7b\u63d0\u4f9b<strong>\u5230\u4efb\u610f\u7c7b\u578b\u7684\u9690\u5f0f\u8f6c\u6362</strong></p>\n</li>\n</ul>\n<h3 id=\"\u6838\u5fc3\u4ee3\u7801\u5b9e\u73b0\">\u6838\u5fc3\u4ee3\u7801\u5b9e\u73b0<a class=\"headerlink\" href=\"#\u6838\u5fc3\u4ee3\u7801\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6838\u5fc3\u4ee3\u7801\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-30\">30</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"cp\">#pragma once</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;type_traits&gt;</span>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a><span class=\"k\">namespace</span><span class=\"w\"> </span><span class=\"nn\">detail</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\"></a>\n<a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\"></a><span class=\"c1\">// instance\u7c7b\u7684\u4f5c\u7528\uff1a\u5b9a\u4e49\u4e86operator\u51fd\u6570\uff0c\u63d0\u4f9b\u5230\u4efb\u610f\u7c7b\u578b\u7684\u9690\u5f0f\u8f6c\u6362\u64cd\u4f5c\u7b26\uff0c\u7528\u4e8e\u6a21\u62df\u6784\u9020Aggregate\u7c7b\u578b\u65f6\u6240\u9700\u7684\u4efb\u610f\u7c7b\u578b\u53c2\u6570</span>\n<a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">instance</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\"></a><span class=\"w\">  </span><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Type</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\"></a><span class=\"w\">  </span><span class=\"k\">operator</span><span class=\"w\"> </span><span class=\"n\">Type</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"p\">;</span>\n<a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\"></a><span class=\"p\">};</span>\n<a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\"></a>\n<a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Aggregate</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">IndexSequence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">index_sequence</span><span class=\"o\">&lt;&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\"></a><span class=\"w\">          </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">arity_impl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IndexSequence</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n<a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\"></a>\n<a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\"></a><span class=\"c1\">// \u7279\u5316\u7248\u672c</span>\n<a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Aggregate</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"kt\">size_t</span><span class=\"p\">...</span><span class=\"w\"> </span><span class=\"n\">Indices</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">arity_impl</span><span class=\"o\">&lt;</span><span class=\"n\">Aggregate</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">index_sequence</span><span class=\"o\">&lt;</span><span class=\"n\">Indices</span><span class=\"p\">...</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\"></a><span class=\"w\">                  </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">void_t</span><span class=\"o\">&lt;</span><span class=\"k\">decltype</span><span class=\"p\">(</span><span class=\"n\">Aggregate</span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\"></a><span class=\"w\">                      </span><span class=\"p\">(</span><span class=\"k\">static_cast</span><span class=\"o\">&lt;</span><span class=\"kt\">void</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">Indices</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">declval</span><span class=\"o\">&lt;</span><span class=\"n\">instance</span><span class=\"o\">&gt;</span><span class=\"p\">())...,</span>\n<a id=\"__codelineno-0-20\" name=\"__codelineno-0-20\"></a><span class=\"w\">                      </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">declval</span><span class=\"o\">&lt;</span><span class=\"n\">instance</span><span class=\"o\">&gt;</span><span class=\"p\">()})</span><span class=\"o\">&gt;&gt;</span>\n<a id=\"__codelineno-0-21\" name=\"__codelineno-0-21\"></a><span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arity_impl</span><span class=\"o\">&lt;</span><span class=\"n\">Aggregate</span><span class=\"p\">,</span>\n<a id=\"__codelineno-0-22\" name=\"__codelineno-0-22\"></a><span class=\"w\">                 </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">index_sequence</span><span class=\"o\">&lt;</span><span class=\"n\">Indices</span><span class=\"p\">...,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">...(</span><span class=\"n\">Indices</span><span class=\"p\">)</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n<a id=\"__codelineno-0-23\" name=\"__codelineno-0-23\"></a>\n<a id=\"__codelineno-0-24\" name=\"__codelineno-0-24\"></a><span class=\"p\">}</span><span class=\"w\">  </span><span class=\"c1\">// namespace detail</span>\n<a id=\"__codelineno-0-25\" name=\"__codelineno-0-25\"></a>\n<a id=\"__codelineno-0-26\" name=\"__codelineno-0-26\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-0-27\" name=\"__codelineno-0-27\"></a><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">arity</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-28\" name=\"__codelineno-0-28\"></a><span class=\"w\">  </span><span class=\"c1\">// \u4f7f\u7528decay_t\u53bb\u9664\u7c7b\u578b\u4fee\u9970\uff08\u5982const/volatile/\u5f15\u7528\uff09</span>\n<a id=\"__codelineno-0-29\" name=\"__codelineno-0-29\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">detail</span><span class=\"o\">::</span><span class=\"n\">arity_impl</span><span class=\"o\">&lt;</span><span class=\"n\">decay_t</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">().</span><span class=\"n\">size</span><span class=\"p\">();</span>\n<a id=\"__codelineno-0-30\" name=\"__codelineno-0-30\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u9996\u5148\uff0c\u5bf9\u4e0a\u9762\u7684\u4ee3\u7801\u8fdb\u884c\u62c6\u89e3\uff0c\u5206\u7ec6\u8282\u8fdb\u884c\u8ba8\u8bba\uff1a</p>\n<h4 id=\"\u7ec6\u82821-\u6784\u9020aggregate\u5bf9\u8c61\u9017\u53f7\u8868\u8fbe\u5f0f\">\u7ec6\u82821: \u6784\u9020Aggregate\u5bf9\u8c61+\u9017\u53f7\u8868\u8fbe\u5f0f<a class=\"headerlink\" href=\"#\u7ec6\u82821-\u6784\u9020aggregate\u5bf9\u8c61\u9017\u53f7\u8868\u8fbe\u5f0f\" title=\"Permanent link\">&para;</a></h4>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"n\">Aggregate</span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"k\">static_cast</span><span class=\"o\">&lt;</span><span class=\"kt\">void</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">Indices</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">declval</span><span class=\"o\">&lt;</span><span class=\"n\">instance</span><span class=\"o\">&gt;</span><span class=\"p\">())...,</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">declval</span><span class=\"o\">&lt;</span><span class=\"n\">instance</span><span class=\"o\">&gt;</span><span class=\"p\">()}</span>\n</code></pre></div></td></tr></table></div>\n\u8fd9\u6bb5\u4ee3\u7801\u5c1d\u8bd5\u6784\u9020Aggregate\u5bf9\u8c61\uff0c\u901a\u8fc7\u4e0d\u65ad\u589e\u52a0\u53c2\u6570\u6570\u91cf\u76f4\u5230\u7f16\u8bd1\u5931\u8d25\uff0c\u4ece\u800c\u786e\u5b9a\u6700\u5927\u6709\u6548\u53c2\u6570\u6570\u91cf\u3002</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"p\">(</span><span class=\"k\">static_cast</span><span class=\"o\">&lt;</span><span class=\"kt\">void</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">Indices</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">declval</span><span class=\"o\">&lt;</span><span class=\"n\">instance</span><span class=\"o\">&gt;</span><span class=\"p\">())</span>\n</code></pre></div></td></tr></table></div>\n\u8fd9\u6bb5\u4ee3\u7801\u901a\u8fc7std::declval&lt;instance&gt;()\u751f\u6210\u4e00\u4e2ainstance\u5bf9\u8c61\uff0c\u5e76\u901a\u8fc7static_cast&lt;void&gt;(Indices)\u6765\u907f\u514d\u7f16\u8bd1\u5668\u8b66\u544a\u3002\u8fd9\u91cc\u8fd8\u7528\u5230\u4e86\u4e00\u4e2a\u6280\u672f\uff0c\u5c31\u662fc++\u4e2d\u7684\u9017\u53f7\u8868\u8fbe\u5f0f\u3002</p>\n<p>C++\u4e2d\u7684\u9017\u53f7\u8868\u8fbe\u5f0f\u662f\u4e00\u79cd\u7279\u6b8a\u7684\u8fd0\u7b97\u7b26\uff0c\u5b83\u53ef\u4ee5\u5c06\u591a\u4e2a\u8868\u8fbe\u5f0f\u8fde\u63a5\u8d77\u6765\u5e76\u6309\u987a\u5e8f\u6c42\u503c\u3002\u9017\u53f7\u8868\u8fbe\u5f0f\u7684\u4e00\u822c\u5f62\u5f0f\u4e3a\uff1a\u8868\u8fbe\u5f0f1, \u8868\u8fbe\u5f0f2, &hellip;, \u8868\u8fbe\u5f0fn\u3002\u5176\u6c42\u503c\u8fc7\u7a0b\u662f\u4ece\u5de6\u5230\u53f3\u4f9d\u6b21\u8ba1\u7b97\u6bcf\u4e2a\u5b50\u8868\u8fbe\u5f0f\uff0c\u6700\u7ec8\u6574\u4e2a\u8868\u8fbe\u5f0f\u7684\u503c\u4e3a\u6700\u540e\u4e00\u4e2a\u8868\u8fbe\u5f0f\uff08\u8868\u8fbe\u5f0fn\uff09\u7684\u503c\u3002\u4f8b\u5982\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// a\u7684\u503c\u4e3a3</span>\n</code></pre></div></td></tr></table></div>\n\u7ed3\u5408\u4e0a\u9762\u7684\u4ee3\u7801\uff0c\u5c31\u53ea\u4f1a\u8f93\u5165std::declval&lt;instance&gt;()\u4f5c\u4e3a\u53c2\u6570\u6784\u9020Aggregate\u5bf9\u8c61\u3002</p>\n<p>\u53c2\u6570\u5305(Indices, instance)&hellip;\u751f\u6210N\u4e2ainstance\uff0c\u989d\u5916\u6dfb\u52a0\u7684instance\u7528\u4e8e\u63a2\u6d4b\u8fb9\u754c\u6761\u4ef6\u3002\u4e5f\u5c31\u662findices\u4e3a(0, 1)\u65f6\uff0c\u4f20\u90123\u4e2a\u53c2\u6570\uff0c\u5f53indices\u4e3a(0, 1, 2)\u65f6\uff0c\u4f20\u90124\u4e2a\u53c2\u6570\u3002</p>\n<h4 id=\"\u7ec6\u82822sfinae\u6280\u672fvoid_t\u8868\u8fbe\u5f0f\u5408\u6cd5\u6027\u68c0\u67e5\">\u7ec6\u82822\uff1aSFINAE\u6280\u672f+void_t\u8868\u8fbe\u5f0f\u5408\u6cd5\u6027\u68c0\u67e5<a class=\"headerlink\" href=\"#\u7ec6\u82822sfinae\u6280\u672fvoid_t\u8868\u8fbe\u5f0f\u5408\u6cd5\u6027\u68c0\u67e5\" title=\"Permanent link\">&para;</a></h4>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">void_t</span><span class=\"o\">&lt;</span><span class=\"k\">decltype</span><span class=\"p\">(</span><span class=\"n\">Aggregate</span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a><span class=\"w\">                      </span><span class=\"p\">(</span><span class=\"k\">static_cast</span><span class=\"o\">&lt;</span><span class=\"kt\">void</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">Indices</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">declval</span><span class=\"o\">&lt;</span><span class=\"n\">instance</span><span class=\"o\">&gt;</span><span class=\"p\">())...,</span>\n<a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\"></a><span class=\"w\">                      </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">declval</span><span class=\"o\">&lt;</span><span class=\"n\">instance</span><span class=\"o\">&gt;</span><span class=\"p\">()})</span><span class=\"o\">&gt;&gt;</span>\n</code></pre></div></td></tr></table></div>\n<p>\u8bf4\u660e\u4e00\u4e0b\u8fd9\u91ccstd::void_t\uff0cvoid_t\u901a\u5e38\u7ed3\u5408SFINAE\u6280\u672f\u8fdb\u884c\u5143\u7f16\u7a0b\u7684\u7c7b\u578b\u8bca\u65ad\u4e0e\u8868\u8fbe\u5f0f\u7684\u5408\u6cd5\u6027\u68c0\u67e5\uff0cvoid_t\u672c\u8eab\u5b9a\u4e49\u975e\u5e38\u7b80\u5355\uff0c\u5bf9\u4e8e\u4efb\u610f\u7c7b\u578b\uff0c\u4e43\u81f3\u53ef\u53d8\u7684\u53c2\u6570\u7c7b\u578b\uff0c\u90fd\u91cd\u5b9a\u4e49\u4e3avoid\u3002</p>\n<p>\u770b\u4e2a\u4f8b\u5b50\u4f60\u5c31\u660e\u767d\u4e86\uff1a</p>\n<ul>\n<li>\u68c0\u6d4b\u7c7b\u578b\u6210\u5458\u662f\u5426\u5b58\u5728\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-7\">7</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a><span class=\"c1\">// \u6cdb\u5316\u7248\u672c\uff08\u9ed8\u8ba4\u8fd4\u56de false\uff09</span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a><span class=\"k\">template</span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">has_type_member</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">false_type</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n<a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\"></a>\n<a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\"></a><span class=\"c1\">// \u7279\u5316\u7248\u672c\uff08\u5f53 T::type \u5b58\u5728\u65f6\u5339\u914d\uff09</span>\n<a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\"></a><span class=\"k\">template</span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">has_type_member</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">void_t</span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">::</span><span class=\"n\">type</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">true_type</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n</code></pre></div></td></tr></table></div></li>\n</ul>\n<p>\u82e5 T \u5305\u542b type \u6210\u5458\u7c7b\u578b\uff0c\u5219\u7279\u5316\u7248\u672c\u751f\u6548\uff0c\u8fd4\u56de true\u3002\n+ \u68c0\u6d4b\u51fd\u6570\u662f\u5426\u5b58\u5728</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-6\">6</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a><span class=\"k\">template</span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">has_hello_func</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">false_type</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n<a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\"></a>\n<a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\"></a><span class=\"k\">template</span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">has_hello_func</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">void_t</span><span class=\"o\">&lt;</span><span class=\"k\">decltype</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">declval</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">().</span><span class=\"n\">hello</span><span class=\"p\">())</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span>\n<a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\"></a><span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">true_type</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n</code></pre></div></td></tr></table></div>\n<h4 id=\"\u7ec6\u82823index_sequence\u7684\u4f7f\u7528\">\u7ec6\u82823\uff1aindex_sequence\u7684\u4f7f\u7528<a class=\"headerlink\" href=\"#\u7ec6\u82823index_sequence\u7684\u4f7f\u7528\" title=\"Permanent link\">&para;</a></h4>\n<p>std::index_sequence\u662fC++14\u5f15\u5165\u7684\u7f16\u8bd1\u671f\u6574\u6570\u5e8f\u5217\u5de5\u5177\uff0c\u4e3b\u8981\u7528\u4e8e\u6a21\u677f\u5143\u7f16\u7a0b\u4e2d\u5904\u7406\u53c2\u6570\u5305\u548c\u7d22\u5f15\u64cd\u4f5c\u3002</p>\n<p>\u4f8b\u5982\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-7-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-5\">5</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\"></a><span class=\"k\">template</span><span class=\"o\">&lt;</span><span class=\"kt\">size_t</span><span class=\"p\">...</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\"></a><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">make_squares</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">index_sequence</span><span class=\"o\">&lt;</span><span class=\"n\">I</span><span class=\"p\">...</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">array</span><span class=\"p\">{</span><span class=\"n\">I</span><span class=\"o\">*</span><span class=\"n\">I</span><span class=\"p\">...};</span>\n<a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\"></a><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">arr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">make_squares</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">make_index_sequence</span><span class=\"o\">&lt;</span><span class=\"mi\">5</span><span class=\"o\">&gt;</span><span class=\"p\">{});</span><span class=\"w\"> </span><span class=\"c1\">// {0,1,4,9,16}</span>\n</code></pre></div></td></tr></table></div></p>\n<h4 id=\"\u7ec6\u82824-\u9012\u5f52\u63a2\u6d4b\u7684\u673a\u5236\">\u7ec6\u82824: \u9012\u5f52\u63a2\u6d4b\u7684\u673a\u5236<a class=\"headerlink\" href=\"#\u7ec6\u82824-\u9012\u5f52\u63a2\u6d4b\u7684\u673a\u5236\" title=\"Permanent link\">&para;</a></h4>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-8-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-8\">8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-9\">9</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Aggregate</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"kt\">size_t</span><span class=\"p\">...</span><span class=\"w\"> </span><span class=\"n\">Indices</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">arity_impl</span><span class=\"o\">&lt;</span><span class=\"n\">Aggregate</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">index_sequence</span><span class=\"o\">&lt;</span><span class=\"n\">Indices</span><span class=\"p\">...</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\"></a><span class=\"w\">                  </span><span class=\"c1\">// \u672c\u6b21\u63a2\u6d4b\u7684\u53c2\u6570\u5217\u8868\uff0c\u7528\u4e8e\u63a2\u6d4bAggregate\u80fd\u63a5\u53d7\u7684\u53c2\u6570\u6570\u91cf\uff0c\u53c2\u6570\u6570\u91cf\u4e3asizeof...(Indices)+ 1</span>\n<a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\"></a><span class=\"w\">                  </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">void_t</span><span class=\"o\">&lt;</span><span class=\"k\">decltype</span><span class=\"p\">(</span><span class=\"n\">Aggregate</span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\"></a><span class=\"w\">                      </span><span class=\"p\">(</span><span class=\"k\">static_cast</span><span class=\"o\">&lt;</span><span class=\"kt\">void</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">Indices</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">declval</span><span class=\"o\">&lt;</span><span class=\"n\">instance</span><span class=\"o\">&gt;</span><span class=\"p\">())...,</span>\n<a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\"></a><span class=\"w\">                      </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">declval</span><span class=\"o\">&lt;</span><span class=\"n\">instance</span><span class=\"o\">&gt;</span><span class=\"p\">()})</span><span class=\"o\">&gt;&gt;</span>\n<a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\"></a><span class=\"w\">    </span><span class=\"c1\">// \u9012\u5f52\u63a2\u6d4b\uff0c\u6bcf\u6b21\u9012\u5f52\u589e\u52a0\u4e00\u4e2a\u53c2\u6570\uff0c\u589e\u52a0\u7684\u53c2\u6570\u4e3asizeof...(Indices)</span>\n<a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\"></a><span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arity_impl</span><span class=\"o\">&lt;</span><span class=\"n\">Aggregate</span><span class=\"p\">,</span>\n<a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\"></a><span class=\"w\">                 </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">index_sequence</span><span class=\"o\">&lt;</span><span class=\"n\">Indices</span><span class=\"p\">...,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">...(</span><span class=\"n\">Indices</span><span class=\"p\">)</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n</code></pre></div></td></tr></table></div>\n<p>\u9012\u5f52\u63a2\u6d4b\u673a\u5236\uff1a\n+ \u4ece\u7a7a\u53c2\u6570\u5217\u8868\u5f00\u59cb(std::index_sequence&lt;&gt;)</p>\n<ul>\n<li>\n<p>\u6bcf\u6b21\u9012\u5f52\u589e\u52a0\u4e00\u4e2a\u53c2\u6570(std::index_sequence&lt;Indices&hellip;, sizeof&hellip;(Indices)&gt;)\uff0c\u6bd4\u5982\u539f\u6765\u662f\uff1astd::index_sequence&lt;&gt;\uff0c\u4e0b\u4e00\u6b21\u9012\u5f52\u53d8\u4e3astd::index_sequence&lt;0&gt;\uff0c\u518d\u4e0b\u4e00\u6b21\u9012\u5f52\u53d8\u4e3astd::index_sequence&lt;0, 1&gt;\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002</p>\n</li>\n<li>\n<p>\u5f53\u53c2\u6570\u6570\u91cf\u8d85\u8fc7Aggregate\u7c7b\u578b\u6210\u5458\u6570\u91cf\u65f6\uff0cSFINAE\u4f7f\u7279\u5316\u7248\u672c\u5931\u6548</p>\n</li>\n</ul>\n<h3 id=\"\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u7406\u89e3\u8ba1\u7b97\u8fc7\u7a0b\">\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u7406\u89e3\u8ba1\u7b97\u8fc7\u7a0b<a class=\"headerlink\" href=\"#\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u7406\u89e3\u8ba1\u7b97\u8fc7\u7a0b\" title=\"Permanent link\">&para;</a></h3>\n<p>arity&lt;T&gt;()\u51fd\u6570\u6a21\u677f\u53ef\u4ee5\u8fd4\u56de\u4efb\u610f\u7c7b\u578bT\u7684\u6210\u5458\u6570\u91cf\uff0c\u5b8c\u5168\u5728\u7f16\u8bd1\u671f\u8ba1\u7b97\uff0c\u96f6\u8fd0\u884c\u65f6\u5f00\u9500\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-9-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-8\">8</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Point</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">};</span>\n<a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\"></a>\n<a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\"></a><span class=\"c1\">// \u5c1d\u8bd5\u6784\u9020\uff1a</span>\n<a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\"></a><span class=\"n\">Point</span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\"></a><span class=\"w\">    </span><span class=\"n\">instance</span><span class=\"p\">{},</span><span class=\"w\">  </span><span class=\"c1\">// \u5339\u914dx</span>\n<a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\"></a><span class=\"w\">    </span><span class=\"n\">instance</span><span class=\"p\">{},</span><span class=\"w\">  </span><span class=\"c1\">// \u5339\u914dy </span>\n<a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\"></a><span class=\"w\">    </span><span class=\"n\">instance</span><span class=\"p\">{}</span><span class=\"w\">   </span><span class=\"c1\">// \u89e6\u53d1SFINAE (Point\u53ea\u67092\u4e2a\u6210\u5458)</span>\n<a id=\"__codelineno-9-8\" name=\"__codelineno-9-8\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5f53\u53c2\u6570\u6570\u91cf=3\u65f6\u6784\u9020\u5931\u8d25\uff0c\u9012\u5f52\u7ec8\u6b62\uff0c\u786e\u5b9aarity=2\u3002</p>\n<p>\u4ee5\u7ed3\u6784\u4f53Point\u4e3a\u4f8b\uff0c\u9010\u6b65\u89e3\u91ca\u8fd9\u4e2a\u6a21\u677f\u7279\u5316\u7684\u6267\u884c\u8fc7\u7a0b\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u6b65, \u5c1d\u8bd5\u5339\u914d\u7279\u5316\u7248\u672c\uff08\u5e26std::void_t\u7684\u7248\u672c\uff09</li>\n</ul>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-10-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\"></a><span class=\"n\">arity_impl</span><span class=\"o\">&lt;</span><span class=\"n\">Point</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">index_sequence</span><span class=\"o\">&lt;&gt;&gt;</span>\n</code></pre></div></td></tr></table></div>\n\u6b64\u65f6Indices\u5305\u4e3a\u7a7a\uff0c\u5c1d\u8bd5\u6784\u9020\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-11-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\"></a><span class=\"n\">Point</span><span class=\"p\">{</span><span class=\"n\">instance</span><span class=\"p\">{}}</span>\n</code></pre></div></td></tr></table></div>\n\u6784\u9020\u6210\u529f\uff08\u5339\u914d1\u4e2a\u6210\u5458\uff09\uff0c\u89e6\u53d1\u9012\u5f52\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u6b21\u9012\u5f52\uff1a</li>\n</ul>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-12-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-12-1\" name=\"__codelineno-12-1\"></a><span class=\"n\">arity_impl</span><span class=\"o\">&lt;</span><span class=\"n\">Point</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">index_sequence</span><span class=\"o\">&lt;</span><span class=\"mi\">0</span><span class=\"o\">&gt;&gt;</span>\n</code></pre></div></td></tr></table></div>\n\u5c1d\u8bd5\u6784\u9020\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-13-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-13-1\" name=\"__codelineno-13-1\"></a><span class=\"n\">Point</span><span class=\"p\">{</span><span class=\"n\">instance</span><span class=\"p\">{},</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">{}}</span>\n</code></pre></div></td></tr></table></div>\n\u6784\u9020\u6210\u529f\uff08\u5339\u914d2\u4e2a\u6210\u5458\uff09, \u89e6\u53d1\u9012\u5f52</p>\n<ul>\n<li>\u7b2c\u4e8c\u6b21\u9012\u5f52\uff1a</li>\n</ul>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-14-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-14-1\" name=\"__codelineno-14-1\"></a><span class=\"n\">arity_impl</span><span class=\"o\">&lt;</span><span class=\"n\">Point</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">index_sequence</span><span class=\"o\">&lt;</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"o\">&gt;&gt;</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5c1d\u8bd5\u6784\u9020\uff1a</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-15-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-15-1\" name=\"__codelineno-15-1\"></a><span class=\"n\">Point</span><span class=\"p\">{</span><span class=\"n\">instance</span><span class=\"p\">{},</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">{},</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">{}}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u6784\u9020\u5931\u8d25\uff08\u8d85\u8fc72\u4e2a\u53c2\u6570\uff09, \u9012\u5f52\u7ec8\u6b62\u3002\n\u6700\u7ec8\u7ee7\u627farity_impl&lt;Point, std::index_sequence&lt;0,1&gt;&gt;, size()\u8fd4\u56de2\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-16-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-16-7\">7</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-16-1\" name=\"__codelineno-16-1\"></a><span class=\"n\">Point</span><span class=\"w\"> </span><span class=\"n\">p1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n<a id=\"__codelineno-16-2\" name=\"__codelineno-16-2\"></a>\n<a id=\"__codelineno-16-3\" name=\"__codelineno-16-3\"></a><span class=\"n\">Point</span><span class=\"w\"> </span><span class=\"n\">p2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"mi\">1</span><span class=\"p\">};</span>\n<a id=\"__codelineno-16-4\" name=\"__codelineno-16-4\"></a>\n<a id=\"__codelineno-16-5\" name=\"__codelineno-16-5\"></a><span class=\"n\">Point</span><span class=\"w\"> </span><span class=\"n\">p3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">};</span>\n<a id=\"__codelineno-16-6\" name=\"__codelineno-16-6\"></a>\n<a id=\"__codelineno-16-7\" name=\"__codelineno-16-7\"></a><span class=\"n\">Point</span><span class=\"w\"> </span><span class=\"n\">p4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">};</span><span class=\"w\"> </span><span class=\"c1\">// error, \u8d85\u8fc72\u4e2a\u53c2\u6570</span>\n</code></pre></div></td></tr></table></div>\n<p>\u901a\u8fc7\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u901a\u8fc7\u9012\u5f52\u63a2\u6d4b\uff0c\u53ef\u4ee5\u786e\u5b9a\u4efb\u610f\u7c7b\u578b\u7684\u6210\u5458\u6570\u91cf\u3002</p>\n<p>\u5177\u4f53\u4f7f\u7528\uff1a</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-17-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-17-5\">5</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-17-1\" name=\"__codelineno-17-1\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">(){</span>\n<a id=\"__codelineno-17-2\" name=\"__codelineno-17-2\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">nums</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">arity</span><span class=\"o\">&lt;</span><span class=\"n\">Point</span><span class=\"o\">&gt;</span><span class=\"p\">();</span>\n<a id=\"__codelineno-17-3\" name=\"__codelineno-17-3\"></a><span class=\"w\">  </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">cout</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">nums</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<a id=\"__codelineno-17-4\" name=\"__codelineno-17-4\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-17-5\" name=\"__codelineno-17-5\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n\u5b8c\u6574\u4f8b\u5b50\u53ef\u4ee5\u53c2\u8003<a href=\"https://github.com/KenForever1/cpp_idioms/blob/main/cpp/template/main.cpp\">KenForever1/cpp_idioms</a>\u3002</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/c\u5f00\u53d1\u5e38\u89c1\u95ee\u9898\u4e4babi\u517c\u5bb9\u6027\u95ee\u9898/\" target=\"_blank\">C++\u5f00\u53d1\u5e38\u89c1\u95ee\u9898\u4e4bABI\u517c\u5bb9\u6027\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u6280\u6cd5\u5982\u4f55\u4e3a\u4e00\u4e2a\u7c7b\u52a8\u6001\u9644\u52a0\u4efb\u610f\u7c7b\u578b\u6570\u636e/\" target=\"_blank\">C++\u6280\u6cd5\uff1a\u5982\u4f55\u4e3a\u4e00\u4e2a\u7c7b\u52a8\u6001\u9644\u52a0\u4efb\u610f\u7c7b\u578b\u6570\u636e</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u6280\u6cd5iguana\u5e8f\u5217\u5316\u5e93\u4e2d\u5982\u4f55\u5b9e\u73b0enum-reflection\u53cd\u5c04/\" target=\"_blank\">C++\u6280\u6cd5\uff1aiguana\u5e8f\u5217\u5316\u5e93\u4e2d\u5982\u4f55\u5b9e\u73b0enum reflection\u53cd\u5c04</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-06-29T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/c%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93cista/",
            "url": "https://github.com/KenForever1/blog/c%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93cista/",
            "title": "C++\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93cista",
            "content_html": "<h2 id=\"c\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93cista\">C++\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93cista<a class=\"headerlink\" href=\"#c\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93cista\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u9605\u8bfbCandle\uff08rust\u7684\u673a\u5668\u5b66\u4e60\u5e93\uff09\u65f6\uff0c\u770b\u5230\u4e86rust\u4e2d\u5229\u7528mmap\u548cCow\u673a\u5236\u5b9e\u73b0\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u52a0\u8f7d\u6a21\u578b\u7684tensor\u3002</p>\n<p>\u5176\u4e2d\u4e3a\u4e86\u89e3\u51b3mmap\u7684\u6570\u636e\u751f\u547d\u5468\u671f\u4e3a&rsquo;a, \u5982\u679c\u7528Cow&lt;&rsquo;a&gt;\u5f15\u7528mmap\u8fd4\u56de\u7684\u6307\u9488, \u4f7f\u7528\u7684\u751f\u547d\u5468\u671f\u5982\u679c\u8d85\u8fc7&rsquo;a\u5219\u4e0d\u80fd\u4f7f\u7528\uff0c\u4e0d\u5229\u4e8e\u4ee3\u7801\u5f00\u53d1\u548c\u5f15\u7528\u3002\u56e0\u6b64\u5f15\u5165\u4e86yoke crate\u64e6\u9664\u751f\u547d\u5468\u671f\u3002</p>\n<p>\u501f\u6b64\uff0c\u641c\u7d22\u4e86\u4e00\u4e0bc++\u7684\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93\uff0c\u627e\u5230\u4e86<a href=\"https://github.com/felixguendling/cista\">cista</a>\u3002</p>\n<!-- more -->\n\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-20\">20</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"k\">namespace</span><span class=\"w\"> </span><span class=\"nn\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nn\">cista</span><span class=\"o\">::</span><span class=\"nn\">offset</span><span class=\"p\">;</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">MODE</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\">  </span><span class=\"c1\">// opt. versioning + check sum</span>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a><span class=\"w\">    </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">mode</span><span class=\"o\">::</span><span class=\"n\">WITH_VERSION</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">mode</span><span class=\"o\">::</span><span class=\"n\">WITH_INTEGRITY</span><span class=\"p\">;</span>\n<a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\"></a>\n<a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">pos</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">};</span>\n<a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\"></a><span class=\"k\">using</span><span class=\"w\"> </span><span class=\"n\">pos_map</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\">  </span><span class=\"c1\">// Automatic deduction of hash &amp; equality</span>\n<a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\"></a><span class=\"w\">    </span><span class=\"n\">data</span><span class=\"o\">::</span><span class=\"n\">hash_map</span><span class=\"o\">&lt;</span><span class=\"n\">data</span><span class=\"o\">::</span><span class=\"n\">vector</span><span class=\"o\">&lt;</span><span class=\"n\">pos</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\"></a><span class=\"w\">                   </span><span class=\"n\">data</span><span class=\"o\">::</span><span class=\"n\">hash_set</span><span class=\"o\">&lt;</span><span class=\"n\">data</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">;</span>\n<a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\"></a>\n<a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\"></a><span class=\"p\">{</span><span class=\"w\">  </span><span class=\"c1\">// Serialize.</span>\n<a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\"></a><span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">positions</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\"></a><span class=\"w\">      </span><span class=\"n\">pos_map</span><span class=\"p\">{{{{</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">}},</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s\">&quot;hello&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;cista&quot;</span><span class=\"p\">}},</span>\n<a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\"></a><span class=\"w\">              </span><span class=\"p\">{{{</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"mi\">7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">}},</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s\">&quot;hello&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;world&quot;</span><span class=\"p\">}}};</span>\n<a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\"></a><span class=\"w\">  </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">buf</span><span class=\"w\"> </span><span class=\"n\">mmap</span><span class=\"p\">{</span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">mmap</span><span class=\"p\">{</span><span class=\"s\">&quot;data&quot;</span><span class=\"p\">}};</span>\n<a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\"></a><span class=\"w\">  </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">serialize</span><span class=\"o\">&lt;</span><span class=\"n\">MODE</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">mmap</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">positions</span><span class=\"p\">);</span>\n<a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\"></a>\n<a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\"></a><span class=\"c1\">// Deserialize.</span>\n<a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\"></a><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">mmap</span><span class=\"p\">(</span><span class=\"s\">&quot;data&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">mmap</span><span class=\"o\">::</span><span class=\"n\">protection</span><span class=\"o\">::</span><span class=\"n\">READ</span><span class=\"p\">);</span>\n<a id=\"__codelineno-0-20\" name=\"__codelineno-0-20\"></a><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">positions</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">deserialize</span><span class=\"o\">&lt;</span><span class=\"n\">pos_map</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">MODE</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5b83\u6709\u4e24\u79cd\u6a21\u5f0f\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"k\">namespace</span><span class=\"w\"> </span><span class=\"nn\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nn\">cista</span><span class=\"o\">::</span><span class=\"nn\">raw</span><span class=\"p\">;</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"n\">\u548c</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a><span class=\"k\">namespace</span><span class=\"w\"> </span><span class=\"nn\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nn\">cista</span><span class=\"o\">::</span><span class=\"nn\">offset</span><span class=\"p\">;</span>\n</code></pre></div></td></tr></table></div>\n\u5728data\u547d\u540d\u7a7a\u95f4\u4e0b\uff0c\u5b9e\u73b0\u4e86hashmap\u3001hashset\u3001string\u3001vector\u7b49\u6570\u636e\u7ed3\u6784\uff0c\u652f\u6301\u5224\u65ad\u76f8\u7b49\u3001hash\u7b49\u3002</p>\n<ul>\n<li>\n<p>\u4e3a\u4ec0\u4e48offset\u65b9\u5f0f\u76f8\u6bd4raw\u65b9\u5f0f\u901f\u5ea6\u66f4\u5feb\uff1f</p>\n</li>\n<li>\n<p>hashmap\u5982\u4f55\u5b9e\u73b0\u7684\uff1f</p>\n</li>\n</ul>\n<h2 id=\"offset\u548craw\u65b9\u5f0f\">offset\u548craw\u65b9\u5f0f<a class=\"headerlink\" href=\"#offset\u548craw\u65b9\u5f0f\" title=\"Permanent link\">&para;</a></h2>\n<p>Offset Based Data Structures</p>\n<ul>\n<li>\n<p>+ can be read without any deserialization step (i.e. reinterpret_cast<T> is sufficient).</p>\n</li>\n<li>\n<p>+ suitable for shared memory applications</p>\n</li>\n<li>\n<p>- slower at runtime (pointers need to be resolved using one more add)</p>\n</li>\n</ul>\n<p>Raw Data Structures</p>\n<ul>\n<li>\n<p>- deserialize step takes time (but still very fast also for GBs of data)</p>\n</li>\n<li>\n<p>- the buffer containing the serialized data needs to be modified</p>\n</li>\n<li>\n<p>+ fast runtime access (raw access)</p>\n</li>\n</ul>\n<p>\u6211\u4eec\u7b80\u5355\u8fc7\u4e00\u4e0b\u4ee3\u7801\u5b9e\u73b0\uff0c\u6709\u5174\u8da3\u7684\u670b\u53cb\u53ef\u4ee5\u9605\u8bfb\u6e90\u7801\uff0c\u4ee3\u7801\u5f88\u6e05\u6670\u3002</p>\n<h2 id=\"\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\">\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316<a class=\"headerlink\" href=\"#\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\" title=\"Permanent link\">&para;</a></h2>\n<p>\u96f6\u62f7\u8d1d\u4e3b\u8981\u4f7f\u7528\u4e86mmap\u65b9\u5f0f\uff0c\u5c06\u6587\u4ef6\u6620\u5c04\u5230\u8fdb\u7a0b\u5730\u5740\u7a7a\u95f4\uff0c\u76f4\u63a5\u901a\u8fc7\u6307\u9488\u8bbf\u95ee\u6587\u4ef6\u5185\u5bb9\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-29\">29</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">mode</span><span class=\"w\"> </span><span class=\"n\">Mode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">kDefaultMode</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">filesystem</span><span class=\"o\">::</span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a><span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">mmap</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a><span class=\"w\">      </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">mmap</span><span class=\"p\">{</span><span class=\"n\">p</span><span class=\"p\">.</span><span class=\"n\">generic_string</span><span class=\"p\">().</span><span class=\"n\">c_str</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">mmap</span><span class=\"o\">::</span><span class=\"n\">protection</span><span class=\"o\">::</span><span class=\"n\">WRITE</span><span class=\"p\">};</span>\n<a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\"></a><span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">writer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">buf</span><span class=\"o\">&lt;</span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">mmap</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">move</span><span class=\"p\">(</span><span class=\"n\">mmap</span><span class=\"p\">));</span>\n<a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\"></a><span class=\"w\">  </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">serialize</span><span class=\"o\">&lt;</span><span class=\"n\">Mode</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">writer</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"p\">);</span>\n<a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\"></a>\n<a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">mode</span><span class=\"w\"> </span><span class=\"n\">Mode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">kDefaultMode</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">filesystem</span><span class=\"o\">::</span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wrapped</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\"></a><span class=\"w\">  </span><span class=\"n\">write</span><span class=\"o\">&lt;</span><span class=\"n\">Mode</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">w</span><span class=\"p\">);</span>\n<a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\"></a>\n<a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mode</span><span class=\"w\"> </span><span class=\"n\">Mode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">kDefaultMode</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\"></a><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">wrapped</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">filesystem</span><span class=\"o\">::</span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\"></a><span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">file</span><span class=\"p\">{</span><span class=\"n\">p</span><span class=\"p\">.</span><span class=\"n\">generic_string</span><span class=\"p\">().</span><span class=\"n\">c_str</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"s\">&quot;r&quot;</span><span class=\"p\">}.</span><span class=\"n\">content</span><span class=\"p\">();</span>\n<a id=\"__codelineno-2-17\" name=\"__codelineno-2-17\"></a><span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">deserialize</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Mode</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">);</span>\n<a id=\"__codelineno-2-18\" name=\"__codelineno-2-18\"></a><span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">memory_holder</span><span class=\"p\">{</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">move</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">)};</span>\n<a id=\"__codelineno-2-19\" name=\"__codelineno-2-19\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">wrapped</span><span class=\"p\">{</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">move</span><span class=\"p\">(</span><span class=\"n\">mem</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">};</span>\n<a id=\"__codelineno-2-20\" name=\"__codelineno-2-20\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-2-21\" name=\"__codelineno-2-21\"></a>\n<a id=\"__codelineno-2-22\" name=\"__codelineno-2-22\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mode</span><span class=\"w\"> </span><span class=\"n\">Mode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">kDefaultMode</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-2-23\" name=\"__codelineno-2-23\"></a><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">wrapped</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">read_mmap</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">filesystem</span><span class=\"o\">::</span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-24\" name=\"__codelineno-2-24\"></a><span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">mmap</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-2-25\" name=\"__codelineno-2-25\"></a><span class=\"w\">      </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">mmap</span><span class=\"p\">{</span><span class=\"n\">p</span><span class=\"p\">.</span><span class=\"n\">generic_string</span><span class=\"p\">().</span><span class=\"n\">c_str</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">mmap</span><span class=\"o\">::</span><span class=\"n\">protection</span><span class=\"o\">::</span><span class=\"n\">READ</span><span class=\"p\">};</span>\n<a id=\"__codelineno-2-26\" name=\"__codelineno-2-26\"></a><span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">deserialize</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Mode</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">mmap</span><span class=\"p\">);</span>\n<a id=\"__codelineno-2-27\" name=\"__codelineno-2-27\"></a><span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">memory_holder</span><span class=\"p\">{</span><span class=\"n\">buf</span><span class=\"p\">{</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">move</span><span class=\"p\">(</span><span class=\"n\">mmap</span><span class=\"p\">)}};</span>\n<a id=\"__codelineno-2-28\" name=\"__codelineno-2-28\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">wrapped</span><span class=\"p\">{</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">move</span><span class=\"p\">(</span><span class=\"n\">mem</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">};</span>\n<a id=\"__codelineno-2-29\" name=\"__codelineno-2-29\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h2 id=\"hashmap\u5b9e\u73b0\">hashmap\u5b9e\u73b0<a class=\"headerlink\" href=\"#hashmap\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"swiss-table\u5b9e\u73b0\">swiss table\u5b9e\u73b0<a class=\"headerlink\" href=\"#swiss-table\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h3>\n<p>\u53c2\u8003\u4e86<a href=\"https://abseil.io/blog/20180927-swisstables\">abseil\u7684swiss tables</a>\u5b9e\u73b0\uff0c\u5728\u539f\u5148\u5b9e\u73b0\u7684\u4e0a\u5220\u9664\u4e86\u591a\u4f59\u7684\u529f\u80fd\u3002</p>\n<p>swiss table\u4ece\u7528\u6cd5\u4e0a\u5206\u4e3a\u4e24\u7c7b\uff1a</p>\n<ul>\n<li>absl::flat_hash_map and absl::flat_hash_set</li>\n</ul>\n<p>flat\u65b9\u5f0f\u5c06value_type\u5b58\u50a8\u5728\u5bb9\u5668\u7684\u4e3b\u6570\u7ec4\u4e2d\uff0c\u4ee5\u907f\u514d\u5185\u5b58\u95f4\u63a5\u5bfb\u5740\u3002\u7531\u4e8e\u5b83\u4eec\u5728\u91cd\u65b0\u54c8\u5e0c\u65f6\u4f1a\u79fb\u52a8\u6570\u636e\uff0c\u56e0\u6b64\u5143\u7d20\u65e0\u6cd5\u4fdd\u6301\u6307\u9488\u7a33\u5b9a\u6027\u3002</p>\n<p><img alt=\"\" src=\"https://abseil.io/img/flat_hash_map.svg\" /></p>\n<ul>\n<li>absl::node_hash_map and absl::node_hash_set</li>\n</ul>\n<p>\u8ffd\u6c42\u6307\u9488\u7a33\u5b9a\u6027\uff0c\u6216\u8005\u4f60\u7684\u503c\u5f88\u5927\uff0c\u5c31\u91c7\u7528node\u65b9\u5f0f\u3002</p>\n<p><img alt=\"\" src=\"https://abseil.io/img/node_hash_map.svg\" /></p>\n<p><a href=\"https://abseil.io/blog/20180927-swisstables\">blog/20180927-swisstables</a>\u4e2d\u4ecb\u7ecd\uff0c\u66f4\u63a8\u8350\u4f7f\u7528 absl::flat_hash_map&lt;K, std::unique_ptr&lt;V&gt;&gt;\u65b9\u5f0f\u66ff\u4ee3 absl::node_hash_map&lt;K, V&gt;\u3002</p>\n<h3 id=\"hash_storage\u5b9e\u73b0\">hash_storage\u5b9e\u73b0<a class=\"headerlink\" href=\"#hash_storage\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h3>\n<p>hashmap\u548chashset\u7684\u6838\u5fc3\u5b9e\u73b0\u662f<strong>hash_storage</strong> struct, hash_storage\u91c7\u7528<strong>swiss_table</strong>\u5b9e\u73b0\u3002\u5728\u540e\u9762\u7684\u6587\u7ae0\u7684\u4ecb\u7ecd\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-18\">18</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"k\">namespace</span><span class=\"w\"> </span><span class=\"nn\">raw</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Hash</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">hashing</span><span class=\"o\">&lt;</span><span class=\"n\">Key</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a><span class=\"w\">          </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">equal_to</span><span class=\"o\">&lt;</span><span class=\"n\">Key</span><span class=\"o\">&gt;&gt;</span>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a><span class=\"k\">using</span><span class=\"w\"> </span><span class=\"n\">hash_map</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\"></a><span class=\"w\">    </span><span class=\"n\">hash_storage</span><span class=\"o\">&lt;</span><span class=\"n\">pair</span><span class=\"o\">&lt;</span><span class=\"n\">Key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">get_first</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">get_second</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Hash</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"o\">&gt;</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\"></a><span class=\"p\">}</span><span class=\"w\">  </span><span class=\"c1\">// namespace raw</span>\n<a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\"></a>\n<a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\"></a><span class=\"k\">namespace</span><span class=\"w\"> </span><span class=\"nn\">offset</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Hash</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">hashing</span><span class=\"o\">&lt;</span><span class=\"n\">Key</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\"></a><span class=\"w\">          </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">equal_to</span><span class=\"o\">&lt;</span><span class=\"n\">Key</span><span class=\"o\">&gt;&gt;</span>\n<a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\"></a><span class=\"k\">using</span><span class=\"w\"> </span><span class=\"n\">hash_map</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\"></a><span class=\"w\">    </span><span class=\"n\">hash_storage</span><span class=\"o\">&lt;</span><span class=\"n\">pair</span><span class=\"o\">&lt;</span><span class=\"n\">Key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">get_first</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">get_second</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Hash</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"o\">&gt;</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\"></a><span class=\"p\">}</span><span class=\"w\">  </span><span class=\"c1\">// namespace offset</span>\n<a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\"></a>\n<a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\"></a><span class=\"k\">namespace</span><span class=\"w\"> </span><span class=\"nn\">offset</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Hash</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">hashing</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">equal_to</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;&gt;</span>\n<a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\"></a><span class=\"k\">using</span><span class=\"w\"> </span><span class=\"n\">hash_set</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">hash_storage</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">identity</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">identity</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Hash</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"o\">&gt;</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\"></a><span class=\"p\">}</span><span class=\"w\">  </span><span class=\"c1\">// namespace offset</span>\n</code></pre></div></td></tr></table></div>\n<h2 id=\"string\u7684\u5b9e\u73b0\">string\u7684\u5b9e\u73b0<a class=\"headerlink\" href=\"#string\u7684\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6839\u636estring\u7684\u5927\u5c0f\uff0c\u5206\u4e3a\u4e24\u79cd\u5b9e\u73b0\uff0c\u5c0f\u7684\u7528stack\uff0c\u5927\u7684\u7528heap, short_length_limit\u662f16\u5b57\u8282\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-22\">22</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">generate_string</span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">heap</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\"></a><span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">is_short_</span><span class=\"p\">{</span><span class=\"nb\">false</span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\"></a><span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">self_allocated_</span><span class=\"p\">{</span><span class=\"nb\">false</span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">__fill__</span><span class=\"p\">{</span><span class=\"mi\">0</span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">size_</span><span class=\"p\">{</span><span class=\"mi\">0</span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\"></a><span class=\"w\">    </span><span class=\"n\">Ptr</span><span class=\"w\"> </span><span class=\"n\">ptr_</span><span class=\"p\">{</span><span class=\"k\">nullptr</span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\"></a><span class=\"w\">  </span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\"></a>\n<a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">stack</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\"></a><span class=\"w\">    </span><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\"></a><span class=\"w\">      </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">is_short_</span><span class=\"p\">{</span><span class=\"nb\">true</span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\"></a><span class=\"w\">      </span><span class=\"n\">CharT</span><span class=\"w\"> </span><span class=\"n\">__fill__</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\"></a><span class=\"w\">    </span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\"></a><span class=\"w\">    </span><span class=\"n\">CharT</span><span class=\"w\"> </span><span class=\"n\">s_</span><span class=\"p\">[</span><span class=\"n\">short_length_limit</span><span class=\"p\">]{</span><span class=\"mi\">0</span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\"></a><span class=\"w\">  </span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\"></a>\n<a id=\"__codelineno-4-18\" name=\"__codelineno-4-18\"></a><span class=\"w\">  </span><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-19\" name=\"__codelineno-4-19\"></a><span class=\"w\">    </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"n\">h_</span><span class=\"p\">{};</span>\n<a id=\"__codelineno-4-20\" name=\"__codelineno-4-20\"></a><span class=\"w\">    </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"n\">s_</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-21\" name=\"__codelineno-4-21\"></a><span class=\"w\">  </span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-22\" name=\"__codelineno-4-22\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u5206\u4e3a\u4e24\u79cd\u60c5\u51b5\uff0cown\u548cnon_own\u3002\u4e5f\u5c31\u662f\u7ba1\u7406\u5185\u5b58\u8fd8\u662f\u4e0d\u7ba1\u7406\u5185\u5b58\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-4\">4</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a><span class=\"w\">  </span><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">owning_t</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a><span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">owning</span><span class=\"p\">{};</span>\n<a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\"></a><span class=\"w\">  </span><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">non_owning_t</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\"></a><span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">non_owning</span><span class=\"p\">{};</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5982\u679c\u8981\u4ecenon_owning\u8f6c\u6362\u6210owning\uff0c\u5219\u9700\u8981\u8c03\u7528std::memcpy\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-23\">23</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"n\">msize_t</span><span class=\"w\"> </span><span class=\"n\">short_length_limit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">15U</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">CharT</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\"></a>\n<a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">set_owning</span><span class=\"p\">(</span><span class=\"n\">CharT</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">msize_t</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\"></a><span class=\"w\">    </span><span class=\"n\">reset</span><span class=\"p\">();</span>\n<a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0U</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\"></a><span class=\"w\">    </span><span class=\"n\">s_</span><span class=\"p\">.</span><span class=\"n\">is_short_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">short_length_limit</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">s_</span><span class=\"p\">.</span><span class=\"n\">is_short_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">memcpy</span><span class=\"p\">(</span><span class=\"n\">s_</span><span class=\"p\">.</span><span class=\"n\">s_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">CharT</span><span class=\"p\">));</span>\n<a id=\"__codelineno-6-11\" name=\"__codelineno-6-11\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">short_length_limit</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"n\">i</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-12\" name=\"__codelineno-6-12\"></a><span class=\"w\">        </span><span class=\"n\">s_</span><span class=\"p\">.</span><span class=\"n\">s_</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-13\" name=\"__codelineno-6-13\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-14\" name=\"__codelineno-6-14\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-15\" name=\"__codelineno-6-15\"></a><span class=\"w\">    </span><span class=\"n\">h_</span><span class=\"p\">.</span><span class=\"n\">ptr_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">static_cast</span><span class=\"o\">&lt;</span><span class=\"n\">CharT</span><span class=\"o\">*&gt;</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">CharT</span><span class=\"p\">)));</span>\n<a id=\"__codelineno-6-16\" name=\"__codelineno-6-16\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">h_</span><span class=\"p\">.</span><span class=\"n\">ptr_</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-17\" name=\"__codelineno-6-17\"></a><span class=\"w\">        </span><span class=\"n\">throw_exception</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">bad_alloc</span><span class=\"p\">{});</span>\n<a id=\"__codelineno-6-18\" name=\"__codelineno-6-18\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-19\" name=\"__codelineno-6-19\"></a><span class=\"w\">    </span><span class=\"n\">h_</span><span class=\"p\">.</span><span class=\"n\">size_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-20\" name=\"__codelineno-6-20\"></a><span class=\"w\">    </span><span class=\"n\">h_</span><span class=\"p\">.</span><span class=\"n\">self_allocated_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-21\" name=\"__codelineno-6-21\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">memcpy</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">CharT</span><span class=\"p\">));</span>\n<a id=\"__codelineno-6-22\" name=\"__codelineno-6-22\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-23\" name=\"__codelineno-6-23\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h2 id=\"\u5176\u5b83\u5e8f\u5217\u5316\u5e93\">\u5176\u5b83\u5e8f\u5217\u5316\u5e93<a class=\"headerlink\" href=\"#\u5176\u5b83\u5e8f\u5217\u5316\u5e93\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li>\n<p>Protocol Buffers</p>\n</li>\n<li>\n<p>Cap\u2019n Proto</p>\n</li>\n<li>\n<p><a href=\"https://flatbuffers.dev/languages/rust/\">Flatbuffers</a></p>\n</li>\n<li>\n<p>cereal</p>\n</li>\n<li>\n<p>Boost Serialization</p>\n</li>\n<li>\n<p>MessagePack</p>\n</li>\n</ul>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/cista\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93\u5b9e\u73b0\u4e4bswiss_table\u54c8\u5e0c\u8868\u5b9e\u73b0/\" target=\"_blank\">cista\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93\u5b9e\u73b0\u4e4bswiss_table\u54c8\u5e0c\u8868\u5b9e\u73b0</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u5f00\u53d1\u5e38\u89c1\u95ee\u9898\u4e4babi\u517c\u5bb9\u6027\u95ee\u9898/\" target=\"_blank\">C++\u5f00\u53d1\u5e38\u89c1\u95ee\u9898\u4e4bABI\u517c\u5bb9\u6027\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/fast-pimpl-\u53c8\u662f\u4ec0\u4e48\u6280\u6cd5/\" target=\"_blank\">Fast PIMPL \u53c8\u662f\u4ec0\u4e48\u6280\u6cd5\uff1f</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-06-28T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/cista%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93%E5%AE%9E%E7%8E%B0%E4%B9%8Bswiss_table--group%E5%8C%B9%E9%85%8D%E4%BD%8D%E8%BF%90%E7%AE%97/",
            "url": "https://github.com/KenForever1/blog/cista%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93%E5%AE%9E%E7%8E%B0%E4%B9%8Bswiss_table--group%E5%8C%B9%E9%85%8D%E4%BD%8D%E8%BF%90%E7%AE%97/",
            "title": "cista\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93\u5b9e\u73b0\u4e4bswiss_table--group\u5339\u914d\u4f4d\u8fd0\u7b97",
            "content_html": "<h2 id=\"swiss-table\u4e2dgroup\u7684\u5b9e\u73b0\u89e3\u6790\">Swiss Table\u4e2dGroup\u7684\u5b9e\u73b0\u89e3\u6790<a class=\"headerlink\" href=\"#swiss-table\u4e2dgroup\u7684\u5b9e\u73b0\u89e3\u6790\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u4e2a<code>group</code>\u7ed3\u6784\u4f53\u662fSwiss Table\u5b9e\u73b0\u4e2d\u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u7528\u4e8e\u9ad8\u6548\u5904\u7406\u54c8\u5e0c\u8868\u63a7\u5236\u4f4d\u7684\u6279\u91cf\u64cd\u4f5c\u3002</p>\n<!-- more -->\n\n<p>\u5b9a\u4e49\u6838\u5fc3\u5e38\u91cf\uff0c\u7528\u4e8e\u4f4d\u8fd0\u7b97\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">MSBS</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x8080808080808080ULL</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// \u6bcf\u4e2a\u5b57\u8282\u7684\u6700\u9ad8\u4f4d\u63a9\u7801</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">LSBS</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x0101010101010101ULL</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// \u6bcf\u4e2a\u5b57\u8282\u7684\u6700\u4f4e\u4f4d\u63a9\u7801</span>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">GAPS</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x00FEFEFEFEFEFEFEULL</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// \u7528\u4e8e\u8ba1\u7b97\u524d\u5bfc\u7a7a\u4f4d\u7684\u63a9\u7801</span>\n</code></pre></div></td></tr></table></div>\n\u6784\u9020\u51fd\u6570\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-8\">8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-9\">9</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"k\">using</span><span class=\"w\"> </span><span class=\"n\">group_t</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"kt\">uint64_t</span><span class=\"p\">;</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"k\">using</span><span class=\"w\"> </span><span class=\"n\">h2_t</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"kt\">uint8_t</span><span class=\"p\">;</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a>\n<a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\"></a><span class=\"k\">explicit</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"p\">(</span><span class=\"n\">ctrl_t</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\"></a><span class=\"w\">  </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">memcpy</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">ctrl_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WIDTH</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\"></a><span class=\"cp\">#if defined(CISTA_BIG_ENDIAN)</span>\n<a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\"></a><span class=\"w\">  </span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">endian_swap</span><span class=\"p\">(</span><span class=\"n\">ctrl_</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\"></a><span class=\"cp\">#endif</span>\n<a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n* \u4ece\u6307\u5b9a\u4f4d\u7f6e\u62f7\u8d1d8\u4e2a\u63a7\u5236\u5b57\u8282\u5230<code>ctrl_</code>\u6210\u5458\n* \u5927\u7aef\u7cfb\u7edf\u9700\u8981\u505a\u5b57\u8282\u5e8f\u8f6c\u6362</p>\n<h2 id=\"\u5173\u952e\u5339\u914d\u65b9\u6cd5\">\u5173\u952e\u5339\u914d\u65b9\u6cd5<a class=\"headerlink\" href=\"#\u5173\u952e\u5339\u914d\u65b9\u6cd5\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"match\u65b9\u6cd5---\u5339\u914d\u7279\u5b9ah2\u503c\"><code>match</code>\u65b9\u6cd5 - \u5339\u914d\u7279\u5b9ah2\u503c<a class=\"headerlink\" href=\"#match\u65b9\u6cd5---\u5339\u914d\u7279\u5b9ah2\u503c\" title=\"Permanent link\">&para;</a></h3>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-4\">4</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"n\">bit_mask</span><span class=\"w\"> </span><span class=\"nf\">match</span><span class=\"p\">(</span><span class=\"n\">h2_t</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">hash</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a><span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">^</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">LSBS</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">hash</span><span class=\"p\">);</span>\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">bit_mask</span><span class=\"p\">{(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">LSBS</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">MSBS</span><span class=\"p\">};</span>\n<a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n* \u901a\u8fc7\u4f4d\u8fd0\u7b97\u540c\u65f6\u68c0\u67e58\u4e2a\u63a7\u5236\u5b57\u8282\u662f\u5426\u5339\u914d\u7ed9\u5b9a\u7684h2\u503c\n* \u7b97\u6cd5\u539f\u7406\uff1a\n  1. <code>LSBS * hash</code>\uff1a\u5c06h2\u503c\u590d\u5236\u5230\u6bcf\u4e2a\u5b57\u8282\n  2. <code>ctrl_ ^ ...</code>\uff1a\u5f02\u6216\u64cd\u4f5c\u627e\u51fa\u5339\u914d\u7684\u5b57\u8282\n  3. <code>(x - LSBS) &amp; ~x &amp; MSBS</code>\uff1a\u7cbe\u786e\u5b9a\u4f4d\u5339\u914d\u7684\u5b57\u8282</p>\n<h4 id=\"\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u6765\u7406\u89e3match\">\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u6765\u7406\u89e3<code>match</code>\uff1a<a class=\"headerlink\" href=\"#\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u6765\u7406\u89e3match\" title=\"Permanent link\">&para;</a></h4>\n<p>\u76f8\u5173\u4f8b\u5b50\u5b9e\u73b0\u6e90\u7801<a href=\"https://github.com/KenForever1/cpp_idioms/blob/main/cpp/swiss_table/bit_verify_match.cpp\">KenForever1/cpp_idioms</a>\u3002</p>\n<p>\u8ba9\u6211\u4eec\u901a\u8fc7\u4e00\u4e2a\u5177\u4f53\u4f8b\u5b50\u6765\u8bf4\u660ematch\u65b9\u6cd5\u7684\u4f4d\u8fd0\u7b97\u8fc7\u7a0b\u3002\u5047\u8bbe\uff1a</p>\n<p>\u5f53\u524dgroup\u76848\u4e2a\u63a7\u5236\u5b57\u8282\u4e3a\uff1a[0x12, 0x34, 0x56, 0x78, 0x12, 0x9A, EMPTY, DELETED]</p>\n<p>\u5bf9\u5e94ctrl_\u503c\uff1a0xFE80129A78563412 (\u5c0f\u7aef\u5e8f)</p>\n<p>EMPTY = 0x80, DELETED = 0xFE</p>\n<p>\u8981\u5339\u914d\u7684h2\u503c\u4e3a\uff1a0x12</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-13\">13</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"o\">===</span><span class=\"w\"> </span><span class=\"n\">\u5f00\u59cb\u5339\u914d\u8fc7\u7a0b</span><span class=\"w\"> </span><span class=\"o\">===</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a><span class=\"n\">\u63a7\u5236\u5b57\u8282</span><span class=\"p\">(</span><span class=\"n\">ctrl_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0xff809a1278563412</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span><span class=\"mh\">0x34</span><span class=\"w\"> </span><span class=\"mh\">0x56</span><span class=\"w\"> </span><span class=\"mh\">0x78</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span><span class=\"mh\">0x9a</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a><span class=\"nl\">\u5339\u914d\u7684h2\u503c</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x12</span>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a><span class=\"n\">LSBS</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">hash</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x1212121212121212</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span>\n<a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\"></a><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">^</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">LSBS</span><span class=\"o\">*</span><span class=\"n\">hash</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0xed9288006a442600</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x26</span><span class=\"w\"> </span><span class=\"mh\">0x44</span><span class=\"w\"> </span><span class=\"mh\">0x6a</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x88</span><span class=\"w\"> </span><span class=\"mh\">0x92</span><span class=\"w\"> </span><span class=\"mh\">0xed</span><span class=\"w\"> </span>\n<a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\"></a><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">LSBS</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0xec9186ff694324ff</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0x24</span><span class=\"w\"> </span><span class=\"mh\">0x43</span><span class=\"w\"> </span><span class=\"mh\">0x69</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0x86</span><span class=\"w\"> </span><span class=\"mh\">0x91</span><span class=\"w\"> </span><span class=\"mh\">0xec</span><span class=\"w\"> </span>\n<a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\"></a><span class=\"o\">~</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x126d77ff95bbd9ff</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xd9</span><span class=\"w\"> </span><span class=\"mh\">0xbb</span><span class=\"w\"> </span><span class=\"mh\">0x95</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0x77</span><span class=\"w\"> </span><span class=\"mh\">0x6d</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span>\n<a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\"></a><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">LSBS</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x000106ff010300ff</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x03</span><span class=\"w\"> </span><span class=\"mh\">0x01</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0x06</span><span class=\"w\"> </span><span class=\"mh\">0x01</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\"></a><span class=\"n\">\u6700\u7ec8\u7ed3\u679c</span><span class=\"w\"> </span><span class=\"n\">mask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x0000008000000080</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\"></a>\n<a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\"></a><span class=\"o\">===</span><span class=\"w\"> </span><span class=\"n\">\u5339\u914d\u7ed3\u679c</span><span class=\"w\"> </span><span class=\"o\">===</span>\n<a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\"></a><span class=\"n\">\u5339\u914d\u63a9\u7801</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x0000008000000080</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\"></a><span class=\"nl\">\u5339\u914d\u7684\u5b57\u8282\u4f4d\u7f6e</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"match_empty\u65b9\u6cd5---\u5339\u914d\u7a7a\u69fd\u4f4d\"><code>match_empty</code>\u65b9\u6cd5 - \u5339\u914d\u7a7a\u69fd\u4f4d<a class=\"headerlink\" href=\"#match_empty\u65b9\u6cd5---\u5339\u914d\u7a7a\u69fd\u4f4d\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a><span class=\"n\">bit_mask</span><span class=\"w\"> </span><span class=\"nf\">match_empty</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">bit_mask</span><span class=\"p\">{(</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">~</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"mi\">6U</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">MSBS</span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<ul>\n<li>\n<p>\u901a\u8fc7\u4f4d\u8fd0\u7b97\u627e\u51faEMPTY(-128)\u63a7\u5236\u5b57\u8282</p>\n</li>\n<li>\n<p>\u5229\u7528\u4e86EMPTY\u7684\u7279\u6b8a\u4f4d\u6a21\u5f0f(10000000)</p>\n</li>\n</ul>\n<h4 id=\"\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u6765\u7406\u89e3match_empty\">\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u6765\u7406\u89e3<code>match_empty</code><a class=\"headerlink\" href=\"#\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u6765\u7406\u89e3match_empty\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5047\u8bbe\u6211\u4eec\u6709\u4ee5\u4e0b\u63a7\u5236\u5b57\u8282\u7ec4\uff08\u5c0f\u7aef\u5e8f\u6392\u5217\uff09\uff1a\n[0x12, 0x34, EMPTY, 0x56, DELETED, EMPTY, 0x78, END]</p>\n<p>EMPTY = 0x80</p>\n<p>DELETED = 0xFE</p>\n<p>END = 0xFF</p>\n<p>\u5bf9\u5e94\u7684 64 \u4f4d ctrl_ \u503c\u4e3a\uff1a0xFF8078FE56803412</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-8\">8</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a><span class=\"o\">===</span><span class=\"w\"> </span><span class=\"n\">match_empty</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"n\">\u793a\u4f8b</span><span class=\"w\"> </span><span class=\"o\">===</span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a><span class=\"n\">\u539f\u59cb\u63a7\u5236\u5b57\u8282</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0xff7880fe56803412</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span><span class=\"mh\">0x34</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x56</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x78</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span>\n<a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\"></a><span class=\"o\">~</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x00877f01a97fcbed</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0xed</span><span class=\"w\"> </span><span class=\"mh\">0xcb</span><span class=\"w\"> </span><span class=\"mh\">0x7f</span><span class=\"w\"> </span><span class=\"mh\">0xa9</span><span class=\"w\"> </span><span class=\"mh\">0x01</span><span class=\"w\"> </span><span class=\"mh\">0x7f</span><span class=\"w\"> </span><span class=\"mh\">0x87</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\"></a><span class=\"o\">~</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x21dfc06a5ff2fb40</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x40</span><span class=\"w\"> </span><span class=\"mh\">0xfb</span><span class=\"w\"> </span><span class=\"mh\">0xf2</span><span class=\"w\"> </span><span class=\"mh\">0x5f</span><span class=\"w\"> </span><span class=\"mh\">0x6a</span><span class=\"w\"> </span><span class=\"mh\">0xc0</span><span class=\"w\"> </span><span class=\"mh\">0xdf</span><span class=\"w\"> </span><span class=\"mh\">0x21</span><span class=\"w\"> </span>\n<a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\"></a><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">~</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x2158806a56803000</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x30</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x56</span><span class=\"w\"> </span><span class=\"mh\">0x6a</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x58</span><span class=\"w\"> </span><span class=\"mh\">0x21</span><span class=\"w\"> </span>\n<a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\"></a><span class=\"n\">\u6700\u7ec8\u7ed3\u679c</span><span class=\"w\"> </span><span class=\"n\">mask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x0000800000800000</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\"></a>\n<a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\"></a><span class=\"nl\">\u5339\u914d\u7684EMPTY\u4f4d\u7f6e</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"match_empty_or_deleted\u65b9\u6cd5\"><code>match_empty_or_deleted</code>\u65b9\u6cd5<a class=\"headerlink\" href=\"#match_empty_or_deleted\u65b9\u6cd5\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a><span class=\"n\">bit_mask</span><span class=\"w\"> </span><span class=\"nf\">match_empty_or_deleted</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">bit_mask</span><span class=\"p\">{(</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">~</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"mi\">7U</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">MSBS</span><span class=\"p\">};</span>\n<a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<ul>\n<li>\n<p>\u7c7b\u4f3c<code>match_empty</code>\u4f46\u5339\u914dEMPTY\u6216DELETED\u72b6\u6001</p>\n</li>\n<li>\n<p>\u5229\u7528\u4e86\u8fd9\u4e24\u79cd\u72b6\u6001\u7684\u9ad8\u4f4d\u90fd\u662f1\u7684\u7279\u6027</p>\n</li>\n</ul>\n<h4 id=\"\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u6765\u7406\u89e3match_empty_or_deleted\">\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u6765\u7406\u89e3<code>match_empty_or_deleted</code><a class=\"headerlink\" href=\"#\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u6765\u7406\u89e3match_empty_or_deleted\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5047\u8bbe\u6211\u4eec\u6709\u4ee5\u4e0b\u63a7\u5236\u5b57\u8282\u7ec4\uff08\u5c0f\u7aef\u5e8f\u6392\u5217\uff09\uff1a\n[0x12, 0x34, EMPTY, 0x56, DELETED, EMPTY, 0x78, END]</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-7-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-8\">8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-9\">9</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\"></a><span class=\"nl\">shift_pos</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">7</span>\n<a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\"></a><span class=\"o\">===</span><span class=\"w\"> </span><span class=\"n\">match_empty</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"n\">\u793a\u4f8b</span><span class=\"w\"> </span><span class=\"o\">===</span>\n<a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\"></a><span class=\"n\">\u539f\u59cb\u63a7\u5236\u5b57\u8282</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0xff7880fe56803412</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span><span class=\"mh\">0x34</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x56</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x78</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span>\n<a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\"></a><span class=\"o\">~</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x00877f01a97fcbed</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0xed</span><span class=\"w\"> </span><span class=\"mh\">0xcb</span><span class=\"w\"> </span><span class=\"mh\">0x7f</span><span class=\"w\"> </span><span class=\"mh\">0xa9</span><span class=\"w\"> </span><span class=\"mh\">0x01</span><span class=\"w\"> </span><span class=\"mh\">0x7f</span><span class=\"w\"> </span><span class=\"mh\">0x87</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\"></a><span class=\"o\">~</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">$shift_pos$</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x43bf80d4bfe5f680</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0xf6</span><span class=\"w\"> </span><span class=\"mh\">0xe5</span><span class=\"w\"> </span><span class=\"mh\">0xbf</span><span class=\"w\"> </span><span class=\"mh\">0xd4</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0xbf</span><span class=\"w\"> </span><span class=\"mh\">0x43</span><span class=\"w\"> </span>\n<a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\"></a><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">~</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">$shift_pos$</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x433880d416803400</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x34</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x16</span><span class=\"w\"> </span><span class=\"mh\">0xd4</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x38</span><span class=\"w\"> </span><span class=\"mh\">0x43</span><span class=\"w\"> </span>\n<a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\"></a><span class=\"n\">\u6700\u7ec8\u7ed3\u679c</span><span class=\"w\"> </span><span class=\"n\">mask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x0000808000800000</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\"></a>\n<a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\"></a><span class=\"nl\">\u5339\u914d\u7684EMPTY\u4f4d\u7f6e</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"count_leading_empty_or_deleted\u65b9\u6cd5\"><code>count_leading_empty_or_deleted</code>\u65b9\u6cd5<a class=\"headerlink\" href=\"#count_leading_empty_or_deleted\u65b9\u6cd5\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-8-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"nf\">count_leading_empty_or_deleted</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">trailing_zeros</span><span class=\"p\">(((</span><span class=\"o\">~</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">7U</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">GAPS</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1U</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">7U</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">3U</span><span class=\"p\">;</span>\n<a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<ul>\n<li>\n<p>\u8ba1\u7b97\u524d\u5bfc\u7684EMPTY\u6216DELETED\u69fd\u4f4d\u6570\u91cf</p>\n</li>\n<li>\n<p>\u7528\u4e8e\u63a2\u6d4b\u5e8f\u5217\u4e2d\u5feb\u901f\u8df3\u8fc7\u8fde\u7eed\u65e0\u6548\u69fd\u4f4d</p>\n</li>\n</ul>\n<p>\u4f7f\u7528\u65b9\u6cd5\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-9-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-7\">7</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">skip_empty_or_deleted</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\"></a><span class=\"w\">    </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_empty_or_deleted</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">ctrl_</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\"></a><span class=\"w\">        </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">shift</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"p\">{</span><span class=\"n\">ctrl_</span><span class=\"p\">}.</span><span class=\"n\">count_leading_empty_or_deleted</span><span class=\"p\">();</span>\n<a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\"></a><span class=\"w\">        </span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"n\">shift</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\"></a><span class=\"w\">        </span><span class=\"n\">entry_</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"n\">shift</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-10-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-19\">19</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\"></a><span class=\"o\">===</span><span class=\"w\"> </span><span class=\"n\">\u793a\u4f8b1</span><span class=\"w\"> </span><span class=\"o\">===</span>\n<a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\"></a><span class=\"n\">\u539f\u59cb\u63a7\u5236\u5b57\u8282</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0xff788056fe803412</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x12</span><span class=\"w\"> </span><span class=\"mh\">0x34</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0x56</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x78</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span>\n<a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\"></a><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x01fef100adfd0068</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x68</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0xfd</span><span class=\"w\"> </span><span class=\"mh\">0xad</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0xf1</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0x01</span><span class=\"w\"> </span>\n<a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\"></a><span class=\"o\">~</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x00877fa9017fcbed</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0xed</span><span class=\"w\"> </span><span class=\"mh\">0xcb</span><span class=\"w\"> </span><span class=\"mh\">0x7f</span><span class=\"w\"> </span><span class=\"mh\">0x01</span><span class=\"w\"> </span><span class=\"mh\">0xa9</span><span class=\"w\"> </span><span class=\"mh\">0x7f</span><span class=\"w\"> </span><span class=\"mh\">0x87</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-10-5\" name=\"__codelineno-10-5\"></a><span class=\"o\">~</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x00867100017d0068</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x68</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x7d</span><span class=\"w\"> </span><span class=\"mh\">0x01</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x71</span><span class=\"w\"> </span><span class=\"mh\">0x86</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-10-6\" name=\"__codelineno-10-6\"></a><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">GAPS</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x00fefffefffffefe</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-10-7\" name=\"__codelineno-10-7\"></a><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x00fefffefffffeff</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-10-8\" name=\"__codelineno-10-8\"></a><span class=\"nl\">trailing_zeros</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<a id=\"__codelineno-10-9\" name=\"__codelineno-10-9\"></a><span class=\"n\">\u524d\u5bfcEMPTY</span><span class=\"o\">/</span><span class=\"n\">DELETED\u6570\u91cf</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<a id=\"__codelineno-10-10\" name=\"__codelineno-10-10\"></a>\n<a id=\"__codelineno-10-11\" name=\"__codelineno-10-11\"></a><span class=\"o\">===</span><span class=\"w\"> </span><span class=\"n\">\u793a\u4f8b2</span><span class=\"w\"> </span><span class=\"o\">===</span>\n<a id=\"__codelineno-10-12\" name=\"__codelineno-10-12\"></a><span class=\"n\">\u539f\u59cb\u63a7\u5236\u5b57\u8282</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0xffbc9a785680fe80</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0x80</span><span class=\"w\"> </span><span class=\"mh\">0x56</span><span class=\"w\"> </span><span class=\"mh\">0x78</span><span class=\"w\"> </span><span class=\"mh\">0x9a</span><span class=\"w\"> </span><span class=\"mh\">0xbc</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span>\n<a id=\"__codelineno-10-13\" name=\"__codelineno-10-13\"></a><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x01ff7934f0ad01fd</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0xfd</span><span class=\"w\"> </span><span class=\"mh\">0x01</span><span class=\"w\"> </span><span class=\"mh\">0xad</span><span class=\"w\"> </span><span class=\"mh\">0xf0</span><span class=\"w\"> </span><span class=\"mh\">0x34</span><span class=\"w\"> </span><span class=\"mh\">0x79</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0x01</span><span class=\"w\"> </span>\n<a id=\"__codelineno-10-14\" name=\"__codelineno-10-14\"></a><span class=\"o\">~</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x00436587a97f017f</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x7f</span><span class=\"w\"> </span><span class=\"mh\">0x01</span><span class=\"w\"> </span><span class=\"mh\">0x7f</span><span class=\"w\"> </span><span class=\"mh\">0xa9</span><span class=\"w\"> </span><span class=\"mh\">0x87</span><span class=\"w\"> </span><span class=\"mh\">0x65</span><span class=\"w\"> </span><span class=\"mh\">0x43</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-10-15\" name=\"__codelineno-10-15\"></a><span class=\"o\">~</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x00436104a02d017d</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x7d</span><span class=\"w\"> </span><span class=\"mh\">0x01</span><span class=\"w\"> </span><span class=\"mh\">0x2d</span><span class=\"w\"> </span><span class=\"mh\">0xa0</span><span class=\"w\"> </span><span class=\"mh\">0x04</span><span class=\"w\"> </span><span class=\"mh\">0x61</span><span class=\"w\"> </span><span class=\"mh\">0x43</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-10-16\" name=\"__codelineno-10-16\"></a><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">GAPS</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x00fffffefeffffff</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-10-17\" name=\"__codelineno-10-17\"></a><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x00fffffeff000000</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xfe</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0xff</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"w\"> </span>\n<a id=\"__codelineno-10-18\" name=\"__codelineno-10-18\"></a><span class=\"nl\">trailing_zeros</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">24</span>\n<a id=\"__codelineno-10-19\" name=\"__codelineno-10-19\"></a><span class=\"n\">\u524d\u5bfcEMPTY</span><span class=\"o\">/</span><span class=\"n\">DELETED\u6570\u91cf</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n</code></pre></div></td></tr></table></div>\n\u53ef\u4ee5\u770b\u5230\uff0c\u4e3a\u4e86\u91c7\u7528\u4f4d\u8fd0\u7b97\uff0c\u52a0\u5feb\u8ba1\u7b97\u901f\u5ea6\uff0c\u5728\u63a7\u5236\u5b57\u8282\u4e2d\uff0cEMPTY = 0x80\uff0cDELETED = 0xFE\uff0cEND = 0xFF\u7684\u6570\u503c\u90fd\u662f\u7ecf\u8fc7\u7279\u6b8a\u8bbe\u8ba1\u7684\u3002</p>\n<h3 id=\"bit_mask\u7ed3\u6784\u89e3\u6790\">bit_mask\u7ed3\u6784\u89e3\u6790<a class=\"headerlink\" href=\"#bit_mask\u7ed3\u6784\u89e3\u6790\" title=\"Permanent link\">&para;</a></h3>\n<p><code>bit_mask</code>\u662fSwiss Table\u4e2d\u7528\u4e8e\u9ad8\u6548\u5904\u7406\u4f4d\u63a9\u7801\u7684\u8f85\u52a9\u7ed3\u6784\uff0c\u4e3b\u8981\u529f\u80fd\u662f\u8fed\u4ee3\u548c\u64cd\u4f5c64\u4f4d\u63a9\u7801\u4e2d\u7684\u5339\u914d\u4f4d\u3002</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-11-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\"></a><span class=\"n\">group_t</span><span class=\"w\"> </span><span class=\"n\">mask_</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// 64\u4f4d\u63a9\u7801\uff0c\u6bcf\u4e2a\u5b57\u8282\u4ee3\u8868\u4e00\u4e2a\u63a7\u5236\u5b57\u8282\u7684\u72b6\u6001</span>\n<a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">SHIFT</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">3U</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// \u7528\u4e8e\u5b57\u8282\u7d22\u5f15\u4f4d\u79fb(8=2^3)</span>\n</code></pre></div></td></tr></table></div>\n\u8fed\u4ee3\u5668\u548c\u63a9\u7801\u64cd\u4f5c\uff0c\u5b9e\u73b0\u4e86\u7c7b\u4f3c\u8fed\u4ee3\u5668\u7684\u63a5\u53e3\uff0c\u53ef\u4ee5\u5728\u8303\u56f4for\u5faa\u73af\u4e2d\u4f7f\u7528\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-12-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-12-15\">15</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-12-1\" name=\"__codelineno-12-1\"></a><span class=\"n\">bit_mask</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"k\">operator</span><span class=\"o\">++</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-12-2\" name=\"__codelineno-12-2\"></a><span class=\"w\">  </span><span class=\"n\">mask_</span><span class=\"w\"> </span><span class=\"o\">&amp;=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">mask_</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1U</span><span class=\"p\">);</span><span class=\"w\">  </span><span class=\"c1\">// \u6e05\u9664\u6700\u4f4e\u4f4d\u76841</span>\n<a id=\"__codelineno-12-3\" name=\"__codelineno-12-3\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">this</span><span class=\"p\">;</span>\n<a id=\"__codelineno-12-4\" name=\"__codelineno-12-4\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-12-5\" name=\"__codelineno-12-5\"></a>\n<a id=\"__codelineno-12-6\" name=\"__codelineno-12-6\"></a><span class=\"n\">size_type</span><span class=\"w\"> </span><span class=\"k\">operator</span><span class=\"o\">*</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span>\n<a id=\"__codelineno-12-7\" name=\"__codelineno-12-7\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">trailing_zeros</span><span class=\"p\">();</span><span class=\"w\">  </span><span class=\"c1\">// \u8fd4\u56de\u5f53\u524d\u6700\u4f4e\u4f4d1\u7684\u5b57\u8282\u4f4d\u7f6e</span>\n<a id=\"__codelineno-12-8\" name=\"__codelineno-12-8\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-12-9\" name=\"__codelineno-12-9\"></a>\n<a id=\"__codelineno-12-10\" name=\"__codelineno-12-10\"></a><span class=\"k\">explicit</span><span class=\"w\"> </span><span class=\"k\">operator</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span>\n<a id=\"__codelineno-12-11\" name=\"__codelineno-12-11\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">mask_</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0U</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// \u5224\u65ad\u662f\u5426\u6709\u5339\u914d</span>\n<a id=\"__codelineno-12-12\" name=\"__codelineno-12-12\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-12-13\" name=\"__codelineno-12-13\"></a>\n<a id=\"__codelineno-12-14\" name=\"__codelineno-12-14\"></a><span class=\"n\">bit_mask</span><span class=\"w\"> </span><span class=\"n\">begin</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">this</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<a id=\"__codelineno-12-15\" name=\"__codelineno-12-15\"></a><span class=\"n\">bit_mask</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">bit_mask</span><span class=\"p\">{</span><span class=\"mi\">0</span><span class=\"p\">};</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"\u4f4d\u64cd\u4f5c\">\u4f4d\u64cd\u4f5c<a class=\"headerlink\" href=\"#\u4f4d\u64cd\u4f5c\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li>\n<p><code>trailing_zeros</code>: \u8ba1\u7b97\u6700\u4f4e\u4f4d1\u7684\u4f4d\u7f6e(\u4ee5\u5b57\u8282\u4e3a\u5355\u4f4d)</p>\n</li>\n<li>\n<p><code>leading_zeros</code>: \u8ba1\u7b97\u6700\u9ad8\u4f4d1\u7684\u4f4d\u7f6e(\u4ee5\u5b57\u8282\u4e3a\u5355\u4f4d)</p>\n</li>\n<li>\n<p>\u90fd\u4f7f\u7528\u4e86\u4f4d\u8fd0\u7b97\u4f18\u5316\uff0c\u901a\u8fc7\u4f4d\u79fb\u8f6c\u6362\u4f4d\u7d22\u5f15\u5230\u5b57\u8282\u7d22\u5f15</p>\n</li>\n</ul>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-13-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-13-15\">15</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-13-1\" name=\"__codelineno-13-1\"></a><span class=\"n\">size_type</span><span class=\"w\"> </span><span class=\"nf\">trailing_zeros</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-13-2\" name=\"__codelineno-13-2\"></a><span class=\"w\">  </span><span class=\"c1\">// ::cista::trailing_zeros(mask_) \u8fd4\u56de\u7684\u662f\u6700\u4f4e\u4f4d1\u7684\u4f4d\u7f6e(\u4ee5bit\u4e3a\u5355\u4f4d)</span>\n<a id=\"__codelineno-13-3\" name=\"__codelineno-13-3\"></a><span class=\"w\">  </span><span class=\"c1\">// \u8fd9\u91cc &gt;&gt; SHIFT \u662f\u5c06bit\u7d22\u5f15\u8f6c\u6362\u4e3a\u5b57\u8282\u7d22\u5f15</span>\n<a id=\"__codelineno-13-4\" name=\"__codelineno-13-4\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"o\">::</span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">trailing_zeros</span><span class=\"p\">(</span><span class=\"n\">mask_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">SHIFT</span><span class=\"p\">;</span>\n<a id=\"__codelineno-13-5\" name=\"__codelineno-13-5\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-13-6\" name=\"__codelineno-13-6\"></a>\n<a id=\"__codelineno-13-7\" name=\"__codelineno-13-7\"></a><span class=\"n\">size_type</span><span class=\"w\"> </span><span class=\"nf\">leading_zeros</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-13-8\" name=\"__codelineno-13-8\"></a><span class=\"w\">  </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">total_significant_bits</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">SHIFT</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// 64</span>\n<a id=\"__codelineno-13-9\" name=\"__codelineno-13-9\"></a><span class=\"w\">  </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">extra_bits</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">group_t</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">total_significant_bits</span><span class=\"p\">;</span>\n<a id=\"__codelineno-13-10\" name=\"__codelineno-13-10\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"o\">::</span><span class=\"n\">cista</span><span class=\"o\">::</span><span class=\"n\">leading_zeros</span><span class=\"p\">(</span><span class=\"n\">mask_</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">extra_bits</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">SHIFT</span><span class=\"p\">;</span>\n<a id=\"__codelineno-13-11\" name=\"__codelineno-13-11\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-13-12\" name=\"__codelineno-13-12\"></a>\n<a id=\"__codelineno-13-13\" name=\"__codelineno-13-13\"></a><span class=\"c1\">//         00000000 000000000 00000000 00000000</span>\n<a id=\"__codelineno-13-14\" name=\"__codelineno-13-14\"></a><span class=\"c1\">// bit\u7d22\u5f15\uff1a 1-8 9-16 17-24 25-32</span>\n<a id=\"__codelineno-13-15\" name=\"__codelineno-13-15\"></a><span class=\"c1\">// \u5b57\u8282\u7d22\u5f15\uff1a 1 2 3 4</span>\n</code></pre></div></td></tr></table></div>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-14-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-14-8\">8</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-14-1\" name=\"__codelineno-14-1\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-14-2\" name=\"__codelineno-14-2\"></a><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"n\">trailing_zeros</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-14-3\" name=\"__codelineno-14-3\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">8U</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-14-4\" name=\"__codelineno-14-4\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">static_cast</span><span class=\"o\">&lt;</span><span class=\"kt\">unsigned</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">__builtin_ctzll</span><span class=\"p\">(</span><span class=\"n\">t</span><span class=\"p\">));</span>\n<a id=\"__codelineno-14-5\" name=\"__codelineno-14-5\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">4U</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">  </span><span class=\"c1\">// 32bit</span>\n<a id=\"__codelineno-14-6\" name=\"__codelineno-14-6\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">static_cast</span><span class=\"o\">&lt;</span><span class=\"kt\">unsigned</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">__builtin_ctz</span><span class=\"p\">(</span><span class=\"n\">t</span><span class=\"p\">));</span>\n<a id=\"__codelineno-14-7\" name=\"__codelineno-14-7\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-14-8\" name=\"__codelineno-14-8\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u8fd9\u4e2a\u51fd\u6570\u4f5c\u7528\u662f\u8fd4\u56de\u8f93\u5165\u6570\u4e8c\u8fdb\u5236\u8868\u793a\u4ece\u6700\u4f4e\u4f4d\u5f00\u59cb(\u53f3\u8d77)\u7684\u8fde\u7eed\u76840\u7684\u4e2a\u6570\uff1b\u5982\u679c\u4f20\u51650\u5219\u884c\u4e3a\u672a\u5b9a\u4e49\u3002\u901a\u8fc7__builtin_ctzll\u5b9e\u73b0\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-15-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-15-8\">8</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-15-1\" name=\"__codelineno-15-1\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-15-2\" name=\"__codelineno-15-2\"></a><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"n\">leading_zeros</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-15-3\" name=\"__codelineno-15-3\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">8U</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-15-4\" name=\"__codelineno-15-4\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">static_cast</span><span class=\"o\">&lt;</span><span class=\"kt\">unsigned</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">__builtin_clzll</span><span class=\"p\">(</span><span class=\"n\">t</span><span class=\"p\">));</span>\n<a id=\"__codelineno-15-5\" name=\"__codelineno-15-5\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">4U</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">  </span><span class=\"c1\">// 32bit</span>\n<a id=\"__codelineno-15-6\" name=\"__codelineno-15-6\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">static_cast</span><span class=\"o\">&lt;</span><span class=\"kt\">unsigned</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">__builtin_clz</span><span class=\"p\">(</span><span class=\"n\">t</span><span class=\"p\">));</span>\n<a id=\"__codelineno-15-7\" name=\"__codelineno-15-7\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-15-8\" name=\"__codelineno-15-8\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u8fd9\u4e2a\u51fd\u6570\u4f5c\u7528\u662f\u8fd4\u56de\u8f93\u5165\u6570\u4e8c\u8fdb\u5236\u8868\u793a\u4ece\u6700\u9ad8\u4f4d\u5f00\u59cb(\u5de6\u8d77)\u7684\u8fde\u7eed\u76840\u7684\u4e2a\u6570\uff1b\u5982\u679c\u4f20\u51650\u5219\u884c\u4e3a\u672a\u5b9a\u4e49\u3002\u901a\u8fc7__builtin_clzll\u5b9e\u73b0\u3002</p>\n<h2 id=\"\u603b\u7ed3\">\u603b\u7ed3<a class=\"headerlink\" href=\"#\u603b\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u901a\u8fc7\u4f4d\u8fd0\u7b97\u5e76\u884c\u5904\u7406\uff0c\u867d\u7136\u672a\u4f7f\u7528\u5b9e\u9645SIMD\u6307\u4ee4\uff0c\u4f46\u901a\u8fc764\u4f4d\u6574\u6570\u8fd0\u7b97\u6a21\u62df\u4e86\u5e76\u884c\u5904\u74068\u4e2a\u63a7\u5236\u5b57\u8282\u7684\u6548\u679c\u3002\u6240\u6709\u64cd\u4f5c\u90fd\u901a\u8fc7<strong>\u7cbe\u5fc3\u8bbe\u8ba1\u7684\u4f4d\u8fd0\u7b97</strong>\u5b8c\u6210\uff0c\u907f\u514d\u4e86\u5206\u652f\u548c\u5faa\u73af\u3002<strong>\u5185\u5b58\u5c40\u90e8\u6027</strong>\uff1a\u63a7\u5236\u5b57\u8282\u8fde\u7eed\u5b58\u50a8\uff0c\u5145\u5206\u5229\u7528CPU\u7f13\u5b58\u3002<strong>\u72b6\u6001\u5feb\u901f\u5224\u65ad</strong>\uff1a\u53ef\u4ee5\u4e00\u6b21\u6027\u5224\u65ad\u6574\u4e2agroup\u7684\u72b6\u6001(\u5168\u7a7a/\u90e8\u5206\u5339\u914d\u7b49)\u3002\u901a\u8fc7\u8fd9\u4e9b\u8bbe\u8ba1\uff0c\u4f7f\u5f97Swiss Table\u5728\u67e5\u627e\u3001\u63d2\u5165\u7b49\u64cd\u4f5c\u4e0a\u83b7\u5f97\u9ad8\u541e\u5410\u91cf\u3002</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/c\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898/\" target=\"_blank\">C++\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u6280\u6cd5\u5982\u4f55\u4e3a\u4e00\u4e2a\u7c7b\u52a8\u6001\u9644\u52a0\u4efb\u610f\u7c7b\u578b\u6570\u636e/\" target=\"_blank\">C++\u6280\u6cd5\uff1a\u5982\u4f55\u4e3a\u4e00\u4e2a\u7c7b\u52a8\u6001\u9644\u52a0\u4efb\u610f\u7c7b\u578b\u6570\u636e</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c20\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8e\u5c5e\u6027\u6d4b\u8bd5\u7684quickcheck-cpp\u5e93/\" target=\"_blank\">C++20\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8e\u5c5e\u6027\u6d4b\u8bd5\u7684quickcheck-cpp\u5e93</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-06-28T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/cista%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93%E5%AE%9E%E7%8E%B0%E4%B9%8Bswiss_table%E5%93%88%E5%B8%8C%E8%A1%A8%E5%AE%9E%E7%8E%B0/",
            "url": "https://github.com/KenForever1/blog/cista%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93%E5%AE%9E%E7%8E%B0%E4%B9%8Bswiss_table%E5%93%88%E5%B8%8C%E8%A1%A8%E5%AE%9E%E7%8E%B0/",
            "title": "cista\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93\u5b9e\u73b0\u4e4bswiss_table\u54c8\u5e0c\u8868\u5b9e\u73b0",
            "content_html": "<p>\u670b\u53cb\u4eec\uff0c\u5927\u5bb6\u597d\uff01\u4e0a\u6587\u6211\u4eec\u4ecb\u7ecd\u4e86<a href=\"https://mp.weixin.qq.com/s/KENr2Q4HoU9R75L-l95uoQ\">C++\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93 cista</a>\uff0c\u4eca\u5929\u63a5\u7740\u4ecb\u7ecd\u4e00\u4e0b cista \u5e93\u7684\u5b9e\u73b0\u3002</p>\n<h2 id=\"swiss_table\u5b9e\u73b0\u539f\u7406\">swiss_table\u5b9e\u73b0\u539f\u7406<a class=\"headerlink\" href=\"#swiss_table\u5b9e\u73b0\u539f\u7406\" title=\"Permanent link\">&para;</a></h2>\n<p>\u53ef\u4ee5\u4ececista\u5e93\u7684\u4ecb\u7ecd\u4e2d\u770b\u5230\u5982\u4e0b\u5185\u5bb9\uff1a</p>\n<blockquote>\n<p>Comes with a serializable high-performance hash map and hash set implementation based on Google&rsquo;s Swiss Table technique.</p>\n</blockquote>\n<p>swiss table\u7684\u5b9e\u73b0\u53ef\u4ee5\u53c2\u8003<a href=\"https://www.cnblogs.com/apocelipes/p/17562468.html\">\u7b80\u5355\u4e86\u89e3\u4e0b\u6700\u8fd1\u6b63\u706b\u7684SwissTable</a>\uff0c\u8bb2\u89e3\u7684\u5f88\u6e05\u6670\u3002</p>\n<p>\u672c\u5c0f\u8282\u5927\u591a\u6570\u5185\u5bb9\u662f\u7ad9\u5728\u5de8\u4eba\u80a9\u8180\u4e0a\uff0c\u5f15\u7528<a href=\"https://www.cnblogs.com/apocelipes/p/17562468.html\">\u7b80\u5355\u4e86\u89e3\u4e0b\u6700\u8fd1\u6b63\u706b\u7684SwissTable</a>\uff0c\u52a0\u4e0a\u4f5c\u8005\u7ed3\u5408cista\u5e93\u7684\u4ecb\u7ecd\u3002</p>\n<p>\u4ee5\u4e09\u79cd\u5b9e\u73b0hashmap\u7684\u65b9\u5f0f\uff0c\u770b\u4f18\u7f3a\u70b9\uff1a</p>\n<ul>\n<li>\n<p>\u94fe\u8868\u6cd5\uff1a\u6307\u9488\u7a33\u5b9a\u6027\uff0c\u80fd\u91c7\u53d6\u6269\u5bb9\u4e4b\u5916\u7684\u624b\u6bb5\u963b\u6b62\u67e5\u8be2\u6027\u80fd\u9000\u5316\uff0c\u6bd4\u5982\u628a\u8fc7\u957f\u94fe\u8868\u8f6c\u6362\u6210\u641c\u7d22\u6811\u3002\u7f3a\u70b9\uff1a\u7f13\u5b58\u4e0d\u591f\u53cb\u597d\uff0c\u51b2\u7a81\u8f83\u591a\u7684\u65f6\u5019\u7f13\u5b58\u547d\u4e2d\u7387\u8f83\u4f4e\u4ece\u800c\u5f71\u54cd\u6027\u80fd\u3002</p>\n</li>\n<li>\n<p>\u7ebf\u6027\u63a2\u6d4b\u6cd5\uff1a\u7f13\u5b58\u53cb\u597d\uff0c\u52a0\u4e0a\u51b2\u7a81\u4f1a\u6709\u8fde\u9501\u5f71\u54cd\uff0c\u6ca1\u6709\u6307\u9488\u7a33\u5b9a\u6027\u3002</p>\n</li>\n</ul>\n<!-- more -->\n\n<p>swiss table\u662f\u4e3a\u4e86\u6539\u8fdb\u54c8\u5e0c\u8868\u672c\u8eab\u7684\u7ed3\u6784\u529b\u6c42\u5728\u7f13\u5b58\u53cb\u597d\u3001\u6027\u80fd\u548c\u5185\u5b58\u7528\u91cf\u4e0a\u627e\u5230\u5e73\u8861\u3002</p>\n<blockquote>\n<p>swisstable\u62e5\u6709\u60ca\u4eba\u6027\u80fd\u7684\u4e3b\u8981\u539f\u56e0\uff1a\u5b83\u5c3d\u91cf\u907f\u514d\u7ebf\u6027\u63a2\u6d4b\u6cd5\u5bfc\u81f4\u7684\u5927\u91cf\u7b49\u503c\u6bd4\u8f83\u548c\u94fe\u8868\u6cd5\u4f1a\u5e26\u6765\u7684\u7f13\u5b58\u547d\u4e2d\u7387\u4f4e\u4e0b\uff0c\u4ee5\u53ca\u5728\u5355\u4f4d\u65f6\u95f4\u5185\u5b83\u80fd\u540c\u65f6\u8fc7\u6ee4N\u4e2a\uff08\u901a\u5e38\u4e3a16\uff0c\u56e0\u4e3a16x8=128\uff0c\u662f\u5927\u591a\u6570\u5e73\u53f0\u4e0aSIMD\u6307\u4ee4\u4e13\u7528\u7684\u5411\u91cf\u5bc4\u5b58\u5668\u7684\u5927\u5c0f\uff09\u5143\u7d20\uff0c\u4e14\u53ef\u4ee5\u7528\u4f4d\u8fd0\u7b97\u4ee3\u66ff\u5bf9\u6570\u636e\u7684\u904d\u5386\u3002\u8fd9\u4f1a\u4e3a\u54c8\u5e0c\u8868\u7684\u541e\u5410\u91cf\u5e26\u6765\u8d28\u7684\u98de\u8dc3\u3002</p>\n</blockquote>\n<ul>\n<li>\n<p>\u6539\u8fdb\u7684\u7ebf\u6027\u63a2\u6d4b\u65b9\u5f0f\uff0c\u5206group\u5904\u7406\uff0c\u53ef\u4ee5SIMD\u6307\u4ee4\u52a0\u901f\u5904\u7406\u3002</p>\n</li>\n<li>\n<p>swiss table\u91c7\u7528\u4e86 <strong>control\u63a7\u5236\u4fe1\u606f \u548c slot\u5b58\u50a8\u6570\u636e</strong> \u5206\u79bb\u7684\u65b9\u5f0f\u8fdb\u884c\u5b58\u50a8\u3002\u76f8\u6bd4\u94fe\u5f0f\uff0c\u6570\u636e\u5c40\u90e8\u6027\u66f4\u597d\u3002</p>\n</li>\n<li>\n<p>hash\u4e00\u517164\u4f4d\uff0c57\u4f4d\u4e3ah1\uff0c\u7528\u4e8e\u9501\u5b9a\u662fslot\u4f4d\u7f6e\u30027\u4f4d\u4e3ah2\uff0c\u4f5c\u4e3akey\u3002</p>\n</li>\n<li>\n<p>resize\u6269\u5bb92\u500d\u3002</p>\n</li>\n</ul>\n<p>\u63a7\u5236\u4fe1\u606fcontrl\u4e2d\uff0c\u4e0b\u9762\u7684\u5b9a\u4e49\uff0c\u8868\u793a\u4e86\u4e09\u79cd\u72b6\u6001\uff0c\u90fd\u662f1\u5f00\u5934\u3002\u5982\u679c\u662f0\u5f00\u5934\uff0c\u540e\u9762\u5c31\u662f7\u4f4dh2\u6570\u636e\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-5\">5</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"k\">enum</span><span class=\"w\"> </span><span class=\"nc\">ctrl_t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">int8_t</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a><span class=\"w\">    </span><span class=\"n\">EMPTY</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">-128</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// 10000000</span>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a><span class=\"w\">    </span><span class=\"n\">DELETED</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">-2</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// 11111110</span>\n<a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\"></a><span class=\"w\">    </span><span class=\"n\">END</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"w\">  </span><span class=\"c1\">// 11111111</span>\n<a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\"></a><span class=\"w\">  </span><span class=\"p\">};</span>\n</code></pre></div></td></tr></table></div>\n<p>abseil\u7684\u5b9e\u73b0\u4e2d\uff0c\u6587\u7ae0\u91cc\u4e5f\u63d0\u5230\u4e86\uff0c\u91c7\u7528\u4e86SSE\uff08SIMD\u6307\u4ee4\uff09\u8fdb\u884c\u52a0\u901f\uff0c\u4e00\u6b21\u540c\u65f6\u6bd4\u8f83\u4e00\u4e2aGroup\uff0816\u4e2aslot\uff09\u3002\u5728cista\u4e2d\uff0c\u6ca1\u6709\u5b9e\u73b0SSE\u3002</p>\n<p>\u5f15\u7528\u6587\u7ae0\u4e2d\u7684\u4e00\u5f20\u56fe\u8bf4\u660eswiss_table\u5b58\u50a8\u5e03\u5c40\uff1a</p>\n<p><img alt=\"\" src=\"https://raw.githubusercontent.com/KenForever1/CDN/main/swiss_table.jpg\" /></p>\n<p>\u5728cista\u4e2d\u901a\u8fc7\u4f4d\u8fd0\u7b97\u5e76\u884c\u5904\u7406\uff0c\u867d\u7136\u672a\u4f7f\u7528\u5b9e\u9645SIMD\u6307\u4ee4\uff0c\u4f46\u901a\u8fc764\u4f4d\u6574\u6570\u8fd0\u7b97\u6a21\u62df\u4e86\u5e76\u884c\u5904\u74068\u4e2a\u63a7\u5236\u5b57\u8282\u7684\u6548\u679c\u3002\n+ \u6240\u6709\u64cd\u4f5c\u90fd\u901a\u8fc7<strong>\u7cbe\u5fc3\u8bbe\u8ba1\u7684\u4f4d\u8fd0\u7b97</strong>\u5b8c\u6210\uff0c\u907f\u514d\u4e86\u5206\u652f\u548c\u5faa\u73af\u3002</p>\n<ul>\n<li>\n<p><strong>\u5185\u5b58\u5c40\u90e8\u6027</strong>\uff1a\u63a7\u5236\u5b57\u8282\u8fde\u7eed\u5b58\u50a8\uff0c\u5145\u5206\u5229\u7528CPU\u7f13\u5b58\u3002</p>\n</li>\n<li>\n<p><strong>\u72b6\u6001\u5feb\u901f\u5224\u65ad</strong>\uff1a\u53ef\u4ee5\u4e00\u6b21\u6027\u5224\u65ad\u6574\u4e2agroup\u7684\u72b6\u6001(\u5168\u7a7a/\u90e8\u5206\u5339\u914d\u7b49)\u3002</p>\n</li>\n</ul>\n<p>\u901a\u8fc7\u8fd9\u4e9b\u8bbe\u8ba1\uff0c\u4f7f\u5f97Swiss Table\u5728\u67e5\u627e\u3001\u63d2\u5165\u7b49\u64cd\u4f5c\u4e0a\u83b7\u5f97\u9ad8\u541e\u5410\u91cf\u3002\u5728hashmap\u7684\u5b9e\u73b0\u4e2d\uff0c\u54c8\u5e0c\u51fd\u6570\u7684\u7b97\u6cd5\u4e5f\u5f88\u91cd\u8981\uff0c\u4e00\u4e2a\u66f4\u52a0\u9ad8\u6548\u201c\u5b8c\u7f8e\u54c8\u5e0c\u51fd\u6570\u201d\uff0c\u53ef\u4ee5\u51cf\u5c11\u51b2\u7a81\uff0c\u51cf\u5c11\u7b49\u503c\u6bd4\u8f83\uff0c\u63d0\u9ad8\u6027\u80fd\u3002</p>\n<h2 id=\"cista\u4e2dswiss_table\u54c8\u5e0c\u8868\u5b9e\u73b0\">cista\u4e2dswiss_table\u54c8\u5e0c\u8868\u5b9e\u73b0<a class=\"headerlink\" href=\"#cista\u4e2dswiss_table\u54c8\u5e0c\u8868\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"find\u67e5\u627e\u5b9e\u73b0\">find\u67e5\u627e\u5b9e\u73b0<a class=\"headerlink\" href=\"#find\u67e5\u627e\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h3>\n<p>find_impl\u5b9e\u73b0\u5982\u4e0b\uff0c\u53ef\u4ee5\u770b\u5230\u901a\u8fc7h1\u786e\u5b9a\u67e5\u627e\u7684group\uff0c\u7136\u540e\u901a\u8fc7h2\u8fdb\u884c\u5339\u914d\uff0c\u5224\u65adkey\u76f8\u7b49\uff0c\u8fd4\u56deiterator\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-15\">15</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"k\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">Key</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"n\">iterator</span><span class=\"w\"> </span><span class=\"n\">find_impl</span><span class=\"p\">(</span><span class=\"n\">Key</span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a><span class=\"w\">    </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">hash</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">compute_hash</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">seq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">probe_seq</span><span class=\"p\">{</span><span class=\"n\">h1</span><span class=\"p\">(</span><span class=\"n\">hash</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">capacity_</span><span class=\"p\">};</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">seq</span><span class=\"p\">.</span><span class=\"n\">next</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\"></a><span class=\"w\">        </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"p\">{</span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">seq</span><span class=\"p\">.</span><span class=\"n\">offset_</span><span class=\"p\">};</span>\n<a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\"></a><span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"p\">.</span><span class=\"n\">match</span><span class=\"p\">(</span><span class=\"n\">h2</span><span class=\"p\">(</span><span class=\"n\">hash</span><span class=\"p\">)))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Eq</span><span class=\"p\">{}(</span><span class=\"n\">GetKey</span><span class=\"p\">()(</span><span class=\"n\">entries_</span><span class=\"p\">[</span><span class=\"n\">seq</span><span class=\"p\">.</span><span class=\"n\">offset</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">)]),</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\"></a><span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">iterator_at</span><span class=\"p\">(</span><span class=\"n\">seq</span><span class=\"p\">.</span><span class=\"n\">offset</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span>\n<a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">g</span><span class=\"p\">.</span><span class=\"n\">match_empty</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"p\">();</span>\n<a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\">   </span>\n<a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n\u7531\u4e8econtrol\u4fe1\u606f\u548cslot\u4fe1\u606f\u7684index\u662f\u4e00\u4e00\u5bf9\u5e94\u7684\uff0c\u56e0\u6b64iterator\u4e2d\u4fdd\u6301\u7684ctrl\u548centry\u7684\u6307\u9488\uff0c\u83b7\u53d6value\uff0c\u5c31\u662f*entry_\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-5\">5</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">iterator</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a><span class=\"w\">    </span><span class=\"n\">reference</span><span class=\"w\"> </span><span class=\"k\">operator</span><span class=\"o\">*</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">noexcept</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">entry_</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a><span class=\"w\">    </span><span class=\"n\">ctrl_t</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ctrl_</span><span class=\"p\">{</span><span class=\"k\">nullptr</span><span class=\"p\">};</span>\n<a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a><span class=\"w\">    </span><span class=\"n\">T</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">entry_</span><span class=\"p\">{</span><span class=\"k\">nullptr</span><span class=\"p\">};</span>\n<a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u5220\u9664\u3001\u63d2\u5165\u64cd\u4f5c\u7684\u903b\u8f91\u611f\u5174\u8da3\u7684\u670b\u53cb\u63a8\u8350\u9605\u8bfb<a href=\"https://github.com/felixguendling/cista/blob/master/include/cista/containers/hash_storage.h\">cista hashstorage\u6e90\u7801</a>\uff0c\u5e0c\u671b\u672c\u6587\u53ef\u4ee5\u5e2e\u52a9\u4f60\u66f4\u52a0\u5feb\u901f\u7406\u89e3\u5b9e\u73b0\u3002</p>\n<h3 id=\"\u6838\u5fc3\u5b58\u50a8\u7ed3\u6784\u7684\u521d\u59cb\u5316\">\u6838\u5fc3\u5b58\u50a8\u7ed3\u6784\u7684\u521d\u59cb\u5316<a class=\"headerlink\" href=\"#\u6838\u5fc3\u5b58\u50a8\u7ed3\u6784\u7684\u521d\u59cb\u5316\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6838\u5fc3\u5b58\u50a8\u7ed3\u6784entries_\u7684\u521d\u59cb\u5316\u4ee3\u7801\u5982\u4e0b\uff0c\u4fdd\u5b58\u4e86slot\u6570\u636e\u548ccontrol\u6570\u636e\u3002WIDTH\u4e3a8\uff0cALIGNMENT\u4e3aalignof(T)\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-23\">23</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"w\">  </span><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"n\">size_type</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">WIDTH</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">8U</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a><span class=\"w\">  </span><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">constexpr</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">ALIGNMENT</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">alignof</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">initialize_entries</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\"></a><span class=\"w\">    </span><span class=\"n\">self_allocated_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\"></a><span class=\"w\">    </span><span class=\"c1\">// capacity_ * sizeof(T)  \u4fdd\u5b58slot\u6570\u636e</span>\n<a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\"></a><span class=\"w\">    </span><span class=\"c1\">// (capacity_ + 1U + WIDTH) * sizeof(ctrl_t) \u4fdd\u5b58control\u4fe1\u606f\uff0c\u52a0\u4e0a\u540e\u9762\u7684padding\u5bf9\u9f50</span>\n<a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\"></a><span class=\"w\">    </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">static_cast</span><span class=\"o\">&lt;</span><span class=\"n\">size_type</span><span class=\"o\">&gt;</span><span class=\"p\">(</span>\n<a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\"></a><span class=\"w\">        </span><span class=\"n\">capacity_</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">capacity_</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1U</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">WIDTH</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">ctrl_t</span><span class=\"p\">));</span>\n<a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\"></a><span class=\"w\">    </span><span class=\"n\">entries_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">reinterpret_cast</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">*&gt;</span><span class=\"p\">(</span>\n<a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\"></a><span class=\"w\">        </span><span class=\"n\">CISTA_ALIGNED_ALLOC</span><span class=\"p\">(</span><span class=\"n\">ALIGNMENT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">static_cast</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"kt\">size_t</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">)));</span>\n<a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">entries_</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\"></a><span class=\"w\">      </span><span class=\"n\">throw_exception</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">bad_alloc</span><span class=\"p\">{});</span>\n<a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\"></a><span class=\"cp\">#if defined(CISTA_ZERO_OUT)</span>\n<a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">memset</span><span class=\"p\">(</span><span class=\"n\">entries_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\"></a><span class=\"cp\">#endif</span>\n<a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\"></a><span class=\"w\">    </span><span class=\"n\">ctrl_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">reinterpret_cast</span><span class=\"o\">&lt;</span><span class=\"n\">ctrl_t</span><span class=\"o\">*&gt;</span><span class=\"p\">(</span>\n<a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\"></a><span class=\"w\">        </span><span class=\"k\">reinterpret_cast</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"kt\">uint8_t</span><span class=\"o\">*&gt;</span><span class=\"p\">(</span><span class=\"n\">ptr_cast</span><span class=\"p\">(</span><span class=\"n\">entries_</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span>\n<a id=\"__codelineno-3-20\" name=\"__codelineno-3-20\"></a><span class=\"w\">        </span><span class=\"n\">capacity_</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">));</span>\n<a id=\"__codelineno-3-21\" name=\"__codelineno-3-21\"></a><span class=\"w\">    </span><span class=\"n\">reset_ctrl</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-22\" name=\"__codelineno-3-22\"></a><span class=\"w\">    </span><span class=\"n\">reset_growth_left</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-23\" name=\"__codelineno-3-23\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u4e0b\u7bc7\u6587\u7ae0\uff0c\u6211\u5c06\u8be6\u7ec6\u4ecb\u7ecdSwiss Table\u4e2dGroup\u7684\u4ee3\u7801\u5b9e\u73b0\uff0cgroup\u5339\u914d\u4f4d\u8fd0\u7b97\u3002</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/c\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93cista/\" target=\"_blank\">C++\u96f6\u62f7\u8d1d\u53cd\u5e8f\u5217\u5316\u5e93cista</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898/\" target=\"_blank\">C++\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-06-28T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/c%E6%8A%80%E6%B3%95%E5%A6%82%E4%BD%95%E4%B8%BA%E4%B8%80%E4%B8%AA%E7%B1%BB%E5%8A%A8%E6%80%81%E9%99%84%E5%8A%A0%E4%BB%BB%E6%84%8F%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE/",
            "url": "https://github.com/KenForever1/blog/c%E6%8A%80%E6%B3%95%E5%A6%82%E4%BD%95%E4%B8%BA%E4%B8%80%E4%B8%AA%E7%B1%BB%E5%8A%A8%E6%80%81%E9%99%84%E5%8A%A0%E4%BB%BB%E6%84%8F%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE/",
            "title": "C++\u6280\u6cd5\uff1a\u5982\u4f55\u4e3a\u4e00\u4e2a\u7c7b\u52a8\u6001\u9644\u52a0\u4efb\u610f\u7c7b\u578b\u6570\u636e",
            "content_html": "<h2 id=\"c\u6280\u6cd5\u5982\u4f55\u4e3a\u4e00\u4e2a\u7c7b\u52a8\u6001\u9644\u52a0\u4efb\u610f\u7c7b\u578b\u6570\u636e\">C++\u6280\u6cd5\uff1a\u5982\u4f55\u4e3a\u4e00\u4e2a\u7c7b\u52a8\u6001\u9644\u52a0\u4efb\u610f\u7c7b\u578b\u6570\u636e<a class=\"headerlink\" href=\"#c\u6280\u6cd5\u5982\u4f55\u4e3a\u4e00\u4e2a\u7c7b\u52a8\u6001\u9644\u52a0\u4efb\u610f\u7c7b\u578b\u6570\u636e\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u8bbe\u8ba1\u4e00\u4e2a\u7c7b\u65f6\uff0c\u7c7b\u7684\u6210\u5458\u5c31\u56fa\u5b9a\u4e0b\u6765\u4e86\u3002\u4f46\u662f\u67d0\u4e9b\u573a\u666f\u4e0b\uff0c\u9700\u8981\u6269\u5c55\u7c7b\u7684\u6210\u5458\uff0c\u4f46\u662f\u53c8\u4e0d\u60f3\u6539\u53d8\u7c7b\u7684\u5b9a\u4e49\u3002\u8fd9\u79cd\u60c5\u51b5\u600e\u4e48\u529e\u5462\uff1f</p>\n<!-- more -->\n<p>\u6709\u4e00\u4e9b\u65b9\u6cd5\uff1a\n+ \u5728\u8bbe\u8ba1\u7c7b\u65f6\uff0c\u589e\u52a0\u4e00\u4e9b\u4fdd\u7559\u5b57\u6bb5\uff0c\u7559\u5f85\u540e\u9762\u4f7f\u7528\u3002\n+ \u5728\u7c7b\u4e2d\u53ef\u4ee5\u5b58\u50a8std::string\uff0c\u5b58\u50a8json\u6570\u636e\u4e4b\u7c7b\u7684\uff0c\u5982\u679c\u8981\u589e\u52a0\u6570\u636e\uff0c\u53ef\u4ee5\u5b58\u50a8\u5230string\u4e2d\u3002\n+ \u53e6\u5916\u5c31\u662f\u672c\u6587\u4ecb\u7ecd\u7684\uff0c\u5229\u7528\u7c7b\u578b\u64e6\u9664\u6280\u672f\uff0c\u901a\u8fc7std::shared_ptr&lt;void&gt;\u5b58\u50a8\u6570\u636e\uff0c\u53ef\u4ee5\u5b58\u50a8\u4efb\u610f\u7c7b\u578b\u7684\u6570\u636e\u3002</p>\n<p>C++\u53ef\u4ee5\u901a\u8fc7std::shared_ptr&lt;void&gt;\u5b9e\u73b0\u4e3a\u4e00\u4e2a\u7c7b\u52a8\u6001\u9644\u52a0\u4efb\u610f\u7c7b\u578b\u6570\u636e\u3002\u53ef\u4ee5\u7528\u4e8e\u9700\u8981\u5b58\u50a8\u4e0d\u540c\u7c7b\u578b\u6570\u636e\u4f46\u5e0c\u671b\u7edf\u4e00\u7ba1\u7406\u7684\u573a\u666f\u3002\nstd::shared_ptr&lt;void&gt;\u901a\u8fc7\u7c7b\u578b\u64e6\u9664\u673a\u5236\uff0c\u53ef\u4ee5\u6301\u6709\u4efb\u610f\u7c7b\u578b\u7684\u6307\u9488\uff0c\u540c\u65f6\u5229\u7528\u5f15\u7528\u8ba1\u6570\u81ea\u52a8\u7ba1\u7406\u5185\u5b58\u751f\u547d\u5468\u671f\u3002</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">shared_ptr</span><span class=\"o\">&lt;</span><span class=\"kt\">void</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">make_shared</span><span class=\"o\">&lt;</span><span class=\"kt\">int</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"mi\">42</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// \u5b58\u50a8int\u7c7b\u578b</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">make_shared</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"s\">&quot;Hello&quot;</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// \u52a8\u6001\u66ff\u6362\u4e3astring\u7c7b\u578b</span>\n</code></pre></div></td></tr></table></div>\n\u4f7f\u7528\u65f6\u9700\u901a\u8fc7std::dynamic_pointer_cast\u6216std::static_pointer_cast\u5c06void\u6307\u9488\u8f6c\u6362\u56de\u5177\u4f53\u7c7b\u578b\uff0c\u786e\u4fdd\u7c7b\u578b\u5b89\u5168\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">strPtr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">static_pointer_cast</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">strPtr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"cm\">/* \u5b89\u5168\u4f7f\u7528 */</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h2 id=\"\u4e00\u4e2a\u4f8b\u5b50\u770b\u8d85\u5b9e\u7528\u7684\u4f7f\u7528\u65b9\u6cd5\">\u4e00\u4e2a\u4f8b\u5b50\u770b\u8d85\u5b9e\u7528\u7684\u4f7f\u7528\u65b9\u6cd5<a class=\"headerlink\" href=\"#\u4e00\u4e2a\u4f8b\u5b50\u770b\u8d85\u5b9e\u7528\u7684\u4f7f\u7528\u65b9\u6cd5\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8be6\u7ec6\u5b9e\u73b0\uff0c\u53c2\u8003\u5f00\u6e90\u5730\u5740<a href=\"https://github.com/KenForever1/attachment_set/tree/main\">KenForever1/attachment_set</a>, \u53ea\u9700\u8981100\u884c\u5934\u6587\u4ef6\u5b9e\u73b0\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-23\">23</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"c1\">// \u5b9a\u4e49\u5bb9\u5668\uff0c\u53ef\u4ee5\u662f\u4f60\u9700\u8981\u6269\u5c55\u7684\u7c7b\u7684\u6210\u5458\u53d8\u91cf</span>\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a><span class=\"n\">AttachmentSet</span><span class=\"w\"> </span><span class=\"n\">attachments</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a>\n<a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a><span class=\"c1\">// \u5b58\u50a8\u9644\u4ef6</span>\n<a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\"></a><span class=\"n\">attachments</span><span class=\"p\">.</span><span class=\"n\">set</span><span class=\"o\">&lt;</span><span class=\"n\">MyClass</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"s\">&quot;obj&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">make_shared</span><span class=\"o\">&lt;</span><span class=\"n\">MyClass</span><span class=\"o\">&gt;</span><span class=\"p\">());</span>\n<a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\"></a><span class=\"n\">attachments</span><span class=\"p\">.</span><span class=\"n\">set</span><span class=\"o\">&lt;</span><span class=\"kt\">int</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"s\">&quot;value&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">make_shared</span><span class=\"o\">&lt;</span><span class=\"kt\">int</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"mi\">42</span><span class=\"p\">));</span>\n<a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\"></a>\n<a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\"></a><span class=\"c1\">// \u83b7\u53d6\u9644\u4ef6</span>\n<a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">attachments</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"o\">&lt;</span><span class=\"n\">MyClass</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"s\">&quot;obj&quot;</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\"></a><span class=\"w\">    </span><span class=\"n\">ptr</span><span class=\"o\">-&gt;</span><span class=\"n\">doSomething</span><span class=\"p\">();</span>\n<a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\"></a>\n<a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\"></a><span class=\"c1\">// \u7c7b\u578b\u68c0\u67e5</span>\n<a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">attachments</span><span class=\"p\">.</span><span class=\"n\">is</span><span class=\"o\">&lt;</span><span class=\"kt\">int</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"s\">&quot;value&quot;</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\"></a><span class=\"w\">    </span><span class=\"c1\">// \u5b89\u5168\u64cd\u4f5c...</span>\n<a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-2-17\" name=\"__codelineno-2-17\"></a>\n<a id=\"__codelineno-2-18\" name=\"__codelineno-2-18\"></a><span class=\"c1\">// \u904d\u5386\u9644\u4ef6</span>\n<a id=\"__codelineno-2-19\" name=\"__codelineno-2-19\"></a><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">attachments</span><span class=\"p\">.</span><span class=\"n\">begin</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">attachments</span><span class=\"p\">.</span><span class=\"n\">end</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"n\">it</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-20\" name=\"__codelineno-2-20\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">it</span><span class=\"p\">.</span><span class=\"n\">is</span><span class=\"o\">&lt;</span><span class=\"n\">MyClass</span><span class=\"o\">&gt;</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-21\" name=\"__codelineno-2-21\"></a><span class=\"w\">        </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"o\">&lt;</span><span class=\"n\">MyClass</span><span class=\"o\">&gt;</span><span class=\"p\">();</span>\n<a id=\"__codelineno-2-22\" name=\"__codelineno-2-22\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-2-23\" name=\"__codelineno-2-23\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h2 id=\"\u6838\u5fc3\u65b9\u6cd5\u5b9e\u73b0\">\u6838\u5fc3\u65b9\u6cd5\u5b9e\u73b0<a class=\"headerlink\" href=\"#\u6838\u5fc3\u65b9\u6cd5\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"attachmentset\u7c7b\u5b9e\u73b0\">AttachmentSet\u7c7b\u5b9e\u73b0<a class=\"headerlink\" href=\"#attachmentset\u7c7b\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5982\u679c\u628a\u6269\u5c55\u5b58\u50a8\u7684\u6570\u636e\u79f0\u4e3a\u9644\u4ef6\uff0c\u5982\u679c\u8981\u5b58\u50a8\u591a\u4e2a\u9644\u4ef6\uff0c\u80af\u5b9a\u8981\u7528\u5bb9\u5668\u53bb\u88c5\u3002\u8fd9\u91cc\u53ef\u4ee5\u7528vector\u5b58\u50a8\uff0c\u8fd8\u80fd\u5229\u7528\u4e0aiterator\u8fed\u4ee3\u5668\u3002</p>\n<p>\u6700\u7b80\u5355\u7684\u5c31\u662fstd::vector&lt;std::shared_ptr&lt;void&gt;&gt;\u6210\u5458\u53d8\u91cf\uff0c\u4e5f\u53ef\u4ee5\u5b58\u50a8\u4e3aany\uff0c\u901a\u8fc7any_cast\u8fdb\u884c\u8f6c\u6362\uff0c\u7528\u4e8e\u5b58\u50a8\u9644\u4ef6\u3002</p>\n<p>\u9664\u4e86\u5b58\u50a8\u6570\u636e\uff0c\u8fd8\u8981\u5b58\u50a8\u67e5\u627e\u7684\u7d22\u5f15Key\uff0c\u4ee5\u53ca\u7528\u4e8e\u5bf9\u6bd4\u7c7b\u578b\u7684typeid, \u4e5f\u53ef\u4ee5\u662ftypeid(T).hash_code()\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-20\">20</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">AttachmentSet</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">TypeInfo</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a><span class=\"w\">        </span><span class=\"c1\">// \u901a\u8fc7typeid(T).hash_code()\u5339\u914d\u548c\u6821\u9a8c\u7c7b\u578b\u662f\u5426\u6b63\u5e38</span>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a><span class=\"w\">        </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\"></a><span class=\"w\">        </span><span class=\"c1\">// \u7c7b\u578b\u8f6c\u6362\uff0c\u5728\u5b58\u50a8\u9644\u4ef6\u65f6\u7ed1\u5b9a\u8be5\u51fd\u6570</span>\n<a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\"></a><span class=\"w\">        </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">function</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">shared_ptr</span><span class=\"o\">&lt;</span><span class=\"kt\">void</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">any</span><span class=\"o\">&amp;</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">caster</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\"></a><span class=\"w\">    </span><span class=\"p\">};</span>\n<a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\"></a>\n<a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Attachment</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\"></a><span class=\"w\">        </span><span class=\"c1\">// \u9644\u4ef6\u540d\u79f0</span>\n<a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\"></a><span class=\"w\">        </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\"></a><span class=\"w\">        </span><span class=\"c1\">// \u9644\u4ef6\u6570\u636e</span>\n<a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\"></a><span class=\"w\">        </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\"></a><span class=\"w\">        </span><span class=\"c1\">// \u9644\u4ef6\u7c7b\u578b\u4fe1\u606f</span>\n<a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\"></a><span class=\"w\">        </span><span class=\"n\">TypeInfo</span><span class=\"w\"> </span><span class=\"n\">type_info</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\"></a><span class=\"w\">    </span><span class=\"p\">};</span>\n<a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\"></a>\n<a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\"></a><span class=\"w\">    </span><span class=\"c1\">// \u5b58\u50a8\u9644\u4ef6\u5bb9\u5668</span>\n<a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\"></a><span class=\"w\">    </span><span class=\"k\">using</span><span class=\"w\"> </span><span class=\"n\">Storage</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">vector</span><span class=\"o\">&lt;</span><span class=\"n\">Attachment</span><span class=\"o\">&gt;</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-20\" name=\"__codelineno-3-20\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"set\u65b9\u6cd5\u5b9e\u73b0\">set\u65b9\u6cd5\u5b9e\u73b0<a class=\"headerlink\" href=\"#set\u65b9\u6cd5\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-17\">17</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a><span class=\"k\">template</span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">shared_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\"></a><span class=\"w\">    </span><span class=\"n\">TypeInfo</span><span class=\"w\"> </span><span class=\"n\">type_info</span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\"></a><span class=\"w\">        </span><span class=\"c1\">// \u7c7b\u578b\u4fe1\u606f</span>\n<a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\"></a><span class=\"w\">        </span><span class=\"k\">typeid</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">).</span><span class=\"n\">hash_code</span><span class=\"p\">(),</span>\n<a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\"></a><span class=\"w\">        </span><span class=\"c1\">// \u7c7b\u578b\u8f6c\u6362\u51fd\u6570\uff0c\u675c\u7edd\u9519\u8bef\u7c7b\u578b\u8f6c\u6362\uff0c\u907f\u514dstd::bad_any_cast\u5f02\u5e38</span>\n<a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\"></a><span class=\"w\">        </span><span class=\"p\">[](</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">any</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">any_cast</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">shared_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\"></a><span class=\"w\">    </span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\"></a>\n<a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\"></a><span class=\"w\">    </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">storage_</span><span class=\"p\">.</span><span class=\"n\">end</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\"></a><span class=\"w\">        </span><span class=\"n\">it</span><span class=\"o\">-&gt;</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\"></a><span class=\"w\">        </span><span class=\"n\">it</span><span class=\"o\">-&gt;</span><span class=\"n\">type_info</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">type_info</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\"></a><span class=\"w\">        </span><span class=\"n\">storage_</span><span class=\"p\">.</span><span class=\"n\">push_back</span><span class=\"p\">({</span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">type_info</span><span class=\"p\">});</span>\n<a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"get\u65b9\u6cd5\u5b9e\u73b0\">get\u65b9\u6cd5\u5b9e\u73b0<a class=\"headerlink\" href=\"#get\u65b9\u6cd5\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-16\">16</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a><span class=\"c1\">// \u901a\u8fc7name \u67e5\u627e</span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a><span class=\"n\">Storage</span><span class=\"o\">::</span><span class=\"n\">const_iterator</span><span class=\"w\"> </span><span class=\"nf\">find</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">find_if</span><span class=\"p\">(</span><span class=\"n\">storage_</span><span class=\"p\">.</span><span class=\"n\">begin</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">storage_</span><span class=\"p\">.</span><span class=\"n\">end</span><span class=\"p\">(),</span>\n<a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\"></a><span class=\"w\">        </span><span class=\"p\">[</span><span class=\"o\">&amp;</span><span class=\"n\">name</span><span class=\"p\">](</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">auto</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">.</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">});</span>\n<a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\"></a>\n<a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\"></a><span class=\"k\">template</span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">shared_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\"></a><span class=\"w\">    </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">);</span>\n<a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\"></a><span class=\"w\">    </span><span class=\"c1\">// \u627e\u4e0d\u5230\u6216\u8005\u7c7b\u578b\u4e0d\u5339\u914d\uff0c\u8fd4\u56denullptr</span>\n<a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">storage_</span><span class=\"p\">.</span><span class=\"n\">end</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"o\">-&gt;</span><span class=\"n\">type_info</span><span class=\"p\">.</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"k\">typeid</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">).</span><span class=\"n\">hash_code</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-14\" name=\"__codelineno-5-14\"></a><span class=\"w\">    </span><span class=\"c1\">// \u83b7\u53d6\u6570\u636e</span>\n<a id=\"__codelineno-5-15\" name=\"__codelineno-5-15\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">static_pointer_cast</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">it</span><span class=\"o\">-&gt;</span><span class=\"n\">type_info</span><span class=\"p\">.</span><span class=\"n\">caster</span><span class=\"p\">(</span><span class=\"n\">it</span><span class=\"o\">-&gt;</span><span class=\"n\">data</span><span class=\"p\">));</span>\n<a id=\"__codelineno-5-16\" name=\"__codelineno-5-16\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"\u8fed\u4ee3\u5668\u5b9e\u73b0\">\u8fed\u4ee3\u5668\u5b9e\u73b0<a class=\"headerlink\" href=\"#\u8fed\u4ee3\u5668\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h3>\n<p>\u501f\u52a9vector\uff0c\u5f88\u5bb9\u5668\u5b9e\u73b0\u8fed\u4ee3\u5668\uff0c\u5e76\u4e14\u5b9e\u73b0\u4e86name()\u3001is()\u3001get()\u65b9\u6cd5\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-20\">20</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">Iterator</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\"></a><span class=\"w\">    </span><span class=\"n\">Storage</span><span class=\"o\">::</span><span class=\"n\">const_iterator</span><span class=\"w\"> </span><span class=\"n\">it_</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\"></a><span class=\"k\">public</span><span class=\"o\">:</span>\n<a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\"></a><span class=\"w\">    </span><span class=\"k\">explicit</span><span class=\"w\"> </span><span class=\"n\">Iterator</span><span class=\"p\">(</span><span class=\"n\">Storage</span><span class=\"o\">::</span><span class=\"n\">const_iterator</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">it_</span><span class=\"p\">(</span><span class=\"n\">it</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n<a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\"></a>\n<a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">it_</span><span class=\"o\">-&gt;</span><span class=\"n\">name</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\"></a>\n<a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\"></a><span class=\"w\">    </span><span class=\"k\">template</span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\"></a><span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">it_</span><span class=\"o\">-&gt;</span><span class=\"n\">type_info</span><span class=\"p\">.</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"k\">typeid</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">).</span><span class=\"n\">hash_code</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\"></a>\n<a id=\"__codelineno-6-11\" name=\"__codelineno-6-11\"></a><span class=\"w\">    </span><span class=\"k\">template</span><span class=\"o\">&lt;</span><span class=\"k\">typename</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-6-12\" name=\"__codelineno-6-12\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">shared_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-13\" name=\"__codelineno-6-13\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">is</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-14\" name=\"__codelineno-6-14\"></a><span class=\"w\">        </span><span class=\"c1\">// \u83b7\u53d6\u6570\u636e, \u4ecestd::any\u8f6c\u6362\u6210std::shared_ptr&lt;T&gt;</span>\n<a id=\"__codelineno-6-15\" name=\"__codelineno-6-15\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">static_pointer_cast</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">it_</span><span class=\"o\">-&gt;</span><span class=\"n\">type_info</span><span class=\"p\">.</span><span class=\"n\">caster</span><span class=\"p\">(</span><span class=\"n\">it_</span><span class=\"o\">-&gt;</span><span class=\"n\">data</span><span class=\"p\">));</span>\n<a id=\"__codelineno-6-16\" name=\"__codelineno-6-16\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-17\" name=\"__codelineno-6-17\"></a>\n<a id=\"__codelineno-6-18\" name=\"__codelineno-6-18\"></a><span class=\"w\">    </span><span class=\"n\">Iterator</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"k\">operator</span><span class=\"o\">++</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"n\">it_</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">this</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-19\" name=\"__codelineno-6-19\"></a><span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"k\">operator</span><span class=\"o\">!=</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">Iterator</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">other</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">it_</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">other</span><span class=\"p\">.</span><span class=\"n\">it_</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-20\" name=\"__codelineno-6-20\"></a><span class=\"p\">};</span>\n</code></pre></div></td></tr></table></div></p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/c\u6280\u6cd5\u6a21\u677f\u5143\u7f16\u7a0b\u7f16\u8bd1\u671f\u83b7\u53d6\u7c7b\u6210\u5458\u6570\u91cf/\" target=\"_blank\">C++\u6280\u6cd5:\u6a21\u677f\u5143\u7f16\u7a0b\u7f16\u8bd1\u671f\u83b7\u53d6\u7c7b\u6210\u5458\u6570\u91cf</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898/\" target=\"_blank\">C++\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u6280\u6cd5iguana\u5e8f\u5217\u5316\u5e93\u4e2d\u5982\u4f55\u5b9e\u73b0enum-reflection\u53cd\u5c04/\" target=\"_blank\">C++\u6280\u6cd5\uff1aiguana\u5e8f\u5217\u5316\u5e93\u4e2d\u5982\u4f55\u5b9e\u73b0enum reflection\u53cd\u5c04</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-06-22T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/torch_memory_saver%E9%AB%98%E6%80%A7%E8%83%BDcuda%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%E5%AE%9E%E7%8E%B0/",
            "url": "https://github.com/KenForever1/blog/torch_memory_saver%E9%AB%98%E6%80%A7%E8%83%BDcuda%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%E5%AE%9E%E7%8E%B0/",
            "title": "torch_memory_saver\u9ad8\u6027\u80fdCUDA\u5185\u5b58\u7ba1\u7406\u5de5\u5177\u5b9e\u73b0",
            "content_html": "<p><a href=\"https://github.com/fzyzcjy/torch_memory_saver/tree/master\">torch_memory_saver</a>\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u9ad8\u6027\u80fdCUDA\u5185\u5b58\u7ba1\u7406\u5de5\u5177\uff0c\u4e3b\u8981\u529f\u80fd\u662f\u5141\u8bb8\u6682\u505c\u548c\u6062\u590dPyTorch\u5f20\u91cf\u7684CUDA\u5185\u5b58\u5360\u7528\u3002\u4fdd\u6301\u7528\u6237\u4f7f\u7528\u7684\u865a\u62df\u5730\u5740\u4e0d\u53d8\uff0c\u6682\u505c\u540e\u91ca\u653e\u663e\u5b58\uff0c\u6062\u590d\u91cd\u65b0\u5206\u914d\u663e\u5b58\uff0c\u7ed1\u5b9a\u5230\u865a\u62df\u5730\u5740\u4e0a\u3002</p>\n<p>\u672c\u6587\u4f1a\u4ecb\u7ecd\u6838\u5fc3\u539f\u7406\uff0c\u4ee5\u53ca\u62e6\u622aCUDA runtime API\u7684\u5b9e\u73b0\u3002\u4f60\u8fd8\u53ef\u4ee5\u770b\u5230\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2apython c++\u6269\u5c55\u3002\u5728sglang\u5927\u6a21\u578b\u63a8\u7406\u5e93\u4e2d\u4e5f\u6709\u4f7f\u7528\u5230\u8fd9\u4e2atorch_memory_saver\u5e93\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u6838\u5fc3\u539f\u7406\u548c\u4f7f\u7528\u793a\u4f8b\">\u6838\u5fc3\u539f\u7406\u548c\u4f7f\u7528\u793a\u4f8b<a class=\"headerlink\" href=\"#\u6838\u5fc3\u539f\u7406\u548c\u4f7f\u7528\u793a\u4f8b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5185\u5b58\u6682\u505c/\u6062\u590d\u529f\u80fd\u7684\u6838\u5fc3\u5b9e\u73b0\u539f\u7406:\n\u4f7f\u7528CUDA\u865a\u62df\u5185\u5b58\u7ba1\u7406API\uff08cuMemCreate/cuMemMap\u7b49\uff09\u66ff\u4ee3\u5e38\u89c4cudaMalloc, \u901a\u8fc7LD_PRELOAD\u62e6\u622acudaMalloc/cudaFree\u8c03\u7528, \u5728\u7279\u5b9aregion\u5185\uff08\u4f8b\u5982\uff1a\u5728python\u4e2d\u53ef\u4ee5\u7528with memory_saver.region()\u8bed\u6cd5\uff09\u5206\u914d\u7684\u5185\u5b58\u4f1a\u88ab\u7279\u6b8a\u7ba1\u7406\u3002</p>\n<p>\u4f7f\u7528\u4f8b\u5b50\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Python</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-14\">14</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">torch_memory_saver</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a><span class=\"n\">memory_saver</span> <span class=\"o\">=</span> <span class=\"n\">torch_memory_saver</span><span class=\"o\">.</span><span class=\"n\">memory_saver</span>\n<a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\"></a>\n<a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\"></a><span class=\"c1\"># 1. For tensors that wants to be paused, create them within `region`</span>\n<a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\"></a><span class=\"k\">with</span> <span class=\"n\">memory_saver</span><span class=\"o\">.</span><span class=\"n\">region</span><span class=\"p\">():</span>\n<a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\"></a>    <span class=\"n\">pauseable_tensor</span> <span class=\"o\">=</span> <span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">full</span><span class=\"p\">((</span><span class=\"mi\">1_000_000_000</span><span class=\"p\">,),</span> <span class=\"mi\">100</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">uint8</span><span class=\"p\">,</span> <span class=\"n\">device</span><span class=\"o\">=</span><span class=\"s1\">&#39;cuda&#39;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\"></a>\n<a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\"></a><span class=\"c1\"># 2. After `pause`, CUDA memory is released for those tensors.</span>\n<a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\"></a><span class=\"c1\"># For example, check `nvidia-smi`&#39;s memory usage to verify.</span>\n<a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\"></a><span class=\"n\">memory_saver</span><span class=\"o\">.</span><span class=\"n\">pause</span><span class=\"p\">()</span>\n<a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\"></a>\n<a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\"></a><span class=\"c1\"># 3. After `resume`, CUDA memory is re-occupied for those tensors.</span>\n<a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\"></a><span class=\"n\">memory_saver</span><span class=\"o\">.</span><span class=\"n\">resume</span><span class=\"p\">()</span>\n</code></pre></div></td></tr></table></div></p>\n<h2 id=\"\u6682\u505c\u548c\u6062\u590d\u5b9e\u73b0\u539f\u7406\">\u6682\u505c\u548c\u6062\u590d\u5b9e\u73b0\u539f\u7406<a class=\"headerlink\" href=\"#\u6682\u505c\u548c\u6062\u590d\u5b9e\u73b0\u539f\u7406\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0b\u9762\u4ecb\u7ecdpause\u548cresume\u7684\u5b9e\u73b0\u65b9\u5f0f\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-10\">10</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">pause</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"w\">    </span><span class=\"c1\">// \u904d\u5386\u6240\u6709\u5df2\u5206\u914d\u5185\u5b58</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">allocation_metadata_</span><span class=\"p\">.</span><span class=\"n\">begin</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"p\">...)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\"></a><span class=\"w\">        </span><span class=\"c1\">// 1. \u53d6\u6d88\u5185\u5b58\u6620\u5c04 (cuMemUnmap)</span>\n<a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\"></a><span class=\"w\">        </span><span class=\"c1\">// 2. \u91ca\u653e\u5e95\u5c42\u5185\u5b58\u53e5\u67c4 (cuMemRelease)</span>\n<a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\"></a><span class=\"w\">        </span><span class=\"c1\">// \u4fdd\u7559\u865a\u62df\u5730\u5740\u7a7a\u95f4\u4e0d\u91ca\u653e</span>\n<a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\"></a><span class=\"w\">        </span><span class=\"n\">CURESULT_CHECK</span><span class=\"p\">(</span><span class=\"n\">cuMemUnmap</span><span class=\"p\">((</span><span class=\"n\">CUdeviceptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">metadata</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">));</span>\n<a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\"></a><span class=\"w\">        </span><span class=\"n\">CURESULT_CHECK</span><span class=\"p\">(</span><span class=\"n\">cuMemRelease</span><span class=\"p\">(</span><span class=\"n\">metadata</span><span class=\"p\">.</span><span class=\"n\">allocHandle</span><span class=\"p\">));</span>\n<a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-14\">14</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">resume</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a><span class=\"w\">    </span><span class=\"c1\">// \u904d\u5386\u6240\u6709\u5df2\u5206\u914d\u5185\u5b58</span>\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">allocation_metadata_</span><span class=\"p\">.</span><span class=\"n\">begin</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"p\">...)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a><span class=\"w\">        </span><span class=\"c1\">// 1. \u521b\u5efa\u65b0\u7684\u5185\u5b58\u53e5\u67c4 (cuMemCreate)</span>\n<a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\"></a><span class=\"w\">        </span><span class=\"c1\">// 2. \u91cd\u65b0\u6620\u5c04\u5230\u539f\u6765\u7684\u865a\u62df\u5730\u5740 (cuMemMap)</span>\n<a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\"></a><span class=\"w\">        </span><span class=\"c1\">// 3. \u8bbe\u7f6e\u8bbf\u95ee\u6743\u9650 (cuMemSetAccess)</span>\n<a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\"></a>\n<a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\"></a><span class=\"w\">        </span><span class=\"n\">CUmemGenericAllocationHandle</span><span class=\"w\"> </span><span class=\"n\">newAllocHandle</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\"></a><span class=\"w\">        </span><span class=\"n\">CUDAUtils</span><span class=\"o\">::</span><span class=\"n\">cu_mem_create</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">newAllocHandle</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">metadata</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">metadata</span><span class=\"p\">.</span><span class=\"n\">device</span><span class=\"p\">);</span>\n<a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\"></a><span class=\"w\">        </span><span class=\"n\">CURESULT_CHECK</span><span class=\"p\">(</span><span class=\"n\">cuMemMap</span><span class=\"p\">((</span><span class=\"n\">CUdeviceptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">metadata</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">newAllocHandle</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">));</span>\n<a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\"></a><span class=\"w\">        </span><span class=\"n\">CUDAUtils</span><span class=\"o\">::</span><span class=\"n\">cu_mem_set_access</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">metadata</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">metadata</span><span class=\"p\">.</span><span class=\"n\">device</span><span class=\"p\">);</span>\n<a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\"></a><span class=\"w\">        </span><span class=\"n\">metadata</span><span class=\"p\">.</span><span class=\"n\">allocHandle</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">newAllocHandle</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n\u4f7f\u7528CUDA\u865a\u62df\u5185\u5b58API\u4fdd\u6301\u865a\u62df\u5730\u5740\u4e0d\u53d8\uff0c\u56e0\u6b64\u6682\u505c\u65f6\u53ea\u91ca\u653e\u7269\u7406\u5185\u5b58\uff0c\u4fdd\u7559\u865a\u62df\u5730\u5740\u7a7a\u95f4\u3002\u6062\u590d\u65f6\u91cd\u65b0\u5206\u914d\u7269\u7406\u5185\u5b58\u5e76\u6620\u5c04\u5230\u539f\u865a\u62df\u5730\u5740\u3002</p>\n<ul>\n<li>\u8c03\u7528cuMemAddressReserve\u4fdd\u7559\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff1b</li>\n<li>\u901a\u8fc7cuMemCreate\u5206\u914d\u7269\u7406\u5185\u5b58\uff1b</li>\n<li>\u4f7f\u7528cuMemMap\u5c06\u7269\u7406\u5185\u5b58\u6620\u5c04\u5230\u865a\u62df\u5730\u5740\uff1b</li>\n<li>\u6700\u540e\u901a\u8fc7cuMemSetAccess\u8bbe\u7f6e\u8bbf\u95ee\u6743\u9650</li>\n</ul>\n<p>\u8fd9\u6837\u5e94\u7528\u7a0b\u5e8f\u65e0\u9700\u4fee\u6539\u6307\u9488\u5f15\u7528\uff0c\u7279\u522b\u9002\u5408\u9700\u8981\u4e34\u65f6\u91ca\u653e\u663e\u5b58\u7684\u5927\u6a21\u578b\u573a\u666f\u3002</p>\n<p>\u518d\u770b\u770bmalloc\u548cfree\u7684\u5b9e\u73b0\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-30\">30</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"n\">cudaError_t</span><span class=\"w\"> </span><span class=\"nf\">malloc</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">**</span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a><span class=\"w\">    </span><span class=\"n\">CUdevice</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"n\">CURESULT_CHECK</span><span class=\"p\">(</span><span class=\"n\">cuCtxGetDevice</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">device</span><span class=\"p\">));</span>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a>\n<a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\"></a><span class=\"w\">    </span><span class=\"n\">CUmemGenericAllocationHandle</span><span class=\"w\"> </span><span class=\"n\">allocHandle</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\"></a><span class=\"w\">    </span><span class=\"n\">CUDAUtils</span><span class=\"o\">::</span><span class=\"n\">cu_mem_create</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">allocHandle</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\"></a><span class=\"w\">    </span><span class=\"c1\">// ptr\u5c31\u662f\u4fdd\u7559\u91cd\u590d\u4f7f\u7528\u7684\u865a\u62df\u5730\u5740</span>\n<a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\"></a><span class=\"w\">    </span><span class=\"n\">CURESULT_CHECK</span><span class=\"p\">(</span><span class=\"n\">cuMemAddressReserve</span><span class=\"p\">((</span><span class=\"n\">CUdeviceptr</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">));</span>\n<a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\"></a><span class=\"w\">    </span><span class=\"n\">CURESULT_CHECK</span><span class=\"p\">(</span><span class=\"n\">cuMemMap</span><span class=\"p\">((</span><span class=\"n\">CUdeviceptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">allocHandle</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">));</span>\n<a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\"></a><span class=\"w\">    </span><span class=\"n\">CUDAUtils</span><span class=\"o\">::</span><span class=\"n\">cu_mem_set_access</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\"></a>\n<a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\"></a><span class=\"w\">    </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\"></a><span class=\"w\">        </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">lock_guard</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">mutex</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">lock</span><span class=\"p\">(</span><span class=\"n\">allocator_metadata_mutex_</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\"></a><span class=\"w\">        </span><span class=\"n\">allocation_metadata_</span><span class=\"p\">.</span><span class=\"n\">emplace</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_AllocationMetadata</span><span class=\"p\">{</span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">allocHandle</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"p\">});</span>\n<a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\"></a>\n<a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\"></a><span class=\"n\">cudaError_t</span><span class=\"w\"> </span><span class=\"nf\">free</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\"></a><span class=\"w\">    </span><span class=\"n\">_AllocationMetadata</span><span class=\"w\"> </span><span class=\"n\">metadata</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-20\" name=\"__codelineno-3-20\"></a><span class=\"w\">    </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-21\" name=\"__codelineno-3-21\"></a><span class=\"w\">        </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">lock_guard</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">mutex</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">lock</span><span class=\"p\">(</span><span class=\"n\">allocator_metadata_mutex_</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-22\" name=\"__codelineno-3-22\"></a><span class=\"w\">        </span><span class=\"n\">SIMPLE_CHECK</span><span class=\"p\">(</span><span class=\"n\">allocation_metadata_</span><span class=\"p\">.</span><span class=\"n\">count</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"s\">&quot;Trying to free a pointer not allocated here&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-23\" name=\"__codelineno-3-23\"></a><span class=\"w\">        </span><span class=\"n\">metadata</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">allocation_metadata_</span><span class=\"p\">[</span><span class=\"n\">ptr</span><span class=\"p\">];</span>\n<a id=\"__codelineno-3-24\" name=\"__codelineno-3-24\"></a><span class=\"w\">        </span><span class=\"n\">allocation_metadata_</span><span class=\"p\">.</span><span class=\"n\">erase</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-25\" name=\"__codelineno-3-25\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-3-26\" name=\"__codelineno-3-26\"></a>\n<a id=\"__codelineno-3-27\" name=\"__codelineno-3-27\"></a><span class=\"w\">    </span><span class=\"n\">CURESULT_CHECK</span><span class=\"p\">(</span><span class=\"n\">cuMemUnmap</span><span class=\"p\">((</span><span class=\"n\">CUdeviceptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">metadata</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">));</span>\n<a id=\"__codelineno-3-28\" name=\"__codelineno-3-28\"></a><span class=\"w\">    </span><span class=\"n\">CURESULT_CHECK</span><span class=\"p\">(</span><span class=\"n\">cuMemRelease</span><span class=\"p\">(</span><span class=\"n\">metadata</span><span class=\"p\">.</span><span class=\"n\">allocHandle</span><span class=\"p\">));</span>\n<a id=\"__codelineno-3-29\" name=\"__codelineno-3-29\"></a><span class=\"w\">    </span><span class=\"n\">CURESULT_CHECK</span><span class=\"p\">(</span><span class=\"n\">cuMemAddressFree</span><span class=\"p\">((</span><span class=\"n\">CUdeviceptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">metadata</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">));</span>\n<a id=\"__codelineno-3-30\" name=\"__codelineno-3-30\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u901a\u8fc7allocation_metadata_\u4fdd\u5b58\u4e86\u865a\u62df\u6307\u9488ptr\u548c\u6bcf\u6b21\u5206\u914d\u7684metadata\uff0cmetadata\u5305\u62ec\u4e86\u771f\u5b9e\u4f7f\u7528\u7684\u5185\u5b58allocHandle\u548csize\u3002</p>\n<p>\u5728pause\u7684\u65f6\u5019\u91ca\u653eallocHandle\uff0c\u4f46\u662f\u4e0d\u91ca\u653eptr\u3002\u5728assume\u7684\u65f6\u5019\u7533\u8bf7\u65b0\u7684allocHandle\uff0c\u7ed1\u5b9aptr\u548callocHandle\u7684\u5173\u7cfb\uff0c\u5373\u66f4\u65b0allocation_metadata_\u4fdd\u5b58\u7684metadata\u4fe1\u606f\u3002</p>\n<h2 id=\"\u901a\u8fc7region\u8fdb\u884c\u7ba1\u7406\">\u901a\u8fc7Region\u8fdb\u884c\u7ba1\u7406<a class=\"headerlink\" href=\"#\u901a\u8fc7region\u8fdb\u884c\u7ba1\u7406\" title=\"Permanent link\">&para;</a></h2>\n<p>\u901a\u8fc7Region\u8fdb\u884c\u7ba1\u7406\uff0c\u4e0d\u5728Region\u5185\u7684\u5185\u5b58\u4e0d\u53d7\u5f71\u54cd\uff0c\u6b63\u5e38\u4f7f\u7528CudaMalloc/CudaFree\u3002\u5728\u7279\u5b9aRegion\u5185\u5206\u914d\u7684\u5185\u5b58\u4f1a\u88ab\u7279\u6b8a\u7ba1\u7406\uff0c\u6682\u505c\u65f6\u53ea\u91ca\u653e\u7269\u7406\u5185\u5b58\uff0c\u4fdd\u7559\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff0c\u6062\u590d\u65f6\u91cd\u65b0\u5206\u914d\u7269\u7406\u5185\u5b58\u5e76\u6620\u5c04\u5230\u539f\u865a\u62df\u5730\u5740\u3002</p>\n<p>\u5bf9\u5e94python\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Python</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a><span class=\"k\">with</span> <span class=\"n\">memory_saver</span><span class=\"o\">.</span><span class=\"n\">region</span><span class=\"p\">():</span>\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a>    <span class=\"n\">x</span> <span class=\"o\">=</span> <span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">full</span><span class=\"p\">((</span><span class=\"mi\">1_000_000_000</span><span class=\"p\">,),</span> <span class=\"mi\">100</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">uint8</span><span class=\"p\">,</span> <span class=\"n\">device</span><span class=\"o\">=</span><span class=\"s1\">&#39;cuda&#39;</span><span class=\"p\">)</span>\n</code></pre></div></td></tr></table></div></p>\n<p>Region\u7684\u5b9e\u73b0\uff1a</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-21\">21</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a><span class=\"k\">namespace</span><span class=\"w\"> </span><span class=\"nn\">RegionManager</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a><span class=\"w\">    </span><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">thread_local</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">is_interesting_region_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\"></a>\n<a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">enter</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\"></a><span class=\"cp\">#ifdef TMS_DEBUG_LOG</span>\n<a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\"></a><span class=\"w\">        </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">cout</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;[torch_memory_saver.cpp] tms_region_enter&quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\"></a><span class=\"cp\">#endif</span>\n<a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\"></a><span class=\"w\">        </span><span class=\"n\">is_interesting_region_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\"></a>\n<a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">leave</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\"></a><span class=\"cp\">#ifdef TMS_DEBUG_LOG</span>\n<a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\"></a><span class=\"w\">        </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">cout</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">&quot;[torch_memory_saver.cpp] tms_region_leave&quot;</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-14\" name=\"__codelineno-5-14\"></a><span class=\"cp\">#endif</span>\n<a id=\"__codelineno-5-15\" name=\"__codelineno-5-15\"></a><span class=\"w\">        </span><span class=\"n\">is_interesting_region_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-16\" name=\"__codelineno-5-16\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-17\" name=\"__codelineno-5-17\"></a>\n<a id=\"__codelineno-5-18\" name=\"__codelineno-5-18\"></a><span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"nf\">is_interesting_region</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-19\" name=\"__codelineno-5-19\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">is_interesting_region_</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-20\" name=\"__codelineno-5-20\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-21\" name=\"__codelineno-5-21\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\nis_interesting_region\u51fd\u6570\uff0c\u4f1a\u5728\u4e0b\u8282\u62e6\u622a\u4e2dcudaMalloc/cudaFree\u8c03\u7528\u4e2d\u533a\u5206\u4e0d\u540c\u7684\u8c03\u7528\u5b9e\u73b0\u3002</p>\n<h2 id=\"ld_preload\u62e6\u622acudamalloccudafree\u8c03\u7528\">LD_PRELOAD\u62e6\u622acudaMalloc/cudaFree\u8c03\u7528<a class=\"headerlink\" href=\"#ld_preload\u62e6\u622acudamalloccudafree\u8c03\u7528\" title=\"Permanent link\">&para;</a></h2>\n<p>pytorch python\u5e93\u505a\u4e86\u5927\u91cf\u7684\u5c01\u88c5\uff0c\u66f4\u52a0\u53cb\u597d\u4f7f\u7528\u3002\u6bd4\u5982\u521b\u5efa\u4e00\u4e2atensor\u53ea\u9700\u8981\u4e0b\u9762\u4e00\u53e5\uff0c\u6307\u5b9adatatype\u3001shape\u3001device\u4e3acuda\u3002\u5b9e\u9645\u4e0a\u5e95\u5c42\u4f1a\u8c03\u7528cudaMalloc/cudaFree\uff08cudaruntime\u7684api\uff09\u53bb\u5206\u914d\u548c\u91ca\u653e\u663e\u5b58\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Text Only</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a>x = torch.full((1_000_000_000,), 100, dtype=torch.uint8, device=&#39;cuda&#39;)\n</code></pre></div></td></tr></table></div>\n\u4e3a\u4e86\u80fd\u591f\u4f7f\u7528\u4e0a\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u5206\u914d\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u62e6\u622acudaruntime\u4e2d\u5b9e\u73b0\u7684cudaMalloc\u548ccudaFree\u3002\u6bd4\u5982\u5728Region\u533a\u57df\u5185\u8c03\u7528\u81ea\u5b9a\u4e49\u5206\u914d\u91ca\u653e\u903b\u8f91\uff0c\u4e0d\u5728Region\u5185\u7684\u5185\u5b58\uff0c\u6b63\u5e38\u8c03\u7528cudaruntime\u7684CudaMalloc/CudaFree\u3002</p>\n<p>\u4e00\u8d77\u770b\u770b\u5982\u4f55\u62e6\u622a\uff01</p>\n<p>\u81ea\u5b9a\u4e49cudaMalloc\u548ccudaFree\u51fd\u6570\u3002\u5206\u6761\u4ef6\u8c03\u7528\u4e0d\u540c\u7684\u903b\u8f91\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-7-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-15\">15</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\"></a><span class=\"n\">cudaError_t</span><span class=\"w\"> </span><span class=\"nf\">cudaMalloc</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">**</span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">RegionManager</span><span class=\"o\">::</span><span class=\"n\">is_interesting_region</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">TorchMemorySaver</span><span class=\"o\">::</span><span class=\"n\">instance</span><span class=\"p\">().</span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">RegionManager</span><span class=\"o\">::</span><span class=\"n\">get_current_tag</span><span class=\"p\">());</span>\n<a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">APIForwarder</span><span class=\"o\">::</span><span class=\"n\">call_real_cuda_malloc</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\"></a>\n<a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\"></a><span class=\"n\">cudaError_t</span><span class=\"w\"> </span><span class=\"nf\">cudaFree</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">RegionManager</span><span class=\"o\">::</span><span class=\"n\">is_interesting_region</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">TorchMemorySaver</span><span class=\"o\">::</span><span class=\"n\">instance</span><span class=\"p\">().</span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">APIForwarder</span><span class=\"o\">::</span><span class=\"n\">call_real_cuda_free</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-14\" name=\"__codelineno-7-14\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-7-15\" name=\"__codelineno-7-15\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\ncall_real_cuda_malloc\u548ccall_real_cuda_free\u5c31\u662f\u8c03\u7528cudaruntime\u7684\u6807\u51c6\u5b9e\u73b0\u3002</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u548c\u6211\u4eec\u4e0a\u7bc7\u5c06\u62e6\u622a\u7684\u6587\u7ae0\u4e00\u6837\uff0c\u7528\u5230\u4e86dlsym RTLD_NEXT\u65b9\u5f0f\u548cLD_PRELOAD\u65b9\u5f0f\u83b7\u53d6cudaruntime\u7684\u5b9e\u73b0\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-8-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-7\">7</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\"></a><span class=\"w\">    </span><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">cudaError_t</span><span class=\"w\"> </span><span class=\"nf\">call_real_cuda_malloc</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">**</span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">C10_UNLIKELY</span><span class=\"p\">(</span><span class=\"k\">nullptr</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">real_cudaMalloc</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\"></a><span class=\"w\">            </span><span class=\"n\">real_cudaMalloc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">CudaMallocFunc</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">check_dlsym</span><span class=\"p\">(</span><span class=\"n\">dlsym</span><span class=\"p\">(</span><span class=\"n\">RTLD_NEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;cudaMalloc&quot;</span><span class=\"p\">));</span>\n<a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\"></a><span class=\"w\">        </span><span class=\"n\">cudaError_t</span><span class=\"w\"> </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">real_cudaMalloc</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">ret</span><span class=\"p\">;</span>\n<a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<h2 id=\"\u989d\u5916\u5b66\u4e60\u5230\u7684\u77e5\u8bc6\">\u989d\u5916\u5b66\u4e60\u5230\u7684\u77e5\u8bc6<a class=\"headerlink\" href=\"#\u989d\u5916\u5b66\u4e60\u5230\u7684\u77e5\u8bc6\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9664\u6b64\u4e4b\u5916\uff0c\u7531\u4e8e\u6838\u5fc3\u903b\u8f91\u662fc++\u5b9e\u73b0\u7684\uff0c\u56e0\u6b64\u4f60\u8fd8\u53ef\u4ee5\u901a\u8fc7\u672c\u9879\u76ee\u5b66\u4f1a\u5982\u4f55\u5b9e\u73b0python c/c++\u6269\u5c55\uff08setup ext_modules\uff09\u3002</p>\n<p>\u548cpytorch\u4e00\u6837\uff0c\u6700\u7ec8\u4f7f\u7528torch_memory_saver\u662fpython\u5305\u5f62\u5f0f\u3002\u5982\u4f55\u901a\u8fc7\uff08from contextlib import contextmanager\uff09\u81ea\u5b9a\u4e49python with\u8bed\u6cd5\u7cd6\u3002\u5982\u4f55\u8c03\u7528\u5c01\u88c5c++\u6269\u5c55\u3002\u5f62\u6210\u4e00\u4e2a\u7528\u6237\u53cb\u597d\u7684python\u5e93\u3002</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/sglang\u63a8\u7406\u4f7f\u7528\u4e4b\u73af\u5883\u914d\u7f6e/\" target=\"_blank\">sglang\u63a8\u7406\u4f7f\u7528\u4e4b\u73af\u5883\u914d\u7f6e</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/\u4ecedeepseek\u5f00\u6e90\u5e933fs\u4e2d\u5b66\u4e60fuse\u7684\u4f7f\u7528-\u5982\u4f55\u5f00\u53d1\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e00/\" target=\"_blank\">\u4eceDeepseek\u5f00\u6e90\u5e933FS\u4e2d\u5b66\u4e60fuse\u7684\u4f7f\u7528-\u5982\u4f55\u5f00\u53d1\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff08\u4e00\uff09</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-06-21T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/tritonserver-multibatch%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/",
            "url": "https://github.com/KenForever1/blog/tritonserver-multibatch%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/",
            "title": "tritonserver-multibatch\u6e90\u7801\u5206\u6790",
            "content_html": "<!-- more -->\n<h2 id=\"\u95ee\u9898\">\u95ee\u9898<a class=\"headerlink\" href=\"#\u95ee\u9898\" title=\"Permanent link\">&para;</a></h2>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-23\">23</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"nl\">name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;python_batched_service&quot;</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a><span class=\"nl\">backend</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;python&quot;</span>\n<a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\"></a><span class=\"nl\">max_batch_size</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\"></a>\n<a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\"></a><span class=\"n\">dynamic_batching</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\"></a><span class=\"w\">  </span><span class=\"nl\">max_queue_delay_microseconds</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">500000</span>\n<a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\"></a>\n<a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\"></a><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"p\">[</span>\n<a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\"></a><span class=\"w\">    </span><span class=\"nl\">name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;input_field&quot;</span>\n<a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\"></a><span class=\"w\">    </span><span class=\"nl\">data_type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">TYPE_FP32</span>\n<a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\"></a><span class=\"w\">    </span><span class=\"nl\">dims</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"w\"> </span><span class=\"p\">]</span>\n<a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\"></a><span class=\"p\">]</span>\n<a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\"></a>\n<a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\"></a><span class=\"n\">instance_group</span><span class=\"w\"> </span><span class=\"p\">[</span>\n<a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n<a id=\"__codelineno-0-20\" name=\"__codelineno-0-20\"></a><span class=\"w\">    </span><span class=\"nl\">count</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<a id=\"__codelineno-0-21\" name=\"__codelineno-0-21\"></a><span class=\"w\">    </span><span class=\"nl\">kind</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">KIND_CPU</span>\n<a id=\"__codelineno-0-22\" name=\"__codelineno-0-22\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-0-23\" name=\"__codelineno-0-23\"></a><span class=\"p\">]</span>\n</code></pre></div></td></tr></table></div>\n\u5bf9\u4e8e\u4e00\u4e2a\u8f93\u5165\u4e3ainput_field\u7684\u6a21\u578b\uff0c\u5982\u679c\u8f93\u5165\u7684shape\u4e0d\u540c\uff0c\u6bd4\u5982[1,20]\u548c[1,30]\u3001[1\u300140]\uff0c\u90a3\u4e48dynamic batching\u662f\u5426\u4f1a\u51d1batch\uff1f</p>\n<p>\u7b54\u6848\u662f\u4e0d\u4f1a\uff0c\u53ea\u6709\u8fde\u7eed\u53d1\u9001\u7684[1,20]\u8fd9\u79cd\u76f8\u540c\u8f93\u5165shape\u7684\u8bf7\u6c42\u624d\u4f1a\u51d1batch\u3002\u4e0d\u4e00\u6837\u7684\u53eb\u4e0d\u89c4\u5219\u8f93\u5165\uff0c\u4e5f\u53ebragged batch\u3002</p>\n<p>\u53ef\u4ee5\u53c2\u8003python\u4f8b\u5b50\u3002</p>\n<p>https://github.com/triton-inference-server/server/issues/6937</p>\n<p>https://github.com/triton-inference-server/server/blob/main/docs/protocol/extension_statistics.md</p>\n<h3 id=\"tritonserver\">tritonserver<a class=\"headerlink\" href=\"#tritonserver\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0d\u540cshape\uff0c\u91c7\u7528dynamic batching\u65b9\u5f0f\u4e0d\u4f1a\u51d1batch\u3002</p>\n<p>\u9700\u8981\u91c7\u7528ragged batching\u65b9\u5f0f\u3002\u6216\u8005\u5c06proto3\u7684int32\u6539\u6210fixed32\uff0c\u4ee5\u53ca\u907f\u514d\u4f20\u8f930\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-32\">32</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"c1\">// repo-core-src/src/backend_model.cc</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"n\">Status</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a><span class=\"nf\">TritonModel::SetConfiguredScheduler</span><span class=\"p\">()</span>\n<a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\"></a><span class=\"p\">{</span>\n<a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\"></a><span class=\"w\">  </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">Scheduler</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">scheduler</span><span class=\"p\">;</span>\n<a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\"></a>\n<a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\"></a><span class=\"w\">  </span><span class=\"c1\">// Need to enforce equal shape batches (i.e. non-ragged batches) if</span>\n<a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\"></a><span class=\"w\">  </span><span class=\"c1\">// the model 1) allows one or more variable-size input tensors that</span>\n<a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\"></a><span class=\"w\">  </span><span class=\"c1\">// are not marked as &#39;allow_ragged_batch&#39; or 2) has one or more</span>\n<a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\"></a><span class=\"w\">  </span><span class=\"c1\">// shape-tensor inputs. This is not needed if all input shapes are</span>\n<a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\"></a><span class=\"w\">  </span><span class=\"c1\">// non-variable and if there are no shape tensors... so we don&#39;t</span>\n<a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\"></a><span class=\"w\">  </span><span class=\"c1\">// enable it in that case for efficiency reasons.</span>\n<a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\"></a><span class=\"w\">  </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unordered_map</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">enforce_equal_shape_tensors</span><span class=\"p\">;</span>\n<a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">config_</span><span class=\"p\">.</span><span class=\"n\">input</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\"></a><span class=\"w\">    </span><span class=\"c1\">// https://docs.nvidia.com/deeplearning/triton-inference-server/user-guide/docs/user_guide/model_configuration.html#shape-tensors, \u76ee\u524d\u53ea\u6709TensorRT\u652f\u6301shape_tensor\u3002</span>\n<a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">input</span><span class=\"p\">.</span><span class=\"n\">is_shape_tensor</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\"></a><span class=\"w\">      </span><span class=\"n\">enforce_equal_shape_tensors</span><span class=\"p\">.</span><span class=\"n\">insert</span><span class=\"p\">({</span><span class=\"n\">input</span><span class=\"p\">.</span><span class=\"n\">name</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">});</span>\n<a id=\"__codelineno-1-18\" name=\"__codelineno-1-18\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<a id=\"__codelineno-1-19\" name=\"__codelineno-1-19\"></a><span class=\"w\">        </span><span class=\"o\">!</span><span class=\"n\">input</span><span class=\"p\">.</span><span class=\"n\">allow_ragged_batch</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span>\n<a id=\"__codelineno-1-20\" name=\"__codelineno-1-20\"></a><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">triton</span><span class=\"o\">::</span><span class=\"n\">common</span><span class=\"o\">::</span><span class=\"n\">GetElementCount</span><span class=\"p\">(</span><span class=\"n\">input</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-21\" name=\"__codelineno-1-21\"></a><span class=\"w\">      </span><span class=\"n\">enforce_equal_shape_tensors</span><span class=\"p\">.</span><span class=\"n\">insert</span><span class=\"p\">({</span><span class=\"n\">input</span><span class=\"p\">.</span><span class=\"n\">name</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">});</span>\n<a id=\"__codelineno-1-22\" name=\"__codelineno-1-22\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-1-23\" name=\"__codelineno-1-23\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-1-24\" name=\"__codelineno-1-24\"></a><span class=\"w\">    </span><span class=\"c1\">// ......</span>\n<a id=\"__codelineno-1-25\" name=\"__codelineno-1-25\"></a>\n<a id=\"__codelineno-1-26\" name=\"__codelineno-1-26\"></a><span class=\"w\">    </span><span class=\"n\">RETURN_IF_ERROR</span><span class=\"p\">(</span><span class=\"n\">DynamicBatchScheduler</span><span class=\"o\">::</span><span class=\"n\">Create</span><span class=\"p\">(</span>\n<a id=\"__codelineno-1-27\" name=\"__codelineno-1-27\"></a><span class=\"w\">    </span><span class=\"k\">this</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"cm\">/*nice*/</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"w\"> </span><span class=\"cm\">/* dynamic_batching_enabled */</span><span class=\"p\">,</span>\n<a id=\"__codelineno-1-28\" name=\"__codelineno-1-28\"></a><span class=\"w\">    </span><span class=\"n\">config_</span><span class=\"p\">.</span><span class=\"n\">max_batch_size</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">enforce_equal_shape_tensors</span><span class=\"p\">,</span>\n<a id=\"__codelineno-1-29\" name=\"__codelineno-1-29\"></a><span class=\"w\">    </span><span class=\"n\">config_</span><span class=\"p\">.</span><span class=\"n\">dynamic_batching</span><span class=\"p\">(),</span>\n<a id=\"__codelineno-1-30\" name=\"__codelineno-1-30\"></a><span class=\"w\">    </span><span class=\"n\">config_</span><span class=\"p\">.</span><span class=\"n\">response_cache</span><span class=\"p\">().</span><span class=\"n\">enable</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"cm\">/* response_cache_enable */</span><span class=\"p\">,</span>\n<a id=\"__codelineno-1-31\" name=\"__codelineno-1-31\"></a><span class=\"w\">    </span><span class=\"o\">&amp;</span><span class=\"n\">scheduler</span><span class=\"p\">));</span>\n<a id=\"__codelineno-1-32\" name=\"__codelineno-1-32\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-39\">39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-40\">40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-41\">41</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-42\">42</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-43\">43</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-44\">44</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-45\">45</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-46\">46</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-47\">47</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-48\">48</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-49\">49</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-50\">50</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-51\">51</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-52\">52</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-53\">53</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-54\">54</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-55\">55</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-56\">56</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-57\">57</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-58\">58</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-59\">59</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-60\">60</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-61\">61</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"c1\">// _deps/repo-core-src/src/dynamic_batch_scheduler.cc</span>\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a><span class=\"kt\">uint64_t</span>\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a><span class=\"nf\">DynamicBatchScheduler::GetDynamicBatch</span><span class=\"p\">(){</span>\n<a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a>\n<a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\"></a><span class=\"w\">    </span><span class=\"c1\">// When there is optional input or input shape must be enforced,</span>\n<a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\"></a><span class=\"w\">    </span><span class=\"c1\">// the inputs in the requests must be examined for forming a batch</span>\n<a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">check_input</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\"></a><span class=\"w\">        </span><span class=\"o\">!</span><span class=\"n\">enforce_equal_shape_tensors_</span><span class=\"p\">.</span><span class=\"n\">empty</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">has_optional_input_</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\"></a>\n<a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\"></a><span class=\"w\">    </span><span class=\"c1\">// If there is no pending batch, then this request is starting a</span>\n<a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\"></a><span class=\"w\">    </span><span class=\"c1\">// new batch.</span>\n<a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">payload_batch_size</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">queue_</span><span class=\"p\">.</span><span class=\"n\">PendingBatchCount</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\"></a><span class=\"w\">      </span><span class=\"c1\">// Get the shape of the new batch that is being started...</span>\n<a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">check_input</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">curr_payload_</span><span class=\"o\">-&gt;</span><span class=\"n\">MutableRequiredEqualInputs</span><span class=\"p\">()</span>\n<a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\"></a><span class=\"w\">                 </span><span class=\"o\">-&gt;</span><span class=\"n\">Initialize</span><span class=\"p\">(</span>\n<a id=\"__codelineno-2-17\" name=\"__codelineno-2-17\"></a><span class=\"w\">                     </span><span class=\"n\">queue_</span><span class=\"p\">.</span><span class=\"n\">RequestAtCursor</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">enforce_equal_shape_tensors_</span><span class=\"p\">,</span>\n<a id=\"__codelineno-2-18\" name=\"__codelineno-2-18\"></a><span class=\"w\">                     </span><span class=\"n\">has_optional_input_</span><span class=\"p\">)</span>\n<a id=\"__codelineno-2-19\" name=\"__codelineno-2-19\"></a><span class=\"w\">                 </span><span class=\"p\">.</span><span class=\"n\">IsOk</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-20\" name=\"__codelineno-2-20\"></a><span class=\"w\">          </span><span class=\"n\">send_now</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-21\" name=\"__codelineno-2-21\"></a><span class=\"w\">          </span><span class=\"k\">break</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-22\" name=\"__codelineno-2-22\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n<a id=\"__codelineno-2-23\" name=\"__codelineno-2-23\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n<a id=\"__codelineno-2-24\" name=\"__codelineno-2-24\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-25\" name=\"__codelineno-2-25\"></a><span class=\"w\">      </span><span class=\"c1\">// There is a pending batch and adding this request would make</span>\n<a id=\"__codelineno-2-26\" name=\"__codelineno-2-26\"></a><span class=\"w\">      </span><span class=\"c1\">// the batch size larger than all of the preferred batch sizes,</span>\n<a id=\"__codelineno-2-27\" name=\"__codelineno-2-27\"></a><span class=\"w\">      </span><span class=\"c1\">// so mark the cursor at this point. Not sending the pending batch so</span>\n<a id=\"__codelineno-2-28\" name=\"__codelineno-2-28\"></a><span class=\"w\">      </span><span class=\"c1\">// that we can examine the queue delay of requests that fits in a batch.</span>\n<a id=\"__codelineno-2-29\" name=\"__codelineno-2-29\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(((</span><span class=\"n\">payload_batch_size</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">pending_batch_size_</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">batch_size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-2-30\" name=\"__codelineno-2-30\"></a><span class=\"w\">           </span><span class=\"n\">max_preferred_batch_size_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span>\n<a id=\"__codelineno-2-31\" name=\"__codelineno-2-31\"></a><span class=\"w\">          </span><span class=\"p\">(</span><span class=\"n\">best_preferred_batch_size</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-32\" name=\"__codelineno-2-32\"></a><span class=\"w\">        </span><span class=\"n\">best_preferred_batch_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pending_batch_size_</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-33\" name=\"__codelineno-2-33\"></a><span class=\"w\">        </span><span class=\"n\">queue_</span><span class=\"p\">.</span><span class=\"n\">MarkCursor</span><span class=\"p\">();</span>\n<a id=\"__codelineno-2-34\" name=\"__codelineno-2-34\"></a><span class=\"w\">        </span><span class=\"n\">payload_saturated_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-35\" name=\"__codelineno-2-35\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n<a id=\"__codelineno-2-36\" name=\"__codelineno-2-36\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">payload_batch_size</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">pending_batch_size_</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">batch_size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-2-37\" name=\"__codelineno-2-37\"></a><span class=\"w\">          </span><span class=\"n\">max_batch_size_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-38\" name=\"__codelineno-2-38\"></a><span class=\"w\">        </span><span class=\"n\">send_now</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-39\" name=\"__codelineno-2-39\"></a><span class=\"w\">        </span><span class=\"k\">break</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-40\" name=\"__codelineno-2-40\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n<a id=\"__codelineno-2-41\" name=\"__codelineno-2-41\"></a>\n<a id=\"__codelineno-2-42\" name=\"__codelineno-2-42\"></a><span class=\"w\">      </span><span class=\"c1\">// There is a pending batch and it has a different shape then</span>\n<a id=\"__codelineno-2-43\" name=\"__codelineno-2-43\"></a><span class=\"w\">      </span><span class=\"c1\">// this request, so send the pending batch as it is.</span>\n<a id=\"__codelineno-2-44\" name=\"__codelineno-2-44\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">check_input</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span>\n<a id=\"__codelineno-2-45\" name=\"__codelineno-2-45\"></a><span class=\"w\">          </span><span class=\"o\">!</span><span class=\"n\">curr_payload_</span><span class=\"o\">-&gt;</span><span class=\"n\">MutableRequiredEqualInputs</span><span class=\"p\">()</span><span class=\"o\">-&gt;</span><span class=\"n\">HasEqualInputs</span><span class=\"p\">(</span>\n<a id=\"__codelineno-2-46\" name=\"__codelineno-2-46\"></a><span class=\"w\">              </span><span class=\"n\">queue_</span><span class=\"p\">.</span><span class=\"n\">RequestAtCursor</span><span class=\"p\">()))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-47\" name=\"__codelineno-2-47\"></a><span class=\"w\">        </span><span class=\"n\">curr_payload_</span><span class=\"o\">-&gt;</span><span class=\"n\">MarkSaturated</span><span class=\"p\">();</span>\n<a id=\"__codelineno-2-48\" name=\"__codelineno-2-48\"></a><span class=\"w\">        </span><span class=\"n\">send_now</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-49\" name=\"__codelineno-2-49\"></a><span class=\"w\">        </span><span class=\"k\">break</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-50\" name=\"__codelineno-2-50\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n<a id=\"__codelineno-2-51\" name=\"__codelineno-2-51\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-2-52\" name=\"__codelineno-2-52\"></a>\n<a id=\"__codelineno-2-53\" name=\"__codelineno-2-53\"></a><span class=\"w\">    </span><span class=\"c1\">// \u76f4\u63a5\u53d1\u9001</span>\n<a id=\"__codelineno-2-54\" name=\"__codelineno-2-54\"></a><span class=\"w\">    </span><span class=\"c1\">// If the delay has been exceeded, or if the current batch can&#39;t grow</span>\n<a id=\"__codelineno-2-55\" name=\"__codelineno-2-55\"></a><span class=\"w\">    </span><span class=\"c1\">// any larger then just immediately execute whatever is pending.</span>\n<a id=\"__codelineno-2-56\" name=\"__codelineno-2-56\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">send_now</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">payload_batch_size</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">pending_batch_size_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span>\n<a id=\"__codelineno-2-57\" name=\"__codelineno-2-57\"></a><span class=\"w\">                    </span><span class=\"n\">max_preferred_batch_size_</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-58\" name=\"__codelineno-2-58\"></a><span class=\"w\">        </span><span class=\"n\">payload_saturated_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-59\" name=\"__codelineno-2-59\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-60\" name=\"__codelineno-2-60\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-2-61\" name=\"__codelineno-2-61\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-35\">35</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"kt\">bool</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a><span class=\"nf\">RequiredEqualInputs::HasEqualInputs</span><span class=\"p\">(</span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">InferenceRequest</span><span class=\"o\">&gt;&amp;</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"p\">){</span>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a><span class=\"w\">        </span><span class=\"c1\">//......</span>\n<a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\"></a><span class=\"w\">        </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">auto</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">d1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">itr</span><span class=\"o\">-&gt;</span><span class=\"n\">second</span><span class=\"p\">.</span><span class=\"n\">first</span><span class=\"o\">-&gt;</span><span class=\"n\">Data</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\"></a><span class=\"w\">          </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">auto</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">d2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"o\">-&gt;</span><span class=\"n\">Data</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\"></a>\n<a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\"></a><span class=\"w\">          </span><span class=\"c1\">// For now being conservative and assuming that content</span>\n<a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\"></a><span class=\"w\">          </span><span class=\"c1\">// comparison is for shape tensors which are likely to always</span>\n<a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\"></a><span class=\"w\">          </span><span class=\"c1\">// be in a single buffer.</span>\n<a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\"></a><span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">d1</span><span class=\"o\">-&gt;</span><span class=\"n\">BufferCount</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">d2</span><span class=\"o\">-&gt;</span><span class=\"n\">BufferCount</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\"></a><span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n<a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\"></a>\n<a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\"></a><span class=\"w\">          </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">d1_byte_size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">d2_byte_size</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\"></a><span class=\"w\">          </span><span class=\"n\">TRITONSERVER_MemoryType</span><span class=\"w\"> </span><span class=\"n\">d1_memory_type</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">d2_memory_type</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\"></a><span class=\"w\">          </span><span class=\"kt\">int64_t</span><span class=\"w\"> </span><span class=\"n\">d1_memory_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">d2_memory_id</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\"></a><span class=\"w\">          </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">d1_buffer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">d1</span><span class=\"o\">-&gt;</span><span class=\"n\">BufferAt</span><span class=\"p\">(</span>\n<a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\"></a><span class=\"w\">              </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"cm\">/* idx */</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">d1_byte_size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">d1_memory_type</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">d1_memory_id</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-20\" name=\"__codelineno-3-20\"></a><span class=\"w\">          </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">d2_buffer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">d2</span><span class=\"o\">-&gt;</span><span class=\"n\">BufferAt</span><span class=\"p\">(</span>\n<a id=\"__codelineno-3-21\" name=\"__codelineno-3-21\"></a><span class=\"w\">              </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"cm\">/* idx */</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">d2_byte_size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">d2_memory_type</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">d2_memory_id</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-22\" name=\"__codelineno-3-22\"></a>\n<a id=\"__codelineno-3-23\" name=\"__codelineno-3-23\"></a><span class=\"w\">          </span><span class=\"c1\">// Tensor must be same size and in in CPU memory so that it</span>\n<a id=\"__codelineno-3-24\" name=\"__codelineno-3-24\"></a><span class=\"w\">          </span><span class=\"c1\">// can be easily compared. If not return false conservatively.</span>\n<a id=\"__codelineno-3-25\" name=\"__codelineno-3-25\"></a><span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">d1_byte_size</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">d2_byte_size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">d1_buffer</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">||</span>\n<a id=\"__codelineno-3-26\" name=\"__codelineno-3-26\"></a><span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">d2_buffer</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">||</span>\n<a id=\"__codelineno-3-27\" name=\"__codelineno-3-27\"></a><span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">d1_memory_type</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">TRITONSERVER_MEMORY_GPU</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">||</span>\n<a id=\"__codelineno-3-28\" name=\"__codelineno-3-28\"></a><span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">d2_memory_type</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">TRITONSERVER_MEMORY_GPU</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-29\" name=\"__codelineno-3-29\"></a><span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-30\" name=\"__codelineno-3-30\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n<a id=\"__codelineno-3-31\" name=\"__codelineno-3-31\"></a>\n<a id=\"__codelineno-3-32\" name=\"__codelineno-3-32\"></a><span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">strncmp</span><span class=\"p\">(</span><span class=\"n\">d1_buffer</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">d2_buffer</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">d1_byte_size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-33\" name=\"__codelineno-3-33\"></a><span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-34\" name=\"__codelineno-3-34\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n<a id=\"__codelineno-3-35\" name=\"__codelineno-3-35\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"\u91c7\u7528ragged-batch\">\u91c7\u7528ragged batch<a class=\"headerlink\" href=\"#\u91c7\u7528ragged-batch\" title=\"Permanent link\">&para;</a></h3>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Text Only</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-8\">8</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a>max_batch_size: 16\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a>input [\n<a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\"></a>  {\n<a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\"></a>    name: &quot;INPUT&quot;\n<a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\"></a>    data_type: TYPE_FP32\n<a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\"></a>    dims: [ -1 ]\n<a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\"></a>  }\n<a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\"></a>]\n</code></pre></div></td></tr></table></div>\n\u6539\u4e3a\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Text Only</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-8\">8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-9\">9</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a>max_batch_size: 16\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a>input [\n<a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\"></a>  {\n<a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\"></a>    name: &quot;INPUT&quot;\n<a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\"></a>    data_type: TYPE_FP32\n<a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\"></a>    dims: [ -1 ]\n<a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\"></a>    allow_ragged_batch: true\n<a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\"></a>  }\n<a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\"></a>]\n</code></pre></div></td></tr></table></div></p>\n<p>python backend\u548c\u4e00\u822c\u81ea\u5b9a\u4e49\u7684backend\u90fd\u4e0d\u9700\u8981\u52a0\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Text Only</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-8\">8</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a>batch_input [\n<a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\"></a>  {\n<a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\"></a>    kind: BATCH_ACCUMULATED_ELEMENT_COUNT\n<a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\"></a>    target_name: &quot;INDEX&quot;\n<a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\"></a>    data_type: TYPE_FP32\n<a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\"></a>    source_input: &quot;INPUT&quot;\n<a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\"></a>  }\n<a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\"></a>]\n</code></pre></div></td></tr></table></div></p>\n<blockquote>\n<p>The backends, such as ONNX Runtime backend, TensorFlow backend, PyTorch backend, and TensorRT backend, require models to accept ragged inputs as 1-dimensional tensors. These backends concatenates the request inputs into the 1-dimensional tensor.Because the concatenated input doesn\u2019t track the start and end index for each request, the backends often require the model to have additional input(s), batch input, that describe various information about the batch formed.\nhttps://docs.nvidia.com/deeplearning/triton-inference-server/user-guide/docs/user_guide/ragged_batching.html</p>\n</blockquote>\n<p>\u50cfONNX Runtime backend, TensorFlow backend, PyTorch backend, and TensorRT backend\uff0c\u5c06request inputs \u62fc\u63a5\u62101\u7ef4tensor\uff0c\u4f46\u662f\u8fd9\u4e2a\u62fc\u63a5\u7684tensor\u65e0\u6cd5\u8ddf\u8e2a\u6bcf\u4e2arequest\u7684start\u548cend index\uff0c\u6240\u4ee5\u9700\u8981\u989d\u5916\u7684batch input\u6765\u63cf\u8ff0batch\u7684\u6784\u6210\u3002</p>\n<p>\u53ef\u4ee5\u67e5\u770b\u5b9e\u73b0\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-7-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\"></a><span class=\"c1\">// https://github1s.com/triton-inference-server/onnxruntime_backend/blob/main/src/onnxruntime.cc</span>\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"proto3\">proto3<a class=\"headerlink\" href=\"#proto3\" title=\"Permanent link\">&para;</a></h3>\n<p>proto\u7684\u89c4\u5219\uff0cint32\u7c7b\u578b\u76840\u503c\u5e8f\u5217\u5316\u4e0d\u5360\u7528\u5b57\u8282\u6570\uff0c\u975e0\u7f16\u7801\u91c7\u7528variant\uff0c\u6570\u5b57\u6839\u636e\u5927\u5c0f\u4e0d\u540c\uff0c\u57282-5\u4e2a\u5b57\u8282\u53d8\u5316\u3002</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-8-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-11\">11</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\"></a><span class=\"n\">syntax</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">&quot;proto3&quot;</span><span class=\"p\">;</span>\n<a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\"></a>\n<a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\"></a><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"p\">.</span><span class=\"n\">proto</span><span class=\"p\">;</span>\n<a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\"></a><span class=\"n\">message</span><span class=\"w\"> </span><span class=\"n\">Image</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\"></a><span class=\"w\">    </span><span class=\"n\">int32</span><span class=\"w\"> </span><span class=\"n\">device_id</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\"></a><span class=\"w\">    </span><span class=\"n\">int32</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span>\n<a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\"></a><span class=\"w\">    </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">;</span>\n<a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\"></a><span class=\"n\">message</span><span class=\"w\"> </span><span class=\"n\">ImageSet</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\"></a><span class=\"w\">    </span><span class=\"n\">repeated</span><span class=\"w\"> </span><span class=\"n\">Image</span><span class=\"w\"> </span><span class=\"n\">images</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n\u9700\u8981\u6539\u6210\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-9-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-11\">11</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\"></a><span class=\"n\">syntax</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">&quot;proto3&quot;</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\"></a>\n<a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\"></a><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"p\">.</span><span class=\"n\">proto</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\"></a><span class=\"n\">message</span><span class=\"w\"> </span><span class=\"n\">Image</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\"></a><span class=\"w\">    </span><span class=\"n\">fixed32</span><span class=\"w\"> </span><span class=\"n\">device_id</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\"></a><span class=\"w\">    </span><span class=\"n\">fixed32</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\"></a><span class=\"w\">    </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-8\" name=\"__codelineno-9-8\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-9-9\" name=\"__codelineno-9-9\"></a><span class=\"n\">message</span><span class=\"w\"> </span><span class=\"n\">ImageSet</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-10\" name=\"__codelineno-9-10\"></a><span class=\"w\">    </span><span class=\"n\">repeated</span><span class=\"w\"> </span><span class=\"n\">Image</span><span class=\"w\"> </span><span class=\"n\">images</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-11\" name=\"__codelineno-9-11\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\nfixed32\u53ea\u80fd\u89e3\u51b3\u975e0\u503c\u7684\u5e8f\u5217\u5316\u540e\u957f\u5ea6\u4fdd\u6301\u4e00\u81f4\uff0c\u540c\u65f6\u9700\u8981\u907f\u514ddevice_id\u548cfd\u4f20\u90120\uff0c\u6bd4\u5982\u53ef\u4ee5\u5148\u52a01\uff0c\u4ece1\u5f00\u59cb\u3002\u4f20\u9012\u5230server\u540e\u518d\u51cf1\u3002</p>\n<h2 id=\"python-backend\u4f8b\u5b50\">python backend\u4f8b\u5b50<a class=\"headerlink\" href=\"#python-backend\u4f8b\u5b50\" title=\"Permanent link\">&para;</a></h2>\n<p>model.py\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Python</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-10-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-10-19\">19</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\"></a><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">triton_python_backend_utils</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nn\">pb_utils</span>\n<a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\"></a>\n<a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\"></a>\n<a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\"></a><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">TritonPythonModel</span><span class=\"p\">:</span>\n<a id=\"__codelineno-10-5\" name=\"__codelineno-10-5\"></a>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">initialize</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">):</span>\n<a id=\"__codelineno-10-6\" name=\"__codelineno-10-6\"></a>        <span class=\"k\">pass</span>\n<a id=\"__codelineno-10-7\" name=\"__codelineno-10-7\"></a>\n<a id=\"__codelineno-10-8\" name=\"__codelineno-10-8\"></a>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">requests</span><span class=\"p\">):</span>\n<a id=\"__codelineno-10-9\" name=\"__codelineno-10-9\"></a>        <span class=\"n\">num_requests</span> <span class=\"o\">=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">requests</span><span class=\"p\">)</span>\n<a id=\"__codelineno-10-10\" name=\"__codelineno-10-10\"></a>        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;Received a batch containing </span><span class=\"si\">{</span><span class=\"n\">num_requests</span><span class=\"si\">}</span><span class=\"s2\"> request(s)&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-10-11\" name=\"__codelineno-10-11\"></a>\n<a id=\"__codelineno-10-12\" name=\"__codelineno-10-12\"></a>        <span class=\"n\">responses</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n<a id=\"__codelineno-10-13\" name=\"__codelineno-10-13\"></a>            <span class=\"n\">pb_utils</span><span class=\"o\">.</span><span class=\"n\">InferenceResponse</span><span class=\"p\">(</span><span class=\"n\">output_tensors</span><span class=\"o\">=</span><span class=\"p\">[])</span>\n<a id=\"__codelineno-10-14\" name=\"__codelineno-10-14\"></a>            <span class=\"k\">for</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"n\">num_requests</span><span class=\"p\">)</span>\n<a id=\"__codelineno-10-15\" name=\"__codelineno-10-15\"></a>        <span class=\"p\">]</span>\n<a id=\"__codelineno-10-16\" name=\"__codelineno-10-16\"></a>        <span class=\"k\">return</span> <span class=\"n\">responses</span>\n<a id=\"__codelineno-10-17\" name=\"__codelineno-10-17\"></a>\n<a id=\"__codelineno-10-18\" name=\"__codelineno-10-18\"></a>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">finalize</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n<a id=\"__codelineno-10-19\" name=\"__codelineno-10-19\"></a>        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cleaning up...&quot;</span><span class=\"p\">)</span>\n</code></pre></div></td></tr></table></div></p>\n<p>client.py\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Python</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-11-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-39\">39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-40\">40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-41\">41</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-42\">42</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-43\">43</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-44\">44</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-45\">45</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-46\">46</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-11-47\">47</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\"></a><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">tritonclient.grpc</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nn\">grpcclient</span>\n<a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\"></a><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">numpy</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nn\">np</span>\n<a id=\"__codelineno-11-3\" name=\"__codelineno-11-3\"></a>\n<a id=\"__codelineno-11-4\" name=\"__codelineno-11-4\"></a>\n<a id=\"__codelineno-11-5\" name=\"__codelineno-11-5\"></a><span class=\"n\">triton_client</span> <span class=\"o\">=</span> <span class=\"n\">grpcclient</span><span class=\"o\">.</span><span class=\"n\">InferenceServerClient</span><span class=\"p\">(</span>\n<a id=\"__codelineno-11-6\" name=\"__codelineno-11-6\"></a>    <span class=\"n\">url</span><span class=\"o\">=</span><span class=\"s2\">&quot;localhost:8001&quot;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-11-7\" name=\"__codelineno-11-7\"></a>    <span class=\"n\">verbose</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n<a id=\"__codelineno-11-8\" name=\"__codelineno-11-8\"></a><span class=\"p\">)</span>\n<a id=\"__codelineno-11-9\" name=\"__codelineno-11-9\"></a>\n<a id=\"__codelineno-11-10\" name=\"__codelineno-11-10\"></a>\n<a id=\"__codelineno-11-11\" name=\"__codelineno-11-11\"></a><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">callback</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span> <span class=\"n\">error</span><span class=\"p\">):</span>\n<a id=\"__codelineno-11-12\" name=\"__codelineno-11-12\"></a>    <span class=\"k\">if</span> <span class=\"n\">error</span><span class=\"p\">:</span>\n<a id=\"__codelineno-11-13\" name=\"__codelineno-11-13\"></a>        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">error</span><span class=\"p\">)</span>\n<a id=\"__codelineno-11-14\" name=\"__codelineno-11-14\"></a>    <span class=\"k\">pass</span>\n<a id=\"__codelineno-11-15\" name=\"__codelineno-11-15\"></a>\n<a id=\"__codelineno-11-16\" name=\"__codelineno-11-16\"></a>\n<a id=\"__codelineno-11-17\" name=\"__codelineno-11-17\"></a><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">send_single_request</span><span class=\"p\">(</span><span class=\"n\">array</span><span class=\"p\">):</span>\n<a id=\"__codelineno-11-18\" name=\"__codelineno-11-18\"></a>    <span class=\"n\">inputs</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n<a id=\"__codelineno-11-19\" name=\"__codelineno-11-19\"></a>        <span class=\"n\">grpcclient</span><span class=\"o\">.</span><span class=\"n\">InferInput</span><span class=\"p\">(</span><span class=\"s2\">&quot;input_field&quot;</span><span class=\"p\">,</span> <span class=\"n\">array</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">,</span> <span class=\"s2\">&quot;FP32&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-11-20\" name=\"__codelineno-11-20\"></a>    <span class=\"p\">]</span>\n<a id=\"__codelineno-11-21\" name=\"__codelineno-11-21\"></a>    <span class=\"n\">inputs</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_data_from_numpy</span><span class=\"p\">(</span><span class=\"n\">array</span><span class=\"p\">)</span>\n<a id=\"__codelineno-11-22\" name=\"__codelineno-11-22\"></a>\n<a id=\"__codelineno-11-23\" name=\"__codelineno-11-23\"></a>    <span class=\"n\">triton_client</span><span class=\"o\">.</span><span class=\"n\">async_infer</span><span class=\"p\">(</span>\n<a id=\"__codelineno-11-24\" name=\"__codelineno-11-24\"></a>        <span class=\"n\">model_name</span><span class=\"o\">=</span><span class=\"s2\">&quot;python_batched_service&quot;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-11-25\" name=\"__codelineno-11-25\"></a>        <span class=\"n\">inputs</span><span class=\"o\">=</span><span class=\"n\">inputs</span><span class=\"p\">,</span>\n<a id=\"__codelineno-11-26\" name=\"__codelineno-11-26\"></a>        <span class=\"n\">model_version</span><span class=\"o\">=</span><span class=\"s2\">&quot;1&quot;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-11-27\" name=\"__codelineno-11-27\"></a>        <span class=\"n\">outputs</span><span class=\"o\">=</span><span class=\"p\">[],</span>\n<a id=\"__codelineno-11-28\" name=\"__codelineno-11-28\"></a>        <span class=\"n\">callback</span><span class=\"o\">=</span><span class=\"n\">callback</span><span class=\"p\">,</span>\n<a id=\"__codelineno-11-29\" name=\"__codelineno-11-29\"></a>    <span class=\"p\">)</span>\n<a id=\"__codelineno-11-30\" name=\"__codelineno-11-30\"></a>\n<a id=\"__codelineno-11-31\" name=\"__codelineno-11-31\"></a><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">send_many_requests</span><span class=\"p\">(</span><span class=\"n\">input_sizes</span><span class=\"p\">):</span>\n<a id=\"__codelineno-11-32\" name=\"__codelineno-11-32\"></a>    <span class=\"k\">for</span> <span class=\"n\">ix</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"mi\">200</span><span class=\"p\">):</span>\n<a id=\"__codelineno-11-33\" name=\"__codelineno-11-33\"></a>        <span class=\"n\">size</span> <span class=\"o\">=</span> <span class=\"n\">input_sizes</span><span class=\"p\">[</span><span class=\"n\">ix</span> <span class=\"o\">%</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">input_sizes</span><span class=\"p\">)]</span>\n<a id=\"__codelineno-11-34\" name=\"__codelineno-11-34\"></a>        <span class=\"n\">array</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">random</span><span class=\"o\">.</span><span class=\"n\">rand</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">astype</span><span class=\"p\">(</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">float32</span><span class=\"p\">)</span>\n<a id=\"__codelineno-11-35\" name=\"__codelineno-11-35\"></a>        <span class=\"n\">send_single_request</span><span class=\"p\">(</span><span class=\"n\">array</span><span class=\"o\">=</span><span class=\"n\">array</span><span class=\"p\">)</span>\n<a id=\"__codelineno-11-36\" name=\"__codelineno-11-36\"></a>\n<a id=\"__codelineno-11-37\" name=\"__codelineno-11-37\"></a>\n<a id=\"__codelineno-11-38\" name=\"__codelineno-11-38\"></a><span class=\"k\">if</span> <span class=\"vm\">__name__</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;__main__&quot;</span><span class=\"p\">:</span>\n<a id=\"__codelineno-11-39\" name=\"__codelineno-11-39\"></a>    <span class=\"n\">send_many_requests</span><span class=\"p\">(</span><span class=\"n\">input_sizes</span><span class=\"o\">=</span><span class=\"p\">[</span>\n<a id=\"__codelineno-11-40\" name=\"__codelineno-11-40\"></a>        <span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">20</span><span class=\"p\">,),</span>\n<a id=\"__codelineno-11-41\" name=\"__codelineno-11-41\"></a>    <span class=\"p\">])</span>\n<a id=\"__codelineno-11-42\" name=\"__codelineno-11-42\"></a>\n<a id=\"__codelineno-11-43\" name=\"__codelineno-11-43\"></a>    <span class=\"n\">send_many_requests</span><span class=\"p\">(</span><span class=\"n\">input_sizes</span><span class=\"o\">=</span><span class=\"p\">[</span>\n<a id=\"__codelineno-11-44\" name=\"__codelineno-11-44\"></a>        <span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">20</span><span class=\"p\">,),</span>\n<a id=\"__codelineno-11-45\" name=\"__codelineno-11-45\"></a>        <span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">40</span><span class=\"p\">),</span>\n<a id=\"__codelineno-11-46\" name=\"__codelineno-11-46\"></a>        <span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">60</span><span class=\"p\">),</span>\n<a id=\"__codelineno-11-47\" name=\"__codelineno-11-47\"></a>    <span class=\"p\">])</span>\n</code></pre></div></td></tr></table></div></p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/sglang\u63a8\u7406\u4f7f\u7528\u4e4b\u73af\u5883\u914d\u7f6e/\" target=\"_blank\">sglang\u63a8\u7406\u4f7f\u7528\u4e4b\u73af\u5883\u914d\u7f6e</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/\u4ecedeepseek\u5f00\u6e90\u5e933fs\u4e2d\u5b66\u4e60fuse\u7684\u4f7f\u7528-\u5982\u4f55\u5f00\u53d1\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e00/\" target=\"_blank\">\u4eceDeepseek\u5f00\u6e90\u5e933FS\u4e2d\u5b66\u4e60fuse\u7684\u4f7f\u7528-\u5982\u4f55\u5f00\u53d1\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff08\u4e00\uff09</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-06-21T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/tritonserver-ratelimiter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/",
            "url": "https://github.com/KenForever1/blog/tritonserver-ratelimiter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/",
            "title": "tritonserver-ratelimiter\u6e90\u7801\u5206\u6790",
            "content_html": "<!-- more -->\n<h2 id=\"tritonserver\u8c03\u5ea6\u5668\">tritonserver\u8c03\u5ea6\u5668<a class=\"headerlink\" href=\"#tritonserver\u8c03\u5ea6\u5668\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e09\u79cd\u8c03\u5ea6\u5668\uff1a</p>\n<ul>\n<li>\n<p>emsemble schedulor</p>\n</li>\n<li>\n<p>dynamicbatch scheduler</p>\n</li>\n<li>\n<p>sequece scheduler</p>\n</li>\n</ul>\n<p>\u4ee5metric\u4e3a\u5165\u53e3\u5bf9\u6e90\u7801\u8fdb\u884c\u5206\u6790\uff0c</p>\n<p>metric\u63d0\u4f9b\u4e86http\u63a5\u53e3\uff0c\u7edf\u8ba1\u4e86nv_inference_compute_infer_duration_us\u548cnv_inference_queue_duration_us\u6307\u6807\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Python</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-4\">4</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"n\">count_pattern</span> <span class=\"o\">=</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s1\">&#39;nv_inference_count\\{model=&quot;([^&quot;]+)&quot;.*\\} (\\d+)&#39;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a><span class=\"n\">duration_pattern</span> <span class=\"o\">=</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s1\">&#39;nv_inference_request_duration_us\\{model=&quot;([^&quot;]+)&quot;.*\\} (\\d+)&#39;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a><span class=\"n\">compute_duration_pattern</span> <span class=\"o\">=</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s1\">&#39;nv_inference_compute_infer_duration_us\\{model=&quot;([^&quot;]+)&quot;.*\\} (\\d+)&#39;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\"></a><span class=\"n\">queue_duration_pattern</span> <span class=\"o\">=</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s1\">&#39;nv_inference_queue_duration_us\\{model=&quot;([^&quot;]+)&quot;.*\\} (\\d+)&#39;</span><span class=\"p\">)</span>\n</code></pre></div></td></tr></table></div>\n<h2 id=\"metric\u7edf\u8ba1nv_inference_queue_duration_us\u548cnv_inference_compute_infer_duration_us\u6307\u6807\">metric\u7edf\u8ba1nv_inference_queue_duration_us\u548cnv_inference_compute_infer_duration_us\u6307\u6807<a class=\"headerlink\" href=\"#metric\u7edf\u8ba1nv_inference_queue_duration_us\u548cnv_inference_compute_infer_duration_us\u6307\u6807\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6ce8\u518c\u6307\u6807\u5230prometheus_registry_\u4e2d\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-12\">12</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"w\">      </span><span class=\"n\">inf_request_duration_us_family_</span><span class=\"p\">(</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"w\">          </span><span class=\"n\">prometheus</span><span class=\"o\">::</span><span class=\"n\">BuildCounter</span><span class=\"p\">()</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a><span class=\"w\">              </span><span class=\"p\">.</span><span class=\"n\">Name</span><span class=\"p\">(</span><span class=\"s\">&quot;nv_inference_request_duration_us&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\"></a><span class=\"w\">              </span><span class=\"p\">.</span><span class=\"n\">Help</span><span class=\"p\">(</span><span class=\"s\">&quot;Cumulative inference request duration in microseconds &quot;</span>\n<a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\"></a><span class=\"w\">                    </span><span class=\"s\">&quot;(includes cached requests)&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\"></a><span class=\"w\">              </span><span class=\"p\">.</span><span class=\"n\">Register</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">registry_</span><span class=\"p\">)),</span>\n<a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\"></a><span class=\"w\">      </span><span class=\"n\">inf_queue_duration_us_family_</span><span class=\"p\">(</span>\n<a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\"></a><span class=\"w\">          </span><span class=\"n\">prometheus</span><span class=\"o\">::</span><span class=\"n\">BuildCounter</span><span class=\"p\">()</span>\n<a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\"></a><span class=\"w\">              </span><span class=\"p\">.</span><span class=\"n\">Name</span><span class=\"p\">(</span><span class=\"s\">&quot;nv_inference_queue_duration_us&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\"></a><span class=\"w\">              </span><span class=\"p\">.</span><span class=\"n\">Help</span><span class=\"p\">(</span><span class=\"s\">&quot;Cumulative inference queuing duration in microseconds &quot;</span>\n<a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\"></a><span class=\"w\">                    </span><span class=\"s\">&quot;(includes cached requests)&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\"></a><span class=\"w\">              </span><span class=\"p\">.</span><span class=\"n\">Register</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">registry_</span><span class=\"p\">)),</span>\n</code></pre></div></td></tr></table></div></p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"n\">counter_families_</span><span class=\"p\">[</span><span class=\"s\">&quot;queue_duration&quot;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a><span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"n\">Metrics</span><span class=\"o\">::</span><span class=\"n\">FamilyInferenceQueueDuration</span><span class=\"p\">();</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5168\u5c40\u641c\u7d22\u201cqueue_duration\u201d\u627e\u5230\u201cuint64_t queue_duration_ns_;\u201d\u5728infer_stats.h\u4e2d\u3002\u8fdb\u800c\u53ef\u4ee5\u627e\u5230\u5982\u4f55\u7edf\u8ba1\u7684\u4e86\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">queue_duration_ns</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">compute_start_ns</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">queue_start_ns</span><span class=\"p\">;</span>\n</code></pre></div></td></tr></table></div></p>\n<h2 id=\"dynamicbatch-scheduler\u4e2d\u8c03\u5ea6\u6d41\u7a0b\">Dynamicbatch scheduler\u4e2d\u8c03\u5ea6\u6d41\u7a0b<a class=\"headerlink\" href=\"#dynamicbatch-scheduler\u4e2d\u8c03\u5ea6\u6d41\u7a0b\" title=\"Permanent link\">&para;</a></h2>\n<p>RateLimiter::EnqueuePayload\uff1aDynamicBatchScheduler::BatcherThread\u7ebf\u7a0b\u8c03\u5ea6\u3002cv_.wait_for\uff0c\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2cv_\u627e\u5230\u5728\u54ea\u513f\u653e\u5165\u8d44\u6e90\u7684\uff0c\u4e5f\u5c31\u662fcv_.notify_one()\u3002DynamicBatchScheduler::Enqueue\u51fd\u6570\u4e2d\uff0c\u5c06requests Enqueue\u3002</p>\n<p>\u524d\u9762\u8bf4\u7684metric\u7edf\u8ba1\u7684\u5165\u961f\u65f6\u95f4\u5c31\u662f\u5728DynamicBatchScheduler::Enqueue\u51fd\u6570\u51fd\u6570\u8fdb\u5165\u65f6\u521d\u59cb\u5316\u7684\uff0c request-&gt;CaptureQueueStartNs()\u3002(Emsemble\u8c03\u5ea6\u4e2d\u4e5f\u6709\u8fd9\u4e2aEnqueue\u64cd\u4f5c\uff0c\u521d\u59cb\u5316enqueue\u65f6\u95f4\u70b9)\u3002</p>\n<p>SchedulePayload\uff1a\u5c06playload\u653e\u5165payload_queue-&gt;queue_\u548cpayload_queue-&gt;specific_queues_\uff08\u4e0e\u5177\u4f53\u7684model_instance\u76f8\u5173\uff09\u3002</p>\n<p>RateLimiter::DequeuePayload\uff1aTritonModelInstance::TritonBackendThread::BackendThread()\u6a21\u578b\u5b9e\u4f8b\u7ebf\u7a0b\u8c03\u7528\uff0c\u7531\u4ecepayload_queue-&gt;queue_-&gt;Dequeue\u83b7\u53d6payload\uff0c\u6216\u8005\u5bf9playload\u4e2d\u7684requests\u8fdb\u884c<strong>merge\uff08batch\u8c03\u5ea6\uff09</strong>\u3002</p>\n<p>RateLimiter\u4e2d\u7684merge\u4f1a\u6839\u636e\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684<strong>\u6700\u5927batch\u6570\u548c\u7b49\u5f85\u65f6\u95f4</strong>\u8fdb\u884cmerge\u3002</p>\n<h2 id=\"esemble-scheduler\u4e2d\u8c03\u5ea6\u6d41\u7a0b\">Esemble scheduler\u4e2d\u8c03\u5ea6\u6d41\u7a0b<a class=\"headerlink\" href=\"#esemble-scheduler\u4e2d\u8c03\u5ea6\u6d41\u7a0b\" title=\"Permanent link\">&para;</a></h2>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-11\">11</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a><span class=\"kt\">void</span>\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a><span class=\"nf\">EnsembleContext::Proceed</span><span class=\"p\">(</span>\n<a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">shared_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">EnsembleContext</span><span class=\"o\">&gt;&amp;</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"p\">,</span>\n<a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">Step</span><span class=\"o\">&gt;&amp;</span><span class=\"w\"> </span><span class=\"n\">completed_step</span><span class=\"p\">)</span>\n<a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\"></a><span class=\"p\">{</span>\n<a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\"></a><span class=\"w\">  </span><span class=\"n\">StepList</span><span class=\"w\"> </span><span class=\"n\">ready_steps</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\"></a><span class=\"w\">  </span><span class=\"n\">Status</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"o\">-&gt;</span><span class=\"n\">PrepareSteps</span><span class=\"p\">(</span><span class=\"n\">completed_step</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">ready_steps</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"p\">.</span><span class=\"n\">IsOk</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\"></a><span class=\"w\">    </span><span class=\"n\">ScheduleSteps</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">move</span><span class=\"p\">(</span><span class=\"n\">ready_steps</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/tritonserver-multibatch\u6e90\u7801\u5206\u6790/\" target=\"_blank\">tritonserver-multibatch\u6e90\u7801\u5206\u6790</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898/\" target=\"_blank\">C++\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-06-21T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/tritonserver%E4%B8%ADshm%E4%BD%BF%E7%94%A8%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/",
            "url": "https://github.com/KenForever1/blog/tritonserver%E4%B8%ADshm%E4%BD%BF%E7%94%A8%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/",
            "title": "Tritonserver\u4e2dshm\u4f7f\u7528\u6e90\u4ee3\u7801\u5206\u6790",
            "content_html": "<!-- more -->\n\n<h2 id=\"tritonserver\u4e2dshm\u4f7f\u7528\u6e90\u4ee3\u7801\u5206\u6790\">Tritonserver\u4e2dshm\u4f7f\u7528\u6e90\u4ee3\u7801\u5206\u6790<a class=\"headerlink\" href=\"#tritonserver\u4e2dshm\u4f7f\u7528\u6e90\u4ee3\u7801\u5206\u6790\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4ece\u6e90\u7801\u63a2\u7d22Tritonserver\u4e2dshm\u5982\u4f55\u4f7f\u7528\uff0c\u5305\u62ecsystem shm\u548ccuda ipc shm\u3002\u4e00\u4e2ashm req\u5982\u4f55\u4f20\u9012\u7ed9server\uff0c\u7136\u540e\u5728backend\u4e2d\u4f7f\u7528\u3002\n\u5728server\u9879\u76ee\u4e2d\uff0c\u521d\u59cb\u5316\u4e86shmmanager\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\">3</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"c1\">// tritonserver/server/src/main.cc</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a><span class=\"c1\">// Manager for shared memory blocks.</span>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">shm_manager</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">make_shared</span><span class=\"o\">&lt;</span><span class=\"n\">triton</span><span class=\"o\">::</span><span class=\"n\">server</span><span class=\"o\">::</span><span class=\"n\">SharedMemoryManager</span><span class=\"o\">&gt;</span><span class=\"p\">();</span>\n</code></pre></div></td></tr></table></div>\n\u7136\u540e\u521d\u59cb\u5316GRPC server\uff0c\u5c06shm_manager\u4f20\u5165\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-4\">4</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"c1\">// Start the HTTP, GRPC, and metrics endpoints.</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">StartEndpoints</span><span class=\"p\">(</span><span class=\"n\">server</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">trace_manager</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shm_manager</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a><span class=\"n\">exit</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n\u5728grpc server\u4e2d\uff0c\u91c7\u7528\u5f02\u6b65\u65b9\u5f0f\u5904\u7406\u4e0d\u540c\u7c7b\u578b\u7684\u8bf7\u6c42\u3002\u5206\u4e3a\u4e09\u79cd\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-7\">7</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"c1\">// server/src/grpc/grpc_server.cc</span>\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a><span class=\"c1\">// common\u8bf7\u6c42\u961f\u5217</span>\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;::</span><span class=\"n\">grpc</span><span class=\"o\">::</span><span class=\"n\">ServerCompletionQueue</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">common_cq_</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a><span class=\"c1\">// \u6a21\u578b\u63a8\u7406\u8bf7\u6c42\u961f\u5217</span>\n<a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;::</span><span class=\"n\">grpc</span><span class=\"o\">::</span><span class=\"n\">ServerCompletionQueue</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">model_infer_cq_</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\"></a><span class=\"c1\">// \u6a21\u578b\u6d41\u5f0f\u63a8\u7406\u8bf7\u6c42\u961f\u5217</span>\n<a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;::</span><span class=\"n\">grpc</span><span class=\"o\">::</span><span class=\"n\">ServerCompletionQueue</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">model_stream_infer_cq_</span><span class=\"p\">;</span>\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"common-\u8bf7\u6c42\u5904\u7406\">common \u8bf7\u6c42\u5904\u7406<a class=\"headerlink\" href=\"#common-\u8bf7\u6c42\u5904\u7406\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728common\u8bf7\u6c42\u4e2d\uff0c\u6bcf\u4e2a\u7c7b\u578b\u5c31\u662f\u4e00\u4e2aCommonCallData\u7c7b\u578b\uff0c\u8be5\u7c7b\u578b\u5305\u62ec\u4e86\u8bf7\u6c42\u7684\u56de\u8c03\u51fd\u6570\u3002\u5728thread\u4e2d\u8c03\u7528\u56de\u8c03\u51fd\u6570\uff0c\u5904\u7406\u8bf7\u6c42\u3002\ncommonhandler\u4e2d\u6ce8\u518c\u4e86\u5982\u4e0bcommon\u8bf7\u6c42\u7c7b\u578b\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-19\">19</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterServerLive</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterServerReady</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterHealthCheck</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterModelReady</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterServerMetadata</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterModelMetadata</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterModelConfig</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterModelStatistics</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterTrace</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterLogging</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterSystemSharedMemoryStatus</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterSystemSharedMemoryRegister</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterSystemSharedMemoryUnregister</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterCudaSharedMemoryStatus</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterCudaSharedMemoryRegister</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterCudaSharedMemoryUnregister</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterRepositoryIndex</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterRepositoryModelLoad</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">RegisterRepositoryModelUnload</span><span class=\"p\">();</span>\n</code></pre></div></td></tr></table></div>\ngpu ipc shm\u548csys shm\u5c31\u5728\u5176\u4e2d\u7684\u51fd\u6570\u6ce8\u518c\u4e86, \u901a\u8fc7shm_manager\u6ce8\u518c\u7ba1\u7406name, raw_handle, byte_size, device_id\u7b49\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-39\">39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-40\">40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-41\">41</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-42\">42</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-43\">43</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-44\">44</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-45\">45</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-46\">46</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-47\">47</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-48\">48</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-49\">49</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-50\">50</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a><span class=\"kt\">void</span>\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a><span class=\"nf\">CommonHandler::RegisterCudaSharedMemoryRegister</span><span class=\"p\">()</span>\n<a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\"></a><span class=\"p\">{</span>\n<a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\"></a><span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">OnRegisterCudaSharedMemoryRegister</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\"></a><span class=\"w\">      </span><span class=\"p\">[</span><span class=\"k\">this</span><span class=\"p\">](</span>\n<a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\"></a><span class=\"w\">          </span><span class=\"o\">::</span><span class=\"n\">grpc</span><span class=\"o\">::</span><span class=\"n\">ServerContext</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"p\">,</span>\n<a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\"></a><span class=\"w\">          </span><span class=\"n\">inference</span><span class=\"o\">::</span><span class=\"n\">CudaSharedMemoryRegisterRequest</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"p\">,</span>\n<a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\"></a><span class=\"w\">          </span><span class=\"o\">::</span><span class=\"n\">grpc</span><span class=\"o\">::</span><span class=\"n\">ServerAsyncResponseWriter</span><span class=\"o\">&lt;</span>\n<a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\"></a><span class=\"w\">              </span><span class=\"n\">inference</span><span class=\"o\">::</span><span class=\"n\">CudaSharedMemoryRegisterResponse</span><span class=\"o\">&gt;*</span><span class=\"w\"> </span><span class=\"n\">responder</span><span class=\"p\">,</span>\n<a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\"></a><span class=\"w\">          </span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\"></a><span class=\"w\">        </span><span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">service_</span><span class=\"o\">-&gt;</span><span class=\"n\">RequestCudaSharedMemoryRegister</span><span class=\"p\">(</span>\n<a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\"></a><span class=\"w\">            </span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">responder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">cq_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">cq_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\"></a><span class=\"w\">      </span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\"></a>\n<a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\"></a><span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">OnExecuteCudaSharedMemoryRegister</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\"></a><span class=\"w\">      </span><span class=\"p\">[</span><span class=\"k\">this</span><span class=\"p\">](</span>\n<a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\"></a><span class=\"w\">          </span><span class=\"n\">inference</span><span class=\"o\">::</span><span class=\"n\">CudaSharedMemoryRegisterRequest</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"p\">,</span>\n<a id=\"__codelineno-4-18\" name=\"__codelineno-4-18\"></a><span class=\"w\">          </span><span class=\"n\">inference</span><span class=\"o\">::</span><span class=\"n\">CudaSharedMemoryRegisterResponse</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">response</span><span class=\"p\">,</span>\n<a id=\"__codelineno-4-19\" name=\"__codelineno-4-19\"></a><span class=\"w\">          </span><span class=\"o\">::</span><span class=\"n\">grpc</span><span class=\"o\">::</span><span class=\"n\">Status</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-20\" name=\"__codelineno-4-20\"></a><span class=\"w\">        </span><span class=\"n\">TRITONSERVER_Error</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-21\" name=\"__codelineno-4-21\"></a><span class=\"cp\">#ifdef TRITON_ENABLE_GPU</span>\n<a id=\"__codelineno-4-22\" name=\"__codelineno-4-22\"></a><span class=\"w\">        </span><span class=\"n\">err</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">shm_manager_</span><span class=\"o\">-&gt;</span><span class=\"n\">RegisterCUDASharedMemory</span><span class=\"p\">(</span>\n<a id=\"__codelineno-4-23\" name=\"__codelineno-4-23\"></a><span class=\"w\">            </span><span class=\"n\">request</span><span class=\"p\">.</span><span class=\"n\">name</span><span class=\"p\">(),</span>\n<a id=\"__codelineno-4-24\" name=\"__codelineno-4-24\"></a><span class=\"w\">            </span><span class=\"k\">reinterpret_cast</span><span class=\"o\">&lt;</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">cudaIpcMemHandle_t</span><span class=\"o\">*&gt;</span><span class=\"p\">(</span>\n<a id=\"__codelineno-4-25\" name=\"__codelineno-4-25\"></a><span class=\"w\">                </span><span class=\"n\">request</span><span class=\"p\">.</span><span class=\"n\">raw_handle</span><span class=\"p\">().</span><span class=\"n\">c_str</span><span class=\"p\">()),</span>\n<a id=\"__codelineno-4-26\" name=\"__codelineno-4-26\"></a><span class=\"w\">            </span><span class=\"n\">request</span><span class=\"p\">.</span><span class=\"n\">byte_size</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"p\">.</span><span class=\"n\">device_id</span><span class=\"p\">());</span>\n<a id=\"__codelineno-4-27\" name=\"__codelineno-4-27\"></a><span class=\"cp\">#else</span>\n<a id=\"__codelineno-4-28\" name=\"__codelineno-4-28\"></a><span class=\"w\">        </span><span class=\"n\">err</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TRITONSERVER_ErrorNew</span><span class=\"p\">(</span>\n<a id=\"__codelineno-4-29\" name=\"__codelineno-4-29\"></a><span class=\"w\">            </span><span class=\"n\">TRITONSERVER_ERROR_INVALID_ARG</span><span class=\"p\">,</span>\n<a id=\"__codelineno-4-30\" name=\"__codelineno-4-30\"></a><span class=\"w\">            </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"p\">(</span>\n<a id=\"__codelineno-4-31\" name=\"__codelineno-4-31\"></a><span class=\"w\">                </span><span class=\"s\">&quot;failed to register CUDA shared memory region: &#39;&quot;</span><span class=\"w\"> </span><span class=\"o\">+</span>\n<a id=\"__codelineno-4-32\" name=\"__codelineno-4-32\"></a><span class=\"w\">                </span><span class=\"n\">request</span><span class=\"p\">.</span><span class=\"n\">name</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"s\">&quot;&#39;, GPUs not supported&quot;</span><span class=\"p\">)</span>\n<a id=\"__codelineno-4-33\" name=\"__codelineno-4-33\"></a><span class=\"w\">                </span><span class=\"p\">.</span><span class=\"n\">c_str</span><span class=\"p\">());</span>\n<a id=\"__codelineno-4-34\" name=\"__codelineno-4-34\"></a><span class=\"cp\">#endif  </span><span class=\"c1\">// TRITON_ENABLE_GPU</span>\n<a id=\"__codelineno-4-35\" name=\"__codelineno-4-35\"></a>\n<a id=\"__codelineno-4-36\" name=\"__codelineno-4-36\"></a><span class=\"w\">        </span><span class=\"n\">GrpcStatusUtil</span><span class=\"o\">::</span><span class=\"n\">Create</span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-37\" name=\"__codelineno-4-37\"></a><span class=\"w\">        </span><span class=\"n\">TRITONSERVER_ErrorDelete</span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-38\" name=\"__codelineno-4-38\"></a><span class=\"w\">      </span><span class=\"p\">};</span>\n<a id=\"__codelineno-4-39\" name=\"__codelineno-4-39\"></a>\n<a id=\"__codelineno-4-40\" name=\"__codelineno-4-40\"></a><span class=\"w\">  </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">pair</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"o\">&gt;&amp;</span><span class=\"w\"> </span><span class=\"n\">restricted_kv</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-4-41\" name=\"__codelineno-4-41\"></a><span class=\"w\">      </span><span class=\"n\">restricted_keys_</span><span class=\"p\">.</span><span class=\"n\">Get</span><span class=\"p\">(</span><span class=\"n\">RestrictedCategory</span><span class=\"o\">::</span><span class=\"n\">SHARED_MEMORY</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-42\" name=\"__codelineno-4-42\"></a><span class=\"w\">  </span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"n\">CommonCallData</span><span class=\"o\">&lt;</span>\n<a id=\"__codelineno-4-43\" name=\"__codelineno-4-43\"></a><span class=\"w\">      </span><span class=\"o\">::</span><span class=\"n\">grpc</span><span class=\"o\">::</span><span class=\"n\">ServerAsyncResponseWriter</span><span class=\"o\">&lt;</span>\n<a id=\"__codelineno-4-44\" name=\"__codelineno-4-44\"></a><span class=\"w\">          </span><span class=\"n\">inference</span><span class=\"o\">::</span><span class=\"n\">CudaSharedMemoryRegisterResponse</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<a id=\"__codelineno-4-45\" name=\"__codelineno-4-45\"></a><span class=\"w\">      </span><span class=\"n\">inference</span><span class=\"o\">::</span><span class=\"n\">CudaSharedMemoryRegisterRequest</span><span class=\"p\">,</span>\n<a id=\"__codelineno-4-46\" name=\"__codelineno-4-46\"></a><span class=\"w\">      </span><span class=\"n\">inference</span><span class=\"o\">::</span><span class=\"n\">CudaSharedMemoryRegisterResponse</span><span class=\"o\">&gt;</span><span class=\"p\">(</span>\n<a id=\"__codelineno-4-47\" name=\"__codelineno-4-47\"></a><span class=\"w\">      </span><span class=\"s\">&quot;CudaSharedMemoryRegister&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OnRegisterCudaSharedMemoryRegister</span><span class=\"p\">,</span>\n<a id=\"__codelineno-4-48\" name=\"__codelineno-4-48\"></a><span class=\"w\">      </span><span class=\"n\">OnExecuteCudaSharedMemoryRegister</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"w\"> </span><span class=\"cm\">/* async */</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cq_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">restricted_kv</span><span class=\"p\">,</span>\n<a id=\"__codelineno-4-49\" name=\"__codelineno-4-49\"></a><span class=\"w\">      </span><span class=\"n\">response_delay_</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-50\" name=\"__codelineno-4-50\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<h2 id=\"infer-grpc\u8bf7\u6c42\">infer grpc\u8bf7\u6c42<a class=\"headerlink\" href=\"#infer-grpc\u8bf7\u6c42\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"request-\u5904\u7406\">request \u5904\u7406<a class=\"headerlink\" href=\"#request-\u5904\u7406\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-22\">22</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a><span class=\"n\">ModelInferHandler</span><span class=\"o\">::</span><span class=\"n\">Execute</span><span class=\"p\">(</span><span class=\"n\">InferHandler</span><span class=\"o\">::</span><span class=\"n\">State</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"p\">){</span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a><span class=\"w\">  </span><span class=\"c1\">// Maintain shared pointers(read-only reference) to the shared memory block&#39;s</span>\n<a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\"></a><span class=\"w\">  </span><span class=\"c1\">// information for the shared memory regions used by the request. These</span>\n<a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\"></a><span class=\"w\">  </span><span class=\"c1\">// pointers will automatically increase the usage count, preventing</span>\n<a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\"></a><span class=\"w\">  </span><span class=\"c1\">// unregistration of the shared memory. This vector must be cleared in the</span>\n<a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\"></a><span class=\"w\">  </span><span class=\"c1\">// `InferResponseComplete` callback (after inference) to decrease the count</span>\n<a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\"></a><span class=\"w\">  </span><span class=\"c1\">// and permit unregistration. The vector will be included in</span>\n<a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\"></a><span class=\"w\">  </span><span class=\"c1\">// `response_release_payload` for the callback.</span>\n<a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\"></a><span class=\"w\">  </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">vector</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">shared_ptr</span><span class=\"o\">&lt;</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">SharedMemoryManager</span><span class=\"o\">::</span><span class=\"n\">SharedMemoryInfo</span><span class=\"o\">&gt;&gt;</span>\n<a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\"></a><span class=\"w\">      </span><span class=\"n\">shm_regions_info</span><span class=\"p\">;</span>\n<a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\"></a>\n<a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\"></a><span class=\"w\">    </span><span class=\"n\">err</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">InferGRPCToInput</span><span class=\"p\">(</span>\n<a id=\"__codelineno-5-14\" name=\"__codelineno-5-14\"></a><span class=\"w\">        </span><span class=\"n\">tritonserver_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shm_manager_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">serialized_data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">irequest</span><span class=\"p\">,</span>\n<a id=\"__codelineno-5-15\" name=\"__codelineno-5-15\"></a><span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"n\">shm_regions_info</span><span class=\"p\">);</span>\n<a id=\"__codelineno-5-16\" name=\"__codelineno-5-16\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-17\" name=\"__codelineno-5-17\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-5-18\" name=\"__codelineno-5-18\"></a><span class=\"w\">    </span><span class=\"n\">err</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">InferAllocatorPayload</span><span class=\"o\">&lt;</span><span class=\"n\">inference</span><span class=\"o\">::</span><span class=\"n\">ModelInferResponse</span><span class=\"o\">&gt;</span><span class=\"p\">(</span>\n<a id=\"__codelineno-5-19\" name=\"__codelineno-5-19\"></a><span class=\"w\">        </span><span class=\"n\">tritonserver_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shm_manager_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">move</span><span class=\"p\">(</span><span class=\"n\">serialized_data</span><span class=\"p\">),</span>\n<a id=\"__codelineno-5-20\" name=\"__codelineno-5-20\"></a><span class=\"w\">        </span><span class=\"n\">response_queue</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">state</span><span class=\"o\">-&gt;</span><span class=\"n\">alloc_payload_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">shm_regions_info</span><span class=\"p\">);</span>\n<a id=\"__codelineno-5-21\" name=\"__codelineno-5-21\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-5-22\" name=\"__codelineno-5-22\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<p>\u5728InferGRPCToInput\u5982\u679creq\u662fshm\u4fe1\u606f\u7684\uff0c\u5c31\u4f1a\u83b7\u53d6shm\u4fe1\u606f\u3002\u7136\u540e\u5c06shm\u4fe1\u606f\u7ed1\u5b9a\u5230req\u7684BufferAttributes\u4e2d\u3002\u7136\u540e\u8c03\u7528infer\uff0c\u8df3\u8f6c\u7684schedule\u6a21\u5757\uff08\u62bd\u8c61\u7c7b\uff09\uff0c\u518d\u4ea4\u7ed9\u5177\u4f53\u7684dynamic scheduler\u7b49\u8c03\u5ea6\u3002\u5c06request\u5305\u88c5\u6210payload\uff0c\u6839\u636e\u8c03\u5ea6\u7b56\u7565\u7ed9\u5230model_instance\u3002\u7136\u540e\u5c31\u53ef\u4ee5\u8c03\u5ea6\u5230\u5b9e\u73b0\u7684\u5177\u4f53infer backend\u903b\u8f91\u4e86\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-26\">26</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a><span class=\"kt\">void</span>\n<a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\"></a><span class=\"nf\">TritonModelInstance::Execute</span><span class=\"p\">(</span>\n<a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">vector</span><span class=\"o\">&lt;</span><span class=\"n\">TRITONBACKEND_Request</span><span class=\"o\">*&gt;&amp;</span><span class=\"w\"> </span><span class=\"n\">triton_requests</span><span class=\"p\">)</span>\n<a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\"></a><span class=\"p\">{</span>\n<a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\"></a><span class=\"w\">  </span><span class=\"n\">TRITONBACKEND_ModelInstance</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">triton_model_instance</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\"></a><span class=\"w\">      </span><span class=\"k\">reinterpret_cast</span><span class=\"o\">&lt;</span><span class=\"n\">TRITONBACKEND_ModelInstance</span><span class=\"o\">*&gt;</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\"></a><span class=\"w\">  </span><span class=\"n\">TritonBackend</span><span class=\"o\">::</span><span class=\"n\">TritonModelInstanceExecFn_t</span><span class=\"w\"> </span><span class=\"n\">inst_exec_fn</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\"></a><span class=\"w\">      </span><span class=\"n\">model_</span><span class=\"o\">-&gt;</span><span class=\"n\">Backend</span><span class=\"p\">()</span><span class=\"o\">-&gt;</span><span class=\"n\">ModelInstanceExecFn</span><span class=\"p\">();</span>\n<a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\"></a>\n<a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\"></a><span class=\"w\">  </span><span class=\"c1\">// If there is an error then we retain ownership of &#39;requests&#39;</span>\n<a id=\"__codelineno-6-11\" name=\"__codelineno-6-11\"></a><span class=\"w\">  </span><span class=\"c1\">// and must send error responses.</span>\n<a id=\"__codelineno-6-12\" name=\"__codelineno-6-12\"></a><span class=\"w\">  </span><span class=\"n\">TRITONSERVER_Error</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">inst_exec_fn</span><span class=\"p\">(</span>\n<a id=\"__codelineno-6-13\" name=\"__codelineno-6-13\"></a><span class=\"w\">      </span><span class=\"n\">triton_model_instance</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">triton_requests</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">triton_requests</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">());</span>\n<a id=\"__codelineno-6-14\" name=\"__codelineno-6-14\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-15\" name=\"__codelineno-6-15\"></a><span class=\"w\">    </span><span class=\"n\">Status</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Status</span><span class=\"p\">(</span>\n<a id=\"__codelineno-6-16\" name=\"__codelineno-6-16\"></a><span class=\"w\">        </span><span class=\"n\">TritonCodeToStatusCode</span><span class=\"p\">(</span><span class=\"n\">TRITONSERVER_ErrorCode</span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">)),</span>\n<a id=\"__codelineno-6-17\" name=\"__codelineno-6-17\"></a><span class=\"w\">        </span><span class=\"n\">TRITONSERVER_ErrorMessage</span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">));</span>\n<a id=\"__codelineno-6-18\" name=\"__codelineno-6-18\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">TRITONBACKEND_Request</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">tr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">triton_requests</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-19\" name=\"__codelineno-6-19\"></a><span class=\"w\">      </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">InferenceRequest</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">ur</span><span class=\"p\">(</span>\n<a id=\"__codelineno-6-20\" name=\"__codelineno-6-20\"></a><span class=\"w\">          </span><span class=\"k\">reinterpret_cast</span><span class=\"o\">&lt;</span><span class=\"n\">InferenceRequest</span><span class=\"o\">*&gt;</span><span class=\"p\">(</span><span class=\"n\">tr</span><span class=\"p\">));</span>\n<a id=\"__codelineno-6-21\" name=\"__codelineno-6-21\"></a><span class=\"w\">      </span><span class=\"n\">InferenceRequest</span><span class=\"o\">::</span><span class=\"n\">RespondIfError</span><span class=\"p\">(</span><span class=\"n\">ur</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"w\"> </span><span class=\"cm\">/* release_requests */</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-22\" name=\"__codelineno-6-22\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-23\" name=\"__codelineno-6-23\"></a>\n<a id=\"__codelineno-6-24\" name=\"__codelineno-6-24\"></a><span class=\"w\">    </span><span class=\"n\">TRITONSERVER_ErrorDelete</span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-25\" name=\"__codelineno-6-25\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-26\" name=\"__codelineno-6-26\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"response-\u5904\u7406\">response \u5904\u7406<a class=\"headerlink\" href=\"#response-\u5904\u7406\" title=\"Permanent link\">&para;</a></h3>\n<p>ModelInferHandler\u7c7b\u7684\u6784\u9020\u51fd\u6570\u4e2d\uff0c\u6ce8\u518c\u4e86\u56de\u8c03\u51fd\u6570\uff0c\u5c06ipc\u4fe1\u606f\u4f20\u9012\u7ed9\u4e86Response\u7684allocator\u3002\u5c31\u53ef\u4ee5\u901a\u8fc7ipc\u8fd4\u56deresponse\u7ed9client\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-7-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-15\">15</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\"></a><span class=\"w\">    </span><span class=\"c1\">// Create the allocator that will be used to allocate buffers for</span>\n<a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\"></a><span class=\"w\">    </span><span class=\"c1\">// the result tensors.</span>\n<a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\"></a><span class=\"w\">    </span><span class=\"n\">FAIL_IF_ERR</span><span class=\"p\">(</span>\n<a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\"></a><span class=\"w\">        </span><span class=\"n\">TRITONSERVER_ResponseAllocatorNew</span><span class=\"p\">(</span>\n<a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\"></a><span class=\"w\">            </span><span class=\"o\">&amp;</span><span class=\"n\">allocator_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">InferResponseAlloc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">InferResponseFree</span><span class=\"p\">,</span>\n<a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\"></a><span class=\"w\">            </span><span class=\"n\">InferResponseStart</span><span class=\"p\">),</span>\n<a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\"></a><span class=\"w\">        </span><span class=\"s\">&quot;creating inference response allocator&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\"></a><span class=\"w\">    </span><span class=\"n\">FAIL_IF_ERR</span><span class=\"p\">(</span>\n<a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\"></a><span class=\"w\">        </span><span class=\"n\">TRITONSERVER_ResponseAllocatorSetQueryFunction</span><span class=\"p\">(</span>\n<a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\"></a><span class=\"w\">            </span><span class=\"n\">allocator_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OutputBufferQuery</span><span class=\"p\">),</span>\n<a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\"></a><span class=\"w\">        </span><span class=\"s\">&quot;setting allocator&#39;s query function&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\"></a><span class=\"w\">    </span><span class=\"n\">FAIL_IF_ERR</span><span class=\"p\">(</span>\n<a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\"></a><span class=\"w\">        </span><span class=\"n\">TRITONSERVER_ResponseAllocatorSetBufferAttributesFunction</span><span class=\"p\">(</span>\n<a id=\"__codelineno-7-14\" name=\"__codelineno-7-14\"></a><span class=\"w\">            </span><span class=\"n\">allocator_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OutputBufferAttributes</span><span class=\"p\">),</span>\n<a id=\"__codelineno-7-15\" name=\"__codelineno-7-15\"></a><span class=\"w\">        </span><span class=\"s\">&quot;setting allocator&#39;s output buffer attributes function&quot;</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div></p>\n<h2 id=\"\u4f7f\u7528shm-extention\">\u4f7f\u7528shm extention<a class=\"headerlink\" href=\"#\u4f7f\u7528shm-extention\" title=\"Permanent link\">&para;</a></h2>\n<p>https://docs.nvidia.com/deeplearning/triton-inference-server/user-guide/docs/protocol/extension_shared_memory.html</p>\n<p>\u8981\u4f7f\u7528shm extention\uff0c\u8ba9req\u548cresponse\u4f20\u8f93shm\u7684fd\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u4f20\u8f93\u6570\u636e\u3002</p>\n<p>\u9700\u8981client\u4ee5http\u6216\u8005grpc\u7684\u65b9\u5f0f\u53d1\u9001\u8bf7\u6c42\uff0c\u6ce8\u518cshm\u533a\u57df\u4fe1\u606f\uff0c\u540e\u9762\u7684\u8bf7\u6c42\u548cresponse\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f20\u8f93shm\u7684fd\u4f7f\u7528\u4e86\u3002</p>\n<p>\u5728\u6211\u4eec\u7f16\u5199\u7684backend\u4e2d\u53ef\u4ee5\u901a\u8fc7backend api\u83b7\u53d6request\u7684shm\u4fe1\u606f\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-8-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-39\">39</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-40\">40</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-41\">41</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-42\">42</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-43\">43</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-44\">44</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-45\">45</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-46\">46</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-47\">47</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-48\">48</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-49\">49</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-50\">50</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-51\">51</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-52\">52</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\"></a><span class=\"n\">TRITONAPI_DECLSPEC</span><span class=\"w\"> </span><span class=\"n\">TRITONSERVER_Error</span><span class=\"o\">*</span>\n<a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\"></a><span class=\"n\">TRITONBACKEND_RequestOutputBufferProperties</span><span class=\"p\">(</span>\n<a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\"></a><span class=\"w\">    </span><span class=\"n\">TRITONBACKEND_Request</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">byte_size</span><span class=\"p\">,</span>\n<a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\"></a><span class=\"w\">    </span><span class=\"n\">TRITONSERVER_MemoryType</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">memory_type</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int64_t</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">memory_type_id</span><span class=\"p\">)</span>\n<a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\"></a><span class=\"p\">{</span>\n<a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\"></a><span class=\"w\">  </span><span class=\"n\">InferenceRequest</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">tr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">reinterpret_cast</span><span class=\"o\">&lt;</span><span class=\"n\">InferenceRequest</span><span class=\"o\">*&gt;</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\"></a><span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\"></a><span class=\"w\">      </span><span class=\"n\">tr</span><span class=\"o\">-&gt;</span><span class=\"n\">OutputBufferProperties</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">byte_size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">memory_type</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">memory_type_id</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">status</span><span class=\"p\">.</span><span class=\"n\">IsOk</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">TRITONSERVER_ErrorNew</span><span class=\"p\">(</span>\n<a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\"></a><span class=\"w\">        </span><span class=\"n\">StatusCodeToTritonCode</span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"p\">.</span><span class=\"n\">StatusCode</span><span class=\"p\">()),</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"p\">.</span><span class=\"n\">Message</span><span class=\"p\">().</span><span class=\"n\">c_str</span><span class=\"p\">());</span>\n<a id=\"__codelineno-8-12\" name=\"__codelineno-8-12\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-8-13\" name=\"__codelineno-8-13\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// success</span>\n<a id=\"__codelineno-8-14\" name=\"__codelineno-8-14\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-8-15\" name=\"__codelineno-8-15\"></a>\n<a id=\"__codelineno-8-16\" name=\"__codelineno-8-16\"></a>\n<a id=\"__codelineno-8-17\" name=\"__codelineno-8-17\"></a>\n<a id=\"__codelineno-8-18\" name=\"__codelineno-8-18\"></a><span class=\"n\">TRITONBACKEND_DECLSPEC</span><span class=\"w\"> </span><span class=\"n\">TRITONSERVER_Error</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">TRITONBACKEND_InputBufferAttributes</span><span class=\"p\">(</span>\n<a id=\"__codelineno-8-19\" name=\"__codelineno-8-19\"></a><span class=\"w\">    </span><span class=\"n\">TRITONBACKEND_Input</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">index</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"o\">**</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"p\">,</span>\n<a id=\"__codelineno-8-20\" name=\"__codelineno-8-20\"></a><span class=\"w\">    </span><span class=\"n\">TRITONSERVER_BufferAttributes</span><span class=\"o\">**</span><span class=\"w\"> </span><span class=\"n\">buffer_attributes</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-21\" name=\"__codelineno-8-21\"></a>\n<a id=\"__codelineno-8-22\" name=\"__codelineno-8-22\"></a>\n<a id=\"__codelineno-8-23\" name=\"__codelineno-8-23\"></a><span class=\"c1\">/// Get the memory type field of the buffer attributes.</span>\n<a id=\"__codelineno-8-24\" name=\"__codelineno-8-24\"></a><span class=\"c1\">///</span>\n<a id=\"__codelineno-8-25\" name=\"__codelineno-8-25\"></a><span class=\"c1\">/// \\param buffer_attributes The buffer attributes object.</span>\n<a id=\"__codelineno-8-26\" name=\"__codelineno-8-26\"></a><span class=\"c1\">/// \\param memory_type Returns the memory type associated with the buffer</span>\n<a id=\"__codelineno-8-27\" name=\"__codelineno-8-27\"></a><span class=\"c1\">/// attributes object.</span>\n<a id=\"__codelineno-8-28\" name=\"__codelineno-8-28\"></a><span class=\"c1\">/// \\return a TRITONSERVER_Error indicating success or failure.</span>\n<a id=\"__codelineno-8-29\" name=\"__codelineno-8-29\"></a><span class=\"n\">TRITONSERVER_DECLSPEC</span><span class=\"w\"> </span><span class=\"n\">TRITONSERVER_Error</span><span class=\"o\">*</span>\n<a id=\"__codelineno-8-30\" name=\"__codelineno-8-30\"></a><span class=\"n\">TRITONSERVER_BufferAttributesMemoryType</span><span class=\"p\">(</span>\n<a id=\"__codelineno-8-31\" name=\"__codelineno-8-31\"></a><span class=\"w\">    </span><span class=\"n\">TRITONSERVER_BufferAttributes</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">buffer_attributes</span><span class=\"p\">,</span>\n<a id=\"__codelineno-8-32\" name=\"__codelineno-8-32\"></a><span class=\"w\">    </span><span class=\"n\">TRITONSERVER_MemoryType</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">memory_type</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-33\" name=\"__codelineno-8-33\"></a>\n<a id=\"__codelineno-8-34\" name=\"__codelineno-8-34\"></a><span class=\"c1\">/// Get the CudaIpcHandle field of the buffer attributes object.</span>\n<a id=\"__codelineno-8-35\" name=\"__codelineno-8-35\"></a><span class=\"c1\">///</span>\n<a id=\"__codelineno-8-36\" name=\"__codelineno-8-36\"></a><span class=\"c1\">/// \\param buffer_attributes The buffer attributes object.</span>\n<a id=\"__codelineno-8-37\" name=\"__codelineno-8-37\"></a><span class=\"c1\">/// \\param cuda_ipc_handle Returns the memory type associated with the buffer</span>\n<a id=\"__codelineno-8-38\" name=\"__codelineno-8-38\"></a><span class=\"c1\">/// attributes object. If the cudaIpcHandle does not exist for the buffer,</span>\n<a id=\"__codelineno-8-39\" name=\"__codelineno-8-39\"></a><span class=\"c1\">/// nullptr will be returned.</span>\n<a id=\"__codelineno-8-40\" name=\"__codelineno-8-40\"></a><span class=\"c1\">/// \\return a TRITONSERVER_Error indicating success or failure.</span>\n<a id=\"__codelineno-8-41\" name=\"__codelineno-8-41\"></a><span class=\"n\">TRITONSERVER_DECLSPEC</span><span class=\"w\"> </span><span class=\"n\">TRITONSERVER_Error</span><span class=\"o\">*</span>\n<a id=\"__codelineno-8-42\" name=\"__codelineno-8-42\"></a><span class=\"n\">TRITONSERVER_BufferAttributesCudaIpcHandle</span><span class=\"p\">(</span>\n<a id=\"__codelineno-8-43\" name=\"__codelineno-8-43\"></a><span class=\"w\">    </span><span class=\"n\">TRITONSERVER_BufferAttributes</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">buffer_attributes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"o\">**</span><span class=\"w\"> </span><span class=\"n\">cuda_ipc_handle</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-44\" name=\"__codelineno-8-44\"></a>\n<a id=\"__codelineno-8-45\" name=\"__codelineno-8-45\"></a><span class=\"c1\">/// Get the byte size field of the buffer attributes.</span>\n<a id=\"__codelineno-8-46\" name=\"__codelineno-8-46\"></a><span class=\"c1\">///</span>\n<a id=\"__codelineno-8-47\" name=\"__codelineno-8-47\"></a><span class=\"c1\">/// \\param buffer_attributes The buffer attributes object.</span>\n<a id=\"__codelineno-8-48\" name=\"__codelineno-8-48\"></a><span class=\"c1\">/// \\param byte_size Returns the byte size associated with the buffer attributes</span>\n<a id=\"__codelineno-8-49\" name=\"__codelineno-8-49\"></a><span class=\"c1\">/// object.</span>\n<a id=\"__codelineno-8-50\" name=\"__codelineno-8-50\"></a><span class=\"c1\">/// \\return a TRITONSERVER_Error indicating success or failure.</span>\n<a id=\"__codelineno-8-51\" name=\"__codelineno-8-51\"></a><span class=\"n\">TRITONSERVER_DECLSPEC</span><span class=\"w\"> </span><span class=\"n\">TRITONSERVER_Error</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">TRITONSERVER_BufferAttributesByteSize</span><span class=\"p\">(</span>\n<a id=\"__codelineno-8-52\" name=\"__codelineno-8-52\"></a><span class=\"w\">    </span><span class=\"n\">TRITONSERVER_BufferAttributes</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">buffer_attributes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">byte_size</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div>\n\u7136\u540e\u901a\u8fc7shm\u83b7\u5f97\u6570\u636e\uff0c\u8fdb\u884c\u5904\u7406\uff0c\u518d\u751f\u6210response\u3002</p>\n<p>\u4e3e\u4f8b\uff1a\n\u6bd4\u5982\u5728python backend\u7684\u5b9e\u73b0\u4e2d\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-9-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-33\">33</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\"></a><span class=\"n\">TRITONSERVER_Error</span><span class=\"o\">*</span>\n<a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\"></a><span class=\"nf\">ModelInstanceState::GetInputTensor</span><span class=\"p\">(</span>\n<a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">input_idx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">shared_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">PbTensor</span><span class=\"o\">&gt;&amp;</span><span class=\"w\"> </span><span class=\"n\">input_tensor</span><span class=\"p\">,</span>\n<a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\"></a><span class=\"w\">    </span><span class=\"n\">TRITONBACKEND_Request</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"p\">,</span>\n<a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">shared_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">vector</span><span class=\"o\">&lt;</span><span class=\"n\">TRITONBACKEND_Response</span><span class=\"o\">*&gt;&gt;&amp;</span><span class=\"w\"> </span><span class=\"n\">responses</span><span class=\"p\">)</span>\n<a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\"></a><span class=\"p\">{</span>\n<a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\"></a><span class=\"w\">    </span><span class=\"n\">TRITONSERVER_BufferAttributes</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">buffer_attributes</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-8\" name=\"__codelineno-9-8\"></a>\n<a id=\"__codelineno-9-9\" name=\"__codelineno-9-9\"></a><span class=\"w\">      </span><span class=\"c1\">// This value is not used.</span>\n<a id=\"__codelineno-9-10\" name=\"__codelineno-9-10\"></a><span class=\"w\">      </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">buffer_p</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-11\" name=\"__codelineno-9-11\"></a><span class=\"w\">      </span><span class=\"n\">RETURN_IF_ERROR</span><span class=\"p\">(</span><span class=\"n\">TRITONBACKEND_InputBufferAttributes</span><span class=\"p\">(</span>\n<a id=\"__codelineno-9-12\" name=\"__codelineno-9-12\"></a><span class=\"w\">          </span><span class=\"n\">in</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">buffer_p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">buffer_attributes</span><span class=\"p\">));</span>\n<a id=\"__codelineno-9-13\" name=\"__codelineno-9-13\"></a>\n<a id=\"__codelineno-9-14\" name=\"__codelineno-9-14\"></a><span class=\"w\">      </span><span class=\"n\">input_tensor</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">make_shared</span><span class=\"o\">&lt;</span><span class=\"n\">PbTensor</span><span class=\"o\">&gt;</span><span class=\"p\">(</span>\n<a id=\"__codelineno-9-15\" name=\"__codelineno-9-15\"></a><span class=\"w\">          </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"p\">(</span><span class=\"n\">input_name</span><span class=\"p\">),</span>\n<a id=\"__codelineno-9-16\" name=\"__codelineno-9-16\"></a><span class=\"w\">          </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">vector</span><span class=\"o\">&lt;</span><span class=\"kt\">int64_t</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">input_shape</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">input_shape</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">input_dims_count</span><span class=\"p\">),</span>\n<a id=\"__codelineno-9-17\" name=\"__codelineno-9-17\"></a><span class=\"w\">          </span><span class=\"n\">input_dtype</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">src_memory_type</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">src_memory_type_id</span><span class=\"p\">,</span>\n<a id=\"__codelineno-9-18\" name=\"__codelineno-9-18\"></a><span class=\"w\">          </span><span class=\"k\">const_cast</span><span class=\"o\">&lt;</span><span class=\"kt\">void</span><span class=\"o\">*&gt;</span><span class=\"p\">(</span><span class=\"n\">buffer</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">input_byte_size</span><span class=\"p\">,</span>\n<a id=\"__codelineno-9-19\" name=\"__codelineno-9-19\"></a><span class=\"w\">          </span><span class=\"k\">nullptr</span><span class=\"w\"> </span><span class=\"cm\">/* DLManagedTensor */</span><span class=\"p\">);</span>\n<a id=\"__codelineno-9-20\" name=\"__codelineno-9-20\"></a>\n<a id=\"__codelineno-9-21\" name=\"__codelineno-9-21\"></a><span class=\"w\">      </span><span class=\"n\">cudaIpcMemHandle_t</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">cuda_ipc_handle</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-22\" name=\"__codelineno-9-22\"></a><span class=\"w\">      </span><span class=\"n\">RETURN_IF_ERROR</span><span class=\"p\">(</span><span class=\"n\">TRITONSERVER_BufferAttributesCudaIpcHandle</span><span class=\"p\">(</span>\n<a id=\"__codelineno-9-23\" name=\"__codelineno-9-23\"></a><span class=\"w\">          </span><span class=\"n\">buffer_attributes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">reinterpret_cast</span><span class=\"o\">&lt;</span><span class=\"kt\">void</span><span class=\"o\">**&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">cuda_ipc_handle</span><span class=\"p\">)));</span>\n<a id=\"__codelineno-9-24\" name=\"__codelineno-9-24\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">cuda_ipc_handle</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-25\" name=\"__codelineno-9-25\"></a><span class=\"w\">        </span><span class=\"n\">RETURN_IF_EXCEPTION</span><span class=\"p\">(</span><span class=\"n\">input_tensor</span><span class=\"o\">-&gt;</span><span class=\"n\">SaveToSharedMemory</span><span class=\"p\">(</span>\n<a id=\"__codelineno-9-26\" name=\"__codelineno-9-26\"></a><span class=\"w\">            </span><span class=\"n\">Stub</span><span class=\"p\">()</span><span class=\"o\">-&gt;</span><span class=\"n\">ShmPool</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"w\"> </span><span class=\"cm\">/* copy_gpu */</span><span class=\"p\">));</span>\n<a id=\"__codelineno-9-27\" name=\"__codelineno-9-27\"></a><span class=\"w\">        </span><span class=\"n\">RETURN_IF_EXCEPTION</span><span class=\"p\">(</span>\n<a id=\"__codelineno-9-28\" name=\"__codelineno-9-28\"></a><span class=\"w\">            </span><span class=\"n\">input_tensor</span><span class=\"o\">-&gt;</span><span class=\"n\">Memory</span><span class=\"p\">()</span><span class=\"o\">-&gt;</span><span class=\"n\">SetCudaIpcHandle</span><span class=\"p\">(</span><span class=\"n\">cuda_ipc_handle</span><span class=\"p\">));</span>\n<a id=\"__codelineno-9-29\" name=\"__codelineno-9-29\"></a><span class=\"w\">      </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-30\" name=\"__codelineno-9-30\"></a><span class=\"w\">        </span><span class=\"n\">RETURN_IF_EXCEPTION</span><span class=\"p\">(</span><span class=\"n\">input_tensor</span><span class=\"o\">-&gt;</span><span class=\"n\">SaveToSharedMemory</span><span class=\"p\">(</span>\n<a id=\"__codelineno-9-31\" name=\"__codelineno-9-31\"></a><span class=\"w\">            </span><span class=\"n\">Stub</span><span class=\"p\">()</span><span class=\"o\">-&gt;</span><span class=\"n\">ShmPool</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"w\"> </span><span class=\"cm\">/* copy_gpu */</span><span class=\"p\">));</span>\n<a id=\"__codelineno-9-32\" name=\"__codelineno-9-32\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n<a id=\"__codelineno-9-33\" name=\"__codelineno-9-33\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/tritonserver-multibatch\u6e90\u7801\u5206\u6790/\" target=\"_blank\">tritonserver-multibatch\u6e90\u7801\u5206\u6790</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898/\" target=\"_blank\">C++\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-06-21T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/tritonserver_python_backend_shm_com%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/",
            "url": "https://github.com/KenForever1/blog/tritonserver_python_backend_shm_com%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/",
            "title": "tritonserver_python_backend_shm_com\u6e90\u7801\u5206\u6790",
            "content_html": "<!-- more -->\n\n<h2 id=\"\u80cc\u666f\u4ecb\u7ecd\">\u80cc\u666f\u4ecb\u7ecd<a class=\"headerlink\" href=\"#\u80cc\u666f\u4ecb\u7ecd\" title=\"Permanent link\">&para;</a></h2>\n<p>\u672c\u6587\u4ecb\u7ecd\u4e86tritonserver\u4e2d\uff0c\u5982\u4f55\u901a\u8fc7\u5171\u4eab\u5185\u5b58\u548c\u5b50\u8fdb\u7a0b\u901a\u4fe1\uff0c\u4e3b\u8981\u4ecb\u7ecd\u5171\u4eab\u5185\u5b58\u7ba1\u7406\u7684\u5c01\u88c5\u4ee5\u53cac++ boost inprocess\u6a21\u5757\u7684\u4f7f\u7528\u3002\u8fd9\u5757\u529f\u80fd\u662f\u53ef\u4ee5\u590d\u7528\u7684\uff0c\u53ef\u4ee5\u7528\u4e8e\u5176\u4ed6\u573a\u666f\u3002</p>\n<p>tritonserver\u4f5c\u4e3a\u4e00\u4e2aAI\u63a8\u7406\u670d\u52a1\uff0c\u652f\u6301python backend\u7684\u65b9\u5f0f\uff0c\u901a\u8fc7python \u5b50\u8fdb\u7a0b\u65b9\u5f0f\u8fd0\u884c\u6a21\u578b\u6216\u8005\u81ea\u5b9a\u4e49\u7684\u903b\u8f91\u3002</p>\n<p>\u7b80\u5355\u6765\u8bf4\uff0c\u5c31\u662f\u901a\u8fc7fork\u542f\u52a8\u4e86\u4e00\u4e2astub\u5b50\u8fdb\u7a0b\uff0cstub\u5b50\u8fdb\u7a0b\u901a\u8fc7pybind11\u8fd0\u884c\u7528\u6237\u5b50\u5b9a\u4e49\u7684python\u4ee3\u7801\u3002\u5f53c++\u5b9e\u73b0\u7684tritonserver\u6536\u5230\u8bf7\u6c42\u540e\uff0c\u5c31\u4f1a\u8c03\u7528python\u811a\u672c\uff0c\u7ecf\u8fc7\u5904\u7406\u540e\u8fd4\u56de\u7ed3\u679c\u3002</p>\n<ul>\n<li>fork stub\u5b50\u8fdb\u7a0b\uff0c\u6267\u884c\u7528\u6237\u81ea\u5b9a\u4e49\u7684python\u4ee3\u7801</li>\n<li>tritonserver\u4f5c\u4e3a\u7236\u8fdb\u7a0b\uff0c\u9700\u8981\u548cstub\u5b50\u8fdb\u7a0b\u901a\u4fe1\uff0c\u6bd4\u5982\u63a7\u5236stub\u505c\u6b62\u3001\u53d1\u9001\u8bf7\u6c42\u3001\u63a7\u5236\u547d\u4ee4\u7b49\u3002</li>\n</ul>\n<p>\u8fd9\u5c31\u8bbe\u8ba1\u4e86\u8fdb\u7a0b\u4e4b\u95f4\u7684\u901a\u4fe1\uff0c\u5982\u679c\u901a\u8fc7\u7f51\u7edc\u901a\u4fe1\uff0c\u6027\u80fd\u4f1a\u4e0b\u964d\uff0c\u8fd9\u91cc\u91c7\u7528\u4e86shm\uff08\u5171\u4eab\u5185\u5b58\uff09\u7684\u65b9\u5f0f\u3002</p>\n<h2 id=\"\u5171\u4eab\u5185\u5b58\u548c\u6d88\u606f\u961f\u5217\u7684\u8bbe\u8ba1\">\u5171\u4eab\u5185\u5b58\u548c\u6d88\u606f\u961f\u5217\u7684\u8bbe\u8ba1<a class=\"headerlink\" href=\"#\u5171\u4eab\u5185\u5b58\u548c\u6d88\u606f\u961f\u5217\u7684\u8bbe\u8ba1\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u91cc\u8fdb\u7a0b\u95f4\u901a\u4fe1\uff0c\u8bbe\u8ba1\u4e86\u4e00\u4e2a\u6d88\u606f\u961f\u5217\uff0c\u627f\u8f7d\u6d88\u606f\u961f\u5217\u7684\u8f7d\u4f53\u662f\u5171\u4eab\u5185\u5b58\uff0c\u5373\u901a\u8fc7\u5171\u4eab\u5185\u5b58\u6765\u5b58\u50a8\u6d88\u606f\u961f\u5217\u3002</p>\n<p>\u65e2\u7136\u662f\u8de8\u8fdb\u7a0b\u95f4\u4f20\u8f93\u6570\u636e\u7684\u6d88\u606f\u961f\u5217\uff0c\u90a3\u4e48\u80af\u5b9a\u4e24\u4e2a\u8fdb\u7a0b\u90fd\u4f1a\u83b7\u53d6\u540c\u4e00\u4e2a\u6d88\u606f\u961f\u5217\u7684\u53e5\u67c4\uff0c\u751f\u4ea7\u8005\u521b\u5efa\uff08create\uff09\u5e76\u4e14\u53d1\u9001\uff08push\uff09\u6d88\u606f\uff0c\u6d88\u8d39\u8005load\u6d88\u606f\u961f\u5217\u5e76\u4e14\u6d88\u8d39\uff08pop\uff09\u6d88\u606f\u3002</p>\n<h2 id=\"\u4eceparent\u8fdb\u7a0b\u89c6\u89d2\u770b\">\u4eceparent\u8fdb\u7a0b\u89c6\u89d2\u770b<a class=\"headerlink\" href=\"#\u4eceparent\u8fdb\u7a0b\u89c6\u89d2\u770b\" title=\"Permanent link\">&para;</a></h2>\n<p>parent\u8fdb\u7a0b\u521b\u5efa\u4e86\u6d88\u606f\u961f\u5217\uff0cpush\u6d88\u606f\u5230\u6d88\u606f\u961f\u5217stub_message_queue_\uff0c\u7136\u540e\u7b49\u5f85\u5b50\u8fdb\u7a0b\u6d88\u8d39\u6d88\u606f\u3002\u7136\u540e\u4eceparent_message_queue_\u63a5\u53d7\u5b50\u8fdb\u7a0b\u8fd4\u56de\u7684\u6d88\u606f\u3002</p>\n<h3 id=\"\u5171\u4eab\u5185\u5b58\u4ee5\u53ca\u6d88\u606f\u961f\u5217\u7684\u521b\u5efa\">\u5171\u4eab\u5185\u5b58\u4ee5\u53ca\u6d88\u606f\u961f\u5217\u7684\u521b\u5efa<a class=\"headerlink\" href=\"#\u5171\u4eab\u5185\u5b58\u4ee5\u53ca\u6d88\u606f\u961f\u5217\u7684\u521b\u5efa\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4f8b\u5982\u4e0b\u9762\u662fMessageQueue\u7c7b\u521b\u5efa\u7684\u51e0\u79cd\u4e0d\u540c\u7684\u6d88\u606f\u961f\u5217\uff0c\u7528\u4e8eparent\u8fdb\u7a0b\u548cstub\u8fdb\u7a0b\u4e4b\u95f4\u7684\u901a\u4fe1\uff0c\u6d88\u606f\u961f\u5217\u7684\u7c7b\u578b\u662fbi::managed_external_buffer::handle_t\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-0-19\">19</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"c1\">// \u6e90\u7801\u5730\u5740\uff1ahttps://github.com/triton-inference-server/python_backend/blob/main/src/stub_launcher.cc#L151</span>\n<a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a><span class=\"c1\">// stub_message_queue_\u662fparent\u53d1\u9001\u63a7\u5236\u4fe1\u606f\u7ed9stub\u8fdb\u7a0b\u7684\u961f\u5217\uff0c\u6bd4\u5982\u53d1\u9001\u521d\u59cb\u5316\u3001\u505c\u6b62\u7b49commond</span>\n<a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a><span class=\"n\">RETURN_IF_EXCEPTION</span><span class=\"p\">(</span>\n<a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\"></a><span class=\"w\">      </span><span class=\"n\">stub_message_queue_</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\"></a><span class=\"w\">          </span><span class=\"n\">MessageQueue</span><span class=\"o\">&lt;</span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"o\">&gt;::</span><span class=\"n\">Create</span><span class=\"p\">(</span>\n<a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\"></a><span class=\"w\">              </span><span class=\"n\">shm_pool_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shm_message_queue_size_</span><span class=\"p\">));</span>\n<a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\"></a><span class=\"c1\">// parent_message_queue_\u662fstub\u8fdb\u7a0b\u53d1\u9001\u4fe1\u606f\u7ed9parent\u8fdb\u7a0b\u7684\u961f\u5217</span>\n<a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\"></a><span class=\"w\">  </span><span class=\"n\">RETURN_IF_EXCEPTION</span><span class=\"p\">(</span>\n<a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\"></a><span class=\"w\">      </span><span class=\"n\">parent_message_queue_</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\"></a><span class=\"w\">          </span><span class=\"n\">MessageQueue</span><span class=\"o\">&lt;</span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"o\">&gt;::</span><span class=\"n\">Create</span><span class=\"p\">(</span>\n<a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\"></a><span class=\"w\">              </span><span class=\"n\">shm_pool_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shm_message_queue_size_</span><span class=\"p\">));</span>\n<a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\"></a><span class=\"w\">  </span><span class=\"n\">RETURN_IF_EXCEPTION</span><span class=\"p\">(</span>\n<a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\"></a><span class=\"w\">      </span><span class=\"n\">stub_to_parent_mq_</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\"></a><span class=\"w\">          </span><span class=\"n\">MessageQueue</span><span class=\"o\">&lt;</span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"o\">&gt;::</span><span class=\"n\">Create</span><span class=\"p\">(</span>\n<a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\"></a><span class=\"w\">              </span><span class=\"n\">shm_pool_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shm_message_queue_size_</span><span class=\"p\">));</span>\n<a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\"></a><span class=\"w\">  </span><span class=\"n\">RETURN_IF_EXCEPTION</span><span class=\"p\">(</span>\n<a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\"></a><span class=\"w\">      </span><span class=\"n\">parent_to_stub_mq_</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\"></a><span class=\"w\">          </span><span class=\"n\">MessageQueue</span><span class=\"o\">&lt;</span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"o\">&gt;::</span><span class=\"n\">Create</span><span class=\"p\">(</span>\n<a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\"></a><span class=\"w\">              </span><span class=\"n\">shm_pool_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shm_message_queue_size_</span><span class=\"p\">));</span>\n</code></pre></div></td></tr></table></div>\n<p>SharedMemoryManager\u7c7b\u662f\u4e00\u4e2a\u53ef\u4ee5\u590d\u7528\u7684\u7c7b\uff0c\u5c01\u88c5\u4e86\u5171\u4eab\u5185\u5b58\u7684\u521b\u5efa\u548c\u9500\u6bc1\uff0c\u4ee5\u53ca\u5171\u4eab\u5185\u5b58\u4e2d\u5bf9\u8c61\u7684\u6784\u9020\u548c\u6790\u6784\u3002\u8fd9\u91cc\u6307\u5b9a\u4e86\u5171\u4eab\u5185\u5b58\u7684\u540d\u79f0\uff0c\u5927\u5c0f\uff0c\u589e\u957f\u5927\u5c0f\uff0c\u662f\u5426\u521b\u5efa\u7b49\u53c2\u6570\uff0c\u4e3a\u8fdb\u7a0b\u901a\u4fe1\u521b\u5efa\u4e86\u4e00\u6bb5shm\u5171\u4eab\u5185\u5b58\u3002</p>\n<p>\u5e76\u4e14\u5728\u5171\u4eab\u5185\u5b58\u4e2d\u521b\u5efa\u4e86IPCControlShm\u5bf9\u8c61\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u5305\u542b\u4e86\u6d88\u606f\u961f\u5217\u7684\u53e5\u67c4\uff0c\u4ee5\u53ca\u4e00\u4e9b\u8fdb\u7a0b\u5065\u5eb7\u72b6\u6001\u7684\u6807\u5fd7\u4f4d\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-5\">5</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">SharedMemoryManager</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">shm_pool_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">make_unique</span><span class=\"o\">&lt;</span><span class=\"n\">SharedMemoryManager</span><span class=\"o\">&gt;</span><span class=\"p\">(</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"w\">        </span><span class=\"n\">shm_region_name_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shm_default_byte_size_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shm_growth_byte_size_</span><span class=\"p\">,</span>\n<a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a><span class=\"w\">        </span><span class=\"nb\">true</span><span class=\"w\"> </span><span class=\"cm\">/* create */</span><span class=\"p\">);</span>\n<a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\"></a><span class=\"n\">AllocatedSharedMemory</span><span class=\"o\">&lt;</span><span class=\"n\">IPCControlShm</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">current_ipc_control</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\"></a><span class=\"w\">      </span><span class=\"n\">shm_pool_</span><span class=\"o\">-&gt;</span><span class=\"n\">Construct</span><span class=\"o\">&lt;</span><span class=\"n\">IPCControlShm</span><span class=\"o\">&gt;</span><span class=\"p\">();</span>\n</code></pre></div></td></tr></table></div>\n<p>IPCControlShm\u7ed3\u6784\u4f53\u5305\u542b\u4e86\u8fdb\u7a0b\u901a\u4fe1\u9700\u8981\u7684\u6240\u6709\u4fe1\u606f\uff0c\u5305\u62ec\u4e24\u4e2a\u8fdb\u7a0b\u7684\u5065\u5eb7\u72b6\u6001\uff0c\u4e24\u4e2a\u8fdb\u7a0b\u7684\u6d88\u606f\u961f\u5217\u53e5\u67c4\u7b49\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-15\">15</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"c1\">// Control data structure for the communication between the Python stub and the</span>\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a><span class=\"c1\">// main stub.</span>\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">IPCControlShm</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a><span class=\"w\">  </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">stub_health</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\"></a><span class=\"w\">  </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">parent_health</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\"></a><span class=\"w\">  </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">uses_env</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\"></a><span class=\"w\">  </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">decoupled</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\"></a><span class=\"w\">  </span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">interprocess_mutex</span><span class=\"w\"> </span><span class=\"n\">parent_health_mutex</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\"></a><span class=\"w\">  </span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">interprocess_mutex</span><span class=\"w\"> </span><span class=\"n\">stub_health_mutex</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\"></a><span class=\"w\">  </span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"w\"> </span><span class=\"n\">stub_message_queue</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\"></a><span class=\"w\">  </span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"w\"> </span><span class=\"n\">parent_message_queue</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\"></a><span class=\"w\">  </span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"w\"> </span><span class=\"n\">stub_to_parent_mq</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\"></a><span class=\"w\">  </span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"w\"> </span><span class=\"n\">parent_to_stub_mq</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\"></a><span class=\"w\">  </span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"w\"> </span><span class=\"n\">memory_manager_message_queue</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\"></a><span class=\"p\">};</span>\n</code></pre></div></td></tr></table></div></p>\n<h3 id=\"\u53d1\u9001\u6d88\u606f\">\u53d1\u9001\u6d88\u606f<a class=\"headerlink\" href=\"#\u53d1\u9001\u6d88\u606f\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0b\u9762\u7684\u4ee3\u7801\u63cf\u8ff0\u4e86\u5982\u4f55\u4eceparent\u8fdb\u7a0b\u53d1\u9001\u4e00\u4e2ainitialize_message\u7ed9\u5230stub\u8fdb\u7a0b\u3002\u6784\u9020\u4e00\u4e2aIPCMessage\u7c7b\u578b\u7684\u6d88\u606f\uff0c\u4e3a\u6d88\u606f\u8d4b\u503c\uff0c\u518d\u5c06\u6d88\u606fPush\u5230stub_message_queue_\u4e2d\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-19\">19</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unordered_map</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">initialize_map</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a><span class=\"w\">    </span><span class=\"p\">{</span><span class=\"s\">&quot;model_config&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">model_config_buffer_</span><span class=\"p\">.</span><span class=\"n\">MutableContents</span><span class=\"p\">()},</span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"p\">{</span><span class=\"s\">&quot;model_instance_kind&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kind_</span><span class=\"p\">},</span>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a><span class=\"w\">    </span><span class=\"p\">{</span><span class=\"s\">&quot;model_instance_name&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">model_instance_name_</span><span class=\"p\">},</span>\n<a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\"></a><span class=\"w\">    </span><span class=\"p\">{</span><span class=\"s\">&quot;model_instance_device_id&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">to_string</span><span class=\"p\">(</span><span class=\"n\">device_id_</span><span class=\"p\">)},</span>\n<a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\"></a><span class=\"w\">    </span><span class=\"p\">{</span><span class=\"s\">&quot;model_repository&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">model_repository_path_</span><span class=\"p\">},</span>\n<a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\"></a><span class=\"w\">    </span><span class=\"p\">{</span><span class=\"s\">&quot;model_version&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">to_string</span><span class=\"p\">(</span><span class=\"n\">model_version_</span><span class=\"p\">)},</span>\n<a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\"></a><span class=\"w\">    </span><span class=\"p\">{</span><span class=\"s\">&quot;model_name&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">model_name_</span><span class=\"p\">}};</span>\n<a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\"></a>\n<a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">IPCMessage</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">initialize_message</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\"></a><span class=\"w\">    </span><span class=\"n\">IPCMessage</span><span class=\"o\">::</span><span class=\"n\">Create</span><span class=\"p\">(</span><span class=\"n\">shm_pool_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"w\"> </span><span class=\"cm\">/* inline_response */</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\"></a><span class=\"n\">initialize_message</span><span class=\"o\">-&gt;</span><span class=\"n\">Command</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">PYTHONSTUB_InitializeRequest</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\"></a>\n<a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">PbMap</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">pb_map</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">PbMap</span><span class=\"o\">::</span><span class=\"n\">Create</span><span class=\"p\">(</span><span class=\"n\">shm_pool_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">initialize_map</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\"></a><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"w\"> </span><span class=\"n\">initialize_map_handle</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\"></a><span class=\"w\">    </span><span class=\"n\">pb_map</span><span class=\"o\">-&gt;</span><span class=\"n\">ShmHandle</span><span class=\"p\">();</span>\n<a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\"></a>\n<a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\"></a><span class=\"n\">initialize_message</span><span class=\"o\">-&gt;</span><span class=\"n\">Args</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">initialize_map_handle</span><span class=\"p\">;</span>\n<a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\"></a><span class=\"n\">stub_message_queue_</span><span class=\"o\">-&gt;</span><span class=\"n\">Push</span><span class=\"p\">(</span><span class=\"n\">initialize_message</span><span class=\"o\">-&gt;</span><span class=\"n\">ShmHandle</span><span class=\"p\">());</span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"\u63a5\u6536\u6d88\u606f\">\u63a5\u6536\u6d88\u606f<a class=\"headerlink\" href=\"#\u63a5\u6536\u6d88\u606f\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0a\u5c0f\u8282\u63d0\u5230\u7684initialize_message\u662f\u5982\u4f55\u88ab\u63a5\u6536\u5904\u7406\u7684\u5462\uff1f\u770b\u4e0b\u9762\u7684\u4ee3\u7801\uff0cReceiveMessageFromStub\u51fd\u6570\u63a5\u53d7\u6d88\u606f\uff0c\u7136\u540e\u901a\u8fc7shm_pool_\u5171\u4eab\u5185\u5b58\u65b9\u5f0f\u83b7\u53d6\u6d88\u606f\u5177\u4f53\u7684\u5185\u5bb9\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-19\">19</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"w\"> </span><span class=\"n\">message</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a><span class=\"n\">RETURN_IF_ERROR</span><span class=\"p\">(</span><span class=\"n\">ReceiveMessageFromStub</span><span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">initialization_timeout_ms</span><span class=\"p\">));</span>\n<a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\"></a>\n<a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">IPCMessage</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">initialize_response_message</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\"></a><span class=\"w\">    </span><span class=\"n\">IPCMessage</span><span class=\"o\">::</span><span class=\"n\">LoadFromSharedMemory</span><span class=\"p\">(</span><span class=\"n\">shm_pool_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">message</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\"></a>\n<a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">initialize_response_message</span><span class=\"o\">-&gt;</span><span class=\"n\">Command</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">PYTHONSTUB_InitializeResponse</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\"></a><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">TRITONSERVER_ErrorNew</span><span class=\"p\">(</span>\n<a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\"></a><span class=\"w\">    </span><span class=\"n\">TRITONSERVER_ERROR_INTERNAL</span><span class=\"p\">,</span>\n<a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"p\">(</span>\n<a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\"></a><span class=\"w\">            </span><span class=\"s\">&quot;Received unexpected response from Python backend stub: &quot;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span>\n<a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\"></a><span class=\"w\">        </span><span class=\"n\">model_instance_name_</span><span class=\"p\">)</span>\n<a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">c_str</span><span class=\"p\">());</span>\n<a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\"></a>\n<a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\"></a><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">initialize_response</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">move</span><span class=\"p\">((</span><span class=\"n\">shm_pool_</span><span class=\"o\">-&gt;</span><span class=\"n\">Load</span><span class=\"o\">&lt;</span><span class=\"n\">InitializeResponseShm</span><span class=\"o\">&gt;</span><span class=\"p\">(</span>\n<a id=\"__codelineno-4-18\" name=\"__codelineno-4-18\"></a><span class=\"w\">                </span><span class=\"n\">initialize_response_message</span><span class=\"o\">-&gt;</span><span class=\"n\">Args</span><span class=\"p\">())))</span>\n<a id=\"__codelineno-4-19\" name=\"__codelineno-4-19\"></a><span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">data_</span><span class=\"p\">;</span>\n</code></pre></div></td></tr></table></div>\n<p>ReceiveMessageFromStub\u5b9e\u9645\u4e0a\u5c31\u662f\u4ece\u6d88\u606f\u961f\u5217parent_message_queue_\u4e2d\u53d6\u51fa\u6d88\u606f\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a><span class=\"n\">message</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">parent_message_queue_</span><span class=\"o\">-&gt;</span><span class=\"n\">Pop</span><span class=\"p\">(</span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a><span class=\"w\">    </span><span class=\"n\">timeout_miliseconds</span><span class=\"w\"> </span><span class=\"cm\">/* duration ms */</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div></p>\n<h2 id=\"\u4ecestub\u8fdb\u7a0b\u89c6\u89d2\u770b\">\u4ecestub\u8fdb\u7a0b\u89c6\u89d2\u770b<a class=\"headerlink\" href=\"#\u4ecestub\u8fdb\u7a0b\u89c6\u89d2\u770b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4ecestub\u8fdb\u7a0b\uff0c\u4e5f\u5c31\u662fpython\u5b50\u8fdb\u7a0b\u89c6\u89d2\u770b\uff0c\u5b83\u5c31\u4e0d\u662f\u521b\u5efa\u5171\u4eab\u5185\u5b58\u4e86\u3002\u800c\u662f\u4f7f\u7528parent\u8fdb\u7a0b\u521b\u5efa\u7684\u5171\u4eab\u5185\u5b58\uff0c\u7136\u540e\u901a\u8fc7LoadFromSharedMemory\u65b9\u6cd5load\u521b\u5efa\u597d\u7684\u6d88\u606f\u961f\u5217\uff0c\u76f4\u63a5\u4f7f\u7528\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-10\">10</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a><span class=\"c1\">// https://github.com/triton-inference-server/python_backend/blob/main/src/pb_stub.cc#L164</span>\n<a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\"></a><span class=\"n\">shm_pool_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">make_unique</span><span class=\"o\">&lt;</span><span class=\"n\">SharedMemoryManager</span><span class=\"o\">&gt;</span><span class=\"p\">(</span>\n<a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\"></a><span class=\"w\">    </span><span class=\"n\">shm_region_name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shm_default_size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shm_growth_size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"w\"> </span><span class=\"cm\">/* create */</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\"></a>\n<a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\"></a><span class=\"n\">AllocatedSharedMemory</span><span class=\"o\">&lt;</span><span class=\"n\">IPCControlShm</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">ipc_control</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\"></a><span class=\"w\">    </span><span class=\"n\">shm_pool_</span><span class=\"o\">-&gt;</span><span class=\"n\">Load</span><span class=\"o\">&lt;</span><span class=\"n\">IPCControlShm</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">ipc_control_handle</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\"></a><span class=\"n\">ipc_control_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ipc_control</span><span class=\"p\">.</span><span class=\"n\">data_</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">();</span>\n<a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\"></a>\n<a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\"></a><span class=\"n\">stub_message_queue_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">MessageQueue</span><span class=\"o\">&lt;</span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"o\">&gt;::</span>\n<a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\"></a><span class=\"w\">    </span><span class=\"n\">LoadFromSharedMemory</span><span class=\"p\">(</span><span class=\"n\">shm_pool_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ipc_control_</span><span class=\"o\">-&gt;</span><span class=\"n\">stub_message_queue</span><span class=\"p\">);</span>\n</code></pre></div></td></tr></table></div>\n\u4e0a\u9762\u8bf4\u4e86parent\u7ed9stub\u53d1\u9001\u4e86\u4e00\u4e2ainitialize_message\uff0cstub\u8fdb\u7a0b\u6536\u5230\u540e\uff0c\u4f1a\u56de\u590d\u4e00\u4e2ainitialize_response\u3002\u5b50\u8fdb\u7a0b\u901a\u8fc7Pop\u4ecestub_message_queue_\u63a5\u53d7\u6d88\u606f\u3002</p>\n<h3 id=\"\u63a5\u6536\u6d88\u606f_1\">\u63a5\u6536\u6d88\u606f<a class=\"headerlink\" href=\"#\u63a5\u6536\u6d88\u606f_1\" title=\"Permanent link\">&para;</a></h3>\n<p>stub\u8fdb\u7a0b\u5982\u4f55\u63a5\u53d7\u6d88\u606f\u5462\uff1f\u4e0a\u9762\u63d0\u5230parent\u8fdb\u7a0b\u53d1\u9001\u6d88\u606f\u5c31\u662f\u5c06\u6d88\u606f\u5165\u961f\u5217stub_message_queue_\uff0c\u5728stub\u8fdb\u7a0b\u7684\u8c03\u7528\u7684PopMessage\u51fd\u6570\u4e2d\uff0c\u5c31\u662f\u901a\u8fc7Pop\u4ece\u961f\u5217\u4e2d\u53d6\u6d88\u606f\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-7-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-14\">14</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">IPCMessage</span><span class=\"o\">&gt;</span>\n<a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\"></a><span class=\"n\">Stub</span><span class=\"o\">::</span><span class=\"n\">PopMessage</span><span class=\"p\">()</span>\n<a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\"></a><span class=\"p\">{</span>\n<a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\"></a><span class=\"w\">  </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\"></a><span class=\"w\">  </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">IPCMessage</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">ipc_message</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\"></a><span class=\"w\">  </span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"w\"> </span><span class=\"n\">message</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\"></a><span class=\"w\">  </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">success</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\"></a><span class=\"w\">    </span><span class=\"n\">message</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">stub_message_queue_</span><span class=\"o\">-&gt;</span><span class=\"n\">Pop</span><span class=\"p\">(</span><span class=\"mi\">1000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\"></a>\n<a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\"></a><span class=\"w\">  </span><span class=\"n\">ipc_message</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">IPCMessage</span><span class=\"o\">::</span><span class=\"n\">LoadFromSharedMemory</span><span class=\"p\">(</span><span class=\"n\">shm_pool_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">message</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\"></a>\n<a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">ipc_message</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-14\" name=\"__codelineno-7-14\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\nstub\u8fdb\u7a0b\u7684\u6838\u5fc3\u903b\u8f91\u5c31\u662f\u8c03\u7528RunCommand\u65b9\u6cd5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u4f1a\u4ecestub_message_queue_\u4e2d\u53d6\u51fa\u6d88\u606f\uff0c\u7136\u540e\u6839\u636e\u6d88\u606f\u7c7b\u578b\u6267\u884c\u4e0d\u540c\u7684\u903b\u8f91\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-8-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-12\">12</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\"></a><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">IPCMessage</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">ipc_message</span><span class=\"p\">;</span>\n<a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\"></a><span class=\"p\">{</span>\n<a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\"></a><span class=\"c1\">// Release the GIL lock when waiting for new message. Without this line, the</span>\n<a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\"></a><span class=\"c1\">// other threads in the user&#39;s Python model cannot make progress if they</span>\n<a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\"></a><span class=\"c1\">// give up GIL.</span>\n<a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\"></a><span class=\"n\">py</span><span class=\"o\">::</span><span class=\"n\">gil_scoped_release</span><span class=\"w\"> </span><span class=\"n\">release</span><span class=\"p\">;</span>\n<a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\"></a><span class=\"n\">ipc_message</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">PopMessage</span><span class=\"p\">();</span>\n<a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\"></a><span class=\"k\">switch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ipc_message</span><span class=\"o\">-&gt;</span><span class=\"n\">Command</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\"></a><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"no\">PYTHONSTUB_CommandType</span><span class=\"o\">::</span><span class=\"no\">PYTHONSTUB_InitializeRequest</span><span class=\"p\">:</span><span class=\"w\"> </span>\n<a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\"></a><span class=\"c1\">//...</span>\n<a id=\"__codelineno-8-12\" name=\"__codelineno-8-12\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h3 id=\"pybind11\u8c03\u7528python\u903b\u8f91\">pybind11\u8c03\u7528python\u903b\u8f91<a class=\"headerlink\" href=\"#pybind11\u8c03\u7528python\u903b\u8f91\" title=\"Permanent link\">&para;</a></h3>\n<p>stub\u662f\u4e00\u4e2ac++\u5b9e\u73b0\u7684\u8fdb\u7a0b\uff0c\u5b83\u6536\u5230initialize_message\u540e\uff0c\u4f1a\u901a\u8fc7pybind11\u5e93\u3002</p>\n<p>pybind11\u5e93\u53ef\u4ee5\u8c03\u7528\u7528\u6237\u5b9e\u73b0\u7684python\u903b\u8f91\uff0c\u6bd4\u5982\u83b7\u53d6python\u7c7b\u3001\u8c03\u7528\u7c7b\u529f\u80fd\u51fd\u6570\u3002\u8fd9\u91cc\u7b80\u5355\u653e\u4e00\u4e0b\u4ee3\u7801\uff0c\u5f88\u5bb9\u6613\u7406\u89e3\uff1a</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-9-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-24\">24</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-25\">25</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-26\">26</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-27\">27</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-28\">28</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-29\">29</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-30\">30</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-31\">31</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-32\">32</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-33\">33</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-34\">34</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-35\">35</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-36\">36</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-37\">37</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-38\">38</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-39\">39</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;pybind11/embed.h&gt;</span>\n<a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;pybind11/numpy.h&gt;</span>\n<a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;pybind11/stl.h&gt;</span>\n<a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\"></a><span class=\"k\">namespace</span><span class=\"w\"> </span><span class=\"nn\">py</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nn\">pybind11</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\"></a><span class=\"kt\">void</span>\n<a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\"></a><span class=\"nf\">Stub::Initialize</span><span class=\"p\">(</span><span class=\"n\">bi</span><span class=\"o\">::</span><span class=\"n\">managed_external_buffer</span><span class=\"o\">::</span><span class=\"n\">handle_t</span><span class=\"w\"> </span><span class=\"n\">map_handle</span><span class=\"p\">)</span>\n<a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\"></a><span class=\"p\">{</span>\n<a id=\"__codelineno-9-8\" name=\"__codelineno-9-8\"></a><span class=\"w\">  </span><span class=\"n\">py</span><span class=\"o\">::</span><span class=\"k\">module</span><span class=\"w\"> </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">StubSetup</span><span class=\"p\">();</span>\n<a id=\"__codelineno-9-9\" name=\"__codelineno-9-9\"></a>\n<a id=\"__codelineno-9-10\" name=\"__codelineno-9-10\"></a><span class=\"w\">  </span><span class=\"n\">py</span><span class=\"o\">::</span><span class=\"k\">module</span><span class=\"w\"> </span><span class=\"n\">python_backend_utils</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-9-11\" name=\"__codelineno-9-11\"></a><span class=\"w\">      </span><span class=\"n\">py</span><span class=\"o\">::</span><span class=\"n\">module_</span><span class=\"o\">::</span><span class=\"k\">import</span><span class=\"p\">(</span><span class=\"s\">&quot;triton_python_backend_utils&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-9-12\" name=\"__codelineno-9-12\"></a><span class=\"w\">  </span><span class=\"n\">py</span><span class=\"o\">::</span><span class=\"k\">module</span><span class=\"w\"> </span><span class=\"n\">c_python_backend_utils</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-9-13\" name=\"__codelineno-9-13\"></a><span class=\"w\">      </span><span class=\"n\">py</span><span class=\"o\">::</span><span class=\"n\">module_</span><span class=\"o\">::</span><span class=\"k\">import</span><span class=\"p\">(</span><span class=\"s\">&quot;c_python_backend_utils&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-9-14\" name=\"__codelineno-9-14\"></a><span class=\"w\">  </span><span class=\"c1\">// ......</span>\n<a id=\"__codelineno-9-15\" name=\"__codelineno-9-15\"></a><span class=\"w\">  </span><span class=\"n\">c_python_backend_utils</span><span class=\"p\">.</span><span class=\"n\">attr</span><span class=\"p\">(</span><span class=\"s\">&quot;shared_memory&quot;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">py</span><span class=\"o\">::</span><span class=\"n\">cast</span><span class=\"p\">(</span><span class=\"n\">shm_pool_</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">());</span>\n<a id=\"__codelineno-9-16\" name=\"__codelineno-9-16\"></a>\n<a id=\"__codelineno-9-17\" name=\"__codelineno-9-17\"></a><span class=\"w\">  </span><span class=\"n\">async_event_loop_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">py</span><span class=\"o\">::</span><span class=\"n\">none</span><span class=\"p\">();</span>\n<a id=\"__codelineno-9-18\" name=\"__codelineno-9-18\"></a><span class=\"w\">  </span><span class=\"n\">background_futures_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">py</span><span class=\"o\">::</span><span class=\"n\">set</span><span class=\"p\">();</span>\n<a id=\"__codelineno-9-19\" name=\"__codelineno-9-19\"></a>\n<a id=\"__codelineno-9-20\" name=\"__codelineno-9-20\"></a><span class=\"w\">  </span><span class=\"c1\">// \u521b\u5efa\u4e00\u4e2aTritonPythonModel\u5bf9\u8c61\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u662f\u7528\u6237\u5b9e\u73b0\u7684python\u7c7b\uff0c\u7528\u6237\u9700\u8981\u5728\u7c7b\u4e2d\u5b9e\u73b0initialize\u3001execute\u3001finalizer\u7b49\u51fd\u6570</span>\n<a id=\"__codelineno-9-21\" name=\"__codelineno-9-21\"></a><span class=\"w\">  </span><span class=\"n\">py</span><span class=\"o\">::</span><span class=\"n\">object</span><span class=\"w\"> </span><span class=\"n\">TritonPythonModel</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">sys</span><span class=\"p\">.</span><span class=\"n\">attr</span><span class=\"p\">(</span><span class=\"s\">&quot;TritonPythonModel&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-9-22\" name=\"__codelineno-9-22\"></a><span class=\"w\">  </span><span class=\"n\">model_instance_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TritonPythonModel</span><span class=\"p\">();</span>\n<a id=\"__codelineno-9-23\" name=\"__codelineno-9-23\"></a>\n<a id=\"__codelineno-9-24\" name=\"__codelineno-9-24\"></a><span class=\"w\">  </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unordered_map</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-25\" name=\"__codelineno-9-25\"></a><span class=\"w\">  </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">PbMap</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">pb_map_shm</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<a id=\"__codelineno-9-26\" name=\"__codelineno-9-26\"></a><span class=\"w\">      </span><span class=\"n\">PbMap</span><span class=\"o\">::</span><span class=\"n\">LoadFromSharedMemory</span><span class=\"p\">(</span><span class=\"n\">shm_pool_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">map_handle</span><span class=\"p\">);</span>\n<a id=\"__codelineno-9-27\" name=\"__codelineno-9-27\"></a><span class=\"w\">  </span><span class=\"c1\">// Get the unordered_map representation of the map in shared memory.</span>\n<a id=\"__codelineno-9-28\" name=\"__codelineno-9-28\"></a><span class=\"w\">  </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pb_map_shm</span><span class=\"o\">-&gt;</span><span class=\"n\">UnorderedMap</span><span class=\"p\">();</span>\n<a id=\"__codelineno-9-29\" name=\"__codelineno-9-29\"></a><span class=\"w\">  </span><span class=\"n\">py</span><span class=\"o\">::</span><span class=\"n\">dict</span><span class=\"w\"> </span><span class=\"n\">model_config_params</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-30\" name=\"__codelineno-9-30\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">auto</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-31\" name=\"__codelineno-9-31\"></a><span class=\"w\">    </span><span class=\"n\">model_config_params</span><span class=\"p\">[</span><span class=\"n\">pair</span><span class=\"p\">.</span><span class=\"n\">first</span><span class=\"p\">.</span><span class=\"n\">c_str</span><span class=\"p\">()]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"p\">.</span><span class=\"n\">second</span><span class=\"p\">;</span>\n<a id=\"__codelineno-9-32\" name=\"__codelineno-9-32\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-9-33\" name=\"__codelineno-9-33\"></a>\n<a id=\"__codelineno-9-34\" name=\"__codelineno-9-34\"></a><span class=\"w\">  </span><span class=\"c1\">// Call initialize if exists.</span>\n<a id=\"__codelineno-9-35\" name=\"__codelineno-9-35\"></a><span class=\"w\">  </span><span class=\"c1\">// \u8c03\u7528\u7528\u6237\u5b9e\u73b0\u7684initialize\u51fd\u6570</span>\n<a id=\"__codelineno-9-36\" name=\"__codelineno-9-36\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">py</span><span class=\"o\">::</span><span class=\"n\">hasattr</span><span class=\"p\">(</span><span class=\"n\">model_instance_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;initialize&quot;</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-9-37\" name=\"__codelineno-9-37\"></a><span class=\"w\">    </span><span class=\"n\">model_instance_</span><span class=\"p\">.</span><span class=\"n\">attr</span><span class=\"p\">(</span><span class=\"s\">&quot;initialize&quot;</span><span class=\"p\">)(</span><span class=\"n\">model_config_params</span><span class=\"p\">);</span>\n<a id=\"__codelineno-9-38\" name=\"__codelineno-9-38\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n<a id=\"__codelineno-9-39\" name=\"__codelineno-9-39\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h2 id=\"\u603b\u7ed3\">\u603b\u7ed3<a class=\"headerlink\" href=\"#\u603b\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u672c\u6587\u7531\u4e8e\u7bc7\u5e45\u9650\u5236\uff0c\u4ecb\u7ecd\u4e86triton\u7684IPC\u901a\u4fe1\u673a\u5236\uff0c\u4ee5\u53castub\u8fdb\u7a0b\u7684\u521d\u59cb\u5316\u8fc7\u7a0b\uff0c\u4ee5\u53ca\u4ecb\u7ecdstub\u8fdb\u7a0b\u5982\u4f55\u6267\u884c\u7528\u6237\u5b9e\u73b0\u7684python\u903b\u8f91\u3002\u5176\u4e2d\u7684\u8fdb\u7a0b\u95f4\u901a\u4fe1\u673a\u5236\u548cpybind11\u8c03\u7528python\u903b\u8f91\uff0c\u53ef\u4ee5\u590d\u7528\u5230\u4f60\u81ea\u5df1\u7684\u9879\u76ee\u4e2d\u3002\u8fd9\u79cd\u8de8\u8bed\u8a00\u8c03\u7528\u5f88\u5e38\u89c1\uff0c\u5e38\u89c1\u7684\u8fd8\u6709c++\u4e2d\u8c03\u7528lua\u3001\u8c03\u7528js\u7b49\u3002</p>\n<p>\u6d88\u606f\u961f\u5217\u4f7f\u7528\u5230\u4e86SharedMemoryManager\u7c7b\uff0c\u8be5\u7c7b\u91c7\u7528boost.interprocess\u5e93\u5b9e\u73b0\u3002\u5173\u4e8e<a href=\"https://github.com/triton-inference-server/python_backend/blob/main/src/message_queue.h#L67\">\u6d88\u606f\u961f\u5217\u7684\u5b9e\u73b0</a>\u4ee5\u53ca<a href=\"https://github.com/triton-inference-server/python_backend/blob/main/src/shm_manager.h#L44\">\u5171\u4eab\u5185\u5b58\u7684boost.interprocess\u5e93\u7684\u4f7f\u7528</a>\uff0c\u53ef\u4ee5\u53c2\u8003\u6e90\u4ee3\u7801\u5b9e\u73b0\u3002\u540e\u7eed\u6587\u7ae0\u53ef\u80fd\u4f1a\u5c55\u5f00\u4ecb\u7ecd\u3002</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/cutlass\u5e93\u4e2d\u7684\u5c3e\u58f0\u878d\u5408epilogue-fusion\u548cepilogue-visitor-trees/\" target=\"_blank\">CUTLASS\u5e93\u4e2d\u7684\u5c3e\u58f0\u878d\u5408(Epilogue Fusion)\u548cEpilogue Visitor Trees</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/\u4ecedeepseek\u5f00\u6e90\u5e933fs\u4e2d\u5b66\u4e60fuse\u7684\u4f7f\u7528-\u5982\u4f55\u5f00\u53d1\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e00/\" target=\"_blank\">\u4eceDeepseek\u5f00\u6e90\u5e933FS\u4e2d\u5b66\u4e60fuse\u7684\u4f7f\u7528-\u5982\u4f55\u5f00\u53d1\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff08\u4e00\uff09</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-06-21T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        },
        {
            "id": "https://github.com/KenForever1/blog/%E5%87%BD%E6%95%B0hookld_preload%E5%AE%A1%E8%AE%A1%E6%B5%81%E5%8A%AB%E6%8C%81ld_audit%E5%8F%8A%E5%87%BD%E6%95%B0%E6%8F%92%E6%A1%A9/",
            "url": "https://github.com/KenForever1/blog/%E5%87%BD%E6%95%B0hookld_preload%E5%AE%A1%E8%AE%A1%E6%B5%81%E5%8A%AB%E6%8C%81ld_audit%E5%8F%8A%E5%87%BD%E6%95%B0%E6%8F%92%E6%A1%A9/",
            "title": "\u51fd\u6570Hook\uff08LD_PRELOAD\uff09\u3001\u5ba1\u8ba1\u6d41\u52ab\u6301\uff08LD_AUDIT\uff09\u53ca\u51fd\u6570\u63d2\u6869",
            "content_html": "<p>Linux\u4ece\u7b26\u53f7\u52ab\u6301\u5230\u8fd0\u884c\u65f6\u8ffd\u8e2a\uff1a\u51fd\u6570Hook\uff08LD_PRELOAD\uff09\u3001\u5ba1\u8ba1\u6d41\u52ab\u6301\uff08LD_AUDIT\uff09\u53ca\u51fd\u6570\u63d2\u6869\u3002</p>\n<!-- more -->\n<h2 id=\"ldprload\u65b9\u5f0f\u8fdb\u884chook\">LDPRLOAD\u65b9\u5f0f\u8fdb\u884cHook<a class=\"headerlink\" href=\"#ldprload\u65b9\u5f0f\u8fdb\u884chook\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"ldprload\u65b9\u5f0f\u8fdb\u884chook_1\">LDPRLOAD\u65b9\u5f0f\u8fdb\u884cHook<a class=\"headerlink\" href=\"#ldprload\u65b9\u5f0f\u8fdb\u884chook_1\" title=\"Permanent link\">&para;</a></h3>\n<p>LD_PRELOAD\u5141\u8bb8\u5728\u7a0b\u5e8f\u8fd0\u884c\u65f6\u4f18\u5148\u52a0\u8f7d\u6307\u5b9a\u7684\u52a8\u6001\u94fe\u63a5\u5e93(.so\u6587\u4ef6)\uff0c\u8986\u76d6\u9ed8\u8ba4\u7684\u5e93\u51fd\u6570\u5b9e\u73b0\u3002\u52a8\u6001\u94fe\u63a5\u5668\u4f1a\u4f18\u5148\u68c0\u67e5LD_PRELOAD\u6307\u5b9a\u7684\u5e93\uff0c\u82e5\u5176\u4e2d\u5b58\u5728\u4e0e\u7a0b\u5e8f\u8c03\u7528\u7684\u540c\u540d\u51fd\u6570\uff0c\u5219\u4f7f\u7528\u8be5\u5e93\u4e2d\u7684\u5b9e\u73b0\u800c\u975e\u7cfb\u7edf\u9ed8\u8ba4\u7248\u672c\u3002\u51fd\u6570\u52ab\u6301\u4e0eHook\uff0c\u6bd4\u5982\u66ff\u6362malloc\u7684\u5b9e\u73b0\uff0c\u66ff\u6362so\u5e93\u4e2d\u7684\u51fd\u6570\uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7LD_PRELOAD\u5b9e\u73b0\u3002</p>\n<p>\u4e3e\u4e2a\u76f8\u5173\u7684\u4f7f\u7528\u4f8b\u5b50\uff1a\n+ <strong>jemalloc\u7684\u4f7f\u7528</strong></p>\n<p>\u5728<a href=\"https://github.com/jemalloc/jemalloc/wiki/Getting-Started\">jemalloc\u7684\u4f7f\u7528\u4e2d</a>, \u6709\u51e0\u79cd\u65b9\u6cd5\u53ef\u4ee5\u5c06jemalloc\u96c6\u6210\u5230\u5e94\u7528\u7a0b\u5e8f\u4e2d\u3002</p>\n<p>\u6700\u7b80\u5355\u7684\u5c31\u662f\uff0c\u4f7f\u7528LD_PRELOAD\u73af\u5883\u53d8\u91cf\u5728\u8fd0\u884c\u65f6\u5c06jemalloc\u6ce8\u5165\u5e94\u7528\u7a0b\u5e8f\u3002\u8bf7\u6ce8\u610f\uff0c\u53ea\u6709\u5f53\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u6ca1\u6709\u9759\u6001\u94fe\u63a5malloc\u5b9e\u73b0\u65f6\uff0c\u6b64\u65b9\u6cd5\u624d\u6709\u6548\u3002</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-0-1\">1</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a><span class=\"nv\">LD_PRELOAD</span><span class=\"o\">=</span><span class=\"sb\">`</span>jemalloc-config<span class=\"w\"> </span>--libdir<span class=\"sb\">`</span>/libjemalloc.so.<span class=\"sb\">`</span>jemalloc-config<span class=\"w\"> </span>--revision<span class=\"sb\">`</span><span class=\"w\"> </span>app\n</code></pre></div></td></tr></table></div>\n\u9664\u4e86\u8fd9\u79cd\u65b9\u5f0f\uff0c\u5c31\u662f\u7f16\u8bd1\u65f6\u52a8\u6001\u94fe\u63a5\u548c\u9759\u6001\u94fe\u63a5jemalloc\u5230\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u3002\n\u5728\u5f00\u53d1\u4e2d\uff0c\u53ef\u4ee5\u5229\u7528\u8fd9\u79cd\u65b9\u5f0f\u67e5\u627e\u5185\u5b58\u5d29\u6e83\u7684Bug\u3001\u5185\u5b58\u5206\u914d\u60c5\u51b5\u5206\u6790\u3001Heap Profiler\u3001\u89e3\u51b3\u5185\u5b58\u6cc4\u9732\u7b49\u3002</p>\n<h3 id=\"rtld_next\u65b9\u5f0f\u8fdb\u884chook\">RTLD_NEXT\u65b9\u5f0f\u8fdb\u884cHook<a class=\"headerlink\" href=\"#rtld_next\u65b9\u5f0f\u8fdb\u884chook\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9664\u4e86LD_PRELOAD\u65b9\u5f0f\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7\u200c<strong>dlsym RTLD_NEXT\u200c</strong>\u8fdb\u884cHook\u3002</p>\n<p>\u5982\u679cdlsym\u6216dlvsym\u51fd\u6570\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u7684\u503c\u88ab\u8bbe\u7f6e\u4e3aRTLD_NEXT\uff0c\u90a3\u4e48\u8be5\u51fd\u6570\u8fd4\u56de\u4e0b\u4e00\u4e2a\u5171\u4eab\u5bf9\u8c61\u4e2d\u540d\u4e3aNAME\u7684\u7b26\u53f7\u7684\u8fd0\u884c\u65f6\u5730\u5740\uff0c\u901a\u5e38\u7528\u4e8e\u5728Hook\u4ee3\u7801\u4e2d\u8c03\u7528\u539f\u59cb\u51fd\u6570\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e2a\u81ea\u5b9a\u4e49malloc\u51fd\u6570\uff0c\u901a\u8fc7RTLD_NEXT\u62ff\u5230\u539f\u59cbmalloc\u7684\u6307\u9488\uff0c\u4ece\u800c\u53ef\u4ee5\u5728\u81ea\u5b9a\u4e49malloc\u4e2d\u8c03\u7528\u539f\u59cbmalloc\u51fd\u6570\u3002\u8fbe\u5230Hook\u7684\u76ee\u7684\u3002</p>\n<p>\u8fd0\u884c\u65f6\u7b26\u53f7\u89e3\u6790\u51fd\u6570\uff0c\u7528\u4e8e\u5728\u5df2\u52a0\u8f7d\u7684\u5e93\u94fe\u4e2d\u67e5\u627e\u4e0b\u4e00\u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7b26\u53f7\u5b9e\u73b0\u3002</p>\n<p>\u4e3e\u4e2a\u76f8\u5173\u7684\u4f7f\u7528\u4f8b\u5b50\uff1a\n+ <strong>\u534f\u7a0b\u7f51\u7edc\u5e93\u4e2dhook</strong></p>\n<p><a href=\"https://github.com/gatsbyd/melon/blob/master/src/Hook.cpp\">\u57fa\u4e8e\u534f\u7a0b\u548c\u4e8b\u4ef6\u5faa\u73af\u7684c++\u7f51\u7edc\u5e93</a>\u4e2d\uff0c\u901a\u8fc7dlsym RTLD_NEXT\u5b9e\u73b0hook\u3002\u5305\u62ec\u4e86hook read\u3001recv\u3001send\u3001sleep\u7b49\u51fd\u6570\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-1-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-1-2\">2</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a><span class=\"cp\">#define DLSYM(name) \\</span>\n<a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a><span class=\"cp\">        name ## _f = (name ## _t)::dlsym(RTLD_NEXT, #name);</span>\n</code></pre></div></td></tr></table></div>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-2-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-2-14\">14</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">sleep</span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">seconds</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a><span class=\"w\">    </span><span class=\"n\">melon</span><span class=\"o\">::</span><span class=\"n\">Processer</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">processer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">melon</span><span class=\"o\">::</span><span class=\"n\">Processer</span><span class=\"o\">::</span><span class=\"n\">GetProcesserOfThisThread</span><span class=\"p\">();</span>\n<a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">melon</span><span class=\"o\">::</span><span class=\"n\">isHookEnabled</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a><span class=\"w\">        </span><span class=\"c1\">// \u4e0dhook\u65f6\u76f4\u63a5\u8c03\u7528\u7cfb\u7edf\u51fd\u6570\uff0csleep_f = dlsym(RTLD_NEXT, &quot;sleep&quot;);</span>\n<a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">sleep_f</span><span class=\"p\">(</span><span class=\"n\">seconds</span><span class=\"p\">);</span>\n<a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\"></a>\n<a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\"></a><span class=\"w\">    </span><span class=\"c1\">// hook\u65f6\uff0c\u5c06\u5f53\u524d\u534f\u7a0b\u6302\u8d77\uff0c\u7b49\u5f85seconds\u79d2\u540e\u7ee7\u7eed\u6267\u884c</span>\n<a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\"></a><span class=\"w\">    </span><span class=\"n\">melon</span><span class=\"o\">::</span><span class=\"n\">Scheduler</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">scheduler</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">processer</span><span class=\"o\">-&gt;</span><span class=\"n\">getScheduler</span><span class=\"p\">();</span>\n<a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\"></a><span class=\"w\">    </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">scheduler</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">);</span>\n<a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\"></a><span class=\"w\">    </span><span class=\"n\">scheduler</span><span class=\"o\">-&gt;</span><span class=\"n\">runAt</span><span class=\"p\">(</span><span class=\"n\">melon</span><span class=\"o\">::</span><span class=\"n\">Timestamp</span><span class=\"o\">::</span><span class=\"n\">now</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">seconds</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">melon</span><span class=\"o\">::</span><span class=\"n\">Timestamp</span><span class=\"o\">::</span><span class=\"n\">kMicrosecondsPerSecond</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">melon</span><span class=\"o\">::</span><span class=\"n\">Coroutine</span><span class=\"o\">::</span><span class=\"n\">GetCurrentCoroutine</span><span class=\"p\">());</span>\n<a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\"></a><span class=\"w\">    </span><span class=\"n\">melon</span><span class=\"o\">::</span><span class=\"n\">Coroutine</span><span class=\"o\">::</span><span class=\"n\">SwapOut</span><span class=\"p\">();</span>\n<a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<h2 id=\"ld_audit\u94fe\u63a5\u5668\u76d1\u542c\u673a\u5236\">LD_AUDIT\u94fe\u63a5\u5668\u76d1\u542c\u673a\u5236<a class=\"headerlink\" href=\"#ld_audit\u94fe\u63a5\u5668\u76d1\u542c\u673a\u5236\" title=\"Permanent link\">&para;</a></h2>\n<p>\u901a\u8fc7\u524d\u9762\u7684\u4ecb\u7ecd\uff0c\u4f60\u5bf9LD_LIBRARY\u3001LD_PRELOAD\u80af\u5b9a\u5f88\u719f\u6089\u4e86\u3002LD_AUDIT\u662fLinux\u7cfb\u7edf\u4e2dglibc\u52a8\u6001\u94fe\u63a5\u5668(ld.so)\u7684\u53e6\u4e00\u4e2a\u73af\u5883\u53d8\u91cf\uff0c\u7528\u4e8e\u6307\u5b9a\u5ba1\u8ba1\u5e93(audit library)\u7684\u8def\u5f84\uff0c\u4e3b\u8981\u7528\u4e8e\u76d1\u63a7\u548c\u62e6\u622a\u52a8\u6001\u94fe\u63a5\u5e93\u7684\u52a0\u8f7d\u8fc7\u7a0b</p>\n<p>\u901a\u8fc7LD_AUDIT\u94fe\u63a5\u5668\u76d1\u542c\u673a\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u64cd\u7eb5glibc\u7684\u52a8\u6001\u94fe\u63a5\u8fc7\u7a0b\uff0c\u6bd4\u5982\u53ef\u4ee5\u62e6\u622a\u52a8\u6001\u94fe\u63a5\u5e93\u7684\u52a0\u8f7d\u8fc7\u7a0b\uff0c\u6216\u8005\u62e6\u622a\u52a8\u6001\u94fe\u63a5\u5e93\u7684\u7b26\u53f7\u89e3\u6790\u8fc7\u7a0b\u3002\u5728xz-sshd\u6f0f\u6d1e\u4e2d\uff0c\u653b\u51fb\u8005\u901a\u8fc7LD_AUDIT\u52ab\u6301RSA\u89e3\u5bc6\u51fd\u6570\u8c03\u7528\u94fe\uff0c\u5b9e\u73b0\u6743\u9650\u63d0\u5347\u3002</p>\n<p>\u770b\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff1a</p>\n<p><div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-3-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-23\">23</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-3-24\">24</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\"></a><span class=\"c1\">// audit_example.c</span>\n<a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\"></a><span class=\"cp\">#define _GNU_SOURCE</span>\n<a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;link.h&gt;</span>\n<a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n<a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\"></a>\n<a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\"></a><span class=\"c1\">// \u5fc5\u987b\u5b9e\u73b0\u7684\u7248\u672c\u68c0\u67e5\u51fd\u6570</span>\n<a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\"></a><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">la_version</span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\"></a><span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;\u5ba1\u8ba1\u5e93\u7248\u672c: %u (\u652f\u6301\u6700\u9ad8\u7248\u672c%u)</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">LAV_CURRENT</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">LAV_CURRENT</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// \u8fd4\u56de\u652f\u6301\u7684\u7248\u672c\u53f7</span>\n<a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\"></a>\n<a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\"></a><span class=\"c1\">// \u5e93\u52a0\u8f7d\u65f6\u89e6\u53d1\u7684\u56de\u8c03</span>\n<a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\"></a><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">la_objopen</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">link_map</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">map</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Lmid_t</span><span class=\"w\"> </span><span class=\"n\">lmid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">uintptr_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">cookie</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\"></a><span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;\u68c0\u6d4b\u5230\u5e93\u52a0\u8f7d: %s (ID: %p)</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"o\">-&gt;</span><span class=\"n\">l_name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"o\">*</span><span class=\"n\">cookie</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">LA_FLG_BINDTO</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">LA_FLG_BINDFROM</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// \u5141\u8bb8\u7b26\u53f7\u7ed1\u5b9a\u8ffd\u8e2a</span>\n<a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\"></a>\n<a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\"></a><span class=\"c1\">// \u7b26\u53f7\u7ed1\u5b9a\u524d\u89e6\u53d1\u7684\u56de\u8c03</span>\n<a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\"></a><span class=\"kt\">uintptr_t</span><span class=\"w\"> </span><span class=\"nf\">la_symbind64</span><span class=\"p\">(</span><span class=\"n\">Elf64_Sym</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">sym</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">ndx</span><span class=\"p\">,</span>\n<a id=\"__codelineno-3-20\" name=\"__codelineno-3-20\"></a><span class=\"w\">                      </span><span class=\"kt\">uintptr_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">refcook</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">uintptr_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">defcook</span><span class=\"p\">,</span>\n<a id=\"__codelineno-3-21\" name=\"__codelineno-3-21\"></a><span class=\"w\">                      </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">flags</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">symname</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-3-22\" name=\"__codelineno-3-22\"></a><span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;\u7b26\u53f7\u7ed1\u5b9a: %s (\u5730\u5740: %#lx)</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">symname</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sym</span><span class=\"o\">-&gt;</span><span class=\"n\">st_value</span><span class=\"p\">);</span>\n<a id=\"__codelineno-3-23\" name=\"__codelineno-3-23\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">sym</span><span class=\"o\">-&gt;</span><span class=\"n\">st_value</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// \u8fd4\u56de\u539f\u59cb\u5730\u5740\uff08\u53ef\u4fee\u6539\uff09</span>\n<a id=\"__codelineno-3-24\" name=\"__codelineno-3-24\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-4-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-6\">6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-7\">7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-8\">8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-4-9\">9</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\"></a><span class=\"c1\">// test_program.c</span>\n<a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n<a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\"></a><span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;hello</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\"></a><span class=\"c1\">// \u7f16\u8bd1\u5ba1\u8ba1\u5e93\uff1agcc -shared -fPIC audit_example.c -o libaudit.so -ldl</span>\n<a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\"></a><span class=\"c1\">// \u7f16\u8bd1\u6d4b\u8bd5\u7a0b\u5e8f\uff1agcc test_program.c -o test -ldl</span>\n<a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\"></a><span class=\"c1\">// \u8fd0\u884c\u6d4b\u8bd5\uff1aLD_AUDIT=./libaudit.so ./test</span>\n</code></pre></div></td></tr></table></div>\n\u6253\u5370\u8f93\u51fa\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-5-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-20\">20</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-21\">21</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-22\">22</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-5-23\">23</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\"></a>\u5ba1\u8ba1\u5e93\u7248\u672c:<span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">(</span>\u652f\u6301\u6700\u9ad8\u7248\u672c2<span class=\"o\">)</span>\n<a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\"></a>\u68c0\u6d4b\u5230\u5e93\u52a0\u8f7d:<span class=\"w\">  </span><span class=\"o\">(</span>ID:<span class=\"w\"> </span>0xffff87a2c370<span class=\"o\">)</span>\n<a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\"></a>\u68c0\u6d4b\u5230\u5e93\u52a0\u8f7d:<span class=\"w\"> </span>/lib/ld-linux-aarch64.so.1<span class=\"w\"> </span><span class=\"o\">(</span>ID:<span class=\"w\"> </span>0xffff87a2bb88<span class=\"o\">)</span>\n<a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\"></a>\u68c0\u6d4b\u5230\u5e93\u52a0\u8f7d:<span class=\"w\"> </span>linux-vdso.so.1<span class=\"w\"> </span><span class=\"o\">(</span>ID:<span class=\"w\"> </span>0xffff87a2c950<span class=\"o\">)</span>\n<a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\"></a>\u68c0\u6d4b\u5230\u5e93\u52a0\u8f7d:<span class=\"w\"> </span>/lib/aarch64-linux-gnu/libc.so.6<span class=\"w\"> </span><span class=\"o\">(</span>ID:<span class=\"w\"> </span>0xffff87a1d880<span class=\"o\">)</span>\n<a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>__libc_start_main<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff87597434<span class=\"o\">)</span>\n<a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>__cxa_finalize<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff875ad220<span class=\"o\">)</span>\n<a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>abort<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff8759704c<span class=\"o\">)</span>\n<a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>puts<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff875dae70<span class=\"o\">)</span>\n<a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>calloc<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff875fe460<span class=\"o\">)</span>\n<a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>free<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff875fdbc4<span class=\"o\">)</span>\n<a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>malloc<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff875fd630<span class=\"o\">)</span>\n<a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>realloc<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff875fde20<span class=\"o\">)</span>\n<a id=\"__codelineno-5-14\" name=\"__codelineno-5-14\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>_dl_catch_exception<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff8769d290<span class=\"o\">)</span>\n<a id=\"__codelineno-5-15\" name=\"__codelineno-5-15\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>_dl_signal_exception<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff8769d1e4<span class=\"o\">)</span>\n<a id=\"__codelineno-5-16\" name=\"__codelineno-5-16\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>__tls_get_addr<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff87a00cd0<span class=\"o\">)</span>\n<a id=\"__codelineno-5-17\" name=\"__codelineno-5-17\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>_dl_signal_error<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff8769d234<span class=\"o\">)</span>\n<a id=\"__codelineno-5-18\" name=\"__codelineno-5-18\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>_dl_catch_error<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff8769d390<span class=\"o\">)</span>\n<a id=\"__codelineno-5-19\" name=\"__codelineno-5-19\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>__tunable_get_val<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff87a02d40<span class=\"o\">)</span>\n<a id=\"__codelineno-5-20\" name=\"__codelineno-5-20\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>__getauxval<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff87655560<span class=\"o\">)</span>\n<a id=\"__codelineno-5-21\" name=\"__codelineno-5-21\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>_dl_audit_preinit<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff87a03774<span class=\"o\">)</span>\n<a id=\"__codelineno-5-22\" name=\"__codelineno-5-22\"></a>\u7b26\u53f7\u7ed1\u5b9a:<span class=\"w\"> </span>malloc<span class=\"w\"> </span><span class=\"o\">(</span>\u5730\u5740:<span class=\"w\"> </span>0xffff875fd630<span class=\"o\">)</span>\n<a id=\"__codelineno-5-23\" name=\"__codelineno-5-23\"></a>\u6d4b\u8bd5\u7a0b\u5e8f\u8fd0\u884c\u4e2d...\n</code></pre></div></td></tr></table></div>\n\u4e0d\u540c\u4e8eLD_PRELOAD\uff08\u5f3a\u5236\u9884\u52a0\u8f7d\u5e93\uff09\uff0cLD_AUDIT<strong>\u66f4\u4fa7\u91cd\u94fe\u63a5\u8fc7\u7a0b\u7684\u200c\u4e8b\u4ef6\u76d1\u63a7\u200c</strong>\u800c\u975e\u76f4\u63a5\u66ff\u6362\u51fd\u6570\u3002\u5f53\u7136\uff0c\u4e5f\u662f\u53ef\u4ee5\u52ab\u6301\u66ff\u6362\u51fd\u6570\u5b9e\u73b0\u7684\u3002</p>\n<p>\u5e94\u7528\u4f8b\u5b50\uff0c\u5728<a href=\"https://zhuanlan.zhihu.com/p/689983608\">xz-sshd\u6f0f\u6d1e\u53ef\u80fd\u7684\u539f\u7406\u89e3\u8bfb\u2014\u2014\u94fe\u63a5\u5668\u76d1\u542c\u673a\u5236</a>\u4e2d\uff0c\u901a\u8fc7la_symbind64\u51fd\u6570\u52ab\u6301RSA_public_decrypt\uff0c \u66ff\u6362\u4e3a\u81ea\u5df1\u5b9e\u73b0\u7684hijack_RSA_public_decrypt\u51fd\u6570\u3002\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-6-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-6-10\">10</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\"></a><span class=\"c1\">// Called when a symbol is bound</span>\n<a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\"></a><span class=\"kt\">uintptr_t</span><span class=\"w\"> </span><span class=\"nf\">la_symbind64</span><span class=\"p\">(</span><span class=\"n\">Elf64_Sym</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">sym</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">ndx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">uintptr_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">refcook</span><span class=\"p\">,</span>\n<a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\"></a><span class=\"w\">                     </span><span class=\"kt\">uintptr_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">defcook</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">flags</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">symname</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\"></a><span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;Symbol bound: %s</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">symname</span><span class=\"p\">);</span>\n<a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\"></a><span class=\"w\">    </span><span class=\"c1\">// Perform any custom actions here</span>\n<a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">strcmp</span><span class=\"p\">(</span><span class=\"n\">symname</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;RSA_public_decrypt&quot;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uintptr_t</span><span class=\"p\">)</span><span class=\"n\">hijack_RSA_public_decrypt</span><span class=\"p\">;</span>\n<a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n<a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">sym</span><span class=\"o\">-&gt;</span><span class=\"n\">st_value</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// Return the symbol&#39;s actual address</span>\n<a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div></p>\n<h2 id=\"gcc\u51fd\u6570\u63d2\u6869\u529f\u80fd-finstrument-functions\">GCC\u51fd\u6570\u63d2\u6869\u529f\u80fd\uff08-finstrument-functions\uff09<a class=\"headerlink\" href=\"#gcc\u51fd\u6570\u63d2\u6869\u529f\u80fd-finstrument-functions\" title=\"Permanent link\">&para;</a></h2>\n<p>GCC\u7684-finstrument-functions\u662f\u4e00\u4e2a\u5f3a\u5927\u7684\u7f16\u8bd1\u9009\u9879\uff0c\u7528\u4e8e\u5728\u51fd\u6570\u5165\u53e3\u548c\u51fa\u53e3\u81ea\u52a8\u63d2\u5165\u94a9\u5b50\u51fd\u6570\uff0c\u4e3b\u8981\u7528\u4e8e\u6027\u80fd\u5206\u6790\u548c\u8c03\u7528\u8ffd\u8e2a\u3002</p>\n<p>\u7f16\u8bd1\u65f6\u6dfb\u52a0\u8be5\u9009\u9879\u540e\uff0cGCC\u4f1a\u5728\u6bcf\u4e2a\u51fd\u6570\u7684\u5f00\u59cb\u63d2\u5165__cyg_profile_func_enter\uff0c\u5728\u51fd\u6570\u8fd4\u56de\u524d\u63d2\u5165__cyg_profile_func_exit\u3002\u8fd9\u4e24\u4e2a\u94a9\u5b50\u51fd\u6570\u7684\u53c2\u6570\u5305\u542b\u5f53\u524d\u51fd\u6570\u5730\u5740\u548c\u8c03\u7528\u8005\u5730\u5740\u3002\u901a\u8fc7\u8fd9\u4e2a\u529f\u80fd\uff0c\u6211\u4eec\u53ef\u4ee5\u7edf\u8ba1\u51fd\u6570\u8017\u65f6\uff0c\u5b9a\u4f4d\u6267\u884c\u5f02\u5e38\u7684\u51fd\u6570\uff0c\u5206\u6790\u6027\u80fd\u74f6\u9888\u7b49\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u7528ebpf\u76f4\u63a5\u6293\u53d6\u3002\u8bb0\u5f55\u51fd\u6570\u8c03\u7528\u8def\u5f84\uff0c\u8f85\u52a9\u8c03\u8bd5\u590d\u6742\u8c03\u7528\u5173\u7cfb\u7b49\u3002</p>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-7-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-15\">15</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-16\">16</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-17\">17</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-18\">18</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-19\">19</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-7-20\">20</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\"></a><span class=\"c1\">// instrument.c</span>\n<a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\"></a><span class=\"cp\">#define _GNU_SOURCE</span>\n<a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n<a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;dlfcn.h&gt;</span>\n<a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;time.h&gt;</span>\n<a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\"></a>\n<a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\"></a><span class=\"c1\">// \u5fc5\u987b\u7981\u6b62\u94a9\u5b50\u51fd\u6570\u81ea\u8eab\u88ab\u63d2\u6869</span>\n<a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">no_instrument_function</span><span class=\"p\">))</span>\n<a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\"></a><span class=\"n\">__cyg_profile_func_enter</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">func</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">caller</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\"></a><span class=\"w\">    </span><span class=\"n\">Dl_info</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\"></a><span class=\"w\">    </span><span class=\"n\">dladdr</span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">info</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\"></a><span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;\u25b6 ENTER: %s [%p]</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"p\">.</span><span class=\"n\">dli_sname</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"p\">.</span><span class=\"n\">dli_sname</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;unknown&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-7-14\" name=\"__codelineno-7-14\"></a>\n<a id=\"__codelineno-7-15\" name=\"__codelineno-7-15\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">no_instrument_function</span><span class=\"p\">))</span><span class=\"w\"> </span>\n<a id=\"__codelineno-7-16\" name=\"__codelineno-7-16\"></a><span class=\"n\">__cyg_profile_func_exit</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">func</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">caller</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-7-17\" name=\"__codelineno-7-17\"></a><span class=\"w\">    </span><span class=\"n\">Dl_info</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"p\">;</span>\n<a id=\"__codelineno-7-18\" name=\"__codelineno-7-18\"></a><span class=\"w\">    </span><span class=\"n\">dladdr</span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">info</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-19\" name=\"__codelineno-7-19\"></a><span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;\u25c0 EXIT: %s [%p]</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"p\">.</span><span class=\"n\">dli_sname</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"p\">.</span><span class=\"n\">dli_sname</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;unknown&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"p\">);</span>\n<a id=\"__codelineno-7-20\" name=\"__codelineno-7-20\"></a><span class=\"p\">}</span>\n</code></pre></div></td></tr></table></div>\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">C++</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-8-1\"> 1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-2\"> 2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-3\"> 3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-4\"> 4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-5\"> 5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-6\"> 6</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-7\"> 7</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-8\"> 8</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-9\"> 9</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-10\">10</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-11\">11</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-12\">12</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-13\">13</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-14\">14</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-8-15\">15</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\"></a><span class=\"c1\">// main.c</span>\n<a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n<a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\"></a>\n<a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">test_func</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\"></a><span class=\"w\">    </span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// \u6a21\u62df\u8017\u65f6\u64cd\u4f5c</span>\n<a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\"></a>\n<a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\"></a><span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;Start tracing...</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\"></a><span class=\"w\">    </span><span class=\"n\">test_func</span><span class=\"p\">();</span>\n<a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\"></a><span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;End tracing</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n<a id=\"__codelineno-8-12\" name=\"__codelineno-8-12\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<a id=\"__codelineno-8-13\" name=\"__codelineno-8-13\"></a><span class=\"p\">}</span>\n<a id=\"__codelineno-8-14\" name=\"__codelineno-8-14\"></a><span class=\"c1\">// gcc -finstrument-functions main.c instrument.c -ldl -rdynamic -o demo</span>\n<a id=\"__codelineno-8-15\" name=\"__codelineno-8-15\"></a><span class=\"c1\">// ./demo</span>\n</code></pre></div></td></tr></table></div>\n<p>\u8f93\u51fa\uff1a\n<div class=\"highlight\"><table class=\"highlighttable\"><tr><th colspan=\"2\" class=\"filename\"><span class=\"filename\">Bash</span></th></tr><tr><td class=\"linenos\"><div class=\"linenodiv\"><pre><span></span><span class=\"normal\"><a href=\"#__codelineno-9-1\">1</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-2\">2</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-3\">3</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-4\">4</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-5\">5</a></span>\n<span class=\"normal\"><a href=\"#__codelineno-9-6\">6</a></span></pre></div></td><td class=\"code\"><div><pre><span></span><code><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\"></a>\u25b6<span class=\"w\"> </span>ENTER:<span class=\"w\"> </span>main<span class=\"w\"> </span><span class=\"o\">[</span>0xaaaadcf80bf4<span class=\"o\">]</span>\n<a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\"></a>Start<span class=\"w\"> </span>tracing...\n<a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\"></a>\u25b6<span class=\"w\"> </span>ENTER:<span class=\"w\"> </span>test_func<span class=\"w\"> </span><span class=\"o\">[</span>0xaaaadcf80b94<span class=\"o\">]</span>\n<a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\"></a>\u25c0<span class=\"w\"> </span>EXIT:<span class=\"w\"> </span>test_func<span class=\"w\"> </span><span class=\"o\">[</span>0xaaaadcf80b94<span class=\"o\">]</span>\n<a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\"></a>End<span class=\"w\"> </span>tracing\n<a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\"></a>\u25c0<span class=\"w\"> </span>EXIT:<span class=\"w\"> </span>main<span class=\"w\"> </span><span class=\"o\">[</span>0xaaaadcf80bf4<span class=\"o\">]</span>\n</code></pre></div></td></tr></table></div></p>\n<p>\u4f7f\u7528__attribute__((no_instrument_function))\u907f\u514d\u94a9\u5b50\u51fd\u6570\u81ea\u8eab\u88ab\u63d2\u6869\u3002\u9700\u81ea\u5b9a\u4e49\u94a9\u5b50\u51fd\u6570\uff0c\u901a\u5e38\u7ed3\u5408dladdr\u89e3\u6790\u51fd\u6570\u540d\u548c\u6587\u4ef6\u540d\u3002</p>\n<p>\u901a\u8fc7addr2line\u5de5\u5177\u5c06\u5730\u5740\u8f6c\u6362\u4e3a\u6e90\u4ee3\u7801\u884c\u53f7\uff0c\u7ed3\u5408perf\u7b49\u5de5\u5177\u5206\u6790\u6027\u80fd\u3002</p>\n<p>\u8fd9\u4e2a\u529f\u80fd\u5177\u4f53\u548b\u7528\u7684\u5462\uff1f\u4e3e\u4e24\u4e2a\u4f8b\u5b50\uff1a</p>\n<ul>\n<li>\u5f00\u6e90\u5de5\u5177<a href=\"https://github.com/namhyung/uftrace\">uftrace</a>\u5c31\u4f7f\u7528\u5230\u4e86\u8fd9\u4e2a\u529f\u80fd\u83b7\u53d6\u6570\u636e, uftrace\u662f\u4e00\u6b3e\u7528\u4e8eC\u3001C++\u3001Rust\u548cPython\u7a0b\u5e8f\u7684\u51fd\u6570\u8c03\u7528\u56fe\u8ffd\u8e2a\u5de5\u5177\u3002</li>\n</ul>\n<blockquote>\n<p>User space C/C++/Rust functions, by either dynamically patching functions using -P., or else selective NOP patching using code compiled with -pg, -finstrument-functions or -fpatchable-function-entry=N.</p>\n</blockquote>\n<ul>\n<li><a href=\"https://zhuanlan.zhihu.com/p/706025483\">\u4f7f\u7528GCC\u51fd\u6570\u63d2\u6869\u529f\u80fd\u627e\u5230\u8017\u65f6\u5f02\u5e38\u7684\u51fd\u6570</a></li>\n</ul>\n<p>\u8fd9\u7bc7\u6587\u7ae0\u901a\u8fc7\u51fd\u6570\u63d2\u6869\uff0c\u5728\u51fd\u6570\u5165\u53e3\u548c\u51fa\u53e3\u81ea\u52a8\u63d2\u5165\u94a9\u5b50\u51fd\u6570\uff0c\u7528\u4e8e\u7edf\u8ba1\u51fd\u6570\u8017\u65f6\u3002\u5728cyg_profile_func_enter\u4e2d\u8bb0\u5f55\u51fd\u6570\u7684\u5f00\u59cbticks\uff0c\u5728cyg_profile_func_exit\u4e2d\u8bb0\u5f55\u51fd\u6570\u7684\u7ed3\u675fticks\uff0c\u4e24\u8005\u76f8\u51cf\u4fbf\u5f97\u5230\u4e86\u51fd\u6570\u8fd0\u884c\u6d88\u8017\u7684ticks\uff0c\u518d\u9664\u4ee5CPU\u9891\u7387\uff08g_cs_hz\uff09\u5f97\u5230\u8017\u65f6\u3002\u4f7f\u7528x86\u6307\u4ee4\u96c6\u67b6\u6784\u4e2d\u7684RDTSC\uff08Read Time Stamp Counter\uff09\u6307\u4ee4\u8bfb\u53d6\u5904\u7406\u5668\u7684\u65f6\u949f\u5468\u671f\u8ba1\u6570\u5668\u3002</p>\n<p>\u5982\u679c\u8017\u65f6\u5927\u4e8e5ms\uff0c\u4fbf\u5c06\u51fd\u6570\u6307\u9488\u548c\u8017\u65f6push\u5230\u4e00\u4e2a\u6808\u4e2d\uff0c\u8bb0\u5f55\u4e0b\u6765\uff0c\u540e\u7eed\u6253\u5370\u51fa\u6765\u3002</p>\n<style>\n.related-posts {\n  margin-top: 1.5rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(0,0,0,0.1);\n  max-height: none !important; /* \u9632\u6b62Safari\u9519\u8bef\u8ba1\u7b97\u9ad8\u5ea6 */\n  overflow: visible !important; /* \u9632\u6b62\u5185\u5bb9\u88ab\u622a\u65ad */\n}\n.related-posts h3 {\n  margin-top: 0;\n  margin-bottom: 0.5rem;\n  font-size: 1.2rem;\n  font-weight: 500;\n  line-height: 1.3;\n}\n.related-posts ul {\n  margin: 0 0 0.5rem 0 !important; /* \u5f3a\u5236\u8986\u76d6\u53ef\u80fd\u7684\u51b2\u7a81\u6837\u5f0f */\n  padding-left: 1.5rem;\n  list-style-position: outside;\n}\n.related-posts li {\n  margin-bottom: 0.25rem;\n  line-height: 1.4;\n}\n/* \u6697\u8272\u6a21\u5f0f\u9002\u914d */\n[data-md-color-scheme=\"slate\"] .related-posts {\n  border-top-color: rgba(255,255,255,0.1);\n}\n/* Safari\u7279\u5b9a\u4fee\u590d */\n@supports (-webkit-hyphens:none) {\n  .related-posts {\n    display: block;\n    position: relative;\n    height: auto !important;\n  }\n  .related-posts ul {\n    position: static;\n  }\n}\n</style>\n<div class=\"related-posts\">\n<h3>\ud83d\udcda \u76f8\u5173\u6587\u7ae0\u63a8\u8350</h3>\n<ul>\n<li><a href=\"https://kenforever1.github.io/blog/c\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898/\" target=\"_blank\">C++\u4f7f\u7528abseil-cpp\u9047\u5230\u7684\u5c0f\u95ee\u9898</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/c\u6280\u6cd5\u5982\u4f55\u4e3a\u4e00\u4e2a\u7c7b\u52a8\u6001\u9644\u52a0\u4efb\u610f\u7c7b\u578b\u6570\u636e/\" target=\"_blank\">C++\u6280\u6cd5\uff1a\u5982\u4f55\u4e3a\u4e00\u4e2a\u7c7b\u52a8\u6001\u9644\u52a0\u4efb\u610f\u7c7b\u578b\u6570\u636e</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/helix-gpt\u5982\u4f55\u5b9e\u73b0ai-code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5/\" target=\"_blank\">helix-gpt\u5982\u4f55\u5b9e\u73b0AI code\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5?</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/300\u884c\u5b9e\u73b0\u4e00\u4e2aboundedspscqueue/\" target=\"_blank\">300\u884c\u5b9e\u73b0\u4e00\u4e2aBoundedSPSCQueue</a></li>\n<li><a href=\"https://kenforever1.github.io/blog/netcap\u8c03\u8bd5/\" target=\"_blank\">netcap\u8c03\u8bd5</a></li>\n</ul>\n</div>",
            "image": null,
            "date_modified": "2025-06-08T00:00:00+00:00",
            "authors": [
                {
                    "name": "KenForever1"
                }
            ],
            "tags": null
        }
    ]
}