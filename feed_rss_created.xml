<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    
    <title>KenForever1</title>
    <description>热爱编程和阅读，学无止境</description>
    <link>https://github.com/KenForever1/</link>
    <atom:link href="https://github.com/KenForever1/feed_rss_created.xml" rel="self" type="application/rss+xml" />

    
    <managingEditor>SteveForever</managingEditor>
    <docs>https://github.com/KenForever1</docs>
    <language>zh</language>

    
    <pubDate>Sat, 20 Sep 2025 07:41:31 -0000</pubDate>
    <lastBuildDate>Sat, 20 Sep 2025 07:41:31 -0000</lastBuildDate>
    <ttl>1440</ttl>

    
    <generator>MkDocs RSS plugin - v1.17.3</generator>

    
    
    <image>
      <url>https://upload.wikimedia.org/wikipedia/commons/thumb/4/43/Feed-icon.svg/128px-Feed-icon.svg.png</url>
      <title>KenForever1</title>
      <link>https://github.com/KenForever1/</link>
    </image>
    

    
    
    <item>
      <title>pyo3实现python和rust跨语言调用</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;!-- more --&gt;

&lt;h2 id=&#34;pyo3是什么&#34;&gt;pyo3是什么？&lt;a class=&#34;headerlink&#34; href=&#34;#pyo3是什么&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;pyo3是一个Rust库，可以实现python和rust之间的相互调用。可以使用Rust为Python编写扩展。
教程可以参考&lt;a href=&#34;https://pyo3.rs/main/getting-started.html&#34;&gt;pyo3 getting-started&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;就行，pybind11一样，pybind11是一个c++库，提供了c++和python之间的相互调用。&lt;/p&gt;
&lt;h2 id=&#34;ffi需要考虑什么问题&#34;&gt;FFI需要考虑什么问题？&lt;a class=&#34;headerlink&#34; href=&#34;#ffi需要考虑什么问题&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;python和rust之间的相互调用，需要考虑的问题有：
线程安全，线程间竞争。pyo3针对不同的python版本实现，实现了GIL和no GIL。
数据结构的生命周期，pyo3封装了智能指针，通过过程宏生成函数&lt;/p&gt;
&lt;h2 id=&#34;python的no-gil&#34;&gt;python的no GIL&lt;a class=&#34;headerlink&#34; href=&#34;#python的no-gil&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;GIL就是Python的全局解释器锁，因此python的多线程实际是伪多线程，不能像c++等其它语言的多线程一样真正的实现并发。&lt;/p&gt;
&lt;p&gt;python的no GIL是CPython 3.14提出的不再依赖全局解释器锁的多线程实现，提升并发。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;CPython 3.14 declared support for the &amp;ldquo;free-threaded&amp;rdquo; build of CPython that does not rely on the global interpreter lock (often referred to as the GIL) for thread safety. &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;如何编译一个多个版本都可以使用的wheel包与什么特性有关&#34;&gt;如何编译一个多个版本都可以使用的wheel包？与什么特性有关？&lt;a class=&#34;headerlink&#34; href=&#34;#如何编译一个多个版本都可以使用的wheel包与什么特性有关&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;我们平时使用python依赖安装包时可能会注意到，有些wheel文件命名上是指明了python版本要求的，比如python3.8的wheel包和python3.10等是不同的文件。&lt;/p&gt;
&lt;p&gt;标准Python ABI通常要求模块针对特定Python版本编译，而ABI3通过冻结关键二进制接口实现跨版本兼容，降低了维护成本。&lt;/p&gt;
&lt;p&gt;默认情况下，Python扩展模块只能与编译它们时所针对的Python版本一起使用。例如，为Python 3.5构建的扩展模块无法在Python 3.8中导入。&lt;a href=&#34;https://www.python.org/dev/peps/pep-0384/&#34;&gt;PEP 384&lt;/a&gt;引入了有限Python API的概念，该API将具有稳定的ABI，使使用它构建的扩展模块能够在多个Python版本中使用。这也被称为abi3。&lt;/p&gt;
&lt;p&gt;其缺点是，PyO3无法使用那些依赖于针对已知确切Python版本进行编译的优化。pyo3仅调用属于稳定API的Python C-API函数。&lt;/p&gt;
&lt;p&gt;由于单个abi3轮包可用于多个不同的Python版本，PyO3提供了abi3-py37、abi3-py38、abi3-py39等功能标志，用于为您的abi3轮包设置最低所需的Python版本。例如，如果您设置了abi3-py37功能，您的扩展轮包可用于从Python 3.7及更高版本的所有Python 3版本。maturin和setuptools-rust会给轮包命名为类似my-extension-1.0-cp37-abi3-manylinux2020_x86_64.whl的名称。&lt;/p&gt;
&lt;h2 id=&#34;一个python包如何测试多个版本&#34;&gt;一个python包，如何测试多个版本？&lt;a class=&#34;headerlink&#34; href=&#34;#一个python包如何测试多个版本&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://nox.thea.codes/en/stable/index.html&#34;&gt;nox&lt;/a&gt;，可以自动化的在多个python版本下运行测试。通过py脚本配置。&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/rust-facet库如何实现运行时反射/&#34; target=&#34;_blank&#34;&gt;rust-facet库如何实现运行时反射&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/使用aya和c混合编写uprobe程序/&#34; target=&#34;_blank&#34;&gt;使用aya和c混合编写uprobe程序&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c开发常见问题之abi兼容性问题/&#34; target=&#34;_blank&#34;&gt;C++开发常见问题之ABI兼容性问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/pyo3%E5%AE%9E%E7%8E%B0python%E5%92%8Crust%E8%B7%A8%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8/</link>
      <pubDate>Sat, 20 Sep 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/pyo3%E5%AE%9E%E7%8E%B0python%E5%92%8Crust%E8%B7%A8%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8/</guid>
      
    </item>
    
    <item>
      <title>探索ggml的实现</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;!-- more --&gt;

&lt;p&gt;本文主要介绍ggml的调试入门环境搭建、ggml的核心数据结构、内存管理与布局、计算图构建与执行、以及gguf文件格式构成，会分成多个小节介绍。&lt;/p&gt;
&lt;p&gt;本文起源于作者ggml学习过程中了解的资料，包括&lt;a href=&#34;https://xsxszab.github.io/posts/ggml-deep-dive-i/&#34;&gt;xsxszab的ggml-deep-dive系列文章&lt;/a&gt;、以及阅读源码，记录和分享自己的理解过程。（感谢xsxszab绘制的关于内存布局的图例，为ggml的理解更加浅显易懂。）&lt;/p&gt;
&lt;p&gt;ggml是采用c/c++编写高度优化的tensor张量计算库，没有外部依赖。存在不同的backend实现，从mac的metal、x86的avx实现以及arm的neon指令实现、gpu的cuda、hip、opencl等实现。llama.cpp项目就是使用ggml进行模型加载、推理的。&lt;/p&gt;
&lt;h2 id=&#34;探索ggml的实现vscode调试环境的搭建&#34;&gt;探索ggml的实现&amp;ndash;vscode调试环境的搭建&lt;a class=&#34;headerlink&#34; href=&#34;#探索ggml的实现vscode调试环境的搭建&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;在阅读源码的时候，找一个最简单的example例子跑通，然后跟着源码进行调试，是很快理解原理的一种方法。 &lt;/p&gt;
&lt;p&gt;在linux、或者mac下都方便编译。&lt;/p&gt;
&lt;p&gt;编译依赖：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;gcc/g++或者 clang编译&lt;/li&gt;
&lt;li&gt;cmake： 用于管理构建项目&lt;/li&gt;
&lt;li&gt;ccache：可选项，加快编译速度用&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;git&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;clone&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;https://github.com/ggml-org/ggml.git
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;上面的依赖安装很简单，以ubuntu为例：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;apt&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;update
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;apt&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;install&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-y&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;gcc&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;g++&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;cmake&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;ccache
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;配置调试目标&#34;&gt;配置调试目标&lt;a class=&#34;headerlink&#34; href=&#34;#配置调试目标&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;ggml的example中包括了很多例子，先从简单的例子看起。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;examples/simple/simple-ctx.cpp
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;修改项目的cmake配置，即添加-g方便debug调试。找到examples/simple/CMakeLists.txt配置文件，为simple-ctx这个可执行文件添加-g参数。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;set&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;TEST_TARGET&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;simple-ctx&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;add_executable&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;TEST_TARGET&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;simple-ctx.cpp&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;target_compile_options&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;TEST_TARGET&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;PRIVATE&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-g&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;target_link_libraries&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;TEST_TARGET&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;PRIVATE&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;ggml&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
上面只是为可执行文件添加了-g调试信息，如果要调试ggml.so这个库，则需要编译ggml.so库时指定Debug类型。&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;cmake&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-B&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;build&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-S&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;.&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-DCMAKE_BUILD_TYPE&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;DEBUG
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;cmake&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;--build&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;build
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
查看编译输出，可以看到ggml.so库被编译成with debug_info。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;file&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;build/src/libggml.so&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;build/src/libggml.so:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;ELF&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;64&lt;/span&gt;-bit&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;LSB&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;shared&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;object,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;x86-64,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;version&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;SYSV&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;dynamically&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;linked,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;BuildID&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;sha1&lt;span class=&#34;o&#34;&gt;]=&lt;/span&gt;db376e303daeef672c8002ed6cebed1da303a706,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;with&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;debug_info,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;not&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;stripped
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;vscode配置debug&#34;&gt;vscode配置debug&lt;a class=&#34;headerlink&#34; href=&#34;#vscode配置debug&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;点击右边的Run and Debug按钮，create a launch.json file，创建一个配置文件，把下面的内容粘贴进去。&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;JSON&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-2&#34; name=&#34;__codelineno-6-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;&amp;quot;version&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;0.2.0&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-3&#34; name=&#34;__codelineno-6-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;&amp;quot;configurations&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-4&#34; name=&#34;__codelineno-6-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-5&#34; name=&#34;__codelineno-6-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;debug simple-ctx&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-6&#34; name=&#34;__codelineno-6-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;lldb&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-7&#34; name=&#34;__codelineno-6-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;&amp;quot;request&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;launch&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-8&#34; name=&#34;__codelineno-6-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;&amp;quot;program&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;${workspaceFolder}/build/bin/simple-ctx&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-9&#34; name=&#34;__codelineno-6-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;&amp;quot;cwd&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;${workspaceFolder}&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-10&#34; name=&#34;__codelineno-6-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-11&#34; name=&#34;__codelineno-6-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-12&#34; name=&#34;__codelineno-6-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
接下来就可以按照vscode的界面button调试了，如果要调试其它可执行程序，修改launch.json的program字段即可。&lt;/p&gt;
&lt;p&gt;可以看到，通过上面的编译debug模式和添加-g参数，可以进入可执行程序和ggml.so库的源码进行调试了了。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-debug.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-debug1.png&#34; /&gt;&lt;/p&gt;
&lt;h2 id=&#34;探索ggml的实现张量表示&#34;&gt;探索ggml的实现&amp;ndash;张量表示&lt;a class=&#34;headerlink&#34; href=&#34;#探索ggml的实现张量表示&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&#34;ggml_tensor-数据结构&#34;&gt;ggml_tensor 数据结构&lt;a class=&#34;headerlink&#34; href=&#34;#ggml_tensor-数据结构&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;在GGML中通过ggml_tensor结构体表示张量，结构体定义如下：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-40&#34;&gt;40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-41&#34;&gt;41&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-42&#34;&gt;42&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-43&#34;&gt;43&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-44&#34;&gt;44&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-45&#34;&gt;45&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-46&#34;&gt;46&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-7-1&#34; name=&#34;__codelineno-7-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// n-dimensional tensor&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-2&#34; name=&#34;__codelineno-7-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-3&#34; name=&#34;__codelineno-7-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 张量的数据类型：例如GGML_TYPE_F32,GGML_TYPE_F16，GGML_TYPE_Q4_0&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-4&#34; name=&#34;__codelineno-7-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;enum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-5&#34; name=&#34;__codelineno-7-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-6&#34; name=&#34;__codelineno-7-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_backend_buffer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buffer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-7&#34; name=&#34;__codelineno-7-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-8&#34; name=&#34;__codelineno-7-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 最大维度为4，GGML_MAX_DIMS为4&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-9&#34; name=&#34;__codelineno-7-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ne存储张量每个维度的元素个数&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-10&#34; name=&#34;__codelineno-7-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// nb存储张量每个维的元素大小&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-11&#34; name=&#34;__codelineno-7-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int64_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_MAX_DIMS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// number of elements&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-12&#34; name=&#34;__codelineno-7-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_MAX_DIMS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// stride in bytes:&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-13&#34; name=&#34;__codelineno-7-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// nb[0] = ggml_type_size(type)&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-14&#34; name=&#34;__codelineno-7-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// nb[1] = nb[0]   * (ne[0] / ggml_blck_size(type)) + padding&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-15&#34; name=&#34;__codelineno-7-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// nb[i] = nb[i-1] * ne[i-1]&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-16&#34; name=&#34;__codelineno-7-16&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-17&#34; name=&#34;__codelineno-7-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 张量op类型，在计算图中作为op node，后面会提到&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-18&#34; name=&#34;__codelineno-7-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 例如矩阵乘类型，GGML_OP_MUL_MAT&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-19&#34; name=&#34;__codelineno-7-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// compute data&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-20&#34; name=&#34;__codelineno-7-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;enum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_op&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;op&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-21&#34; name=&#34;__codelineno-7-21&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-22&#34; name=&#34;__codelineno-7-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// op params - allocated as int32_t for alignment&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-23&#34; name=&#34;__codelineno-7-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int32_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;op_params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_MAX_OP_PARAMS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int32_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)];&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-24&#34; name=&#34;__codelineno-7-24&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-25&#34; name=&#34;__codelineno-7-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int32_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;flags&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-26&#34; name=&#34;__codelineno-7-26&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-27&#34; name=&#34;__codelineno-7-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 指针指向此张量的src张量&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-28&#34; name=&#34;__codelineno-7-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 例如矩阵乘op tensor的src张量是矩阵A tensor和矩阵B tensor&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-29&#34; name=&#34;__codelineno-7-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;src&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_MAX_SRC&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-30&#34; name=&#34;__codelineno-7-30&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-31&#34; name=&#34;__codelineno-7-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 描述张量视图，如果此张量是另一个张量（base张量）的视图，则指向base张量&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-32&#34; name=&#34;__codelineno-7-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// source tensor and offset for views&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-33&#34; name=&#34;__codelineno-7-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;view_src&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-34&#34; name=&#34;__codelineno-7-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 视图张量的偏移量&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-35&#34; name=&#34;__codelineno-7-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;               &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;view_offs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-36&#34; name=&#34;__codelineno-7-36&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-37&#34; name=&#34;__codelineno-7-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 存储张量的数据&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-38&#34; name=&#34;__codelineno-7-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-39&#34; name=&#34;__codelineno-7-39&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-40&#34; name=&#34;__codelineno-7-40&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 张量的名称&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-41&#34; name=&#34;__codelineno-7-41&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_MAX_NAME&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-42&#34; name=&#34;__codelineno-7-42&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-43&#34; name=&#34;__codelineno-7-43&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;extra&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// extra things e.g. for ggml-cuda.cu&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-44&#34; name=&#34;__codelineno-7-44&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-45&#34; name=&#34;__codelineno-7-45&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;padding&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-46&#34; name=&#34;__codelineno-7-46&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;通过一个例子学习tensor&#34;&gt;通过一个例子学习tensor&lt;a class=&#34;headerlink&#34; href=&#34;#通过一个例子学习tensor&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;在examples文件夹中添加一个simple-add.cpp的文件，添加如下内容：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-40&#34;&gt;40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-41&#34;&gt;41&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-42&#34;&gt;42&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-43&#34;&gt;43&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-44&#34;&gt;44&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-45&#34;&gt;45&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-46&#34;&gt;46&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-47&#34;&gt;47&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-48&#34;&gt;48&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-49&#34;&gt;49&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-50&#34;&gt;50&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-8-1&#34; name=&#34;__codelineno-8-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;quot;ggml.h&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-2&#34; name=&#34;__codelineno-8-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;quot;ggml-cpu.h&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-3&#34; name=&#34;__codelineno-8-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;cstring&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-4&#34; name=&#34;__codelineno-8-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;iostream&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-5&#34; name=&#34;__codelineno-8-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;vector&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-6&#34; name=&#34;__codelineno-8-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-7&#34; name=&#34;__codelineno-8-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-8&#34; name=&#34;__codelineno-8-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_init_params&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-9&#34; name=&#34;__codelineno-8-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.mem_size   =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1024&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1024&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1024&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_overhead&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-10&#34; name=&#34;__codelineno-8-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.mem_buffer =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-11&#34; name=&#34;__codelineno-8-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.no_alloc   =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-12&#34; name=&#34;__codelineno-8-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-13&#34; name=&#34;__codelineno-8-13&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-14&#34; name=&#34;__codelineno-8-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_context&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_init&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-15&#34; name=&#34;__codelineno-8-15&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-16&#34; name=&#34;__codelineno-8-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// --------------------&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-17&#34; name=&#34;__codelineno-8-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Modify this section to test different tensor computations&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-18&#34; name=&#34;__codelineno-8-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-19&#34; name=&#34;__codelineno-8-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-20&#34; name=&#34;__codelineno-8-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-21&#34; name=&#34;__codelineno-8-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-22&#34; name=&#34;__codelineno-8-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-23&#34; name=&#34;__codelineno-8-23&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-24&#34; name=&#34;__codelineno-8-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-25&#34; name=&#34;__codelineno-8-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-26&#34; name=&#34;__codelineno-8-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-27&#34; name=&#34;__codelineno-8-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-28&#34; name=&#34;__codelineno-8-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-29&#34; name=&#34;__codelineno-8-29&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-30&#34; name=&#34;__codelineno-8-30&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-31&#34; name=&#34;__codelineno-8-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 因为ggml中tensor表示和pytorch相反，因此3行2列的矩阵，表示为[2, 3]&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-32&#34; name=&#34;__codelineno-8-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_new_tensor_2d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_TYPE_F32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-33&#34; name=&#34;__codelineno-8-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_new_tensor_2d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_TYPE_F32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-8-34&#34; name=&#34;__codelineno-8-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memcpy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_nbytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-35&#34; name=&#34;__codelineno-8-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memcpy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_nbytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-36&#34; name=&#34;__codelineno-8-36&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-37&#34; name=&#34;__codelineno-8-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_add&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-38&#34; name=&#34;__codelineno-8-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// --------------------&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-39&#34; name=&#34;__codelineno-8-39&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-40&#34; name=&#34;__codelineno-8-40&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_cgraph&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_new_graph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-41&#34; name=&#34;__codelineno-8-41&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_build_forward_expand&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-42&#34; name=&#34;__codelineno-8-42&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-43&#34; name=&#34;__codelineno-8-43&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_compute_with_ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-44&#34; name=&#34;__codelineno-8-44&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-45&#34; name=&#34;__codelineno-8-45&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vector&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;out_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_nelements&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-46&#34; name=&#34;__codelineno-8-46&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memcpy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;out_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_nbytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-47&#34; name=&#34;__codelineno-8-47&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-48&#34; name=&#34;__codelineno-8-48&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_free&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-49&#34; name=&#34;__codelineno-8-49&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-50&#34; name=&#34;__codelineno-8-50&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
完善cmake配置，在CMakeLists.txt中添加以下内容：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;CMake&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-9-1&#34; name=&#34;__codelineno-9-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c&#34;&gt;#&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-2&#34; name=&#34;__codelineno-9-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c&#34;&gt;# simple-add&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-3&#34; name=&#34;__codelineno-9-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-4&#34; name=&#34;__codelineno-9-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nb&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;TEST_TARGET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;simple-add&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-5&#34; name=&#34;__codelineno-9-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nb&#34;&gt;add_executable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;TEST_TARGET&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;simple-add.cpp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-6&#34; name=&#34;__codelineno-9-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nb&#34;&gt;target_compile_options&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;TEST_TARGET&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;PRIVATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;-g&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-7&#34; name=&#34;__codelineno-9-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nb&#34;&gt;target_link_libraries&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;TEST_TARGET&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;PRIVATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;ggml&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
根据第一节的内容，编译然后就可以用vscode debug调试了。当完成ggml_new_tensor_2d创建2维张量时，并且通过memcpy拷贝赋值后。我们通过gdb打印tensor的数据，就可以看到数据了。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-40&#34;&gt;40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-41&#34;&gt;41&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-42&#34;&gt;42&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-43&#34;&gt;43&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-44&#34;&gt;44&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-45&#34;&gt;45&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-10-1&#34; name=&#34;__codelineno-10-1&#34;&gt;&lt;/a&gt;&amp;gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;p&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;*a
&lt;a id=&#34;__codelineno-10-2&#34; name=&#34;__codelineno-10-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;ggml_tensor&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-3&#34; name=&#34;__codelineno-10-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;GGML_TYPE_F32
&lt;a id=&#34;__codelineno-10-4&#34; name=&#34;__codelineno-10-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;buffer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-10-5&#34; name=&#34;__codelineno-10-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-6&#34; name=&#34;__codelineno-10-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;4&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;8&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;24&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;24&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-7&#34; name=&#34;__codelineno-10-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;op&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;GGML_OP_NONE
&lt;a id=&#34;__codelineno-10-8&#34; name=&#34;__codelineno-10-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;op_params&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-9&#34; name=&#34;__codelineno-10-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-10&#34; name=&#34;__codelineno-10-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-11&#34; name=&#34;__codelineno-10-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-12&#34; name=&#34;__codelineno-10-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-13&#34; name=&#34;__codelineno-10-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-14&#34; name=&#34;__codelineno-10-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-15&#34; name=&#34;__codelineno-10-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-16&#34; name=&#34;__codelineno-10-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-17&#34; name=&#34;__codelineno-10-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-18&#34; name=&#34;__codelineno-10-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;9&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-19&#34; name=&#34;__codelineno-10-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-20&#34; name=&#34;__codelineno-10-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;11&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-21&#34; name=&#34;__codelineno-10-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;12&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-22&#34; name=&#34;__codelineno-10-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;13&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-23&#34; name=&#34;__codelineno-10-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;14&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-24&#34; name=&#34;__codelineno-10-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-25&#34; name=&#34;__codelineno-10-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-26&#34; name=&#34;__codelineno-10-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;flags&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-27&#34; name=&#34;__codelineno-10-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;src&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-28&#34; name=&#34;__codelineno-10-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-10-29&#34; name=&#34;__codelineno-10-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-10-30&#34; name=&#34;__codelineno-10-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-10-31&#34; name=&#34;__codelineno-10-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-10-32&#34; name=&#34;__codelineno-10-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-10-33&#34; name=&#34;__codelineno-10-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-10-34&#34; name=&#34;__codelineno-10-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-10-35&#34; name=&#34;__codelineno-10-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-10-36&#34; name=&#34;__codelineno-10-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-10-37&#34; name=&#34;__codelineno-10-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;9&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-10-38&#34; name=&#34;__codelineno-10-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-39&#34; name=&#34;__codelineno-10-39&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;view_src&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-10-40&#34; name=&#34;__codelineno-10-40&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;view_offs&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-41&#34; name=&#34;__codelineno-10-41&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0x00007fffb75eb1b0
&lt;a id=&#34;__codelineno-10-42&#34; name=&#34;__codelineno-10-42&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-43&#34; name=&#34;__codelineno-10-43&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;extra&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0x0000000000000000
&lt;a id=&#34;__codelineno-10-44&#34; name=&#34;__codelineno-10-44&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;padding&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-45&#34; name=&#34;__codelineno-10-45&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
从上面的内容可以看到，ggml_tensor结构体的ne成员变量是一个数组，数组的元素个数是4，分别表示该张量的维度。例如，一个二维矩阵的ne成员变量为[2, 3, 1, 1]，表示该矩阵有3行2列，且行和列的索引从0开始。&lt;/p&gt;
&lt;h3 id=&#34;tensor的内存布局&#34;&gt;tensor的内存布局&lt;a class=&#34;headerlink&#34; href=&#34;#tensor的内存布局&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;h4 id=&#34;f32矩阵&#34;&gt;f32矩阵&lt;a class=&#34;headerlink&#34; href=&#34;#f32矩阵&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;对于ne的理解，比如一个RGB的图片，width为1920，height为1080， 用pytorch表示维度信息就是[1, 3, 1080, 1920],即[N, C, H, W]。而在GGML中，这个维度信息表示为：
[1920, 1080, 3, 1]。&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-11-1&#34; name=&#34;__codelineno-11-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_TYPE_F32&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-2&#34; name=&#34;__codelineno-11-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;buffer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-3&#34; name=&#34;__codelineno-11-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-4&#34; name=&#34;__codelineno-11-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 4表示第一维每个元素所占字节数。8表示每行元素间隔8个字节，也就是间隔两个元素。&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-5&#34; name=&#34;__codelineno-11-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 也就是在内存存储的布局是row major连续存储的&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-6&#34; name=&#34;__codelineno-11-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;24&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;24&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-7&#34; name=&#34;__codelineno-11-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;op&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_OP_NONE&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
ne只表示了矩阵的维度，而nb表示了矩阵在内存中的存储布局，以及每行元素间隔。&lt;/p&gt;
&lt;h3 id=&#34;量化矩阵&#34;&gt;量化矩阵&lt;a class=&#34;headerlink&#34; href=&#34;#量化矩阵&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;在上面的例子任意地方加一行表示一个量化矩阵。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-12-1&#34; name=&#34;__codelineno-12-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_new_tensor_2d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_TYPE_Q4_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;通过&lt;code&gt;p *c&lt;/code&gt; 可以查看矩阵的详细信息。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-9&#34;&gt;9&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-13-1&#34; name=&#34;__codelineno-13-1&#34;&gt;&lt;/a&gt;&amp;gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;p&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;*c
&lt;a id=&#34;__codelineno-13-2&#34; name=&#34;__codelineno-13-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;ggml_tensor&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-3&#34; name=&#34;__codelineno-13-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;GGML_TYPE_Q4_0
&lt;a id=&#34;__codelineno-13-4&#34; name=&#34;__codelineno-13-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;buffer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-13-5&#34; name=&#34;__codelineno-13-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;32&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;6&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-6&#34; name=&#34;__codelineno-13-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;18&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;18&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;108&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;108&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-7&#34; name=&#34;__codelineno-13-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;op&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;GGML_OP_NONE
&lt;a id=&#34;__codelineno-13-8&#34; name=&#34;__codelineno-13-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;......
&lt;a id=&#34;__codelineno-13-9&#34; name=&#34;__codelineno-13-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
下面就分析认识一些Q4_0类型的矩阵表示有什么不同。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-9&#34;&gt;9&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-14-1&#34; name=&#34;__codelineno-14-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;typedef&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint16_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_half&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-2&#34; name=&#34;__codelineno-14-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#define QK4_0 32&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-3&#34; name=&#34;__codelineno-14-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;typedef&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-4&#34; name=&#34;__codelineno-14-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 16bit存储delta信息, 2个字节&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-5&#34; name=&#34;__codelineno-14-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_half&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;           &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// delta&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-6&#34; name=&#34;__codelineno-14-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 8bit数组，数组长度为：16， 16个字节&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-7&#34; name=&#34;__codelineno-14-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint8_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;qs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QK4_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// nibbles / quants&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-8&#34; name=&#34;__codelineno-14-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block_q4_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-9&#34; name=&#34;__codelineno-14-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static_assert&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block_q4_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_half&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QK4_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;wrong q4_0 block size/padding&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
在GGML中，一个block_q4_0结构体，可以表示32个int4元素，再加上一个16bit的delta信息。&lt;/p&gt;
&lt;p&gt;我们ne[0]和ne[1]分别为32, 16,表示了32行和16列的int4矩阵。而nb[0]为18，表示GGML的q4_0量化将32个int4元素组合在一起，再加上一个16位的差值，每组共18字节。&lt;/p&gt;
&lt;p&gt;[32, 6, 1, 1]的Q4_0数组就可以看成[1,6,1,1]，因为32个元素为内存上的最小寻址单元。更高维度的情况下，nb[i] = nb[i-1] * ne[i]。&lt;/p&gt;
&lt;h3 id=&#34;矩阵permute重排列&#34;&gt;矩阵permute重排列&lt;a class=&#34;headerlink&#34; href=&#34;#矩阵permute重排列&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;看一个pytorch例子，了解permute是什么？permute就是对数据的维度变化顺序
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-9&#34;&gt;9&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-15-1&#34; name=&#34;__codelineno-15-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;import&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-2&#34; name=&#34;__codelineno-15-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;import&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;numpy&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;np&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-3&#34; name=&#34;__codelineno-15-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-15-4&#34; name=&#34;__codelineno-15-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;np&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;array&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([[[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]]])&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-5&#34; name=&#34;__codelineno-15-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;unpermuted&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-6&#34; name=&#34;__codelineno-15-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;print&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unpermuted&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;#&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;——&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;])&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-7&#34; name=&#34;__codelineno-15-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-15-8&#34; name=&#34;__codelineno-15-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;permuted&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unpermuted&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;permute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-9&#34; name=&#34;__codelineno-15-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;print&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;permuted&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;#&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;——&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-16-1&#34; name=&#34;__codelineno-16-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([[[&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]],&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-2&#34; name=&#34;__codelineno-16-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[[&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]],&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-3&#34; name=&#34;__codelineno-16-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[[&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]]])&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;     &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;#&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;print&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;permuted&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;再看ggml中的permute操作，添加如下例子:
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-17-1&#34; name=&#34;__codelineno-17-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;before&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-2&#34; name=&#34;__codelineno-17-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-17-3&#34; name=&#34;__codelineno-17-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Same as PyTorch&amp;#39;s permute()&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-4&#34; name=&#34;__codelineno-17-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;after&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_permute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;before&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
观察before和after tensor信息，可以看到after的ne和nb中的0和1维度交换了，但是看data，其实数据内存存储本身是没有变化的。对于一个内存存储，要改变ne维度信息，只需要改变nb每个维度的间隔，也就是数据访问方式。&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-18-1&#34; name=&#34;__codelineno-18-1&#34;&gt;&lt;/a&gt;&amp;gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;p&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;*before
&lt;a id=&#34;__codelineno-18-2&#34; name=&#34;__codelineno-18-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;ggml_tensor&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-3&#34; name=&#34;__codelineno-18-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;GGML_TYPE_F32
&lt;a id=&#34;__codelineno-18-4&#34; name=&#34;__codelineno-18-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;buffer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-18-5&#34; name=&#34;__codelineno-18-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-6&#34; name=&#34;__codelineno-18-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;4&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;8&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;24&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;24&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-7&#34; name=&#34;__codelineno-18-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;op&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;GGML_OP_NONE
&lt;a id=&#34;__codelineno-18-8&#34; name=&#34;__codelineno-18-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;view_src&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-18-9&#34; name=&#34;__codelineno-18-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;view_offs&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-10&#34; name=&#34;__codelineno-18-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0x00007fffb77eb1b0
&lt;a id=&#34;__codelineno-18-11&#34; name=&#34;__codelineno-18-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-12&#34; name=&#34;__codelineno-18-12&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-18-13&#34; name=&#34;__codelineno-18-13&#34;&gt;&lt;/a&gt;&amp;gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;p&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;*after
&lt;a id=&#34;__codelineno-18-14&#34; name=&#34;__codelineno-18-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;ggml_tensor&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-15&#34; name=&#34;__codelineno-18-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;GGML_TYPE_F32
&lt;a id=&#34;__codelineno-18-16&#34; name=&#34;__codelineno-18-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;buffer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nullptr
&lt;a id=&#34;__codelineno-18-17&#34; name=&#34;__codelineno-18-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-18&#34; name=&#34;__codelineno-18-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;8&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;4&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;24&lt;/span&gt;,&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;24&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-19&#34; name=&#34;__codelineno-18-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;op&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;GGML_OP_PERMUTE
&lt;a id=&#34;__codelineno-18-20&#34; name=&#34;__codelineno-18-20&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-18-21&#34; name=&#34;__codelineno-18-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;view_src&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0x00007fffb77eb060
&lt;a id=&#34;__codelineno-18-22&#34; name=&#34;__codelineno-18-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;view_offs&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-23&#34; name=&#34;__codelineno-18-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0x00007fffb77eb1b0
&lt;a id=&#34;__codelineno-18-24&#34; name=&#34;__codelineno-18-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot; (permuted)&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-25&#34; name=&#34;__codelineno-18-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
从view_src也可以看出after只是before的视图。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-19-1&#34; name=&#34;__codelineno-19-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Pseudo-code representation of tensor&amp;#39;s memory layout&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-2&#34; name=&#34;__codelineno-19-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-3&#34; name=&#34;__codelineno-19-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-19-4&#34; name=&#34;__codelineno-19-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Accessing row 1 before permutation, nb[0] = 4&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-5&#34; name=&#34;__codelineno-19-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 1, 2,&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-6&#34; name=&#34;__codelineno-19-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 3, 4,&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-7&#34; name=&#34;__codelineno-19-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 5, 6&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-8&#34; name=&#34;__codelineno-19-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;e0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-9&#34; name=&#34;__codelineno-19-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;e1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-10&#34; name=&#34;__codelineno-19-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-19-11&#34; name=&#34;__codelineno-19-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Accessing row 1 after permutation, nb[0] = 8&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-12&#34; name=&#34;__codelineno-19-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// [[1,3,5],&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-13&#34; name=&#34;__codelineno-19-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;//  [2,4,6]]&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-14&#34; name=&#34;__codelineno-19-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;e0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-15&#34; name=&#34;__codelineno-19-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;e1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-16&#34; name=&#34;__codelineno-19-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;e1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;张量视图&#34;&gt;张量视图&lt;a class=&#34;headerlink&#34; href=&#34;#张量视图&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;视图可以对张量内存进行复用，避免拷贝、避免低效的为每个张量分配一个独特的内存块。&lt;/p&gt;
&lt;p&gt;以ggml_cpy操作为例，拷贝的b tensor就是相对于a创建的一个视图。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-20-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-20-1&#34; name=&#34;__codelineno-20-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// ggml_cpy&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-2&#34; name=&#34;__codelineno-20-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_cpy_impl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-3&#34; name=&#34;__codelineno-20-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_context&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-4&#34; name=&#34;__codelineno-20-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-5&#34; name=&#34;__codelineno-20-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-6&#34; name=&#34;__codelineno-20-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_ASSERT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_nelements&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_nelements&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-7&#34; name=&#34;__codelineno-20-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-20-8&#34; name=&#34;__codelineno-20-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// make a view of the destination&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-9&#34; name=&#34;__codelineno-20-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_view_tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-10&#34; name=&#34;__codelineno-20-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;strlen&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-11&#34; name=&#34;__codelineno-20-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_format_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;%s (copy of %s)&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-12&#34; name=&#34;__codelineno-20-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-13&#34; name=&#34;__codelineno-20-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_format_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;%s (copy)&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-14&#34; name=&#34;__codelineno-20-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-15&#34; name=&#34;__codelineno-20-15&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-20-16&#34; name=&#34;__codelineno-20-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;op&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;     &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_OP_CPY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-17&#34; name=&#34;__codelineno-20-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;src&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-18&#34; name=&#34;__codelineno-20-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;src&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-19&#34; name=&#34;__codelineno-20-19&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-20-20&#34; name=&#34;__codelineno-20-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-20-21&#34; name=&#34;__codelineno-20-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;以LLM中Q、K、V tensor为例，下面的Qcur、Kcur、Vcur可以表示成创建的tensor_input的一部分。所以视图不用是base tensor的全部，可以只是一部分，通过offset可以设置相对base tensor的偏移量。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-21-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-21-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-21-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-21-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-21-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-21-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-21-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-21-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-21-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-21-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-21-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-21-1&#34; name=&#34;__codelineno-21-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tensor_input&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_new_tensor_2d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_TYPE_32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;768&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;seq_len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-21-2&#34; name=&#34;__codelineno-21-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-21-3&#34; name=&#34;__codelineno-21-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Create a view tensor of shape (768, seq_len) with offset 0&lt;/span&gt;
&lt;a id=&#34;__codelineno-21-4&#34; name=&#34;__codelineno-21-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// The last parameter of ggml_view_2d specifies the view&amp;#39;s offset (in bytes)&lt;/span&gt;
&lt;a id=&#34;__codelineno-21-5&#34; name=&#34;__codelineno-21-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Qcur&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_view_2d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tensor_input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;768&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;seq_len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cur&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;768&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-21-6&#34; name=&#34;__codelineno-21-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-21-7&#34; name=&#34;__codelineno-21-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Create a view tensor of shape (768, seq_len) with offset 768&lt;/span&gt;
&lt;a id=&#34;__codelineno-21-8&#34; name=&#34;__codelineno-21-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Kcur&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_view_2d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tensor_input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;768&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;seq_len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cur&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;768&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-21-9&#34; name=&#34;__codelineno-21-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-21-10&#34; name=&#34;__codelineno-21-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Create a view tensor of shape (768, seq_len) with offset 768 * 2&lt;/span&gt;
&lt;a id=&#34;__codelineno-21-11&#34; name=&#34;__codelineno-21-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Vcur&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_view_2d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tensor_input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;768&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;seq_len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cur&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;768&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h2 id=&#34;探索ggml的实现ggml的内存管理&#34;&gt;探索ggml的实现&amp;ndash;GGML的内存管理&lt;a class=&#34;headerlink&#34; href=&#34;#探索ggml的实现ggml的内存管理&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;本小节通过最简单的一个例子, ./examples/simple/simple-ctx.cpp，理解GGML实现两个矩阵执行矩阵乘法的核心工作流程。&lt;/p&gt;
&lt;p&gt;这个例子具有以下特点，也因此作为我们理解的起点。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;在cpu上执行最简单的两个矩阵的乘法计算，与硬件显卡无关&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;所有的计算都在cpu上执行，所有的内存分配都在RAM中完成&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;!!![warning]
    GGML采用c语言风格实现，所以在内存管理上，通过struct中的指针和偏移量来管理内存，我们需要跟踪指针值、计算偏移量，来理解它的内存布局。&lt;/p&gt;
&lt;h3 id=&#34;认识ggml_context&#34;&gt;认识ggml_context&lt;a class=&#34;headerlink&#34; href=&#34;#认识ggml_context&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;跳过不重要的函数（比如： ggml_time_init），断点debug进入load_model函数。首先看到一个ctx_size的计算，通过ctx_size作为参数，调用了ggml_init函数, 初始化了struct ggml_context *。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;暂时先跳过复杂的ctx_size计算，重点关注这个GGML最重要的函数之一：ggml_init。&lt;/p&gt;
&lt;h4 id=&#34;理解ggml_init&#34;&gt;理解ggml_init&lt;a class=&#34;headerlink&#34; href=&#34;#理解ggml_init&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;ggml_init函数接受一个参数ggml_init_params，这个参数中包含内存分配的参数。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;mem_size_: 内存池大小，也就是ctx_size（提前计算出来的）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;mem_buffer_: 内存池，也就是ctx_buffer，这个内存池用于存储ggml_tensor结构体和数据。这里传递的NULL初始化，表示由内部分配&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;no_alloc_: 是否使用用户传递的内存池，如果为true，则使用用户传递的内存池。这个传递的false，表示由内部分配内存池。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-22-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-22-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-22-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-22-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-22-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-22-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-22-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-22-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-22-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-22-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-22-1&#34; name=&#34;__codelineno-22-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_context&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_init&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_init_params&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-22-2&#34; name=&#34;__codelineno-22-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ......&lt;/span&gt;
&lt;a id=&#34;__codelineno-22-3&#34; name=&#34;__codelineno-22-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-22-4&#34; name=&#34;__codelineno-22-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-22-5&#34; name=&#34;__codelineno-22-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_init_params&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-22-6&#34; name=&#34;__codelineno-22-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// memory pool&lt;/span&gt;
&lt;a id=&#34;__codelineno-22-7&#34; name=&#34;__codelineno-22-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mem_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// bytes&lt;/span&gt;
&lt;a id=&#34;__codelineno-22-8&#34; name=&#34;__codelineno-22-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mem_buffer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// if NULL, memory will be allocated internally&lt;/span&gt;
&lt;a id=&#34;__codelineno-22-9&#34; name=&#34;__codelineno-22-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;no_alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// don&amp;#39;t allocate memory for the tensor data&lt;/span&gt;
&lt;a id=&#34;__codelineno-22-10&#34; name=&#34;__codelineno-22-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;进入ggml_init函数，可以看到，首先在堆上分配了一个struct ggml_context *。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_init_func.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;到这里，ggml_context内存布局如下图所示，我们接下来会一步一步了解内部的进一步分配。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph1.png&#34; /&gt;&lt;/p&gt;
&lt;h3 id=&#34;ggml的tensor表示&#34;&gt;GGML的tensor表示&lt;a class=&#34;headerlink&#34; href=&#34;#ggml的tensor表示&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;在ggml_init函数执行完成后，紧接着就是对两个矩阵tensor的创建和内存赋值。包括了ggml_new_tensor_2d的调用，一直调用到真正的实现函数ggml_new_tensor_impl。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-23-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-23-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-23-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-23-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-23-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-23-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-23-1&#34; name=&#34;__codelineno-23-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// create tensors&lt;/span&gt;
&lt;a id=&#34;__codelineno-23-2&#34; name=&#34;__codelineno-23-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_new_tensor_2d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_TYPE_F32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cols_A&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rows_A&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-23-3&#34; name=&#34;__codelineno-23-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_new_tensor_2d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_TYPE_F32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cols_B&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rows_B&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-23-4&#34; name=&#34;__codelineno-23-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-23-5&#34; name=&#34;__codelineno-23-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;memcpy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_nbytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-23-6&#34; name=&#34;__codelineno-23-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;memcpy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_nbytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;关于view_src的内容可以跳过，主要用于处理张量视图，现在可以不用关心。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-new-tensor-impl.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;首先，一个问题就是：GGML的张量维度是如何表示的？&lt;/p&gt;
&lt;p&gt;这里我们可以和pytorch的张量表示进行对比，因为你可以发现，它们的表示方式正好相反。&lt;/p&gt;
&lt;p&gt;ggml采用一个四维数组表示shape信息。在pytorch中一个[batch, channels, height, width]的张量，ggml中表示为[width, height, channels, batch]。&lt;/p&gt;
&lt;p&gt;pytorch从最外层到最内层的数据，是从左到右表示的。这里最内层，表示在内存存储上连续的维度。&lt;/p&gt;
&lt;p&gt;比如row优先存储，一个3 * 4的矩阵（3行，4列），那最内层维度就是列，也就是4列。pytorch表示为[3, 4]，ggml表示为[4, 3]。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;picture from https://en.wikipedia.org/wiki/Row-_and_column-major_order&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/row-colomn-matrix.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;上面计算出的data_size，先计算单行的size，然后乘以行数，得到矩阵的size。这里的type是float32类型，如果是量化类型，size就会不同，后面用到在讨论。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-24-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-24-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-24-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-24-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-24-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-24-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-24-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-24-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-24-9&#34;&gt;9&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-24-1&#34; name=&#34;__codelineno-24-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;obj_alloc_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-24-2&#34; name=&#34;__codelineno-24-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-24-3&#34; name=&#34;__codelineno-24-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;view_src&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;no_alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-24-4&#34; name=&#34;__codelineno-24-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// allocate tensor data in the context&amp;#39;s memory pool&lt;/span&gt;
&lt;a id=&#34;__codelineno-24-5&#34; name=&#34;__codelineno-24-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;obj_alloc_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-24-6&#34; name=&#34;__codelineno-24-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-24-7&#34; name=&#34;__codelineno-24-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-24-8&#34; name=&#34;__codelineno-24-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_object&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;obj_new&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_new_object&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_OBJECT_TYPE_TENSOR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_TENSOR_SIZE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;obj_alloc_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-24-9&#34; name=&#34;__codelineno-24-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;GGML_ASSERT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;obj_new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;如果view_src为空，且no_alloc为false，则调用ggml_new_object函数，分配一个struct ggml_object *，并初始化。分配的size就是tensor的size，这里就是data_size。&lt;/p&gt;
&lt;p&gt;!!! [warning]
    view_src表示该obj是其它内存的视图，不需要分配内存，直接复用内存。&lt;/p&gt;
&lt;p&gt;分配的ggml_object结构体有什么用呢？&lt;/p&gt;
&lt;h4 id=&#34;理解ggml_new_object&#34;&gt;理解ggml_new_object&lt;a class=&#34;headerlink&#34; href=&#34;#理解ggml_new_object&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;直接看代码，可能有点困难，我们对关键点进行总结。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;在这个例子中，我们首先计算了context的size，据此分配了ggml_context。接下来的内存分配，包括obj的分配，都是在context的memory pool中完成。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ggml_object的定义可以看出，有一个next指针指向下一个ggml_object。因此它是通过链表来管理内存的，每个ggml_object对象都是一个链表节点。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;初始状态下，ggml_object的objects_begin和objects_end都为NULL，表示这个链表为空。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ggml_object的用途是什么呢？ggml通过它来隐式的管理各种资源&amp;ndash;包括tensor张量、计算图、work buffer等。链接具有O(n)的查找时间复杂度。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-new-obj.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;分配一个ggml_object对象，需要多大的内存呢？&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-25-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-25-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-25-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-25-1&#34; name=&#34;__codelineno-25-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_object&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;obj_new&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_new_object&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_OBJECT_TYPE_TENSOR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_TENSOR_SIZE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;obj_alloc_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-25-2&#34; name=&#34;__codelineno-25-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-25-3&#34; name=&#34;__codelineno-25-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_TENSOR_SIZE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;以这里ggml_object分配的是tensor类型为例子：
包括了 struct ggml_object的size + struct ggml_tensor的size + obj_alloc_size（也就是tensor的data内存大小）。当然ggml_tensor struc的size和obj_alloc_size还需要进行内存对齐。&lt;/p&gt;
&lt;p&gt;到此，我们的ggml_context内存布局（没有分配新的内存，所有的内存都是分配ctx时分配）如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph2.png&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;ggml_tensor如何定义&#34;&gt;ggml_tensor如何定义&lt;a class=&#34;headerlink&#34; href=&#34;#ggml_tensor如何定义&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;上节，我们的第一个tensor，以及通过ggml_object进行了表示管理，并为其在ggml_context中分配了内存，那么ggml_tensor结构体的定义呢？&lt;/p&gt;
&lt;p&gt;我们继续看ggml_new_tensor_impl函数中的下半部分内容。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-26-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-26-1&#34; name=&#34;__codelineno-26-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)((&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mem_buffer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;obj_new&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-2&#34; name=&#34;__codelineno-26-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-26-3&#34; name=&#34;__codelineno-26-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-4&#34; name=&#34;__codelineno-26-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.type         =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-5&#34; name=&#34;__codelineno-26-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.buffer       =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-6&#34; name=&#34;__codelineno-26-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.ne           =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-7&#34; name=&#34;__codelineno-26-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.nb           =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-8&#34; name=&#34;__codelineno-26-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.op           =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_OP_NONE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-9&#34; name=&#34;__codelineno-26-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.op_params    =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-10&#34; name=&#34;__codelineno-26-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.flags        =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-11&#34; name=&#34;__codelineno-26-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.src          =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-12&#34; name=&#34;__codelineno-26-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.view_src     =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;view_src&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-13&#34; name=&#34;__codelineno-26-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.view_offs    =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;view_offs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-14&#34; name=&#34;__codelineno-26-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.data         =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;obj_alloc_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-15&#34; name=&#34;__codelineno-26-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.name         =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-16&#34; name=&#34;__codelineno-26-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.extra        =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-17&#34; name=&#34;__codelineno-26-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.padding      =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-18&#34; name=&#34;__codelineno-26-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-19&#34; name=&#34;__codelineno-26-19&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-26-20&#34; name=&#34;__codelineno-26-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_dims&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-21&#34; name=&#34;__codelineno-26-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-22&#34; name=&#34;__codelineno-26-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-23&#34; name=&#34;__codelineno-26-23&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-26-24&#34; name=&#34;__codelineno-26-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_type_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-25&#34; name=&#34;__codelineno-26-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_blck_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-26&#34; name=&#34;__codelineno-26-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_MAX_DIMS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-27&#34; name=&#34;__codelineno-26-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-28&#34; name=&#34;__codelineno-26-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-29&#34; name=&#34;__codelineno-26-29&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-26-30&#34; name=&#34;__codelineno-26-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_objects&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-26-31&#34; name=&#34;__codelineno-26-31&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-26-32&#34; name=&#34;__codelineno-26-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;result指针指向了ctx-&amp;gt;mem_buffer + obj_new-&amp;gt;offs，也就是ggml_tensor结构体对象所分配的内存。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph3.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;ggml_tensor结构体的关键字段如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;data：指向tensor张量数据存储起始地址，这里就是ggml_tensor结构体自身之后的第一个字节。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ne：一个大小为4的数组，表示每个维度的元素数量，这里是[2, 4, 1, 1]。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;nb：一个大小为4的数组，表示每个维度的元素字节数，这里是[4, 8, 32, 32]。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果不考虑量化，计算方式如下:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-27-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-27-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-27-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-27-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-27-1&#34; name=&#34;__codelineno-27-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-27-2&#34; name=&#34;__codelineno-27-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-27-3&#34; name=&#34;__codelineno-27-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-27-4&#34; name=&#34;__codelineno-27-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;通过上面的内容我们以及了解了ggml_new_tensor_2d的工作原理。在simple-ctx例子中，会调用两次以分配两个tensor张量，一次为x，一次为y，分配后的内存布局如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph4.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;然后通过memcpy将数据复制到ggml_tensor的data字段中。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-ctx-graph5.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;这里的张量数据直接硬编码定义到了源代码中，因此不需要加载GGU文件，再更复杂的例子中会通过GGU文件加载数据。&lt;/p&gt;
&lt;h3 id=&#34;要点&#34;&gt;要点&lt;a class=&#34;headerlink&#34; href=&#34;#要点&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;ggml 通过ggml_context来处理内存分配&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ggml_context中通过链表来管理内存，每个节点都是ggml_object结构体，隐式管理tensor张量、计算图、work buffer等资源。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ggml_tensor的维度表示和pytorch是相反的，这个需要注意。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;探索ggml的实现ggml计算图构建&#34;&gt;探索ggml的实现&amp;ndash;GGML计算图构建&lt;a class=&#34;headerlink&#34; href=&#34;#探索ggml的实现ggml计算图构建&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;本小节介绍GGML如何构建和管理计算图相关的数据结构。&lt;/p&gt;
&lt;h3 id=&#34;在ggml_context中创建计算图&#34;&gt;在ggml_context中创建计算图&lt;a class=&#34;headerlink&#34; href=&#34;#在ggml_context中创建计算图&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;上一节，完成了ggml_context的创建，并且完成了矩阵计算所需的ggml_tensor张量的创建。(load_model函数中实现的功能)&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-28-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-28-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-28-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-28-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-28-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-28-1&#34; name=&#34;__codelineno-28-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;simple_model&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-28-2&#34; name=&#34;__codelineno-28-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;load_model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;matrix_A&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;matrix_B&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rows_A&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cols_A&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rows_B&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cols_B&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-28-3&#34; name=&#34;__codelineno-28-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-28-4&#34; name=&#34;__codelineno-28-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// perform computation in cpu&lt;/span&gt;
&lt;a id=&#34;__codelineno-28-5&#34; name=&#34;__codelineno-28-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;compute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;接下来重点研究的就是compute函数，分为构建计算图、执行图计算、获取结果（获取最后一个计算节点的输出结果）三个步骤。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-29-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-29-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-29-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-29-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-29-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-29-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-29-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-29-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-29-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-29-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-29-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-29-1&#34; name=&#34;__codelineno-29-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// compute with backend&lt;/span&gt;
&lt;a id=&#34;__codelineno-29-2&#34; name=&#34;__codelineno-29-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;compute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;simple_model&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-29-3&#34; name=&#34;__codelineno-29-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_cgraph&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;build_graph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-29-4&#34; name=&#34;__codelineno-29-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-29-5&#34; name=&#34;__codelineno-29-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_threads&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// number of threads to perform some operations with multi-threading&lt;/span&gt;
&lt;a id=&#34;__codelineno-29-6&#34; name=&#34;__codelineno-29-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-29-7&#34; name=&#34;__codelineno-29-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_compute_with_ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_threads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-29-8&#34; name=&#34;__codelineno-29-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-29-9&#34; name=&#34;__codelineno-29-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// in this case, the output tensor is the last one in the graph&lt;/span&gt;
&lt;a id=&#34;__codelineno-29-10&#34; name=&#34;__codelineno-29-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_node&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;-1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-29-11&#34; name=&#34;__codelineno-29-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;在build_graph函数中，首先会调用&lt;strong&gt;ggml_new_graph&lt;/strong&gt;，这个函数可以和前一节中ggml_new_tensor函数一样的方式理解。它也是创建了ggml_object对象，但是不同的是，&lt;strong&gt;这个object管理的是计算图（ggml_cgraph结构体对象）&lt;/strong&gt;，而不是tensor张量。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-new-graph-custom.png&#34; /&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;通过ggml_graph_nbytes函数获取计算图需要占用的内存大小&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ggml_new_object根据计算图大小在ggml_context内存区域中分配一块内存，创建ggml_object对象&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;通过offs偏移获取ggml_object中管理的ggml_cgraph结构体对象指针，完成计算图的构建&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;现在我们再对细节进行展开介绍：&lt;/p&gt;
&lt;h4 id=&#34;ggml_gral_nbytes计算细节&#34;&gt;ggml_gral_nbytes计算细节&lt;a class=&#34;headerlink&#34; href=&#34;#ggml_gral_nbytes计算细节&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;GGML_DEFAULT_GRAPH_SIZE是一个宏定义，默认值为2048。定义了单个ggml_cgraph中可分配的最大节点树和leaf（叶节点）张量数。然后使用ggml_hash_size函数计算hash表需要的内存大小，乘以2是需要管理nodes和leafs两种类型。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-30-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-30-1&#34; name=&#34;__codelineno-30-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 调用ggml_new_graph_custom传递的参数&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-2&#34; name=&#34;__codelineno-30-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ggml_new_graph_custom&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_DEFAULT_GRAPH_SIZE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-3&#34; name=&#34;__codelineno-30-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-30-4&#34; name=&#34;__codelineno-30-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#define GGML_DEFAULT_GRAPH_SIZE 2048&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-5&#34; name=&#34;__codelineno-30-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-30-6&#34; name=&#34;__codelineno-30-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;ggml_graph_nbytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;grads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-7&#34; name=&#34;__codelineno-30-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_hash_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-8&#34; name=&#34;__codelineno-30-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-9&#34; name=&#34;__codelineno-30-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;incr_ptr_aligned&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_cgraph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-10&#34; name=&#34;__codelineno-30-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;incr_ptr_aligned&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// nodes&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-11&#34; name=&#34;__codelineno-30-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;incr_ptr_aligned&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// leafs&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-12&#34; name=&#34;__codelineno-30-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;incr_ptr_aligned&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int32_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int32_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// use_counts&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-13&#34; name=&#34;__codelineno-30-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;incr_ptr_aligned&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// hash keys&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-14&#34; name=&#34;__codelineno-30-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;grads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-15&#34; name=&#34;__codelineno-30-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;incr_ptr_aligned&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// grads&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-16&#34; name=&#34;__codelineno-30-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;incr_ptr_aligned&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// grad_accs&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-17&#34; name=&#34;__codelineno-30-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-18&#34; name=&#34;__codelineno-30-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 计算hash_size需要多少个ggml_bitset_t表示状态，这些多个ggml_bitset_t构成了bit位图&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-19&#34; name=&#34;__codelineno-30-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;incr_ptr_aligned&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_bitset_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_bitset_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_bitset_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-20&#34; name=&#34;__codelineno-30-20&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-30-21&#34; name=&#34;__codelineno-30-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nbytes&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-22&#34; name=&#34;__codelineno-30-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nbytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-30-23&#34; name=&#34;__codelineno-30-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;ggml_hash_size从其实现来看，通过二分查找找到大于或等于2 * GGML_DEFAULT_GRAPH_SIZE的最小质数，这个质数决定了计算图哈希表的大小。选择质数主要是出于性能考虑：GGML采用了一种简单的开放地址哈希函数，并使用线性探测法。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-31-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-31-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-31-1&#34; name=&#34;__codelineno-31-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// the last 4 bits are always zero due to alignment&lt;/span&gt;
&lt;a id=&#34;__codelineno-31-2&#34; name=&#34;__codelineno-31-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_tensor_pointer_value&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;%&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;table_size&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;blockquote&gt;
&lt;blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;使用质数表大小有助于更均匀地分布键，减少聚集、提高查找效率。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/blockquote&gt;
&lt;/blockquote&gt;
&lt;p&gt;ggml_graph的内存布局：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;ggml_cgraph结构体对象占用空间：sizeof(struct ggml_cgraph)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;2048个tensor张量指针，指向nodes&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;2048个tensor张量指针，指向leafs&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;hash_size个int32_t，用于记录张量的使用次数&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;hash_size个tensor张量指针，用于存储张量的哈希键&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;梯度相关，simple_ctx例子不涉及&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;哈希表bit位图，用于记录张量的使用情况&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;关于bit位图，&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-32-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-32-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-32-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-32-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-32-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-32-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-32-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-32-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-32-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-32-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-32-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-32-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-32-1&#34; name=&#34;__codelineno-32-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;typedef&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint32_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_bitset_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-32-2&#34; name=&#34;__codelineno-32-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-32-3&#34; name=&#34;__codelineno-32-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static_assert&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_bitset_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;bitset_t constants must be updated&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-32-4&#34; name=&#34;__codelineno-32-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#define BITSET_SHR 5 &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// log2(sizeof(ggml_bitset_t)*8)&lt;/span&gt;
&lt;a id=&#34;__codelineno-32-5&#34; name=&#34;__codelineno-32-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#define BITSET_MASK (sizeof(ggml_bitset_t)*8 - 1)&lt;/span&gt;
&lt;a id=&#34;__codelineno-32-6&#34; name=&#34;__codelineno-32-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-32-7&#34; name=&#34;__codelineno-32-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-32-8&#34; name=&#34;__codelineno-32-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// &amp;gt;&amp;gt; BITSET_SHR相当于除以32，表示数字n的bit记录位于第几个ggml_bitset_t中&lt;/span&gt;
&lt;a id=&#34;__codelineno-32-9&#34; name=&#34;__codelineno-32-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 一个ggml_bitset_t可以表示32个数的状态，在本文上下文中即表示一个hash位置&lt;/span&gt;
&lt;a id=&#34;__codelineno-32-10&#34; name=&#34;__codelineno-32-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;ggml_bitset_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-32-11&#34; name=&#34;__codelineno-32-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;BITSET_MASK&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;BITSET_SHR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-32-12&#34; name=&#34;__codelineno-32-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;根据ggml_graph_nbytes函数计算出来的内存大小，在ctx中分配内存，分配后的内存布局如下：&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_graph_graph1.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;包括计算图对象、节点指针、叶子指针、使用次数、哈希键、梯度、哈希表bit位图。接下来的几行代码初始化指向已分配内存中不同区域的指针，并将它们存储在ggml_cgraph结构体中。最后，哈希表被重置，所有槽位都被标记为未占用。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_graph_graph2.png&#34; /&gt;&lt;/p&gt;
&lt;h3 id=&#34;构建矩阵乘计算图&#34;&gt;构建矩阵乘计算图&lt;a class=&#34;headerlink&#34; href=&#34;#构建矩阵乘计算图&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;前面的内容介绍了在ggml_context中分配一个计算图内存，并且初始化了相关成员默认值。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-33-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-33-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-33-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-33-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-33-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-33-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-33-1&#34; name=&#34;__codelineno-33-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_cgraph&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_new_graph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-33-2&#34; name=&#34;__codelineno-33-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-33-3&#34; name=&#34;__codelineno-33-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 用gf表示矩阵乘任务&lt;/span&gt;
&lt;a id=&#34;__codelineno-33-4&#34; name=&#34;__codelineno-33-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// result = a*b^T&lt;/span&gt;
&lt;a id=&#34;__codelineno-33-5&#34; name=&#34;__codelineno-33-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_mul_mat&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-33-6&#34; name=&#34;__codelineno-33-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ggml_build_forward_expand&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;现在这个计算图gf支持添加2048个张量节点和叶节点，但是还没有将矩阵乘这个计算的节点加入计算图。接下来的内容就是介绍如何将矩阵乘任务信息用计算图进行表示。&lt;/p&gt;
&lt;p&gt;在ggml_mul_mat函数中，首先检查输入张量的合法性，然后创建一个结果张量，并设置张量的运算类型为矩阵乘。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-34-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-34-1&#34; name=&#34;__codelineno-34-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_mul_mat&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-2&#34; name=&#34;__codelineno-34-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_context&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-3&#34; name=&#34;__codelineno-34-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-4&#34; name=&#34;__codelineno-34-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-5&#34; name=&#34;__codelineno-34-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_ASSERT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_can_mul_mat&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-6&#34; name=&#34;__codelineno-34-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_ASSERT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_is_transposed&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-7&#34; name=&#34;__codelineno-34-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-34-8&#34; name=&#34;__codelineno-34-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 计算结果的shape&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-9&#34; name=&#34;__codelineno-34-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int64_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-10&#34; name=&#34;__codelineno-34-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_new_tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_TYPE_F32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ne&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-11&#34; name=&#34;__codelineno-34-11&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-34-12&#34; name=&#34;__codelineno-34-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 将加入graph nodes中的一个node，类型位矩阵乘&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-13&#34; name=&#34;__codelineno-34-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;op&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;     &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_OP_MUL_MAT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-14&#34; name=&#34;__codelineno-34-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;src&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-15&#34; name=&#34;__codelineno-34-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;src&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-16&#34; name=&#34;__codelineno-34-16&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-34-17&#34; name=&#34;__codelineno-34-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-34-18&#34; name=&#34;__codelineno-34-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;现在，到了我们构建计算图的最后阶段了，秘密就藏在ggml_build_forward_expand函数中。&lt;/p&gt;
&lt;p&gt;函数的输入参数是我们创建的“空图”和矩阵乘任务所返回的矩阵乘结果节点（在复杂的案例中，就是模型的输出节点或者LLM中的logits）。&lt;/p&gt;
&lt;h4 id=&#34;ggml_build_forward_expand-函数细节探索&#34;&gt;ggml_build_forward_expand 函数细节探索&lt;a class=&#34;headerlink&#34; href=&#34;#ggml_build_forward_expand-函数细节探索&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;该函数调用到了ggml_build_forward_impl函数，核心实现在ggml_visit_parents中。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-35-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-35-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-35-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-35-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-35-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-35-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-35-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-35-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-35-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-35-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-35-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-35-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-35-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-35-1&#34; name=&#34;__codelineno-35-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;ggml_build_forward_impl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_cgraph&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;expand&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-35-2&#34; name=&#34;__codelineno-35-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_nodes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-35-3&#34; name=&#34;__codelineno-35-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-35-4&#34; name=&#34;__codelineno-35-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_visit_parents&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-35-5&#34; name=&#34;__codelineno-35-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-35-6&#34; name=&#34;__codelineno-35-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_new&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_nodes&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-35-7&#34; name=&#34;__codelineno-35-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_PRINT_DEBUG&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;%s: visited %d new nodes&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__func__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-35-8&#34; name=&#34;__codelineno-35-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-35-9&#34; name=&#34;__codelineno-35-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_new&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-35-10&#34; name=&#34;__codelineno-35-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// the last added node should always be starting point&lt;/span&gt;
&lt;a id=&#34;__codelineno-35-11&#34; name=&#34;__codelineno-35-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_ASSERT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nodes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_nodes&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-35-12&#34; name=&#34;__codelineno-35-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-35-13&#34; name=&#34;__codelineno-35-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;ggml_visit_parents函数通过递归的方式构建了计算图。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_visit_parents-1.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_visit_parents-2.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;核心逻辑：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;检查当前张量是否已存在于哈希表中。如果存在，则停止执行并返回。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;对所有src张量递归调用ggml_visit_parents函数。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;如果它是一个叶节点（即常量张量或不由运算生成的输入张量），则将其存储在图的叶数组（leafs数组）中。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;否则，将其存储在图的节点数组（nodes数组）中。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;所有递归调用返回后，最后一次检查会确保最后记录的节点是结果张量。因为使用了后序遍历，这意味着输入节点（张量）是最后插入的。&lt;/p&gt;
&lt;p&gt;采用debug打印gf计算图信息，1个node节点就是mat mul op节点，两个leaf节点就是两个输入张量a、b矩阵。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-36-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-36-1&#34; name=&#34;__codelineno-36-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gf&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-2&#34; name=&#34;__codelineno-36-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_cgraph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-3&#34; name=&#34;__codelineno-36-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2048&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-4&#34; name=&#34;__codelineno-36-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_nodes&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-5&#34; name=&#34;__codelineno-36-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_leafs&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-6&#34; name=&#34;__codelineno-36-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nodes&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x000055555556ddd8&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-7&#34; name=&#34;__codelineno-36-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;grads&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-8&#34; name=&#34;__codelineno-36-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;grad_accs&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-9&#34; name=&#34;__codelineno-36-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;leafs&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x0000555555571dd8&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-10&#34; name=&#34;__codelineno-36-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;use_counts&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x0000555555575dd8&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-11&#34; name=&#34;__codelineno-36-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;visited_hash_set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-12&#34; name=&#34;__codelineno-36-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4099&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-13&#34; name=&#34;__codelineno-36-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;used&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x0000555555581e00&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-14&#34; name=&#34;__codelineno-36-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;keys&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x0000555555579de8&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-15&#34; name=&#34;__codelineno-36-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-16&#34; name=&#34;__codelineno-36-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_CGRAPH_EVAL_ORDER_LEFT_TO_RIGHT&lt;/span&gt;
&lt;a id=&#34;__codelineno-36-17&#34; name=&#34;__codelineno-36-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;到目前为止，我们已经构建好了a、b矩阵乘这个任务的计算图，接下来就是看GGML如何执行这个计算图并获取计算结果了。&lt;/p&gt;
&lt;h2 id=&#34;探索ggml的实现执行ggml计算图&#34;&gt;探索ggml的实现&amp;ndash;执行GGML计算图&lt;a class=&#34;headerlink&#34; href=&#34;#探索ggml的实现执行ggml计算图&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;这节主要介绍如何计算GGML计算图，实现的核心逻辑在ggml_graph_compute_with_ctx函数中。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-37-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-37-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-37-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-37-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-37-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-37-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-37-1&#34; name=&#34;__codelineno-37-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_threads&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// number of threads to perform some operations with multi-threading&lt;/span&gt;
&lt;a id=&#34;__codelineno-37-2&#34; name=&#34;__codelineno-37-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-37-3&#34; name=&#34;__codelineno-37-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_compute_with_ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_threads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-37-4&#34; name=&#34;__codelineno-37-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-37-5&#34; name=&#34;__codelineno-37-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// in this case, the output tensor is the last one in the graph&lt;/span&gt;
&lt;a id=&#34;__codelineno-37-6&#34; name=&#34;__codelineno-37-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_node&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;-1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;在该函数中，首先创建了个一个计算计划，并且根据cplan的work_size分配了完成这个plan所需的buffer，然后调用ggml_graph_compute函数执行计算计划。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-38-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-38-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-38-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-38-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-38-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-38-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-38-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-38-1&#34; name=&#34;__codelineno-38-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;enum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_status&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_compute_with_ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_context&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_cgraph&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_threads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-38-2&#34; name=&#34;__codelineno-38-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_cplan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_plan&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_threads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-38-3&#34; name=&#34;__codelineno-38-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-38-4&#34; name=&#34;__codelineno-38-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;work_data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint8_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_new_buffer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;work_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-38-5&#34; name=&#34;__codelineno-38-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-38-6&#34; name=&#34;__codelineno-38-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_compute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-38-7&#34; name=&#34;__codelineno-38-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;ggml_cplan结构体的核心目的是：&lt;strong&gt;确定计算的关键执行参数&lt;/strong&gt;。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;n_threads：用于图计算的线程数，这个设置为了1。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;work_size：计算计划所需的临时内存大小（字节为单位）。在simple-ctx这个示例中，这个值被设置为0，不同的后端和op需要的work_size有不同。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;探索ggml_graph_plan细节&#34;&gt;探索ggml_graph_plan细节&lt;a class=&#34;headerlink&#34; href=&#34;#探索ggml_graph_plan细节&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;h4 id=&#34;如何确定线程数量&#34;&gt;如何确定线程数量&lt;a class=&#34;headerlink&#34; href=&#34;#如何确定线程数量&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;ggml_graph_plan函数实现的主要功能就是确定计算计划所需的线程数和临时内存大小。&lt;/p&gt;
&lt;p&gt;确定线程数的逻辑：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;首先，传递的参数n_threads决定了cplan的线程数上限。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;通过迭代所有的op node，根据op类型的线程限制和n_threads参数，确max_threads。（通过op的swich case实现）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;最终线程计算如下：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-39-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-39-1&#34; name=&#34;__codelineno-39-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;final_n_threads&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MIN&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_threads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MAX&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;each&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;node&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;maximum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;multithreading&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;count&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h4 id=&#34;确定工作缓存区大小&#34;&gt;确定工作缓存区大小&lt;a class=&#34;headerlink&#34; href=&#34;#确定工作缓存区大小&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;遍历所有的op node，根据每个op type以及计算的数据类型（比如计算的矩阵乘两个参数数据类不同，需要额外的缓存区），确定需要的临时内存大小。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;最终工作缓存区大小计算如下：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-40-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-40-1&#34; name=&#34;__codelineno-40-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;final_work_buffer_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MAX&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;each&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;node&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;required&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;work&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buffer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在simple-ctx这个例子中，threads_count = 1， work_buffer_size = 0。在接下来的函数ggml_new_buffer中，可以看到分配的work_buffer_size大小的缓存区，也是在context的内存buffer中分配的。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-41-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-41-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-41-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-41-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-41-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-41-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-41-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-41-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-41-9&#34;&gt;9&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-41-1&#34; name=&#34;__codelineno-41-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;
&lt;a id=&#34;__codelineno-41-2&#34; name=&#34;__codelineno-41-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_cplan&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-41-3&#34; name=&#34;__codelineno-41-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;work_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-41-4&#34; name=&#34;__codelineno-41-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;work_data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00005555555821d0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-41-5&#34; name=&#34;__codelineno-41-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_threads&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;
&lt;a id=&#34;__codelineno-41-6&#34; name=&#34;__codelineno-41-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NULL&lt;/span&gt;
&lt;a id=&#34;__codelineno-41-7&#34; name=&#34;__codelineno-41-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;abort_callback&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x0000000000000000&lt;/span&gt;
&lt;a id=&#34;__codelineno-41-8&#34; name=&#34;__codelineno-41-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;abort_callback_data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x0000000000000000&lt;/span&gt;
&lt;a id=&#34;__codelineno-41-9&#34; name=&#34;__codelineno-41-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;计算图的执行计算&#34;&gt;计算图的执行计算&lt;a class=&#34;headerlink&#34; href=&#34;#计算图的执行计算&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;到目前为止，为了执行计算图，已经准备好了张量数据、计算图、计算计划（plan），执行的关键逻辑来到了ggml_graph_compute函数，将计算图cgraph和cplan作为参数传入。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-42-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-42-1&#34; name=&#34;__codelineno-42-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_compute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml-graph-compute.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;在ggml_graph_compute函数中, 实现了如下核心功能：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在ggml_cpu_init函数中，创建了一些快速计算的查找表。比如f32到f16的转换表、gelu计算的查找表。&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-43-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-43-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-43-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-43-1&#34; name=&#34;__codelineno-43-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ggml_table_f32_f16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-43-2&#34; name=&#34;__codelineno-43-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ggml_table_gelu_f16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_CPU_FP32_TO_FP16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_gelu_f32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-43-3&#34; name=&#34;__codelineno-43-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ggml_table_gelu_quick_f16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_CPU_FP32_TO_FP16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_gelu_quick_f32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;创建了线程池，将计算图和计算任务dispath给线程池执行。在linux下，ggml采用pthread实现线程相关操作。（关于GGML_USE_OPENMP的逻辑可以先跳过）&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;ggml线程池实现&#34;&gt;GGML线程池实现&lt;a class=&#34;headerlink&#34; href=&#34;#ggml线程池实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;GGML 实现了一个线程池，该线程池经过优化，可高效运行计算图，并针对 NUMA 架构进行了优化。&lt;/p&gt;
&lt;p&gt;ggml首先使用默认参数初始化一个ggml_thread_pool结构体，然后为每个工作线程分配一个状态结构体（ggml_compute_state），负责线程池中的每个线程的状态记录：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-44-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-44-1&#34; name=&#34;__codelineno-44-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Per-thread state&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-2&#34; name=&#34;__codelineno-44-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_compute_state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-3&#34; name=&#34;__codelineno-44-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#ifndef GGML_USE_OPENMP&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-4&#34; name=&#34;__codelineno-44-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// linux下实际为pthread&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-5&#34; name=&#34;__codelineno-44-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_thread_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;thrd&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-6&#34; name=&#34;__codelineno-44-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 用于设置cpu亲和性（NUMA相关优化）&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-7&#34; name=&#34;__codelineno-44-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cpumask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_MAX_N_THREADS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-8&#34; name=&#34;__codelineno-44-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;last_graph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-9&#34; name=&#34;__codelineno-44-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pending&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-10&#34; name=&#34;__codelineno-44-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#endif&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-11&#34; name=&#34;__codelineno-44-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 指向线程池的指针&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-12&#34; name=&#34;__codelineno-44-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_threadpool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-13&#34; name=&#34;__codelineno-44-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 线程编号&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-14&#34; name=&#34;__codelineno-44-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ith&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-44-15&#34; name=&#34;__codelineno-44-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;如果启用了 OpenMP，线程管理会自动处理；否则，GGML 会手动创建和管理 pthread，即手动设置cpu亲和性等操作。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/ggml_threadpool.png&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;cpu亲和性设置&#34;&gt;cpu亲和性设置&lt;a class=&#34;headerlink&#34; href=&#34;#cpu亲和性设置&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;由于在numa架构下，本地/远程内存访问速度差异大，通过NUMA感知调度（如线程绑定、内存分配优化）可提升性能‌。通过设置cpu亲和性，绑定线程到本地NUMA节点，减少远程访问‌。&lt;/p&gt;
&lt;p&gt;在ggml的实现中，通过函数ggml_thread_cpumask_next()为每个worker线程分配cpu亲和性。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-45-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-45-1&#34; name=&#34;__codelineno-45-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;ggml_thread_cpumask_next&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;global_mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;local_mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;strict&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int32_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;iter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-2&#34; name=&#34;__codelineno-45-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;strict&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-3&#34; name=&#34;__codelineno-45-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memcpy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;local_mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;global_mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_MAX_N_THREADS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-4&#34; name=&#34;__codelineno-45-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-5&#34; name=&#34;__codelineno-45-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-6&#34; name=&#34;__codelineno-45-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;local_mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_MAX_N_THREADS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-7&#34; name=&#34;__codelineno-45-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int32_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;base_idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;iter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-8&#34; name=&#34;__codelineno-45-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int32_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_MAX_N_THREADS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-9&#34; name=&#34;__codelineno-45-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int32_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;base_idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-10&#34; name=&#34;__codelineno-45-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_MAX_N_THREADS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-11&#34; name=&#34;__codelineno-45-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Just a cheaper modulo&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-12&#34; name=&#34;__codelineno-45-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_MAX_N_THREADS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-13&#34; name=&#34;__codelineno-45-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-14&#34; name=&#34;__codelineno-45-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;global_mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;])&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-15&#34; name=&#34;__codelineno-45-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;local_mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-16&#34; name=&#34;__codelineno-45-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;iter&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-17&#34; name=&#34;__codelineno-45-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-18&#34; name=&#34;__codelineno-45-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-19&#34; name=&#34;__codelineno-45-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-20&#34; name=&#34;__codelineno-45-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-45-21&#34; name=&#34;__codelineno-45-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;在该函数中通过strict参数控制线程的亲和性设置。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;如果strict为false，则将全局mask复制给线程的mask。在没有NUMA的架构中，这会导致所有线程都被允许在任何核心上运行。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;如果strict为true，则通过循环遍历全局mask，找到第一个可用的CPU核心，并将其分配给线程。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这种逻辑确保线程在可用的CPU核心之间均匀分布，从而减少竞争。&lt;/p&gt;
&lt;h4 id=&#34;计算图工作线程创建及调度&#34;&gt;计算图工作线程创建及调度&lt;a class=&#34;headerlink&#34; href=&#34;#计算图工作线程创建及调度&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;上面的逻辑完成了线程池的创建、亲和性的设置，接下来就是创建具体的工作线程了，也就是线程跑起来要执行怎样的运算逻辑。&lt;/p&gt;
&lt;p&gt;注意，这里创建工作线程是从thread 1开始的，因为thread 0的触发不在这里。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-46-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-46-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-46-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-46-1&#34; name=&#34;__codelineno-46-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tpp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_threads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-46-2&#34; name=&#34;__codelineno-46-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int32_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rc&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_thread_create&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;workers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;thrd&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_compute_secondary_thread&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;workers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]);&lt;/span&gt;
&lt;a id=&#34;__codelineno-46-3&#34; name=&#34;__codelineno-46-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;接下来，请看ggml_graph_compute_secondary_thread函数。&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-47-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-47-1&#34; name=&#34;__codelineno-47-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;thread_ret_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;ggml_graph_compute_secondary_thread&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-2&#34; name=&#34;__codelineno-47-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_compute_state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_compute_state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-3&#34; name=&#34;__codelineno-47-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_threadpool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-4&#34; name=&#34;__codelineno-47-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-47-5&#34; name=&#34;__codelineno-47-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 设置线程优先级&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-6&#34; name=&#34;__codelineno-47-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_thread_apply_priority&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prio&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-7&#34; name=&#34;__codelineno-47-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_thread_cpumask_is_valid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cpumask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-8&#34; name=&#34;__codelineno-47-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 设置线程 affinity&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-9&#34; name=&#34;__codelineno-47-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_thread_apply_affinity&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cpumask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-10&#34; name=&#34;__codelineno-47-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-11&#34; name=&#34;__codelineno-47-11&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-47-12&#34; name=&#34;__codelineno-47-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;while&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-13&#34; name=&#34;__codelineno-47-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Check if we need to sleep&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-14&#34; name=&#34;__codelineno-47-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;while&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pause&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-15&#34; name=&#34;__codelineno-47-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_PRINT_DEBUG&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;thread #%d inside pause loop&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ith&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-16&#34; name=&#34;__codelineno-47-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_mutex_lock_shared&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mutex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-17&#34; name=&#34;__codelineno-47-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pause&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-18&#34; name=&#34;__codelineno-47-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_cond_wait&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cond&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mutex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-19&#34; name=&#34;__codelineno-47-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-20&#34; name=&#34;__codelineno-47-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_PRINT_DEBUG&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;thread #%d resuming after wait&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ith&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-21&#34; name=&#34;__codelineno-47-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_mutex_unlock_shared&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mutex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-22&#34; name=&#34;__codelineno-47-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-23&#34; name=&#34;__codelineno-47-23&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-47-24&#34; name=&#34;__codelineno-47-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// This needs to be checked for after the cond_wait&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-25&#34; name=&#34;__codelineno-47-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;break&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-26&#34; name=&#34;__codelineno-47-26&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-47-27&#34; name=&#34;__codelineno-47-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Check if there is new work&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-28&#34; name=&#34;__codelineno-47-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// The main thread is the only one that can dispatch new work&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-29&#34; name=&#34;__codelineno-47-29&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-47-30&#34; name=&#34;__codelineno-47-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_compute_check_for_work&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-31&#34; name=&#34;__codelineno-47-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pending&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-32&#34; name=&#34;__codelineno-47-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pending&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-33&#34; name=&#34;__codelineno-47-33&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-47-34&#34; name=&#34;__codelineno-47-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_compute_thread&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-35&#34; name=&#34;__codelineno-47-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-36&#34; name=&#34;__codelineno-47-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-37&#34; name=&#34;__codelineno-47-37&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-47-38&#34; name=&#34;__codelineno-47-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;thread_ret_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-47-39&#34; name=&#34;__codelineno-47-39&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
可以看到工作线程不是上来就开始执行，而是通过threadpool-&amp;gt;pause进行了暂停等待。&lt;/p&gt;
&lt;p&gt;让我们回头看看主线程中的ggml_graph_compute逻辑，它首先创建线程池，也就是上面的部分。创建好从1开始的工作线程后，然后调用了ggml_graph_compute_kickoff，就是它把线程池的pause设置为false。&lt;/p&gt;
&lt;p&gt;然后线程0在这个启动其它线程的线程开始执行ggml_graph_compute_thread计算任务。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-48-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-48-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-48-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-48-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-48-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-48-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-48-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-48-1&#34; name=&#34;__codelineno-48-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;enum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_status&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_compute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_cgraph&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_cplan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-48-2&#34; name=&#34;__codelineno-48-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Kick all threads to start the new graph&lt;/span&gt;
&lt;a id=&#34;__codelineno-48-3&#34; name=&#34;__codelineno-48-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_compute_kickoff&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_threads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-48-4&#34; name=&#34;__codelineno-48-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-48-5&#34; name=&#34;__codelineno-48-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// This is a work thread too&lt;/span&gt;
&lt;a id=&#34;__codelineno-48-6&#34; name=&#34;__codelineno-48-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_graph_compute_thread&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;workers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]);&lt;/span&gt;
&lt;a id=&#34;__codelineno-48-7&#34; name=&#34;__codelineno-48-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;多线程如何执行矩阵乘张量计算&#34;&gt;多线程如何执行矩阵乘张量计算&lt;a class=&#34;headerlink&#34; href=&#34;#多线程如何执行矩阵乘张量计算&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;GGML的所有线程每次只处理一个节点。让我们看看ggml_compute_forward，其中会根据节点的运算符类型选择实际的计算函数。这是通过一个庞大的switch-case语句块来处理的。&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-49-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-49-1&#34; name=&#34;__codelineno-49-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;thread_ret_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;ggml_graph_compute_thread&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-2&#34; name=&#34;__codelineno-49-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_compute_state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_compute_state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-3&#34; name=&#34;__codelineno-49-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_threadpool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-4&#34; name=&#34;__codelineno-49-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-49-5&#34; name=&#34;__codelineno-49-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_cgraph&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-6&#34; name=&#34;__codelineno-49-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_cplan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-7&#34; name=&#34;__codelineno-49-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-49-8&#34; name=&#34;__codelineno-49-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set_numa_thread_affinity&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ith&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-9&#34; name=&#34;__codelineno-49-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-49-10&#34; name=&#34;__codelineno-49-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_compute_params&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-11&#34; name=&#34;__codelineno-49-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.ith       =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ith&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-12&#34; name=&#34;__codelineno-49-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.nth       =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;atomic_load_explicit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_threads_cur&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory_order_relaxed&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-13&#34; name=&#34;__codelineno-49-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.wsize     =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;work_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-14&#34; name=&#34;__codelineno-49-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.wdata     =*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;work_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-15&#34; name=&#34;__codelineno-49-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*.threadpool=*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-16&#34; name=&#34;__codelineno-49-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-17&#34; name=&#34;__codelineno-49-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-49-18&#34; name=&#34;__codelineno-49-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;node_n&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;node_n&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_nodes&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;atomic_load_explicit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;abort&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory_order_relaxed&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;node_n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;node_n&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-19&#34; name=&#34;__codelineno-49-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;node&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nodes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;node_n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-20&#34; name=&#34;__codelineno-49-20&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-49-21&#34; name=&#34;__codelineno-49-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_compute_forward&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;node&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-22&#34; name=&#34;__codelineno-49-22&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-49-23&#34; name=&#34;__codelineno-49-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ith&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;abort_callback&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-24&#34; name=&#34;__codelineno-49-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;abort_callback&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cplan&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;abort_callback_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-25&#34; name=&#34;__codelineno-49-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;atomic_store_explicit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;abort&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;node_n&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory_order_relaxed&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-26&#34; name=&#34;__codelineno-49-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ec&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GGML_STATUS_ABORTED&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-27&#34; name=&#34;__codelineno-49-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-28&#34; name=&#34;__codelineno-49-28&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-49-29&#34; name=&#34;__codelineno-49-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;node_n&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cgraph&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n_nodes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-30&#34; name=&#34;__codelineno-49-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_barrier&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-31&#34; name=&#34;__codelineno-49-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-32&#34; name=&#34;__codelineno-49-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-33&#34; name=&#34;__codelineno-49-33&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-49-34&#34; name=&#34;__codelineno-49-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_barrier&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadpool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-35&#34; name=&#34;__codelineno-49-35&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-49-36&#34; name=&#34;__codelineno-49-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-49-37&#34; name=&#34;__codelineno-49-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
ggml_compute_forward调用的是ggml_compute_forward_mul_mat的实现，完成矩阵乘法。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-50-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-50-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-50-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-50-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-50-1&#34; name=&#34;__codelineno-50-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;no&#34;&gt;GGML_OP_MUL_MAT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-50-2&#34; name=&#34;__codelineno-50-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-50-3&#34; name=&#34;__codelineno-50-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_compute_forward_mul_mat&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-50-4&#34; name=&#34;__codelineno-50-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;break&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;查看ggml_compute_forward_mul_mat的实现可知，矩阵的计算不是一个线程完成整个矩阵的计算，而是传递了thread_id参数，根据thread_id来拆分矩阵块，分块计算。&lt;/p&gt;
&lt;p&gt;这里也可以看到GGML的计算图执行调度和一般图计算的区别，一般场景的有向无环图，多个线程并行执行多个可以并行的node，这里GGML是一次只执行一个node，node中多个线程分块计算。然后进入下一个节点计算。&lt;/p&gt;
&lt;p&gt;一旦一个节点node的计算完成，所有线程都会在屏障ggml_barrier处同步，确保它们在进入下一个节点之前完成当前节点的计算。这个过程会重复进行，直到图中的所有节点都被评估完毕。&lt;/p&gt;
&lt;p&gt;上面更多的谈到的是不使用OpenMP，手动管理线程的凡是。如果启用OpenMP后，它会自动管理并行计算，无需手动创建和同步线程。我们无需自己处理线程池、条件变量和竞争条件，只需设置线程数量，让每个线程执行ggml_graph_compute_thread即可。&lt;/p&gt;
&lt;h3 id=&#34;获取计算结果&#34;&gt;获取计算结果&lt;a class=&#34;headerlink&#34; href=&#34;#获取计算结果&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-51-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-51-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-51-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-51-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-51-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-51-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-51-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-51-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-51-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-51-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-51-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-51-1&#34; name=&#34;__codelineno-51-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// perform computation in cpu&lt;/span&gt;
&lt;a id=&#34;__codelineno-51-2&#34; name=&#34;__codelineno-51-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ggml_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;compute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-51-3&#34; name=&#34;__codelineno-51-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-51-4&#34; name=&#34;__codelineno-51-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// get the result data pointer as a float array to print&lt;/span&gt;
&lt;a id=&#34;__codelineno-51-5&#34; name=&#34;__codelineno-51-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vector&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;out_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_nelements&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-51-6&#34; name=&#34;__codelineno-51-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;memcpy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;out_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_nbytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-51-7&#34; name=&#34;__codelineno-51-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-51-8&#34; name=&#34;__codelineno-51-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// expected result:&lt;/span&gt;
&lt;a id=&#34;__codelineno-51-9&#34; name=&#34;__codelineno-51-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// [ 60.00 55.00 50.00 110.00&lt;/span&gt;
&lt;a id=&#34;__codelineno-51-10&#34; name=&#34;__codelineno-51-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;//   90.00 54.00 54.00 126.00&lt;/span&gt;
&lt;a id=&#34;__codelineno-51-11&#34; name=&#34;__codelineno-51-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;//   42.00 29.00 28.00 64.00 ]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;最后就是获取result node，然后将计算结果拷贝出来。到此，通过simple-ctx的例子，我们从源码理解了GGML如何实现在ggml_context中分配所有需要的内存，通过cpu backend的方式执行计算图。&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c20如何实现一个基于属性测试的quickcheck-cpp库/&#34; target=&#34;_blank&#34;&gt;C++20如何实现一个基于属性测试的quickcheck-cpp库&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c使用abseil-cpp遇到的小问题/&#34; target=&#34;_blank&#34;&gt;C++使用abseil-cpp遇到的小问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/%E6%8E%A2%E7%B4%A2ggml%E7%9A%84%E5%AE%9E%E7%8E%B0/</link>
      <pubDate>Mon, 01 Sep 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/%E6%8E%A2%E7%B4%A2ggml%E7%9A%84%E5%AE%9E%E7%8E%B0/</guid>
      
    </item>
    
    <item>
      <title>bitnet中int2和int8的使用</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;!-- more --&gt;

&lt;h2 id=&#34;bitnet中int2和int8的使用&#34;&gt;bitnet中int2和int8的使用&lt;a class=&#34;headerlink&#34; href=&#34;#bitnet中int2和int8的使用&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;W2A8‌（2-bit权重 + 8-bit激活）是一种极低精度量化方案，旨在通过牺牲部分模型精度换取显著的存储和计算效率提升。适用于计算资源受限的场景边缘设备部署‌，如移动端或嵌入式设备‌。&lt;/p&gt;
&lt;h3 id=&#34;gpu版本推理&#34;&gt;gpu版本推理&lt;a class=&#34;headerlink&#34; href=&#34;#gpu版本推理&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/microsoft/BitNet/tree/main/gpu&#34;&gt;参考readme中&lt;/a&gt;使用的 BitNet-b1.58-2B-4T模型。&lt;/p&gt;
&lt;p&gt;权重weight采用int2存储，激活activation采用int8存储。自定义了个cuda kernel函数，用于计算int2和int8的乘法。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;在转换checkpoint时，将int8权重转为int2（convert_weight_int8_to_int2），并且对权重进行了划分为16×32 blocks和重排，便于gpu的高效运算。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;自定义kernel函数ladder_int8xint2_kernel，采用gpu dp4a指令(__dp4a)进行低精度的点积操作。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://developer.nvidia.com/blog/parallelforall/wp-content/uploads/2016/10/DP4A_DP2A-624x223.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;在prefill时，使用fp16；在decode时，使用int2，采用自定义cuda kernel函数进行int2和int8的乘法。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Python&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;# \gpu\generate.py&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;model_args_prefill&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;fast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ModelArgs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;use_kernel&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;False&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;model_args_decode&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;fast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ModelArgs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;use_kernel&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;True&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-4&#34; name=&#34;__codelineno-0-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;tokenizer&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Tokenizer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;./tokenizer.model&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-5&#34; name=&#34;__codelineno-0-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-6&#34; name=&#34;__codelineno-0-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;prefill_model&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;fast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Transformer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_args_prefill&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-7&#34; name=&#34;__codelineno-0-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;decode_model&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;fast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Transformer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_args_decode&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-8&#34; name=&#34;__codelineno-0-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-9&#34; name=&#34;__codelineno-0-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;fp16_ckpt_path&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ckpt_dir&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;/&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;model_state_fp16.pt&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-10&#34; name=&#34;__codelineno-0-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;fp16_checkpoint&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;load&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fp16_ckpt_path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;map_location&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;cpu&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-11&#34; name=&#34;__codelineno-0-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;int2_ckpt_path&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ckpt_dir&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;/&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;model_state_int2.pt&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-12&#34; name=&#34;__codelineno-0-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;int2_checkpoint&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;load&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;int2_ckpt_path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;map_location&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;cpu&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-13&#34; name=&#34;__codelineno-0-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;prefill_model&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;load_state_dict&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fp16_checkpoint&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;strict&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;True&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-14&#34; name=&#34;__codelineno-0-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;decode_model&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;load_state_dict&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;int2_checkpoint&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;strict&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;True&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
ladder_int8xint2_kernel核函数用于计算int2乘int8的向量乘法。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;M&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ws_num&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K_block_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;N_block_size&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;__global__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__launch_bounds__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ladder_int8xint2_kernel&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int8_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__restrict__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;A&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int8_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__restrict__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;B&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__nv_bfloat16&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__restrict__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dtype_transform&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__nv_bfloat16&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__restrict__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__nv_bfloat16&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__restrict__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ws&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K_per_loop&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-4&#34; name=&#34;__codelineno-1-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wmma_K&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-5&#34; name=&#34;__codelineno-1-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wmma_N&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-6&#34; name=&#34;__codelineno-1-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;in_thread_C_local&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-7&#34; name=&#34;__codelineno-1-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;signed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;A_local&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K_per_loop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-8&#34; name=&#34;__codelineno-1-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;B_reshape_local&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-9&#34; name=&#34;__codelineno-1-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;signed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;B_decode_local&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K_per_loop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-10&#34; name=&#34;__codelineno-1-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;red_buf0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-11&#34; name=&#34;__codelineno-1-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;in_thread_C_local&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-12&#34; name=&#34;__codelineno-1-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#pragma unroll&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-13&#34; name=&#34;__codelineno-1-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;k_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;k_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K_per_loop&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K_block_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;k_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-14&#34; name=&#34;__codelineno-1-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;int4&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;A_local&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;int4&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;A&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;k_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K_per_loop&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K_block_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(((&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadIdx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K_per_loop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)));&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-15&#34; name=&#34;__codelineno-1-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;B_reshape_local&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;B&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-1-16&#34; name=&#34;__codelineno-1-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(((&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;blockIdx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;N_block_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-1-17&#34; name=&#34;__codelineno-1-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;k_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K_block_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K_per_loop&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wmma_N&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-18&#34; name=&#34;__codelineno-1-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((((&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadIdx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wmma_K&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wmma_N&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-19&#34; name=&#34;__codelineno-1-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((((&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadIdx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wmma_K&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wmma_N&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-1-20&#34; name=&#34;__codelineno-1-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((((&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadIdx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wmma_K&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wmma_N&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-1-21&#34; name=&#34;__codelineno-1-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((((&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadIdx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wmma_K&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-22&#34; name=&#34;__codelineno-1-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-23&#34; name=&#34;__codelineno-1-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;decode_i2s_to_i8s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;B_reshape_local&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;B_decode_local&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-24&#34; name=&#34;__codelineno-1-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#pragma unroll&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-25&#34; name=&#34;__codelineno-1-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;k_2_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;k_2_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;k_2_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-26&#34; name=&#34;__codelineno-1-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;in_thread_C_local&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__dp4a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;A_local&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;k_2_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))],&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;B_decode_local&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;k_2_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))],&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;in_thread_C_local&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-27&#34; name=&#34;__codelineno-1-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-28&#34; name=&#34;__codelineno-1-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-29&#34; name=&#34;__codelineno-1-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;red_buf0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;in_thread_C_local&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-30&#34; name=&#34;__codelineno-1-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#pragma unroll&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-31&#34; name=&#34;__codelineno-1-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K_block_size&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-32&#34; name=&#34;__codelineno-1-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;red_buf0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__shfl_down_sync&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__activemask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;red_buf0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;K_block_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-33&#34; name=&#34;__codelineno-1-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-34&#34; name=&#34;__codelineno-1-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;out_idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((((&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;blockIdx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;N_block_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadIdx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-35&#34; name=&#34;__codelineno-1-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ws_idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;out_idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ws_num&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-36&#34; name=&#34;__codelineno-1-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threadIdx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-37&#34; name=&#34;__codelineno-1-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dtype_transform&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;out_idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__nv_bfloat16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(((&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;red_buf0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;])&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ws&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ws_idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-38&#34; name=&#34;__codelineno-1-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;自定义kernel NVIDIA GeForce RTX 4050性能测试运行结果：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Text Only&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;custom == np True
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;Shape(2560, 2560), W2A8: 54.40us, torch BF16: 73.39us
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;custom == np True
&lt;a id=&#34;__codelineno-2-4&#34; name=&#34;__codelineno-2-4&#34;&gt;&lt;/a&gt;Shape(3840, 2560), W2A8: 22.66us, torch BF16: 75.50us
&lt;a id=&#34;__codelineno-2-5&#34; name=&#34;__codelineno-2-5&#34;&gt;&lt;/a&gt;custom == np True
&lt;a id=&#34;__codelineno-2-6&#34; name=&#34;__codelineno-2-6&#34;&gt;&lt;/a&gt;Shape(13824, 2560), W2A8: 39.99us, torch BF16: 364.94us
&lt;a id=&#34;__codelineno-2-7&#34; name=&#34;__codelineno-2-7&#34;&gt;&lt;/a&gt;custom == np True
&lt;a id=&#34;__codelineno-2-8&#34; name=&#34;__codelineno-2-8&#34;&gt;&lt;/a&gt;Shape(2560, 6912), W2A8: 48.95us, torch BF16: 221.11us
&lt;a id=&#34;__codelineno-2-9&#34; name=&#34;__codelineno-2-9&#34;&gt;&lt;/a&gt;custom == np True
&lt;a id=&#34;__codelineno-2-10&#34; name=&#34;__codelineno-2-10&#34;&gt;&lt;/a&gt;Shape(3200, 3200), W2A8: 45.98us, torch BF16: 128.34us
&lt;a id=&#34;__codelineno-2-11&#34; name=&#34;__codelineno-2-11&#34;&gt;&lt;/a&gt;custom == np True
&lt;a id=&#34;__codelineno-2-12&#34; name=&#34;__codelineno-2-12&#34;&gt;&lt;/a&gt;Shape(4800, 3200), W2A8: 25.54us, torch BF16: 171.50us
&lt;a id=&#34;__codelineno-2-13&#34; name=&#34;__codelineno-2-13&#34;&gt;&lt;/a&gt;custom == np True
&lt;a id=&#34;__codelineno-2-14&#34; name=&#34;__codelineno-2-14&#34;&gt;&lt;/a&gt;Shape(3200, 10240), W2A8: 37.18us, torch BF16: 342.03us
&lt;a id=&#34;__codelineno-2-15&#34; name=&#34;__codelineno-2-15&#34;&gt;&lt;/a&gt;custom == np True
&lt;a id=&#34;__codelineno-2-16&#34; name=&#34;__codelineno-2-16&#34;&gt;&lt;/a&gt;Shape(20480, 3200), W2A8: 74.29us, torch BF16: 805.49us
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;cpu版本推理&#34;&gt;cpu版本推理&lt;a class=&#34;headerlink&#34; href=&#34;#cpu版本推理&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;cpu推理基于llama.cpp项目，采用T-MAC(查找表)算法提高了推理性能。&lt;/p&gt;
&lt;p&gt;传统方式，需要把权重反量化为浮点数，然后和激活进行计算。采用查找表就是，把1bit的各种计算可能提前计算好存储到一个查找表中，然后通过索引进行查找完成计算。&lt;/p&gt;
&lt;h4 id=&#34;simd计算int2和int8的向量点积&#34;&gt;SIMD计算int2和int8的向量点积&lt;a class=&#34;headerlink&#34; href=&#34;#simd计算int2和int8的向量点积&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;bitnet的实现分为intel的AVX 和 ARM 的 neon 指令， 这里对&lt;a href=&#34;https://github.com/microsoft/BitNet/blob/main/src/ggml-bitnet-mad.cpp&#34;&gt;AVX指令版本&lt;/a&gt;进行介绍。&lt;/p&gt;
&lt;p&gt;将量化后的 i2 数据与 i8 数据做点积，利用平台 SIMD 指令做并行加速。
为了高效处理，数据按组分块，每组做并行处理，最后合并结果。
针对不同平台分别优化（AVX2/NEON）。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;each&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;of&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;groups&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;each&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;in&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;mf&#34;&gt;1.&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;提取2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bit数据&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;mf&#34;&gt;2.&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;载入8&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bit数据&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-5&#34; name=&#34;__codelineno-3-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;mf&#34;&gt;3.&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;做乘法累加&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;（&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SIMD并行&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;）&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-6&#34; name=&#34;__codelineno-3-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;累加所有组的结果&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-7&#34; name=&#34;__codelineno-3-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;最后合并所有块的结果&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;输出点积&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt;  1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt;  2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-3&#34;&gt;  3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-4&#34;&gt;  4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-5&#34;&gt;  5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-6&#34;&gt;  6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-7&#34;&gt;  7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-8&#34;&gt;  8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-9&#34;&gt;  9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-10&#34;&gt; 10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-11&#34;&gt; 11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-12&#34;&gt; 12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-13&#34;&gt; 13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-14&#34;&gt; 14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-15&#34;&gt; 15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-16&#34;&gt; 16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-17&#34;&gt; 17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-18&#34;&gt; 18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-19&#34;&gt; 19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-20&#34;&gt; 20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-21&#34;&gt; 21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-22&#34;&gt; 22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-23&#34;&gt; 23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-24&#34;&gt; 24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-25&#34;&gt; 25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-26&#34;&gt; 26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-27&#34;&gt; 27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-28&#34;&gt; 28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-29&#34;&gt; 29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-30&#34;&gt; 30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-31&#34;&gt; 31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-32&#34;&gt; 32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-33&#34;&gt; 33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-34&#34;&gt; 34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-35&#34;&gt; 35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-36&#34;&gt; 36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-37&#34;&gt; 37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-38&#34;&gt; 38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-39&#34;&gt; 39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-40&#34;&gt; 40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-41&#34;&gt; 41&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-42&#34;&gt; 42&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-43&#34;&gt; 43&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-44&#34;&gt; 44&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-45&#34;&gt; 45&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-46&#34;&gt; 46&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-47&#34;&gt; 47&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-48&#34;&gt; 48&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-49&#34;&gt; 49&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-50&#34;&gt; 50&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-51&#34;&gt; 51&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-52&#34;&gt; 52&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-53&#34;&gt; 53&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-54&#34;&gt; 54&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-55&#34;&gt; 55&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-56&#34;&gt; 56&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-57&#34;&gt; 57&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-58&#34;&gt; 58&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-59&#34;&gt; 59&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-60&#34;&gt; 60&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-61&#34;&gt; 61&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-62&#34;&gt; 62&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-63&#34;&gt; 63&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-64&#34;&gt; 64&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-65&#34;&gt; 65&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-66&#34;&gt; 66&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-67&#34;&gt; 67&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-68&#34;&gt; 68&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-69&#34;&gt; 69&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-70&#34;&gt; 70&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-71&#34;&gt; 71&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-72&#34;&gt; 72&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-73&#34;&gt; 73&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-74&#34;&gt; 74&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-75&#34;&gt; 75&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-76&#34;&gt; 76&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-77&#34;&gt; 77&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-78&#34;&gt; 78&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-79&#34;&gt; 79&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-80&#34;&gt; 80&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-81&#34;&gt; 81&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-82&#34;&gt; 82&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-83&#34;&gt; 83&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-84&#34;&gt; 84&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-85&#34;&gt; 85&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-86&#34;&gt; 86&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-87&#34;&gt; 87&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-88&#34;&gt; 88&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-89&#34;&gt; 89&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-90&#34;&gt; 90&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-91&#34;&gt; 91&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-92&#34;&gt; 92&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-93&#34;&gt; 93&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-94&#34;&gt; 94&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-95&#34;&gt; 95&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-96&#34;&gt; 96&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-97&#34;&gt; 97&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-98&#34;&gt; 98&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-99&#34;&gt; 99&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-100&#34;&gt;100&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-101&#34;&gt;101&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-102&#34;&gt;102&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-103&#34;&gt;103&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-104&#34;&gt;104&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-105&#34;&gt;105&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-106&#34;&gt;106&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-107&#34;&gt;107&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-108&#34;&gt;108&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-109&#34;&gt;109&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-110&#34;&gt;110&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-111&#34;&gt;111&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-112&#34;&gt;112&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-113&#34;&gt;113&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-114&#34;&gt;114&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-115&#34;&gt;115&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-116&#34;&gt;116&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-117&#34;&gt;117&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-118&#34;&gt;118&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-119&#34;&gt;119&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-120&#34;&gt;120&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-121&#34;&gt;121&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-122&#34;&gt;122&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-123&#34;&gt;123&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-124&#34;&gt;124&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-125&#34;&gt;125&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-126&#34;&gt;126&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-127&#34;&gt;127&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-128&#34;&gt;128&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-129&#34;&gt;129&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-130&#34;&gt;130&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-131&#34;&gt;131&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-132&#34;&gt;132&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-133&#34;&gt;133&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-134&#34;&gt;134&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-135&#34;&gt;135&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-136&#34;&gt;136&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-137&#34;&gt;137&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-138&#34;&gt;138&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-139&#34;&gt;139&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-140&#34;&gt;140&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-141&#34;&gt;141&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-142&#34;&gt;142&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-143&#34;&gt;143&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-144&#34;&gt;144&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-145&#34;&gt;145&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-146&#34;&gt;146&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-147&#34;&gt;147&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-148&#34;&gt;148&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-149&#34;&gt;149&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-150&#34;&gt;150&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-151&#34;&gt;151&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-152&#34;&gt;152&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-153&#34;&gt;153&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-154&#34;&gt;154&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-155&#34;&gt;155&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-156&#34;&gt;156&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-157&#34;&gt;157&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-158&#34;&gt;158&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-159&#34;&gt;159&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-160&#34;&gt;160&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-161&#34;&gt;161&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-162&#34;&gt;162&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-163&#34;&gt;163&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-164&#34;&gt;164&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-165&#34;&gt;165&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-166&#34;&gt;166&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-167&#34;&gt;167&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-168&#34;&gt;168&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-169&#34;&gt;169&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-170&#34;&gt;170&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-171&#34;&gt;171&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-172&#34;&gt;172&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-173&#34;&gt;173&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-174&#34;&gt;174&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-175&#34;&gt;175&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-176&#34;&gt;176&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-177&#34;&gt;177&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-178&#34;&gt;178&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-179&#34;&gt;179&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-180&#34;&gt;180&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-181&#34;&gt;181&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-182&#34;&gt;182&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-183&#34;&gt;183&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-184&#34;&gt;184&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-185&#34;&gt;185&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-186&#34;&gt;186&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-187&#34;&gt;187&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-188&#34;&gt;188&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-189&#34;&gt;189&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-190&#34;&gt;190&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-191&#34;&gt;191&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-192&#34;&gt;192&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-193&#34;&gt;193&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-194&#34;&gt;194&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-195&#34;&gt;195&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-196&#34;&gt;196&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-197&#34;&gt;197&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-198&#34;&gt;198&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-199&#34;&gt;199&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-200&#34;&gt;200&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-201&#34;&gt;201&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-202&#34;&gt;202&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-203&#34;&gt;203&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-204&#34;&gt;204&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-205&#34;&gt;205&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-206&#34;&gt;206&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-207&#34;&gt;207&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-208&#34;&gt;208&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-209&#34;&gt;209&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-210&#34;&gt;210&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-211&#34;&gt;211&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-212&#34;&gt;212&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-213&#34;&gt;213&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-214&#34;&gt;214&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-215&#34;&gt;215&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-216&#34;&gt;216&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-217&#34;&gt;217&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-218&#34;&gt;218&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-219&#34;&gt;219&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-220&#34;&gt;220&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-221&#34;&gt;221&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-222&#34;&gt;222&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-223&#34;&gt;223&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-224&#34;&gt;224&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-225&#34;&gt;225&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-226&#34;&gt;226&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-227&#34;&gt;227&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-228&#34;&gt;228&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-229&#34;&gt;229&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-230&#34;&gt;230&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-231&#34;&gt;231&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-232&#34;&gt;232&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-233&#34;&gt;233&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-234&#34;&gt;234&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-235&#34;&gt;235&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-236&#34;&gt;236&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-237&#34;&gt;237&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-238&#34;&gt;238&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-239&#34;&gt;239&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-240&#34;&gt;240&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-241&#34;&gt;241&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-242&#34;&gt;242&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-243&#34;&gt;243&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-244&#34;&gt;244&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-245&#34;&gt;245&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-246&#34;&gt;246&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 1. 初始化掩码和累加器&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// mask = _mm256_set1_epi8(0x03); 用于提取2-bit数据。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-3&#34; name=&#34;__codelineno-4-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// accu = _mm256_setzero_si256(); 用于累加结果。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-4&#34; name=&#34;__codelineno-4-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 2. 分组处理&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-5&#34; name=&#34;__codelineno-4-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 外层循环：每次处理32组。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-6&#34; name=&#34;__codelineno-4-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 内层循环：遍历每组中的32个元素。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-7&#34; name=&#34;__codelineno-4-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 对每一组数据，分别取出2-bit并与8-bit数据做乘法累加（点积）。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-8&#34; name=&#34;__codelineno-4-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 3. 数据解码&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-9&#34; name=&#34;__codelineno-4-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 2-bit数据拆成4个bit组（shift和mask操作）。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-10&#34; name=&#34;__codelineno-4-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 8-bit直接载入。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-11&#34; name=&#34;__codelineno-4-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 使用 _mm256_maddubs_epi16 指令做乘法累加。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-12&#34; name=&#34;__codelineno-4-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 4. 累加所有结果&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-13&#34; name=&#34;__codelineno-4-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 使用 _mm256_add_epi16 和 _mm256_add_epi32 指令合并结果。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-14&#34; name=&#34;__codelineno-4-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 最后用 hsum_i32_8 对 SIMD 累加结果求和，得到最终点积。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-15&#34; name=&#34;__codelineno-4-15&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-16&#34; name=&#34;__codelineno-4-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sumi&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;将结果赋值给输出指针&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-17&#34; name=&#34;__codelineno-4-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-18&#34; name=&#34;__codelineno-4-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;vector&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-19&#34; name=&#34;__codelineno-4-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;type_traits&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-20&#34; name=&#34;__codelineno-4-20&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-21&#34; name=&#34;__codelineno-4-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// #include &amp;quot;ggml-bitnet.h&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-22&#34; name=&#34;__codelineno-4-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// #include &amp;quot;ggml-quants.h&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-23&#34; name=&#34;__codelineno-4-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;cmath&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-24&#34; name=&#34;__codelineno-4-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;cstring&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-25&#34; name=&#34;__codelineno-4-25&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-26&#34; name=&#34;__codelineno-4-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#define QK_I2_S 128&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-27&#34; name=&#34;__codelineno-4-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#define QK_I2 128&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-28&#34; name=&#34;__codelineno-4-28&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-29&#34; name=&#34;__codelineno-4-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;immintrin.h&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-30&#34; name=&#34;__codelineno-4-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;cstdint&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-31&#34; name=&#34;__codelineno-4-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;cstdio&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-32&#34; name=&#34;__codelineno-4-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;iostream&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-33&#34; name=&#34;__codelineno-4-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// horizontally add 8 int32_t&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-34&#34; name=&#34;__codelineno-4-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kr&#34;&gt;inline&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hsum_i32_8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-35&#34; name=&#34;__codelineno-4-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kr&#34;&gt;__m128i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sum128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm_add_epi32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_castsi256_si128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_extractf128_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-36&#34; name=&#34;__codelineno-4-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kr&#34;&gt;__m128i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hi64&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm_unpackhi_epi64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sum128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sum128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-37&#34; name=&#34;__codelineno-4-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kr&#34;&gt;__m128i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sum64&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm_add_epi32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hi64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sum128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-38&#34; name=&#34;__codelineno-4-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kr&#34;&gt;__m128i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hi32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm_shuffle_epi32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sum64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_MM_SHUFFLE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-39&#34; name=&#34;__codelineno-4-39&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm_cvtsi128_si32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm_add_epi32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sum64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hi32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-40&#34; name=&#34;__codelineno-4-40&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-41&#34; name=&#34;__codelineno-4-41&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-42&#34; name=&#34;__codelineno-4-42&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-43&#34; name=&#34;__codelineno-4-43&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;print_m256i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-44&#34; name=&#34;__codelineno-4-44&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint8_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-45&#34; name=&#34;__codelineno-4-45&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_storeu_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-46&#34; name=&#34;__codelineno-4-46&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-47&#34; name=&#34;__codelineno-4-47&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;%02x &amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-48&#34; name=&#34;__codelineno-4-48&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;%&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;16&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-49&#34; name=&#34;__codelineno-4-49&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-50&#34; name=&#34;__codelineno-4-50&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-51&#34; name=&#34;__codelineno-4-51&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-52&#34; name=&#34;__codelineno-4-52&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// x 指向 2-bit 量化数据，y 指向 8-bit 数据。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-53&#34; name=&#34;__codelineno-4-53&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 数据被分成多个组，便于后面的 SIMD 并行处理。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-54&#34; name=&#34;__codelineno-4-54&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 主要变量：&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-55&#34; name=&#34;__codelineno-4-55&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// QK_I2_S 通常为 128，表示每组的元素数。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-56&#34; name=&#34;__codelineno-4-56&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// nb = n / QK_I2_S，组数。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-57&#34; name=&#34;__codelineno-4-57&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// group32_num = nb / 32，每 32 组为一大组。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-58&#34; name=&#34;__codelineno-4-58&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// la_num = nb % 32，剩余组数。&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-59&#34; name=&#34;__codelineno-4-59&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_vec_dot_i2_i8_s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;by&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nrc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-60&#34; name=&#34;__codelineno-4-60&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint8_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint8_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-61&#34; name=&#34;__codelineno-4-61&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int8_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int8_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-62&#34; name=&#34;__codelineno-4-62&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-63&#34; name=&#34;__codelineno-4-63&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QK_I2_S&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-64&#34; name=&#34;__codelineno-4-64&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group32_num&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-65&#34; name=&#34;__codelineno-4-65&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;la_num&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;%&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-66&#34; name=&#34;__codelineno-4-66&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;groupla_num&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;%&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-67&#34; name=&#34;__codelineno-4-67&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-68&#34; name=&#34;__codelineno-4-68&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// n : 128 nb : 1 group32_num : 0 la_num : 1 groupla_num : 1&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-69&#34; name=&#34;__codelineno-4-69&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cout&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;n : &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-70&#34; name=&#34;__codelineno-4-70&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot; nb : &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nb&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-71&#34; name=&#34;__codelineno-4-71&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot; group32_num : &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group32_num&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-72&#34; name=&#34;__codelineno-4-72&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot; la_num : &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;la_num&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-73&#34; name=&#34;__codelineno-4-73&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot; groupla_num : &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;groupla_num&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-74&#34; name=&#34;__codelineno-4-74&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-75&#34; name=&#34;__codelineno-4-75&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-76&#34; name=&#34;__codelineno-4-76&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_set1_epi8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x03&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-77&#34; name=&#34;__codelineno-4-77&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accu&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_setzero_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-78&#34; name=&#34;__codelineno-4-78&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-79&#34; name=&#34;__codelineno-4-79&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group32_num&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;){&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-80&#34; name=&#34;__codelineno-4-80&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cout&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;i : &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-81&#34; name=&#34;__codelineno-4-81&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accu32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_setzero_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-82&#34; name=&#34;__codelineno-4-82&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-83&#34; name=&#34;__codelineno-4-83&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 128 index&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-84&#34; name=&#34;__codelineno-4-84&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_loadu_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-85&#34; name=&#34;__codelineno-4-85&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_srli_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-86&#34; name=&#34;__codelineno-4-86&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_srli_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-87&#34; name=&#34;__codelineno-4-87&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_srli_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-88&#34; name=&#34;__codelineno-4-88&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-89&#34; name=&#34;__codelineno-4-89&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each 32 index&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-90&#34; name=&#34;__codelineno-4-90&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_and_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-91&#34; name=&#34;__codelineno-4-91&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_and_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-92&#34; name=&#34;__codelineno-4-92&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_and_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-93&#34; name=&#34;__codelineno-4-93&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_and_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-94&#34; name=&#34;__codelineno-4-94&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-95&#34; name=&#34;__codelineno-4-95&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each 32 index&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-96&#34; name=&#34;__codelineno-4-96&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_loadu_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-97&#34; name=&#34;__codelineno-4-97&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_loadu_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-98&#34; name=&#34;__codelineno-4-98&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_loadu_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-99&#34; name=&#34;__codelineno-4-99&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_loadu_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;96&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-100&#34; name=&#34;__codelineno-4-100&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-101&#34; name=&#34;__codelineno-4-101&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 128 index accumulation add&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-102&#34; name=&#34;__codelineno-4-102&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// split into 32 accumulation block&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-103&#34; name=&#34;__codelineno-4-103&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each block each 128 index accumulated 4index&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-104&#34; name=&#34;__codelineno-4-104&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each index maximum 256&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-105&#34; name=&#34;__codelineno-4-105&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each block maximum 4 * 256&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-106&#34; name=&#34;__codelineno-4-106&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each block accumulation maximum 127 * 256&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-107&#34; name=&#34;__codelineno-4-107&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each 32 group index (128 index in one group) needs cast to int32&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-108&#34; name=&#34;__codelineno-4-108&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_maddubs_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-109&#34; name=&#34;__codelineno-4-109&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_maddubs_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-110&#34; name=&#34;__codelineno-4-110&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_maddubs_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-111&#34; name=&#34;__codelineno-4-111&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_maddubs_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-112&#34; name=&#34;__codelineno-4-112&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-113&#34; name=&#34;__codelineno-4-113&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accu32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_add_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accu32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_add_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-114&#34; name=&#34;__codelineno-4-114&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accu32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_add_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accu32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_add_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-115&#34; name=&#34;__codelineno-4-115&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-116&#34; name=&#34;__codelineno-4-116&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accu&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_add_epi32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_madd_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accu32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_set1_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accu&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-117&#34; name=&#34;__codelineno-4-117&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-118&#34; name=&#34;__codelineno-4-118&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-119&#34; name=&#34;__codelineno-4-119&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;groupla_num&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;){&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-120&#34; name=&#34;__codelineno-4-120&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accula&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_setzero_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-121&#34; name=&#34;__codelineno-4-121&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;la_num&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-122&#34; name=&#34;__codelineno-4-122&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 128 index&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-123&#34; name=&#34;__codelineno-4-123&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 例子中的128个int2，分成4组，每组32个int2&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-124&#34; name=&#34;__codelineno-4-124&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 128个int2&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-125&#34; name=&#34;__codelineno-4-125&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// xx1 xx2 xx3 xx4 xx5 xx6 xx7 xx8 (int 16)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-126&#34; name=&#34;__codelineno-4-126&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 00  xx1 xx2 xx3 xx4 xx5 xx6 xx7 (shift right 2bit)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-127&#34; name=&#34;__codelineno-4-127&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 00  00  xx1 xx2 xx3 xx4 xx5 xx6 (shift right 4bit)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-128&#34; name=&#34;__codelineno-4-128&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 00  00  00  xx1 xx2 xx3 xx4 xx5 (shift right 6bit)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-129&#34; name=&#34;__codelineno-4-129&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_loadu_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group32_num&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-130&#34; name=&#34;__codelineno-4-130&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_srli_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-131&#34; name=&#34;__codelineno-4-131&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_srli_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-132&#34; name=&#34;__codelineno-4-132&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_srli_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-133&#34; name=&#34;__codelineno-4-133&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-134&#34; name=&#34;__codelineno-4-134&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each 32 index&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-135&#34; name=&#34;__codelineno-4-135&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// mask: 00000011 00000011&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-136&#34; name=&#34;__codelineno-4-136&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// --  --  --  xx4 -- -- -- xx8 (int 16)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-137&#34; name=&#34;__codelineno-4-137&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 00  --  --  xx3 -- -- -- xx7 (shift right 2bit)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-138&#34; name=&#34;__codelineno-4-138&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 00  00  --  xx2 -- -- -- xx6 (shift right 4bit)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-139&#34; name=&#34;__codelineno-4-139&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 00  00  00  xx1 -- -- -- xx5 (shift right 6bit)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-140&#34; name=&#34;__codelineno-4-140&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// int2通过移动bit位置和mask，拆分成了int8表示，就可以直接和int8进行运算了&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-141&#34; name=&#34;__codelineno-4-141&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_and_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-142&#34; name=&#34;__codelineno-4-142&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_and_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-143&#34; name=&#34;__codelineno-4-143&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_and_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-144&#34; name=&#34;__codelineno-4-144&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_and_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-145&#34; name=&#34;__codelineno-4-145&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-146&#34; name=&#34;__codelineno-4-146&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-147&#34; name=&#34;__codelineno-4-147&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;print_m256i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-148&#34; name=&#34;__codelineno-4-148&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;-----&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-149&#34; name=&#34;__codelineno-4-149&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;print_m256i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-150&#34; name=&#34;__codelineno-4-150&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;-----&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-151&#34; name=&#34;__codelineno-4-151&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;print_m256i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-152&#34; name=&#34;__codelineno-4-152&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;-----&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-153&#34; name=&#34;__codelineno-4-153&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;print_m256i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-154&#34; name=&#34;__codelineno-4-154&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;-----&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-155&#34; name=&#34;__codelineno-4-155&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-156&#34; name=&#34;__codelineno-4-156&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// x中的int2每间隔4个数字为一组&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-157&#34; name=&#34;__codelineno-4-157&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 03 03 03 03 03 03 03 03 03 03 03 03 03 03 03 03 &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-158&#34; name=&#34;__codelineno-4-158&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 03 03 03 03 03 03 03 03 03 03 03 03 03 03 03 03 &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-159&#34; name=&#34;__codelineno-4-159&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// -----&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-160&#34; name=&#34;__codelineno-4-160&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 02 02 02 02 02 02 02 02 02 02 02 02 02 02 02 02 &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-161&#34; name=&#34;__codelineno-4-161&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 02 02 02 02 02 02 02 02 02 02 02 02 02 02 02 02 &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-162&#34; name=&#34;__codelineno-4-162&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// -----&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-163&#34; name=&#34;__codelineno-4-163&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-164&#34; name=&#34;__codelineno-4-164&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-165&#34; name=&#34;__codelineno-4-165&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// -----&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-166&#34; name=&#34;__codelineno-4-166&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-167&#34; name=&#34;__codelineno-4-167&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-168&#34; name=&#34;__codelineno-4-168&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-169&#34; name=&#34;__codelineno-4-169&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-170&#34; name=&#34;__codelineno-4-170&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each 32 index&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-171&#34; name=&#34;__codelineno-4-171&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 例子中的128个int8数据，分成4组，每组32个int8数据&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-172&#34; name=&#34;__codelineno-4-172&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// xx1 xx2&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-173&#34; name=&#34;__codelineno-4-173&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_loadu_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group32_num&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-174&#34; name=&#34;__codelineno-4-174&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_loadu_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group32_num&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-175&#34; name=&#34;__codelineno-4-175&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_loadu_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group32_num&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-176&#34; name=&#34;__codelineno-4-176&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_loadu_si256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__m256i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group32_num&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;96&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-177&#34; name=&#34;__codelineno-4-177&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-178&#34; name=&#34;__codelineno-4-178&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;print_m256i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-179&#34; name=&#34;__codelineno-4-179&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;-----&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-180&#34; name=&#34;__codelineno-4-180&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;print_m256i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-181&#34; name=&#34;__codelineno-4-181&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;-----&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-182&#34; name=&#34;__codelineno-4-182&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;print_m256i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-183&#34; name=&#34;__codelineno-4-183&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;-----&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-184&#34; name=&#34;__codelineno-4-184&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;print_m256i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-185&#34; name=&#34;__codelineno-4-185&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-186&#34; name=&#34;__codelineno-4-186&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 按顺序存储，相邻的32个int8为一组&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-187&#34; name=&#34;__codelineno-4-187&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// -----&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-188&#34; name=&#34;__codelineno-4-188&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-189&#34; name=&#34;__codelineno-4-189&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 10 11 12 13 14 15 16 17 18 19 1a 1b 1c 1d 1e 1f &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-190&#34; name=&#34;__codelineno-4-190&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// -----&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-191&#34; name=&#34;__codelineno-4-191&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 20 21 22 23 24 25 26 27 28 29 2a 2b 2c 2d 2e 2f &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-192&#34; name=&#34;__codelineno-4-192&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 30 31 32 33 34 35 36 37 38 39 3a 3b 3c 3d 3e 3f &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-193&#34; name=&#34;__codelineno-4-193&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// -----&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-194&#34; name=&#34;__codelineno-4-194&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 40 41 42 43 44 45 46 47 48 49 4a 4b 4c 4d 4e 4f &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-195&#34; name=&#34;__codelineno-4-195&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 50 51 52 53 54 55 56 57 58 59 5a 5b 5c 5d 5e 5f &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-196&#34; name=&#34;__codelineno-4-196&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// -----&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-197&#34; name=&#34;__codelineno-4-197&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 60 61 62 63 64 65 66 67 68 69 6a 6b 6c 6d 6e 6f &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-198&#34; name=&#34;__codelineno-4-198&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 70 71 72 73 74 75 76 77 78 79 7a 7b 7c 7d 7e 7f&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-199&#34; name=&#34;__codelineno-4-199&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-200&#34; name=&#34;__codelineno-4-200&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-201&#34; name=&#34;__codelineno-4-201&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 128 index accumulation add&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-202&#34; name=&#34;__codelineno-4-202&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// split into 32 accumulation block&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-203&#34; name=&#34;__codelineno-4-203&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each block each 128 index accumulated 4index&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-204&#34; name=&#34;__codelineno-4-204&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each index maximum 256&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-205&#34; name=&#34;__codelineno-4-205&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each block maximum 4 * 256&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-206&#34; name=&#34;__codelineno-4-206&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each block accumulation maximum 127 * 256&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-207&#34; name=&#34;__codelineno-4-207&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// each 32 group index (128 index in one group) needs cast to int32&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-208&#34; name=&#34;__codelineno-4-208&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 乘加运算&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-209&#34; name=&#34;__codelineno-4-209&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// xx1, xx5 (16bit)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-210&#34; name=&#34;__codelineno-4-210&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// yy1, yy2 (16bit)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-211&#34; name=&#34;__codelineno-4-211&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// res = xx1 * yy1  + xx5 * yy2&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-212&#34; name=&#34;__codelineno-4-212&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_maddubs_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-213&#34; name=&#34;__codelineno-4-213&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_maddubs_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-214&#34; name=&#34;__codelineno-4-214&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_maddubs_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-215&#34; name=&#34;__codelineno-4-215&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_maddubs_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-216&#34; name=&#34;__codelineno-4-216&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-217&#34; name=&#34;__codelineno-4-217&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// printf(&amp;quot;-----\n&amp;quot;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-218&#34; name=&#34;__codelineno-4-218&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// print_m256i(xq8_3);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-219&#34; name=&#34;__codelineno-4-219&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// printf(&amp;quot;-----\n&amp;quot;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-220&#34; name=&#34;__codelineno-4-220&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// print_m256i(xq8_2);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-221&#34; name=&#34;__codelineno-4-221&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// printf(&amp;quot;-----\n&amp;quot;);、&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-222&#34; name=&#34;__codelineno-4-222&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 打印第1组乘加计算结果&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-223&#34; name=&#34;__codelineno-4-223&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;print_m256i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-224&#34; name=&#34;__codelineno-4-224&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;-----&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-225&#34; name=&#34;__codelineno-4-225&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// print_m256i(xq8_0);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-226&#34; name=&#34;__codelineno-4-226&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// printf(&amp;quot;-----\n&amp;quot;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-227&#34; name=&#34;__codelineno-4-227&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-228&#34; name=&#34;__codelineno-4-228&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-229&#34; name=&#34;__codelineno-4-229&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-230&#34; name=&#34;__codelineno-4-230&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-231&#34; name=&#34;__codelineno-4-231&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 乘加计算&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-232&#34; name=&#34;__codelineno-4-232&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 20 21 22 23 24 25 26 27 28 29 2a 2b 2c 2d 2e 2f &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-233&#34; name=&#34;__codelineno-4-233&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 30 31 32 33 34 35 36 37 38 39 3a 3b 3c 3d 3e 3f&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-234&#34; name=&#34;__codelineno-4-234&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 结果&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-235&#34; name=&#34;__codelineno-4-235&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 41 00 45 00 49 00 4d 00 51 00 55 00 59 00 5d 00 &lt;/span&gt;
&lt;a id=&#34;__codelineno-4-236&#34; name=&#34;__codelineno-4-236&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 61 00 65 00 69 00 6d 00 71 00 75 00 79 00 7d 00&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-237&#34; name=&#34;__codelineno-4-237&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-238&#34; name=&#34;__codelineno-4-238&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-239&#34; name=&#34;__codelineno-4-239&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accula&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_add_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accula&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_add_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-240&#34; name=&#34;__codelineno-4-240&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accula&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_add_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accula&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_add_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xq8_3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-241&#34; name=&#34;__codelineno-4-241&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-242&#34; name=&#34;__codelineno-4-242&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accu&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_add_epi32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accu&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_madd_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accula&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_mm256_set1_epi16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-243&#34; name=&#34;__codelineno-4-243&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-244&#34; name=&#34;__codelineno-4-244&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sumi&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hsum_i32_8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;accu&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-245&#34; name=&#34;__codelineno-4-245&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sumi&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-246&#34; name=&#34;__codelineno-4-246&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
测试代码：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-40&#34;&gt;40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-41&#34;&gt;41&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-42&#34;&gt;42&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-43&#34;&gt;43&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-44&#34;&gt;44&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-45&#34;&gt;45&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// g++ int2_int8.cpp  -mavx2&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// cat /proc/cpuinfo | grep avx&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-3&#34; name=&#34;__codelineno-5-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-4&#34; name=&#34;__codelineno-5-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-5&#34; name=&#34;__codelineno-5-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_debug&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-6&#34; name=&#34;__codelineno-5-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-7&#34; name=&#34;__codelineno-5-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 设定向量长度为128（一个block）&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-8&#34; name=&#34;__codelineno-5-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QK_I2_S&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-9&#34; name=&#34;__codelineno-5-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint8_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i2_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QK_I2_S&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 每4个2bit压缩成1字节，128个int2, 也就是_mm256_loadu_si256一次load256bit，要load 1次，一次load 128个int2数字，再通过偏移量分成32个int2一组，分成4组&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-10&#34; name=&#34;__codelineno-5-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int8_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i8_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QK_I2_S&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 128个int8，也就是_mm256_loadu_si256一次load256bit,要load 4次，每次load32个int8数字&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-11&#34; name=&#34;__codelineno-5-11&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-12&#34; name=&#34;__codelineno-5-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// _mm256_maddubs_epi16就可以一次计算32个int8数字和int2数字&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-13&#34; name=&#34;__codelineno-5-13&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-14&#34; name=&#34;__codelineno-5-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 构造简单数据：i2全部为1，i8全部为1&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-15&#34; name=&#34;__codelineno-5-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 2bit编码：2bit可表示4种状态（00, 01, 10, 11），若采用带符号整数表示，范围为-2到1；无符号整数范围为0到3&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-16&#34; name=&#34;__codelineno-5-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QK_I2_S&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-17&#34; name=&#34;__codelineno-5-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_debug&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;){&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-18&#34; name=&#34;__codelineno-5-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 每字节填充为 0x55 (01010101) 即每个2bit为&amp;quot;1&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-19&#34; name=&#34;__codelineno-5-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i2_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x55&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-20&#34; name=&#34;__codelineno-5-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-21&#34; name=&#34;__codelineno-5-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 00 01 10 11&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-22&#34; name=&#34;__codelineno-5-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i2_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x1B&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-23&#34; name=&#34;__codelineno-5-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-24&#34; name=&#34;__codelineno-5-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-25&#34; name=&#34;__codelineno-5-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QK_I2_S&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-26&#34; name=&#34;__codelineno-5-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_debug&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;){&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-27&#34; name=&#34;__codelineno-5-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i8_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-28&#34; name=&#34;__codelineno-5-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-29&#34; name=&#34;__codelineno-5-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i8_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-30&#34; name=&#34;__codelineno-5-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-31&#34; name=&#34;__codelineno-5-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-32&#34; name=&#34;__codelineno-5-32&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-33&#34; name=&#34;__codelineno-5-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;float&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mf&#34;&gt;0.0f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-34&#34; name=&#34;__codelineno-5-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ggml_vec_dot_i2_i8_s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i2_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i8_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-35&#34; name=&#34;__codelineno-5-35&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-36&#34; name=&#34;__codelineno-5-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cout&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;测试结果: &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-37&#34; name=&#34;__codelineno-5-37&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-38&#34; name=&#34;__codelineno-5-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 理论上，如果i2都解码为1，i8都为1，点积应为128&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-39&#34; name=&#34;__codelineno-5-39&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mf&#34;&gt;128.0f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-40&#34; name=&#34;__codelineno-5-40&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cout&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;通过&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-41&#34; name=&#34;__codelineno-5-41&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-42&#34; name=&#34;__codelineno-5-42&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cout&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;未通过&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-43&#34; name=&#34;__codelineno-5-43&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-44&#34; name=&#34;__codelineno-5-44&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-45&#34; name=&#34;__codelineno-5-45&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;代码似乎没有完全开源，比如没有在代码中看到如下内容：
+ T-MAC的实现和应用？
+ ggml_vec_dot_i2_i8_s如何被调用上的？&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c20如何实现一个基于属性测试的quickcheck-cpp库/&#34; target=&#34;_blank&#34;&gt;C++20如何实现一个基于属性测试的quickcheck-cpp库&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c使用abseil-cpp遇到的小问题/&#34; target=&#34;_blank&#34;&gt;C++使用abseil-cpp遇到的小问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/bitnet%E4%B8%ADint2%E5%92%8Cint8%E7%9A%84%E4%BD%BF%E7%94%A8/</link>
      <pubDate>Sun, 24 Aug 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/bitnet%E4%B8%ADint2%E5%92%8Cint8%E7%9A%84%E4%BD%BF%E7%94%A8/</guid>
      
    </item>
    
    <item>
      <title>两种不同设计理念的解析库nom和pest</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;!-- more --&gt;

&lt;h2 id=&#34;nom和pest解析库设计&#34;&gt;nom和pest解析库设计&lt;a class=&#34;headerlink&#34; href=&#34;#nom和pest解析库设计&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;nom 和 pest时Rust 生态中两个主流的解析库，但是设计理念和使用方式有显著差异。&lt;/p&gt;
&lt;h3 id=&#34;-nom库解析器组合库&#34;&gt;🔧 nom库：解析器组合库&lt;a class=&#34;headerlink&#34; href=&#34;#-nom库解析器组合库&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;基于‌解析器组合器‌（Parser Combinators）模式，通过组合小型解析器构建复杂逻辑。
支持‌零拷贝解析‌，直接操作输入数据切片，高效处理二进制或文本。&lt;/p&gt;
&lt;p&gt;适用于网络协议解析（HTTP、WebSocket）、自定义二进制格式（如文件头、数据包）
高性能文本处理（CSV、日志）。&lt;/p&gt;
&lt;p&gt;对于解析一个cvs文件，首先要使用nom提供的小型解析器，定义如何解析一个field,然后如何解析&amp;rdquo;,&amp;rdquo;号分隔，然后定义如何解析一行，最后定义如何解析一个csv文件。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 解析未加引号的字段&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;parse_unquoted_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;IResult&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;escaped_transform&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alphanumeric1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;sc&#34;&gt;&amp;#39;\\&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;one_of&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\&amp;quot;&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;bfnrt&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\\&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parse&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-4&#34; name=&#34;__codelineno-0-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-5&#34; name=&#34;__codelineno-0-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-6&#34; name=&#34;__codelineno-0-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 单个字段解析&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-7&#34; name=&#34;__codelineno-0-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;parse_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;IResult&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-8&#34; name=&#34;__codelineno-0-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parse_unquoted_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parse&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-9&#34; name=&#34;__codelineno-0-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-10&#34; name=&#34;__codelineno-0-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-11&#34; name=&#34;__codelineno-0-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 解析单行CSV数据&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-12&#34; name=&#34;__codelineno-0-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;parse_line&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;IResult&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Vec&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-13&#34; name=&#34;__codelineno-0-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-14&#34; name=&#34;__codelineno-0-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 正常行解析（以换行符结束）&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-15&#34; name=&#34;__codelineno-0-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;terminated&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-16&#34; name=&#34;__codelineno-0-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;separated_list0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;sc&#34;&gt;&amp;#39;,&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parse_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-17&#34; name=&#34;__codelineno-0-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tag&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\r\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tag&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;eof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)),&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-18&#34; name=&#34;__codelineno-0-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-19&#34; name=&#34;__codelineno-0-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 处理空行&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-20&#34; name=&#34;__codelineno-0-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tag&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\r\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tag&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;fm&#34;&gt;vec!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[]),&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-21&#34; name=&#34;__codelineno-0-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-22&#34; name=&#34;__codelineno-0-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parse&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-23&#34; name=&#34;__codelineno-0-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-24&#34; name=&#34;__codelineno-0-24&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-25&#34; name=&#34;__codelineno-0-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-0-26&#34; name=&#34;__codelineno-0-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;csv_line&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;r#&amp;quot;2,Escapedquote,314\r\n&amp;quot;#&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-27&#34; name=&#34;__codelineno-0-27&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-28&#34; name=&#34;__codelineno-0-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parse_line&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;csv_line&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-29&#34; name=&#34;__codelineno-0-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-30&#34; name=&#34;__codelineno-0-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;row&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;in&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-31&#34; name=&#34;__codelineno-0-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;fm&#34;&gt;println!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;{:?}&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;row&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-32&#34; name=&#34;__codelineno-0-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-33&#34; name=&#34;__codelineno-0-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-34&#34; name=&#34;__codelineno-0-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;fm&#34;&gt;println!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Parse error: {:?}&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-35&#34; name=&#34;__codelineno-0-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-36&#34; name=&#34;__codelineno-0-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;-pest基于-peg-的解析器生成器&#34;&gt;📝 pest：基于 PEG 的解析器生成器&lt;a class=&#34;headerlink&#34; href=&#34;#-pest基于-peg-的解析器生成器&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;使用‌解析表达式文法‌（Parsing Expression Grammar, PEG）定义语法规则。
语法规则与 Rust 代码分离（.pest 文件），提升可读性。&lt;/p&gt;
&lt;p&gt;适用于编程语言解析（自定义 DSL），复杂文本格式（配置文件、模板引擎），需要严格语法定义的场景（如编译器前端）。&lt;/p&gt;
&lt;p&gt;比如解析一个csv文件：
&lt;a href=&#34;https://pest.rs/book/examples/csv.html&#34;&gt;pest csv&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;定义一个.pest文件描述语法的规则
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nv&#34;&gt;field&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;ASCII_DIGIT&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;.&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;-&amp;quot;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;+&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nv&#34;&gt;record&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;field&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;~&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;,&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;~&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;field&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;*&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nv&#34;&gt;file&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;SOI&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;~&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;record&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;~&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;\r\n&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;\n&amp;quot;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;))&lt;/span&gt;*&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;~&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;EOI&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h2 id=&#34;选择&#34;&gt;选择&lt;a class=&#34;headerlink&#34; href=&#34;#选择&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;以解析json为例，nom的性能相比pest的更高一些。&lt;/p&gt;
&lt;pre class=&#34;mermaid&#34;&gt;&lt;code&gt;graph TD     
    A[需解析什么数据?] --&amp;gt;|二进制/高性能| B(nom)     
    A --&amp;gt;|严格语法/DSL| C(pest)     
    B --&amp;gt; D{需要动态调整解析逻辑?}     
    D --&amp;gt;|是| E[选择nom+自定义组合器]     
    D --&amp;gt;|否| F[直接使用nom内置组合器]     
    C --&amp;gt; G{是否需要IDE工具支持?}     
    G --&amp;gt;|是| H[选择pest+语法高亮插件]     
    G --&amp;gt;|否| I[纯pest规则文件]&lt;/code&gt;&lt;/pre&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/pyo3实现python和rust跨语言调用/&#34; target=&#34;_blank&#34;&gt;pyo3实现python和rust跨语言调用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/使用aya和c混合编写uprobe程序/&#34; target=&#34;_blank&#34;&gt;使用aya和c混合编写uprobe程序&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c使用abseil-cpp遇到的小问题/&#34; target=&#34;_blank&#34;&gt;C++使用abseil-cpp遇到的小问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/%E4%B8%A4%E7%A7%8D%E4%B8%8D%E5%90%8C%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5%E7%9A%84%E8%A7%A3%E6%9E%90%E5%BA%93nom%E5%92%8Cpest/</link>
      <pubDate>Sun, 10 Aug 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/%E4%B8%A4%E7%A7%8D%E4%B8%8D%E5%90%8C%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5%E7%9A%84%E8%A7%A3%E6%9E%90%E5%BA%93nom%E5%92%8Cpest/</guid>
      
    </item>
    
    <item>
      <title>C++如何实现一个支持动态、静态插件的系统</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;!-- more --&gt;

&lt;h2 id=&#34;引言&#34;&gt;引言&lt;a class=&#34;headerlink&#34; href=&#34;#引言&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;通过&lt;a href=&#34;https://github.com/ai-dynamo/nixl&#34;&gt;英伟达推理传输库（NIXL）&lt;/a&gt;学习C++如何实现一个支持动态、静态插件注册和管理！&lt;/p&gt;
&lt;p&gt;NIXL是一个开源项目，英伟达推理传输库（NIXL）旨在加速诸如英伟达Dynamo等人工智能推理框架中的点对点通信，同时通过模块化插件架构，为各种类型的内存（如CPU和GPU）和存储（如文件、块存储和对象存储）提供抽象。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;支持Python、Rust语言绑定。python采用pybind11实现，Rust采用bindgen实现。&lt;/li&gt;
&lt;li&gt;采用meson构建系统进行构建。&lt;/li&gt;
&lt;li&gt;采用插件机制，区分了动态插件（dlsym动态库加载）和静态插件（编译时链接）。&lt;/li&gt;
&lt;li&gt;接口api实现清晰，接口和实现分离，方便进行跨语言FFI绑定。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;c插件系统接口和管理&#34;&gt;C++插件系统接口和管理&lt;a class=&#34;headerlink&#34; href=&#34;#c插件系统接口和管理&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;一个插件系统需要如何考虑接口实现呢？需要包括哪些信息？&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;插件版本定义，在插件加载时可以对插件版本进行校验，确保插件和主程序兼容。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;通过 &lt;strong&gt;attribute&lt;/strong&gt;((visibility(&amp;ldquo;default&amp;rdquo;))) 导出接口函数，使得动态库加载时可以找到这些函数。显式声明需要对外暴露的接口，避免默认导出所有符号，确保关键函数或变量可被外部链接。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;插件接口定义&#34;&gt;插件接口定义&lt;a class=&#34;headerlink&#34; href=&#34;#插件接口定义&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;在一个api接口头文件中定义插件接口，包括插件版本、插件名称、插件初始化、插件销毁等函数。在项目的组织结构中，可以专门放到一个api目录下。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-40&#34;&gt;40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-41&#34;&gt;41&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-42&#34;&gt;42&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-43&#34;&gt;43&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;quot;backend/backend_engine.h&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Define the plugin API version&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-4&#34; name=&#34;__codelineno-0-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#define NIXL_PLUGIN_API_VERSION 1&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-5&#34; name=&#34;__codelineno-0-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-6&#34; name=&#34;__codelineno-0-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Define the plugin interface class&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-7&#34; name=&#34;__codelineno-0-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-8&#34; name=&#34;__codelineno-0-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;public&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-9&#34; name=&#34;__codelineno-0-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;api_version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-10&#34; name=&#34;__codelineno-0-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-11&#34; name=&#34;__codelineno-0-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Function pointer for creating a new backend engine instance&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-12&#34; name=&#34;__codelineno-0-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendEngine&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;create_engine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendInitParams&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;init_params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-13&#34; name=&#34;__codelineno-0-13&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-14&#34; name=&#34;__codelineno-0-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Function pointer for destroying a backend engine instance&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-15&#34; name=&#34;__codelineno-0-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;destroy_engine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendEngine&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;engine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-16&#34; name=&#34;__codelineno-0-16&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-17&#34; name=&#34;__codelineno-0-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Function to get the plugin name&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-18&#34; name=&#34;__codelineno-0-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_plugin_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)();&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-19&#34; name=&#34;__codelineno-0-19&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-20&#34; name=&#34;__codelineno-0-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Function to get the plugin version&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-21&#34; name=&#34;__codelineno-0-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_plugin_version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)();&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-22&#34; name=&#34;__codelineno-0-22&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-23&#34; name=&#34;__codelineno-0-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Function to get backend options&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-24&#34; name=&#34;__codelineno-0-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixl_b_params_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_backend_options&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)();&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-25&#34; name=&#34;__codelineno-0-25&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-26&#34; name=&#34;__codelineno-0-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Function to get supported backend mem types&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-27&#34; name=&#34;__codelineno-0-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixl_mem_list_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_backend_mems&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)();&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-28&#34; name=&#34;__codelineno-0-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-29&#34; name=&#34;__codelineno-0-29&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-30&#34; name=&#34;__codelineno-0-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Macro to define exported C functions for the plugin&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-31&#34; name=&#34;__codelineno-0-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#define NIXL_PLUGIN_EXPORT __attribute__((visibility(&amp;quot;default&amp;quot;)))&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-32&#34; name=&#34;__codelineno-0-32&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-33&#34; name=&#34;__codelineno-0-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Creator Function type for static plugins&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-34&#34; name=&#34;__codelineno-0-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;typedef&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlStaticPluginCreatorFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)();&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-35&#34; name=&#34;__codelineno-0-35&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-36&#34; name=&#34;__codelineno-0-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Plugin must implement these functions for dynamic loading&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-37&#34; name=&#34;__codelineno-0-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;extern&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;C&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-38&#34; name=&#34;__codelineno-0-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Initialize the plugin&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-39&#34; name=&#34;__codelineno-0-39&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NIXL_PLUGIN_EXPORT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixl_plugin_init&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-40&#34; name=&#34;__codelineno-0-40&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-41&#34; name=&#34;__codelineno-0-41&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Cleanup the plugin&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-42&#34; name=&#34;__codelineno-0-42&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NIXL_PLUGIN_EXPORT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixl_plugin_fini&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-43&#34; name=&#34;__codelineno-0-43&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;插件管理器&#34;&gt;插件管理器&lt;a class=&#34;headerlink&#34; href=&#34;#插件管理器&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;通过一个单例，进行插件管理。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;nixlPluginManager&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;nixlPluginManager::getInstance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Meyers singleton initialization is safe in multi-threaded environment.&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Consult standard [stmt.dcl] chapter for details.&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-4&#34; name=&#34;__codelineno-1-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlPluginManager&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-5&#34; name=&#34;__codelineno-1-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-6&#34; name=&#34;__codelineno-1-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
看一下nixlPluginManager的成员变量定义：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-9&#34;&gt;9&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;using&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixl_backend_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;nixlPluginManager&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-4&#34; name=&#34;__codelineno-2-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;private&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-5&#34; name=&#34;__codelineno-2-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixl_backend_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shared_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlPluginHandle&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loaded_plugins_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 同时保存了注册的动态插件和静态插件信息&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-6&#34; name=&#34;__codelineno-2-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vector&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin_dirs_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 保存插件搜索路径&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-7&#34; name=&#34;__codelineno-2-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vector&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlStaticPluginInfo&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;static_plugins_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 保存有静态插件的信息，方便在unload时进行过滤静态插件，因为静态插件不需要dlclose。&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-8&#34; name=&#34;__codelineno-2-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ......&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-9&#34; name=&#34;__codelineno-2-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;维护插件信息&#34;&gt;维护插件信息&lt;a class=&#34;headerlink&#34; href=&#34;#维护插件信息&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;nixlPluginHandle同时支持保存动态插件和静态插件的信息。nixlPluginHandle结构只在构造和析构时修改，在查询和插件实例化时只读。因此可以在多线程中安全使用，不需要加锁。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;nixlPluginHandle&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;private&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Handle to the dynamically loaded library&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Plugin interface&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-5&#34; name=&#34;__codelineno-3-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-6&#34; name=&#34;__codelineno-3-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;public&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-7&#34; name=&#34;__codelineno-3-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlPluginHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-8&#34; name=&#34;__codelineno-3-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlPluginHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-9&#34; name=&#34;__codelineno-3-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-10&#34; name=&#34;__codelineno-3-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendEngine&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;createEngine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendInitParams&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;init_params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-11&#34; name=&#34;__codelineno-3-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;destroyEngine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendEngine&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;engine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-12&#34; name=&#34;__codelineno-3-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;getName&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-13&#34; name=&#34;__codelineno-3-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;getVersion&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-14&#34; name=&#34;__codelineno-3-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixl_b_params_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;getBackendOptions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-15&#34; name=&#34;__codelineno-3-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixl_mem_list_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;getBackendMems&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-16&#34; name=&#34;__codelineno-3-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h2 id=&#34;静态插件和动态插件注册&#34;&gt;静态插件和动态插件注册&lt;a class=&#34;headerlink&#34; href=&#34;#静态插件和动态插件注册&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&#34;静态插件&#34;&gt;静态插件&lt;a class=&#34;headerlink&#34; href=&#34;#静态插件&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-9&#34;&gt;9&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Creator Function for static plugins&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;typedef&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlStaticPluginCreatorFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)();&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-3&#34; name=&#34;__codelineno-4-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-4&#34; name=&#34;__codelineno-4-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-5&#34; name=&#34;__codelineno-4-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Structure to hold static plugin info&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-6&#34; name=&#34;__codelineno-4-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;nixlStaticPluginInfo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-7&#34; name=&#34;__codelineno-4-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-8&#34; name=&#34;__codelineno-4-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlStaticPluginCreatorFunc&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;createFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-9&#34; name=&#34;__codelineno-4-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;注册静态插件: 静态插件只需要保存一个name和createFunc，并且在注册时，执行createFunc进行实例化（一个静态全局实例）。然后将nixlBackendPlugin*信息保存到loaded_plugins_的map中。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;nixlPluginManager::registerStaticPlugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlStaticPluginCreatorFunc&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;creator&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lock_guard&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-3&#34; name=&#34;__codelineno-5-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-4&#34; name=&#34;__codelineno-5-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlStaticPluginInfo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-5&#34; name=&#34;__codelineno-5-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-6&#34; name=&#34;__codelineno-5-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;createFunc&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;creator&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-7&#34; name=&#34;__codelineno-5-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;static_plugins_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;push_back&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-8&#34; name=&#34;__codelineno-5-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-9&#34; name=&#34;__codelineno-5-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;//Static Plugins are considered pre-loaded&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-10&#34; name=&#34;__codelineno-5-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;createFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-11&#34; name=&#34;__codelineno-5-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NIXL_INFO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Loading static plugin: &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-12&#34; name=&#34;__codelineno-5-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-13&#34; name=&#34;__codelineno-5-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Register the loaded plugin&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-14&#34; name=&#34;__codelineno-5-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin_handle&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_shared&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlPluginHandle&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-15&#34; name=&#34;__codelineno-5-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loaded_plugins_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-16&#34; name=&#34;__codelineno-5-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-17&#34; name=&#34;__codelineno-5-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;静态插件不需要unload, 相比动态插件需要dlclose。&lt;/p&gt;
&lt;p&gt;在编译时，决定是否注册静态插件。createStaticPosixPlugin函数在插件模块中实现（后面实现环节有介绍），这里通过宏控制是否注册静态插件。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#ifdef STATIC_PLUGIN_POSIX&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-2&#34; name=&#34;__codelineno-6-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;extern&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;createStaticPosixPlugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-3&#34; name=&#34;__codelineno-6-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;registerStaticPlugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;POSIX&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;createStaticPosixPlugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-4&#34; name=&#34;__codelineno-6-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#endif &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// STATIC_PLUGIN_POSIX&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-5&#34; name=&#34;__codelineno-6-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-6-6&#34; name=&#34;__codelineno-6-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#ifdef STATIC_PLUGIN_GDS&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-7&#34; name=&#34;__codelineno-6-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#ifndef DISABLE_GDS_BACKEND&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-8&#34; name=&#34;__codelineno-6-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;extern&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;createStaticGdsPlugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-9&#34; name=&#34;__codelineno-6-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;registerStaticPlugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;GDS&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;createStaticGdsPlugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-10&#34; name=&#34;__codelineno-6-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#endif &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// DISABLE_GDS_BACKEND&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-11&#34; name=&#34;__codelineno-6-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#endif &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// STATIC_PLUGIN_GDS&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;动态插件加载&#34;&gt;动态插件加载&lt;a class=&#34;headerlink&#34; href=&#34;#动态插件加载&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;通过一个void *handle，保存动态库的句柄。&lt;/p&gt;
&lt;p&gt;支持设置插件搜索路径，并加载插件。在加载插件时，先根据插件名称校验是否已经为静态插件，即已经preload，可以直接返回静态插件的handle。&lt;/p&gt;
&lt;p&gt;在插件加载时，会进行插件版本校验。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-7-1&#34; name=&#34;__codelineno-7-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shared_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlPluginHandle&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlPluginManager&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loadPluginFromPath&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin_path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-2&#34; name=&#34;__codelineno-7-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Open the plugin file&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-3&#34; name=&#34;__codelineno-7-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dlopen&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin_path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RTLD_NOW&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RTLD_LOCAL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-4&#34; name=&#34;__codelineno-7-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-5&#34; name=&#34;__codelineno-7-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NIXL_ERROR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Failed to load plugin from &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin_path&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;: &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dlerror&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-6&#34; name=&#34;__codelineno-7-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-7&#34; name=&#34;__codelineno-7-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-8&#34; name=&#34;__codelineno-7-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-9&#34; name=&#34;__codelineno-7-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Get the initialization function&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-10&#34; name=&#34;__codelineno-7-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typedef&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;init_func_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)();&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-11&#34; name=&#34;__codelineno-7-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;init_func_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;init&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;init_func_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dlsym&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;nixl_plugin_init&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-12&#34; name=&#34;__codelineno-7-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;init&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-13&#34; name=&#34;__codelineno-7-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NIXL_ERROR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Failed to find nixl_plugin_init in &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin_path&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;: &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dlerror&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-14&#34; name=&#34;__codelineno-7-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dlclose&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-15&#34; name=&#34;__codelineno-7-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-16&#34; name=&#34;__codelineno-7-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-17&#34; name=&#34;__codelineno-7-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-18&#34; name=&#34;__codelineno-7-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Call the initialization function&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-19&#34; name=&#34;__codelineno-7-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;init&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-20&#34; name=&#34;__codelineno-7-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-21&#34; name=&#34;__codelineno-7-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NIXL_ERROR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Plugin initialization failed for &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin_path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-22&#34; name=&#34;__codelineno-7-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dlclose&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-23&#34; name=&#34;__codelineno-7-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-24&#34; name=&#34;__codelineno-7-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-25&#34; name=&#34;__codelineno-7-25&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-26&#34; name=&#34;__codelineno-7-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Check API version&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-27&#34; name=&#34;__codelineno-7-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;api_version&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NIXL_PLUGIN_API_VERSION&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-28&#34; name=&#34;__codelineno-7-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NIXL_ERROR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Plugin API version mismatch for &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin_path&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-29&#34; name=&#34;__codelineno-7-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                   &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;: expected &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NIXL_PLUGIN_API_VERSION&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-30&#34; name=&#34;__codelineno-7-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                   &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;, got &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;api_version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-31&#34; name=&#34;__codelineno-7-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dlclose&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-32&#34; name=&#34;__codelineno-7-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-33&#34; name=&#34;__codelineno-7-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-34&#34; name=&#34;__codelineno-7-34&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-35&#34; name=&#34;__codelineno-7-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Create and store the plugin handle&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-36&#34; name=&#34;__codelineno-7-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin_handle&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_shared&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlPluginHandle&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-37&#34; name=&#34;__codelineno-7-37&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-38&#34; name=&#34;__codelineno-7-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-39&#34; name=&#34;__codelineno-7-39&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;介绍到现在，一个插件的框架已经搭建好了。支持插件管理、插件接口定义、动态和静态插件加载。
接下来，就是根据插件接口，实现具体的插件。如何实现支持动态加载的插件和静态插件。&lt;/p&gt;
&lt;h2 id=&#34;如何实现插件plugin&#34;&gt;如何实现插件Plugin&lt;a class=&#34;headerlink&#34; href=&#34;#如何实现插件plugin&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;实现插件只需要导入头文件，并实现插件接口。保证了插件接口的统一性，结构组织的清晰。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-8-1&#34; name=&#34;__codelineno-8-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;quot;backend/backend_plugin.h&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
这个Posix是英伟达推理传输库（NIXL）中其中一个插件实现，其他插件还包括了hf3fs、mooncake、cuda_gds等。看一下如何实现一个Posix插件，下面是对插件接口函数的实现：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-9-1&#34; name=&#34;__codelineno-9-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Function to create a new POSIX backend engine instance&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-2&#34; name=&#34;__codelineno-9-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendEngine&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;create_posix_engine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendInitParams&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;init_params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-3&#34; name=&#34;__codelineno-9-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlPosixEngine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;init_params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-4&#34; name=&#34;__codelineno-9-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-5&#34; name=&#34;__codelineno-9-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-6&#34; name=&#34;__codelineno-9-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 资源的正确释放&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-7&#34; name=&#34;__codelineno-9-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;destroy_posix_engine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendEngine&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;engine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-8&#34; name=&#34;__codelineno-9-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;delete&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;engine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-9&#34; name=&#34;__codelineno-9-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-10&#34; name=&#34;__codelineno-9-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-11&#34; name=&#34;__codelineno-9-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Function to get the plugin name，插件名称&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-12&#34; name=&#34;__codelineno-9-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;get_plugin_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-13&#34; name=&#34;__codelineno-9-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;POSIX&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-14&#34; name=&#34;__codelineno-9-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-15&#34; name=&#34;__codelineno-9-15&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-16&#34; name=&#34;__codelineno-9-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Function to get the plugin version，插件版本&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-17&#34; name=&#34;__codelineno-9-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;get_plugin_version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-18&#34; name=&#34;__codelineno-9-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;0.1.0&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-19&#34; name=&#34;__codelineno-9-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-20&#34; name=&#34;__codelineno-9-20&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-21&#34; name=&#34;__codelineno-9-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Function to get backend options&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-22&#34; name=&#34;__codelineno-9-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixl_b_params_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;get_backend_options&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-23&#34; name=&#34;__codelineno-9-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixl_b_params_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-24&#34; name=&#34;__codelineno-9-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-25&#34; name=&#34;__codelineno-9-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-26&#34; name=&#34;__codelineno-9-26&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-27&#34; name=&#34;__codelineno-9-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Function to get supported backend mem types&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-28&#34; name=&#34;__codelineno-9-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixl_mem_list_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;get_backend_mems&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-29&#34; name=&#34;__codelineno-9-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DRAM_SEG&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;FILE_SEG&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-30&#34; name=&#34;__codelineno-9-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;静态插件和动态插件实现的区别：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;静态插件在编译时，通过宏控制是否注册静态插件，在程序编译时，根据宏定义，决定是否调用createStaticPosixPlugin函数。将静态全局变量nixlBackendPlugin*信息保存到loaded_plugins_的map中。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;动态插件在运行时，通过dlopen加载动态库，并调用nixl_plugin_init函数，初始化插件。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-40&#34;&gt;40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-41&#34;&gt;41&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-10-1&#34; name=&#34;__codelineno-10-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#ifdef STATIC_PLUGIN_POSIX&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-2&#34; name=&#34;__codelineno-10-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-10-3&#34; name=&#34;__codelineno-10-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 通过静态全局变量，注册静态插件实例，在程序编译时，根据宏定义，决定是否调用createStaticPosixPlugin函数&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-4&#34; name=&#34;__codelineno-10-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 决定是否注册静态插件&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-5&#34; name=&#34;__codelineno-10-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Static plugin structure&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-6&#34; name=&#34;__codelineno-10-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-7&#34; name=&#34;__codelineno-10-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NIXL_PLUGIN_API_VERSION&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-8&#34; name=&#34;__codelineno-10-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;create_posix_engine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-9&#34; name=&#34;__codelineno-10-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;destroy_posix_engine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-10&#34; name=&#34;__codelineno-10-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_plugin_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-11&#34; name=&#34;__codelineno-10-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_plugin_version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-12&#34; name=&#34;__codelineno-10-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_backend_options&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-13&#34; name=&#34;__codelineno-10-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_backend_mems&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-14&#34; name=&#34;__codelineno-10-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-15&#34; name=&#34;__codelineno-10-15&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-10-16&#34; name=&#34;__codelineno-10-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;createStaticPosixPlugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-17&#34; name=&#34;__codelineno-10-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Return the static plugin instance&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-18&#34; name=&#34;__codelineno-10-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-19&#34; name=&#34;__codelineno-10-19&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-10-20&#34; name=&#34;__codelineno-10-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#else&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-21&#34; name=&#34;__codelineno-10-21&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-10-22&#34; name=&#34;__codelineno-10-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Plugin initialization function&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-23&#34; name=&#34;__codelineno-10-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;extern&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;C&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NIXL_PLUGIN_EXPORT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixl_plugin_init&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-24&#34; name=&#34;__codelineno-10-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;try&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-25&#34; name=&#34;__codelineno-10-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_unique&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixlBackendPlugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-26&#34; name=&#34;__codelineno-10-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;create_engine&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;create_posix_engine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-27&#34; name=&#34;__codelineno-10-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;destroy_engine&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;destroy_posix_engine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-28&#34; name=&#34;__codelineno-10-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_plugin_name&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_plugin_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-29&#34; name=&#34;__codelineno-10-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_plugin_version&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_plugin_version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-30&#34; name=&#34;__codelineno-10-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_backend_options&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_backend_options&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-31&#34; name=&#34;__codelineno-10-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_backend_mems&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_backend_mems&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-32&#34; name=&#34;__codelineno-10-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;api_version&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NIXL_PLUGIN_API_VERSION&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Set the API version&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-33&#34; name=&#34;__codelineno-10-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plugin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;release&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-34&#34; name=&#34;__codelineno-10-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;catch&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;exception&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-35&#34; name=&#34;__codelineno-10-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-36&#34; name=&#34;__codelineno-10-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-37&#34; name=&#34;__codelineno-10-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-38&#34; name=&#34;__codelineno-10-38&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-10-39&#34; name=&#34;__codelineno-10-39&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Plugin cleanup function&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-40&#34; name=&#34;__codelineno-10-40&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;extern&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;C&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NIXL_PLUGIN_EXPORT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nixl_plugin_fini&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-41&#34; name=&#34;__codelineno-10-41&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;感谢您的阅读，今天的内容就到这里了。通过本文我们了解了c++项目NIXL插件框架的设计和实现，以及如何实现一个插件。&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c使用abseil-cpp遇到的小问题/&#34; target=&#34;_blank&#34;&gt;C++使用abseil-cpp遇到的小问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c技法如何为一个类动态附加任意类型数据/&#34; target=&#34;_blank&#34;&gt;C++技法：如何为一个类动态附加任意类型数据&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/c%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%94%AF%E6%8C%81%E5%8A%A8%E6%80%81%E9%9D%99%E6%80%81%E6%8F%92%E4%BB%B6%E7%9A%84%E7%B3%BB%E7%BB%9F/</link>
      <pubDate>Sun, 03 Aug 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/c%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%94%AF%E6%8C%81%E5%8A%A8%E6%80%81%E9%9D%99%E6%80%81%E6%8F%92%E4%BB%B6%E7%9A%84%E7%B3%BB%E7%BB%9F/</guid>
      
    </item>
    
    <item>
      <title>rust-facet库如何实现运行时反射</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;!-- more --&gt;

&lt;h2 id=&#34;从facet-反射实现&#34;&gt;从facet 反射实现&lt;a class=&#34;headerlink&#34; href=&#34;#从facet-反射实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&#34;从例子看facet反射的两大功能&#34;&gt;从例子看facet反射的两大功能&lt;a class=&#34;headerlink&#34; href=&#34;#从例子看facet反射的两大功能&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;为序列化和反序列化，比如json、yaml服务。&lt;/p&gt;
&lt;h4 id=&#34;partial功能介绍&#34;&gt;Partial功能介绍&lt;a class=&#34;headerlink&#34; href=&#34;#partial功能介绍&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;用于构建值，可以用于根据json、yaml等格式，反序列化构建rust类型以及设置成员的值。先通过Partial::alloc分配关于类型Outer的未初始化内存，然后通过.begin_field(&amp;ldquo;name&amp;rdquo;).set(String::from(&amp;ldquo;Hello, world!&amp;rdquo;))为成员name设置值。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#[derive(Facet, PartialEq, Eq, Debug)]&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Outer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-4&#34; name=&#34;__codelineno-0-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inner&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Inner&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-5&#34; name=&#34;__codelineno-0-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-6&#34; name=&#34;__codelineno-0-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-7&#34; name=&#34;__codelineno-0-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#[derive(Facet, PartialEq, Eq, Debug)]&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-8&#34; name=&#34;__codelineno-0-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Inner&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-9&#34; name=&#34;__codelineno-0-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;i32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-10&#34; name=&#34;__codelineno-0-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;i32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-11&#34; name=&#34;__codelineno-0-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-12&#34; name=&#34;__codelineno-0-12&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-13&#34; name=&#34;__codelineno-0-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#[test]&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-14&#34; name=&#34;__codelineno-0-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;wip_struct_testleak1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-15&#34; name=&#34;__codelineno-0-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Partial&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Outer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-16&#34; name=&#34;__codelineno-0-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;begin_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-17&#34; name=&#34;__codelineno-0-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Hello, world!&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-18&#34; name=&#34;__codelineno-0-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-19&#34; name=&#34;__codelineno-0-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;begin_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;inner&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-20&#34; name=&#34;__codelineno-0-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;begin_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;x&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-21&#34; name=&#34;__codelineno-0-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;42&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-22&#34; name=&#34;__codelineno-0-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-23&#34; name=&#34;__codelineno-0-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;begin_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;b&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-24&#34; name=&#34;__codelineno-0-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;43&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-25&#34; name=&#34;__codelineno-0-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-26&#34; name=&#34;__codelineno-0-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-27&#34; name=&#34;__codelineno-0-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;build&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-28&#34; name=&#34;__codelineno-0-28&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-29&#34; name=&#34;__codelineno-0-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;fm&#34;&gt;assert_eq!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-30&#34; name=&#34;__codelineno-0-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-31&#34; name=&#34;__codelineno-0-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Outer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-32&#34; name=&#34;__codelineno-0-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Hello, world!&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-33&#34; name=&#34;__codelineno-0-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inner&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Inner&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;42&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;43&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-34&#34; name=&#34;__codelineno-0-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-35&#34; name=&#34;__codelineno-0-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-36&#34; name=&#34;__codelineno-0-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h4 id=&#34;peekvalue功能介绍&#34;&gt;PeekValue功能介绍&lt;a class=&#34;headerlink&#34; href=&#34;#peekvalue功能介绍&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;查看存在的值。例如：通过.field_by_name(&amp;ldquo;number&amp;rdquo;)获取number成员的值。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#[derive(Facet)]&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;TestStruct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;number&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;i32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-4&#34; name=&#34;__codelineno-1-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-5&#34; name=&#34;__codelineno-1-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-6&#34; name=&#34;__codelineno-1-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-1-7&#34; name=&#34;__codelineno-1-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#[test]&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-8&#34; name=&#34;__codelineno-1-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;peek_struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-9&#34; name=&#34;__codelineno-1-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Create test struct instance&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-10&#34; name=&#34;__codelineno-1-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TestStruct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-11&#34; name=&#34;__codelineno-1-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;number&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;42&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-12&#34; name=&#34;__codelineno-1-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;hello&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-13&#34; name=&#34;__codelineno-1-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-14&#34; name=&#34;__codelineno-1-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;peek_value&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Peek&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-15&#34; name=&#34;__codelineno-1-15&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-1-16&#34; name=&#34;__codelineno-1-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Convert to struct and check we can convert to PeekStruct&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-17&#34; name=&#34;__codelineno-1-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;peek_struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;peek_value&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-18&#34; name=&#34;__codelineno-1-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;into_struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-19&#34; name=&#34;__codelineno-1-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;expect&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Should be convertible to struct&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-20&#34; name=&#34;__codelineno-1-20&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-1-21&#34; name=&#34;__codelineno-1-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Test field access by name&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-22&#34; name=&#34;__codelineno-1-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;number_field&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;peek_struct&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-23&#34; name=&#34;__codelineno-1-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field_by_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;number&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-24&#34; name=&#34;__codelineno-1-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;expect&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Should have a number field&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-25&#34; name=&#34;__codelineno-1-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_field&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;peek_struct&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-26&#34; name=&#34;__codelineno-1-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field_by_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-27&#34; name=&#34;__codelineno-1-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;expect&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Should have a text field&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-28&#34; name=&#34;__codelineno-1-28&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-1-29&#34; name=&#34;__codelineno-1-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Test field values&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-30&#34; name=&#34;__codelineno-1-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;number_value&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;number_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;i32&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unwrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-31&#34; name=&#34;__codelineno-1-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;fm&#34;&gt;assert_eq!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;number_value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;42&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-32&#34; name=&#34;__codelineno-1-32&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-1-33&#34; name=&#34;__codelineno-1-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_value&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unwrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-34&#34; name=&#34;__codelineno-1-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;fm&#34;&gt;assert_eq!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;hello&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-35&#34; name=&#34;__codelineno-1-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;核心存储结构&#34;&gt;核心存储结构&lt;a class=&#34;headerlink&#34; href=&#34;#核心存储结构&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;facet存储的核心数据结构，&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SHAPE&lt;/li&gt;
&lt;li&gt;VTABLE
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;trait&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Facet&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;facet&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;facet&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// The shape of this type&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-4&#34; name=&#34;__codelineno-2-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Shape embeds all other constants of this trait.&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-5&#34; name=&#34;__codelineno-2-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SHAPE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-6&#34; name=&#34;__codelineno-2-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-7&#34; name=&#34;__codelineno-2-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Function pointers to perform various operations: print the full type&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-8&#34; name=&#34;__codelineno-2-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// name (with generic type parameters), use the Display implementation,&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-9&#34; name=&#34;__codelineno-2-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// the Debug implementation, build a default value, clone, etc.&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-10&#34; name=&#34;__codelineno-2-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-11&#34; name=&#34;__codelineno-2-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// If [`Self::SHAPE`] has `ShapeLayout::Unsized`, then the parent pointer needs to be passed.&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-12&#34; name=&#34;__codelineno-2-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-13&#34; name=&#34;__codelineno-2-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// There are more specific vtables in variants of [`Def`]&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-14&#34; name=&#34;__codelineno-2-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;VTABLE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ValueVTable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-15&#34; name=&#34;__codelineno-2-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;为core、alloc、std等模块中的数据结构都实现了Facet trait。以实现反射的两大功能。&lt;/p&gt;
&lt;h3 id=&#34;string类型如何实现trait&#34;&gt;String类型如何实现trait&lt;a class=&#34;headerlink&#34; href=&#34;#string类型如何实现trait&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;看个最简单的类型，从alloc模块中引入的String类型。对每个类型为了实现反射，都有一个字符串类型的描述标志，String类型就是&amp;rdquo;String&amp;rdquo;。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#[cfg(feature = &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;alloc&amp;quot;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;)]&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Facet&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;VTABLE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ValueVTable&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vtable&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value_vtable&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_opts&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;fm&#34;&gt;write!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-5&#34; name=&#34;__codelineno-3-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-6&#34; name=&#34;__codelineno-3-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;{}&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-7&#34; name=&#34;__codelineno-3-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SHAPE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_identifier&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-8&#34; name=&#34;__codelineno-3-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-9&#34; name=&#34;__codelineno-3-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-10&#34; name=&#34;__codelineno-3-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vtable_sized&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vtable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sized_mut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unwrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-11&#34; name=&#34;__codelineno-3-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 如何解析String类型&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-12&#34; name=&#34;__codelineno-3-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vtable_sized&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parse&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-13&#34; name=&#34;__codelineno-3-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-14&#34; name=&#34;__codelineno-3-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// For String, parsing from a string is just copying the string&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-15&#34; name=&#34;__codelineno-3-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-16&#34; name=&#34;__codelineno-3-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-17&#34; name=&#34;__codelineno-3-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-18&#34; name=&#34;__codelineno-3-18&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-19&#34; name=&#34;__codelineno-3-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vtable&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-20&#34; name=&#34;__codelineno-3-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-21&#34; name=&#34;__codelineno-3-21&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-22&#34; name=&#34;__codelineno-3-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SHAPE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Shape&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-23&#34; name=&#34;__codelineno-3-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;builder_for_sized&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-24&#34; name=&#34;__codelineno-3-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Def&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scalar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-25&#34; name=&#34;__codelineno-3-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_identifier&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;String&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-26&#34; name=&#34;__codelineno-3-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ty&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;UserType&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Opaque&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-27&#34; name=&#34;__codelineno-3-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;build&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-28&#34; name=&#34;__codelineno-3-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-29&#34; name=&#34;__codelineno-3-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;vtable如何实现&#34;&gt;VTABLE如何实现&lt;a class=&#34;headerlink&#34; href=&#34;#vtable如何实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;通过ValueVTableBuilder绑定了函数指针，通过Spez统一调用到对应的函数。
impl! crate
可以判断某个类型是否实现了某个 trait，&lt;a href=&#34;https://docs.rs/impls/latest/impls/&#34;&gt;impls crate&lt;/a&gt;。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#[macro_export]&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;fm&#34;&gt;macro_rules!&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value_vtable&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-3&#34; name=&#34;__codelineno-4-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;$type_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ty&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;$type_name_fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;expr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-4&#34; name=&#34;__codelineno-4-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-5&#34; name=&#34;__codelineno-4-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;$crate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ValueVTable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;builder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;$type_name&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-6&#34; name=&#34;__codelineno-4-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;$type_name_fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-7&#34; name=&#34;__codelineno-4-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;display&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-8&#34; name=&#34;__codelineno-4-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;$crate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;spez&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;impls&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;$type_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;core&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Display&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-9&#34; name=&#34;__codelineno-4-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-10&#34; name=&#34;__codelineno-4-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;use&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;$crate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;spez&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-11&#34; name=&#34;__codelineno-4-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Spez&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;spez_display&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-12&#34; name=&#34;__codelineno-4-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-13&#34; name=&#34;__codelineno-4-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-14&#34; name=&#34;__codelineno-4-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;None&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-15&#34; name=&#34;__codelineno-4-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-16&#34; name=&#34;__codelineno-4-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-17&#34; name=&#34;__codelineno-4-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ...&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-18&#34; name=&#34;__codelineno-4-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;build&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-19&#34; name=&#34;__codelineno-4-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-20&#34; name=&#34;__codelineno-4-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-21&#34; name=&#34;__codelineno-4-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;spec模块实现了“自动解引用特化辅助工具”指的是通过自动解引用（auto-deref）技术，实现类似于specialization的功能。
简而言之，本模块让你可以根据类型实现的 trait 自动选择更合适的实现，且不需要用到 Rust 还未稳定的specialization feature功能。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/dtolnay/case-studies/blob/master/autoref-specialization/README.md&#34;&gt;rust自动引用特化参考&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;例如，一个类型实现了 &lt;code&gt;Default&lt;/code&gt; trait，那么 &lt;code&gt;spez_default_in_place&lt;/code&gt; 方法会返回一个指向默认值的指针。将默认值写入到指定的内存位置，也就是PtrUninit。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-40&#34;&gt;40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-41&#34;&gt;41&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;//////////////////////////////////////////////////////////////////////////////////////&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Default (in place, because we can&amp;#39;t have sized) 🏠🔄&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-3&#34; name=&#34;__codelineno-5-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;//////////////////////////////////////////////////////////////////////////////////////&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-4&#34; name=&#34;__codelineno-5-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-5&#34; name=&#34;__codelineno-5-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// Specialization proxy for [`core::default::Default`]&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-6&#34; name=&#34;__codelineno-5-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;trait&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SpezDefaultInPlaceYes&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-7&#34; name=&#34;__codelineno-5-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Creates a default value for the inner type in place.&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-8&#34; name=&#34;__codelineno-5-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-9&#34; name=&#34;__codelineno-5-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// This method is called when the wrapped type implements `Default`.&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-10&#34; name=&#34;__codelineno-5-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// It writes the default value into the provided uninitialized memory.&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-11&#34; name=&#34;__codelineno-5-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-12&#34; name=&#34;__codelineno-5-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// # Safety&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-13&#34; name=&#34;__codelineno-5-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-14&#34; name=&#34;__codelineno-5-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// This function operates on uninitialized memory and requires that `target`&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-15&#34; name=&#34;__codelineno-5-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// has sufficient space allocated for type `T`.&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-16&#34; name=&#34;__codelineno-5-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;spez_default_in_place&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PtrUninit&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PtrMut&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-17&#34; name=&#34;__codelineno-5-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-18&#34; name=&#34;__codelineno-5-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Default&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SpezDefaultInPlaceYes&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SpezEmpty&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-19&#34; name=&#34;__codelineno-5-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;spez_default_in_place&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PtrUninit&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PtrMut&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-20&#34; name=&#34;__codelineno-5-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Default&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-21&#34; name=&#34;__codelineno-5-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-22&#34; name=&#34;__codelineno-5-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-23&#34; name=&#34;__codelineno-5-23&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-24&#34; name=&#34;__codelineno-5-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// Specialization proxy for [`core::default::Default`]&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-25&#34; name=&#34;__codelineno-5-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;trait&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SpezDefaultInPlaceNo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-26&#34; name=&#34;__codelineno-5-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Fallback implementation when the type doesn&amp;#39;t implement `Default`.&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-27&#34; name=&#34;__codelineno-5-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-28&#34; name=&#34;__codelineno-5-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// This method is used as a fallback and is designed to be unreachable in practice.&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-29&#34; name=&#34;__codelineno-5-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// It&amp;#39;s only selected when the wrapped type doesn&amp;#39;t implement `Default`.&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-30&#34; name=&#34;__codelineno-5-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-31&#34; name=&#34;__codelineno-5-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// # Safety&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-32&#34; name=&#34;__codelineno-5-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-33&#34; name=&#34;__codelineno-5-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// This function is marked unsafe as it deals with uninitialized memory,&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-34&#34; name=&#34;__codelineno-5-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// but it should never be reachable in practice.&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-35&#34; name=&#34;__codelineno-5-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;spez_default_in_place&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_target&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PtrUninit&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PtrMut&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-36&#34; name=&#34;__codelineno-5-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-37&#34; name=&#34;__codelineno-5-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SpezDefaultInPlaceNo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SpezEmpty&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-38&#34; name=&#34;__codelineno-5-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;spez_default_in_place&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_target&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PtrUninit&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PtrMut&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-39&#34; name=&#34;__codelineno-5-39&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;fm&#34;&gt;unreachable!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-40&#34; name=&#34;__codelineno-5-40&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-41&#34; name=&#34;__codelineno-5-41&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;ValueVTableBuilder是ValueVTable类型的构建器。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ValueVTableBuilder&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-2&#34; name=&#34;__codelineno-6-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TypeNameFn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-3&#34; name=&#34;__codelineno-6-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;display&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DisplayFn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-4&#34; name=&#34;__codelineno-6-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ...&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-5&#34; name=&#34;__codelineno-6-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
display函数实现就是通过transmute进行类型转换，从DisplayFnTyped类型转换为DisplayFn。&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-7-1&#34; name=&#34;__codelineno-7-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;display&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;display&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DisplayFnTyped&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-2&#34; name=&#34;__codelineno-7-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;display&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-3&#34; name=&#34;__codelineno-7-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;transmute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DisplayFnTyped&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DisplayFn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;display&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-4&#34; name=&#34;__codelineno-7-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-5&#34; name=&#34;__codelineno-7-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-6&#34; name=&#34;__codelineno-7-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-8-1&#34; name=&#34;__codelineno-8-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// Function to format a value for display&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-2&#34; name=&#34;__codelineno-8-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-3&#34; name=&#34;__codelineno-8-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// If both [`DisplayFn`] and [`ParseFn`] are set, we should be able to round-trip the value.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-4&#34; name=&#34;__codelineno-8-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-5&#34; name=&#34;__codelineno-8-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// # Safety&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-6&#34; name=&#34;__codelineno-8-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-7&#34; name=&#34;__codelineno-8-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// The `value` parameter must point to aligned, initialized memory of the correct type.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-8&#34; name=&#34;__codelineno-8-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;DisplayFn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-9&#34; name=&#34;__codelineno-8-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PtrConst&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;core&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Formatter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;core&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-10&#34; name=&#34;__codelineno-8-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-11&#34; name=&#34;__codelineno-8-11&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-12&#34; name=&#34;__codelineno-8-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// Function to format a value for display&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-13&#34; name=&#34;__codelineno-8-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-14&#34; name=&#34;__codelineno-8-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// If both [`DisplayFn`] and [`ParseFn`] are set, we should be able to round-trip the value.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-15&#34; name=&#34;__codelineno-8-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;DisplayFnTyped&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;core&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Formatter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;core&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;****&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;shape如何实现&#34;&gt;SHAPE如何实现&lt;a class=&#34;headerlink&#34; href=&#34;#shape如何实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-9&#34;&gt;9&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-9-1&#34; name=&#34;__codelineno-9-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Shape&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-2&#34; name=&#34;__codelineno-9-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Returns a builder for a shape for some type `T`.&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-3&#34; name=&#34;__codelineno-9-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;builder_for_sized&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Facet&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ShapeBuilder&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-4&#34; name=&#34;__codelineno-9-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ShapeBuilder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;VTABLE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-5&#34; name=&#34;__codelineno-9-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-6&#34; name=&#34;__codelineno-9-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ConstTypeId&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;of&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-7&#34; name=&#34;__codelineno-9-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-8&#34; name=&#34;__codelineno-9-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ....&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-9&#34; name=&#34;__codelineno-9-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-10-1&#34; name=&#34;__codelineno-10-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// Builder for [`Shape`]&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-2&#34; name=&#34;__codelineno-10-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ShapeBuilder&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-3&#34; name=&#34;__codelineno-10-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ConstTypeId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-4&#34; name=&#34;__codelineno-10-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ShapeLayout&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 记录了layout信息&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-5&#34; name=&#34;__codelineno-10-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vtable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ValueVTable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 记录了vtable信息，就是上面的value_vtable，存储了函数指针&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-6&#34; name=&#34;__codelineno-10-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Def&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-7&#34; name=&#34;__codelineno-10-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ty&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-8&#34; name=&#34;__codelineno-10-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_identifier&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;amp;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-9&#34; name=&#34;__codelineno-10-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TypeParam&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-10&#34; name=&#34;__codelineno-10-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;doc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-11&#34; name=&#34;__codelineno-10-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;attributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ShapeAttribute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-12&#34; name=&#34;__codelineno-10-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_tag&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;amp;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-13&#34; name=&#34;__codelineno-10-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inner&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Shape&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-14&#34; name=&#34;__codelineno-10-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;layout是什么呢？实际上就是存储的core::alloc::Layout，记录了Size、Align等信息。可以分配一段该类型的未初始化内存，然后就可以反序列化时将内存写入到指定的内存中，就构造出了type的实例。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-11-1&#34; name=&#34;__codelineno-11-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;use&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;core&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-2&#34; name=&#34;__codelineno-11-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-3&#34; name=&#34;__codelineno-11-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// Schema for reflection of a type&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-4&#34; name=&#34;__codelineno-11-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#[derive(Clone, Copy)]&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-5&#34; name=&#34;__codelineno-11-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#[repr(C)]&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-6&#34; name=&#34;__codelineno-11-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Shape&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-7&#34; name=&#34;__codelineno-11-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Unique type identifier, provided by the compiler.&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-8&#34; name=&#34;__codelineno-11-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ConstTypeId&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-9&#34; name=&#34;__codelineno-11-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-10&#34; name=&#34;__codelineno-11-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Size, alignment — enough to allocate a value of this type&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-11&#34; name=&#34;__codelineno-11-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// (but not initialize it.)&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-12&#34; name=&#34;__codelineno-11-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ShapeLayout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-13&#34; name=&#34;__codelineno-11-13&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-14&#34; name=&#34;__codelineno-11-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Function pointers to perform various operations: print the full type&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-15&#34; name=&#34;__codelineno-11-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// name (with generic type parameters), use the Display implementation,&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-16&#34; name=&#34;__codelineno-11-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// the Debug implementation, build a default value, clone, etc.&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-17&#34; name=&#34;__codelineno-11-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-18&#34; name=&#34;__codelineno-11-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// If the shape has `ShapeLayout::Unsized`, then the parent pointer needs to be passed.&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-19&#34; name=&#34;__codelineno-11-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-20&#34; name=&#34;__codelineno-11-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// There are more specific vtables in variants of [`Def`]&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-21&#34; name=&#34;__codelineno-11-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vtable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ValueVTable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-22&#34; name=&#34;__codelineno-11-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ...&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-23&#34; name=&#34;__codelineno-11-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-24&#34; name=&#34;__codelineno-11-24&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-25&#34; name=&#34;__codelineno-11-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// Layout of the shape&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-26&#34; name=&#34;__codelineno-11-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#[derive(Clone, Copy, Debug, Hash)]&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-27&#34; name=&#34;__codelineno-11-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;enum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ShapeLayout&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-28&#34; name=&#34;__codelineno-11-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// `Sized` type&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-29&#34; name=&#34;__codelineno-11-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Sized&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-30&#34; name=&#34;__codelineno-11-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// `!Sized` type&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-31&#34; name=&#34;__codelineno-11-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Unsized&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-32&#34; name=&#34;__codelineno-11-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h4 id=&#34;如何在堆上分配一段未初始化内存&#34;&gt;如何在堆上分配一段未初始化内存？&lt;a class=&#34;headerlink&#34; href=&#34;#如何在堆上分配一段未初始化内存&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-12-1&#34; name=&#34;__codelineno-12-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// facet/facet-core/src/types/mod.rs&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-2&#34; name=&#34;__codelineno-12-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Shape&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-3&#34; name=&#34;__codelineno-12-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Heap-allocate a value of this shape&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-4&#34; name=&#34;__codelineno-12-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[cfg(feature = &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;alloc&amp;quot;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;)]&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-5&#34; name=&#34;__codelineno-12-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[inline]&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-6&#34; name=&#34;__codelineno-12-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;allocate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;crate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PtrUninit&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;UnsizedError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-7&#34; name=&#34;__codelineno-12-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;layout&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sized_layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-8&#34; name=&#34;__codelineno-12-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-12-9&#34; name=&#34;__codelineno-12-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;crate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PtrUninit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-10&#34; name=&#34;__codelineno-12-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;core&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;without_provenance_mut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;align&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-11&#34; name=&#34;__codelineno-12-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-12&#34; name=&#34;__codelineno-12-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// SAFETY: We have checked that layout&amp;#39;s size is non-zero&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-13&#34; name=&#34;__codelineno-12-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-14&#34; name=&#34;__codelineno-12-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}))&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-15&#34; name=&#34;__codelineno-12-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-16&#34; name=&#34;__codelineno-12-16&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-12-17&#34; name=&#34;__codelineno-12-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Deallocate a heap-allocated value of this shape&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-18&#34; name=&#34;__codelineno-12-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[cfg(feature = &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;alloc&amp;quot;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;)]&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-19&#34; name=&#34;__codelineno-12-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[inline]&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-20&#34; name=&#34;__codelineno-12-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;deallocate_mut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PtrMut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;UnsizedError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-21&#34; name=&#34;__codelineno-12-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;use&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dealloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-22&#34; name=&#34;__codelineno-12-22&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-12-23&#34; name=&#34;__codelineno-12-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;layout&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sized_layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-24&#34; name=&#34;__codelineno-12-24&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-12-25&#34; name=&#34;__codelineno-12-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-26&#34; name=&#34;__codelineno-12-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Nothing to deallocate&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-27&#34; name=&#34;__codelineno-12-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(());&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-28&#34; name=&#34;__codelineno-12-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-29&#34; name=&#34;__codelineno-12-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// SAFETY: The user guarantees ptr is valid and from allocate, we checked size isn&amp;#39;t 0&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-30&#34; name=&#34;__codelineno-12-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dealloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;as_mut_byte_ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-31&#34; name=&#34;__codelineno-12-31&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-12-32&#34; name=&#34;__codelineno-12-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(())&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-33&#34; name=&#34;__codelineno-12-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-34&#34; name=&#34;__codelineno-12-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ...&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-35&#34; name=&#34;__codelineno-12-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;什么时候会用到根据layout分配内存呢？在facet reflect的Partial功能中。还记得最前面的Partial就是调用了alloc函数分配Outer类型的内存吗？
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-13-1&#34; name=&#34;__codelineno-13-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;facet&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Partial&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;facet&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-2&#34; name=&#34;__codelineno-13-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Allocates a new Partial instance with the given shape&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-3&#34; name=&#34;__codelineno-13-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;alloc_shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReflectError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-4&#34; name=&#34;__codelineno-13-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;crate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;trace&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-5&#34; name=&#34;__codelineno-13-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;alloc_shape({:?}), with layout {:?}&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-6&#34; name=&#34;__codelineno-13-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-7&#34; name=&#34;__codelineno-13-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sized_layout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-8&#34; name=&#34;__codelineno-13-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-9&#34; name=&#34;__codelineno-13-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-13-10&#34; name=&#34;__codelineno-13-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map_err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReflectError&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Unsized&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-11&#34; name=&#34;__codelineno-13-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-12&#34; name=&#34;__codelineno-13-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;operation&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;alloc_shape&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-13&#34; name=&#34;__codelineno-13-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-14&#34; name=&#34;__codelineno-13-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ....&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-15&#34; name=&#34;__codelineno-13-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-16&#34; name=&#34;__codelineno-13-16&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-13-17&#34; name=&#34;__codelineno-13-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Allocates a new TypedPartial instance with the given shape and type&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-18&#34; name=&#34;__codelineno-13-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;alloc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TypedPartial&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;facet&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReflectError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-19&#34; name=&#34;__codelineno-13-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;where&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-20&#34; name=&#34;__codelineno-13-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Facet&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;facet&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-21&#34; name=&#34;__codelineno-13-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-22&#34; name=&#34;__codelineno-13-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TypedPartial&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-23&#34; name=&#34;__codelineno-13-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inner&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alloc_shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SHAPE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-24&#34; name=&#34;__codelineno-13-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;phantom&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PhantomData&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-25&#34; name=&#34;__codelineno-13-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-26&#34; name=&#34;__codelineno-13-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-27&#34; name=&#34;__codelineno-13-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;partial的实现原理&#34;&gt;Partial的实现原理&lt;a class=&#34;headerlink&#34; href=&#34;#partial的实现原理&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Partial通过一个Vec&amp;lt;Frame&amp;gt;来保存操作的元素。以Partial构造一个Struct为例。当前操作name field，那么Vec保存的最后一帧就是记录的name fileld的信息，包括shape、数据指针、状态Tracker等。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-14-1&#34; name=&#34;__codelineno-14-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Partial&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;facet&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-2&#34; name=&#34;__codelineno-14-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// stack of frames to keep track of deeply nested initialization&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-3&#34; name=&#34;__codelineno-14-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;frames&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Vec&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Frame&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-4&#34; name=&#34;__codelineno-14-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ...&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-5&#34; name=&#34;__codelineno-14-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-6&#34; name=&#34;__codelineno-14-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-14-7&#34; name=&#34;__codelineno-14-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Frame&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-8&#34; name=&#34;__codelineno-14-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Address of the value being initialized&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-9&#34; name=&#34;__codelineno-14-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PtrUninit&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-10&#34; name=&#34;__codelineno-14-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-14-11&#34; name=&#34;__codelineno-14-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Shape of the value being initialized&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-12&#34; name=&#34;__codelineno-14-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-13&#34; name=&#34;__codelineno-14-13&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-14-14&#34; name=&#34;__codelineno-14-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Tracks initialized fields&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-15&#34; name=&#34;__codelineno-14-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tracker&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Tracker&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-16&#34; name=&#34;__codelineno-14-16&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-14-17&#34; name=&#34;__codelineno-14-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Whether this frame owns the allocation or is just a field pointer&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-18&#34; name=&#34;__codelineno-14-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ownership&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;FrameOwnership&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-19&#34; name=&#34;__codelineno-14-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
从前面的例子看
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-15-1&#34; name=&#34;__codelineno-15-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#[derive(Facet, PartialEq, Eq, Debug)]&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-2&#34; name=&#34;__codelineno-15-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Outer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-3&#34; name=&#34;__codelineno-15-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-4&#34; name=&#34;__codelineno-15-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-5&#34; name=&#34;__codelineno-15-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-15-6&#34; name=&#34;__codelineno-15-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#[test]&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-7&#34; name=&#34;__codelineno-15-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;wip_struct_testleak1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-8&#34; name=&#34;__codelineno-15-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Partial&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Outer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-9&#34; name=&#34;__codelineno-15-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;begin_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-10&#34; name=&#34;__codelineno-15-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Hello, world!&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-11&#34; name=&#34;__codelineno-15-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-12&#34; name=&#34;__codelineno-15-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ......&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-13&#34; name=&#34;__codelineno-15-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;首先,alloc分配Outer类型我们已经介绍清楚了。从begin_field说起。
根据field_name, 例如Outer 结构体的name字段，先获取Struct的struct_type.fields，然后获取到一个index。就可以根据index去获取这个field的信息了。我们的目的是获取field的Shape和未初始化指针，后续就可以通过set函数设置该字段的值。&lt;/p&gt;
&lt;p&gt;self.frames.last_mut()就是获取当前栈帧。当前操作的是Struct类型的栈帧。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-16-1&#34; name=&#34;__codelineno-16-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// /home/ken/tmp/facet/facet-reflect/src/partial/mod.rs&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-2&#34; name=&#34;__codelineno-16-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// Selects a field of a struct with a given name&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-3&#34; name=&#34;__codelineno-16-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;begin_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReflectError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-4&#34; name=&#34;__codelineno-16-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;frame&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;frames&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;last_mut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unwrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-5&#34; name=&#34;__codelineno-16-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;frame&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ty&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-6&#34; name=&#34;__codelineno-16-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-7&#34; name=&#34;__codelineno-16-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;UserType&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;struct_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-8&#34; name=&#34;__codelineno-16-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;struct_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fields&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;iter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;position&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-9&#34; name=&#34;__codelineno-16-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-10&#34; name=&#34;__codelineno-16-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-11&#34; name=&#34;__codelineno-16-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-12&#34; name=&#34;__codelineno-16-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReflectError&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OperationFailed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-13&#34; name=&#34;__codelineno-16-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;frame&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-14&#34; name=&#34;__codelineno-16-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;operation&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;field not found&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-15&#34; name=&#34;__codelineno-16-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;});&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-16&#34; name=&#34;__codelineno-16-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-17&#34; name=&#34;__codelineno-16-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-18&#34; name=&#34;__codelineno-16-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;begin_nth_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-19&#34; name=&#34;__codelineno-16-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-20&#34; name=&#34;__codelineno-16-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-21&#34; name=&#34;__codelineno-16-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-22&#34; name=&#34;__codelineno-16-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;调用begin_nth_field函数时，最后一个Frame还是Struct的信息。
在找到name feild后，如果已经初始化，就先drop初始化的数据，然后后续重新初始化。同时，更新最后一帧，也就是last_frame为当前操作的Struct的name field。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-40&#34;&gt;40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-41&#34;&gt;41&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-42&#34;&gt;42&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-43&#34;&gt;43&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-44&#34;&gt;44&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-45&#34;&gt;45&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-46&#34;&gt;46&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-47&#34;&gt;47&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-48&#34;&gt;48&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-49&#34;&gt;49&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-50&#34;&gt;50&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-51&#34;&gt;51&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-52&#34;&gt;52&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-53&#34;&gt;53&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-54&#34;&gt;54&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-55&#34;&gt;55&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-17-1&#34; name=&#34;__codelineno-17-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Selects the nth field of a struct by index&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-2&#34; name=&#34;__codelineno-17-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;begin_nth_field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;usize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReflectError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-3&#34; name=&#34;__codelineno-17-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;frame&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;frames&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;last_mut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unwrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-4&#34; name=&#34;__codelineno-17-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;frame&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ty&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-5&#34; name=&#34;__codelineno-17-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-6&#34; name=&#34;__codelineno-17-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;UserType&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;struct_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-7&#34; name=&#34;__codelineno-17-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;struct_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fields&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-8&#34; name=&#34;__codelineno-17-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReflectError&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OperationFailed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-9&#34; name=&#34;__codelineno-17-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;frame&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-10&#34; name=&#34;__codelineno-17-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;operation&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;field index out of bounds&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-11&#34; name=&#34;__codelineno-17-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;});&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-12&#34; name=&#34;__codelineno-17-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-13&#34; name=&#34;__codelineno-17-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;struct_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fields&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-14&#34; name=&#34;__codelineno-17-14&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-17-15&#34; name=&#34;__codelineno-17-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;frame&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tracker&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-16&#34; name=&#34;__codelineno-17-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Tracker&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Uninit&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-17&#34; name=&#34;__codelineno-17-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;frame&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tracker&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Tracker&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-18&#34; name=&#34;__codelineno-17-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;iset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ISet&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;struct_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fields&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()),&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-19&#34; name=&#34;__codelineno-17-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;current_child&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-20&#34; name=&#34;__codelineno-17-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-21&#34; name=&#34;__codelineno-17-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-22&#34; name=&#34;__codelineno-17-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Tracker&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-23&#34; name=&#34;__codelineno-17-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;iset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-24&#34; name=&#34;__codelineno-17-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;current_child&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-25&#34; name=&#34;__codelineno-17-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-26&#34; name=&#34;__codelineno-17-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Check if this field was already initialized&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-27&#34; name=&#34;__codelineno-17-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;iset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-28&#34; name=&#34;__codelineno-17-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Drop the existing value before re-initializing&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-29&#34; name=&#34;__codelineno-17-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 获取name字段的指针，drop已经初始化的数据，进行重新初始化&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-30&#34; name=&#34;__codelineno-17-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field_ptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;frame&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field_init_at&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-31&#34; name=&#34;__codelineno-17-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;drop_fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-32&#34; name=&#34;__codelineno-17-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vtable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sized&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;and_then&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;drop_in_place&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)())&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-33&#34; name=&#34;__codelineno-17-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-34&#34; name=&#34;__codelineno-17-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;drop_fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field_ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-35&#34; name=&#34;__codelineno-17-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-36&#34; name=&#34;__codelineno-17-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Unset the bit so we can re-initialize&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-37&#34; name=&#34;__codelineno-17-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;iset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-38&#34; name=&#34;__codelineno-17-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-39&#34; name=&#34;__codelineno-17-39&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;current_child&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-40&#34; name=&#34;__codelineno-17-40&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-41&#34; name=&#34;__codelineno-17-41&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;fm&#34;&gt;unreachable!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-42&#34; name=&#34;__codelineno-17-42&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-43&#34; name=&#34;__codelineno-17-43&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-17-44&#34; name=&#34;__codelineno-17-44&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Push a new frame for this field onto the frames stack.&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-45&#34; name=&#34;__codelineno-17-45&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field_ptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;frame&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field_uninit_at&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-46&#34; name=&#34;__codelineno-17-46&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field_shape&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-47&#34; name=&#34;__codelineno-17-47&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 修改最后一帧，也就是last_frame为当前操作的Struct的name field&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-48&#34; name=&#34;__codelineno-17-48&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;frames&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-49&#34; name=&#34;__codelineno-17-49&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;push&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Frame&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field_ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;field_shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;FrameOwnership&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Field&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-50&#34; name=&#34;__codelineno-17-50&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-17-51&#34; name=&#34;__codelineno-17-51&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-52&#34; name=&#34;__codelineno-17-52&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-53&#34; name=&#34;__codelineno-17-53&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-54&#34; name=&#34;__codelineno-17-54&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-55&#34; name=&#34;__codelineno-17-55&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;set设置值
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-18-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-18-1&#34; name=&#34;__codelineno-18-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// Sets a value wholesale into the current frame&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-2&#34; name=&#34;__codelineno-18-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;U&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReflectError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-3&#34; name=&#34;__codelineno-18-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;where&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-4&#34; name=&#34;__codelineno-18-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Facet&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;facet&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-5&#34; name=&#34;__codelineno-18-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-6&#34; name=&#34;__codelineno-18-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;require_active&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-7&#34; name=&#34;__codelineno-18-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-18-8&#34; name=&#34;__codelineno-18-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// For conversion frames, store the value in the conversion frame itself&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-9&#34; name=&#34;__codelineno-18-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// The conversion will happen during end()&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-10&#34; name=&#34;__codelineno-18-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr_const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PtrConst&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;raw&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-11&#34; name=&#34;__codelineno-18-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-12&#34; name=&#34;__codelineno-18-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Safety: We are calling set_shape with a valid shape and a valid pointer&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-13&#34; name=&#34;__codelineno-18-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set_shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr_const&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SHAPE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-14&#34; name=&#34;__codelineno-18-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-15&#34; name=&#34;__codelineno-18-15&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-18-16&#34; name=&#34;__codelineno-18-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Prevent the value from being dropped since we&amp;#39;ve copied it&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-17&#34; name=&#34;__codelineno-18-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;core&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;forget&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-18&#34; name=&#34;__codelineno-18-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-18-19&#34; name=&#34;__codelineno-18-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
set函数调用了set_shape函数，因为begin_field函数接着调用的就是set函数，因此set_shape函数中获取的last_mut frame就是name字段的信息。然后就为data指针指向的数据赋值了。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Rust&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-19-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-19-1&#34; name=&#34;__codelineno-19-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;sd&#34;&gt;/// Sets a value into the current frame by shape, for shape-based operations&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-2&#34; name=&#34;__codelineno-19-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#[inline]&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-3&#34; name=&#34;__codelineno-19-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;set_shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-4&#34; name=&#34;__codelineno-19-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-5&#34; name=&#34;__codelineno-19-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;src_value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PtrConst&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-6&#34; name=&#34;__codelineno-19-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;src_shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-7&#34; name=&#34;__codelineno-19-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReflectError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-8&#34; name=&#34;__codelineno-19-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;frames&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;last_mut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unwrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-9&#34; name=&#34;__codelineno-19-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-19-10&#34; name=&#34;__codelineno-19-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-11&#34; name=&#34;__codelineno-19-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;copy_from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;src_value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unwrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-12&#34; name=&#34;__codelineno-19-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-13&#34; name=&#34;__codelineno-19-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tracker&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Tracker&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Init&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-14&#34; name=&#34;__codelineno-19-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-19-15&#34; name=&#34;__codelineno-19-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
到此，成功实现了Struct的Partial功能，从分配未初始化的内存，然后通过string类型的field名称，构造一个个field，最终构造出一个结构体。&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/pyo3实现python和rust跨语言调用/&#34; target=&#34;_blank&#34;&gt;pyo3实现python和rust跨语言调用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/使用aya和c混合编写uprobe程序/&#34; target=&#34;_blank&#34;&gt;使用aya和c混合编写uprobe程序&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c开发常见问题之abi兼容性问题/&#34; target=&#34;_blank&#34;&gt;C++开发常见问题之ABI兼容性问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c20如何实现一个基于属性测试的quickcheck-cpp库/&#34; target=&#34;_blank&#34;&gt;C++20如何实现一个基于属性测试的quickcheck-cpp库&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/rust-facet%E5%BA%93%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8F%8D%E5%B0%84/</link>
      <pubDate>Sat, 02 Aug 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/rust-facet%E5%BA%93%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8F%8D%E5%B0%84/</guid>
      
    </item>
    
    <item>
      <title>关于阅读源码的一点心得</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;p&gt;朋友们，阅读优秀的源码可以学到很多，例如代码的结构组织、设计模式、为了解决一些问题特殊处理、写法技巧、优化策略等，同时也扩展了对编程语言的熟悉程度、关于这个项目的解决问题思路。&lt;/p&gt;
&lt;!-- more --&gt;

&lt;p&gt;本文主要记录和分享一些我阅读代码过程中的心得，包括如何阅读代码、利用阅读代码工具、如何选择一些代码库阅读。&lt;/p&gt;
&lt;h2 id=&#34;如何阅读代码&#34;&gt;如何阅读代码&lt;a class=&#34;headerlink&#34; href=&#34;#如何阅读代码&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;阅读代码的过程，就像是探案寻找嫌疑人、破解敌人的阵法、又或者欣赏一件艺术品。如果没有思路、一头扎进去，或者变成了按顺序读代码，就会眼睛痛、头发晕了，很难进行下去。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;带着问题或者目标去阅读代码，大型代码库都是由很多人开发的、由很多功能组成，特别庞大，需要由问题切入。比如这个代码库中如何实现某个功能的？比如Pytorch中如何使用cudaIpc功能的？比如LLM推理库中如何实现投机采样的？&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;不推荐顺序读代码，比如打开一个文件，从头开始往后读，一个一个文件读。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;拿C++的一个文件来说，可能由一个类或者多个类，里面包括了核心函数、工具辅助函数、用的少的函数变量等。有些函数变量对解决的你问题没有任何意义，按顺序阅读就会增加混乱度。推荐根据类和方法的调用关系，不断的跳转，查看代码如何实现和解决问题的。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;对于一个不了解的项目或者库，推荐可以从测试看起、先从用起来的角度，去理解这个项目是干嘛的，它能够解决哪些问题。在这个过程中，你就会去查阅它的文档（readme、blog）以及熟悉API用法。同时也会带给你很多问题，让你作为切入点阅读源码。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;阅读代码工具的利用&#34;&gt;阅读代码工具的利用&lt;a class=&#34;headerlink&#34; href=&#34;#阅读代码工具的利用&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;github1s&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;sourcegraph&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;command等软件&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;如何选择阅读的代码库&#34;&gt;如何选择阅读的代码库&lt;a class=&#34;headerlink&#34; href=&#34;#如何选择阅读的代码库&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;兴趣、技能提升、结合工作中的需求（或者未来工作的发展情况）&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/使用pytorch从零构建llama3大模型--深入了解输出模块以及训练推理/&#34; target=&#34;_blank&#34;&gt;使用Pytorch从零构建Llama3大模型--深入了解输出模块以及训练推理&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/cista零拷贝反序列化库实现之swiss_table哈希表实现/&#34; target=&#34;_blank&#34;&gt;cista零拷贝反序列化库实现之swiss_table哈希表实现&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/%E5%85%B3%E4%BA%8E%E9%98%85%E8%AF%BB%E6%BA%90%E7%A0%81%E7%9A%84%E4%B8%80%E7%82%B9%E5%BF%83%E5%BE%97/</link>
      <pubDate>Fri, 01 Aug 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/%E5%85%B3%E4%BA%8E%E9%98%85%E8%AF%BB%E6%BA%90%E7%A0%81%E7%9A%84%E4%B8%80%E7%82%B9%E5%BF%83%E5%BE%97/</guid>
      
    </item>
    
    <item>
      <title>VLLM推理框架中的sleep_mode如何实现</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;!-- [TOC] --&gt;

&lt;h2 id=&#34;vllm-sleep_model-简介&#34;&gt;vllm sleep_model 简介&lt;a class=&#34;headerlink&#34; href=&#34;#vllm-sleep_model-简介&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;前文&lt;a href=&#34;https://zhuanlan.zhihu.com/p/1919901725592093271&#34; title=&#34;torch_memory_saver 高性能 CUDA 内存管理工具实现&#34;&gt;torch_memory_saver 高性能 CUDA 内存管理工具实现&lt;/a&gt;，介绍了 sglang 中利用了该库将保存 kv_cache 和权重的显存释放出来。&lt;/p&gt;
&lt;p&gt;在 VLLM 中也有同样的功能实现，在 VLLM 中的直接应用是“sleep mode”。将模型权重从显存（或者 NPU 内存中）卸载，并丢弃其中的 KV 缓存。&lt;/p&gt;
&lt;!-- more --&gt;

&lt;p&gt;两种 level 不同策略：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;Level&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;Sleep
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;Action:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;Offloads&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;model&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;weights&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;and&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;discards&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;the&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;KV&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;cache.
&lt;a id=&#34;__codelineno-0-4&#34; name=&#34;__codelineno-0-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-5&#34; name=&#34;__codelineno-0-5&#34;&gt;&lt;/a&gt;Memory:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;Model&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;weights&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;are&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;moved&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;to&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;CPU&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;memory&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;KV&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;cache&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;is&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;forgotten.
&lt;a id=&#34;__codelineno-0-6&#34; name=&#34;__codelineno-0-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-7&#34; name=&#34;__codelineno-0-7&#34;&gt;&lt;/a&gt;Use&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;Case:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;Suitable&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;when&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;reusing&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;the&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;same&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;model&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;later.
&lt;a id=&#34;__codelineno-0-8&#34; name=&#34;__codelineno-0-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-9&#34; name=&#34;__codelineno-0-9&#34;&gt;&lt;/a&gt;Note:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;Ensure&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;sufficient&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;CPU&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;memory&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;is&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;available&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;to&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;hold&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;the&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;model&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;weights.
&lt;a id=&#34;__codelineno-0-10&#34; name=&#34;__codelineno-0-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-11&#34; name=&#34;__codelineno-0-11&#34;&gt;&lt;/a&gt;Level&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;Sleep
&lt;a id=&#34;__codelineno-0-12&#34; name=&#34;__codelineno-0-12&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-13&#34; name=&#34;__codelineno-0-13&#34;&gt;&lt;/a&gt;Action:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;Discards&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;both&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;model&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;weights&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;and&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;KV&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;cache.
&lt;a id=&#34;__codelineno-0-14&#34; name=&#34;__codelineno-0-14&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-15&#34; name=&#34;__codelineno-0-15&#34;&gt;&lt;/a&gt;Memory:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;The&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;content&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;of&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;both&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;the&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;model&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;weights&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;and&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;kv&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;cache&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;is&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;forgotten.
&lt;a id=&#34;__codelineno-0-16&#34; name=&#34;__codelineno-0-16&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-17&#34; name=&#34;__codelineno-0-17&#34;&gt;&lt;/a&gt;Use&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;Case:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;Ideal&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;when&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;switching&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;to&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;a&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;different&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;model&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;or&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;updating&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;the&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;current&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;one.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h2 id=&#34;如何使用-sleep-和-wake_up&#34;&gt;如何使用 sleep 和 wake_up?&lt;a class=&#34;headerlink&#34; href=&#34;#如何使用-sleep-和-wake_up&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;在 VLLM 中通过 CuMemAllocator.get_instance()使用 sleep 和 wake_up 方法，实现释放显存和恢复显存。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Python&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;load_model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vllm_config&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_config&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;enable_sleep_mode&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;allocator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;CuMemAllocator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-4&#34; name=&#34;__codelineno-1-4&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;k&#34;&gt;assert&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;allocator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_current_usage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-5&#34; name=&#34;__codelineno-1-5&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;s2&#34;&gt;&amp;quot;Sleep mode can only be &amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-6&#34; name=&#34;__codelineno-1-6&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;s2&#34;&gt;&amp;quot;used for one instance per process.&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-7&#34; name=&#34;__codelineno-1-7&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;context&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;allocator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;use_memory_pool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tag&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;weights&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-8&#34; name=&#34;__codelineno-1-8&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-9&#34; name=&#34;__codelineno-1-9&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;kn&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;contextlib&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;nullcontext&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-10&#34; name=&#34;__codelineno-1-10&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;context&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;nullcontext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-11&#34; name=&#34;__codelineno-1-11&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;with&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-12&#34; name=&#34;__codelineno-1-12&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_runner&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;load_model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-13&#34; name=&#34;__codelineno-1-13&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-1-14&#34; name=&#34;__codelineno-1-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Worker&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;():&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-15&#34; name=&#34;__codelineno-1-15&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-1-16&#34; name=&#34;__codelineno-1-16&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;sleep&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-17&#34; name=&#34;__codelineno-1-17&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;free_bytes_before_sleep&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuda&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mem_get_info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-18&#34; name=&#34;__codelineno-1-18&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-1-19&#34; name=&#34;__codelineno-1-19&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;allocator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;CuMemAllocator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-20&#34; name=&#34;__codelineno-1-20&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;allocator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sleep&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offload_tags&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;weights&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;level&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;tuple&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-21&#34; name=&#34;__codelineno-1-21&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;free_bytes_after_sleep&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;total&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuda&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mem_get_info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-22&#34; name=&#34;__codelineno-1-22&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;freed_bytes&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;free_bytes_after_sleep&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;free_bytes_before_sleep&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-23&#34; name=&#34;__codelineno-1-23&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;used_bytes&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;total&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;free_bytes_after_sleep&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-24&#34; name=&#34;__codelineno-1-24&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;k&#34;&gt;assert&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;freed_bytes&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;Memory usage increased after sleeping.&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-25&#34; name=&#34;__codelineno-1-25&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;logger&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-26&#34; name=&#34;__codelineno-1-26&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;s2&#34;&gt;&amp;quot;Sleep mode freed &lt;/span&gt;&lt;span class=&#34;si&#34;&gt;%.2f&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt; GiB memory, &amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-27&#34; name=&#34;__codelineno-1-27&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;s2&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;%.2f&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt; GiB memory is still in use.&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;freed_bytes&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;/&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;GiB_bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-28&#34; name=&#34;__codelineno-1-28&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;n&#34;&gt;used_bytes&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;/&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;GiB_bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-29&#34; name=&#34;__codelineno-1-29&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-1-30&#34; name=&#34;__codelineno-1-30&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;wake_up&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;tags&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Optional&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;list&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]]&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-31&#34; name=&#34;__codelineno-1-31&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;allocator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;CuMemAllocator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-32&#34; name=&#34;__codelineno-1-32&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;allocator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wake_up&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tags&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;当调用 sleep 方法时，所有具有指定标签的张量都将被卸载(offload)到 CPU 内存中，其余张量将被丢弃(discard)。
当我们调用 wake_up 时，之前卸载的所有张量都将被加载回 GPU 内存，其余张量为空。&lt;/p&gt;
&lt;h2 id=&#34;sleep-和-wake_up-实现&#34;&gt;sleep 和 wake_up 实现&lt;a class=&#34;headerlink&#34; href=&#34;#sleep-和-wake_up-实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;cuda 实现针对 NVIDIA GPU, npu 实现针对华为 Ascend NPU。&lt;/p&gt;
&lt;h3 id=&#34;cuda-实现&#34;&gt;cuda 实现&lt;a class=&#34;headerlink&#34; href=&#34;#cuda-实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;cuda 实现采用 &lt;a href=&#34;https://github.com/vllm-project/vllm/blob/main/vllm/device_allocator/cumem.py#L106-L107&#34; title=&#34;CuMemAllocator 类实现&#34;&gt;CuMemAllocator 类实现&lt;/a&gt;。pointer_to_data 中保存了 ptr 和元数据。&lt;/p&gt;
&lt;p&gt;sleep 方法就是将offload_tags中的数据先offload到cpu，即调用 cudaMemcpy DeviceToHost 拷贝到 cpu 内存中。并且记录下 cpu_backup_tensor，供 wakeup 的时候，将 cpu 内存中的数据拷贝回 gpu 内存中。&lt;/p&gt;
&lt;p&gt;对于没有在 offload_tags 中的数据，sleep 方法会直接丢弃数据，释放显存。调用 unmap_and_release实现。主要是保持用户使用的虚拟地址不变，暂停后释放显存，恢复重新分配显存，绑定到虚拟地址上。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Python&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;sleep&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;n&#34;&gt;offload_tags&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Optional&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Union&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;tuple&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-4&#34; name=&#34;__codelineno-2-4&#34;&gt;&lt;/a&gt;                                         &lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]]&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-5&#34; name=&#34;__codelineno-2-5&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;offload_tags&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;is&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-6&#34; name=&#34;__codelineno-2-6&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;c1&#34;&gt;# by default, allocated tensors are offloaded&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-7&#34; name=&#34;__codelineno-2-7&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;c1&#34;&gt;# when the allocator sleeps&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-8&#34; name=&#34;__codelineno-2-8&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;offload_tags&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CuMemAllocator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;default_tag&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-9&#34; name=&#34;__codelineno-2-9&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;elif&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;isinstance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offload_tags&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-10&#34; name=&#34;__codelineno-2-10&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;offload_tags&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offload_tags&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-11&#34; name=&#34;__codelineno-2-11&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-12&#34; name=&#34;__codelineno-2-12&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;assert&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;isinstance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offload_tags&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;tuple&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-13&#34; name=&#34;__codelineno-2-13&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-14&#34; name=&#34;__codelineno-2-14&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;data&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pointer_to_data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;items&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;():&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-15&#34; name=&#34;__codelineno-2-15&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-16&#34; name=&#34;__codelineno-2-16&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tag&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;offload_tags&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-17&#34; name=&#34;__codelineno-2-17&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;n&#34;&gt;size_in_bytes&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-18&#34; name=&#34;__codelineno-2-18&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;n&#34;&gt;cpu_backup_tensor&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;empty&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-19&#34; name=&#34;__codelineno-2-19&#34;&gt;&lt;/a&gt;                &lt;span class=&#34;n&#34;&gt;size_in_bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-20&#34; name=&#34;__codelineno-2-20&#34;&gt;&lt;/a&gt;                &lt;span class=&#34;n&#34;&gt;dtype&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uint8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-21&#34; name=&#34;__codelineno-2-21&#34;&gt;&lt;/a&gt;                &lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;cpu&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-22&#34; name=&#34;__codelineno-2-22&#34;&gt;&lt;/a&gt;                &lt;span class=&#34;n&#34;&gt;pin_memory&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_pin_memory_available&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-23&#34; name=&#34;__codelineno-2-23&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;n&#34;&gt;cpu_ptr&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;cpu_backup_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data_ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-24&#34; name=&#34;__codelineno-2-24&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;n&#34;&gt;libcudart&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cudaMemcpy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cpu_ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;size_in_bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-25&#34; name=&#34;__codelineno-2-25&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cpu_backup_tensor&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;cpu_backup_tensor&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-26&#34; name=&#34;__codelineno-2-26&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;unmap_and_release&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-27&#34; name=&#34;__codelineno-2-27&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-28&#34; name=&#34;__codelineno-2-28&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;gc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;collect&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-29&#34; name=&#34;__codelineno-2-29&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuda&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;empty_cache&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;wake_up 方法则是调用 create_and_map(handle)实现重新分配显存，并绑定到虚拟地址上。将 offload 的数据从 cpu 拷贝到 gpu 中。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Python&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;wake_up&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;tags&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Optional&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;list&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]]&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;data&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pointer_to_data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;items&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;():&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;tags&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;is&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;or&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tag&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;tags&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-5&#34; name=&#34;__codelineno-3-5&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;n&#34;&gt;create_and_map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-6&#34; name=&#34;__codelineno-3-6&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cpu_backup_tensor&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;is&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-7&#34; name=&#34;__codelineno-3-7&#34;&gt;&lt;/a&gt;                &lt;span class=&#34;n&#34;&gt;cpu_backup_tensor&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cpu_backup_tensor&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-8&#34; name=&#34;__codelineno-3-8&#34;&gt;&lt;/a&gt;                &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;cpu_backup_tensor&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;is&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-9&#34; name=&#34;__codelineno-3-9&#34;&gt;&lt;/a&gt;                    &lt;span class=&#34;n&#34;&gt;size_in_bytes&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;cpu_backup_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;numel&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-10&#34; name=&#34;__codelineno-3-10&#34;&gt;&lt;/a&gt;                    &lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;cpu_backup_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;element_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-11&#34; name=&#34;__codelineno-3-11&#34;&gt;&lt;/a&gt;                    &lt;span class=&#34;n&#34;&gt;cpu_ptr&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;cpu_backup_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data_ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-12&#34; name=&#34;__codelineno-3-12&#34;&gt;&lt;/a&gt;                    &lt;span class=&#34;n&#34;&gt;libcudart&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cudaMemcpy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;cpu_ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;size_in_bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-13&#34; name=&#34;__codelineno-3-13&#34;&gt;&lt;/a&gt;                    &lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cpu_backup_tensor&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;pointer_to_data 元数据：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Python&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;# py_device, py_alignedSize, py_d_mem (保存的用户使用的指针), py_p_memHandle（内存mmap的文件描述符）&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;HandleType&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;tuple&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-3&#34; name=&#34;__codelineno-4-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-4&#34; name=&#34;__codelineno-4-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nd&#34;&gt;@dataclasses&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dataclass&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-5&#34; name=&#34;__codelineno-4-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;AllocationData&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-6&#34; name=&#34;__codelineno-4-6&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;HandleType&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-7&#34; name=&#34;__codelineno-4-7&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;tag&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-8&#34; name=&#34;__codelineno-4-8&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;cpu_backup_tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Optional&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;# offload到cpu的tensor&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;python 调用底层 c++实现，和&lt;strong&gt;torch_memory_saver&lt;/strong&gt;原理完全一致。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Python&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;create_and_map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocation_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;HandleType&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;python_create_and_map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocation_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-3&#34; name=&#34;__codelineno-5-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-4&#34; name=&#34;__codelineno-5-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-5&#34; name=&#34;__codelineno-5-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;unmap_and_release&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocation_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;HandleType&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-6&#34; name=&#34;__codelineno-5-6&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;python_unmap_and_release&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocation_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;c++实现查看&lt;a href=&#34;https://github.com/vllm-project/vllm/blob/main/csrc/cumem_allocator.cpp#L297&#34; title=&#34;cumem_allocator.cpp&#34;&gt;cumem_allocator.cpp&lt;/a&gt;。&lt;/p&gt;
&lt;h3 id=&#34;ascend-npu-的实现&#34;&gt;Ascend NPU 的实现&lt;a class=&#34;headerlink&#34; href=&#34;#ascend-npu-的实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;主要通过&lt;a href=&#34;https://github.com/vllm-project/vllm-ascend/blob/main/vllm_ascend/device_allocator/camem.py&#34; title=&#34;CaMemAllocator 类的实现&#34;&gt;CaMemAllocator 类实现&lt;/a&gt;。python 调用底层 c++实现。和 cuda 实现的区别就是 sleep 中的 unmap_and_release 函数、wake_up 中的 create_and_map 函数实现不一样。&lt;/p&gt;
&lt;p&gt;具体实现可以参考&lt;a href=&#34;https://github.com/vllm-project/vllm-ascend/blob/main/csrc/camem_allocator.cpp&#34; title=&#34;camem_allocator.cpp&#34;&gt;camem_allocator.cpp&lt;/a&gt;，使用 Ascend NPU 的 aclrt 实现了保存指针 aclrtReserveMemAddress、内存映射等 API。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-40&#34;&gt;40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-41&#34;&gt;41&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-42&#34;&gt;42&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-43&#34;&gt;43&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-44&#34;&gt;44&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-45&#34;&gt;45&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-46&#34;&gt;46&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;create_and_map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;long&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;long&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;ssize_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d_mem&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-2&#34; name=&#34;__codelineno-6-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;aclrtDrvMemHandle&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_memHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-3&#34; name=&#34;__codelineno-6-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ensure_context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-4&#34; name=&#34;__codelineno-6-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Define memory allocation properties&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-5&#34; name=&#34;__codelineno-6-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;aclrtPhysicalMemProp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prop&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{};&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-6&#34; name=&#34;__codelineno-6-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handleType&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ACL_MEM_HANDLE_TYPE_NONE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-7&#34; name=&#34;__codelineno-6-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocationType&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ACL_MEM_ALLOCATION_TYPE_PINNED&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-8&#34; name=&#34;__codelineno-6-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memAttr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ACL_HBM_MEM_HUGE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-9&#34; name=&#34;__codelineno-6-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;location&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-10&#34; name=&#34;__codelineno-6-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;location&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ACL_MEM_LOCATION_TYPE_DEVICE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-11&#34; name=&#34;__codelineno-6-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;reserve&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-12&#34; name=&#34;__codelineno-6-12&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-6-13&#34; name=&#34;__codelineno-6-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Allocate memory using aclrtMallocPhysical&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-14&#34; name=&#34;__codelineno-6-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;aclError&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;error_code&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;aclrtMallocPhysical&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_memHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-15&#34; name=&#34;__codelineno-6-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;error_code&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-16&#34; name=&#34;__codelineno-6-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cerr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;acl Error, code: &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;error_code&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot; at &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__FILE__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;:&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;\
&lt;a id=&#34;__codelineno-6-17&#34; name=&#34;__codelineno-6-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__LINE__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-18&#34; name=&#34;__codelineno-6-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-19&#34; name=&#34;__codelineno-6-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-20&#34; name=&#34;__codelineno-6-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;error_code&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;aclrtMapMem&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d_mem&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_memHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-21&#34; name=&#34;__codelineno-6-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;error_code&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-22&#34; name=&#34;__codelineno-6-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cerr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;acl Error, code: &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;error_code&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot; at &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__FILE__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;:&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;\
&lt;a id=&#34;__codelineno-6-23&#34; name=&#34;__codelineno-6-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__LINE__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-24&#34; name=&#34;__codelineno-6-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-25&#34; name=&#34;__codelineno-6-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-26&#34; name=&#34;__codelineno-6-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-27&#34; name=&#34;__codelineno-6-27&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-6-28&#34; name=&#34;__codelineno-6-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;unmap_and_release&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;long&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;long&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;ssize_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-29&#34; name=&#34;__codelineno-6-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                       &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d_mem&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-30&#34; name=&#34;__codelineno-6-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                       &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;aclrtDrvMemHandle&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_memHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-31&#34; name=&#34;__codelineno-6-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// std::cout &amp;lt;&amp;lt; &amp;quot;unmap_and_release: device=&amp;quot; &amp;lt;&amp;lt; device &amp;lt;&amp;lt; &amp;quot;, size=&amp;quot; &amp;lt;&amp;lt; size &amp;lt;&amp;lt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-32&#34; name=&#34;__codelineno-6-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// &amp;quot;, d_mem=&amp;quot; &amp;lt;&amp;lt; d_mem &amp;lt;&amp;lt; &amp;quot;, p_memHandle=&amp;quot; &amp;lt;&amp;lt; p_memHandle &amp;lt;&amp;lt; std::endl;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-33&#34; name=&#34;__codelineno-6-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ensure_context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-34&#34; name=&#34;__codelineno-6-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;aclError&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;error_code&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;aclrtUnmapMem&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d_mem&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-35&#34; name=&#34;__codelineno-6-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;error_code&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-36&#34; name=&#34;__codelineno-6-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cerr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;acl Error, code: &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;error_code&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot; at &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__FILE__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;:&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;\
&lt;a id=&#34;__codelineno-6-37&#34; name=&#34;__codelineno-6-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__LINE__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-38&#34; name=&#34;__codelineno-6-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-39&#34; name=&#34;__codelineno-6-39&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-40&#34; name=&#34;__codelineno-6-40&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;error_code&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;aclrtFreePhysical&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_memHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-41&#34; name=&#34;__codelineno-6-41&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;error_code&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-42&#34; name=&#34;__codelineno-6-42&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cerr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;acl Error, code: &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;error_code&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot; at &amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__FILE__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;:&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;\
&lt;a id=&#34;__codelineno-6-43&#34; name=&#34;__codelineno-6-43&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__LINE__&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-44&#34; name=&#34;__codelineno-6-44&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-45&#34; name=&#34;__codelineno-6-45&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-46&#34; name=&#34;__codelineno-6-46&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;通过 pytorch 插件注册了 NPU 的自定义 my_malloc 和 my_free 函数。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Python&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-7-1&#34; name=&#34;__codelineno-7-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;get_pluggable_allocator&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-2&#34; name=&#34;__codelineno-7-2&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;python_malloc_fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Callable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;tuple&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]],&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-3&#34; name=&#34;__codelineno-7-3&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;python_free_func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Callable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;tuple&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]]&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-4&#34; name=&#34;__codelineno-7-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;npu&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NPUPluggableAllocator&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-5&#34; name=&#34;__codelineno-7-5&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;init_module&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;python_malloc_fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;python_free_func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-6&#34; name=&#34;__codelineno-7-6&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;new_alloc&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;npu&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NPUPluggableAllocator&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lib_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;my_malloc&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-7&#34; name=&#34;__codelineno-7-7&#34;&gt;&lt;/a&gt;                                                       &lt;span class=&#34;s1&#34;&gt;&amp;#39;my_free&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-8&#34; name=&#34;__codelineno-7-8&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;new_alloc&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-9&#34; name=&#34;__codelineno-7-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-10&#34; name=&#34;__codelineno-7-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nd&#34;&gt;@contextmanager&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-11&#34; name=&#34;__codelineno-7-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;use_memory_pool_with_allocator&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-12&#34; name=&#34;__codelineno-7-12&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;python_malloc_fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Callable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;tuple&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]],&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-13&#34; name=&#34;__codelineno-7-13&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;python_free_func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Callable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;tuple&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]]):&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-14&#34; name=&#34;__codelineno-7-14&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;new_alloc&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;get_pluggable_allocator&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;python_malloc_fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;python_free_func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-15&#34; name=&#34;__codelineno-7-15&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;mem_pool&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;npu&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MemPool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new_alloc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_allocator&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-16&#34; name=&#34;__codelineno-7-16&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;with&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;npu&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;use_mem_pool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mem_pool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-17&#34; name=&#34;__codelineno-7-17&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;k&#34;&gt;yield&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;mem_pool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;new_alloc&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;torch_memory_saver 的实现和 vllm 中 sleep_mode 用到的 CuMemAllocator 实现是一样的，除此之外 vllm 针对 npu 实现了 CaMemAllocator，调用的 aclrt 实现。
vllm 的 sleep_mode 除了将 gpu 内存释放，还实现了根据 offload_tags offload 到 cpu（主要是权重）。&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/gpu的pin_memory是什么/&#34; target=&#34;_blank&#34;&gt;GPU的pin_memory是什么？&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c使用abseil-cpp遇到的小问题/&#34; target=&#34;_blank&#34;&gt;C++使用abseil-cpp遇到的小问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/vllm%E6%8E%A8%E7%90%86%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84sleep_mode%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0/</link>
      <pubDate>Sun, 06 Jul 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/vllm%E6%8E%A8%E7%90%86%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84sleep_mode%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0/</guid>
      
    </item>
    
    <item>
      <title>优雅开发篇：git worktree并行分支开发，及一个测量二进程膨胀的rust工具应用</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;h2 id=&#34;git-worktree-是什么&#34;&gt;git worktree 是什么？&lt;a class=&#34;headerlink&#34; href=&#34;#git-worktree-是什么&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Git Worktree 是 Git 提供的一个强大功能，允许你在同一个仓库中&lt;strong&gt;创建多个独立的工作目录&lt;/strong&gt;，每个目录可以关联不同的分支（或者 commit），从而实现并行开发而&lt;strong&gt;无需频繁切换分支或依赖 git stash 暂存代码 ‌&lt;/strong&gt;。&lt;/p&gt;
&lt;!-- more --&gt;

&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/git-worktree.png&#34; /&gt;&lt;/p&gt;
&lt;h3 id=&#34;可以解决什么问题&#34;&gt;可以解决什么问题？&lt;a class=&#34;headerlink&#34; href=&#34;#可以解决什么问题&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;没有使用 worktree 的同学，假设在 dev 分支上开发，开发了一半，需要切换到 release 分支修复 bug，那么需要：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;保存当前分支的状态，比如 git commit 或者 git stash。&lt;/li&gt;
&lt;li&gt;切换到 release 分支，切一个 hotfix 分支，修复 bug，提交。&lt;/li&gt;
&lt;li&gt;切换回来继续开发。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;或者：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;git clone repo 到另一个目录，修复 bug。&lt;/li&gt;
&lt;li&gt;切换回原目录，继续开发。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;缺点就是：&lt;/p&gt;
&lt;p&gt;第一，这样很麻烦，切来切去。&lt;/p&gt;
&lt;p&gt;第二，占地方，多个 repo 拷贝占磁盘空间。&lt;/p&gt;
&lt;p&gt;第三，如果 2 个版本分支的工程依赖环境差异较大，导致每次切换分支后，工程都都需要重新安装依赖以及做全量编译——这无疑增加了编译时间，导致开发效率下降。&lt;/p&gt;
&lt;h3 id=&#34;有什么优势&#34;&gt;有什么优势？&lt;a class=&#34;headerlink&#34; href=&#34;#有什么优势&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;针对这个痛点， Git Worktree 出现了, 它具有下面的优势：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;不需要提交或者暂存代码，就可以切换分支。面对多个分支的代码不需要频繁切换。&lt;/li&gt;
&lt;li&gt;每个工作区共享同一个版本仓库信息，更节省硬盘空间。&lt;/li&gt;
&lt;li&gt;各个工作区之间的更新同步更快，git clone 方式下，A 工作区和 B 工作区需要 A commit-&amp;gt; A push -&amp;gt; B pull。git worktree 方式下，A 工作区只要本地提交更新后，其他工作区就能立即收到（因为它们共享同一个版本仓库）。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;通过一个例子学习使用-git-worktree&#34;&gt;通过一个例子学习使用 git worktree&lt;a class=&#34;headerlink&#34; href=&#34;#通过一个例子学习使用-git-worktree&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&#34;git-worktree如何使用&#34;&gt;git worktree如何使用&lt;a class=&#34;headerlink&#34; href=&#34;#git-worktree如何使用&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;假设我们有个 helloworld 的仓库：https://github.com/KenForever1/helloworld。&lt;/p&gt;
&lt;p&gt;当前工作在 dev 分支上，想要在 release 分支修复 bug，那么就可以使用 git worktree，而无需切换分支。&lt;/p&gt;
&lt;p&gt;为release分支增加一个worktree：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nb&#34;&gt;cd&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;/workspace/helloworld
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;git&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;worktree&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;add&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;../release-branch&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;release
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;进入release分支的worktree目录，修复bug:
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nb&#34;&gt;cd&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;../release-branch
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;//&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;fix&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;your&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;bug&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;here
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;查看当前 worktree 列表：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;git&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;worktree&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;list
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;/workspace/helloworld&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;main&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;/workspace/release-branch&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;release-branch&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;切换回 dev 分支，删除 release 分支：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nb&#34;&gt;cd&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;../dev-branch
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;git&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;worktree&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;remove&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;release-branch
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;其他命令&#34;&gt;其他命令&lt;a class=&#34;headerlink&#34; href=&#34;#其他命令&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;删除除了 remove 命令，还可以手动删除目录，然后 git worktree 会自动清理&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;rm&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-rf&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;../release-branch
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;git&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;worktree&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;prune
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;ol&gt;
&lt;li&gt;锁定与解锁 ‌&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;git&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;worktree&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;lock&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;releas-branch&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;--reason&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;维护中&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;# 解锁‌&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-3&#34; name=&#34;__codelineno-5-3&#34;&gt;&lt;/a&gt;git&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;worktree&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;unlock&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;releas-branch
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;锁定了以后，git worktree remove 会报错，需要先解锁。&lt;/p&gt;
&lt;h2 id=&#34;一个测量二进制膨胀的-rust-小工具&#34;&gt;一个测量二进制膨胀的 rust 小工具&lt;a class=&#34;headerlink&#34; href=&#34;#一个测量二进制膨胀的-rust-小工具&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&#34;设计原理&#34;&gt;设计原理&lt;a class=&#34;headerlink&#34; href=&#34;#设计原理&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;下面介绍的一个 rust 工具测量二进制膨胀（Measures bloat）的小工具：
&lt;a href=&#34;https://github.com/facet-rs/limpid/blob/HEAD/limpid/src/main.rs&#34; title=&#34;facet-rs/limpid&#34;&gt;facet-rs/limpid&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;一个是当前 HEAD（目前开发的新特性），一个是 main 分支（已经发布的版本）。目的是想对比分析两个目录下的编译构建耗时，二进制大小差异等。
为了实现这个功能，针对 HEAD 开发目录，创建了一个 worktree 目录，命名为 main。对比分析完成后，删除 worktree 目录。&lt;/p&gt;
&lt;p&gt;因为对比的仓库&lt;a href=&#34;https://github.com/facet-rs/facet&#34; title=&#34;facet-rs/facet&#34;&gt;facet-rs/facet&lt;/a&gt;，是一个 rust 序列化库 crate，可以理解和 serde 差不多。
在 limpid 工具中，包括了创建 worktree 和编译统计信息的代码，另一个就是使用 facet 库的例子，采用相对目录引用 facet。所以只要保持层级一致，就可以使用不同分支的 facet 库。&lt;/p&gt;
&lt;p&gt;工作目录的结构如下：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;facet/&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# facet库HEAD分支&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-2&#34; name=&#34;__codelineno-6-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;facet/
&lt;a id=&#34;__codelineno-6-3&#34; name=&#34;__codelineno-6-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;Cargo.toml
&lt;a id=&#34;__codelineno-6-4&#34; name=&#34;__codelineno-6-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;facet-core/
&lt;a id=&#34;__codelineno-6-5&#34; name=&#34;__codelineno-6-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;Cargo.toml
&lt;a id=&#34;__codelineno-6-6&#34; name=&#34;__codelineno-6-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;facet-reflect/
&lt;a id=&#34;__codelineno-6-7&#34; name=&#34;__codelineno-6-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;Cargo.toml
&lt;a id=&#34;__codelineno-6-8&#34; name=&#34;__codelineno-6-8&#34;&gt;&lt;/a&gt;limpid/&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# limpid工具&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-9&#34; name=&#34;__codelineno-6-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;limpid/&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# limpid工具&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-10&#34; name=&#34;__codelineno-6-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;Cargo.toml&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# this tool&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-11&#34; name=&#34;__codelineno-6-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;kitchensink/&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# 使用facet库的例子，可以编译成二进制程序&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-12&#34; name=&#34;__codelineno-6-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;ks-facet/
&lt;a id=&#34;__codelineno-6-13&#34; name=&#34;__codelineno-6-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;Cargo.toml&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# 相对目录方式，引用../facet库&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-14&#34; name=&#34;__codelineno-6-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;ks-serde/
&lt;a id=&#34;__codelineno-6-15&#34; name=&#34;__codelineno-6-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;Cargo.toml
&lt;a id=&#34;__codelineno-6-16&#34; name=&#34;__codelineno-6-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;ks-facet-json-read/
&lt;a id=&#34;__codelineno-6-17&#34; name=&#34;__codelineno-6-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# etc.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;对比的 main worktree 目录。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-7-1&#34; name=&#34;__codelineno-7-1&#34;&gt;&lt;/a&gt;/tmp/
&lt;a id=&#34;__codelineno-7-2&#34; name=&#34;__codelineno-7-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;limpid-main-workspace/
&lt;a id=&#34;__codelineno-7-3&#34; name=&#34;__codelineno-7-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;facet/&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# worktree from facet repo at main branch&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-4&#34; name=&#34;__codelineno-7-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;facet/
&lt;a id=&#34;__codelineno-7-5&#34; name=&#34;__codelineno-7-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;facet-core/
&lt;a id=&#34;__codelineno-7-6&#34; name=&#34;__codelineno-7-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;facet-reflect/
&lt;a id=&#34;__codelineno-7-7&#34; name=&#34;__codelineno-7-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;limpid/&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# worktree from limpid repo at current HEAD&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-8&#34; name=&#34;__codelineno-7-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;limpid/
&lt;a id=&#34;__codelineno-7-9&#34; name=&#34;__codelineno-7-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;kitchensink/
&lt;a id=&#34;__codelineno-7-10&#34; name=&#34;__codelineno-7-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;ks-facet/
&lt;a id=&#34;__codelineno-7-11&#34; name=&#34;__codelineno-7-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;ks-serde/
&lt;a id=&#34;__codelineno-7-12&#34; name=&#34;__codelineno-7-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;ks-facet-json-read/
&lt;a id=&#34;__codelineno-7-13&#34; name=&#34;__codelineno-7-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# etc.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;通过，这个工具我们可以学习 worktree 的用法，也可以学习到一些工具的设计理念。与语言无关，你也可以用 python 或 c++以及其他语言实现。&lt;/p&gt;
&lt;h3 id=&#34;杂谈&#34;&gt;杂谈&lt;a class=&#34;headerlink&#34; href=&#34;#杂谈&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;这个例子如果你想学习 rust 也可以参考，里面有很多常用的不错的 crate 使用，比如：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-8-1&#34; name=&#34;__codelineno-8-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nv&#34;&gt;anyhow&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;1.0&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# 用于错误处理&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-2&#34; name=&#34;__codelineno-8-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nv&#34;&gt;substance&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;0.7.1&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# https://github.com/fasterthanlime/substance.git，检查二进制文件的符号、分析二进制文件的大小构成&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-3&#34; name=&#34;__codelineno-8-3&#34;&gt;&lt;/a&gt;owo-colors&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;4.0&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# 用于命令行输出彩色字&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-4&#34; name=&#34;__codelineno-8-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nv&#34;&gt;indicatif&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;0.17&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# 进度条&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-5&#34; name=&#34;__codelineno-8-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nv&#34;&gt;camino&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;1.1.10&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# Utf8路径支持，Path和PathBuf更好的包装&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-6&#34; name=&#34;__codelineno-8-6&#34;&gt;&lt;/a&gt;pico-args&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;0.5.0&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# 命令行参数解析，比clap更轻量&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;顺便提一句，针对刚刚提到的 substance rust 工具，google 也有个 c++工具&lt;a href=&#34;https://github.com/google/bloaty&#34; title=&#34;Bloaty&#34;&gt;Bloaty&lt;/a&gt;。可以解决是什么让你的二进制文件变得这么大？&lt;strong&gt;Bloaty 会为你展示二进制文件的大小分布&lt;/strong&gt;，这样你就能了解其中是什么占用了空间。&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/fish如何增加和删除环境变量path为什么没有fish_remove_path方法删除环境变量/&#34; target=&#34;_blank&#34;&gt;fish如何增加和删除环境变量PATH？为什么没有fish_remove_path方法删除环境变量&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c静态库和动态库全局变量初始化有何不同/&#34; target=&#34;_blank&#34;&gt;c++静态库和动态库全局变量初始化有何不同？&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c20如何实现一个基于属性测试的quickcheck-cpp库/&#34; target=&#34;_blank&#34;&gt;C++20如何实现一个基于属性测试的quickcheck-cpp库&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/%E4%BC%98%E9%9B%85%E5%BC%80%E5%8F%91%E7%AF%87git-worktree%E5%B9%B6%E8%A1%8C%E5%88%86%E6%94%AF%E5%BC%80%E5%8F%91%E5%8F%8A%E4%B8%80%E4%B8%AA%E6%B5%8B%E9%87%8F%E4%BA%8C%E8%BF%9B%E7%A8%8B%E8%86%A8%E8%83%80%E7%9A%84rust%E5%B7%A5%E5%85%B7%E5%BA%94%E7%94%A8/</link>
      <pubDate>Tue, 01 Jul 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/%E4%BC%98%E9%9B%85%E5%BC%80%E5%8F%91%E7%AF%87git-worktree%E5%B9%B6%E8%A1%8C%E5%88%86%E6%94%AF%E5%BC%80%E5%8F%91%E5%8F%8A%E4%B8%80%E4%B8%AA%E6%B5%8B%E9%87%8F%E4%BA%8C%E8%BF%9B%E7%A8%8B%E8%86%A8%E8%83%80%E7%9A%84rust%E5%B7%A5%E5%85%B7%E5%BA%94%E7%94%A8/</guid>
      
    </item>
    
    <item>
      <title>C++技法:模板元编程编译期获取类成员数量</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;p&gt;C++反射中，有个必要的就是需要获取一个类的成员个数，然后就可以根据个数，将类的成员通过std::tie转换成tuple。继而可以实现equal、hash、serialize等功能。&lt;/p&gt;
&lt;!-- more --&gt;

&lt;h3 id=&#34;基本原理&#34;&gt;基本原理&lt;a class=&#34;headerlink&#34; href=&#34;#基本原理&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;本文介绍分析如何获取一个类的成员个数的方法，通过模板元编程实现，基本原理：
+ &lt;strong&gt;编译时计算&lt;/strong&gt;结构体成员数量&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;使用&lt;strong&gt;SFINAE&lt;/strong&gt;技术，通过&lt;strong&gt;递归实例化arity_impl模板来探测&lt;/strong&gt;结构体能接受的最大参数数量&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;通过一个instance类提供&lt;strong&gt;到任意类型的隐式转换&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;核心代码实现&#34;&gt;核心代码实现&lt;a class=&#34;headerlink&#34; href=&#34;#核心代码实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;核心代码如下：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#pragma once&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;type_traits&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;namespace&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;detail&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-4&#34; name=&#34;__codelineno-0-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-5&#34; name=&#34;__codelineno-0-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// instance类的作用：定义了operator函数，提供到任意类型的隐式转换操作符，用于模拟构造Aggregate类型时所需的任意类型参数&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-6&#34; name=&#34;__codelineno-0-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-7&#34; name=&#34;__codelineno-0-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-8&#34; name=&#34;__codelineno-0-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;operator&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-9&#34; name=&#34;__codelineno-0-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-10&#34; name=&#34;__codelineno-0-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-11&#34; name=&#34;__codelineno-0-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Aggregate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;IndexSequence&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;index_sequence&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-12&#34; name=&#34;__codelineno-0-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-13&#34; name=&#34;__codelineno-0-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;arity_impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IndexSequence&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{};&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-14&#34; name=&#34;__codelineno-0-14&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-15&#34; name=&#34;__codelineno-0-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 特化版本&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-16&#34; name=&#34;__codelineno-0-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Aggregate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Indices&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-17&#34; name=&#34;__codelineno-0-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;arity_impl&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Aggregate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;index_sequence&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Indices&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-18&#34; name=&#34;__codelineno-0-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;void_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;decltype&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Aggregate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-19&#34; name=&#34;__codelineno-0-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Indices&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;declval&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())...,&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-20&#34; name=&#34;__codelineno-0-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;declval&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()})&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-21&#34; name=&#34;__codelineno-0-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;arity_impl&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Aggregate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-22&#34; name=&#34;__codelineno-0-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                 &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;index_sequence&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Indices&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Indices&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{};&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-23&#34; name=&#34;__codelineno-0-23&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-24&#34; name=&#34;__codelineno-0-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// namespace detail&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-25&#34; name=&#34;__codelineno-0-25&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-26&#34; name=&#34;__codelineno-0-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-27&#34; name=&#34;__codelineno-0-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;arity&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-28&#34; name=&#34;__codelineno-0-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 使用decay_t去除类型修饰（如const/volatile/引用）&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-29&#34; name=&#34;__codelineno-0-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;detail&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;arity_impl&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;decay_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-30&#34; name=&#34;__codelineno-0-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;首先，对上面的代码进行拆解，分细节进行讨论：&lt;/p&gt;
&lt;h4 id=&#34;细节1-构造aggregate对象逗号表达式&#34;&gt;细节1: 构造Aggregate对象+逗号表达式&lt;a class=&#34;headerlink&#34; href=&#34;#细节1-构造aggregate对象逗号表达式&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;Aggregate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Indices&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;declval&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())...,&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;declval&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
这段代码尝试构造Aggregate对象，通过不断增加参数数量直到编译失败，从而确定最大有效参数数量。&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Indices&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;declval&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
这段代码通过std::declval&amp;lt;instance&amp;gt;()生成一个instance对象，并通过static_cast&amp;lt;void&amp;gt;(Indices)来避免编译器警告。这里还用到了一个技术，就是c++中的逗号表达式。&lt;/p&gt;
&lt;p&gt;C++中的逗号表达式是一种特殊的运算符，它可以将多个表达式连接起来并按顺序求值。逗号表达式的一般形式为：表达式1, 表达式2, &amp;hellip;, 表达式n。其求值过程是从左到右依次计算每个子表达式，最终整个表达式的值为最后一个表达式（表达式n）的值。例如：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// a的值为3&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
结合上面的代码，就只会输入std::declval&amp;lt;instance&amp;gt;()作为参数构造Aggregate对象。&lt;/p&gt;
&lt;p&gt;参数包(Indices, instance)&amp;hellip;生成N个instance，额外添加的instance用于探测边界条件。也就是indices为(0, 1)时，传递3个参数，当indices为(0, 1, 2)时，传递4个参数。&lt;/p&gt;
&lt;h4 id=&#34;细节2sfinae技术void_t表达式合法性检查&#34;&gt;细节2：SFINAE技术+void_t表达式合法性检查&lt;a class=&#34;headerlink&#34; href=&#34;#细节2sfinae技术void_t表达式合法性检查&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;void_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;decltype&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Aggregate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Indices&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;declval&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())...,&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-3&#34; name=&#34;__codelineno-4-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;declval&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()})&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;说明一下这里std::void_t，void_t通常结合SFINAE技术进行元编程的类型诊断与表达式的合法性检查，void_t本身定义非常简单，对于任意类型，乃至可变的参数类型，都重定义为void。&lt;/p&gt;
&lt;p&gt;看个例子你就明白了：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;检测类型成员是否存在
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 泛化版本（默认返回 false）&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-3&#34; name=&#34;__codelineno-5-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;has_type_member&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;false_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{};&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-4&#34; name=&#34;__codelineno-5-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-5&#34; name=&#34;__codelineno-5-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 特化版本（当 T::type 存在时匹配）&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-6&#34; name=&#34;__codelineno-5-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-7&#34; name=&#34;__codelineno-5-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;has_type_member&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;void_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;true_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;若 T 包含 type 成员类型，则特化版本生效，返回 true。
+ 检测函数是否存在&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-2&#34; name=&#34;__codelineno-6-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;has_hello_func&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;false_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{};&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-3&#34; name=&#34;__codelineno-6-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-6-4&#34; name=&#34;__codelineno-6-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-5&#34; name=&#34;__codelineno-6-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;has_hello_func&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;void_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;decltype&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;declval&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hello&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-6-6&#34; name=&#34;__codelineno-6-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;true_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h4 id=&#34;细节3index_sequence的使用&#34;&gt;细节3：index_sequence的使用&lt;a class=&#34;headerlink&#34; href=&#34;#细节3index_sequence的使用&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;std::index_sequence是C++14引入的编译期整数序列工具，主要用于模板元编程中处理参数包和索引操作。&lt;/p&gt;
&lt;p&gt;例如：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-7-1&#34; name=&#34;__codelineno-7-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;I&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-2&#34; name=&#34;__codelineno-7-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_squares&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;index_sequence&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;I&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-3&#34; name=&#34;__codelineno-7-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;array&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;I&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;I&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...};&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-4&#34; name=&#34;__codelineno-7-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-5&#34; name=&#34;__codelineno-7-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;arr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_squares&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_index_sequence&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{});&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// {0,1,4,9,16}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h4 id=&#34;细节4-递归探测的机制&#34;&gt;细节4: 递归探测的机制&lt;a class=&#34;headerlink&#34; href=&#34;#细节4-递归探测的机制&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-9&#34;&gt;9&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-8-1&#34; name=&#34;__codelineno-8-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Aggregate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Indices&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-2&#34; name=&#34;__codelineno-8-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;arity_impl&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Aggregate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;index_sequence&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Indices&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-3&#34; name=&#34;__codelineno-8-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 本次探测的参数列表，用于探测Aggregate能接受的参数数量，参数数量为sizeof...(Indices)+ 1&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-4&#34; name=&#34;__codelineno-8-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;void_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;decltype&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Aggregate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-5&#34; name=&#34;__codelineno-8-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Indices&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;declval&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())...,&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-6&#34; name=&#34;__codelineno-8-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;declval&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()})&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-7&#34; name=&#34;__codelineno-8-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 递归探测，每次递归增加一个参数，增加的参数为sizeof...(Indices)&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-8&#34; name=&#34;__codelineno-8-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;arity_impl&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Aggregate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-9&#34; name=&#34;__codelineno-8-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                 &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;index_sequence&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Indices&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Indices&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;递归探测机制：
+ 从空参数列表开始(std::index_sequence&amp;lt;&amp;gt;)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;每次递归增加一个参数(std::index_sequence&amp;lt;Indices&amp;hellip;, sizeof&amp;hellip;(Indices)&amp;gt;)，比如原来是：std::index_sequence&amp;lt;&amp;gt;，下一次递归变为std::index_sequence&amp;lt;0&amp;gt;，再下一次递归变为std::index_sequence&amp;lt;0, 1&amp;gt;，以此类推。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;当参数数量超过Aggregate类型成员数量时，SFINAE使特化版本失效&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;通过一个例子理解计算过程&#34;&gt;通过一个例子理解计算过程&lt;a class=&#34;headerlink&#34; href=&#34;#通过一个例子理解计算过程&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;arity&amp;lt;T&amp;gt;()函数模板可以返回任意类型T的成员数量，完全在编译期计算，零运行时开销。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-9-1&#34; name=&#34;__codelineno-9-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Point&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;double&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-2&#34; name=&#34;__codelineno-9-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-3&#34; name=&#34;__codelineno-9-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 尝试构造：&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-4&#34; name=&#34;__codelineno-9-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;Point&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-5&#34; name=&#34;__codelineno-9-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 匹配x&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-6&#34; name=&#34;__codelineno-9-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 匹配y &lt;/span&gt;
&lt;a id=&#34;__codelineno-9-7&#34; name=&#34;__codelineno-9-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 触发SFINAE (Point只有2个成员)&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-8&#34; name=&#34;__codelineno-9-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;当参数数量=3时构造失败，递归终止，确定arity=2。&lt;/p&gt;
&lt;p&gt;以结构体Point为例，逐步解释这个模板特化的执行过程：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;第一步, 尝试匹配特化版本（带std::void_t的版本）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-10-1&#34; name=&#34;__codelineno-10-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;arity_impl&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Point&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;index_sequence&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
此时Indices包为空，尝试构造：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-11-1&#34; name=&#34;__codelineno-11-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;Point&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
构造成功（匹配1个成员），触发递归：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;第一次递归：&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-12-1&#34; name=&#34;__codelineno-12-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;arity_impl&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Point&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;index_sequence&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
尝试构造：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-13-1&#34; name=&#34;__codelineno-13-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;Point&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
构造成功（匹配2个成员）, 触发递归&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;第二次递归：&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-14-1&#34; name=&#34;__codelineno-14-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;arity_impl&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Point&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;index_sequence&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;尝试构造：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-15-1&#34; name=&#34;__codelineno-15-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;Point&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;构造失败（超过2个参数）, 递归终止。
最终继承arity_impl&amp;lt;Point, std::index_sequence&amp;lt;0,1&amp;gt;&amp;gt;, size()返回2。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-16-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-16-1&#34; name=&#34;__codelineno-16-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;Point&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{};&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-2&#34; name=&#34;__codelineno-16-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-16-3&#34; name=&#34;__codelineno-16-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;Point&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-4&#34; name=&#34;__codelineno-16-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-16-5&#34; name=&#34;__codelineno-16-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;Point&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-16-6&#34; name=&#34;__codelineno-16-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-16-7&#34; name=&#34;__codelineno-16-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;Point&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// error, 超过2个参数&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;通过这个例子，我们可以看到，通过递归探测，可以确定任意类型的成员数量。&lt;/p&gt;
&lt;p&gt;具体使用：&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-17-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-17-1&#34; name=&#34;__codelineno-17-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(){&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-2&#34; name=&#34;__codelineno-17-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nums&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;arity&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Point&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-3&#34; name=&#34;__codelineno-17-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cout&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nums&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-4&#34; name=&#34;__codelineno-17-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-17-5&#34; name=&#34;__codelineno-17-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
完整例子可以参考&lt;a href=&#34;https://github.com/KenForever1/cpp_idioms/blob/main/cpp/template/main.cpp&#34;&gt;KenForever1/cpp_idioms&lt;/a&gt;。&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c开发常见问题之abi兼容性问题/&#34; target=&#34;_blank&#34;&gt;C++开发常见问题之ABI兼容性问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c技法如何为一个类动态附加任意类型数据/&#34; target=&#34;_blank&#34;&gt;C++技法：如何为一个类动态附加任意类型数据&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c技法iguana序列化库中如何实现enum-reflection反射/&#34; target=&#34;_blank&#34;&gt;C++技法：iguana序列化库中如何实现enum reflection反射&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/c%E6%8A%80%E6%B3%95%E6%A8%A1%E6%9D%BF%E5%85%83%E7%BC%96%E7%A8%8B%E7%BC%96%E8%AF%91%E6%9C%9F%E8%8E%B7%E5%8F%96%E7%B1%BB%E6%88%90%E5%91%98%E6%95%B0%E9%87%8F/</link>
      <pubDate>Sun, 29 Jun 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/c%E6%8A%80%E6%B3%95%E6%A8%A1%E6%9D%BF%E5%85%83%E7%BC%96%E7%A8%8B%E7%BC%96%E8%AF%91%E6%9C%9F%E8%8E%B7%E5%8F%96%E7%B1%BB%E6%88%90%E5%91%98%E6%95%B0%E9%87%8F/</guid>
      
    </item>
    
    <item>
      <title>C++零拷贝反序列化库cista</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;h2 id=&#34;c零拷贝反序列化库cista&#34;&gt;C++零拷贝反序列化库cista&lt;a class=&#34;headerlink&#34; href=&#34;#c零拷贝反序列化库cista&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;在阅读Candle（rust的机器学习库）时，看到了rust中利用mmap和Cow机制实现零拷贝反序列化加载模型的tensor。&lt;/p&gt;
&lt;p&gt;其中为了解决mmap的数据生命周期为&amp;rsquo;a, 如果用Cow&amp;lt;&amp;rsquo;a&amp;gt;引用mmap返回的指针, 使用的生命周期如果超过&amp;rsquo;a则不能使用，不利于代码开发和引用。因此引入了yoke crate擦除生命周期。&lt;/p&gt;
&lt;p&gt;借此，搜索了一下c++的零拷贝反序列化库，找到了&lt;a href=&#34;https://github.com/felixguendling/cista&#34;&gt;cista&lt;/a&gt;。&lt;/p&gt;
&lt;!-- more --&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;namespace&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;offset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MODE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// opt. versioning + check sum&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mode&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;WITH_VERSION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mode&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;WITH_INTEGRITY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-4&#34; name=&#34;__codelineno-0-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-5&#34; name=&#34;__codelineno-0-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;pos&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-6&#34; name=&#34;__codelineno-0-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;using&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pos_map&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Automatic deduction of hash &amp;amp; equality&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-7&#34; name=&#34;__codelineno-0-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_map&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vector&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pos&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-8&#34; name=&#34;__codelineno-0-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                   &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_set&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-9&#34; name=&#34;__codelineno-0-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-10&#34; name=&#34;__codelineno-0-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Serialize.&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-11&#34; name=&#34;__codelineno-0-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;positions&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-12&#34; name=&#34;__codelineno-0-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pos_map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{{{{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}},&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;hello&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;cista&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}},&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-13&#34; name=&#34;__codelineno-0-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{{{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}},&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;hello&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;world&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}}};&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-14&#34; name=&#34;__codelineno-0-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;data&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}};&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-15&#34; name=&#34;__codelineno-0-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;serialize&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MODE&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;positions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-16&#34; name=&#34;__codelineno-0-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-17&#34; name=&#34;__codelineno-0-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-18&#34; name=&#34;__codelineno-0-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Deserialize.&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-19&#34; name=&#34;__codelineno-0-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;data&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;protection&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;READ&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-20&#34; name=&#34;__codelineno-0-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;positions&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;deserialize&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pos_map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MODE&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;它有两种模式：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;namespace&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;raw&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;和&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;namespace&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;offset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
在data命名空间下，实现了hashmap、hashset、string、vector等数据结构，支持判断相等、hash等。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;为什么offset方式相比raw方式速度更快？&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;hashmap如何实现的？&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;offset和raw方式&#34;&gt;offset和raw方式&lt;a class=&#34;headerlink&#34; href=&#34;#offset和raw方式&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Offset Based Data Structures&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;+ can be read without any deserialization step (i.e. reinterpret_cast&lt;T&gt; is sufficient).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;+ suitable for shared memory applications&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;- slower at runtime (pointers need to be resolved using one more add)&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Raw Data Structures&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;- deserialize step takes time (but still very fast also for GBs of data)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;- the buffer containing the serialized data needs to be modified&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;+ fast runtime access (raw access)&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们简单过一下代码实现，有兴趣的朋友可以阅读源码，代码很清晰。&lt;/p&gt;
&lt;h2 id=&#34;零拷贝反序列化&#34;&gt;零拷贝反序列化&lt;a class=&#34;headerlink&#34; href=&#34;#零拷贝反序列化&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;零拷贝主要使用了mmap方式，将文件映射到进程地址空间，直接通过指针访问文件内容。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mode&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Mode&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;kDefaultMode&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;write&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;filesystem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;w&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-4&#34; name=&#34;__codelineno-2-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;generic_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;protection&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;WRITE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-5&#34; name=&#34;__codelineno-2-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;writer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buf&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;move&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-6&#34; name=&#34;__codelineno-2-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;serialize&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Mode&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;writer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;w&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-7&#34; name=&#34;__codelineno-2-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-8&#34; name=&#34;__codelineno-2-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-9&#34; name=&#34;__codelineno-2-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mode&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Mode&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;kDefaultMode&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-10&#34; name=&#34;__codelineno-2-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;write&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;filesystem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wrapped&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;w&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-11&#34; name=&#34;__codelineno-2-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;write&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Mode&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;w&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-12&#34; name=&#34;__codelineno-2-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-13&#34; name=&#34;__codelineno-2-13&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-14&#34; name=&#34;__codelineno-2-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mode&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Mode&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;kDefaultMode&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-15&#34; name=&#34;__codelineno-2-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wrapped&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;read&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;filesystem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-16&#34; name=&#34;__codelineno-2-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;file&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;generic_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;r&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;content&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-17&#34; name=&#34;__codelineno-2-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;deserialize&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Mode&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-18&#34; name=&#34;__codelineno-2-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory_holder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;move&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)};&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-19&#34; name=&#34;__codelineno-2-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wrapped&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;move&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-20&#34; name=&#34;__codelineno-2-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-21&#34; name=&#34;__codelineno-2-21&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-22&#34; name=&#34;__codelineno-2-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mode&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Mode&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;kDefaultMode&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-23&#34; name=&#34;__codelineno-2-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wrapped&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;read_mmap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;filesystem&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-24&#34; name=&#34;__codelineno-2-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-25&#34; name=&#34;__codelineno-2-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;generic_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;protection&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;READ&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-26&#34; name=&#34;__codelineno-2-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;deserialize&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Mode&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-27&#34; name=&#34;__codelineno-2-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory_holder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;move&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mmap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)}};&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-28&#34; name=&#34;__codelineno-2-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wrapped&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;move&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mem&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-29&#34; name=&#34;__codelineno-2-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h2 id=&#34;hashmap实现&#34;&gt;hashmap实现&lt;a class=&#34;headerlink&#34; href=&#34;#hashmap实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&#34;swiss-table实现&#34;&gt;swiss table实现&lt;a class=&#34;headerlink&#34; href=&#34;#swiss-table实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;参考了&lt;a href=&#34;https://abseil.io/blog/20180927-swisstables&#34;&gt;abseil的swiss tables&lt;/a&gt;实现，在原先实现的上删除了多余的功能。&lt;/p&gt;
&lt;p&gt;swiss table从用法上分为两类：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;absl::flat_hash_map and absl::flat_hash_set&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;flat方式将value_type存储在容器的主数组中，以避免内存间接寻址。由于它们在重新哈希时会移动数据，因此元素无法保持指针稳定性。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://abseil.io/img/flat_hash_map.svg&#34; /&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;absl::node_hash_map and absl::node_hash_set&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;追求指针稳定性，或者你的值很大，就采用node方式。&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://abseil.io/img/node_hash_map.svg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://abseil.io/blog/20180927-swisstables&#34;&gt;blog/20180927-swisstables&lt;/a&gt;中介绍，更推荐使用 absl::flat_hash_map&amp;lt;K, std::unique_ptr&amp;lt;V&amp;gt;&amp;gt;方式替代 absl::node_hash_map&amp;lt;K, V&amp;gt;。&lt;/p&gt;
&lt;h3 id=&#34;hash_storage实现&#34;&gt;hash_storage实现&lt;a class=&#34;headerlink&#34; href=&#34;#hash_storage实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;hashmap和hashset的核心实现是&lt;strong&gt;hash_storage&lt;/strong&gt; struct, hash_storage采用&lt;strong&gt;swiss_table&lt;/strong&gt;实现。在后面的文章的介绍。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;namespace&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;raw&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Hash&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hashing&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Eq&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;equal_to&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;using&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_map&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-5&#34; name=&#34;__codelineno-3-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_storage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pair&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Value&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_first&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_second&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Hash&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Eq&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-6&#34; name=&#34;__codelineno-3-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// namespace raw&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-7&#34; name=&#34;__codelineno-3-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-8&#34; name=&#34;__codelineno-3-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;namespace&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;offset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-9&#34; name=&#34;__codelineno-3-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Hash&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hashing&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-10&#34; name=&#34;__codelineno-3-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Eq&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;equal_to&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-11&#34; name=&#34;__codelineno-3-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;using&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_map&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-12&#34; name=&#34;__codelineno-3-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_storage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pair&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Value&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_first&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_second&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Hash&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Eq&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-13&#34; name=&#34;__codelineno-3-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// namespace offset&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-14&#34; name=&#34;__codelineno-3-14&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-15&#34; name=&#34;__codelineno-3-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;namespace&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;offset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-16&#34; name=&#34;__codelineno-3-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Hash&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hashing&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Eq&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;equal_to&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-17&#34; name=&#34;__codelineno-3-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;using&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_storage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;identity&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;identity&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Hash&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Eq&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-18&#34; name=&#34;__codelineno-3-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// namespace offset&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h2 id=&#34;string的实现&#34;&gt;string的实现&lt;a class=&#34;headerlink&#34; href=&#34;#string的实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;根据string的大小，分为两种实现，小的用stack，大的用heap, short_length_limit是16字节。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;generate_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;heap&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-3&#34; name=&#34;__codelineno-4-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_short_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-4&#34; name=&#34;__codelineno-4-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;self_allocated_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-5&#34; name=&#34;__codelineno-4-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint16_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__fill__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-6&#34; name=&#34;__codelineno-4-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint32_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-7&#34; name=&#34;__codelineno-4-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Ptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-8&#34; name=&#34;__codelineno-4-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-9&#34; name=&#34;__codelineno-4-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-10&#34; name=&#34;__codelineno-4-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;stack&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-11&#34; name=&#34;__codelineno-4-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;union&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-12&#34; name=&#34;__codelineno-4-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_short_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-13&#34; name=&#34;__codelineno-4-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CharT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__fill__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-14&#34; name=&#34;__codelineno-4-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-15&#34; name=&#34;__codelineno-4-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CharT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;short_length_limit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-16&#34; name=&#34;__codelineno-4-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-17&#34; name=&#34;__codelineno-4-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-18&#34; name=&#34;__codelineno-4-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;union&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-19&#34; name=&#34;__codelineno-4-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;heap&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;h_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-20&#34; name=&#34;__codelineno-4-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stack&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-21&#34; name=&#34;__codelineno-4-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-22&#34; name=&#34;__codelineno-4-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;分为两种情况，own和non_own。也就是管理内存还是不管理内存。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;owning_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;owning&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{};&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-3&#34; name=&#34;__codelineno-5-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;non_owning_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-4&#34; name=&#34;__codelineno-5-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;non_owning&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;如果要从non_owning转换成owning，则需要调用std::memcpy。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;msize_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;short_length_limit&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15U&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CharT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-2&#34; name=&#34;__codelineno-6-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-6-3&#34; name=&#34;__codelineno-6-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;set_owning&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CharT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;msize_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-4&#34; name=&#34;__codelineno-6-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;reset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-5&#34; name=&#34;__codelineno-6-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-6&#34; name=&#34;__codelineno-6-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-7&#34; name=&#34;__codelineno-6-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-8&#34; name=&#34;__codelineno-6-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_short_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;short_length_limit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-9&#34; name=&#34;__codelineno-6-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_short_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-10&#34; name=&#34;__codelineno-6-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memcpy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CharT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-11&#34; name=&#34;__codelineno-6-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;short_length_limit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-12&#34; name=&#34;__codelineno-6-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-13&#34; name=&#34;__codelineno-6-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-14&#34; name=&#34;__codelineno-6-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-15&#34; name=&#34;__codelineno-6-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;h_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CharT&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;malloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CharT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)));&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-16&#34; name=&#34;__codelineno-6-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;h_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-17&#34; name=&#34;__codelineno-6-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;throw_exception&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bad_alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{});&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-18&#34; name=&#34;__codelineno-6-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-19&#34; name=&#34;__codelineno-6-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;h_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-20&#34; name=&#34;__codelineno-6-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;h_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;self_allocated_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-21&#34; name=&#34;__codelineno-6-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memcpy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CharT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-22&#34; name=&#34;__codelineno-6-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-23&#34; name=&#34;__codelineno-6-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h2 id=&#34;其它序列化库&#34;&gt;其它序列化库&lt;a class=&#34;headerlink&#34; href=&#34;#其它序列化库&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Protocol Buffers&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Cap’n Proto&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://flatbuffers.dev/languages/rust/&#34;&gt;Flatbuffers&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;cereal&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Boost Serialization&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;MessagePack&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/cista零拷贝反序列化库实现之swiss_table哈希表实现/&#34; target=&#34;_blank&#34;&gt;cista零拷贝反序列化库实现之swiss_table哈希表实现&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c开发常见问题之abi兼容性问题/&#34; target=&#34;_blank&#34;&gt;C++开发常见问题之ABI兼容性问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/fast-pimpl-又是什么技法/&#34; target=&#34;_blank&#34;&gt;Fast PIMPL 又是什么技法？&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/c%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93cista/</link>
      <pubDate>Sat, 28 Jun 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/c%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93cista/</guid>
      
    </item>
    
    <item>
      <title>cista零拷贝反序列化库实现之swiss_table--group匹配位运算</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;h2 id=&#34;swiss-table中group的实现解析&#34;&gt;Swiss Table中Group的实现解析&lt;a class=&#34;headerlink&#34; href=&#34;#swiss-table中group的实现解析&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;这个&lt;code&gt;group&lt;/code&gt;结构体是Swiss Table实现中的核心组件，用于高效处理哈希表控制位的批量操作。&lt;/p&gt;
&lt;!-- more --&gt;

&lt;p&gt;定义核心常量，用于位运算：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MSBS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x8080808080808080ULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 每个字节的最高位掩码&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LSBS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x0101010101010101ULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 每个字节的最低位掩码&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GAPS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00FEFEFEFEFEFEFEULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 用于计算前导空位的掩码&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
构造函数：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-9&#34;&gt;9&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;using&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint64_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;using&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;h2_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint8_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-1-4&#34; name=&#34;__codelineno-1-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;explicit&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pos&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-5&#34; name=&#34;__codelineno-1-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memcpy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pos&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;WIDTH&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-6&#34; name=&#34;__codelineno-1-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#if defined(CISTA_BIG_ENDIAN)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-7&#34; name=&#34;__codelineno-1-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endian_swap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-8&#34; name=&#34;__codelineno-1-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#endif&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-9&#34; name=&#34;__codelineno-1-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
* 从指定位置拷贝8个控制字节到&lt;code&gt;ctrl_&lt;/code&gt;成员
* 大端系统需要做字节序转换&lt;/p&gt;
&lt;h2 id=&#34;关键匹配方法&#34;&gt;关键匹配方法&lt;a class=&#34;headerlink&#34; href=&#34;#关键匹配方法&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&#34;match方法---匹配特定h2值&#34;&gt;&lt;code&gt;match&lt;/code&gt;方法 - 匹配特定h2值&lt;a class=&#34;headerlink&#34; href=&#34;#match方法---匹配特定h2值&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;bit_mask&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;h2_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;^&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LSBS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bit_mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LSBS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MSBS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-4&#34; name=&#34;__codelineno-2-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
* 通过位运算同时检查8个控制字节是否匹配给定的h2值
* 算法原理：
  1. &lt;code&gt;LSBS * hash&lt;/code&gt;：将h2值复制到每个字节
  2. &lt;code&gt;ctrl_ ^ ...&lt;/code&gt;：异或操作找出匹配的字节
  3. &lt;code&gt;(x - LSBS) &amp;amp; ~x &amp;amp; MSBS&lt;/code&gt;：精确定位匹配的字节&lt;/p&gt;
&lt;h4 id=&#34;通过一个例子来理解match&#34;&gt;通过一个例子来理解&lt;code&gt;match&lt;/code&gt;：&lt;a class=&#34;headerlink&#34; href=&#34;#通过一个例子来理解match&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;相关例子实现源码&lt;a href=&#34;https://github.com/KenForever1/cpp_idioms/blob/main/cpp/swiss_table/bit_verify_match.cpp&#34;&gt;KenForever1/cpp_idioms&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;让我们通过一个具体例子来说明match方法的位运算过程。假设：&lt;/p&gt;
&lt;p&gt;当前group的8个控制字节为：[0x12, 0x34, 0x56, 0x78, 0x12, 0x9A, EMPTY, DELETED]&lt;/p&gt;
&lt;p&gt;对应ctrl_值：0xFE80129A78563412 (小端序)&lt;/p&gt;
&lt;p&gt;EMPTY = 0x80, DELETED = 0xFE&lt;/p&gt;
&lt;p&gt;要匹配的h2值为：0x12&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;===&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;开始匹配过程&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;===&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;控制字节&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff809a1278563412&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x34&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x56&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x78&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x9a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nl&#34;&gt;匹配的h2值&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;LSBS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x1212121212121212&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-3-5&#34; name=&#34;__codelineno-3-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;^&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LSBS&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xed9288006a442600&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x26&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x44&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x6a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x88&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x92&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-3-6&#34; name=&#34;__codelineno-3-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LSBS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xec9186ff694324ff&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x24&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x43&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x69&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x86&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x91&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xec&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-3-7&#34; name=&#34;__codelineno-3-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x126d77ff95bbd9ff&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xd9&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xbb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x95&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x77&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x6d&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-3-8&#34; name=&#34;__codelineno-3-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LSBS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x000106ff010300ff&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x03&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x06&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-3-9&#34; name=&#34;__codelineno-3-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;最终结果&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x0000008000000080&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-3-10&#34; name=&#34;__codelineno-3-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-11&#34; name=&#34;__codelineno-3-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;===&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;匹配结果&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;===&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-12&#34; name=&#34;__codelineno-3-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;匹配掩码&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x0000008000000080&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-3-13&#34; name=&#34;__codelineno-3-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nl&#34;&gt;匹配的字节位置&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;match_empty方法---匹配空槽位&#34;&gt;&lt;code&gt;match_empty&lt;/code&gt;方法 - 匹配空槽位&lt;a class=&#34;headerlink&#34; href=&#34;#match_empty方法---匹配空槽位&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;bit_mask&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;match_empty&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bit_mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MSBS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-3&#34; name=&#34;__codelineno-4-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;通过位运算找出EMPTY(-128)控制字节&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;利用了EMPTY的特殊位模式(10000000)&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;通过一个例子来理解match_empty&#34;&gt;通过一个例子来理解&lt;code&gt;match_empty&lt;/code&gt;&lt;a class=&#34;headerlink&#34; href=&#34;#通过一个例子来理解match_empty&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;假设我们有以下控制字节组（小端序排列）：
[0x12, 0x34, EMPTY, 0x56, DELETED, EMPTY, 0x78, END]&lt;/p&gt;
&lt;p&gt;EMPTY = 0x80&lt;/p&gt;
&lt;p&gt;DELETED = 0xFE&lt;/p&gt;
&lt;p&gt;END = 0xFF&lt;/p&gt;
&lt;p&gt;对应的 64 位 ctrl_ 值为：0xFF8078FE56803412&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;===&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;match_empty&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;示例&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;===&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;原始控制字节&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff7880fe56803412&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x34&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x56&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x78&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-5-3&#34; name=&#34;__codelineno-5-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00877f01a97fcbed&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xcb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x7f&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xa9&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x7f&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x87&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-5-4&#34; name=&#34;__codelineno-5-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x21dfc06a5ff2fb40&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x40&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xf2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x5f&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x6a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xc0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xdf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-5-5&#34; name=&#34;__codelineno-5-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x2158806a56803000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x30&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x56&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x6a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x58&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-5-6&#34; name=&#34;__codelineno-5-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;最终结果&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x0000800000800000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-5-7&#34; name=&#34;__codelineno-5-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-8&#34; name=&#34;__codelineno-5-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nl&#34;&gt;匹配的EMPTY位置&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;match_empty_or_deleted方法&#34;&gt;&lt;code&gt;match_empty_or_deleted&lt;/code&gt;方法&lt;a class=&#34;headerlink&#34; href=&#34;#match_empty_or_deleted方法&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;bit_mask&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;match_empty_or_deleted&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-2&#34; name=&#34;__codelineno-6-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bit_mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MSBS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-3&#34; name=&#34;__codelineno-6-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;类似&lt;code&gt;match_empty&lt;/code&gt;但匹配EMPTY或DELETED状态&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;利用了这两种状态的高位都是1的特性&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;通过一个例子来理解match_empty_or_deleted&#34;&gt;通过一个例子来理解&lt;code&gt;match_empty_or_deleted&lt;/code&gt;&lt;a class=&#34;headerlink&#34; href=&#34;#通过一个例子来理解match_empty_or_deleted&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;假设我们有以下控制字节组（小端序排列）：
[0x12, 0x34, EMPTY, 0x56, DELETED, EMPTY, 0x78, END]&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-9&#34;&gt;9&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-7-1&#34; name=&#34;__codelineno-7-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nl&#34;&gt;shift_pos&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-2&#34; name=&#34;__codelineno-7-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;===&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;match_empty&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;示例&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;===&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-3&#34; name=&#34;__codelineno-7-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;原始控制字节&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff7880fe56803412&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x34&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x56&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x78&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-7-4&#34; name=&#34;__codelineno-7-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00877f01a97fcbed&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xcb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x7f&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xa9&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x7f&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x87&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-7-5&#34; name=&#34;__codelineno-7-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;$shift_pos$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x43bf80d4bfe5f680&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xf6&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xe5&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xbf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xd4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xbf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x43&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-7-6&#34; name=&#34;__codelineno-7-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;$shift_pos$&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x433880d416803400&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x34&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x16&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xd4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x38&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x43&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-7-7&#34; name=&#34;__codelineno-7-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;最终结果&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x0000808000800000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-7-8&#34; name=&#34;__codelineno-7-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-9&#34; name=&#34;__codelineno-7-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nl&#34;&gt;匹配的EMPTY位置&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;count_leading_empty_or_deleted方法&#34;&gt;&lt;code&gt;count_leading_empty_or_deleted&lt;/code&gt;方法&lt;a class=&#34;headerlink&#34; href=&#34;#count_leading_empty_or_deleted方法&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-8-1&#34; name=&#34;__codelineno-8-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;count_leading_empty_or_deleted&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-2&#34; name=&#34;__codelineno-8-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;trailing_zeros&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(((&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GAPS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-3&#34; name=&#34;__codelineno-8-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;计算前导的EMPTY或DELETED槽位数量&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;用于探测序列中快速跳过连续无效槽位&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;使用方法：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-9-1&#34; name=&#34;__codelineno-9-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;skip_empty_or_deleted&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-2&#34; name=&#34;__codelineno-9-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;while&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_empty_or_deleted&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-3&#34; name=&#34;__codelineno-9-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shift&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;count_leading_empty_or_deleted&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-4&#34; name=&#34;__codelineno-9-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shift&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-5&#34; name=&#34;__codelineno-9-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;entry_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shift&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-6&#34; name=&#34;__codelineno-9-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-7&#34; name=&#34;__codelineno-9-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-10-1&#34; name=&#34;__codelineno-10-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;===&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;示例1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;===&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-2&#34; name=&#34;__codelineno-10-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;原始控制字节&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff788056fe803412&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x12&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x34&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x56&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x78&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-10-3&#34; name=&#34;__codelineno-10-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x01fef100adfd0068&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x68&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfd&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xad&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xf1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-10-4&#34; name=&#34;__codelineno-10-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00877fa9017fcbed&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xcb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x7f&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xa9&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x7f&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x87&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-10-5&#34; name=&#34;__codelineno-10-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00867100017d0068&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x68&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x7d&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x71&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x86&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-10-6&#34; name=&#34;__codelineno-10-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GAPS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00fefffefffffefe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-10-7&#34; name=&#34;__codelineno-10-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00fefffefffffeff&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-10-8&#34; name=&#34;__codelineno-10-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nl&#34;&gt;trailing_zeros&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-9&#34; name=&#34;__codelineno-10-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;前导EMPTY&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DELETED数量&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-10&#34; name=&#34;__codelineno-10-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-10-11&#34; name=&#34;__codelineno-10-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;===&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;示例2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;===&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-12&#34; name=&#34;__codelineno-10-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;原始控制字节&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xffbc9a785680fe80&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x80&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x56&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x78&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x9a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xbc&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-10-13&#34; name=&#34;__codelineno-10-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x01ff7934f0ad01fd&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfd&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xad&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xf0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x34&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x79&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-10-14&#34; name=&#34;__codelineno-10-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00436587a97f017f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x7f&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x7f&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xa9&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x87&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x65&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x43&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-10-15&#34; name=&#34;__codelineno-10-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;~&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00436104a02d017d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x7d&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x2d&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xa0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x04&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x61&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x43&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-10-16&#34; name=&#34;__codelineno-10-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GAPS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00fffffefeffffff&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-10-17&#34; name=&#34;__codelineno-10-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00fffffeff000000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xfe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xff&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x00&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-10-18&#34; name=&#34;__codelineno-10-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nl&#34;&gt;trailing_zeros&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;24&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-19&#34; name=&#34;__codelineno-10-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;前导EMPTY&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DELETED数量&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
可以看到，为了采用位运算，加快计算速度，在控制字节中，EMPTY = 0x80，DELETED = 0xFE，END = 0xFF的数值都是经过特殊设计的。&lt;/p&gt;
&lt;h3 id=&#34;bit_mask结构解析&#34;&gt;bit_mask结构解析&lt;a class=&#34;headerlink&#34; href=&#34;#bit_mask结构解析&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;bit_mask&lt;/code&gt;是Swiss Table中用于高效处理位掩码的辅助结构，主要功能是迭代和操作64位掩码中的匹配位。&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-11-1&#34; name=&#34;__codelineno-11-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;group_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 64位掩码，每个字节代表一个控制字节的状态&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-2&#34; name=&#34;__codelineno-11-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SHIFT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 用于字节索引位移(8=2^3)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
迭代器和掩码操作，实现了类似迭代器的接口，可以在范围for循环中使用：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-12-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-12-1&#34; name=&#34;__codelineno-12-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;bit_mask&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;operator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-2&#34; name=&#34;__codelineno-12-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 清除最低位的1&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-3&#34; name=&#34;__codelineno-12-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;this&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-4&#34; name=&#34;__codelineno-12-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-5&#34; name=&#34;__codelineno-12-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-12-6&#34; name=&#34;__codelineno-12-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;size_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;operator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-12-7&#34; name=&#34;__codelineno-12-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;trailing_zeros&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 返回当前最低位1的字节位置&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-8&#34; name=&#34;__codelineno-12-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-9&#34; name=&#34;__codelineno-12-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-12-10&#34; name=&#34;__codelineno-12-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;explicit&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;operator&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-12-11&#34; name=&#34;__codelineno-12-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 判断是否有匹配&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-12&#34; name=&#34;__codelineno-12-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-13&#34; name=&#34;__codelineno-12-13&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-12-14&#34; name=&#34;__codelineno-12-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;bit_mask&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;begin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;this&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-12-15&#34; name=&#34;__codelineno-12-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;bit_mask&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bit_mask&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;位操作&#34;&gt;位操作&lt;a class=&#34;headerlink&#34; href=&#34;#位操作&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;trailing_zeros&lt;/code&gt;: 计算最低位1的位置(以字节为单位)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;leading_zeros&lt;/code&gt;: 计算最高位1的位置(以字节为单位)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;都使用了位运算优化，通过位移转换位索引到字节索引&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-13-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-13-1&#34; name=&#34;__codelineno-13-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;size_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;trailing_zeros&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-2&#34; name=&#34;__codelineno-13-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ::cista::trailing_zeros(mask_) 返回的是最低位1的位置(以bit为单位)&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-3&#34; name=&#34;__codelineno-13-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 这里 &amp;gt;&amp;gt; SHIFT 是将bit索引转换为字节索引&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-4&#34; name=&#34;__codelineno-13-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;trailing_zeros&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SHIFT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-5&#34; name=&#34;__codelineno-13-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-6&#34; name=&#34;__codelineno-13-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-13-7&#34; name=&#34;__codelineno-13-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;size_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;leading_zeros&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-8&#34; name=&#34;__codelineno-13-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;total_significant_bits&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SHIFT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 64&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-9&#34; name=&#34;__codelineno-13-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;extra_bits&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;total_significant_bits&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-10&#34; name=&#34;__codelineno-13-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cista&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;leading_zeros&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mask_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;extra_bits&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SHIFT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-11&#34; name=&#34;__codelineno-13-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-12&#34; name=&#34;__codelineno-13-12&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-13-13&#34; name=&#34;__codelineno-13-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;//         00000000 000000000 00000000 00000000&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-14&#34; name=&#34;__codelineno-13-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// bit索引： 1-8 9-16 17-24 25-32&lt;/span&gt;
&lt;a id=&#34;__codelineno-13-15&#34; name=&#34;__codelineno-13-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 字节索引： 1 2 3 4&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-14-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-14-1&#34; name=&#34;__codelineno-14-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-2&#34; name=&#34;__codelineno-14-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;trailing_zeros&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-3&#34; name=&#34;__codelineno-14-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-4&#34; name=&#34;__codelineno-14-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__builtin_ctzll&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-5&#34; name=&#34;__codelineno-14-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 32bit&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-6&#34; name=&#34;__codelineno-14-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__builtin_ctz&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-7&#34; name=&#34;__codelineno-14-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-14-8&#34; name=&#34;__codelineno-14-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;这个函数作用是返回输入数二进制表示从最低位开始(右起)的连续的0的个数；如果传入0则行为未定义。通过__builtin_ctzll实现。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-15-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-15-1&#34; name=&#34;__codelineno-15-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-2&#34; name=&#34;__codelineno-15-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;leading_zeros&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-3&#34; name=&#34;__codelineno-15-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-4&#34; name=&#34;__codelineno-15-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__builtin_clzll&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-5&#34; name=&#34;__codelineno-15-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 32bit&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-6&#34; name=&#34;__codelineno-15-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__builtin_clz&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-7&#34; name=&#34;__codelineno-15-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-15-8&#34; name=&#34;__codelineno-15-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;这个函数作用是返回输入数二进制表示从最高位开始(左起)的连续的0的个数；如果传入0则行为未定义。通过__builtin_clzll实现。&lt;/p&gt;
&lt;h2 id=&#34;总结&#34;&gt;总结&lt;a class=&#34;headerlink&#34; href=&#34;#总结&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;通过位运算并行处理，虽然未使用实际SIMD指令，但通过64位整数运算模拟了并行处理8个控制字节的效果。所有操作都通过&lt;strong&gt;精心设计的位运算&lt;/strong&gt;完成，避免了分支和循环。&lt;strong&gt;内存局部性&lt;/strong&gt;：控制字节连续存储，充分利用CPU缓存。&lt;strong&gt;状态快速判断&lt;/strong&gt;：可以一次性判断整个group的状态(全空/部分匹配等)。通过这些设计，使得Swiss Table在查找、插入等操作上获得高吞吐量。&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c使用abseil-cpp遇到的小问题/&#34; target=&#34;_blank&#34;&gt;C++使用abseil-cpp遇到的小问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c技法如何为一个类动态附加任意类型数据/&#34; target=&#34;_blank&#34;&gt;C++技法：如何为一个类动态附加任意类型数据&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c20如何实现一个基于属性测试的quickcheck-cpp库/&#34; target=&#34;_blank&#34;&gt;C++20如何实现一个基于属性测试的quickcheck-cpp库&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/cista%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93%E5%AE%9E%E7%8E%B0%E4%B9%8Bswiss_table--group%E5%8C%B9%E9%85%8D%E4%BD%8D%E8%BF%90%E7%AE%97/</link>
      <pubDate>Sat, 28 Jun 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/cista%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93%E5%AE%9E%E7%8E%B0%E4%B9%8Bswiss_table--group%E5%8C%B9%E9%85%8D%E4%BD%8D%E8%BF%90%E7%AE%97/</guid>
      
    </item>
    
    <item>
      <title>cista零拷贝反序列化库实现之swiss_table哈希表实现</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;p&gt;朋友们，大家好！上文我们介绍了&lt;a href=&#34;https://mp.weixin.qq.com/s/KENr2Q4HoU9R75L-l95uoQ&#34;&gt;C++零拷贝反序列化库 cista&lt;/a&gt;，今天接着介绍一下 cista 库的实现。&lt;/p&gt;
&lt;h2 id=&#34;swiss_table实现原理&#34;&gt;swiss_table实现原理&lt;a class=&#34;headerlink&#34; href=&#34;#swiss_table实现原理&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;可以从cista库的介绍中看到如下内容：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Comes with a serializable high-performance hash map and hash set implementation based on Google&amp;rsquo;s Swiss Table technique.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;swiss table的实现可以参考&lt;a href=&#34;https://www.cnblogs.com/apocelipes/p/17562468.html&#34;&gt;简单了解下最近正火的SwissTable&lt;/a&gt;，讲解的很清晰。&lt;/p&gt;
&lt;p&gt;本小节大多数内容是站在巨人肩膀上，引用&lt;a href=&#34;https://www.cnblogs.com/apocelipes/p/17562468.html&#34;&gt;简单了解下最近正火的SwissTable&lt;/a&gt;，加上作者结合cista库的介绍。&lt;/p&gt;
&lt;p&gt;以三种实现hashmap的方式，看优缺点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;链表法：指针稳定性，能采取扩容之外的手段阻止查询性能退化，比如把过长链表转换成搜索树。缺点：缓存不够友好，冲突较多的时候缓存命中率较低从而影响性能。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;线性探测法：缓存友好，加上冲突会有连锁影响，没有指针稳定性。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;!-- more --&gt;

&lt;p&gt;swiss table是为了改进哈希表本身的结构力求在缓存友好、性能和内存用量上找到平衡。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;swisstable拥有惊人性能的主要原因：它尽量避免线性探测法导致的大量等值比较和链表法会带来的缓存命中率低下，以及在单位时间内它能同时过滤N个（通常为16，因为16x8=128，是大多数平台上SIMD指令专用的向量寄存器的大小）元素，且可以用位运算代替对数据的遍历。这会为哈希表的吞吐量带来质的飞跃。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;改进的线性探测方式，分group处理，可以SIMD指令加速处理。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;swiss table采用了 &lt;strong&gt;control控制信息 和 slot存储数据&lt;/strong&gt; 分离的方式进行存储。相比链式，数据局部性更好。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;hash一共64位，57位为h1，用于锁定是slot位置。7位为h2，作为key。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;resize扩容2倍。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;控制信息contrl中，下面的定义，表示了三种状态，都是1开头。如果是0开头，后面就是7位h2数据。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;enum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;ctrl_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int8_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;EMPTY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;-128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 10000000&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DELETED&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;-2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 11111110&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-4&#34; name=&#34;__codelineno-0-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;-1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 11111111&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-5&#34; name=&#34;__codelineno-0-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;abseil的实现中，文章里也提到了，采用了SSE（SIMD指令）进行加速，一次同时比较一个Group（16个slot）。在cista中，没有实现SSE。&lt;/p&gt;
&lt;p&gt;引用文章中的一张图说明swiss_table存储布局：&lt;/p&gt;
&lt;p&gt;&lt;img alt=&#34;&#34; src=&#34;https://raw.githubusercontent.com/KenForever1/CDN/main/swiss_table.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;在cista中通过位运算并行处理，虽然未使用实际SIMD指令，但通过64位整数运算模拟了并行处理8个控制字节的效果。
+ 所有操作都通过&lt;strong&gt;精心设计的位运算&lt;/strong&gt;完成，避免了分支和循环。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;内存局部性&lt;/strong&gt;：控制字节连续存储，充分利用CPU缓存。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;状态快速判断&lt;/strong&gt;：可以一次性判断整个group的状态(全空/部分匹配等)。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;通过这些设计，使得Swiss Table在查找、插入等操作上获得高吞吐量。在hashmap的实现中，哈希函数的算法也很重要，一个更加高效“完美哈希函数”，可以减少冲突，减少等值比较，提高性能。&lt;/p&gt;
&lt;h2 id=&#34;cista中swiss_table哈希表实现&#34;&gt;cista中swiss_table哈希表实现&lt;a class=&#34;headerlink&#34; href=&#34;#cista中swiss_table哈希表实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&#34;find查找实现&#34;&gt;find查找实现&lt;a class=&#34;headerlink&#34; href=&#34;#find查找实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;find_impl实现如下，可以看到通过h1确定查找的group，然后通过h2进行匹配，判断key相等，返回iterator。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;iterator&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;find_impl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;compute_hash&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-4&#34; name=&#34;__codelineno-1-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;seq&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;probe_seq&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;h1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;capacity_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;seq&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;next&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-5&#34; name=&#34;__codelineno-1-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;g&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;seq&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offset_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-6&#34; name=&#34;__codelineno-1-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;g&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;h2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-7&#34; name=&#34;__codelineno-1-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Eq&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GetKey&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;entries_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;seq&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)]),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-8&#34; name=&#34;__codelineno-1-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;iterator_at&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;seq&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-9&#34; name=&#34;__codelineno-1-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-10&#34; name=&#34;__codelineno-1-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-11&#34; name=&#34;__codelineno-1-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;g&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;match_empty&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-12&#34; name=&#34;__codelineno-1-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-13&#34; name=&#34;__codelineno-1-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-14&#34; name=&#34;__codelineno-1-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;
&lt;a id=&#34;__codelineno-1-15&#34; name=&#34;__codelineno-1-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
由于control信息和slot信息的index是一一对应的，因此iterator中保持的ctrl和entry的指针，获取value，就是*entry_。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;iterator&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;reference&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;operator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;noexcept&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;entry_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-4&#34; name=&#34;__codelineno-2-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;entry_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-5&#34; name=&#34;__codelineno-2-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;删除、插入操作的逻辑感兴趣的朋友推荐阅读&lt;a href=&#34;https://github.com/felixguendling/cista/blob/master/include/cista/containers/hash_storage.h&#34;&gt;cista hashstorage源码&lt;/a&gt;，希望本文可以帮助你更加快速理解实现。&lt;/p&gt;
&lt;h3 id=&#34;核心存储结构的初始化&#34;&gt;核心存储结构的初始化&lt;a class=&#34;headerlink&#34; href=&#34;#核心存储结构的初始化&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;核心存储结构entries_的初始化代码如下，保存了slot数据和control数据。WIDTH为8，ALIGNMENT为alignof(T)。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;WIDTH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8U&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constexpr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ALIGNMENT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;alignof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;initialize_entries&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-5&#34; name=&#34;__codelineno-3-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;self_allocated_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-6&#34; name=&#34;__codelineno-3-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// capacity_ * sizeof(T)  保存slot数据&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-7&#34; name=&#34;__codelineno-3-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// (capacity_ + 1U + WIDTH) * sizeof(ctrl_t) 保存control信息，加上后面的padding对齐&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-8&#34; name=&#34;__codelineno-3-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size_type&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-9&#34; name=&#34;__codelineno-3-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;capacity_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;capacity_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1U&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;WIDTH&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-10&#34; name=&#34;__codelineno-3-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;entries_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;reinterpret_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-11&#34; name=&#34;__codelineno-3-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CISTA_ALIGNED_ALLOC&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ALIGNMENT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)));&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-12&#34; name=&#34;__codelineno-3-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;entries_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-13&#34; name=&#34;__codelineno-3-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;throw_exception&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bad_alloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{});&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-14&#34; name=&#34;__codelineno-3-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-15&#34; name=&#34;__codelineno-3-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#if defined(CISTA_ZERO_OUT)&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-16&#34; name=&#34;__codelineno-3-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;entries_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-17&#34; name=&#34;__codelineno-3-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#endif&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-18&#34; name=&#34;__codelineno-3-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;reinterpret_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctrl_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-19&#34; name=&#34;__codelineno-3-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;reinterpret_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint8_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr_cast&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;entries_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-20&#34; name=&#34;__codelineno-3-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;capacity_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sizeof&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-21&#34; name=&#34;__codelineno-3-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;reset_ctrl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-22&#34; name=&#34;__codelineno-3-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;reset_growth_left&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-23&#34; name=&#34;__codelineno-3-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;下篇文章，我将详细介绍Swiss Table中Group的代码实现，group匹配位运算。&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c零拷贝反序列化库cista/&#34; target=&#34;_blank&#34;&gt;C++零拷贝反序列化库cista&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c使用abseil-cpp遇到的小问题/&#34; target=&#34;_blank&#34;&gt;C++使用abseil-cpp遇到的小问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/cista%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93%E5%AE%9E%E7%8E%B0%E4%B9%8Bswiss_table%E5%93%88%E5%B8%8C%E8%A1%A8%E5%AE%9E%E7%8E%B0/</link>
      <pubDate>Sat, 28 Jun 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/cista%E9%9B%B6%E6%8B%B7%E8%B4%9D%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93%E5%AE%9E%E7%8E%B0%E4%B9%8Bswiss_table%E5%93%88%E5%B8%8C%E8%A1%A8%E5%AE%9E%E7%8E%B0/</guid>
      
    </item>
    
    <item>
      <title>C++技法：如何为一个类动态附加任意类型数据</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;h2 id=&#34;c技法如何为一个类动态附加任意类型数据&#34;&gt;C++技法：如何为一个类动态附加任意类型数据&lt;a class=&#34;headerlink&#34; href=&#34;#c技法如何为一个类动态附加任意类型数据&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;在设计一个类时，类的成员就固定下来了。但是某些场景下，需要扩展类的成员，但是又不想改变类的定义。这种情况怎么办呢？&lt;/p&gt;
&lt;!-- more --&gt;
&lt;p&gt;有一些方法：
+ 在设计类时，增加一些保留字段，留待后面使用。
+ 在类中可以存储std::string，存储json数据之类的，如果要增加数据，可以存储到string中。
+ 另外就是本文介绍的，利用类型擦除技术，通过std::shared_ptr&amp;lt;void&amp;gt;存储数据，可以存储任意类型的数据。&lt;/p&gt;
&lt;p&gt;C++可以通过std::shared_ptr&amp;lt;void&amp;gt;实现为一个类动态附加任意类型数据。可以用于需要存储不同类型数据但希望统一管理的场景。
std::shared_ptr&amp;lt;void&amp;gt;通过类型擦除机制，可以持有任意类型的指针，同时利用引用计数自动管理内存生命周期。&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shared_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_shared&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;42&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 存储int类型&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_shared&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Hello&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 动态替换为string类型&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
使用时需通过std::dynamic_pointer_cast或std::static_pointer_cast将void指针转换回具体类型，确保类型安全。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;strPtr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;static_pointer_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;strPtr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* 安全使用 */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h2 id=&#34;一个例子看超实用的使用方法&#34;&gt;一个例子看超实用的使用方法&lt;a class=&#34;headerlink&#34; href=&#34;#一个例子看超实用的使用方法&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;详细实现，参考开源地址&lt;a href=&#34;https://github.com/KenForever1/attachment_set/tree/main&#34;&gt;KenForever1/attachment_set&lt;/a&gt;, 只需要100行头文件实现。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 定义容器，可以是你需要扩展的类的成员变量&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;AttachmentSet&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;attachments&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-4&#34; name=&#34;__codelineno-2-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 存储附件&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-5&#34; name=&#34;__codelineno-2-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;attachments&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MyClass&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;obj&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_shared&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MyClass&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-6&#34; name=&#34;__codelineno-2-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;attachments&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;value&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_shared&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;42&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-7&#34; name=&#34;__codelineno-2-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-8&#34; name=&#34;__codelineno-2-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 获取附件&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-9&#34; name=&#34;__codelineno-2-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;attachments&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MyClass&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;obj&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-10&#34; name=&#34;__codelineno-2-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;doSomething&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-11&#34; name=&#34;__codelineno-2-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-12&#34; name=&#34;__codelineno-2-12&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-13&#34; name=&#34;__codelineno-2-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 类型检查&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-14&#34; name=&#34;__codelineno-2-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;attachments&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;value&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-15&#34; name=&#34;__codelineno-2-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 安全操作...&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-16&#34; name=&#34;__codelineno-2-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-17&#34; name=&#34;__codelineno-2-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-18&#34; name=&#34;__codelineno-2-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 遍历附件&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-19&#34; name=&#34;__codelineno-2-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;attachments&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;begin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;attachments&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-20&#34; name=&#34;__codelineno-2-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MyClass&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-21&#34; name=&#34;__codelineno-2-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;obj&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MyClass&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-22&#34; name=&#34;__codelineno-2-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-23&#34; name=&#34;__codelineno-2-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h2 id=&#34;核心方法实现&#34;&gt;核心方法实现&lt;a class=&#34;headerlink&#34; href=&#34;#核心方法实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&#34;attachmentset类实现&#34;&gt;AttachmentSet类实现&lt;a class=&#34;headerlink&#34; href=&#34;#attachmentset类实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;如果把扩展存储的数据称为附件，如果要存储多个附件，肯定要用容器去装。这里可以用vector存储，还能利用上iterator迭代器。&lt;/p&gt;
&lt;p&gt;最简单的就是std::vector&amp;lt;std::shared_ptr&amp;lt;void&amp;gt;&amp;gt;成员变量，也可以存储为any，通过any_cast进行转换，用于存储附件。&lt;/p&gt;
&lt;p&gt;除了存储数据，还要存储查找的索引Key，以及用于对比类型的typeid, 也可以是typeid(T).hash_code()。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;AttachmentSet&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;TypeInfo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 通过typeid(T).hash_code()匹配和校验类型是否正常&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-5&#34; name=&#34;__codelineno-3-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 类型转换，在存储附件时绑定该函数&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-6&#34; name=&#34;__codelineno-3-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;function&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shared_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;any&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;caster&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-7&#34; name=&#34;__codelineno-3-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-8&#34; name=&#34;__codelineno-3-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-9&#34; name=&#34;__codelineno-3-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Attachment&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-10&#34; name=&#34;__codelineno-3-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 附件名称&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-11&#34; name=&#34;__codelineno-3-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-12&#34; name=&#34;__codelineno-3-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 附件数据&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-13&#34; name=&#34;__codelineno-3-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;any&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-14&#34; name=&#34;__codelineno-3-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 附件类型信息&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-15&#34; name=&#34;__codelineno-3-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TypeInfo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-16&#34; name=&#34;__codelineno-3-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-17&#34; name=&#34;__codelineno-3-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-18&#34; name=&#34;__codelineno-3-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 存储附件容器&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-19&#34; name=&#34;__codelineno-3-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;using&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Storage&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vector&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Attachment&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-20&#34; name=&#34;__codelineno-3-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;set方法实现&#34;&gt;set方法实现&lt;a class=&#34;headerlink&#34; href=&#34;#set方法实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shared_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-3&#34; name=&#34;__codelineno-4-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TypeInfo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-4&#34; name=&#34;__codelineno-4-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 类型信息&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-5&#34; name=&#34;__codelineno-4-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typeid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_code&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-6&#34; name=&#34;__codelineno-4-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 类型转换函数，杜绝错误类型转换，避免std::bad_any_cast异常&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-7&#34; name=&#34;__codelineno-4-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[](&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;any&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;any_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shared_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-8&#34; name=&#34;__codelineno-4-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-9&#34; name=&#34;__codelineno-4-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-10&#34; name=&#34;__codelineno-4-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;find&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-11&#34; name=&#34;__codelineno-4-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;storage_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-12&#34; name=&#34;__codelineno-4-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-13&#34; name=&#34;__codelineno-4-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_info&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-14&#34; name=&#34;__codelineno-4-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-15&#34; name=&#34;__codelineno-4-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;storage_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;push_back&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;({&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;});&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-16&#34; name=&#34;__codelineno-4-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-17&#34; name=&#34;__codelineno-4-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;get方法实现&#34;&gt;get方法实现&lt;a class=&#34;headerlink&#34; href=&#34;#get方法实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 通过name 查找&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;Storage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;const_iterator&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;find&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-3&#34; name=&#34;__codelineno-5-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;find_if&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;storage_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;begin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;storage_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-4&#34; name=&#34;__codelineno-5-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;](&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;});&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-5&#34; name=&#34;__codelineno-5-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-6&#34; name=&#34;__codelineno-5-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-7&#34; name=&#34;__codelineno-5-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-8&#34; name=&#34;__codelineno-5-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shared_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-9&#34; name=&#34;__codelineno-5-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;find&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-10&#34; name=&#34;__codelineno-5-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 找不到或者类型不匹配，返回nullptr&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-11&#34; name=&#34;__codelineno-5-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;storage_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typeid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_code&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-12&#34; name=&#34;__codelineno-5-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-13&#34; name=&#34;__codelineno-5-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-14&#34; name=&#34;__codelineno-5-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 获取数据&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-15&#34; name=&#34;__codelineno-5-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;static_pointer_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;caster&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-16&#34; name=&#34;__codelineno-5-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;迭代器实现&#34;&gt;迭代器实现&lt;a class=&#34;headerlink&#34; href=&#34;#迭代器实现&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;借助vector，很容器实现迭代器，并且实现了name()、is()、get()方法。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;Iterator&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-2&#34; name=&#34;__codelineno-6-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Storage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;const_iterator&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-3&#34; name=&#34;__codelineno-6-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;public&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-4&#34; name=&#34;__codelineno-6-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;explicit&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Iterator&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Storage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;const_iterator&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-5&#34; name=&#34;__codelineno-6-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-6-6&#34; name=&#34;__codelineno-6-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-7&#34; name=&#34;__codelineno-6-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-6-8&#34; name=&#34;__codelineno-6-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-9&#34; name=&#34;__codelineno-6-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typeid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_code&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-10&#34; name=&#34;__codelineno-6-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-6-11&#34; name=&#34;__codelineno-6-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;typename&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-12&#34; name=&#34;__codelineno-6-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shared_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-13&#34; name=&#34;__codelineno-6-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-14&#34; name=&#34;__codelineno-6-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 获取数据, 从std::any转换成std::shared_ptr&amp;lt;T&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-15&#34; name=&#34;__codelineno-6-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;static_pointer_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;type_info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;caster&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-16&#34; name=&#34;__codelineno-6-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-17&#34; name=&#34;__codelineno-6-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-6-18&#34; name=&#34;__codelineno-6-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Iterator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;operator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;this&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-19&#34; name=&#34;__codelineno-6-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;operator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Iterator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;other&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;other&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-20&#34; name=&#34;__codelineno-6-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c技法模板元编程编译期获取类成员数量/&#34; target=&#34;_blank&#34;&gt;C++技法:模板元编程编译期获取类成员数量&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c使用abseil-cpp遇到的小问题/&#34; target=&#34;_blank&#34;&gt;C++使用abseil-cpp遇到的小问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c技法iguana序列化库中如何实现enum-reflection反射/&#34; target=&#34;_blank&#34;&gt;C++技法：iguana序列化库中如何实现enum reflection反射&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/c%E6%8A%80%E6%B3%95%E5%A6%82%E4%BD%95%E4%B8%BA%E4%B8%80%E4%B8%AA%E7%B1%BB%E5%8A%A8%E6%80%81%E9%99%84%E5%8A%A0%E4%BB%BB%E6%84%8F%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE/</link>
      <pubDate>Sun, 22 Jun 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/c%E6%8A%80%E6%B3%95%E5%A6%82%E4%BD%95%E4%B8%BA%E4%B8%80%E4%B8%AA%E7%B1%BB%E5%8A%A8%E6%80%81%E9%99%84%E5%8A%A0%E4%BB%BB%E6%84%8F%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE/</guid>
      
    </item>
    
    <item>
      <title>torch_memory_saver高性能CUDA内存管理工具实现</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;p&gt;&lt;a href=&#34;https://github.com/fzyzcjy/torch_memory_saver/tree/master&#34;&gt;torch_memory_saver&lt;/a&gt;是一个开源的高性能CUDA内存管理工具，主要功能是允许暂停和恢复PyTorch张量的CUDA内存占用。保持用户使用的虚拟地址不变，暂停后释放显存，恢复重新分配显存，绑定到虚拟地址上。&lt;/p&gt;
&lt;p&gt;本文会介绍核心原理，以及拦截CUDA runtime API的实现。你还可以看到如何实现一个python c++扩展。在sglang大模型推理库中也有使用到这个torch_memory_saver库。&lt;/p&gt;
&lt;!-- more --&gt;

&lt;h2 id=&#34;核心原理和使用示例&#34;&gt;核心原理和使用示例&lt;a class=&#34;headerlink&#34; href=&#34;#核心原理和使用示例&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;内存暂停/恢复功能的核心实现原理:
使用CUDA虚拟内存管理API（cuMemCreate/cuMemMap等）替代常规cudaMalloc, 通过LD_PRELOAD拦截cudaMalloc/cudaFree调用, 在特定region内（例如：在python中可以用with memory_saver.region()语法）分配的内存会被特殊管理。&lt;/p&gt;
&lt;p&gt;使用例子：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Python&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;torch_memory_saver&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;memory_saver&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;torch_memory_saver&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory_saver&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-4&#34; name=&#34;__codelineno-0-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-5&#34; name=&#34;__codelineno-0-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;# 1. For tensors that wants to be paused, create them within `region`&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-6&#34; name=&#34;__codelineno-0-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;with&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;memory_saver&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;region&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;():&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-7&#34; name=&#34;__codelineno-0-7&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;pauseable_tensor&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;full&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1_000_000_000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,),&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;dtype&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uint8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;cuda&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-8&#34; name=&#34;__codelineno-0-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-9&#34; name=&#34;__codelineno-0-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;# 2. After `pause`, CUDA memory is released for those tensors.&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-10&#34; name=&#34;__codelineno-0-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;# For example, check `nvidia-smi`&amp;#39;s memory usage to verify.&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-11&#34; name=&#34;__codelineno-0-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;memory_saver&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pause&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-12&#34; name=&#34;__codelineno-0-12&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-13&#34; name=&#34;__codelineno-0-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;# 3. After `resume`, CUDA memory is re-occupied for those tensors.&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-14&#34; name=&#34;__codelineno-0-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;memory_saver&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;resume&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h2 id=&#34;暂停和恢复实现原理&#34;&gt;暂停和恢复实现原理&lt;a class=&#34;headerlink&#34; href=&#34;#暂停和恢复实现原理&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;下面介绍pause和resume的实现方式：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;pause&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 遍历所有已分配内存&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocation_metadata_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;begin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-4&#34; name=&#34;__codelineno-1-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 1. 取消内存映射 (cuMemUnmap)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-5&#34; name=&#34;__codelineno-1-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 2. 释放底层内存句柄 (cuMemRelease)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-6&#34; name=&#34;__codelineno-1-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 保留虚拟地址空间不释放&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-7&#34; name=&#34;__codelineno-1-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CURESULT_CHECK&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuMemUnmap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CUdeviceptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-8&#34; name=&#34;__codelineno-1-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CURESULT_CHECK&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuMemRelease&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-9&#34; name=&#34;__codelineno-1-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-10&#34; name=&#34;__codelineno-1-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;resume&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 遍历所有已分配内存&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;it&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocation_metadata_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;begin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-4&#34; name=&#34;__codelineno-2-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 1. 创建新的内存句柄 (cuMemCreate)&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-5&#34; name=&#34;__codelineno-2-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 2. 重新映射到原来的虚拟地址 (cuMemMap)&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-6&#34; name=&#34;__codelineno-2-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 3. 设置访问权限 (cuMemSetAccess)&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-7&#34; name=&#34;__codelineno-2-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-8&#34; name=&#34;__codelineno-2-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CUmemGenericAllocationHandle&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;newAllocHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-9&#34; name=&#34;__codelineno-2-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CUDAUtils&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cu_mem_create&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;newAllocHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-10&#34; name=&#34;__codelineno-2-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CURESULT_CHECK&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuMemMap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CUdeviceptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;newAllocHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-11&#34; name=&#34;__codelineno-2-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CUDAUtils&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cu_mem_set_access&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-12&#34; name=&#34;__codelineno-2-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocHandle&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;newAllocHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-13&#34; name=&#34;__codelineno-2-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-14&#34; name=&#34;__codelineno-2-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
使用CUDA虚拟内存API保持虚拟地址不变，因此暂停时只释放物理内存，保留虚拟地址空间。恢复时重新分配物理内存并映射到原虚拟地址。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;调用cuMemAddressReserve保留虚拟地址空间；&lt;/li&gt;
&lt;li&gt;通过cuMemCreate分配物理内存；&lt;/li&gt;
&lt;li&gt;使用cuMemMap将物理内存映射到虚拟地址；&lt;/li&gt;
&lt;li&gt;最后通过cuMemSetAccess设置访问权限&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这样应用程序无需修改指针引用，特别适合需要临时释放显存的大模型场景。&lt;/p&gt;
&lt;p&gt;再看看malloc和free的实现：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;cudaError_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;malloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;**&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tag&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CUdevice&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CURESULT_CHECK&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuCtxGetDevice&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-5&#34; name=&#34;__codelineno-3-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CUmemGenericAllocationHandle&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-6&#34; name=&#34;__codelineno-3-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CUDAUtils&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cu_mem_create&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-7&#34; name=&#34;__codelineno-3-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ptr就是保留重复使用的虚拟地址&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-8&#34; name=&#34;__codelineno-3-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CURESULT_CHECK&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuMemAddressReserve&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CUdeviceptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-9&#34; name=&#34;__codelineno-3-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CURESULT_CHECK&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuMemMap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CUdeviceptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-10&#34; name=&#34;__codelineno-3-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CUDAUtils&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cu_mem_set_access&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-11&#34; name=&#34;__codelineno-3-11&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-12&#34; name=&#34;__codelineno-3-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-13&#34; name=&#34;__codelineno-3-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lock_guard&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mutex&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocator_metadata_mutex_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-14&#34; name=&#34;__codelineno-3-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocation_metadata_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;emplace&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_AllocationMetadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tag&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;});&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-15&#34; name=&#34;__codelineno-3-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-16&#34; name=&#34;__codelineno-3-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-17&#34; name=&#34;__codelineno-3-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-18&#34; name=&#34;__codelineno-3-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;cudaError_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;free&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-19&#34; name=&#34;__codelineno-3-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_AllocationMetadata&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-20&#34; name=&#34;__codelineno-3-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-21&#34; name=&#34;__codelineno-3-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lock_guard&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mutex&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocator_metadata_mutex_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-22&#34; name=&#34;__codelineno-3-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SIMPLE_CHECK&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocation_metadata_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;count&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Trying to free a pointer not allocated here&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-23&#34; name=&#34;__codelineno-3-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocation_metadata_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-24&#34; name=&#34;__codelineno-3-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocation_metadata_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;erase&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-25&#34; name=&#34;__codelineno-3-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-26&#34; name=&#34;__codelineno-3-26&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-27&#34; name=&#34;__codelineno-3-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CURESULT_CHECK&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuMemUnmap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CUdeviceptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-28&#34; name=&#34;__codelineno-3-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CURESULT_CHECK&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuMemRelease&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-29&#34; name=&#34;__codelineno-3-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CURESULT_CHECK&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuMemAddressFree&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CUdeviceptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-30&#34; name=&#34;__codelineno-3-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;通过allocation_metadata_保存了虚拟指针ptr和每次分配的metadata，metadata包括了真实使用的内存allocHandle和size。&lt;/p&gt;
&lt;p&gt;在pause的时候释放allocHandle，但是不释放ptr。在assume的时候申请新的allocHandle，绑定ptr和allocHandle的关系，即更新allocation_metadata_保存的metadata信息。&lt;/p&gt;
&lt;h2 id=&#34;通过region进行管理&#34;&gt;通过Region进行管理&lt;a class=&#34;headerlink&#34; href=&#34;#通过region进行管理&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;通过Region进行管理，不在Region内的内存不受影响，正常使用CudaMalloc/CudaFree。在特定Region内分配的内存会被特殊管理，暂停时只释放物理内存，保留虚拟地址空间，恢复时重新分配物理内存并映射到原虚拟地址。&lt;/p&gt;
&lt;p&gt;对应python：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Python&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;with&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;memory_saver&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;region&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;():&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;full&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1_000_000_000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,),&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;dtype&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;torch&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uint8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;device&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;cuda&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;Region的实现：&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;namespace&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;RegionManager&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;thread_local&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_interesting_region_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-3&#34; name=&#34;__codelineno-5-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-4&#34; name=&#34;__codelineno-5-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;enter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-5&#34; name=&#34;__codelineno-5-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#ifdef TMS_DEBUG_LOG&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-6&#34; name=&#34;__codelineno-5-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cout&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;[torch_memory_saver.cpp] tms_region_enter&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-7&#34; name=&#34;__codelineno-5-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#endif&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-8&#34; name=&#34;__codelineno-5-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_interesting_region_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-9&#34; name=&#34;__codelineno-5-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-10&#34; name=&#34;__codelineno-5-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-11&#34; name=&#34;__codelineno-5-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;leave&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-12&#34; name=&#34;__codelineno-5-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#ifdef TMS_DEBUG_LOG&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-13&#34; name=&#34;__codelineno-5-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cout&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;[torch_memory_saver.cpp] tms_region_leave&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-14&#34; name=&#34;__codelineno-5-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#endif&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-15&#34; name=&#34;__codelineno-5-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_interesting_region_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-16&#34; name=&#34;__codelineno-5-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-17&#34; name=&#34;__codelineno-5-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-18&#34; name=&#34;__codelineno-5-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;is_interesting_region&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-19&#34; name=&#34;__codelineno-5-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_interesting_region_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-20&#34; name=&#34;__codelineno-5-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-21&#34; name=&#34;__codelineno-5-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
is_interesting_region函数，会在下节拦截中cudaMalloc/cudaFree调用中区分不同的调用实现。&lt;/p&gt;
&lt;h2 id=&#34;ld_preload拦截cudamalloccudafree调用&#34;&gt;LD_PRELOAD拦截cudaMalloc/cudaFree调用&lt;a class=&#34;headerlink&#34; href=&#34;#ld_preload拦截cudamalloccudafree调用&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;pytorch python库做了大量的封装，更加友好使用。比如创建一个tensor只需要下面一句，指定datatype、shape、device为cuda。实际上底层会调用cudaMalloc/cudaFree（cudaruntime的api）去分配和释放显存。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Text Only&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;x = torch.full((1_000_000_000,), 100, dtype=torch.uint8, device=&amp;#39;cuda&amp;#39;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
为了能够使用上我们自定义的分配逻辑，那么就需要拦截cudaruntime中实现的cudaMalloc和cudaFree。比如在Region区域内调用自定义分配释放逻辑，不在Region内的内存，正常调用cudaruntime的CudaMalloc/CudaFree。&lt;/p&gt;
&lt;p&gt;一起看看如何拦截！&lt;/p&gt;
&lt;p&gt;自定义cudaMalloc和cudaFree函数。分条件调用不同的逻辑。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-7-1&#34; name=&#34;__codelineno-7-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;cudaError_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;cudaMalloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;**&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-2&#34; name=&#34;__codelineno-7-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RegionManager&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_interesting_region&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-3&#34; name=&#34;__codelineno-7-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TorchMemorySaver&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;malloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RegionManager&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_current_tag&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-4&#34; name=&#34;__codelineno-7-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-5&#34; name=&#34;__codelineno-7-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;APIForwarder&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;call_real_cuda_malloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-6&#34; name=&#34;__codelineno-7-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-7&#34; name=&#34;__codelineno-7-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-8&#34; name=&#34;__codelineno-7-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-9&#34; name=&#34;__codelineno-7-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;cudaError_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;cudaFree&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-10&#34; name=&#34;__codelineno-7-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RegionManager&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_interesting_region&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-11&#34; name=&#34;__codelineno-7-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TorchMemorySaver&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;free&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-12&#34; name=&#34;__codelineno-7-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-13&#34; name=&#34;__codelineno-7-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;APIForwarder&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;call_real_cuda_free&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-14&#34; name=&#34;__codelineno-7-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-15&#34; name=&#34;__codelineno-7-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
call_real_cuda_malloc和call_real_cuda_free就是调用cudaruntime的标准实现。&lt;/p&gt;
&lt;p&gt;可以看到，和我们上篇将拦截的文章一样，用到了dlsym RTLD_NEXT方式和LD_PRELOAD方式获取cudaruntime的实现。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-8-1&#34; name=&#34;__codelineno-8-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cudaError_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;call_real_cuda_malloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;**&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-2&#34; name=&#34;__codelineno-8-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;C10_UNLIKELY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;real_cudaMalloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-3&#34; name=&#34;__codelineno-8-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;real_cudaMalloc&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CudaMallocFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;check_dlsym&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dlsym&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RTLD_NEXT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;cudaMalloc&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-4&#34; name=&#34;__codelineno-8-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-5&#34; name=&#34;__codelineno-8-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cudaError_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ret&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;real_cudaMalloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-6&#34; name=&#34;__codelineno-8-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ret&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-7&#34; name=&#34;__codelineno-8-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h2 id=&#34;额外学习到的知识&#34;&gt;额外学习到的知识&lt;a class=&#34;headerlink&#34; href=&#34;#额外学习到的知识&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;除此之外，由于核心逻辑是c++实现的，因此你还可以通过本项目学会如何实现python c/c++扩展（setup ext_modules）。&lt;/p&gt;
&lt;p&gt;和pytorch一样，最终使用torch_memory_saver是python包形式。如何通过（from contextlib import contextmanager）自定义python with语法糖。如何调用封装c++扩展。形成一个用户友好的python库。&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/sglang推理使用之环境配置/&#34; target=&#34;_blank&#34;&gt;sglang推理使用之环境配置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/从deepseek开源库3fs中学习fuse的使用-如何开发一个文件系统一/&#34; target=&#34;_blank&#34;&gt;从Deepseek开源库3FS中学习fuse的使用-如何开发一个文件系统（一）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/torch_memory_saver%E9%AB%98%E6%80%A7%E8%83%BDcuda%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%E5%AE%9E%E7%8E%B0/</link>
      <pubDate>Sat, 21 Jun 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/torch_memory_saver%E9%AB%98%E6%80%A7%E8%83%BDcuda%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%E5%AE%9E%E7%8E%B0/</guid>
      
    </item>
    
    <item>
      <title>tritonserver-multibatch源码分析</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;!-- more --&gt;
&lt;h2 id=&#34;问题&#34;&gt;问题&lt;a class=&#34;headerlink&#34; href=&#34;#问题&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nl&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;python_batched_service&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nl&#34;&gt;backend&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;python&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-4&#34; name=&#34;__codelineno-0-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nl&#34;&gt;max_batch_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;16&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-5&#34; name=&#34;__codelineno-0-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-6&#34; name=&#34;__codelineno-0-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;dynamic_batching&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-7&#34; name=&#34;__codelineno-0-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;max_queue_delay_microseconds&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;500000&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-8&#34; name=&#34;__codelineno-0-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-9&#34; name=&#34;__codelineno-0-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-10&#34; name=&#34;__codelineno-0-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-11&#34; name=&#34;__codelineno-0-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-12&#34; name=&#34;__codelineno-0-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;input_field&amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-13&#34; name=&#34;__codelineno-0-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;data_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TYPE_FP32&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-14&#34; name=&#34;__codelineno-0-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;dims&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;-1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-15&#34; name=&#34;__codelineno-0-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-16&#34; name=&#34;__codelineno-0-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-17&#34; name=&#34;__codelineno-0-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-0-18&#34; name=&#34;__codelineno-0-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;instance_group&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-19&#34; name=&#34;__codelineno-0-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-20&#34; name=&#34;__codelineno-0-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;count&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-21&#34; name=&#34;__codelineno-0-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;kind&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;KIND_CPU&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-22&#34; name=&#34;__codelineno-0-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-23&#34; name=&#34;__codelineno-0-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
对于一个输入为input_field的模型，如果输入的shape不同，比如[1,20]和[1,30]、[1、40]，那么dynamic batching是否会凑batch？&lt;/p&gt;
&lt;p&gt;答案是不会，只有连续发送的[1,20]这种相同输入shape的请求才会凑batch。不一样的叫不规则输入，也叫ragged batch。&lt;/p&gt;
&lt;p&gt;可以参考python例子。&lt;/p&gt;
&lt;p&gt;https://github.com/triton-inference-server/server/issues/6937&lt;/p&gt;
&lt;p&gt;https://github.com/triton-inference-server/server/blob/main/docs/protocol/extension_statistics.md&lt;/p&gt;
&lt;h3 id=&#34;tritonserver&#34;&gt;tritonserver&lt;a class=&#34;headerlink&#34; href=&#34;#tritonserver&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;不同shape，采用dynamic batching方式不会凑batch。&lt;/p&gt;
&lt;p&gt;需要采用ragged batching方式。或者将proto3的int32改成fixed32，以及避免传输0。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// repo-core-src/src/backend_model.cc&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;Status&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nf&#34;&gt;TritonModel::SetConfiguredScheduler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-4&#34; name=&#34;__codelineno-1-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-5&#34; name=&#34;__codelineno-1-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scheduler&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;scheduler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-6&#34; name=&#34;__codelineno-1-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-1-7&#34; name=&#34;__codelineno-1-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Need to enforce equal shape batches (i.e. non-ragged batches) if&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-8&#34; name=&#34;__codelineno-1-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// the model 1) allows one or more variable-size input tensors that&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-9&#34; name=&#34;__codelineno-1-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// are not marked as &amp;#39;allow_ragged_batch&amp;#39; or 2) has one or more&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-10&#34; name=&#34;__codelineno-1-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// shape-tensor inputs. This is not needed if all input shapes are&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-11&#34; name=&#34;__codelineno-1-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// non-variable and if there are no shape tensors... so we don&amp;#39;t&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-12&#34; name=&#34;__codelineno-1-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// enable it in that case for efficiency reasons.&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-13&#34; name=&#34;__codelineno-1-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unordered_map&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;enforce_equal_shape_tensors&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-14&#34; name=&#34;__codelineno-1-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-15&#34; name=&#34;__codelineno-1-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// https://docs.nvidia.com/deeplearning/triton-inference-server/user-guide/docs/user_guide/model_configuration.html#shape-tensors, 目前只有TensorRT支持shape_tensor。&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-16&#34; name=&#34;__codelineno-1-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_shape_tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-17&#34; name=&#34;__codelineno-1-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;enforce_equal_shape_tensors&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;insert&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;({&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;});&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-18&#34; name=&#34;__codelineno-1-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-19&#34; name=&#34;__codelineno-1-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allow_ragged_batch&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-20&#34; name=&#34;__codelineno-1-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;triton&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;common&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GetElementCount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;-1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-21&#34; name=&#34;__codelineno-1-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;enforce_equal_shape_tensors&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;insert&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;({&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;});&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-22&#34; name=&#34;__codelineno-1-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-23&#34; name=&#34;__codelineno-1-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-24&#34; name=&#34;__codelineno-1-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ......&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-25&#34; name=&#34;__codelineno-1-25&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-1-26&#34; name=&#34;__codelineno-1-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RETURN_IF_ERROR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DynamicBatchScheduler&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Create&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-27&#34; name=&#34;__codelineno-1-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;this&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*nice*/&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* dynamic_batching_enabled */&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-28&#34; name=&#34;__codelineno-1-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;max_batch_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;enforce_equal_shape_tensors&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-29&#34; name=&#34;__codelineno-1-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dynamic_batching&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-30&#34; name=&#34;__codelineno-1-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;response_cache&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;enable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* response_cache_enable */&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-31&#34; name=&#34;__codelineno-1-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;scheduler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-32&#34; name=&#34;__codelineno-1-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-40&#34;&gt;40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-41&#34;&gt;41&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-42&#34;&gt;42&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-43&#34;&gt;43&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-44&#34;&gt;44&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-45&#34;&gt;45&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-46&#34;&gt;46&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-47&#34;&gt;47&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-48&#34;&gt;48&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-49&#34;&gt;49&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-50&#34;&gt;50&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-51&#34;&gt;51&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-52&#34;&gt;52&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-53&#34;&gt;53&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-54&#34;&gt;54&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-55&#34;&gt;55&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-56&#34;&gt;56&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-57&#34;&gt;57&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-58&#34;&gt;58&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-59&#34;&gt;59&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-60&#34;&gt;60&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-61&#34;&gt;61&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// _deps/repo-core-src/src/dynamic_batch_scheduler.cc&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;uint64_t&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nf&#34;&gt;DynamicBatchScheduler::GetDynamicBatch&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(){&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-4&#34; name=&#34;__codelineno-2-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-5&#34; name=&#34;__codelineno-2-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// When there is optional input or input shape must be enforced,&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-6&#34; name=&#34;__codelineno-2-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// the inputs in the requests must be examined for forming a batch&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-7&#34; name=&#34;__codelineno-2-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;check_input&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-8&#34; name=&#34;__codelineno-2-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;enforce_equal_shape_tensors_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;empty&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;has_optional_input_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-9&#34; name=&#34;__codelineno-2-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-10&#34; name=&#34;__codelineno-2-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// If there is no pending batch, then this request is starting a&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-11&#34; name=&#34;__codelineno-2-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// new batch.&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-12&#34; name=&#34;__codelineno-2-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;payload_batch_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;queue_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PendingBatchCount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-13&#34; name=&#34;__codelineno-2-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Get the shape of the new batch that is being started...&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-14&#34; name=&#34;__codelineno-2-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;check_input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-15&#34; name=&#34;__codelineno-2-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;curr_payload_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MutableRequiredEqualInputs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-16&#34; name=&#34;__codelineno-2-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                 &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Initialize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-17&#34; name=&#34;__codelineno-2-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                     &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;queue_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RequestAtCursor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;enforce_equal_shape_tensors_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-18&#34; name=&#34;__codelineno-2-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                     &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;has_optional_input_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-19&#34; name=&#34;__codelineno-2-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                 &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IsOk&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-20&#34; name=&#34;__codelineno-2-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;send_now&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-21&#34; name=&#34;__codelineno-2-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;break&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-22&#34; name=&#34;__codelineno-2-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-23&#34; name=&#34;__codelineno-2-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-24&#34; name=&#34;__codelineno-2-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-25&#34; name=&#34;__codelineno-2-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// There is a pending batch and adding this request would make&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-26&#34; name=&#34;__codelineno-2-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// the batch size larger than all of the preferred batch sizes,&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-27&#34; name=&#34;__codelineno-2-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// so mark the cursor at this point. Not sending the pending batch so&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-28&#34; name=&#34;__codelineno-2-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// that we can examine the queue delay of requests that fits in a batch.&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-29&#34; name=&#34;__codelineno-2-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;payload_batch_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pending_batch_size_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;batch_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-30&#34; name=&#34;__codelineno-2-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;           &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;max_preferred_batch_size_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-31&#34; name=&#34;__codelineno-2-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;best_preferred_batch_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-32&#34; name=&#34;__codelineno-2-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;best_preferred_batch_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pending_batch_size_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-33&#34; name=&#34;__codelineno-2-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;queue_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MarkCursor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-34&#34; name=&#34;__codelineno-2-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;payload_saturated_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-35&#34; name=&#34;__codelineno-2-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-36&#34; name=&#34;__codelineno-2-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;payload_batch_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pending_batch_size_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;batch_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-37&#34; name=&#34;__codelineno-2-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;max_batch_size_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-38&#34; name=&#34;__codelineno-2-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;send_now&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-39&#34; name=&#34;__codelineno-2-39&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;break&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-40&#34; name=&#34;__codelineno-2-40&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-41&#34; name=&#34;__codelineno-2-41&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-42&#34; name=&#34;__codelineno-2-42&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// There is a pending batch and it has a different shape then&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-43&#34; name=&#34;__codelineno-2-43&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// this request, so send the pending batch as it is.&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-44&#34; name=&#34;__codelineno-2-44&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;check_input&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-45&#34; name=&#34;__codelineno-2-45&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;curr_payload_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MutableRequiredEqualInputs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HasEqualInputs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-46&#34; name=&#34;__codelineno-2-46&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;queue_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RequestAtCursor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-47&#34; name=&#34;__codelineno-2-47&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;curr_payload_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MarkSaturated&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-48&#34; name=&#34;__codelineno-2-48&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;send_now&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-49&#34; name=&#34;__codelineno-2-49&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;break&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-50&#34; name=&#34;__codelineno-2-50&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-51&#34; name=&#34;__codelineno-2-51&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-52&#34; name=&#34;__codelineno-2-52&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-53&#34; name=&#34;__codelineno-2-53&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 直接发送&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-54&#34; name=&#34;__codelineno-2-54&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// If the delay has been exceeded, or if the current batch can&amp;#39;t grow&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-55&#34; name=&#34;__codelineno-2-55&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// any larger then just immediately execute whatever is pending.&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-56&#34; name=&#34;__codelineno-2-56&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;send_now&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;payload_batch_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pending_batch_size_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-57&#34; name=&#34;__codelineno-2-57&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;max_preferred_batch_size_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-58&#34; name=&#34;__codelineno-2-58&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;payload_saturated_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-59&#34; name=&#34;__codelineno-2-59&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-60&#34; name=&#34;__codelineno-2-60&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-61&#34; name=&#34;__codelineno-2-61&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nf&#34;&gt;RequiredEqualInputs::HasEqualInputs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferenceRequest&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;){&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;//......&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-5&#34; name=&#34;__codelineno-3-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;itr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;second&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;first&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-6&#34; name=&#34;__codelineno-3-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-7&#34; name=&#34;__codelineno-3-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-8&#34; name=&#34;__codelineno-3-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// For now being conservative and assuming that content&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-9&#34; name=&#34;__codelineno-3-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// comparison is for shape tensors which are likely to always&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-10&#34; name=&#34;__codelineno-3-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// be in a single buffer.&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-11&#34; name=&#34;__codelineno-3-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;BufferCount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;BufferCount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-12&#34; name=&#34;__codelineno-3-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-13&#34; name=&#34;__codelineno-3-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-14&#34; name=&#34;__codelineno-3-14&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-15&#34; name=&#34;__codelineno-3-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1_byte_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2_byte_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-16&#34; name=&#34;__codelineno-3-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_MemoryType&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1_memory_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2_memory_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-17&#34; name=&#34;__codelineno-3-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int64_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1_memory_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2_memory_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-18&#34; name=&#34;__codelineno-3-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1_buffer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;BufferAt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-19&#34; name=&#34;__codelineno-3-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* idx */&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1_byte_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1_memory_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1_memory_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-20&#34; name=&#34;__codelineno-3-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2_buffer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;BufferAt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-21&#34; name=&#34;__codelineno-3-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* idx */&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2_byte_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2_memory_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2_memory_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-22&#34; name=&#34;__codelineno-3-22&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-23&#34; name=&#34;__codelineno-3-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Tensor must be same size and in in CPU memory so that it&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-24&#34; name=&#34;__codelineno-3-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// can be easily compared. If not return false conservatively.&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-25&#34; name=&#34;__codelineno-3-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1_byte_size&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2_byte_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1_buffer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-26&#34; name=&#34;__codelineno-3-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2_buffer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-27&#34; name=&#34;__codelineno-3-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1_memory_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_MEMORY_GPU&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-28&#34; name=&#34;__codelineno-3-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2_memory_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_MEMORY_GPU&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-29&#34; name=&#34;__codelineno-3-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-30&#34; name=&#34;__codelineno-3-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-31&#34; name=&#34;__codelineno-3-31&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-32&#34; name=&#34;__codelineno-3-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;strncmp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1_buffer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d2_buffer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d1_byte_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-33&#34; name=&#34;__codelineno-3-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-34&#34; name=&#34;__codelineno-3-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-35&#34; name=&#34;__codelineno-3-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;采用ragged-batch&#34;&gt;采用ragged batch&lt;a class=&#34;headerlink&#34; href=&#34;#采用ragged-batch&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Text Only&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;max_batch_size: 16
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;input [
&lt;a id=&#34;__codelineno-4-3&#34; name=&#34;__codelineno-4-3&#34;&gt;&lt;/a&gt;  {
&lt;a id=&#34;__codelineno-4-4&#34; name=&#34;__codelineno-4-4&#34;&gt;&lt;/a&gt;    name: &amp;quot;INPUT&amp;quot;
&lt;a id=&#34;__codelineno-4-5&#34; name=&#34;__codelineno-4-5&#34;&gt;&lt;/a&gt;    data_type: TYPE_FP32
&lt;a id=&#34;__codelineno-4-6&#34; name=&#34;__codelineno-4-6&#34;&gt;&lt;/a&gt;    dims: [ -1 ]
&lt;a id=&#34;__codelineno-4-7&#34; name=&#34;__codelineno-4-7&#34;&gt;&lt;/a&gt;  }
&lt;a id=&#34;__codelineno-4-8&#34; name=&#34;__codelineno-4-8&#34;&gt;&lt;/a&gt;]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
改为：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Text Only&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-9&#34;&gt;9&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;max_batch_size: 16
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;input [
&lt;a id=&#34;__codelineno-5-3&#34; name=&#34;__codelineno-5-3&#34;&gt;&lt;/a&gt;  {
&lt;a id=&#34;__codelineno-5-4&#34; name=&#34;__codelineno-5-4&#34;&gt;&lt;/a&gt;    name: &amp;quot;INPUT&amp;quot;
&lt;a id=&#34;__codelineno-5-5&#34; name=&#34;__codelineno-5-5&#34;&gt;&lt;/a&gt;    data_type: TYPE_FP32
&lt;a id=&#34;__codelineno-5-6&#34; name=&#34;__codelineno-5-6&#34;&gt;&lt;/a&gt;    dims: [ -1 ]
&lt;a id=&#34;__codelineno-5-7&#34; name=&#34;__codelineno-5-7&#34;&gt;&lt;/a&gt;    allow_ragged_batch: true
&lt;a id=&#34;__codelineno-5-8&#34; name=&#34;__codelineno-5-8&#34;&gt;&lt;/a&gt;  }
&lt;a id=&#34;__codelineno-5-9&#34; name=&#34;__codelineno-5-9&#34;&gt;&lt;/a&gt;]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;python backend和一般自定义的backend都不需要加：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Text Only&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;batch_input [
&lt;a id=&#34;__codelineno-6-2&#34; name=&#34;__codelineno-6-2&#34;&gt;&lt;/a&gt;  {
&lt;a id=&#34;__codelineno-6-3&#34; name=&#34;__codelineno-6-3&#34;&gt;&lt;/a&gt;    kind: BATCH_ACCUMULATED_ELEMENT_COUNT
&lt;a id=&#34;__codelineno-6-4&#34; name=&#34;__codelineno-6-4&#34;&gt;&lt;/a&gt;    target_name: &amp;quot;INDEX&amp;quot;
&lt;a id=&#34;__codelineno-6-5&#34; name=&#34;__codelineno-6-5&#34;&gt;&lt;/a&gt;    data_type: TYPE_FP32
&lt;a id=&#34;__codelineno-6-6&#34; name=&#34;__codelineno-6-6&#34;&gt;&lt;/a&gt;    source_input: &amp;quot;INPUT&amp;quot;
&lt;a id=&#34;__codelineno-6-7&#34; name=&#34;__codelineno-6-7&#34;&gt;&lt;/a&gt;  }
&lt;a id=&#34;__codelineno-6-8&#34; name=&#34;__codelineno-6-8&#34;&gt;&lt;/a&gt;]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The backends, such as ONNX Runtime backend, TensorFlow backend, PyTorch backend, and TensorRT backend, require models to accept ragged inputs as 1-dimensional tensors. These backends concatenates the request inputs into the 1-dimensional tensor.Because the concatenated input doesn’t track the start and end index for each request, the backends often require the model to have additional input(s), batch input, that describe various information about the batch formed.
https://docs.nvidia.com/deeplearning/triton-inference-server/user-guide/docs/user_guide/ragged_batching.html&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;像ONNX Runtime backend, TensorFlow backend, PyTorch backend, and TensorRT backend，将request inputs 拼接成1维tensor，但是这个拼接的tensor无法跟踪每个request的start和end index，所以需要额外的batch input来描述batch的构成。&lt;/p&gt;
&lt;p&gt;可以查看实现：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-7-1&#34; name=&#34;__codelineno-7-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// https://github1s.com/triton-inference-server/onnxruntime_backend/blob/main/src/onnxruntime.cc&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;proto3&#34;&gt;proto3&lt;a class=&#34;headerlink&#34; href=&#34;#proto3&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;proto的规则，int32类型的0值序列化不占用字节数，非0编码采用variant，数字根据大小不同，在2-5个字节变化。&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-8-1&#34; name=&#34;__codelineno-8-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;syntax&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;proto3&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-2&#34; name=&#34;__codelineno-8-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-3&#34; name=&#34;__codelineno-8-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;package&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hello&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;proto&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-4&#34; name=&#34;__codelineno-8-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;message&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Image&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-5&#34; name=&#34;__codelineno-8-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;int32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-6&#34; name=&#34;__codelineno-8-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;int32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fd&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-7&#34; name=&#34;__codelineno-8-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-8&#34; name=&#34;__codelineno-8-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-9&#34; name=&#34;__codelineno-8-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;message&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ImageSet&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-10&#34; name=&#34;__codelineno-8-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;repeated&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Image&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;images&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-11&#34; name=&#34;__codelineno-8-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
需要改成：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-9-1&#34; name=&#34;__codelineno-9-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;syntax&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;proto3&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-2&#34; name=&#34;__codelineno-9-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-3&#34; name=&#34;__codelineno-9-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;package&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hello&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;proto&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-4&#34; name=&#34;__codelineno-9-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;message&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Image&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-5&#34; name=&#34;__codelineno-9-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fixed32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-6&#34; name=&#34;__codelineno-9-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fixed32&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fd&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-7&#34; name=&#34;__codelineno-9-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-8&#34; name=&#34;__codelineno-9-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-9&#34; name=&#34;__codelineno-9-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;message&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ImageSet&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-10&#34; name=&#34;__codelineno-9-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;repeated&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Image&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;images&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-11&#34; name=&#34;__codelineno-9-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
fixed32只能解决非0值的序列化后长度保持一致，同时需要避免device_id和fd传递0，比如可以先加1，从1开始。传递到server后再减1。&lt;/p&gt;
&lt;h2 id=&#34;python-backend例子&#34;&gt;python backend例子&lt;a class=&#34;headerlink&#34; href=&#34;#python-backend例子&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;model.py
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Python&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-10-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-10-1&#34; name=&#34;__codelineno-10-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;triton_python_backend_utils&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;pb_utils&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-2&#34; name=&#34;__codelineno-10-2&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-10-3&#34; name=&#34;__codelineno-10-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-10-4&#34; name=&#34;__codelineno-10-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;TritonPythonModel&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-5&#34; name=&#34;__codelineno-10-5&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;initialize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-6&#34; name=&#34;__codelineno-10-6&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;k&#34;&gt;pass&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-7&#34; name=&#34;__codelineno-10-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-10-8&#34; name=&#34;__codelineno-10-8&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;execute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;requests&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-9&#34; name=&#34;__codelineno-10-9&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;num_requests&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;requests&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-10&#34; name=&#34;__codelineno-10-10&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;nb&#34;&gt;print&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;sa&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;Received a batch containing &lt;/span&gt;&lt;span class=&#34;si&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;num_requests&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt; request(s)&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-11&#34; name=&#34;__codelineno-10-11&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-10-12&#34; name=&#34;__codelineno-10-12&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;responses&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-13&#34; name=&#34;__codelineno-10-13&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;n&#34;&gt;pb_utils&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferenceResponse&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;output_tensors&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[])&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-14&#34; name=&#34;__codelineno-10-14&#34;&gt;&lt;/a&gt;            &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;_&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;range&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;num_requests&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-15&#34; name=&#34;__codelineno-10-15&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-16&#34; name=&#34;__codelineno-10-16&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;responses&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-17&#34; name=&#34;__codelineno-10-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-10-18&#34; name=&#34;__codelineno-10-18&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;finalize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;a id=&#34;__codelineno-10-19&#34; name=&#34;__codelineno-10-19&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;nb&#34;&gt;print&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;Cleaning up...&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;client.py
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Python&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-40&#34;&gt;40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-41&#34;&gt;41&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-42&#34;&gt;42&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-43&#34;&gt;43&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-44&#34;&gt;44&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-45&#34;&gt;45&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-46&#34;&gt;46&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-11-47&#34;&gt;47&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-11-1&#34; name=&#34;__codelineno-11-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;tritonclient.grpc&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;grpcclient&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-2&#34; name=&#34;__codelineno-11-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;numpy&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;np&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-3&#34; name=&#34;__codelineno-11-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-4&#34; name=&#34;__codelineno-11-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-5&#34; name=&#34;__codelineno-11-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;triton_client&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;grpcclient&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferenceServerClient&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-6&#34; name=&#34;__codelineno-11-6&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;url&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;localhost:8001&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-7&#34; name=&#34;__codelineno-11-7&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;verbose&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;False&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-8&#34; name=&#34;__codelineno-11-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-9&#34; name=&#34;__codelineno-11-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-10&#34; name=&#34;__codelineno-11-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-11&#34; name=&#34;__codelineno-11-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;callback&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;result&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;error&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-12&#34; name=&#34;__codelineno-11-12&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;error&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-13&#34; name=&#34;__codelineno-11-13&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;nb&#34;&gt;print&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;error&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-14&#34; name=&#34;__codelineno-11-14&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;pass&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-15&#34; name=&#34;__codelineno-11-15&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-16&#34; name=&#34;__codelineno-11-16&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-17&#34; name=&#34;__codelineno-11-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;send_single_request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;array&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-18&#34; name=&#34;__codelineno-11-18&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;inputs&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-19&#34; name=&#34;__codelineno-11-19&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;grpcclient&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferInput&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;input_field&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;array&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;FP32&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-20&#34; name=&#34;__codelineno-11-20&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-21&#34; name=&#34;__codelineno-11-21&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;inputs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set_data_from_numpy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;array&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-22&#34; name=&#34;__codelineno-11-22&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-23&#34; name=&#34;__codelineno-11-23&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;triton_client&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;async_infer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-24&#34; name=&#34;__codelineno-11-24&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;model_name&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;python_batched_service&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-25&#34; name=&#34;__codelineno-11-25&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;inputs&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inputs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-26&#34; name=&#34;__codelineno-11-26&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;model_version&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;quot;1&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-27&#34; name=&#34;__codelineno-11-27&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;outputs&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[],&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-28&#34; name=&#34;__codelineno-11-28&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;callback&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;callback&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-29&#34; name=&#34;__codelineno-11-29&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-30&#34; name=&#34;__codelineno-11-30&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-31&#34; name=&#34;__codelineno-11-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;send_many_requests&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_sizes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-32&#34; name=&#34;__codelineno-11-32&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ix&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;range&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;200&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-33&#34; name=&#34;__codelineno-11-33&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;size&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;input_sizes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ix&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;%&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_sizes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)]&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-34&#34; name=&#34;__codelineno-11-34&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;array&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;np&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;random&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rand&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;astype&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;np&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;float32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-35&#34; name=&#34;__codelineno-11-35&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;n&#34;&gt;send_single_request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;array&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;array&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-36&#34; name=&#34;__codelineno-11-36&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-37&#34; name=&#34;__codelineno-11-37&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-38&#34; name=&#34;__codelineno-11-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;vm&#34;&gt;__name__&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;__main__&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-39&#34; name=&#34;__codelineno-11-39&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;send_many_requests&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_sizes&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-40&#34; name=&#34;__codelineno-11-40&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;20&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,),&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-41&#34; name=&#34;__codelineno-11-41&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;p&#34;&gt;])&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-42&#34; name=&#34;__codelineno-11-42&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-11-43&#34; name=&#34;__codelineno-11-43&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;n&#34;&gt;send_many_requests&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_sizes&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-44&#34; name=&#34;__codelineno-11-44&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;20&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,),&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-45&#34; name=&#34;__codelineno-11-45&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;40&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-46&#34; name=&#34;__codelineno-11-46&#34;&gt;&lt;/a&gt;        &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;60&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-11-47&#34; name=&#34;__codelineno-11-47&#34;&gt;&lt;/a&gt;    &lt;span class=&#34;p&#34;&gt;])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/sglang推理使用之环境配置/&#34; target=&#34;_blank&#34;&gt;sglang推理使用之环境配置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/从deepseek开源库3fs中学习fuse的使用-如何开发一个文件系统一/&#34; target=&#34;_blank&#34;&gt;从Deepseek开源库3FS中学习fuse的使用-如何开发一个文件系统（一）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/tritonserver-multibatch%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</link>
      <pubDate>Sat, 21 Jun 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/tritonserver-multibatch%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</guid>
      
    </item>
    
    <item>
      <title>tritonserver-ratelimiter源码分析</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;!-- more --&gt;
&lt;h2 id=&#34;tritonserver调度器&#34;&gt;tritonserver调度器&lt;a class=&#34;headerlink&#34; href=&#34;#tritonserver调度器&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;三种调度器：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;emsemble schedulor&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;dynamicbatch scheduler&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;sequece scheduler&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以metric为入口对源码进行分析，&lt;/p&gt;
&lt;p&gt;metric提供了http接口，统计了nv_inference_compute_infer_duration_us和nv_inference_queue_duration_us指标。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Python&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;count_pattern&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;re&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;compile&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;sa&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;nv_inference_count\{model=&amp;quot;([^&amp;quot;]+)&amp;quot;.*\} (\d+)&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;duration_pattern&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;re&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;compile&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;sa&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;nv_inference_request_duration_us\{model=&amp;quot;([^&amp;quot;]+)&amp;quot;.*\} (\d+)&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;compute_duration_pattern&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;re&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;compile&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;sa&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;nv_inference_compute_infer_duration_us\{model=&amp;quot;([^&amp;quot;]+)&amp;quot;.*\} (\d+)&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-4&#34; name=&#34;__codelineno-0-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;queue_duration_pattern&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;re&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;compile&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;sa&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;nv_inference_queue_duration_us\{model=&amp;quot;([^&amp;quot;]+)&amp;quot;.*\} (\d+)&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h2 id=&#34;metric统计nv_inference_queue_duration_us和nv_inference_compute_infer_duration_us指标&#34;&gt;metric统计nv_inference_queue_duration_us和nv_inference_compute_infer_duration_us指标&lt;a class=&#34;headerlink&#34; href=&#34;#metric统计nv_inference_queue_duration_us和nv_inference_compute_infer_duration_us指标&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;注册指标到prometheus_registry_中。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inf_request_duration_us_family_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prometheus&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;BuildCounter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;nv_inference_request_duration_us&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-4&#34; name=&#34;__codelineno-1-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Help&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Cumulative inference request duration in microseconds &amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-5&#34; name=&#34;__codelineno-1-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;(includes cached requests)&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-6&#34; name=&#34;__codelineno-1-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Register&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;registry_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)),&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-7&#34; name=&#34;__codelineno-1-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inf_queue_duration_us_family_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-8&#34; name=&#34;__codelineno-1-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prometheus&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;BuildCounter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-9&#34; name=&#34;__codelineno-1-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;nv_inference_queue_duration_us&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-10&#34; name=&#34;__codelineno-1-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Help&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Cumulative inference queuing duration in microseconds &amp;quot;&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-11&#34; name=&#34;__codelineno-1-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;(includes cached requests)&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-12&#34; name=&#34;__codelineno-1-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Register&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;registry_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)),&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;counter_families_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;queue_duration&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Metrics&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;FamilyInferenceQueueDuration&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;全局搜索“queue_duration”找到“uint64_t queue_duration_ns_;”在infer_stats.h中。进而可以找到如何统计的了。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint64_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;queue_duration_ns&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;compute_start_ns&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;queue_start_ns&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h2 id=&#34;dynamicbatch-scheduler中调度流程&#34;&gt;Dynamicbatch scheduler中调度流程&lt;a class=&#34;headerlink&#34; href=&#34;#dynamicbatch-scheduler中调度流程&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;RateLimiter::EnqueuePayload：DynamicBatchScheduler::BatcherThread线程调度。cv_.wait_for，可以通过查询cv_找到在哪儿放入资源的，也就是cv_.notify_one()。DynamicBatchScheduler::Enqueue函数中，将requests Enqueue。&lt;/p&gt;
&lt;p&gt;前面说的metric统计的入队时间就是在DynamicBatchScheduler::Enqueue函数函数进入时初始化的， request-&amp;gt;CaptureQueueStartNs()。(Emsemble调度中也有这个Enqueue操作，初始化enqueue时间点)。&lt;/p&gt;
&lt;p&gt;SchedulePayload：将playload放入payload_queue-&amp;gt;queue_和payload_queue-&amp;gt;specific_queues_（与具体的model_instance相关）。&lt;/p&gt;
&lt;p&gt;RateLimiter::DequeuePayload：TritonModelInstance::TritonBackendThread::BackendThread()模型实例线程调用，由从payload_queue-&amp;gt;queue_-&amp;gt;Dequeue获取payload，或者对playload中的requests进行&lt;strong&gt;merge（batch调度）&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;RateLimiter中的merge会根据配置文件中的&lt;strong&gt;最大batch数和等待时间&lt;/strong&gt;进行merge。&lt;/p&gt;
&lt;h2 id=&#34;esemble-scheduler中调度流程&#34;&gt;Esemble scheduler中调度流程&lt;a class=&#34;headerlink&#34; href=&#34;#esemble-scheduler中调度流程&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nf&#34;&gt;EnsembleContext::Proceed&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-3&#34; name=&#34;__codelineno-4-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shared_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;EnsembleContext&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-4&#34; name=&#34;__codelineno-4-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Step&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;completed_step&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-5&#34; name=&#34;__codelineno-4-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-6&#34; name=&#34;__codelineno-4-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;StepList&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ready_steps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-7&#34; name=&#34;__codelineno-4-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Status&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PrepareSteps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;completed_step&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ready_steps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-8&#34; name=&#34;__codelineno-4-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IsOk&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-9&#34; name=&#34;__codelineno-4-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ScheduleSteps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;move&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ready_steps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-10&#34; name=&#34;__codelineno-4-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-11&#34; name=&#34;__codelineno-4-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/tritonserver-multibatch源码分析/&#34; target=&#34;_blank&#34;&gt;tritonserver-multibatch源码分析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c使用abseil-cpp遇到的小问题/&#34; target=&#34;_blank&#34;&gt;C++使用abseil-cpp遇到的小问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/tritonserver-ratelimiter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</link>
      <pubDate>Sat, 21 Jun 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/tritonserver-ratelimiter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</guid>
      
    </item>
    
    <item>
      <title>Tritonserver中shm使用源代码分析</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;!-- more --&gt;

&lt;h2 id=&#34;tritonserver中shm使用源代码分析&#34;&gt;Tritonserver中shm使用源代码分析&lt;a class=&#34;headerlink&#34; href=&#34;#tritonserver中shm使用源代码分析&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;从源码探索Tritonserver中shm如何使用，包括system shm和cuda ipc shm。一个shm req如何传递给server，然后在backend中使用。
在server项目中，初始化了shmmanager。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// tritonserver/server/src/main.cc&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Manager for shared memory blocks.&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_manager&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_shared&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;triton&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;server&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SharedMemoryManager&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
然后初始化GRPC server，将shm_manager传入。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Start the HTTP, GRPC, and metrics endpoints.&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;StartEndpoints&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;server&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;trace_manager&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_manager&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;exit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-4&#34; name=&#34;__codelineno-1-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
在grpc server中，采用异步方式处理不同类型的请求。分为三种：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// server/src/grpc/grpc_server.cc&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// common请求队列&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;grpc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ServerCompletionQueue&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;common_cq_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-4&#34; name=&#34;__codelineno-2-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 模型推理请求队列&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-5&#34; name=&#34;__codelineno-2-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;grpc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ServerCompletionQueue&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_infer_cq_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-6&#34; name=&#34;__codelineno-2-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 模型流式推理请求队列&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-7&#34; name=&#34;__codelineno-2-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;grpc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ServerCompletionQueue&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_stream_infer_cq_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;common-请求处理&#34;&gt;common 请求处理&lt;a class=&#34;headerlink&#34; href=&#34;#common-请求处理&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;在common请求中，每个类型就是一个CommonCallData类型，该类型包括了请求的回调函数。在thread中调用回调函数，处理请求。
commonhandler中注册了如下common请求类型：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterServerLive&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterServerReady&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterHealthCheck&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterModelReady&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-5&#34; name=&#34;__codelineno-3-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterServerMetadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-6&#34; name=&#34;__codelineno-3-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterModelMetadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-7&#34; name=&#34;__codelineno-3-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterModelConfig&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-8&#34; name=&#34;__codelineno-3-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterModelStatistics&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-9&#34; name=&#34;__codelineno-3-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterTrace&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-10&#34; name=&#34;__codelineno-3-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterLogging&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-11&#34; name=&#34;__codelineno-3-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterSystemSharedMemoryStatus&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-12&#34; name=&#34;__codelineno-3-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterSystemSharedMemoryRegister&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-13&#34; name=&#34;__codelineno-3-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterSystemSharedMemoryUnregister&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-14&#34; name=&#34;__codelineno-3-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterCudaSharedMemoryStatus&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-15&#34; name=&#34;__codelineno-3-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterCudaSharedMemoryRegister&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-16&#34; name=&#34;__codelineno-3-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterCudaSharedMemoryUnregister&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-17&#34; name=&#34;__codelineno-3-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterRepositoryIndex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-18&#34; name=&#34;__codelineno-3-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterRepositoryModelLoad&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-19&#34; name=&#34;__codelineno-3-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;RegisterRepositoryModelUnload&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
gpu ipc shm和sys shm就在其中的函数注册了, 通过shm_manager注册管理name, raw_handle, byte_size, device_id等。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-40&#34;&gt;40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-41&#34;&gt;41&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-42&#34;&gt;42&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-43&#34;&gt;43&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-44&#34;&gt;44&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-45&#34;&gt;45&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-46&#34;&gt;46&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-47&#34;&gt;47&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-48&#34;&gt;48&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-49&#34;&gt;49&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-50&#34;&gt;50&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nf&#34;&gt;CommonHandler::RegisterCudaSharedMemoryRegister&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-3&#34; name=&#34;__codelineno-4-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-4&#34; name=&#34;__codelineno-4-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OnRegisterCudaSharedMemoryRegister&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-5&#34; name=&#34;__codelineno-4-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;this&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;](&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-6&#34; name=&#34;__codelineno-4-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;grpc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ServerContext&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-7&#34; name=&#34;__codelineno-4-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inference&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CudaSharedMemoryRegisterRequest&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-8&#34; name=&#34;__codelineno-4-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;grpc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ServerAsyncResponseWriter&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-9&#34; name=&#34;__codelineno-4-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inference&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CudaSharedMemoryRegisterResponse&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;responder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-10&#34; name=&#34;__codelineno-4-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tag&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-11&#34; name=&#34;__codelineno-4-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;this&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;service_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RequestCudaSharedMemoryRegister&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-12&#34; name=&#34;__codelineno-4-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;responder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;this&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cq_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;this&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cq_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tag&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-13&#34; name=&#34;__codelineno-4-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-14&#34; name=&#34;__codelineno-4-14&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-15&#34; name=&#34;__codelineno-4-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OnExecuteCudaSharedMemoryRegister&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-16&#34; name=&#34;__codelineno-4-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;this&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;](&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-17&#34; name=&#34;__codelineno-4-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inference&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CudaSharedMemoryRegisterRequest&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-18&#34; name=&#34;__codelineno-4-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inference&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CudaSharedMemoryRegisterResponse&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;response&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-19&#34; name=&#34;__codelineno-4-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;grpc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Status&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-20&#34; name=&#34;__codelineno-4-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_Error&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-21&#34; name=&#34;__codelineno-4-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#ifdef TRITON_ENABLE_GPU&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-22&#34; name=&#34;__codelineno-4-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_manager_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RegisterCUDASharedMemory&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-23&#34; name=&#34;__codelineno-4-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-24&#34; name=&#34;__codelineno-4-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;reinterpret_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cudaIpcMemHandle_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-25&#34; name=&#34;__codelineno-4-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;raw_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()),&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-26&#34; name=&#34;__codelineno-4-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;byte_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-27&#34; name=&#34;__codelineno-4-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#else&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-28&#34; name=&#34;__codelineno-4-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_ErrorNew&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-29&#34; name=&#34;__codelineno-4-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_ERROR_INVALID_ARG&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-30&#34; name=&#34;__codelineno-4-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-31&#34; name=&#34;__codelineno-4-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;failed to register CUDA shared memory region: &amp;#39;&amp;quot;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-32&#34; name=&#34;__codelineno-4-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&amp;#39;, GPUs not supported&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-33&#34; name=&#34;__codelineno-4-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-34&#34; name=&#34;__codelineno-4-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#endif  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// TRITON_ENABLE_GPU&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-35&#34; name=&#34;__codelineno-4-35&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-36&#34; name=&#34;__codelineno-4-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GrpcStatusUtil&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Create&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-37&#34; name=&#34;__codelineno-4-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_ErrorDelete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-38&#34; name=&#34;__codelineno-4-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-39&#34; name=&#34;__codelineno-4-39&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-40&#34; name=&#34;__codelineno-4-40&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pair&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;restricted_kv&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-41&#34; name=&#34;__codelineno-4-41&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;restricted_keys_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RestrictedCategory&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SHARED_MEMORY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-42&#34; name=&#34;__codelineno-4-42&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CommonCallData&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-43&#34; name=&#34;__codelineno-4-43&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;grpc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ServerAsyncResponseWriter&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-44&#34; name=&#34;__codelineno-4-44&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inference&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CudaSharedMemoryRegisterResponse&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-45&#34; name=&#34;__codelineno-4-45&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inference&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CudaSharedMemoryRegisterRequest&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-46&#34; name=&#34;__codelineno-4-46&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inference&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CudaSharedMemoryRegisterResponse&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-47&#34; name=&#34;__codelineno-4-47&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;CudaSharedMemoryRegister&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OnRegisterCudaSharedMemoryRegister&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-48&#34; name=&#34;__codelineno-4-48&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OnExecuteCudaSharedMemoryRegister&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* async */&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cq_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;restricted_kv&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-49&#34; name=&#34;__codelineno-4-49&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;response_delay_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-50&#34; name=&#34;__codelineno-4-50&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h2 id=&#34;infer-grpc请求&#34;&gt;infer grpc请求&lt;a class=&#34;headerlink&#34; href=&#34;#infer-grpc请求&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&#34;request-处理&#34;&gt;request 处理&lt;a class=&#34;headerlink&#34; href=&#34;#request-处理&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ModelInferHandler&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Execute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferHandler&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;State&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;){&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Maintain shared pointers(read-only reference) to the shared memory block&amp;#39;s&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-3&#34; name=&#34;__codelineno-5-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// information for the shared memory regions used by the request. These&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-4&#34; name=&#34;__codelineno-5-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// pointers will automatically increase the usage count, preventing&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-5&#34; name=&#34;__codelineno-5-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// unregistration of the shared memory. This vector must be cleared in the&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-6&#34; name=&#34;__codelineno-5-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// `InferResponseComplete` callback (after inference) to decrease the count&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-7&#34; name=&#34;__codelineno-5-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// and permit unregistration. The vector will be included in&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-8&#34; name=&#34;__codelineno-5-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// `response_release_payload` for the callback.&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-9&#34; name=&#34;__codelineno-5-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vector&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shared_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SharedMemoryManager&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SharedMemoryInfo&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-10&#34; name=&#34;__codelineno-5-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_regions_info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-11&#34; name=&#34;__codelineno-5-11&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-5-12&#34; name=&#34;__codelineno-5-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-13&#34; name=&#34;__codelineno-5-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferGRPCToInput&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-14&#34; name=&#34;__codelineno-5-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tritonserver_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_manager_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;serialized_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;irequest&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-15&#34; name=&#34;__codelineno-5-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_regions_info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-16&#34; name=&#34;__codelineno-5-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-17&#34; name=&#34;__codelineno-5-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-18&#34; name=&#34;__codelineno-5-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferAllocatorPayload&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inference&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ModelInferResponse&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-19&#34; name=&#34;__codelineno-5-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tritonserver_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_manager_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;move&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;serialized_data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-20&#34; name=&#34;__codelineno-5-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;response_queue&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alloc_payload_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_regions_info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-21&#34; name=&#34;__codelineno-5-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-22&#34; name=&#34;__codelineno-5-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;在InferGRPCToInput如果req是shm信息的，就会获取shm信息。然后将shm信息绑定到req的BufferAttributes中。然后调用infer，跳转的schedule模块（抽象类），再交给具体的dynamic scheduler等调度。将request包装成payload，根据调度策略给到model_instance。然后就可以调度到实现的具体infer backend逻辑了。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-2&#34; name=&#34;__codelineno-6-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nf&#34;&gt;TritonModelInstance::Execute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-3&#34; name=&#34;__codelineno-6-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vector&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONBACKEND_Request&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&amp;gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;triton_requests&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-4&#34; name=&#34;__codelineno-6-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-5&#34; name=&#34;__codelineno-6-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONBACKEND_ModelInstance&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;triton_model_instance&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-6&#34; name=&#34;__codelineno-6-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;reinterpret_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONBACKEND_ModelInstance&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;this&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-7&#34; name=&#34;__codelineno-6-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TritonBackend&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TritonModelInstanceExecFn_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inst_exec_fn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-8&#34; name=&#34;__codelineno-6-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Backend&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ModelInstanceExecFn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-9&#34; name=&#34;__codelineno-6-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-6-10&#34; name=&#34;__codelineno-6-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// If there is an error then we retain ownership of &amp;#39;requests&amp;#39;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-11&#34; name=&#34;__codelineno-6-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// and must send error responses.&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-12&#34; name=&#34;__codelineno-6-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_Error&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inst_exec_fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-13&#34; name=&#34;__codelineno-6-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;triton_model_instance&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;triton_requests&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;triton_requests&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-14&#34; name=&#34;__codelineno-6-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-15&#34; name=&#34;__codelineno-6-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Status&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-16&#34; name=&#34;__codelineno-6-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TritonCodeToStatusCode&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_ErrorCode&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)),&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-17&#34; name=&#34;__codelineno-6-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_ErrorMessage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-18&#34; name=&#34;__codelineno-6-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONBACKEND_Request&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;triton_requests&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-19&#34; name=&#34;__codelineno-6-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferenceRequest&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ur&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-20&#34; name=&#34;__codelineno-6-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;reinterpret_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferenceRequest&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-21&#34; name=&#34;__codelineno-6-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferenceRequest&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RespondIfError&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ur&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* release_requests */&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-22&#34; name=&#34;__codelineno-6-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-23&#34; name=&#34;__codelineno-6-23&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-6-24&#34; name=&#34;__codelineno-6-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_ErrorDelete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-25&#34; name=&#34;__codelineno-6-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-26&#34; name=&#34;__codelineno-6-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;response-处理&#34;&gt;response 处理&lt;a class=&#34;headerlink&#34; href=&#34;#response-处理&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;ModelInferHandler类的构造函数中，注册了回调函数，将ipc信息传递给了Response的allocator。就可以通过ipc返回response给client。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-7-1&#34; name=&#34;__codelineno-7-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Create the allocator that will be used to allocate buffers for&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-2&#34; name=&#34;__codelineno-7-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// the result tensors.&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-3&#34; name=&#34;__codelineno-7-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;FAIL_IF_ERR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-4&#34; name=&#34;__codelineno-7-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_ResponseAllocatorNew&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-5&#34; name=&#34;__codelineno-7-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocator_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferResponseAlloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferResponseFree&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-6&#34; name=&#34;__codelineno-7-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferResponseStart&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-7&#34; name=&#34;__codelineno-7-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;creating inference response allocator&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-8&#34; name=&#34;__codelineno-7-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;FAIL_IF_ERR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-9&#34; name=&#34;__codelineno-7-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_ResponseAllocatorSetQueryFunction&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-10&#34; name=&#34;__codelineno-7-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocator_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OutputBufferQuery&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-11&#34; name=&#34;__codelineno-7-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;setting allocator&amp;#39;s query function&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-12&#34; name=&#34;__codelineno-7-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;FAIL_IF_ERR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-13&#34; name=&#34;__codelineno-7-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_ResponseAllocatorSetBufferAttributesFunction&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-14&#34; name=&#34;__codelineno-7-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;allocator_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OutputBufferAttributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-15&#34; name=&#34;__codelineno-7-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;setting allocator&amp;#39;s output buffer attributes function&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h2 id=&#34;使用shm-extention&#34;&gt;使用shm extention&lt;a class=&#34;headerlink&#34; href=&#34;#使用shm-extention&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;https://docs.nvidia.com/deeplearning/triton-inference-server/user-guide/docs/protocol/extension_shared_memory.html&lt;/p&gt;
&lt;p&gt;要使用shm extention，让req和response传输shm的fd，而不是直接传输数据。&lt;/p&gt;
&lt;p&gt;需要client以http或者grpc的方式发送请求，注册shm区域信息，后面的请求和response就可以直接传输shm的fd使用了。&lt;/p&gt;
&lt;p&gt;在我们编写的backend中可以通过backend api获取request的shm信息。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-40&#34;&gt;40&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-41&#34;&gt;41&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-42&#34;&gt;42&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-43&#34;&gt;43&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-44&#34;&gt;44&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-45&#34;&gt;45&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-46&#34;&gt;46&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-47&#34;&gt;47&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-48&#34;&gt;48&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-49&#34;&gt;49&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-50&#34;&gt;50&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-51&#34;&gt;51&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-52&#34;&gt;52&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-8-1&#34; name=&#34;__codelineno-8-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;TRITONAPI_DECLSPEC&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_Error&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-2&#34; name=&#34;__codelineno-8-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;TRITONBACKEND_RequestOutputBufferProperties&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-3&#34; name=&#34;__codelineno-8-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONBACKEND_Request&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;byte_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-4&#34; name=&#34;__codelineno-8-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_MemoryType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int64_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory_type_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-5&#34; name=&#34;__codelineno-8-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-6&#34; name=&#34;__codelineno-8-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferenceRequest&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;reinterpret_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InferenceRequest&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-7&#34; name=&#34;__codelineno-8-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-8&#34; name=&#34;__codelineno-8-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OutputBufferProperties&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;byte_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory_type_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-9&#34; name=&#34;__codelineno-8-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IsOk&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-10&#34; name=&#34;__codelineno-8-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_ErrorNew&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-11&#34; name=&#34;__codelineno-8-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;StatusCodeToTritonCode&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;StatusCode&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-12&#34; name=&#34;__codelineno-8-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-13&#34; name=&#34;__codelineno-8-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// success&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-14&#34; name=&#34;__codelineno-8-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-15&#34; name=&#34;__codelineno-8-15&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-16&#34; name=&#34;__codelineno-8-16&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-17&#34; name=&#34;__codelineno-8-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-18&#34; name=&#34;__codelineno-8-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;TRITONBACKEND_DECLSPEC&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_Error&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONBACKEND_InputBufferAttributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-19&#34; name=&#34;__codelineno-8-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONBACKEND_Input&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint32_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;index&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;**&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buffer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-20&#34; name=&#34;__codelineno-8-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_BufferAttributes&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;**&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buffer_attributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-21&#34; name=&#34;__codelineno-8-21&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-22&#34; name=&#34;__codelineno-8-22&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-23&#34; name=&#34;__codelineno-8-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// Get the memory type field of the buffer attributes.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-24&#34; name=&#34;__codelineno-8-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-25&#34; name=&#34;__codelineno-8-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// \param buffer_attributes The buffer attributes object.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-26&#34; name=&#34;__codelineno-8-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// \param memory_type Returns the memory type associated with the buffer&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-27&#34; name=&#34;__codelineno-8-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// attributes object.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-28&#34; name=&#34;__codelineno-8-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// \return a TRITONSERVER_Error indicating success or failure.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-29&#34; name=&#34;__codelineno-8-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_DECLSPEC&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_Error&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-30&#34; name=&#34;__codelineno-8-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_BufferAttributesMemoryType&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-31&#34; name=&#34;__codelineno-8-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_BufferAttributes&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buffer_attributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-32&#34; name=&#34;__codelineno-8-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_MemoryType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-33&#34; name=&#34;__codelineno-8-33&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-34&#34; name=&#34;__codelineno-8-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// Get the CudaIpcHandle field of the buffer attributes object.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-35&#34; name=&#34;__codelineno-8-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-36&#34; name=&#34;__codelineno-8-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// \param buffer_attributes The buffer attributes object.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-37&#34; name=&#34;__codelineno-8-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// \param cuda_ipc_handle Returns the memory type associated with the buffer&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-38&#34; name=&#34;__codelineno-8-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// attributes object. If the cudaIpcHandle does not exist for the buffer,&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-39&#34; name=&#34;__codelineno-8-39&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// nullptr will be returned.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-40&#34; name=&#34;__codelineno-8-40&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// \return a TRITONSERVER_Error indicating success or failure.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-41&#34; name=&#34;__codelineno-8-41&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_DECLSPEC&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_Error&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-42&#34; name=&#34;__codelineno-8-42&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_BufferAttributesCudaIpcHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-43&#34; name=&#34;__codelineno-8-43&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_BufferAttributes&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buffer_attributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;**&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuda_ipc_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-44&#34; name=&#34;__codelineno-8-44&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-45&#34; name=&#34;__codelineno-8-45&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// Get the byte size field of the buffer attributes.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-46&#34; name=&#34;__codelineno-8-46&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;///&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-47&#34; name=&#34;__codelineno-8-47&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// \param buffer_attributes The buffer attributes object.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-48&#34; name=&#34;__codelineno-8-48&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// \param byte_size Returns the byte size associated with the buffer attributes&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-49&#34; name=&#34;__codelineno-8-49&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// object.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-50&#34; name=&#34;__codelineno-8-50&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;/// \return a TRITONSERVER_Error indicating success or failure.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-51&#34; name=&#34;__codelineno-8-51&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_DECLSPEC&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_Error&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_BufferAttributesByteSize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-52&#34; name=&#34;__codelineno-8-52&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_BufferAttributes&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buffer_attributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;size_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;byte_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
然后通过shm获得数据，进行处理，再生成response。&lt;/p&gt;
&lt;p&gt;举例：
比如在python backend的实现中：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-9-1&#34; name=&#34;__codelineno-9-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_Error&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-2&#34; name=&#34;__codelineno-9-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nf&#34;&gt;ModelInstanceState::GetInputTensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-3&#34; name=&#34;__codelineno-9-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uint32_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shared_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PbTensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_tensor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-4&#34; name=&#34;__codelineno-9-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONBACKEND_Request&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-5&#34; name=&#34;__codelineno-9-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shared_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vector&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONBACKEND_Response&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&amp;gt;&amp;gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;responses&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-6&#34; name=&#34;__codelineno-9-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-7&#34; name=&#34;__codelineno-9-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_BufferAttributes&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buffer_attributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-8&#34; name=&#34;__codelineno-9-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-9&#34; name=&#34;__codelineno-9-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// This value is not used.&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-10&#34; name=&#34;__codelineno-9-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buffer_p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-11&#34; name=&#34;__codelineno-9-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RETURN_IF_ERROR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONBACKEND_InputBufferAttributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-12&#34; name=&#34;__codelineno-9-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;in&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buffer_p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buffer_attributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-13&#34; name=&#34;__codelineno-9-13&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-14&#34; name=&#34;__codelineno-9-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_tensor&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_shared&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PbTensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-15&#34; name=&#34;__codelineno-9-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-16&#34; name=&#34;__codelineno-9-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vector&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int64_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_shape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_shape&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_dims_count&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-17&#34; name=&#34;__codelineno-9-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_dtype&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;src_memory_type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;src_memory_type_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-18&#34; name=&#34;__codelineno-9-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buffer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_byte_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-19&#34; name=&#34;__codelineno-9-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* DLManagedTensor */&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-20&#34; name=&#34;__codelineno-9-20&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-21&#34; name=&#34;__codelineno-9-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cudaIpcMemHandle_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuda_ipc_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-22&#34; name=&#34;__codelineno-9-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RETURN_IF_ERROR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_BufferAttributesCudaIpcHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-23&#34; name=&#34;__codelineno-9-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;buffer_attributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;reinterpret_cast&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;**&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuda_ipc_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)));&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-24&#34; name=&#34;__codelineno-9-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuda_ipc_handle&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-25&#34; name=&#34;__codelineno-9-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RETURN_IF_EXCEPTION&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SaveToSharedMemory&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-26&#34; name=&#34;__codelineno-9-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Stub&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ShmPool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* copy_gpu */&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-27&#34; name=&#34;__codelineno-9-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RETURN_IF_EXCEPTION&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-28&#34; name=&#34;__codelineno-9-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Memory&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SetCudaIpcHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cuda_ipc_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-29&#34; name=&#34;__codelineno-9-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-30&#34; name=&#34;__codelineno-9-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RETURN_IF_EXCEPTION&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;input_tensor&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SaveToSharedMemory&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-31&#34; name=&#34;__codelineno-9-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Stub&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ShmPool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* copy_gpu */&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-32&#34; name=&#34;__codelineno-9-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-33&#34; name=&#34;__codelineno-9-33&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/tritonserver-multibatch源码分析/&#34; target=&#34;_blank&#34;&gt;tritonserver-multibatch源码分析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c使用abseil-cpp遇到的小问题/&#34; target=&#34;_blank&#34;&gt;C++使用abseil-cpp遇到的小问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/tritonserver%E4%B8%ADshm%E4%BD%BF%E7%94%A8%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/</link>
      <pubDate>Sat, 21 Jun 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/tritonserver%E4%B8%ADshm%E4%BD%BF%E7%94%A8%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/</guid>
      
    </item>
    
    <item>
      <title>tritonserver_python_backend_shm_com源码分析</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;!-- more --&gt;

&lt;h2 id=&#34;背景介绍&#34;&gt;背景介绍&lt;a class=&#34;headerlink&#34; href=&#34;#背景介绍&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;本文介绍了tritonserver中，如何通过共享内存和子进程通信，主要介绍共享内存管理的封装以及c++ boost inprocess模块的使用。这块功能是可以复用的，可以用于其他场景。&lt;/p&gt;
&lt;p&gt;tritonserver作为一个AI推理服务，支持python backend的方式，通过python 子进程方式运行模型或者自定义的逻辑。&lt;/p&gt;
&lt;p&gt;简单来说，就是通过fork启动了一个stub子进程，stub子进程通过pybind11运行用户子定义的python代码。当c++实现的tritonserver收到请求后，就会调用python脚本，经过处理后返回结果。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;fork stub子进程，执行用户自定义的python代码&lt;/li&gt;
&lt;li&gt;tritonserver作为父进程，需要和stub子进程通信，比如控制stub停止、发送请求、控制命令等。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这就设计了进程之间的通信，如果通过网络通信，性能会下降，这里采用了shm（共享内存）的方式。&lt;/p&gt;
&lt;h2 id=&#34;共享内存和消息队列的设计&#34;&gt;共享内存和消息队列的设计&lt;a class=&#34;headerlink&#34; href=&#34;#共享内存和消息队列的设计&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;这里进程间通信，设计了一个消息队列，承载消息队列的载体是共享内存，即通过共享内存来存储消息队列。&lt;/p&gt;
&lt;p&gt;既然是跨进程间传输数据的消息队列，那么肯定两个进程都会获取同一个消息队列的句柄，生产者创建（create）并且发送（push）消息，消费者load消息队列并且消费（pop）消息。&lt;/p&gt;
&lt;h2 id=&#34;从parent进程视角看&#34;&gt;从parent进程视角看&lt;a class=&#34;headerlink&#34; href=&#34;#从parent进程视角看&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;parent进程创建了消息队列，push消息到消息队列stub_message_queue_，然后等待子进程消费消息。然后从parent_message_queue_接受子进程返回的消息。&lt;/p&gt;
&lt;h3 id=&#34;共享内存以及消息队列的创建&#34;&gt;共享内存以及消息队列的创建&lt;a class=&#34;headerlink&#34; href=&#34;#共享内存以及消息队列的创建&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;例如下面是MessageQueue类创建的几种不同的消息队列，用于parent进程和stub进程之间的通信，消息队列的类型是bi::managed_external_buffer::handle_t。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 源码地址：https://github.com/triton-inference-server/python_backend/blob/main/src/stub_launcher.cc#L151&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-2&#34; name=&#34;__codelineno-0-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// stub_message_queue_是parent发送控制信息给stub进程的队列，比如发送初始化、停止等commond&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-3&#34; name=&#34;__codelineno-0-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;RETURN_IF_EXCEPTION&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-4&#34; name=&#34;__codelineno-0-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stub_message_queue_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-5&#34; name=&#34;__codelineno-0-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MessageQueue&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Create&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-6&#34; name=&#34;__codelineno-0-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_message_queue_size_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-7&#34; name=&#34;__codelineno-0-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// parent_message_queue_是stub进程发送信息给parent进程的队列&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-8&#34; name=&#34;__codelineno-0-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RETURN_IF_EXCEPTION&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-9&#34; name=&#34;__codelineno-0-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parent_message_queue_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-10&#34; name=&#34;__codelineno-0-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MessageQueue&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Create&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-11&#34; name=&#34;__codelineno-0-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_message_queue_size_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-12&#34; name=&#34;__codelineno-0-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RETURN_IF_EXCEPTION&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-13&#34; name=&#34;__codelineno-0-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stub_to_parent_mq_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-14&#34; name=&#34;__codelineno-0-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MessageQueue&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Create&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-15&#34; name=&#34;__codelineno-0-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_message_queue_size_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-16&#34; name=&#34;__codelineno-0-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RETURN_IF_EXCEPTION&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-17&#34; name=&#34;__codelineno-0-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parent_to_stub_mq_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-18&#34; name=&#34;__codelineno-0-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MessageQueue&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Create&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-0-19&#34; name=&#34;__codelineno-0-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_message_queue_size_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;SharedMemoryManager类是一个可以复用的类，封装了共享内存的创建和销毁，以及共享内存中对象的构造和析构。这里指定了共享内存的名称，大小，增长大小，是否创建等参数，为进程通信创建了一段shm共享内存。&lt;/p&gt;
&lt;p&gt;并且在共享内存中创建了IPCControlShm对象，这个对象包含了消息队列的句柄，以及一些进程健康状态的标志位。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SharedMemoryManager&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_unique&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SharedMemoryManager&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_region_name_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_default_byte_size_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_growth_byte_size_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-3&#34; name=&#34;__codelineno-1-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* create */&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-4&#34; name=&#34;__codelineno-1-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;AllocatedSharedMemory&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IPCControlShm&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;current_ipc_control&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-5&#34; name=&#34;__codelineno-1-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Construct&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IPCControlShm&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;IPCControlShm结构体包含了进程通信需要的所有信息，包括两个进程的健康状态，两个进程的消息队列句柄等。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Control data structure for the communication between the Python stub and the&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// main stub.&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;IPCControlShm&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-4&#34; name=&#34;__codelineno-2-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stub_health&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-5&#34; name=&#34;__codelineno-2-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parent_health&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-6&#34; name=&#34;__codelineno-2-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uses_env&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-7&#34; name=&#34;__codelineno-2-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;decoupled&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-8&#34; name=&#34;__codelineno-2-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;interprocess_mutex&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parent_health_mutex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-9&#34; name=&#34;__codelineno-2-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;interprocess_mutex&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stub_health_mutex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-10&#34; name=&#34;__codelineno-2-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stub_message_queue&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-11&#34; name=&#34;__codelineno-2-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parent_message_queue&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-12&#34; name=&#34;__codelineno-2-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stub_to_parent_mq&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-13&#34; name=&#34;__codelineno-2-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parent_to_stub_mq&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-14&#34; name=&#34;__codelineno-2-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;memory_manager_message_queue&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-15&#34; name=&#34;__codelineno-2-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h3 id=&#34;发送消息&#34;&gt;发送消息&lt;a class=&#34;headerlink&#34; href=&#34;#发送消息&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;下面的代码描述了如何从parent进程发送一个initialize_message给到stub进程。构造一个IPCMessage类型的消息，为消息赋值，再将消息Push到stub_message_queue_中。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unordered_map&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;initialize_map&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;model_config&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_config_buffer_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MutableContents&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()},&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;model_instance_kind&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;kind_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;model_instance_name&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_instance_name_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-5&#34; name=&#34;__codelineno-3-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;model_instance_device_id&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;device_id_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)},&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-6&#34; name=&#34;__codelineno-3-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;model_repository&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_repository_path_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-7&#34; name=&#34;__codelineno-3-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;model_version&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_version_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)},&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-8&#34; name=&#34;__codelineno-3-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;model_name&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_name_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}};&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-9&#34; name=&#34;__codelineno-3-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-10&#34; name=&#34;__codelineno-3-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IPCMessage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;initialize_message&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-11&#34; name=&#34;__codelineno-3-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IPCMessage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Create&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* inline_response */&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-12&#34; name=&#34;__codelineno-3-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;initialize_message&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Command&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PYTHONSTUB_InitializeRequest&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-13&#34; name=&#34;__codelineno-3-13&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-14&#34; name=&#34;__codelineno-3-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PbMap&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pb_map&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PbMap&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Create&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;initialize_map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-15&#34; name=&#34;__codelineno-3-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;initialize_map_handle&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-16&#34; name=&#34;__codelineno-3-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pb_map&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ShmHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-17&#34; name=&#34;__codelineno-3-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-18&#34; name=&#34;__codelineno-3-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;initialize_message&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;initialize_map_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-19&#34; name=&#34;__codelineno-3-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;stub_message_queue_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Push&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;initialize_message&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ShmHandle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;接收消息&#34;&gt;接收消息&lt;a class=&#34;headerlink&#34; href=&#34;#接收消息&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;上小节提到的initialize_message是如何被接收处理的呢？看下面的代码，ReceiveMessageFromStub函数接受消息，然后通过shm_pool_共享内存方式获取消息具体的内容。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;RETURN_IF_ERROR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReceiveMessageFromStub&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;initialization_timeout_ms&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-3&#34; name=&#34;__codelineno-4-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-4&#34; name=&#34;__codelineno-4-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IPCMessage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;initialize_response_message&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-5&#34; name=&#34;__codelineno-4-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IPCMessage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LoadFromSharedMemory&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-6&#34; name=&#34;__codelineno-4-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-7&#34; name=&#34;__codelineno-4-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;initialize_response_message&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Command&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PYTHONSTUB_InitializeResponse&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-8&#34; name=&#34;__codelineno-4-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_ErrorNew&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-9&#34; name=&#34;__codelineno-4-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TRITONSERVER_ERROR_INTERNAL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-10&#34; name=&#34;__codelineno-4-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-11&#34; name=&#34;__codelineno-4-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Received unexpected response from Python backend stub: &amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-12&#34; name=&#34;__codelineno-4-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_instance_name_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-13&#34; name=&#34;__codelineno-4-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-14&#34; name=&#34;__codelineno-4-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-15&#34; name=&#34;__codelineno-4-15&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-4-16&#34; name=&#34;__codelineno-4-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;initialize_response&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-17&#34; name=&#34;__codelineno-4-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;move&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Load&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InitializeResponseShm&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-18&#34; name=&#34;__codelineno-4-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;initialize_response_message&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())))&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-19&#34; name=&#34;__codelineno-4-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;ReceiveMessageFromStub实际上就是从消息队列parent_message_queue_中取出消息。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;message&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parent_message_queue_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Pop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;timeout_miliseconds&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* duration ms */&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;success&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h2 id=&#34;从stub进程视角看&#34;&gt;从stub进程视角看&lt;a class=&#34;headerlink&#34; href=&#34;#从stub进程视角看&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;从stub进程，也就是python子进程视角看，它就不是创建共享内存了。而是使用parent进程创建的共享内存，然后通过LoadFromSharedMemory方法load创建好的消息队列，直接使用。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// https://github.com/triton-inference-server/python_backend/blob/main/src/pb_stub.cc#L164&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-2&#34; name=&#34;__codelineno-6-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;make_unique&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SharedMemoryManager&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-3&#34; name=&#34;__codelineno-6-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_region_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_default_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_growth_size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* create */&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-4&#34; name=&#34;__codelineno-6-4&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-6-5&#34; name=&#34;__codelineno-6-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;AllocatedSharedMemory&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IPCControlShm&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ipc_control&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-6&#34; name=&#34;__codelineno-6-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Load&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IPCControlShm&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ipc_control_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-7&#34; name=&#34;__codelineno-6-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ipc_control_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ipc_control&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;data_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-8&#34; name=&#34;__codelineno-6-8&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-6-9&#34; name=&#34;__codelineno-6-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;stub_message_queue_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MessageQueue&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;::&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-10&#34; name=&#34;__codelineno-6-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LoadFromSharedMemory&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ipc_control_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stub_message_queue&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
上面说了parent给stub发送了一个initialize_message，stub进程收到后，会回复一个initialize_response。子进程通过Pop从stub_message_queue_接受消息。&lt;/p&gt;
&lt;h3 id=&#34;接收消息_1&#34;&gt;接收消息&lt;a class=&#34;headerlink&#34; href=&#34;#接收消息_1&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;stub进程如何接受消息呢？上面提到parent进程发送消息就是将消息入队列stub_message_queue_，在stub进程的调用的PopMessage函数中，就是通过Pop从队列中取消息。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-7-1&#34; name=&#34;__codelineno-7-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IPCMessage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-2&#34; name=&#34;__codelineno-7-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;Stub&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PopMessage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-3&#34; name=&#34;__codelineno-7-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-4&#34; name=&#34;__codelineno-7-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;success&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-5&#34; name=&#34;__codelineno-7-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IPCMessage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ipc_message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-6&#34; name=&#34;__codelineno-7-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-7&#34; name=&#34;__codelineno-7-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;while&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;success&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-8&#34; name=&#34;__codelineno-7-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;message&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stub_message_queue_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Pop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;success&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-9&#34; name=&#34;__codelineno-7-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-10&#34; name=&#34;__codelineno-7-10&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-11&#34; name=&#34;__codelineno-7-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ipc_message&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IPCMessage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LoadFromSharedMemory&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-12&#34; name=&#34;__codelineno-7-12&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-13&#34; name=&#34;__codelineno-7-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ipc_message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-14&#34; name=&#34;__codelineno-7-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
stub进程的核心逻辑就是调用RunCommand方法，这个方法会从stub_message_queue_中取出消息，然后根据消息类型执行不同的逻辑。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-8-1&#34; name=&#34;__codelineno-8-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IPCMessage&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ipc_message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-2&#34; name=&#34;__codelineno-8-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-3&#34; name=&#34;__codelineno-8-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Release the GIL lock when waiting for new message. Without this line, the&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-4&#34; name=&#34;__codelineno-8-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// other threads in the user&amp;#39;s Python model cannot make progress if they&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-5&#34; name=&#34;__codelineno-8-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// give up GIL.&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-6&#34; name=&#34;__codelineno-8-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gil_scoped_release&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;release&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-7&#34; name=&#34;__codelineno-8-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;ipc_message&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;this&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PopMessage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-8&#34; name=&#34;__codelineno-8-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-9&#34; name=&#34;__codelineno-8-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;switch&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ipc_message&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Command&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-10&#34; name=&#34;__codelineno-8-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;no&#34;&gt;PYTHONSTUB_CommandType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;PYTHONSTUB_InitializeRequest&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-8-11&#34; name=&#34;__codelineno-8-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;//...&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-12&#34; name=&#34;__codelineno-8-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h3 id=&#34;pybind11调用python逻辑&#34;&gt;pybind11调用python逻辑&lt;a class=&#34;headerlink&#34; href=&#34;#pybind11调用python逻辑&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;stub是一个c++实现的进程，它收到initialize_message后，会通过pybind11库。&lt;/p&gt;
&lt;p&gt;pybind11库可以调用用户实现的python逻辑，比如获取python类、调用类功能函数。这里简单放一下代码，很容易理解：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-25&#34;&gt;25&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-26&#34;&gt;26&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-27&#34;&gt;27&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-28&#34;&gt;28&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-29&#34;&gt;29&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-30&#34;&gt;30&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-31&#34;&gt;31&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-32&#34;&gt;32&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-33&#34;&gt;33&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-34&#34;&gt;34&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-35&#34;&gt;35&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-36&#34;&gt;36&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-37&#34;&gt;37&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-38&#34;&gt;38&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-39&#34;&gt;39&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-9-1&#34; name=&#34;__codelineno-9-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;pybind11/embed.h&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-2&#34; name=&#34;__codelineno-9-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;pybind11/numpy.h&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-3&#34; name=&#34;__codelineno-9-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;pybind11/stl.h&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-4&#34; name=&#34;__codelineno-9-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;k&#34;&gt;namespace&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;py&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;pybind11&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-5&#34; name=&#34;__codelineno-9-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-6&#34; name=&#34;__codelineno-9-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nf&#34;&gt;Stub::Initialize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;managed_external_buffer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-7&#34; name=&#34;__codelineno-9-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-8&#34; name=&#34;__codelineno-9-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;module&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sys&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;StubSetup&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-9&#34; name=&#34;__codelineno-9-9&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-10&#34; name=&#34;__codelineno-9-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;module&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;python_backend_utils&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-11&#34; name=&#34;__codelineno-9-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;module_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;import&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;triton_python_backend_utils&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-12&#34; name=&#34;__codelineno-9-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;module&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_python_backend_utils&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-13&#34; name=&#34;__codelineno-9-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;module_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;import&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;c_python_backend_utils&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-14&#34; name=&#34;__codelineno-9-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// ......&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-15&#34; name=&#34;__codelineno-9-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_python_backend_utils&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;attr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;shared_memory&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cast&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-16&#34; name=&#34;__codelineno-9-16&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-17&#34; name=&#34;__codelineno-9-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;async_event_loop_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;none&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-18&#34; name=&#34;__codelineno-9-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;background_futures_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-19&#34; name=&#34;__codelineno-9-19&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-20&#34; name=&#34;__codelineno-9-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 创建一个TritonPythonModel对象，这个对象是用户实现的python类，用户需要在类中实现initialize、execute、finalizer等函数&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-21&#34; name=&#34;__codelineno-9-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;object&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TritonPythonModel&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sys&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;attr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;TritonPythonModel&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-22&#34; name=&#34;__codelineno-9-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_instance_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TritonPythonModel&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-23&#34; name=&#34;__codelineno-9-23&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-24&#34; name=&#34;__codelineno-9-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unordered_map&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-25&#34; name=&#34;__codelineno-9-25&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;std&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unique_ptr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PbMap&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pb_map_shm&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-26&#34; name=&#34;__codelineno-9-26&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PbMap&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LoadFromSharedMemory&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shm_pool_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-27&#34; name=&#34;__codelineno-9-27&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Get the unordered_map representation of the map in shared memory.&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-28&#34; name=&#34;__codelineno-9-28&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pb_map_shm&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;UnorderedMap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-29&#34; name=&#34;__codelineno-9-29&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dict&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_config_params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-30&#34; name=&#34;__codelineno-9-30&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;auto&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pair&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-31&#34; name=&#34;__codelineno-9-31&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_config_params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pair&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;first&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pair&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;second&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-32&#34; name=&#34;__codelineno-9-32&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-33&#34; name=&#34;__codelineno-9-33&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-9-34&#34; name=&#34;__codelineno-9-34&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Call initialize if exists.&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-35&#34; name=&#34;__codelineno-9-35&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 调用用户实现的initialize函数&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-36&#34; name=&#34;__codelineno-9-36&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hasattr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_instance_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;initialize&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-37&#34; name=&#34;__codelineno-9-37&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_instance_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;attr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;initialize&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;model_config_params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-38&#34; name=&#34;__codelineno-9-38&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-39&#34; name=&#34;__codelineno-9-39&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h2 id=&#34;总结&#34;&gt;总结&lt;a class=&#34;headerlink&#34; href=&#34;#总结&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;本文由于篇幅限制，介绍了triton的IPC通信机制，以及stub进程的初始化过程，以及介绍stub进程如何执行用户实现的python逻辑。其中的进程间通信机制和pybind11调用python逻辑，可以复用到你自己的项目中。这种跨语言调用很常见，常见的还有c++中调用lua、调用js等。&lt;/p&gt;
&lt;p&gt;消息队列使用到了SharedMemoryManager类，该类采用boost.interprocess库实现。关于&lt;a href=&#34;https://github.com/triton-inference-server/python_backend/blob/main/src/message_queue.h#L67&#34;&gt;消息队列的实现&lt;/a&gt;以及&lt;a href=&#34;https://github.com/triton-inference-server/python_backend/blob/main/src/shm_manager.h#L44&#34;&gt;共享内存的boost.interprocess库的使用&lt;/a&gt;，可以参考源代码实现。后续文章可能会展开介绍。&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/cutlass库中的尾声融合epilogue-fusion和epilogue-visitor-trees/&#34; target=&#34;_blank&#34;&gt;CUTLASS库中的尾声融合(Epilogue Fusion)和Epilogue Visitor Trees&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/从deepseek开源库3fs中学习fuse的使用-如何开发一个文件系统一/&#34; target=&#34;_blank&#34;&gt;从Deepseek开源库3FS中学习fuse的使用-如何开发一个文件系统（一）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/tritonserver_python_backend_shm_com%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</link>
      <pubDate>Sat, 21 Jun 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/tritonserver_python_backend_shm_com%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</guid>
      
    </item>
    
    <item>
      <title>函数Hook（LD_PRELOAD）、审计流劫持（LD_AUDIT）及函数插桩</title>
      
      
        
      <author>KenForever1</author>
        
      
      
      
      <description>&lt;p&gt;Linux从符号劫持到运行时追踪：函数Hook（LD_PRELOAD）、审计流劫持（LD_AUDIT）及函数插桩。&lt;/p&gt;
&lt;!-- more --&gt;
&lt;h2 id=&#34;ldprload方式进行hook&#34;&gt;LDPRLOAD方式进行Hook&lt;a class=&#34;headerlink&#34; href=&#34;#ldprload方式进行hook&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&#34;ldprload方式进行hook_1&#34;&gt;LDPRLOAD方式进行Hook&lt;a class=&#34;headerlink&#34; href=&#34;#ldprload方式进行hook_1&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;LD_PRELOAD允许在程序运行时优先加载指定的动态链接库(.so文件)，覆盖默认的库函数实现。动态链接器会优先检查LD_PRELOAD指定的库，若其中存在与程序调用的同名函数，则使用该库中的实现而非系统默认版本。函数劫持与Hook，比如替换malloc的实现，替换so库中的函数，都可以通过LD_PRELOAD实现。&lt;/p&gt;
&lt;p&gt;举个相关的使用例子：
+ &lt;strong&gt;jemalloc的使用&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在&lt;a href=&#34;https://github.com/jemalloc/jemalloc/wiki/Getting-Started&#34;&gt;jemalloc的使用中&lt;/a&gt;, 有几种方法可以将jemalloc集成到应用程序中。&lt;/p&gt;
&lt;p&gt;最简单的就是，使用LD_PRELOAD环境变量在运行时将jemalloc注入应用程序。请注意，只有当您的应用程序没有静态链接malloc实现时，此方法才有效。&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-0-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-0-1&#34; name=&#34;__codelineno-0-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;nv&#34;&gt;LD_PRELOAD&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;sb&#34;&gt;`&lt;/span&gt;jemalloc-config&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;--libdir&lt;span class=&#34;sb&#34;&gt;`&lt;/span&gt;/libjemalloc.so.&lt;span class=&#34;sb&#34;&gt;`&lt;/span&gt;jemalloc-config&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;--revision&lt;span class=&#34;sb&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;app
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
除了这种方式，就是编译时动态链接和静态链接jemalloc到你的应用程序。
在开发中，可以利用这种方式查找内存崩溃的Bug、内存分配情况分析、Heap Profiler、解决内存泄露等。&lt;/p&gt;
&lt;h3 id=&#34;rtld_next方式进行hook&#34;&gt;RTLD_NEXT方式进行Hook&lt;a class=&#34;headerlink&#34; href=&#34;#rtld_next方式进行hook&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;除了LD_PRELOAD方式，还可以通过‌&lt;strong&gt;dlsym RTLD_NEXT‌&lt;/strong&gt;进行Hook。&lt;/p&gt;
&lt;p&gt;如果dlsym或dlvsym函数的第一个参数的值被设置为RTLD_NEXT，那么该函数返回下一个共享对象中名为NAME的符号的运行时地址，通常用于在Hook代码中调用原始函数。通过这种方式，我们可以实现一个自定义malloc函数，通过RTLD_NEXT拿到原始malloc的指针，从而可以在自定义malloc中调用原始malloc函数。达到Hook的目的。&lt;/p&gt;
&lt;p&gt;运行时符号解析函数，用于在已加载的库链中查找下一个符合条件的符号实现。&lt;/p&gt;
&lt;p&gt;举个相关的使用例子：
+ &lt;strong&gt;协程网络库中hook&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/gatsbyd/melon/blob/master/src/Hook.cpp&#34;&gt;基于协程和事件循环的c++网络库&lt;/a&gt;中，通过dlsym RTLD_NEXT实现hook。包括了hook read、recv、send、sleep等函数。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-1-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-1-1&#34; name=&#34;__codelineno-1-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#define DLSYM(name) \&lt;/span&gt;
&lt;a id=&#34;__codelineno-1-2&#34; name=&#34;__codelineno-1-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;        name ## _f = (name ## _t)::dlsym(RTLD_NEXT, #name);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-2-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-2-1&#34; name=&#34;__codelineno-2-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;sleep&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;seconds&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-2&#34; name=&#34;__codelineno-2-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;melon&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Processer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;processer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;melon&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Processer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GetProcesserOfThisThread&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-3&#34; name=&#34;__codelineno-2-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;melon&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;isHookEnabled&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-4&#34; name=&#34;__codelineno-2-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 不hook时直接调用系统函数，sleep_f = dlsym(RTLD_NEXT, &amp;quot;sleep&amp;quot;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-5&#34; name=&#34;__codelineno-2-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sleep_f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;seconds&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-6&#34; name=&#34;__codelineno-2-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-7&#34; name=&#34;__codelineno-2-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-2-8&#34; name=&#34;__codelineno-2-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// hook时，将当前协程挂起，等待seconds秒后继续执行&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-9&#34; name=&#34;__codelineno-2-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;melon&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scheduler&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;scheduler&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;processer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;getScheduler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-10&#34; name=&#34;__codelineno-2-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assert&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;scheduler&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;nullptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-11&#34; name=&#34;__codelineno-2-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;scheduler&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;runAt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;melon&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Timestamp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;now&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;seconds&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;melon&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Timestamp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;kMicrosecondsPerSecond&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;melon&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Coroutine&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GetCurrentCoroutine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-12&#34; name=&#34;__codelineno-2-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;melon&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Coroutine&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SwapOut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-13&#34; name=&#34;__codelineno-2-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-2-14&#34; name=&#34;__codelineno-2-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h2 id=&#34;ld_audit链接器监听机制&#34;&gt;LD_AUDIT链接器监听机制&lt;a class=&#34;headerlink&#34; href=&#34;#ld_audit链接器监听机制&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;通过前面的介绍，你对LD_LIBRARY、LD_PRELOAD肯定很熟悉了。LD_AUDIT是Linux系统中glibc动态链接器(ld.so)的另一个环境变量，用于指定审计库(audit library)的路径，主要用于监控和拦截动态链接库的加载过程&lt;/p&gt;
&lt;p&gt;通过LD_AUDIT链接器监听机制，我们可以操纵glibc的动态链接过程，比如可以拦截动态链接库的加载过程，或者拦截动态链接库的符号解析过程。在xz-sshd漏洞中，攻击者通过LD_AUDIT劫持RSA解密函数调用链，实现权限提升。&lt;/p&gt;
&lt;p&gt;看一个简单的例子：&lt;/p&gt;
&lt;p&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-3-24&#34;&gt;24&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-3-1&#34; name=&#34;__codelineno-3-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// audit_example.c&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-2&#34; name=&#34;__codelineno-3-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#define _GNU_SOURCE&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-3&#34; name=&#34;__codelineno-3-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;link.h&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-4&#34; name=&#34;__codelineno-3-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-5&#34; name=&#34;__codelineno-3-5&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-6&#34; name=&#34;__codelineno-3-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 必须实现的版本检查函数&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-7&#34; name=&#34;__codelineno-3-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;la_version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-8&#34; name=&#34;__codelineno-3-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;审计库版本: %u (支持最高版本%u)&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LAV_CURRENT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-9&#34; name=&#34;__codelineno-3-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LAV_CURRENT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 返回支持的版本号&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-10&#34; name=&#34;__codelineno-3-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-11&#34; name=&#34;__codelineno-3-11&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-12&#34; name=&#34;__codelineno-3-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 库加载时触发的回调&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-13&#34; name=&#34;__codelineno-3-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;la_objopen&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;link_map&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Lmid_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lmid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uintptr_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cookie&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-14&#34; name=&#34;__codelineno-3-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;检测到库加载: %s (ID: %p)&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cookie&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-15&#34; name=&#34;__codelineno-3-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LA_FLG_BINDTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LA_FLG_BINDFROM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 允许符号绑定追踪&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-16&#34; name=&#34;__codelineno-3-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-17&#34; name=&#34;__codelineno-3-17&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-3-18&#34; name=&#34;__codelineno-3-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 符号绑定前触发的回调&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-19&#34; name=&#34;__codelineno-3-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;uintptr_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;la_symbind64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Elf64_Sym&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sym&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ndx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-20&#34; name=&#34;__codelineno-3-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                      &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uintptr_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;refcook&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uintptr_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;defcook&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-21&#34; name=&#34;__codelineno-3-21&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                      &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;flags&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;symname&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-22&#34; name=&#34;__codelineno-3-22&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;符号绑定: %s (地址: %#lx)&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;symname&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sym&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;st_value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-23&#34; name=&#34;__codelineno-3-23&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sym&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;st_value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 返回原始地址（可修改）&lt;/span&gt;
&lt;a id=&#34;__codelineno-3-24&#34; name=&#34;__codelineno-3-24&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-7&#34;&gt;7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-8&#34;&gt;8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-4-9&#34;&gt;9&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-4-1&#34; name=&#34;__codelineno-4-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// test_program.c&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-2&#34; name=&#34;__codelineno-4-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-3&#34; name=&#34;__codelineno-4-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-4&#34; name=&#34;__codelineno-4-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;hello&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-5&#34; name=&#34;__codelineno-4-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-6&#34; name=&#34;__codelineno-4-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-7&#34; name=&#34;__codelineno-4-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 编译审计库：gcc -shared -fPIC audit_example.c -o libaudit.so -ldl&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-8&#34; name=&#34;__codelineno-4-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 编译测试程序：gcc test_program.c -o test -ldl&lt;/span&gt;
&lt;a id=&#34;__codelineno-4-9&#34; name=&#34;__codelineno-4-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 运行测试：LD_AUDIT=./libaudit.so ./test&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
打印输出：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-21&#34;&gt;21&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-22&#34;&gt;22&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-5-23&#34;&gt;23&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-5-1&#34; name=&#34;__codelineno-5-1&#34;&gt;&lt;/a&gt;审计库版本:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;支持最高版本2&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-2&#34; name=&#34;__codelineno-5-2&#34;&gt;&lt;/a&gt;检测到库加载:&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;ID:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff87a2c370&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-3&#34; name=&#34;__codelineno-5-3&#34;&gt;&lt;/a&gt;检测到库加载:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;/lib/ld-linux-aarch64.so.1&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;ID:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff87a2bb88&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-4&#34; name=&#34;__codelineno-5-4&#34;&gt;&lt;/a&gt;检测到库加载:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;linux-vdso.so.1&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;ID:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff87a2c950&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-5&#34; name=&#34;__codelineno-5-5&#34;&gt;&lt;/a&gt;检测到库加载:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;/lib/aarch64-linux-gnu/libc.so.6&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;ID:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff87a1d880&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-6&#34; name=&#34;__codelineno-5-6&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;__libc_start_main&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff87597434&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-7&#34; name=&#34;__codelineno-5-7&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;__cxa_finalize&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff875ad220&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-8&#34; name=&#34;__codelineno-5-8&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;abort&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff8759704c&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-9&#34; name=&#34;__codelineno-5-9&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;puts&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff875dae70&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-10&#34; name=&#34;__codelineno-5-10&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;calloc&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff875fe460&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-11&#34; name=&#34;__codelineno-5-11&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;free&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff875fdbc4&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-12&#34; name=&#34;__codelineno-5-12&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;malloc&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff875fd630&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-13&#34; name=&#34;__codelineno-5-13&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;realloc&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff875fde20&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-14&#34; name=&#34;__codelineno-5-14&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;_dl_catch_exception&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff8769d290&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-15&#34; name=&#34;__codelineno-5-15&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;_dl_signal_exception&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff8769d1e4&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-16&#34; name=&#34;__codelineno-5-16&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;__tls_get_addr&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff87a00cd0&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-17&#34; name=&#34;__codelineno-5-17&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;_dl_signal_error&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff8769d234&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-18&#34; name=&#34;__codelineno-5-18&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;_dl_catch_error&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff8769d390&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-19&#34; name=&#34;__codelineno-5-19&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;__tunable_get_val&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff87a02d40&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-20&#34; name=&#34;__codelineno-5-20&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;__getauxval&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff87655560&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-21&#34; name=&#34;__codelineno-5-21&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;_dl_audit_preinit&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff87a03774&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-22&#34; name=&#34;__codelineno-5-22&#34;&gt;&lt;/a&gt;符号绑定:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;malloc&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;地址:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;0xffff875fd630&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;a id=&#34;__codelineno-5-23&#34; name=&#34;__codelineno-5-23&#34;&gt;&lt;/a&gt;测试程序运行中...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
不同于LD_PRELOAD（强制预加载库），LD_AUDIT&lt;strong&gt;更侧重链接过程的‌事件监控‌&lt;/strong&gt;而非直接替换函数。当然，也是可以劫持替换函数实现的。&lt;/p&gt;
&lt;p&gt;应用例子，在&lt;a href=&#34;https://zhuanlan.zhihu.com/p/689983608&#34;&gt;xz-sshd漏洞可能的原理解读——链接器监听机制&lt;/a&gt;中，通过la_symbind64函数劫持RSA_public_decrypt， 替换为自己实现的hijack_RSA_public_decrypt函数。
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-6-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-6-1&#34; name=&#34;__codelineno-6-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// Called when a symbol is bound&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-2&#34; name=&#34;__codelineno-6-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;uintptr_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;la_symbind64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Elf64_Sym&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sym&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ndx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uintptr_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;refcook&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-3&#34; name=&#34;__codelineno-6-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;                     &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uintptr_t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;defcook&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;flags&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;symname&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-4&#34; name=&#34;__codelineno-6-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Symbol bound: %s&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;symname&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-5&#34; name=&#34;__codelineno-6-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Perform any custom actions here&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-6&#34; name=&#34;__codelineno-6-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;strcmp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;symname&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;RSA_public_decrypt&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-7&#34; name=&#34;__codelineno-6-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uintptr_t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hijack_RSA_public_decrypt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-8&#34; name=&#34;__codelineno-6-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-9&#34; name=&#34;__codelineno-6-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sym&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;st_value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Return the symbol&amp;#39;s actual address&lt;/span&gt;
&lt;a id=&#34;__codelineno-6-10&#34; name=&#34;__codelineno-6-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;h2 id=&#34;gcc函数插桩功能-finstrument-functions&#34;&gt;GCC函数插桩功能（-finstrument-functions）&lt;a class=&#34;headerlink&#34; href=&#34;#gcc函数插桩功能-finstrument-functions&#34; title=&#34;Permanent link&#34;&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;GCC的-finstrument-functions是一个强大的编译选项，用于在函数入口和出口自动插入钩子函数，主要用于性能分析和调用追踪。&lt;/p&gt;
&lt;p&gt;编译时添加该选项后，GCC会在每个函数的开始插入__cyg_profile_func_enter，在函数返回前插入__cyg_profile_func_exit。这两个钩子函数的参数包含当前函数地址和调用者地址。通过这个功能，我们可以统计函数耗时，定位执行异常的函数，分析性能瓶颈等，当然也可以用ebpf直接抓取。记录函数调用路径，辅助调试复杂调用关系等。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-16&#34;&gt;16&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-17&#34;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-18&#34;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-19&#34;&gt;19&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-7-20&#34;&gt;20&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-7-1&#34; name=&#34;__codelineno-7-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// instrument.c&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-2&#34; name=&#34;__codelineno-7-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#define _GNU_SOURCE&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-3&#34; name=&#34;__codelineno-7-3&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-4&#34; name=&#34;__codelineno-7-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;dlfcn.h&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-5&#34; name=&#34;__codelineno-7-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;time.h&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-6&#34; name=&#34;__codelineno-7-6&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-7&#34; name=&#34;__codelineno-7-7&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// 必须禁止钩子函数自身被插桩&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-8&#34; name=&#34;__codelineno-7-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;__attribute__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;no_instrument_function&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-9&#34; name=&#34;__codelineno-7-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;__cyg_profile_func_enter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-10&#34; name=&#34;__codelineno-7-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Dl_info&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-11&#34; name=&#34;__codelineno-7-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dladdr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-12&#34; name=&#34;__codelineno-7-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;▶ ENTER: %s [%p]&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dli_sname&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dli_sname&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;unknown&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-13&#34; name=&#34;__codelineno-7-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-14&#34; name=&#34;__codelineno-7-14&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-7-15&#34; name=&#34;__codelineno-7-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;__attribute__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;no_instrument_function&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;
&lt;a id=&#34;__codelineno-7-16&#34; name=&#34;__codelineno-7-16&#34;&gt;&lt;/a&gt;&lt;span class=&#34;n&#34;&gt;__cyg_profile_func_exit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-17&#34; name=&#34;__codelineno-7-17&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Dl_info&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-18&#34; name=&#34;__codelineno-7-18&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dladdr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-19&#34; name=&#34;__codelineno-7-19&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;◀ EXIT: %s [%p]&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dli_sname&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dli_sname&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;unknown&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-7-20&#34; name=&#34;__codelineno-7-20&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;C++&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-1&#34;&gt; 1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-2&#34;&gt; 2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-3&#34;&gt; 3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-4&#34;&gt; 4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-5&#34;&gt; 5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-6&#34;&gt; 6&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-7&#34;&gt; 7&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-8&#34;&gt; 8&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-9&#34;&gt; 9&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-10&#34;&gt;10&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-11&#34;&gt;11&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-12&#34;&gt;12&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-13&#34;&gt;13&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-14&#34;&gt;14&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-8-15&#34;&gt;15&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-8-1&#34; name=&#34;__codelineno-8-1&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// main.c&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-2&#34; name=&#34;__codelineno-8-2&#34;&gt;&lt;/a&gt;&lt;span class=&#34;cp&#34;&gt;#include&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cpf&#34;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-3&#34; name=&#34;__codelineno-8-3&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-4&#34; name=&#34;__codelineno-8-4&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;void&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;test_func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-5&#34; name=&#34;__codelineno-8-5&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sleep&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 模拟耗时操作&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-6&#34; name=&#34;__codelineno-8-6&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-7&#34; name=&#34;__codelineno-8-7&#34;&gt;&lt;/a&gt;
&lt;a id=&#34;__codelineno-8-8&#34; name=&#34;__codelineno-8-8&#34;&gt;&lt;/a&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-9&#34; name=&#34;__codelineno-8-9&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;Start tracing...&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-10&#34; name=&#34;__codelineno-8-10&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-11&#34; name=&#34;__codelineno-8-11&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;End tracing&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-12&#34; name=&#34;__codelineno-8-12&#34;&gt;&lt;/a&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-13&#34; name=&#34;__codelineno-8-13&#34;&gt;&lt;/a&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-14&#34; name=&#34;__codelineno-8-14&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// gcc -finstrument-functions main.c instrument.c -ldl -rdynamic -o demo&lt;/span&gt;
&lt;a id=&#34;__codelineno-8-15&#34; name=&#34;__codelineno-8-15&#34;&gt;&lt;/a&gt;&lt;span class=&#34;c1&#34;&gt;// ./demo&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;输出：
&lt;div class=&#34;highlight&#34;&gt;&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;th colspan=&#34;2&#34; class=&#34;filename&#34;&gt;&lt;span class=&#34;filename&#34;&gt;Bash&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;linenos&#34;&gt;&lt;div class=&#34;linenodiv&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-1&#34;&gt;1&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-2&#34;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-3&#34;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-4&#34;&gt;4&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-5&#34;&gt;5&lt;/a&gt;&lt;/span&gt;
&lt;span class=&#34;normal&#34;&gt;&lt;a href=&#34;#__codelineno-9-6&#34;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;a id=&#34;__codelineno-9-1&#34; name=&#34;__codelineno-9-1&#34;&gt;&lt;/a&gt;▶&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;ENTER:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;main&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;0xaaaadcf80bf4&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-2&#34; name=&#34;__codelineno-9-2&#34;&gt;&lt;/a&gt;Start&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;tracing...
&lt;a id=&#34;__codelineno-9-3&#34; name=&#34;__codelineno-9-3&#34;&gt;&lt;/a&gt;▶&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;ENTER:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;test_func&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;0xaaaadcf80b94&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-4&#34; name=&#34;__codelineno-9-4&#34;&gt;&lt;/a&gt;◀&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;EXIT:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;test_func&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;0xaaaadcf80b94&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;a id=&#34;__codelineno-9-5&#34; name=&#34;__codelineno-9-5&#34;&gt;&lt;/a&gt;End&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;tracing
&lt;a id=&#34;__codelineno-9-6&#34; name=&#34;__codelineno-9-6&#34;&gt;&lt;/a&gt;◀&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;EXIT:&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;main&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;0xaaaadcf80bf4&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;使用__attribute__((no_instrument_function))避免钩子函数自身被插桩。需自定义钩子函数，通常结合dladdr解析函数名和文件名。&lt;/p&gt;
&lt;p&gt;通过addr2line工具将地址转换为源代码行号，结合perf等工具分析性能。&lt;/p&gt;
&lt;p&gt;这个功能具体咋用的呢？举两个例子：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;开源工具&lt;a href=&#34;https://github.com/namhyung/uftrace&#34;&gt;uftrace&lt;/a&gt;就使用到了这个功能获取数据, uftrace是一款用于C、C++、Rust和Python程序的函数调用图追踪工具。&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;User space C/C++/Rust functions, by either dynamically patching functions using -P., or else selective NOP patching using code compiled with -pg, -finstrument-functions or -fpatchable-function-entry=N.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://zhuanlan.zhihu.com/p/706025483&#34;&gt;使用GCC函数插桩功能找到耗时异常的函数&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这篇文章通过函数插桩，在函数入口和出口自动插入钩子函数，用于统计函数耗时。在cyg_profile_func_enter中记录函数的开始ticks，在cyg_profile_func_exit中记录函数的结束ticks，两者相减便得到了函数运行消耗的ticks，再除以CPU频率（g_cs_hz）得到耗时。使用x86指令集架构中的RDTSC（Read Time Stamp Counter）指令读取处理器的时钟周期计数器。&lt;/p&gt;
&lt;p&gt;如果耗时大于5ms，便将函数指针和耗时push到一个栈中，记录下来，后续打印出来。&lt;/p&gt;
&lt;style&gt;
.related-posts {
  margin-top: 1.5rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  max-height: none !important; /* 防止Safari错误计算高度 */
  overflow: visible !important; /* 防止内容被截断 */
}
.related-posts h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  font-weight: 500;
  line-height: 1.3;
}
.related-posts ul {
  margin: 0 0 0.5rem 0 !important; /* 强制覆盖可能的冲突样式 */
  padding-left: 1.5rem;
  list-style-position: outside;
}
.related-posts li {
  margin-bottom: 0.25rem;
  line-height: 1.4;
}
/* 暗色模式适配 */
[data-md-color-scheme=&#34;slate&#34;] .related-posts {
  border-top-color: rgba(255,255,255,0.1);
}
/* Safari特定修复 */
@supports (-webkit-hyphens:none) {
  .related-posts {
    display: block;
    position: relative;
    height: auto !important;
  }
  .related-posts ul {
    position: static;
  }
}
&lt;/style&gt;
&lt;div class=&#34;related-posts&#34;&gt;
&lt;h3&gt;📚 相关文章推荐&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c使用abseil-cpp遇到的小问题/&#34; target=&#34;_blank&#34;&gt;C++使用abseil-cpp遇到的小问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/c技法如何为一个类动态附加任意类型数据/&#34; target=&#34;_blank&#34;&gt;C++技法：如何为一个类动态附加任意类型数据&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/helix-gpt如何实现ai-code以及如何调试/&#34; target=&#34;_blank&#34;&gt;helix-gpt如何实现AI code以及如何调试?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/300行实现一个boundedspscqueue/&#34; target=&#34;_blank&#34;&gt;300行实现一个BoundedSPSCQueue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kenforever1.github.io/blog/netcap调试/&#34; target=&#34;_blank&#34;&gt;netcap调试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</description>
      <link>https://github.com/KenForever1/blog/%E5%87%BD%E6%95%B0hookld_preload%E5%AE%A1%E8%AE%A1%E6%B5%81%E5%8A%AB%E6%8C%81ld_audit%E5%8F%8A%E5%87%BD%E6%95%B0%E6%8F%92%E6%A1%A9/</link>
      <pubDate>Sun, 08 Jun 2025 00:00:00 +0000</pubDate>
      <source url="https://github.com/KenForever1/feed_rss_created.xml">KenForever1</source>
      
      <guid isPermaLink="true">https://github.com/KenForever1/blog/%E5%87%BD%E6%95%B0hookld_preload%E5%AE%A1%E8%AE%A1%E6%B5%81%E5%8A%AB%E6%8C%81ld_audit%E5%8F%8A%E5%87%BD%E6%95%B0%E6%8F%92%E6%A1%A9/</guid>
      
    </item>
    
  </channel>
</rss>